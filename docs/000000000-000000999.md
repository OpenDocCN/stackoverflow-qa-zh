# StackOverflow 问答 0-999

# c# - 如何在 C# 中将 Decimal 转换为 Double？

> ID：4
> 
> 赞同：756
> 
> 时间：2008-07-31T21:42:52.667
> 
> 标签：c#, floating-point, type-conversion, double, decimal

我想用 a`Track-Bar`来改变 a`Form`的不透明度。

这是我的代码：

```
decimal trans = trackBar1.Value / 5000;
this.Opacity = trans; 
```

当我构建应用程序时，它给出了以下错误：

> ```
> Cannot implicitly convert type decimal to double 
> ```

我曾尝试使用`trans`and `double`，但随后`Control`不起作用。此代码在过去的 VB.NET 项目中运行良好。

* * *

## 回答 #1

> 赞同：501
> 
> 时间：2008-07-31T22:17:57.883

An explicit cast to `double` like this isn't necessary:

```
double trans = (double) trackBar1.Value / 5000.0; 
```

Identifying the constant as `5000.0` (or as `5000d`) is sufficient:

```
double trans = trackBar1.Value / 5000.0;
double trans = trackBar1.Value / 5000d; 
```

* * *

## 回答 #2

> 赞同：142
> 
> 时间：2008-08-01T14:23:28.087

**通用问题“十进制与双倍？”的更通用答案：**

**十进制**用于货币计算以保持精度。**Double**用于不受微小差异影响的科学计算。由于 Double 是 CPU 原生的类型（内部表示存储在*base 2*中），使用 Double 进行的计算比 Decimal 执行得更好（内部以*10*表示）。

* * *

## 回答 #3

> 赞同：96
> 
> 时间：2008-08-10T17:54:27.777

您的代码在 VB.NET 中运行良好，因为它隐式执行任何强制转换，而 C# 具有隐式和显式强制转换。

在 C# 中，从十进制到双精度的转换是明确的，因为您会失去准确性。例如 1.1 不能准确地表示为双精度数，但可以表示为小数（原因请参阅“[浮点数 - 比你想象](http://bizvprog.blogspot.com/2008/05/floating-point-numbers-more-inaccurate.html)的更不准确”）。

在 VB 中，编译器为您添加了转换：

```
decimal trans = trackBar1.Value / 5000m;
this.Opacity = (double) trans; 
```

这`(double)`必须在 C# 中明确说明，但可以通过 VB 更“宽容”的编译器来*暗示。*

* * *

## 回答 #4

> 赞同：89
> 
> 时间：2008-09-21T03:51:01.303

为什么要除以 5000？只需将 TrackBar 的最小值和最大值设置在 0 到 100 之间，然后将值除以 100 即可获得不透明度百分比。下面的最少 20 个示例可防止表单变得完全不可见：

```
private void Form1_Load(object sender, System.EventArgs e)
{
    TrackBar1.Minimum = 20;
    TrackBar1.Maximum = 100;

    TrackBar1.LargeChange = 10;
    TrackBar1.SmallChange = 1;
    TrackBar1.TickFrequency = 5;
}

private void TrackBar1_Scroll(object sender, System.EventArgs e)
{
    this.Opacity = TrackBar1.Value / 100;
} 
```

* * *

## 回答 #5

> 赞同：70
> 
> 时间：2009-02-27T11:45:40.910

你有两个问题。

首先，`Opacity`需要一个双精度值，而不是十进制值。编译器告诉您，虽然十进制和双精度之间存在转换，但您需要指定显式转换才能使其工作。

其次，`TrackBar.Value`是一个整数值，并且将一个 int 除以一个 int 会得到一个 int，无论您将它分配给什么类型的变量。在这种情况下，存在从 int 到 decimal 或 double 的隐式转换，因为在进行转换时不会损失精度。所以编译器不会抱怨。但是你得到的值总是 0，大概是因为`trackBar.Value`总是小于 5000。

解决方案是将代码更改为使用双精度（不透明度的本机类型）并通过显式将常量设为双精度来执行浮点运算，这将具有提升算术或强制转换`trackBar.Value`为双精度的效果，这将做同样的事情或两者。您不需要中间变量，除非它在其他地方使用。我的猜测是编译器无论如何都会优化它。

```
trackBar.Opacity = (double)trackBar.Value / 5000.0; 
```

* * *

## 回答 #6

> 赞同：67
> 
> 时间：2008-08-05T20:18:30.677

在我看来，希望尽可能明确。这增加了代码的清晰度，并有助于最终可能阅读它的程序员伙伴。

除了（或代替）将 a 附加`.0`到数字之外，您还可以使用`decimal.ToDouble()`.

这里有些例子：

```
// Example 1
double transperancy = trackBar1.Value/5000;
this.Opacity = decimal.ToDouble(transperancy);

// Example 2 - with inline temp
this.Opacity = decimal.ToDouble(trackBar1.Value/5000); 
```

* * *

## 回答 #7

> 赞同：65
> 
> 时间：2008-08-01T13:53:06.357

听起来像是`this.Opacity`一个双精度值，编译器不喜欢您尝试将十进制值塞入其中。

* * *

## 回答 #8

> 赞同：58
> 
> 时间：2011-08-31T19:08:26.847

[Opacity](https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.form.opacity)属性是双重类型：

```
double trans = trackBar1.Value / 5000.0;
this.Opacity = trans; 
```

或者简单地说：

```
this.Opacity = trackBar1.Value / 5000.0; 
```

或者：

```
this.Opacity = trackBar1.Value / 5000d; 
```

请注意，我使用`5000.0`(或`5000d`) 来强制进行双重除法，因为[`trackBar1.Value`](https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.trackbar.value)它是一个整数，它将执行整数除法，结果将是一个整数。

* * *

## 回答 #9

> 赞同：57
> 
> 时间：2008-11-20T14:36:42.953

您应该使用`5000.0`而不是`5000`.

* * *

## 回答 #10

> 赞同：55
> 
> 时间：2011-08-31T19:09:50.187

假设您使用的是 WinForms，[`Form.Opacity`](https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.form.opacity)类型为`double`，因此您应该使用：

```
double trans = trackBar1.Value / 5000.0;
this.Opacity = trans; 
```

除非您在其他地方需要该值，否则编写起来更简单：

```
this.Opacity = trackBar1.Value / 5000.0; 
```

当您将代码更改为简单的双精度时，控件不起作用的原因是因为您有：

```
double trans = trackbar1.Value / 5000; 
```

它将 解释`5000`为整数，并且因为`trackbar1.Value`也是整数，所以您的`trans`值始终为零。通过添加显式使数字成为浮点值，`.0`编译器现在可以将其解释为双精度并执行正确的计算。

* * *

## 回答 #11

> 赞同：49
> 
> 时间：2012-05-13T02:10:25.407

因为`Opacity`是双精度值，所以我会从一开始就使用双精度，根本不强制转换，但一定要在除法时使用双精度，这样就不会失去任何精度

```
Opacity = trackBar1.Value / 5000.0; 
```

* * *

## 回答 #12

> 赞同：48
> 
> 时间：2012-03-06T08:07:53.210

最好的解决方案是：

```
this.Opacity = decimal.ToDouble(trackBar1.Value/5000); 
```

# html - Why did the width collapse in the percentage width child element in an absolutely positioned parent on Internet Explorer 7?

> ID：6
> 
> 赞同：313
> 
> 时间：2008-07-31T22:08:08.620
> 
> 标签：html, css, internet-explorer-7

I have an absolutely positioned `div` containing several children, one of which is a relatively positioned `div`. When I use a `percentage-based width` on the child `div`, it collapses to `0 width` on IE7, but not on Firefox or Safari.

If I use `pixel width`, it works. If the parent is relatively positioned, the percentage width on the child works.

1.  Is there something I'm missing here?
2.  Is there an easy fix for this besides the `pixel-based width` on the child?
3.  Is there an area of the CSS specification that covers this?

* * *

## 回答 #1

> 赞同：155
> 
> 时间：2008-08-01T12:22:51.593

父级`div`需要有一个已定义的`width`，以像素或百分比为单位。在 Internet Explorer 7 中，父级`div`需要`width`为子级定义的百分比`div`才能正常工作。

* * *

## 回答 #2

> 赞同：64
> 
> 时间：2008-08-05T05:54:23.310

这是一个示例代码。我想这就是你要找的。以下代码在 Firefox 3 (mac) 和 IE7 中显示完全相同。

```
#absdiv {
  position: absolute; 
  left: 100px; 
  top: 100px; 
  width: 80%; 
  height: 60%; 
  background: #999;
}

#pctchild {
  width: 60%; 
  height: 40%; 
  background: #CCC;
}

#reldiv {
  position: relative;
  left: 20px;
  top: 20px;
  height: 25px;
  width: 40%;
  background: red;
}
```

```
<div id="absdiv">
    <div id="reldiv"></div>
    <div id="pctchild"></div>
</div>
```

* * *

## 回答 #3

> 赞同：41
> 
> 时间：2008-09-04T09:02:42.533

8 之前的 IE 对其盒子模型有一个时间方面的问题，最明显的是会产生基于百分比的宽度问题。在您的情况下，默认情况下绝对定位`div`的没有宽度。它的宽度将根据其内容的像素宽度计算出来，并在内容渲染后计算。因此，此时，IE 遇到并呈现您相对定位`div`的父级宽度为 0，因此它本身折叠为 0。

如果您想对此进行更深入的讨论以及大量工作示例，[请看这里](http://www.positioniseverything.net/explorer/percentages.html)。

* * *

## 回答 #4

> 赞同：39
> 
> 时间：2009-05-13T07:47:40.617

> 为什么绝对定位父级中的百分比宽度子级在 IE7 中不起作用？

因为它是 Internet Explorer。

> 我在这里缺少什么吗？

也就是说，提高你的同事/客户对 IE 不好的认识。

> 除了孩子的基于像素的宽度之外，还有一个简单的解决方法吗？

使用`em`单位，因为它们在创建流动布局时更有用，因为您可以将它们用于填充和边距以及字体大小。因此，如果调整大小（这确实是您所需要的），您的空白将与您的文本成比例地增长和缩小。我不认为百分比比 ems 提供更好的控制。没有什么可以阻止您指定百分之一的 em（0.01 em），并且浏览器将按照它认为合适的方式进行解释。

> CSS 规范中是否有涵盖此内容的领域？

没有，据我记得`em`'s 和 %'s 仅用于 CSS 1.0 的字体大小。

* * *

## 回答 #5

> 赞同：34
> 
> 时间：2010-10-22T16:21:10.660

我认为这与`hasLayout`在旧浏览器中实现属性的方式有关。

您是否在 IE8 中尝试过您的代码以查看是否也可以在那里工作？IE8 有一个 Debugger ( `F12`)，也可以在 IE7 模式下运行。

* * *

## 回答 #6

> 赞同：4
> 
> 时间：2018-09-07T14:53:02.030

`div`需要有一个定义的宽度：

```
<div id="parent" style="width:230px;">
    <div id="child1"></div>
    <div id="child2"></div>
</div> 
```

* * *

## 回答 #7

> 赞同：3
> 
> 时间：2020-10-06T03:46:15.157

父`<div>`标签没有指定任何宽度。将它用于子`<div>`标签，它可以是百分比或像素，但无论它是什么，它都应该链接到它的适当位置：

```
<div id="MainDiv" style="width:60%;">
    <div id="Div1">
        ...
    </div>
    <div id="Div2">
        ...
    </div>
    ...
</div> 
```

# c# - How do I calculate someone's age based on a DateTime type birthday?

> ID：9
> 
> 赞同：2099
> 
> 时间：2008-07-31T23:40:59.743
> 
> 标签：c#, .net, datetime

Given a `DateTime` representing a person's birthday, how do I calculate their age in years?

* * *

## 回答 #1

> 赞同：2313
> 
> 时间：2008-08-04T16:50:06.170

一个易于理解和简单的解决方案。

```
// Save today's date.
var today = DateTime.Today;

// Calculate the age.
var age = today.Year - birthdate.Year;

// Go back to the year in which the person was born in case of a leap year
if (birthdate.Date > today.AddYears(-age)) age--; 
```

但是，这假设您正在寻找*西方*的时代观念，而不是使用[*东亚推算*](https://en.wikipedia.org/wiki/East_Asian_age_reckoning)。

* * *

## 回答 #2

> 赞同：1075
> 
> 时间：2008-08-15T03:47:29.100

这是一种奇怪的方法，但是如果您将日期格式化为`yyyymmdd`并从当前日期中减去出生日期，然后删除您的年龄的最后 4 位数字:)

我不知道 C#，但我相信这适用于任何语言。

```
20080814 - 19800703 = 280111 
```

删除最后 4 位数字 = `28`。

C#代码：

```
int now = int.Parse(DateTime.Now.ToString("yyyyMMdd"));
int dob = int.Parse(dateOfBirth.ToString("yyyyMMdd"));
int age = (now - dob) / 10000; 
```

或者，不以扩展方法的形式进行所有类型转换。错误检查省略：

```
public static Int32 GetAge(this DateTime dateOfBirth)
{
    var today = DateTime.Today;

    var a = (today.Year * 100 + today.Month) * 100 + today.Day;
    var b = (dateOfBirth.Year * 100 + dateOfBirth.Month) * 100 + dateOfBirth.Day;

    return (a - b) / 10000;
} 
```

* * *

## 回答 #3

> 赞同：407
> 
> 时间：2009-10-20T15:07:22.630

这是一个测试片段：

```
DateTime bDay = new DateTime(2000, 2, 29);
DateTime now = new DateTime(2009, 2, 28);
MessageBox.Show(string.Format("Test {0} {1} {2}",
                CalculateAgeWrong1(bDay, now),      // outputs 9
                CalculateAgeWrong2(bDay, now),      // outputs 9
                CalculateAgeCorrect(bDay, now),     // outputs 8
                CalculateAgeCorrect2(bDay, now)));  // outputs 8 
```

在这里你有方法：

```
public int CalculateAgeWrong1(DateTime birthDate, DateTime now)
{
    return new DateTime(now.Subtract(birthDate).Ticks).Year - 1;
}

public int CalculateAgeWrong2(DateTime birthDate, DateTime now)
{
    int age = now.Year - birthDate.Year;

    if (now < birthDate.AddYears(age))
        age--;

    return age;
}

public int CalculateAgeCorrect(DateTime birthDate, DateTime now)
{
    int age = now.Year - birthDate.Year;

    if (now.Month < birthDate.Month || (now.Month == birthDate.Month && now.Day < birthDate.Day))
        age--;

    return age;
}

public int CalculateAgeCorrect2(DateTime birthDate, DateTime now)
{
    int age = now.Year - birthDate.Year;

    // For leap years we need this
    if (birthDate > now.AddYears(-age)) 
        age--;
    // Don't use:
    // if (birthDate.AddYears(age) > now) 
    //     age--;

    return age;
} 
```

* * *

## 回答 #4

> 赞同：122
> 
> 时间：2011-02-19T23:56:58.337

对此的简单回答是`AddYears`如下所示应用，因为这是唯一一种将年份添加到闰年的 2 月 29 日并获得普通年份 2 月 28 日的正确结果的本地方法。

有些人认为 3 月 1 日是跳跃者的生日，但 .Net 和任何官方规则都不支持这一点，也没有常见的逻辑解释为什么 2 月出生的一些人应该在另一个月份过 75% 的生日。

此外，Age 方法有助于将其作为扩展添加到`DateTime`. 通过这种方式，您可以以最简单的方式获得年龄：

1.  项目清单

**int 年龄 = 出生日期.Age();**

```
public static class DateTimeExtensions
{
    /// <summary>
    /// Calculates the age in years of the current System.DateTime object today.
    /// </summary>
    /// <param name="birthDate">The date of birth</param>
    /// <returns>Age in years today. 0 is returned for a future date of birth.</returns>
    public static int Age(this DateTime birthDate)
    {
        return Age(birthDate, DateTime.Today);
    }

    /// <summary>
    /// Calculates the age in years of the current System.DateTime object on a later date.
    /// </summary>
    /// <param name="birthDate">The date of birth</param>
    /// <param name="laterDate">The date on which to calculate the age.</param>
    /// <returns>Age in years on a later day. 0 is returned as minimum.</returns>
    public static int Age(this DateTime birthDate, DateTime laterDate)
    {
        int age;
        age = laterDate.Year - birthDate.Year;

        if (age > 0)
        {
            age -= Convert.ToInt32(laterDate.Date < birthDate.Date.AddYears(age));
        }
        else
        {
            age = 0;
        }

        return age;
    }
} 
```

现在，运行这个测试：

```
class Program
{
    static void Main(string[] args)
    {
        RunTest();
    }

    private static void RunTest()
    {
        DateTime birthDate = new DateTime(2000, 2, 28);
        DateTime laterDate = new DateTime(2011, 2, 27);
        string iso = "yyyy-MM-dd";

        for (int i = 0; i < 3; i++)
        {
            for (int j = 0; j < 3; j++)
            {
                Console.WriteLine("Birth date: " + birthDate.AddDays(i).ToString(iso) + "  Later date: " + laterDate.AddDays(j).ToString(iso) + "  Age: " + birthDate.AddDays(i).Age(laterDate.AddDays(j)).ToString());
            }
        }

        Console.ReadKey();
    }
} 
```

关键日期示例如下：

**出生日期：2000-02-29 出生日期：2011-02-28 年龄：11**

输出：

```
{
    Birth date: 2000-02-28  Later date: 2011-02-27  Age: 10
    Birth date: 2000-02-28  Later date: 2011-02-28  Age: 11
    Birth date: 2000-02-28  Later date: 2011-03-01  Age: 11
    Birth date: 2000-02-29  Later date: 2011-02-27  Age: 10
    Birth date: 2000-02-29  Later date: 2011-02-28  Age: 11
    Birth date: 2000-02-29  Later date: 2011-03-01  Age: 11
    Birth date: 2000-03-01  Later date: 2011-02-27  Age: 10
    Birth date: 2000-03-01  Later date: 2011-02-28  Age: 10
    Birth date: 2000-03-01  Later date: 2011-03-01  Age: 11
} 
```

对于后来的日期 2012-02-28：

```
{
    Birth date: 2000-02-28  Later date: 2012-02-28  Age: 12
    Birth date: 2000-02-28  Later date: 2012-02-29  Age: 12
    Birth date: 2000-02-28  Later date: 2012-03-01  Age: 12
    Birth date: 2000-02-29  Later date: 2012-02-28  Age: 11
    Birth date: 2000-02-29  Later date: 2012-02-29  Age: 12
    Birth date: 2000-02-29  Later date: 2012-03-01  Age: 12
    Birth date: 2000-03-01  Later date: 2012-02-28  Age: 11
    Birth date: 2000-03-01  Later date: 2012-02-29  Age: 11
    Birth date: 2000-03-01  Later date: 2012-03-01  Age: 12
} 
```

* * *

## 回答 #5

> 赞同：95
> 
> 时间：2008-10-03T20:19:31.190

我的建议

```
int age = (int) ((DateTime.Now - bday).TotalDays/365.242199); 
```

这似乎在正确的日期改变了年份。（我现场测试到 107 岁。）

* * *

## 回答 #6

> 赞同：89
> 
> 时间：2008-08-01T21:46:12.313

另一个功能，不是我做的，而是在网上找到并稍微改进了一下：

```
public static int GetAge(DateTime birthDate)
{
    DateTime n = DateTime.Now; // To avoid a race condition around midnight
    int age = n.Year - birthDate.Year;

    if (n.Month < birthDate.Month || (n.Month == birthDate.Month && n.Day < birthDate.Day))
        age--;

    return age;
} 
```

我想到了两件事：来自不使用公历的国家的人呢？DateTime.Now 我认为是特定于服务器的文化。我对实际使用亚洲日历的知识绝对为零，我不知道是否有一种简单的方法可以在日历之间转换日期，但以防万一你想知道那些来自 4660 年的中国人 :-)

* * *

## 回答 #7

> 赞同：60
> 
> 时间：2011-04-11T14:47:15.390

2 要解决的主要问题是：

**1\. 计算确切年龄**- 以年、月、日等为单位。

**2\. 计算普遍感知的年龄**——人们通常不关心他们的确切年龄，他们只关心他们今年的生日是什么时候。

* * *

**1**的解决方案很明显：

```
DateTime birth = DateTime.Parse("1.1.2000");
DateTime today = DateTime.Today;     //we usually don't care about birth time
TimeSpan age = today - birth;        //.NET FCL should guarantee this as precise
double ageInDays = age.TotalDays;    //total number of days ... also precise
double daysInYear = 365.2425;        //statistical value for 400 years
double ageInYears = ageInDays / daysInYear;  //can be shifted ... not so precise 
```

* * *

**2**的解决方案在确定总年龄时不是那么精确，但被人们认为是精确的。人们通常也使用它，当他们“手动”计算年龄时：

```
DateTime birth = DateTime.Parse("1.1.2000");
DateTime today = DateTime.Today;
int age = today.Year - birth.Year;    //people perceive their age in years

if (today.Month < birth.Month ||
   ((today.Month == birth.Month) && (today.Day < birth.Day)))
{
  age--;  //birthday in current year not yet reached, we are 1 year younger ;)
          //+ no birthday for 29.2\. guys ... sorry, just wrong date for birth
} 
```

注释 2.:

*   这是我的首选解决方案
*   我们不能使用 DateTime.DayOfYear 或 TimeSpan，因为它们会在闰年改变天数
*   为了可读性，我放了更多的行

还有一点需要注意...我会为它创建 2 个静态重载方法，一个用于通用，第二个用于易用性：

```
public static int GetAge(DateTime bithDay, DateTime today) 
{ 
  //chosen solution method body
}

public static int GetAge(DateTime birthDay) 
{ 
  return GetAge(birthDay, DateTime.Now);
} 
```

* * *

## 回答 #8

> 赞同：53
> 
> 时间：2009-05-18T12:36:51.560

这是一个单行：

```
int age = new DateTime(DateTime.Now.Subtract(birthday).Ticks).Year-1; 
```

* * *

## 回答 #9

> 赞同：53
> 
> 时间：2008-08-01T12:07:19.500

The best way that I know of because of leap years and everything is:

```
DateTime birthDate = new DateTime(2000,3,1);
int age = (int)Math.Floor((DateTime.Now - birthDate).TotalDays / 365.25D); 
```

* * *

## 回答 #10

> 赞同：45
> 
> 时间：2008-08-06T10:23:30.550

这是我们在这里使用的版本。它有效，而且相当简单。这和 Jeff 的想法一样，但我认为它更清晰一点，因为它分离了减一的逻辑，所以更容易理解。

```
public static int GetAge(this DateTime dateOfBirth, DateTime dateAsAt)
{
    return dateAsAt.Year - dateOfBirth.Year - (dateOfBirth.DayOfYear < dateAsAt.DayOfYear ? 0 : 1);
} 
```

如果您认为这种事情不清楚，您可以扩展三元运算符以使其更加清晰。

很明显，这是作为`DateTime`. 这里我们有另一个重载的 Extension 方法，它传入`DateTime.Now`，只是为了完整性。

* * *

## 回答 #11

> 赞同：36
> 
> 时间：2010-02-17T13:32:36.983

我用这个：

```
public static class DateTimeExtensions
{
    public static int Age(this DateTime birthDate)
    {
        return Age(birthDate, DateTime.Now);
    }

    public static int Age(this DateTime birthDate, DateTime offsetDate)
    {
        int result=0;
        result = offsetDate.Year - birthDate.Year;

        if (offsetDate.DayOfYear < birthDate.DayOfYear)
        {
              result--;
        }

        return result;
    }
} 
```

* * *

## 回答 #12

> 赞同：36
> 
> 时间：2013-09-20T19:13:56.967

这为这个问题提供了“更多细节”。也许这就是你要找的

```
DateTime birth = new DateTime(1974, 8, 29);
DateTime today = DateTime.Now;
TimeSpan span = today - birth;
DateTime age = DateTime.MinValue + span;

// Make adjustment due to MinValue equalling 1/1/1
int years = age.Year - 1;
int months = age.Month - 1;
int days = age.Day - 1;

// Print out not only how many years old they are but give months and days as well
Console.Write("{0} years, {1} months, {2} days", years, months, days); 
```

* * *

## 回答 #13

> 赞同：30
> 
> 时间：2008-08-23T13:58:02.860

我创建了一个 SQL Server 用户定义函数来计算某人的年龄，给定他们的生日。当您需要它作为查询的一部分时，这很有用：

```
using System;
using System.Data;
using System.Data.Sql;
using System.Data.SqlClient;
using System.Data.SqlTypes;
using Microsoft.SqlServer.Server;

public partial class UserDefinedFunctions
{
    [SqlFunction(DataAccess = DataAccessKind.Read)]
    public static SqlInt32 CalculateAge(string strBirthDate)
    {
        DateTime dtBirthDate = new DateTime();
        dtBirthDate = Convert.ToDateTime(strBirthDate);
        DateTime dtToday = DateTime.Now;

        // get the difference in years
        int years = dtToday.Year - dtBirthDate.Year;

        // subtract another year if we're before the
        // birth day in the current year
        if (dtToday.Month < dtBirthDate.Month || (dtToday.Month == dtBirthDate.Month && dtToday.Day < dtBirthDate.Day))
            years=years-1;

        int intCustomerAge = years;
        return intCustomerAge;
    }
}; 
```

* * *

## 回答 #14

> 赞同：30
> 
> 时间：2013-04-22T08:19:51.190

这是另一个答案：

```
public static int AgeInYears(DateTime birthday, DateTime today)
{
    return ((today.Year - birthday.Year) * 372 + (today.Month - birthday.Month) * 31 + (today.Day - birthday.Day)) / 372;
} 
```

这已经过广泛的单元测试。它看起来确实有点“神奇”。数字 372 是如果每个月有 31 天，一年中的天数。

它为什么起作用的解释（[从这里解除](https://social.msdn.microsoft.com/Forums/en-US/csharplanguage/thread/ba4a98af-aab3-4c59-bdee-611334e502f2)）是：

> 让我们设置`Yn = DateTime.Now.Year, Yb = birthday.Year, Mn = DateTime.Now.Month, Mb = birthday.Month, Dn = DateTime.Now.Day, Db = birthday.Day`
> 
> `age = Yn - Yb + (31*(Mn - Mb) + (Dn - Db)) / 372`
> 
> 我们知道，我们需要的是，要么`Yn-Yb`已经到了日期，要么`Yn-Yb-1`还没有。
> 
> a) 如果`Mn<Mb`，我们有`-341 <= 31*(Mn-Mb) <= -31 and -30 <= Dn-Db <= 30`
> 
> `-371 <= 31*(Mn - Mb) + (Dn - Db) <= -1`
> 
> 带整数除法
> 
> `(31*(Mn - Mb) + (Dn - Db)) / 372 = -1`
> 
> b) 如果`Mn=Mb`和`Dn<Db`，我们有`31*(Mn - Mb) = 0 and -30 <= Dn-Db <= -1`
> 
> 再次使用整数除法
> 
> `(31*(Mn - Mb) + (Dn - Db)) / 372 = -1`
> 
> c) 如果`Mn>Mb`，我们有`31 <= 31*(Mn-Mb) <= 341 and -30 <= Dn-Db <= 30`
> 
> `1 <= 31*(Mn - Mb) + (Dn - Db) <= 371`
> 
> 带整数除法
> 
> `(31*(Mn - Mb) + (Dn - Db)) / 372 = 0`
> 
> d) 如果`Mn=Mb`和`Dn>Db`，我们有`31*(Mn - Mb) = 0 and 1 <= Dn-Db <= 3`0
> 
> 再次使用整数除法
> 
> `(31*(Mn - Mb) + (Dn - Db)) / 372 = 0`
> 
> e) 如果`Mn=Mb`和`Dn=Db`，我们有`31*(Mn - Mb) + Dn-Db = 0`
> 
> 因此`(31*(Mn - Mb) + (Dn - Db)) / 372 = 0`

* * *

## 回答 #15

> 赞同：26
> 
> 时间：2009-05-18T11:24:38.523

我花了一些时间研究这个并想出这个来计算某人的年龄，以年、月和日为单位。我已经针对 2 月 29 日的问题和闰年进行了测试，它似乎有效，我将不胜感激任何反馈：

```
public void LoopAge(DateTime myDOB, DateTime FutureDate)
{
    int years = 0;
    int months = 0;
    int days = 0;

    DateTime tmpMyDOB = new DateTime(myDOB.Year, myDOB.Month, 1);

    DateTime tmpFutureDate = new DateTime(FutureDate.Year, FutureDate.Month, 1);

    while (tmpMyDOB.AddYears(years).AddMonths(months) < tmpFutureDate)
    {
        months++;

        if (months > 12)
        {
            years++;
            months = months - 12;
        }
    }

    if (FutureDate.Day >= myDOB.Day)
    {
        days = days + FutureDate.Day - myDOB.Day;
    }
    else
    {
        months--;

        if (months < 0)
        {
            years--;
            months = months + 12;
        }

        days +=
            DateTime.DaysInMonth(
                FutureDate.AddMonths(-1).Year, FutureDate.AddMonths(-1).Month
            ) + FutureDate.Day - myDOB.Day;

    }

    //add an extra day if the dob is a leap day
    if (DateTime.IsLeapYear(myDOB.Year) && myDOB.Month == 2 && myDOB.Day == 29)
    {
        //but only if the future date is less than 1st March
        if (FutureDate >= new DateTime(FutureDate.Year, 3, 1))
            days++;
    }

} 
```

* * *

## 回答 #16

> 赞同：21
> 
> 时间：2010-10-06T01:49:50.043

我发现的最简单的方法就是这个。它适用于美国和西欧地区。不能和其他地方说话，尤其是像中国这样的地方。在年龄的初始计算之后，最多进行 4 次额外比较。

```
public int AgeInYears(DateTime birthDate, DateTime referenceDate)
{
  Debug.Assert(referenceDate >= birthDate, 
               "birth date must be on or prior to the reference date");

  DateTime birth = birthDate.Date;
  DateTime reference = referenceDate.Date;
  int years = (reference.Year - birth.Year);

  //
  // an offset of -1 is applied if the birth date has 
  // not yet occurred in the current year.
  //
  if (reference.Month > birth.Month);
  else if (reference.Month < birth.Month) 
    --years;
  else // in birth month
  {
    if (reference.Day < birth.Day)
      --years;
  }

  return years ;
} 
```

我正在查看这个问题的答案，并注意到没有人提到闰日出生的监管/法律影响。例如，[根据 Wikipedia](https://en.wikipedia.org/wiki/February_29#Births)，如果您在 2 月 29 日出生在不同的司法管辖区，那么您的非闰年生日会有所不同：

*   在英国和香港：这是一年中的第一个日子，所以第二天，3 月 1 日是你的生日。
*   在新西兰：前一天，2 月 28 日用于驾驶执照，3 月 1 日用于其他目的。
*   台湾：2月28日。

据我所知，在美国，法规对此事保持沉默，将其留给普通法以及各种监管机构如何在其法规中定义事物。

为此，改进：

```
public enum LeapDayRule
{
  OrdinalDay     = 1 ,
  LastDayOfMonth = 2 ,
}

static int ComputeAgeInYears(DateTime birth, DateTime reference, LeapYearBirthdayRule ruleInEffect)
{
  bool isLeapYearBirthday = CultureInfo.CurrentCulture.Calendar.IsLeapDay(birth.Year, birth.Month, birth.Day);
  DateTime cutoff;

  if (isLeapYearBirthday && !DateTime.IsLeapYear(reference.Year))
  {
    switch (ruleInEffect)
    {
      case LeapDayRule.OrdinalDay:
        cutoff = new DateTime(reference.Year, 1, 1)
                             .AddDays(birth.DayOfYear - 1);
        break;

      case LeapDayRule.LastDayOfMonth:
        cutoff = new DateTime(reference.Year, birth.Month, 1)
                             .AddMonths(1)
                             .AddDays(-1);
        break;

      default:
        throw new InvalidOperationException();
    }
  }
  else
  {
    cutoff = new DateTime(reference.Year, birth.Month, birth.Day);
  }

  int age = (reference.Year - birth.Year) + (reference >= cutoff ? 0 : -1);
  return age < 0 ? 0 : age;
} 
```

应该注意的是，此代码假定：

*   西方（欧洲）的年龄推算，以及
*   一种日历，例如在月末插入一个闰日的公历。

* * *

## 回答 #17

> 赞同：21
> 
> 时间：2010-08-18T14:29:10.410

保持简单（可能很愚蠢:)）。

```
DateTime birth = new DateTime(1975, 09, 27, 01, 00, 00, 00);
TimeSpan ts = DateTime.Now - birth;
Console.WriteLine("You are approximately " + ts.TotalSeconds.ToString() + " seconds old."); 
```

* * *

## 回答 #18

> 赞同：21
> 
> 时间：2012-11-30T12:13:21.373

我们需要考虑小于 1 岁的人吗？作为中国文化，我们将小婴儿的年龄描述为 2 个月或 4 周。

下面是我的实现，它并不像我想象的那么简单，尤其是处理像 2/28 这样的日期。

```
public static string HowOld(DateTime birthday, DateTime now)
{
    if (now < birthday)
        throw new ArgumentOutOfRangeException("birthday must be less than now.");

    TimeSpan diff = now - birthday;
    int diffDays = (int)diff.TotalDays;

    if (diffDays > 7)//year, month and week
    {
        int age = now.Year - birthday.Year;

        if (birthday > now.AddYears(-age))
            age--;

        if (age > 0)
        {
            return age + (age > 1 ? " years" : " year");
        }
        else
        {// month and week
            DateTime d = birthday;
            int diffMonth = 1;

            while (d.AddMonths(diffMonth) <= now)
            {
                diffMonth++;
            }

            age = diffMonth-1;

            if (age == 1 && d.Day > now.Day)
                age--;

            if (age > 0)
            {
                return age + (age > 1 ? " months" : " month");
            }
            else
            {
                age = diffDays / 7;
                return age + (age > 1 ? " weeks" : " week");
            }
        }
    }
    else if (diffDays > 0)
    {
        int age = diffDays;
        return age + (age > 1 ? " days" : " day");
    }
    else
    {
        int age = diffDays;
        return "just born";
    }
} 
```

此实现已通过以下测试用例。

```
[TestMethod]
public void TestAge()
{
    string age = HowOld(new DateTime(2011, 1, 1), new DateTime(2012, 11, 30));
    Assert.AreEqual("1 year", age);

    age = HowOld(new DateTime(2011, 11, 30), new DateTime(2012, 11, 30));
    Assert.AreEqual("1 year", age);

    age = HowOld(new DateTime(2001, 1, 1), new DateTime(2012, 11, 30));
    Assert.AreEqual("11 years", age);

    age = HowOld(new DateTime(2012, 1, 1), new DateTime(2012, 11, 30));
    Assert.AreEqual("10 months", age);

    age = HowOld(new DateTime(2011, 12, 1), new DateTime(2012, 11, 30));
    Assert.AreEqual("11 months", age);

    age = HowOld(new DateTime(2012, 10, 1), new DateTime(2012, 11, 30));
    Assert.AreEqual("1 month", age);

    age = HowOld(new DateTime(2008, 2, 28), new DateTime(2009, 2, 28));
    Assert.AreEqual("1 year", age);

    age = HowOld(new DateTime(2008, 3, 28), new DateTime(2009, 2, 28));
    Assert.AreEqual("11 months", age);

    age = HowOld(new DateTime(2008, 3, 28), new DateTime(2009, 3, 28));
    Assert.AreEqual("1 year", age);

    age = HowOld(new DateTime(2009, 1, 28), new DateTime(2009, 2, 28));
    Assert.AreEqual("1 month", age);

    age = HowOld(new DateTime(2009, 2, 1), new DateTime(2009, 3, 1));
    Assert.AreEqual("1 month", age);

    // NOTE.
    // new DateTime(2008, 1, 31).AddMonths(1) == new DateTime(2009, 2, 28);
    // new DateTime(2008, 1, 28).AddMonths(1) == new DateTime(2009, 2, 28);
    age = HowOld(new DateTime(2009, 1, 31), new DateTime(2009, 2, 28));
    Assert.AreEqual("4 weeks", age);

    age = HowOld(new DateTime(2009, 2, 1), new DateTime(2009, 2, 28));
    Assert.AreEqual("3 weeks", age);

    age = HowOld(new DateTime(2009, 2, 1), new DateTime(2009, 3, 1));
    Assert.AreEqual("1 month", age);

    age = HowOld(new DateTime(2012, 11, 5), new DateTime(2012, 11, 30));
    Assert.AreEqual("3 weeks", age);

    age = HowOld(new DateTime(2012, 11, 1), new DateTime(2012, 11, 30));
    Assert.AreEqual("4 weeks", age);

    age = HowOld(new DateTime(2012, 11, 20), new DateTime(2012, 11, 30));
    Assert.AreEqual("1 week", age);

    age = HowOld(new DateTime(2012, 11, 25), new DateTime(2012, 11, 30));
    Assert.AreEqual("5 days", age);

    age = HowOld(new DateTime(2012, 11, 29), new DateTime(2012, 11, 30));
    Assert.AreEqual("1 day", age);

    age = HowOld(new DateTime(2012, 11, 30), new DateTime(2012, 11, 30));
    Assert.AreEqual("just born", age);

    age = HowOld(new DateTime(2000, 2, 29), new DateTime(2009, 2, 28));
    Assert.AreEqual("8 years", age);

    age = HowOld(new DateTime(2000, 2, 29), new DateTime(2009, 3, 1));
    Assert.AreEqual("9 years", age);

    Exception e = null;

    try
    {
        age = HowOld(new DateTime(2012, 12, 1), new DateTime(2012, 11, 30));
    }
    catch (ArgumentOutOfRangeException ex)
    {
        e = ex;
    }

    Assert.IsTrue(e != null);
} 
```

希望它有帮助。

* * *

## 回答 #19

> 赞同：20
> 
> 时间：2012-11-23T15:00:31.097

这不是一个直接的答案，而更多的是从准科学的角度对手头的问题进行哲学推理。

我认为这个问题没有指定衡量年龄的单位或文化，大多数答案似乎都假设整数年度表示。时间的 SI 单位是`second`，因此正确的通用答案应该是（当然假设归一化`DateTime`并且不考虑相对论效应）：

```
var lifeInSeconds = (DateTime.Now.Ticks - then.Ticks)/TickFactor; 
```

用基督教计算年龄的方法：

```
var then = ... // Then, in this case the birthday
var now = DateTime.UtcNow;
int age = now.Year - then.Year;
if (now.AddYears(-age) < then) age--; 
```

在金融中，在计算通常被称为*Day Count Fraction*的东西时存在类似的问题，它大致是给定时期的年数。年龄问题实际上是一个时间测量问题。

实际/实际（“正确”计算所有天数）约定的示例：

```
DateTime start, end = .... // Whatever, assume start is before end

double startYearContribution = 1 - (double) start.DayOfYear / (double) (DateTime.IsLeapYear(start.Year) ? 366 : 365);
double endYearContribution = (double)end.DayOfYear / (double)(DateTime.IsLeapYear(end.Year) ? 366 : 365);
double middleContribution = (double) (end.Year - start.Year - 1);

double DCF = startYearContribution + endYearContribution + middleContribution; 
```

通常测量时间的另一种非常常见的方法是“序列化”（命名这个日期约定的家伙一定是认真的）：

```
DateTime start, end = .... // Whatever, assume start is before end
int days = (end - start).Days; 
```

我想知道我们需要多长时间才能以秒为单位的相对论年龄变得比迄今为止在一个人的一生中地球绕太阳周期的粗略近似更有用:) 或者换句话说，当一个时期必须被赋予一个位置或一个表示运动的函数本身是有效的:)

* * *

## 回答 #20

> 赞同：19
> 
> 时间：2013-09-19T15:18:53.443

```
TimeSpan diff = DateTime.Now - birthdayDateTime;
string age = String.Format("{0:%y} years, {0:%M} months, {0:%d}, days old", diff); 
```

我不确定您希望它如何返回给您，所以我只是制作了一个可读的字符串。

* * *

## 回答 #21

> 赞同：17
> 
> 时间：2009-06-18T10:35:21.493

这是一个解决方案。

```
DateTime dateOfBirth = new DateTime(2000, 4, 18);
DateTime currentDate = DateTime.Now;

int ageInYears = 0;
int ageInMonths = 0;
int ageInDays = 0;

ageInDays = currentDate.Day - dateOfBirth.Day;
ageInMonths = currentDate.Month - dateOfBirth.Month;
ageInYears = currentDate.Year - dateOfBirth.Year;

if (ageInDays < 0)
{
    ageInDays += DateTime.DaysInMonth(currentDate.Year, currentDate.Month);
    ageInMonths = ageInMonths--;

    if (ageInMonths < 0)
    {
        ageInMonths += 12;
        ageInYears--;
    }
}

if (ageInMonths < 0)
{
    ageInMonths += 12;
    ageInYears--;
}

Console.WriteLine("{0}, {1}, {2}", ageInYears, ageInMonths, ageInDays); 
```

* * *

## 回答 #22

> 赞同：16
> 
> 时间：2014-10-23T13:18:40.373

与 2 月 28 日的任何一年相比，这是能够解决 2 月 29 日生日的最准确答案之一。

```
public int GetAge(DateTime birthDate)
{
    int age = DateTime.Now.Year - birthDate.Year;

    if (birthDate.DayOfYear > DateTime.Now.DayOfYear)
        age--;

    return age;
} 
```

* * *

## 回答 #23

> 赞同：15
> 
> 时间：2014-01-22T07:23:00.600

我有一个定制的方法来计算年龄，加上一个额外的验证信息，以防万一它有帮助：

```
public void GetAge(DateTime dob, DateTime now, out int years, out int months, out int days)
{
    years = 0;
    months = 0;
    days = 0;

    DateTime tmpdob = new DateTime(dob.Year, dob.Month, 1);
    DateTime tmpnow = new DateTime(now.Year, now.Month, 1);

    while (tmpdob.AddYears(years).AddMonths(months) < tmpnow)
    {
        months++;
        if (months > 12)
        {
            years++;
            months = months - 12;
        }
    }

    if (now.Day >= dob.Day)
        days = days + now.Day - dob.Day;
    else
    {
        months--;
        if (months < 0)
        {
            years--;
            months = months + 12;
        }
        days += DateTime.DaysInMonth(now.AddMonths(-1).Year, now.AddMonths(-1).Month) + now.Day - dob.Day;
    }

    if (DateTime.IsLeapYear(dob.Year) && dob.Month == 2 && dob.Day == 29 && now >= new DateTime(now.Year, 3, 1))
        days++;

}   

private string ValidateDate(DateTime dob) //This method will validate the date
{
    int Years = 0; int Months = 0; int Days = 0;

    GetAge(dob, DateTime.Now, out Years, out Months, out Days);

    if (Years < 18)
        message =  Years + " is too young. Please try again on your 18th birthday.";
    else if (Years >= 65)
        message = Years + " is too old. Date of Birth must not be 65 or older.";
    else
        return null; //Denotes validation passed
} 
```

在此处调用方法并传递日期时间值（如果服务器设置为美国语言环境，则为 MM/dd/yyyy）。将其替换为任何要显示的消息框或任何容器：

```
DateTime dob = DateTime.Parse("03/10/1982");  

string message = ValidateDate(dob);

lbldatemessage.Visible = !StringIsNullOrWhitespace(message);
lbldatemessage.Text = message ?? ""; //Ternary if message is null then default to empty string 
```

请记住，您可以以任何您喜欢的方式格式化消息。

* * *

## 回答 #24

> 赞同：14
> 
> 时间：2011-03-08T07:25:02.047

这个解决方案怎么样？

```
static string CalcAge(DateTime birthDay)
{
    DateTime currentDate = DateTime.Now;         
    int approximateAge = currentDate.Year - birthDay.Year;
    int daysToNextBirthDay = (birthDay.Month * 30 + birthDay.Day) - 
        (currentDate.Month * 30 + currentDate.Day) ;

    if (approximateAge == 0 || approximateAge == 1)
    {                
        int month =  Math.Abs(daysToNextBirthDay / 30);
        int days = Math.Abs(daysToNextBirthDay % 30);

        if (month == 0)
            return "Your age is: " + daysToNextBirthDay + " days";

        return "Your age is: " + month + " months and " + days + " days"; ;
    }

    if (daysToNextBirthDay > 0)
        return "Your age is: " + --approximateAge + " Years";

    return "Your age is: " + approximateAge + " Years"; ;
} 
```

* * *

## 回答 #25

> 赞同：13
> 
> 时间：2010-09-06T14:09:01.200

```
private int GetAge(int _year, int _month, int _day
{
    DateTime yourBirthDate= new DateTime(_year, _month, _day);

    DateTime todaysDateTime = DateTime.Today;
    int noOfYears = todaysDateTime.Year - yourBirthDate.Year;

    if (DateTime.Now.Month < yourBirthDate.Month ||
        (DateTime.Now.Month == yourBirthDate.Month && DateTime.Now.Day < yourBirthDate.Day))
    {
        noOfYears--;
    }

    return  noOfYears;
} 
```

* * *

## 回答 #26

> 赞同：10
> 
> 时间：2011-05-13T08:12:55.700

以下方法（从.NET类*DateDiff的*[时间段库中](https://www.codeproject.com/Articles/168662/Time-Period-Library-for-NET)提取）考虑了文化信息的日历：

 *```
// ----------------------------------------------------------------------
private static int YearDiff( DateTime date1, DateTime date2 )
{
  return YearDiff( date1, date2, DateTimeFormatInfo.CurrentInfo.Calendar );
} // YearDiff

// ----------------------------------------------------------------------
private static int YearDiff( DateTime date1, DateTime date2, Calendar calendar )
{
  if ( date1.Equals( date2 ) )
  {
    return 0;
  }

  int year1 = calendar.GetYear( date1 );
  int month1 = calendar.GetMonth( date1 );
  int year2 = calendar.GetYear( date2 );
  int month2 = calendar.GetMonth( date2 );

  // find the the day to compare
  int compareDay = date2.Day;
  int compareDaysPerMonth = calendar.GetDaysInMonth( year1, month1 );
  if ( compareDay > compareDaysPerMonth )
  {
    compareDay = compareDaysPerMonth;
  }

  // build the compare date
  DateTime compareDate = new DateTime( year1, month2, compareDay,
    date2.Hour, date2.Minute, date2.Second, date2.Millisecond );
  if ( date2 > date1 )
  {
    if ( compareDate < date1 )
    {
      compareDate = compareDate.AddYears( 1 );
    }
  }
  else
  {
    if ( compareDate > date1 )
    {
      compareDate = compareDate.AddYears( -1 );
    }
  }
  return year2 - calendar.GetYear( compareDate );
} // YearDiff 
```

用法：

```
// ----------------------------------------------------------------------
public void CalculateAgeSamples()
{
  PrintAge( new DateTime( 2000, 02, 29 ), new DateTime( 2009, 02, 28 ) );
  // > Birthdate=29.02.2000, Age at 28.02.2009 is 8 years
  PrintAge( new DateTime( 2000, 02, 29 ), new DateTime( 2012, 02, 28 ) );
  // > Birthdate=29.02.2000, Age at 28.02.2012 is 11 years
} // CalculateAgeSamples

// ----------------------------------------------------------------------
public void PrintAge( DateTime birthDate, DateTime moment )
{
  Console.WriteLine( "Birthdate={0:d}, Age at {1:d} is {2} years", birthDate, moment, YearDiff( birthDate, moment ) );
} // PrintAge 
```

* * *

## 回答 #27

> 赞同：10
> 
> 时间：2013-12-21T04:53:09.307

这个经典问题值得[Noda Time](https://nodatime.org)解决。

```
static int GetAge(LocalDate dateOfBirth)
{
    Instant now = SystemClock.Instance.Now;

    // The target time zone is important.
    // It should align with the *current physical location* of the person
    // you are talking about.  When the whereabouts of that person are unknown,
    // then you use the time zone of the person who is *asking* for the age.
    // The time zone of birth is irrelevant!

    DateTimeZone zone = DateTimeZoneProviders.Tzdb["America/New_York"];

    LocalDate today = now.InZone(zone).Date;

    Period period = Period.Between(dateOfBirth, today, PeriodUnits.Years);

    return (int) period.Years;
} 
```

用法：

```
LocalDate dateOfBirth = new LocalDate(1976, 8, 27);
int age = GetAge(dateOfBirth); 
```

您可能还对以下改进感兴趣：

*   将时钟作为 传递`IClock`，而不是使用`SystemClock.Instance`，将提高可测试性。

*   目标时区可能会发生变化，因此您也需要一个`DateTimeZone`参数。

另请参阅我关于此主题的博客文章：[处理生日和其他纪念日](https://codeofmatt.com/2014/04/09/handling-birthdays-and-other-anniversaries/)

* * *

## 回答 #28

> 赞同：10
> 
> 时间：2016-06-30T11:24:56.357

SQL 版本：

```
declare @dd smalldatetime = '1980-04-01'
declare @age int = YEAR(GETDATE())-YEAR(@dd)
if (@dd> DATEADD(YYYY, -@age, GETDATE())) set @age = @age -1

print @age 
```

* * *

## 回答 #29

> 赞同：9
> 
> 时间：2011-08-12T20:53:56.410

我使用 ScArcher2 的解决方案来准确计算一个人的年龄，但我需要进一步计算他们的月份和日期以及年份。

```
 public static Dictionary<string,int> CurrentAgeInYearsMonthsDays(DateTime? ndtBirthDate, DateTime? ndtReferralDate)
    {
        //----------------------------------------------------------------------
        // Can't determine age if we don't have a dates.
        //----------------------------------------------------------------------
        if (ndtBirthDate == null) return null;
        if (ndtReferralDate == null) return null;

        DateTime dtBirthDate = Convert.ToDateTime(ndtBirthDate);
        DateTime dtReferralDate = Convert.ToDateTime(ndtReferralDate);

        //----------------------------------------------------------------------
        // Create our Variables
        //----------------------------------------------------------------------
        Dictionary<string, int> dYMD = new Dictionary<string,int>();
        int iNowDate, iBirthDate, iYears, iMonths, iDays;
        string sDif = "";

        //----------------------------------------------------------------------
        // Store off current date/time and DOB into local variables
        //---------------------------------------------------------------------- 
        iNowDate = int.Parse(dtReferralDate.ToString("yyyyMMdd"));
        iBirthDate = int.Parse(dtBirthDate.ToString("yyyyMMdd"));

        //----------------------------------------------------------------------
        // Calculate Years
        //----------------------------------------------------------------------
        sDif = (iNowDate - iBirthDate).ToString();
        iYears = int.Parse(sDif.Substring(0, sDif.Length - 4));

        //----------------------------------------------------------------------
        // Store Years in Return Value
        //----------------------------------------------------------------------
        dYMD.Add("Years", iYears);

        //----------------------------------------------------------------------
        // Calculate Months
        //----------------------------------------------------------------------
        if (dtBirthDate.Month > dtReferralDate.Month)
            iMonths = 12 - dtBirthDate.Month + dtReferralDate.Month - 1;
        else
            iMonths = dtBirthDate.Month - dtReferralDate.Month;

        //----------------------------------------------------------------------
        // Store Months in Return Value
        //----------------------------------------------------------------------
        dYMD.Add("Months", iMonths);

        //----------------------------------------------------------------------
        // Calculate Remaining Days
        //----------------------------------------------------------------------
        if (dtBirthDate.Day > dtReferralDate.Day)
            //Logic: Figure out the days in month previous to the current month, or the admitted month.
            //       Subtract the birthday from the total days which will give us how many days the person has lived since their birthdate day the previous month.
            //       then take the referral date and simply add the number of days the person has lived this month.

            //If referral date is january, we need to go back to the following year's December to get the days in that month.
            if (dtReferralDate.Month == 1)
                iDays = DateTime.DaysInMonth(dtReferralDate.Year - 1, 12) - dtBirthDate.Day + dtReferralDate.Day;       
            else
                iDays = DateTime.DaysInMonth(dtReferralDate.Year, dtReferralDate.Month - 1) - dtBirthDate.Day + dtReferralDate.Day;       
        else
            iDays = dtReferralDate.Day - dtBirthDate.Day;             

        //----------------------------------------------------------------------
        // Store Days in Return Value
        //----------------------------------------------------------------------
        dYMD.Add("Days", iDays);

        return dYMD;
} 
```

* * *

## 回答 #30

> 赞同：8
> 
> 时间：2011-07-16T18:01:50.027

我对[Mark Soen 的](https://stackoverflow.com/questions/9/how-do-i-calculate-someones-age-in-c/1404#1404)回答做了一个小改动：我重写了第三行，以便可以更轻松地解析表达式。

```
public int AgeInYears(DateTime bday)
{
    DateTime now = DateTime.Today;
    int age = now.Year - bday.Year;            
    if (bday.AddYears(age) > now) 
        age--;
    return age;
} 
```

为了清楚起见，我还把它变成了一个函数。

* * *

## 回答 #31

> 赞同：8
> 
> 时间：2012-02-24T12:58:54.110

这很简单，似乎对我的需要很准确。我出于闰年的目的做一个假设，无论这个人什么时候选择庆祝生日，他们在技术上不会老一岁，直到他们上一个生日过去了 365 天（即 2 月 28 日不会让他们老一岁） .

```
DateTime now = DateTime.Today;
DateTime birthday = new DateTime(1991, 02, 03);//3rd feb

int age = now.Year - birthday.Year;

if (now.Month < birthday.Month || (now.Month == birthday.Month && now.Day < birthday.Day))//not had bday this year yet
  age--;

return age; 
```

* * *

## 回答 #32

> 赞同：7
> 
> 时间：2016-10-22T19:10:42.360

```
private int GetYearDiff(DateTime start, DateTime end)
{
    int diff = end.Year - start.Year;
    if (end.DayOfYear < start.DayOfYear) { diff -= 1; }
    return diff;
}
[Fact]
public void GetYearDiff_WhenCalls_ShouldReturnCorrectYearDiff()
{
    //arrange
    var now = DateTime.Now;
    //act
    //assert
    Assert.Equal(24, GetYearDiff(new DateTime(1992, 7, 9), now)); // passed
    Assert.Equal(24, GetYearDiff(new DateTime(1992, now.Month, now.Day), now)); // passed
    Assert.Equal(23, GetYearDiff(new DateTime(1992, 12, 9), now)); // passed
} 
```

* * *

## 回答 #33

> 赞同：7
> 
> 时间：2016-09-29T20:13:16.907

哇，我不得不在这里给出我的答案......这么简单的问题有很多答案。

```
private int CalcularIdade(DateTime dtNascimento)
    {
        var nHoje = Convert.ToInt32(DateTime.Today.ToString("yyyyMMdd"));
        var nAniversario = Convert.ToInt32(dtNascimento.ToString("yyyyMMdd"));

        double diff = (nHoje - nAniversario) / 10000;

        var ret = Convert.ToInt32(Math.Truncate(diff));

        return ret;
    } 
```

* * *

## 回答 #34

> 赞同：7
> 
> 时间：2016-05-04T08:29:20.850

===**俗语（从几个月到几年）** ===

如果您只是为了常用，这里是代码作为您的信息：

```
DateTime today = DateTime.Today;
DateTime bday = DateTime.Parse("2016-2-14");
int age = today.Year - bday.Year;
var unit = "";

if (bday > today.AddYears(-age))
{
    age--;
}
if (age == 0)   // Under one year old
{
    age = today.Month - bday.Month;

    age = age <= 0 ? (12 + age) : age;  // The next year before birthday

    age = today.Day - bday.Day >= 0 ? age : --age;  // Before the birthday.day

    unit = "month";
}
else {
    unit = "year";
}

if (age > 1)
{
    unit = unit + "s";
} 
```

测试结果如下：

```
The birthday: 2016-2-14

2016-2-15 =>  age=0, unit=month;
2016-5-13 =>  age=2, unit=months;
2016-5-14 =>  age=3, unit=months; 
2016-6-13 =>  age=3, unit=months; 
2016-6-15 =>  age=4, unit=months; 
2017-1-13 =>  age=10, unit=months; 
2017-1-14 =>  age=11, unit=months; 
2017-2-13 =>  age=11, unit=months; 
2017-2-14 =>  age=1, unit=year; 
2017-2-15 =>  age=1, unit=year; 
2017-3-13 =>  age=1, unit=year;
2018-1-13 =>  age=1, unit=year; 
2018-1-14 =>  age=1, unit=year; 
2018-2-13 =>  age=1, unit=year; 
2018-2-14 =>  age=2, unit=years; 
```

* * *

## 回答 #35

> 赞同：5
> 
> 时间：2009-11-28T01:58:57.403

这可能有效：

```
public override bool IsValid(DateTime value)
{
    _dateOfBirth =  value;
    var yearsOld = (double) (DateTime.Now.Subtract(_dateOfBirth).TotalDays/365);
    if (yearsOld > 18)
        return true;
    return false;
} 
```

* * *

## 回答 #36

> 赞同：5
> 
> 时间：2015-06-26T16:00:29.003

可以这么简单：

```
int age = DateTime.Now.AddTicks(0 - dob.Ticks).Year - 1; 
```

* * *

## 回答 #37

> 赞同：5
> 
> 时间：2016-04-27T14:58:06.170

这是在一行中回答这个问题的最简单方法。

```
DateTime Dob = DateTime.Parse("1985-04-24");

int Age = DateTime.MinValue.AddDays(DateTime.Now.Subtract(Dob).TotalHours/24 - 1).Year - 1; 
```

这也适用于闰年。

* * *

## 回答 #38

> 赞同：4
> 
> 时间：2009-12-18T14:55:36.833

这是我敲出的 C# 的一个小代码示例，请注意边缘情况，特别是闰年，并非所有上述解决方案都将它们考虑在内。将答案作为 DateTime 推出可能会导致问题，因为您最终可能会尝试将太多天放入特定月份，例如 2 月的 30 天。

```
public string LoopAge(DateTime myDOB, DateTime FutureDate)
{
    int years = 0;
    int months = 0;
    int days = 0;

    DateTime tmpMyDOB = new DateTime(myDOB.Year, myDOB.Month, 1);

    DateTime tmpFutureDate = new DateTime(FutureDate.Year, FutureDate.Month, 1);

    while (tmpMyDOB.AddYears(years).AddMonths(months) < tmpFutureDate)
    {
        months++;
        if (months > 12)
        {
            years++;
            months = months - 12;
        }
    }

    if (FutureDate.Day >= myDOB.Day)
    {
        days = days + FutureDate.Day - myDOB.Day;
    }
    else
    {
        months--;
        if (months < 0)
        {
            years--;
            months = months + 12;
        }
        days = days + (DateTime.DaysInMonth(FutureDate.AddMonths(-1).Year, FutureDate.AddMonths(-1).Month) + FutureDate.Day) - myDOB.Day;

    }

    //add an extra day if the dob is a leap day
    if (DateTime.IsLeapYear(myDOB.Year) && myDOB.Month == 2 && myDOB.Day == 29)
    {
        //but only if the future date is less than 1st March
        if(FutureDate >= new DateTime(FutureDate.Year, 3,1))
            days++;
    }

    return "Years: " + years + " Months: " + months + " Days: " + days;
} 
```

* * *

## 回答 #39

> 赞同：4
> 
> 时间：2011-05-20T16:48:34.793

这是一个将年龄计算添加到 DateTime 对象的 DateTime 扩展器。

```
public static class AgeExtender
{
    public static int GetAge(this DateTime dt)
    {
        int d = int.Parse(dt.ToString("yyyyMMdd"));
        int t = int.Parse(DateTime.Today.ToString("yyyyMMdd"));
        return (t-d)/10000;
    }
} 
```

* * *

## 回答 #40

> 赞同：4
> 
> 时间：2015-10-12T13:12:02.937

```
public string GetAge(this DateTime birthdate, string ageStrinFormat = null)
{
    var date = DateTime.Now.AddMonths(-birthdate.Month).AddDays(-birthdate.Day);
    return string.Format(ageStrinFormat ?? "{0}/{1}/{2}",
        (date.Year - birthdate.Year), date.Month, date.Day);
} 
```

* * *

## 回答 #41

> 赞同：3
> 
> 时间：2008-09-26T20:07:37.550

我认为 TimeSpan 包含我们需要的所有内容，而不必求助于 365.25（或任何其他近似值）。扩展 Aug 的示例：

```
DateTime myBD = new DateTime(1980, 10, 10);
TimeSpan difference = DateTime.Now.Subtract(myBD);

textBox1.Text = difference.Years + " years " + difference.Months + " Months " + difference.Days + " days"; 
```

* * *

## 回答 #42

> 赞同：3
> 
> 时间：2012-01-11T08:58:06.833

我想添加希伯来日历计算（或其他 System.Globalization 日历可以以相同的方式使用），使用此线程中的重写函数：

```
Public Shared Function CalculateAge(BirthDate As DateTime) As Integer
    Dim HebCal As New System.Globalization.HebrewCalendar ()
    Dim now = DateTime.Now()
    Dim iAge = HebCal.GetYear(now) - HebCal.GetYear(BirthDate)
    Dim iNowMonth = HebCal.GetMonth(now), iBirthMonth = HebCal.GetMonth(BirthDate)
    If iNowMonth < iBirthMonth Or (iNowMonth = iBirthMonth AndAlso HebCal.GetDayOfMonth(now) < HebCal.GetDayOfMonth(BirthDate)) Then iAge -= 1
    Return iAge
End Function 
```

* * *

## 回答 #43

> 赞同：3
> 
> 时间：2015-10-05T17:09:38.217

我在这个问题上使用了以下内容。我知道这不是很优雅，但它正在工作。

```
DateTime zeroTime = new DateTime(1, 1, 1);
var date1 = new DateTime(1983, 03, 04);
var date2 = DateTime.Now;
var dif = date2 - date1;
int years = (zeroTime + dif).Year - 1;
Log.DebugFormat("Years -->{0}", years); 
```

* * *

## 回答 #44

> 赞同：3
> 
> 时间：2017-07-16T10:39:21.870

我经常数我的手指。当事情发生变化时，我需要查看日历来确定。所以这就是我在我的代码中所做的：

```
int AgeNow(DateTime birthday)
{
    return AgeAt(DateTime.Now, birthday);
}

int AgeAt(DateTime now, DateTime birthday)
{
    return AgeAt(now, birthday, CultureInfo.CurrentCulture.Calendar);
}

int AgeAt(DateTime now, DateTime birthday, Calendar calendar)
{
    // My age has increased on the morning of my
    // birthday even though I was born in the evening.
    now = now.Date;
    birthday = birthday.Date;

    var age = 0;
    if (now <= birthday) return age; // I am zero now if I am to be born tomorrow.

    while (calendar.AddYears(birthday, age + 1) <= now)
    {
        age++;
    }
    return age;
} 
```

在[LINQPad](https://en.wikipedia.org/wiki/LINQPad)中运行它会给出：

```
PASSED: someone born on 28 February 1964 is age 4 on 28 February 1968
PASSED: someone born on 29 February 1964 is age 3 on 28 February 1968
PASSED: someone born on 31 December 2016 is age 0 on 01 January 2017 
```

LINQPad 中的代码在[这里](http://share.linqpad.net/3gx8ba.linq)。

* * *

## 回答 #45

> 赞同：3
> 
> 时间：2017-12-15T17:27:13.080

只需使用：

```
(DateTime.Now - myDate).TotalHours / 8766.0 
```

当前日期 - `myDate = TimeSpan`，获取总小时数并除以每年的总小时数，并获得准确的年龄/月/日...

* * *

## 回答 #46

> 赞同：2
> 
> 时间：2009-12-16T09:55:00.157

我创建了一个 Age 结构，如下所示：

```
public struct Age : IEquatable<Age>, IComparable<Age>
{
    private readonly int _years;
    private readonly int _months;
    private readonly int _days;

    public int Years  { get { return _years; } }
    public int Months { get { return _months; } }
    public int Days { get { return _days; } }

    public Age( int years, int months, int days ) : this()
    {
        _years = years;
        _months = months;
        _days = days;
    }

    public static Age CalculateAge( DateTime dateOfBirth, DateTime date )
    {
        // Here is some logic that ressembles Mike's solution, although it
        // also takes into account months & days.
        // Ommitted for brevity.
        return new Age (years, months, days);
    }

    // Ommited Equality, Comparable, GetHashCode, functionality for brevity.
} 
```

* * *

## 回答 #47

> 赞同：2
> 
> 时间：2012-07-04T11:28:23.810

试试这个解决方案，它的工作。

```
int age = (Int32.Parse(DateTime.Today.ToString("yyyyMMdd")) - 
           Int32.Parse(birthday.ToString("yyyyMMdd rawrrr"))) / 10000; 
```

* * *

## 回答 #48

> 赞同：2
> 
> 时间：2013-09-19T13:15:37.123

> 为什么 MSDN 的帮助没有告诉你呢？看起来很明显：

```
System.DateTime birthTime = AskTheUser(myUser); // :-)
System.DateTime now = System.DateTime.Now;
System.TimeSpan age = now - birthTime; // As simple as that
double ageInDays = age.TotalDays; // Will you convert to whatever you want yourself? 
```

* * *

## 回答 #49

> 赞同：2
> 
> 时间：2015-02-17T17:24:51.690

只是因为我认为最佳答案不是那么清楚：

```
public static int GetAgeByLoop(DateTime birthday)
{
    var age = -1;

    for (var date = birthday; date < DateTime.Today; date = date.AddYears(1))
    {
        age++;
    }

    return age;
} 
```

* * *

## 回答 #50

> 赞同：2
> 
> 时间：2013-09-08T11:01:48.493

通过更少的转换和 UtcNow，这段代码可以照顾在闰年 2 月 29 日出生的人：

```
public int GetAge(DateTime DateOfBirth)
{
    var Now = DateTime.UtcNow;
    return Now.Year - DateOfBirth.Year -
        (
            (
                Now.Month > DateOfBirth.Month ||
                (Now.Month == DateOfBirth.Month && Now.Day >= DateOfBirth.Day)
            ) ? 0 : 1
        );
} 
```

* * *

## 回答 #51

> 赞同：2
> 
> 时间：2013-01-02T16:09:02.437

这是一个非常简单易学的例子。

```
private int CalculateAge()
{
//get birthdate
   DateTime dtBirth = Convert.ToDateTime(BirthDatePicker.Value);
   int byear = dtBirth.Year;
   int bmonth = dtBirth.Month;
   int bday = dtBirth.Day;
   DateTime dtToday = DateTime.Now;
   int tYear = dtToday.Year;
   int tmonth = dtToday.Month;
   int tday = dtToday.Day;
   int age = tYear - byear;
   if (bmonth < tmonth)
       age--;
   else if (bmonth == tmonth && bday>tday)
   {
       age--;
   }
return age;
} 
```

* * *

## 回答 #52

> 赞同：2
> 
> 时间：2015-06-24T11:26:39.537

这是一个对我很有帮助的功能。不用计算，很简单。

```
 public static string ToAge(this DateTime dob, DateTime? toDate = null)
    {
        if (!toDate.HasValue)
            toDate = DateTime.Now;
        var now = toDate.Value;

        if (now.CompareTo(dob) < 0)
            return "Future date";

        int years = now.Year - dob.Year;
        int months = now.Month - dob.Month;
        int days = now.Day - dob.Day;

        if (days < 0)
        {
            months--;
            days = DateTime.DaysInMonth(dob.Year, dob.Month) - dob.Day + now.Day;
        }

        if (months < 0)
        {
            years--;
            months = 12 + months;
        }

        return string.Format("{0} year(s), {1} month(s), {2} days(s)",
            years,
            months,
            days);
    } 
```

这是一个单元测试：

```
 [Test]
    public void ToAgeTests()
    {
        var date = new DateTime(2000, 1, 1);
        Assert.AreEqual("0 year(s), 0 month(s), 1 days(s)", new DateTime(1999, 12, 31).ToAge(date));
        Assert.AreEqual("0 year(s), 0 month(s), 0 days(s)", new DateTime(2000, 1, 1).ToAge(date));
        Assert.AreEqual("1 year(s), 0 month(s), 0 days(s)", new DateTime(1999, 1, 1).ToAge(date));
        Assert.AreEqual("0 year(s), 11 month(s), 0 days(s)", new DateTime(1999, 2, 1).ToAge(date));
        Assert.AreEqual("0 year(s), 10 month(s), 25 days(s)", new DateTime(1999, 2, 4).ToAge(date));
        Assert.AreEqual("0 year(s), 10 month(s), 1 days(s)", new DateTime(1999, 2, 28).ToAge(date));

        date = new DateTime(2000, 2, 15);
        Assert.AreEqual("0 year(s), 0 month(s), 28 days(s)", new DateTime(2000, 1, 18).ToAge(date));
    } 
```

* * *

## 回答 #53

> 赞同：2
> 
> 时间：2015-07-02T07:37:49.237

我会这样做：

```
DateTime birthDay = new DateTime(1990, 05, 23);
DateTime age = DateTime.Now - birthDay; 
```

通过这种方式，您可以计算一个人的确切年龄，如果需要，可以精确到毫秒。

* * *

## 回答 #54

> 赞同：2
> 
> 时间：2017-10-27T06:43:04.703

简单代码

```
 var birthYear=1993;
 var age = DateTime.Now.AddYears(-birthYear).Year; 
```

* * *

## 回答 #55

> 赞同：2
> 
> 时间：2018-02-15T11:17:51.823

```
var birthDate = ... // DOB
var resultDate = DateTime.Now - birthDate; 
```

使用`resultDate`您可以应用`TimeSpan`任何您想要显示的属性。

* * *

## 回答 #56

> 赞同：2
> 
> 时间：2018-02-08T15:10:18.017

这是计算某人年龄的最简单方法。
计算某人的年龄非常简单，方法如下！为了使代码正常工作，您需要一个名为 BirthDate 的 DateTime 对象，其中包含生日。

```
 C#
        // get the difference in years
        int years = DateTime.Now.Year - BirthDate.Year; 
        // subtract another year if we're before the
        // birth day in the current year
        if (DateTime.Now.Month < BirthDate.Month || 
            (DateTime.Now.Month == BirthDate.Month && 
            DateTime.Now.Day < BirthDate.Day)) 
            years--;
  VB.NET
        ' get the difference in years
        Dim years As Integer = DateTime.Now.Year - BirthDate.Year
        ' subtract another year if we're before the
        ' birth day in the current year
        If DateTime.Now.Month < BirthDate.Month Or (DateTime.Now.Month = BirthDate.Month And DateTime.Now.Day < BirthDate.Day) Then 
            years = years - 1
        End If 
```

* * *

## 回答 #57

> 赞同：1
> 
> 时间：2021-09-24T01:24:41.480

我强烈建议使用一个名为[AgeCalculator](https://www.nuget.org/packages/AgeCalculator/)的 NuGet 包，因为在计算年龄（闰年、时间分量等）时需要考虑很多事情，而且只有两行代码不能解决问题。图书馆给你的时间不止一年。它甚至在计算时考虑了时间成分，因此您可以获得包含年、月、日和时间成分的准确年龄。更先进的是，可以选择将闰年的 2 月 29 日视为非闰年的 2 月 28 日。

* * *

## 回答 #58

> 赞同：0
> 
> 时间：2021-11-15T21:33:05.663

这是一个非常简单的方法：

```
int Age = DateTime.Today.Year - new DateTime(2000, 1, 1).Year; 
```

* * *

## 回答 #59

> 赞同：0
> 
> 时间：2020-10-06T05:44:29.610

我对此一无所知，`DateTime`但我能做的就是：

```
using System;

public class Program
{
    public static int getAge(int month, int day, int year) {
        DateTime today = DateTime.Today;
        int currentDay = today.Day;
        int currentYear = today.Year;
        int currentMonth = today.Month;
        int age = 0;
        if (currentMonth < month) {
            age -= 1;
        } else if (currentMonth == month) {
            if (currentDay < day) {
                age -= 1;
            }
        }
        currentYear -= year;
        age += currentYear;
        return age;
    }
    public static void Main()
    {
        int ageInYears = getAge(8, 10, 2007);
        Console.WriteLine(ageInYears);
    }
} 
```

有点混乱，但更仔细地查看代码，这一切都会有意义。

* * *

## 回答 #60

> 赞同：0
> 
> 时间：2020-09-27T06:07:33.067

```
int Age = new DateTime((DateTime.Now - BirthDate).Ticks).Year -1;
Console.WriteLine("Age {0}", Age); 
```

* * *

## 回答 #61

> 赞同：0
> 
> 时间：2021-08-14T13:35:38.050

```
var startDate = new DateTime(2015, 04, 05);//your start date
var endDate = DateTime.Now;
var years = 0;
while(startDate < endDate) 
{
     startDate = startDate.AddYears(1);
     if(startDate < endDate) 
     {
         years++;
     }
} 
```

* * *

## 回答 #62

> 赞同：0
> 
> 时间：2022-01-10T21:43:36.310

无分支解决方案：

```
public int GetAge(DateOnly birthDate, DateOnly today)
{
    return today.Year - birthDate.Year + (((today.Month << 5) + today.Day - ((birthDate.Month << 5) + birthDate.Day)) >> 31);
} 
```

* * *

## 回答 #63

> 赞同：0
> 
> 时间：2020-03-05T08:37:04.467

很简单的答案

```
 DateTime dob = new DateTime(1991, 3, 4); 
        DateTime now = DateTime.Now; 
        int dobDay = dob.Day, dobMonth = dob.Month; 
        int add = -1; 
        if (dobMonth < now.Month)
        {
            add = 0;
        }
        else if (dobMonth == now.Month)
        {
            if(dobDay <= now.Day)
            {
                add = 0;
            }
            else
            {
                add = -1;
            }
        }
        else
        {
            add = -1;
        } 
        int age = now.Year - dob.Year + add; 
```

* * *

## 回答 #64

> 赞同：0
> 
> 时间：2017-10-31T12:09:08.403

要计算一个人的年龄，

```
DateTime dateOfBirth;

int ageInYears = DateTime.Now.Year - dateOfBirth.Year;

if (dateOfBirth > today.AddYears(-ageInYears )) ageInYears --; 
```

* * *

## 回答 #65

> 赞同：0
> 
> 时间：2021-09-09T18:22:12.203

可以这样计算“年龄”（即“西方”方式）：

```
public static int AgeInYears(this System.DateTime source, System.DateTime target)
  => target.Year - source.Year is int age && age > 0 && source.AddYears(age) > target ? age - 1 : age < 0 && source.AddYears(age) < target ? age + 1 : age; 
```

如果时间的方向是“负”的，那么年龄也将是负的。

可以添加一个分数，表示从目标到下一个生日累积的年龄量：

```
public static double AgeInTotalYears(this System.DateTime source, System.DateTime target)
{
  var sign = (source <= target ? 1 : -1);

  var ageInYears = AgeInYears(source, target); // The method above.

  var last = source.AddYears(ageInYears);
  var next = source.AddYears(ageInYears + sign);

  var fractionalAge = (double)(target - last).Ticks / (double)(next - last).Ticks * sign;

  return ageInYears + fractionalAge;
} 
```

分数是过去的时间（从上一个生日）与总时间（到下一个生日）的比率。

无论是向前还是向后，这两种方法的工作方式都是相同的。

* * *

## 回答 #66

> 赞同：0
> 
> 时间：2022-02-19T14:25:44.773

简单易读的互补方法

```
public static int getAge(DateTime birthDate)
{
    var today = DateTime.Today;
    var age = today.Year - birthDate.Year;
    var monthDiff = today.Month - birthDate.Month;
    var dayDiff = today.Day - birthDate.Day;

    if (dayDiff < 0)
    {
        monthDiff--;
    }
    if (monthDiff < 0)
    {
       age--;
    }
    return age;
} 
```

* * *

## 回答 #67

> 赞同：-1
> 
> 时间：2015-05-09T22:03:15.867

看一下这个：

```
TimeSpan ts = DateTime.Now.Subtract(Birthdate);
age = (byte)(ts.TotalDays / 365.25); 
```

* * *

## 回答 #68

> 赞同：-1
> 
> 时间：2020-09-30T10:10:03.157

我认为这个问题可以用像这样更简单的方法来解决 -

该课程可以像-

```
using System;

namespace TSA
{
    class BirthDay
    {
        double ageDay;
        public BirthDay(int day, int month, int year)
        {
            DateTime birthDate = new DateTime(year, month, day);
            ageDay = (birthDate - DateTime.Now).TotalDays; //DateTime.UtcNow
        }

        internal int GetAgeYear()
        {
            return (int)Math.Truncate(ageDay / 365);
        }

        internal int GetAgeMonth()
        {
            return (int)Math.Truncate((ageDay % 365) / 30);
        }
    }
} 
```

电话可以像-

```
BirthDay b = new BirthDay(1,12,1990);
int year = b.GetAgeYear();
int month = b.GetAgeMonth(); 
```

* * *

## 回答 #69

> 赞同：-2
> 
> 时间：2013-12-03T10:14:42.120

计算年龄最近的年龄：

```
var ts = DateTime.Now - new DateTime(1988, 3, 19);
var age = Math.Round(ts.Days / 365.0); 
```

* * *

## 回答 #70

> 赞同：-3
> 
> 时间：2014-07-29T11:46:24.993

单线答案：

```
DateTime dateOfBirth = Convert.ToDateTime("01/16/1990");
var age = ((DateTime.Now - dateOfBirth).Days) / 365; 
```*

# c# - Calculate relative time in C#

> ID：11
> 
> 赞同：1609
> 
> 时间：2008-07-31T23:55:37.967
> 
> 标签：c#, datetime, time, datediff, relative-time-span

Given a specific `DateTime` value, how do I display relative time, like:

*   2 hours ago
*   3 days ago
*   a month ago

* * *

## 回答 #1

> 赞同：1050
> 
> 时间：2008-08-04T13:57:26.097

杰夫，[您的代码](https://stackoverflow.com/questions/11/how-do-i-calculate-relative-time/12#12)很好，但使用常量可能更清晰（如代码完成中所建议的那样）。

```
const int SECOND = 1;
const int MINUTE = 60 * SECOND;
const int HOUR = 60 * MINUTE;
const int DAY = 24 * HOUR;
const int MONTH = 30 * DAY;

var ts = new TimeSpan(DateTime.UtcNow.Ticks - yourDate.Ticks);
double delta = Math.Abs(ts.TotalSeconds);

if (delta < 1 * MINUTE)
  return ts.Seconds == 1 ? "one second ago" : ts.Seconds + " seconds ago";

if (delta < 2 * MINUTE)
  return "a minute ago";

if (delta < 45 * MINUTE)
  return ts.Minutes + " minutes ago";

if (delta < 90 * MINUTE)
  return "an hour ago";

if (delta < 24 * HOUR)
  return ts.Hours + " hours ago";

if (delta < 48 * HOUR)
  return "yesterday";

if (delta < 30 * DAY)
  return ts.Days + " days ago";

if (delta < 12 * MONTH)
{
  int months = Convert.ToInt32(Math.Floor((double)ts.Days / 30));
  return months <= 1 ? "one month ago" : months + " months ago";
}
else
{
  int years = Convert.ToInt32(Math.Floor((double)ts.Days / 365));
  return years <= 1 ? "one year ago" : years + " years ago";
} 
```

* * *

## 回答 #2

> 赞同：365
> 
> 时间：2008-09-21T16:04:55.783

## [jquery.timeago 插件](https://timeago.yarp.com/)

Jeff，因为 Stack Overflow 广泛使用 jQuery，我推荐[jquery.timeago 插件](https://timeago.yarp.com/)。

好处：

*   即使页面是在 10 分钟前打开的，也要避免使用“1 分钟前”的时间戳；timeago 自动刷新。
*   您可以充分利用 Web 应用程序中的页面和/或片段缓存，因为时间戳不是在服务器上计算的。
*   你可以像酷孩子一样使用微格式。

只需将其附加到 DOM 上的时间戳即可：

```
jQuery(document).ready(function() {
    jQuery('abbr.timeago').timeago();
}); 
```

这将在标题中转换所有`abbr`具有 timeago 类和[ISO 8601](https://en.wikipedia.org/wiki/ISO_8601)时间戳的元素：

```
<abbr class="timeago" title="2008-07-17T09:24:17Z">July 17, 2008</abbr> 
```

变成这样的东西：

```
<abbr class="timeago" title="July 17, 2008">4 months ago</abbr> 
```

产生：4个月前。随着时间的推移，时间戳会自动更新。

*免责声明：我写了这个插件，所以我有偏见。*

* * *

## 回答 #3

> 赞同：340
> 
> 时间：2008-07-31T23:56:41.303

Here's how I do it

```
var ts = new TimeSpan(DateTime.UtcNow.Ticks - dt.Ticks);
double delta = Math.Abs(ts.TotalSeconds);

if (delta < 60)
{
  return ts.Seconds == 1 ? "one second ago" : ts.Seconds + " seconds ago";
}
if (delta < 60 * 2)
{
  return "a minute ago";
}
if (delta < 45 * 60)
{
  return ts.Minutes + " minutes ago";
}
if (delta < 90 * 60)
{
  return "an hour ago";
}
if (delta < 24 * 60 * 60)
{
  return ts.Hours + " hours ago";
}
if (delta < 48 * 60 * 60)
{
  return "yesterday";
}
if (delta < 30 * 24 * 60 * 60)
{
  return ts.Days + " days ago";
}
if (delta < 12 * 30 * 24 * 60 * 60)
{
  int months = Convert.ToInt32(Math.Floor((double)ts.Days / 30));
  return months <= 1 ? "one month ago" : months + " months ago";
}
int years = Convert.ToInt32(Math.Floor((double)ts.Days / 365));
return years <= 1 ? "one year ago" : years + " years ago"; 
```

Suggestions? Comments? Ways to improve this algorithm?

* * *

## 回答 #4

> 赞同：96
> 
> 时间：2008-08-14T05:43:45.330

```
public static string RelativeDate(DateTime theDate)
{
    Dictionary<long, string> thresholds = new Dictionary<long, string>();
    int minute = 60;
    int hour = 60 * minute;
    int day = 24 * hour;
    thresholds.Add(60, "{0} seconds ago");
    thresholds.Add(minute * 2, "a minute ago");
    thresholds.Add(45 * minute, "{0} minutes ago");
    thresholds.Add(120 * minute, "an hour ago");
    thresholds.Add(day, "{0} hours ago");
    thresholds.Add(day * 2, "yesterday");
    thresholds.Add(day * 30, "{0} days ago");
    thresholds.Add(day * 365, "{0} months ago");
    thresholds.Add(long.MaxValue, "{0} years ago");
    long since = (DateTime.Now.Ticks - theDate.Ticks) / 10000000;
    foreach (long threshold in thresholds.Keys) 
    {
        if (since < threshold) 
        {
            TimeSpan t = new TimeSpan((DateTime.Now.Ticks - theDate.Ticks));
            return string.Format(thresholds[threshold], (t.Days > 365 ? t.Days / 365 : (t.Days > 0 ? t.Days : (t.Hours > 0 ? t.Hours : (t.Minutes > 0 ? t.Minutes : (t.Seconds > 0 ? t.Seconds : 0))))).ToString());
        }
    }
    return "";
} 
```

我更喜欢这个版本，因为它简洁，并且能够添加新的刻度点。这可以通过`Latest()`对 Timespan 的扩展而不是那个长的 1 行来封装，但是为了发布的简洁起见，这样做可以。 **这修复了一个小时前，1 小时前，提供一个小时直到 2 小时过去**

* * *

## 回答 #5

> 赞同：71
> 
> 时间：2008-09-17T03:19:19.487

```
public static string ToRelativeDate(DateTime input)
{
    TimeSpan oSpan = DateTime.Now.Subtract(input);
    double TotalMinutes = oSpan.TotalMinutes;
    string Suffix = " ago";

    if (TotalMinutes < 0.0)
    {
        TotalMinutes = Math.Abs(TotalMinutes);
        Suffix = " from now";
    }

    var aValue = new SortedList<double, Func<string>>();
    aValue.Add(0.75, () => "less than a minute");
    aValue.Add(1.5, () => "about a minute");
    aValue.Add(45, () => string.Format("{0} minutes", Math.Round(TotalMinutes)));
    aValue.Add(90, () => "about an hour");
    aValue.Add(1440, () => string.Format("about {0} hours", Math.Round(Math.Abs(oSpan.TotalHours)))); // 60 * 24
    aValue.Add(2880, () => "a day"); // 60 * 48
    aValue.Add(43200, () => string.Format("{0} days", Math.Floor(Math.Abs(oSpan.TotalDays)))); // 60 * 24 * 30
    aValue.Add(86400, () => "about a month"); // 60 * 24 * 60
    aValue.Add(525600, () => string.Format("{0} months", Math.Floor(Math.Abs(oSpan.TotalDays / 30)))); // 60 * 24 * 365 
    aValue.Add(1051200, () => "about a year"); // 60 * 24 * 365 * 2
    aValue.Add(double.MaxValue, () => string.Format("{0} years", Math.Floor(Math.Abs(oSpan.TotalDays / 365))));

    return aValue.First(n => TotalMinutes < n.Key).Value.Invoke() + Suffix;
} 
```

[http://refactormycode.com/codes/493-twitter-esque-relative-dates](http://refactormycode.com/codes/493-twitter-esque-relative-dates)

C# 6 版本：

```
static readonly SortedList<double, Func<TimeSpan, string>> offsets = 
   new SortedList<double, Func<TimeSpan, string>>
{
    { 0.75, _ => "less than a minute"},
    { 1.5, _ => "about a minute"},
    { 45, x => $"{x.TotalMinutes:F0} minutes"},
    { 90, x => "about an hour"},
    { 1440, x => $"about {x.TotalHours:F0} hours"},
    { 2880, x => "a day"},
    { 43200, x => $"{x.TotalDays:F0} days"},
    { 86400, x => "about a month"},
    { 525600, x => $"{x.TotalDays / 30:F0} months"},
    { 1051200, x => "about a year"},
    { double.MaxValue, x => $"{x.TotalDays / 365:F0} years"}
};

public static string ToRelativeDate(this DateTime input)
{
    TimeSpan x = DateTime.Now - input;
    string Suffix = x.TotalMinutes > 0 ? " ago" : " from now";
    x = new TimeSpan(Math.Abs(x.Ticks));
    return offsets.First(n => x.TotalMinutes < n.Key).Value(x) + Suffix;
} 
```

* * *

## 回答 #6

> 赞同：71
> 
> 时间：2009-02-01T19:22:41.450

这里是 Jeffs Script for PHP 的重写：

```
define("SECOND", 1);
define("MINUTE", 60 * SECOND);
define("HOUR", 60 * MINUTE);
define("DAY", 24 * HOUR);
define("MONTH", 30 * DAY);
function relativeTime($time)
{   
    $delta = time() - $time;

    if ($delta < 1 * MINUTE)
    {
        return $delta == 1 ? "one second ago" : $delta . " seconds ago";
    }
    if ($delta < 2 * MINUTE)
    {
      return "a minute ago";
    }
    if ($delta < 45 * MINUTE)
    {
        return floor($delta / MINUTE) . " minutes ago";
    }
    if ($delta < 90 * MINUTE)
    {
      return "an hour ago";
    }
    if ($delta < 24 * HOUR)
    {
      return floor($delta / HOUR) . " hours ago";
    }
    if ($delta < 48 * HOUR)
    {
      return "yesterday";
    }
    if ($delta < 30 * DAY)
    {
        return floor($delta / DAY) . " days ago";
    }
    if ($delta < 12 * MONTH)
    {
      $months = floor($delta / DAY / 30);
      return $months <= 1 ? "one month ago" : $months . " months ago";
    }
    else
    {
        $years = floor($delta / DAY / 365);
        return $years <= 1 ? "one year ago" : $years . " years ago";
    }
} 
```

* * *

## 回答 #7

> 赞同：51
> 
> 时间：2009-03-09T22:02:29.940

这是我作为扩展方法添加到 DateTime 类的一个实现，它处理未来和过去的日期，并提供一个近似选项，允许您指定您正在寻找的详细程度（“3 小时前”与“3 小时， 23 分 12 秒前”）：

```
using System.Text;

/// <summary>
/// Compares a supplied date to the current date and generates a friendly English 
/// comparison ("5 days ago", "5 days from now")
/// </summary>
/// <param name="date">The date to convert</param>
/// <param name="approximate">When off, calculate timespan down to the second.
/// When on, approximate to the largest round unit of time.</param>
/// <returns></returns>
public static string ToRelativeDateString(this DateTime value, bool approximate)
{
    StringBuilder sb = new StringBuilder();

    string suffix = (value > DateTime.Now) ? " from now" : " ago";

    TimeSpan timeSpan = new TimeSpan(Math.Abs(DateTime.Now.Subtract(value).Ticks));

    if (timeSpan.Days > 0)
    {
        sb.AppendFormat("{0} {1}", timeSpan.Days,
          (timeSpan.Days > 1) ? "days" : "day");
        if (approximate) return sb.ToString() + suffix;
    }
    if (timeSpan.Hours > 0)
    {
        sb.AppendFormat("{0}{1} {2}", (sb.Length > 0) ? ", " : string.Empty,
          timeSpan.Hours, (timeSpan.Hours > 1) ? "hours" : "hour");
        if (approximate) return sb.ToString() + suffix;
    }
    if (timeSpan.Minutes > 0)
    {
        sb.AppendFormat("{0}{1} {2}", (sb.Length > 0) ? ", " : string.Empty, 
          timeSpan.Minutes, (timeSpan.Minutes > 1) ? "minutes" : "minute");
        if (approximate) return sb.ToString() + suffix;
    }
    if (timeSpan.Seconds > 0)
    {
        sb.AppendFormat("{0}{1} {2}", (sb.Length > 0) ? ", " : string.Empty, 
          timeSpan.Seconds, (timeSpan.Seconds > 1) ? "seconds" : "second");
        if (approximate) return sb.ToString() + suffix;
    }
    if (sb.Length == 0) return "right now";

    sb.Append(suffix);
    return sb.ToString();
} 
```

* * *

## 回答 #8

> 赞同：44
> 
> 时间：2014-04-09T11:50:10.300

Nuget 上还有一个名为[Humanizr](https://github.com/Humanizr/Humanizer)的包，它实际上运行良好，并且位于 .NET Foundation 中。

```
DateTime.UtcNow.AddHours(-30).Humanize() => "yesterday"
DateTime.UtcNow.AddHours(-2).Humanize() => "2 hours ago"

DateTime.UtcNow.AddHours(30).Humanize() => "tomorrow"
DateTime.UtcNow.AddHours(2).Humanize() => "2 hours from now"

TimeSpan.FromMilliseconds(1299630020).Humanize() => "2 weeks"
TimeSpan.FromMilliseconds(1299630020).Humanize(3) => "2 weeks, 1 day, 1 hour" 
```

Scott Hanselman 在他的[博客上有一篇文章](http://www.hanselman.com/blog/NuGetPackageOfTheWeekHumanizerMakesNETDataTypesMoreHuman.aspx)

* * *

## 回答 #9

> 赞同：37
> 
> 时间：2008-10-23T10:44:13.777

I would recommend computing this on the client side too. Less work for the server.

The following is the version that I use (from Zach Leatherman)

```
/*
 * Javascript Humane Dates
 * Copyright (c) 2008 Dean Landolt (deanlandolt.com)
 * Re-write by Zach Leatherman (zachleat.com)
 * 
 * Adopted from the John Resig's pretty.js
 * at http://ejohn.org/blog/javascript-pretty-date
 * and henrah's proposed modification 
 * at http://ejohn.org/blog/javascript-pretty-date/#comment-297458
 * 
 * Licensed under the MIT license.
 */

function humane_date(date_str){
        var time_formats = [
                [60, 'just now'],
                [90, '1 minute'], // 60*1.5
                [3600, 'minutes', 60], // 60*60, 60
                [5400, '1 hour'], // 60*60*1.5
                [86400, 'hours', 3600], // 60*60*24, 60*60
                [129600, '1 day'], // 60*60*24*1.5
                [604800, 'days', 86400], // 60*60*24*7, 60*60*24
                [907200, '1 week'], // 60*60*24*7*1.5
                [2628000, 'weeks', 604800], // 60*60*24*(365/12), 60*60*24*7
                [3942000, '1 month'], // 60*60*24*(365/12)*1.5
                [31536000, 'months', 2628000], // 60*60*24*365, 60*60*24*(365/12)
                [47304000, '1 year'], // 60*60*24*365*1.5
                [3153600000, 'years', 31536000], // 60*60*24*365*100, 60*60*24*365
                [4730400000, '1 century'] // 60*60*24*365*100*1.5
        ];

        var time = ('' + date_str).replace(/-/g,"/").replace(/[TZ]/g," "),
                dt = new Date,
                seconds = ((dt - new Date(time) + (dt.getTimezoneOffset() * 60000)) / 1000),
                token = ' ago',
                i = 0,
                format;

        if (seconds < 0) {
                seconds = Math.abs(seconds);
                token = '';
        }

        while (format = time_formats[i++]) {
                if (seconds < format[0]) {
                        if (format.length == 2) {
                                return format[1] + (i > 1 ? token : ''); // Conditional so we don't return Just Now Ago
                        } else {
                                return Math.round(seconds / format[2]) + ' ' + format[1] + (i > 1 ? token : '');
                        }
                }
        }

        // overflow for centuries
        if(seconds > 4730400000)
                return Math.round(seconds / 4730400000) + ' centuries' + token;

        return date_str;
};

if(typeof jQuery != 'undefined') {
        jQuery.fn.humane_dates = function(){
                return this.each(function(){
                        var date = humane_date(this.title);
                        if(date && jQuery(this).text() != date) // don't modify the dom if we don't have to
                                jQuery(this).text(date);
                });
        };
} 
```

* * *

## 回答 #10

> 赞同：33
> 
> 时间：2008-08-01T12:17:19.357

@jeff

IMHO yours seems a little long. However it does seem a little more robust with support for "yesterday" and "years". But in my experience when this is used, the person is most likely to view the content in the first 30 days. It is only the really hardcore people that come after that. So, I usually elect to keep this short and simple.

This is the method I am currently using in one of my websites. This returns only a relative day, hour and time. And then the user has to slap on "ago" in the output.

```
public static string ToLongString(this TimeSpan time)
{
    string output = String.Empty;

    if (time.Days > 0)
        output += time.Days + " days ";

    if ((time.Days == 0 || time.Days == 1) && time.Hours > 0)
        output += time.Hours + " hr ";

    if (time.Days == 0 && time.Minutes > 0)
        output += time.Minutes + " min ";

    if (output.Length == 0)
        output += time.Seconds + " sec";

    return output.Trim();
} 
```

* * *

## 回答 #11

> 赞同：25
> 
> 时间：2011-03-25T00:21:04.483

晚会晚了几年，但我有要求在过去和未来的日期都这样做，所以我把[Jeff](https://stackoverflow.com/questions/11/how-do-i-calculate-relative-time/12#12)和[Vincent](https://stackoverflow.com/questions/11/how-do-i-calculate-relative-time/1248#1248)合并到了这个中。这是一场三重盛宴！:)

```
public static class DateTimeHelper
    {
        private const int SECOND = 1;
        private const int MINUTE = 60 * SECOND;
        private const int HOUR = 60 * MINUTE;
        private const int DAY = 24 * HOUR;
        private const int MONTH = 30 * DAY;

        /// <summary>
        /// Returns a friendly version of the provided DateTime, relative to now. E.g.: "2 days ago", or "in 6 months".
        /// </summary>
        /// <param name="dateTime">The DateTime to compare to Now</param>
        /// <returns>A friendly string</returns>
        public static string GetFriendlyRelativeTime(DateTime dateTime)
        {
            if (DateTime.UtcNow.Ticks == dateTime.Ticks)
            {
                return "Right now!";
            }

            bool isFuture = (DateTime.UtcNow.Ticks < dateTime.Ticks);
            var ts = DateTime.UtcNow.Ticks < dateTime.Ticks ? new TimeSpan(dateTime.Ticks - DateTime.UtcNow.Ticks) : new TimeSpan(DateTime.UtcNow.Ticks - dateTime.Ticks);

            double delta = ts.TotalSeconds;

            if (delta < 1 * MINUTE)
            {
                return isFuture ? "in " + (ts.Seconds == 1 ? "one second" : ts.Seconds + " seconds") : ts.Seconds == 1 ? "one second ago" : ts.Seconds + " seconds ago";
            }
            if (delta < 2 * MINUTE)
            {
                return isFuture ? "in a minute" : "a minute ago";
            }
            if (delta < 45 * MINUTE)
            {
                return isFuture ? "in " + ts.Minutes + " minutes" : ts.Minutes + " minutes ago";
            }
            if (delta < 90 * MINUTE)
            {
                return isFuture ? "in an hour" : "an hour ago";
            }
            if (delta < 24 * HOUR)
            {
                return isFuture ? "in " + ts.Hours + " hours" : ts.Hours + " hours ago";
            }
            if (delta < 48 * HOUR)
            {
                return isFuture ? "tomorrow" : "yesterday";
            }
            if (delta < 30 * DAY)
            {
                return isFuture ? "in " + ts.Days + " days" : ts.Days + " days ago";
            }
            if (delta < 12 * MONTH)
            {
                int months = Convert.ToInt32(Math.Floor((double)ts.Days / 30));
                return isFuture ? "in " + (months <= 1 ? "one month" : months + " months") : months <= 1 ? "one month ago" : months + " months ago";
            }
            else
            {
                int years = Convert.ToInt32(Math.Floor((double)ts.Days / 365));
                return isFuture ? "in " + (years <= 1 ? "one year" : years + " years") : years <= 1 ? "one year ago" : years + " years ago";
            }
        }
    } 
```

* * *

## 回答 #12

> 赞同：21
> 
> 时间：2009-02-20T15:17:43.423

有没有一种简单的方法可以在 Java 中做到这一点？`java.util.Date`课程似乎相当有限。

这是我快速而肮脏的 Java 解决方案：

```
import java.util.Date;
import javax.management.timer.Timer;

String getRelativeDate(Date date) {     
  long delta = new Date().getTime() - date.getTime();
  if (delta < 1L * Timer.ONE_MINUTE) {
    return toSeconds(delta) == 1 ? "one second ago" : toSeconds(delta) + " seconds ago";
  }
  if (delta < 2L * Timer.ONE_MINUTE) {
    return "a minute ago";
  }
  if (delta < 45L * Timer.ONE_MINUTE) {
    return toMinutes(delta) + " minutes ago";
  }
  if (delta < 90L * Timer.ONE_MINUTE) {
    return "an hour ago";
  }
  if (delta < 24L * Timer.ONE_HOUR) {
    return toHours(delta) + " hours ago";
  }
  if (delta < 48L * Timer.ONE_HOUR) {
    return "yesterday";
  }
  if (delta < 30L * Timer.ONE_DAY) {
    return toDays(delta) + " days ago";
  }
  if (delta < 12L * 4L * Timer.ONE_WEEK) { // a month
    long months = toMonths(delta); 
    return months <= 1 ? "one month ago" : months + " months ago";
  }
  else {
    long years = toYears(delta);
    return years <= 1 ? "one year ago" : years + " years ago";
  }
}

private long toSeconds(long date) {
  return date / 1000L;
}

private long toMinutes(long date) {
  return toSeconds(date) / 60L;
}

private long toHours(long date) {
  return toMinutes(date) / 60L;
}

private long toDays(long date) {
  return toHours(date) / 24L;
}

private long toMonths(long date) {
  return toDays(date) / 30L;
}

private long toYears(long date) {
  return toMonths(date) / 365L;
} 
```

* * *

## 回答 #13

> 赞同：21
> 
> 时间：2010-02-11T12:23:32.800

## iPhone Objective-C 版本

```
+ (NSString *)timeAgoString:(NSDate *)date {
    int delta = -(int)[date timeIntervalSinceNow];

    if (delta < 60)
    {
        return delta == 1 ? @"one second ago" : [NSString stringWithFormat:@"%i seconds ago", delta];
    }
    if (delta < 120)
    {
        return @"a minute ago";
    }
    if (delta < 2700)
    {
        return [NSString stringWithFormat:@"%i minutes ago", delta/60];
    }
    if (delta < 5400)
    {
        return @"an hour ago";
    }
    if (delta < 24 * 3600)
    {
        return [NSString stringWithFormat:@"%i hours ago", delta/3600];
    }
    if (delta < 48 * 3600)
    {
        return @"yesterday";
    }
    if (delta < 30 * 24 * 3600)
    {
        return [NSString stringWithFormat:@"%i days ago", delta/(24*3600)];
    }
    if (delta < 12 * 30 * 24 * 3600)
    {
        int months = delta/(30*24*3600);
        return months <= 1 ? @"one month ago" : [NSString stringWithFormat:@"%i months ago", months];
    }
    else
    {
        int years = delta/(12*30*24*3600);
        return years <= 1 ? @"one year ago" : [NSString stringWithFormat:@"%i years ago", years];
    }
} 
```

* * *

## 回答 #14

> 赞同：20
> 
> 时间：2011-04-29T18:31:37.443

鉴于世界和她的丈夫似乎正在发布代码示例，这是我不久前根据其中几个答案写的。

我特别需要此代码是可本地化的。所以我有两个类—— `Grammar`，它指定了可本地化的术语，和`FuzzyDateExtensions`，它包含一堆扩展方法。我不需要处理未来的日期时间，所以没有尝试用这段代码来处理它们。

我在源代码中留下了一些 XMLdoc，但为了简洁起见，删除了大部分（它们很明显）。我也没有在这里包括每个班级成员：

```
public class Grammar
{
    /// <summary> Gets or sets the term for "just now". </summary>
    public string JustNow { get; set; }
    /// <summary> Gets or sets the term for "X minutes ago". </summary>
    /// <remarks>
    ///     This is a <see cref="String.Format"/> pattern, where <c>{0}</c>
    ///     is the number of minutes.
    /// </remarks>
    public string MinutesAgo { get; set; }
    public string OneHourAgo { get; set; }
    public string HoursAgo { get; set; }
    public string Yesterday { get; set; }
    public string DaysAgo { get; set; }
    public string LastMonth { get; set; }
    public string MonthsAgo { get; set; }
    public string LastYear { get; set; }
    public string YearsAgo { get; set; }
    /// <summary> Gets or sets the term for "ages ago". </summary>
    public string AgesAgo { get; set; }

    /// <summary>
    ///     Gets or sets the threshold beyond which the fuzzy date should be
    ///     considered "ages ago".
    /// </summary>
    public TimeSpan AgesAgoThreshold { get; set; }

    /// <summary>
    ///     Initialises a new <see cref="Grammar"/> instance with the
    ///     specified properties.
    /// </summary>
    private void Initialise(string justNow, string minutesAgo,
        string oneHourAgo, string hoursAgo, string yesterday, string daysAgo,
        string lastMonth, string monthsAgo, string lastYear, string yearsAgo,
        string agesAgo, TimeSpan agesAgoThreshold)
    { ... }
} 
```

该类`FuzzyDateString`包含：

```
public static class FuzzyDateExtensions
{
    public static string ToFuzzyDateString(this TimeSpan timespan)
    {
        return timespan.ToFuzzyDateString(new Grammar());
    }

    public static string ToFuzzyDateString(this TimeSpan timespan,
        Grammar grammar)
    {
        return GetFuzzyDateString(timespan, grammar);
    }

    public static string ToFuzzyDateString(this DateTime datetime)
    {
        return (DateTime.Now - datetime).ToFuzzyDateString();
    }

    public static string ToFuzzyDateString(this DateTime datetime,
       Grammar grammar)
    {
        return (DateTime.Now - datetime).ToFuzzyDateString(grammar);
    }

    private static string GetFuzzyDateString(TimeSpan timespan,
       Grammar grammar)
    {
        timespan = timespan.Duration();

        if (timespan >= grammar.AgesAgoThreshold)
        {
            return grammar.AgesAgo;
        }

        if (timespan < new TimeSpan(0, 2, 0))    // 2 minutes
        {
            return grammar.JustNow;
        }

        if (timespan < new TimeSpan(1, 0, 0))    // 1 hour
        {
            return String.Format(grammar.MinutesAgo, timespan.Minutes);
        }

        if (timespan < new TimeSpan(1, 55, 0))    // 1 hour 55 minutes
        {
            return grammar.OneHourAgo;
        }

        if (timespan < new TimeSpan(12, 0, 0)    // 12 hours
            && (DateTime.Now - timespan).IsToday())
        {
            return String.Format(grammar.HoursAgo, timespan.RoundedHours());
        }

        if ((DateTime.Now.AddDays(1) - timespan).IsToday())
        {
            return grammar.Yesterday;
        }

        if (timespan < new TimeSpan(32, 0, 0, 0)    // 32 days
            && (DateTime.Now - timespan).IsThisMonth())
        {
            return String.Format(grammar.DaysAgo, timespan.RoundedDays());
        }

        if ((DateTime.Now.AddMonths(1) - timespan).IsThisMonth())
        {
            return grammar.LastMonth;
        }

        if (timespan < new TimeSpan(365, 0, 0, 0, 0)    // 365 days
            && (DateTime.Now - timespan).IsThisYear())
        {
            return String.Format(grammar.MonthsAgo, timespan.RoundedMonths());
        }

        if ((DateTime.Now - timespan).AddYears(1).IsThisYear())
        {
            return grammar.LastYear;
        }

        return String.Format(grammar.YearsAgo, timespan.RoundedYears());
    }
} 
```

除了本地化之外，我想要实现的关键目标之一是“今天”仅表示“这个日历日”，因此`IsToday`, `IsThisMonth`,`IsThisYear`方法如下所示：

```
public static bool IsToday(this DateTime date)
{
    return date.DayOfYear == DateTime.Now.DayOfYear && date.IsThisYear();
} 
```

并且舍入方法是这样的（我已经包括在内`RoundedMonths`，因为这有点不同）：

```
public static int RoundedDays(this TimeSpan timespan)
{
    return (timespan.Hours > 12) ? timespan.Days + 1 : timespan.Days;
}

public static int RoundedMonths(this TimeSpan timespan)
{
    DateTime then = DateTime.Now - timespan;

    // Number of partial months elapsed since 1 Jan, AD 1 (DateTime.MinValue)
    int nowMonthYears = DateTime.Now.Year * 12 + DateTime.Now.Month;
    int thenMonthYears = then.Year * 12 + then.Month;                    

    return nowMonthYears - thenMonthYears;
} 
```

我希望人们觉得这有用和/或有趣:o)

* * *

## 回答 #15

> 赞同：19
> 
> 时间：2009-09-04T13:15:59.820

使用[流畅的日期时间](https://github.com/FluentDateTime)

```
var dateTime1 = 2.Hours().Ago();
var dateTime2 = 3.Days().Ago();
var dateTime3 = 1.Months().Ago();
var dateTime4 = 5.Hours().FromNow();
var dateTime5 = 2.Weeks().FromNow();
var dateTime6 = 40.Seconds().FromNow(); 
```

* * *

## 回答 #16

> 赞同：17
> 
> 时间：2008-08-20T17:26:49.357

在 PHP 中，我这样做：

```
<?php
function timesince($original) {
    // array of time period chunks
    $chunks = array(
        array(60 * 60 * 24 * 365 , 'year'),
        array(60 * 60 * 24 * 30 , 'month'),
        array(60 * 60 * 24 * 7, 'week'),
        array(60 * 60 * 24 , 'day'),
        array(60 * 60 , 'hour'),
        array(60 , 'minute'),
    );

    $today = time(); /* Current unix time  */
    $since = $today - $original;

    if($since > 604800) {
    $print = date("M jS", $original);

    if($since > 31536000) {
        $print .= ", " . date("Y", $original);
    }

    return $print;
}

// $j saves performing the count function each time around the loop
for ($i = 0, $j = count($chunks); $i < $j; $i++) {

    $seconds = $chunks[$i][0];
    $name = $chunks[$i][1];

    // finding the biggest chunk (if the chunk fits, break)
    if (($count = floor($since / $seconds)) != 0) {
        break;
    }
}

$print = ($count == 1) ? '1 '.$name : "$count {$name}s";

return $print . " ago";

} ?> 
```

* * *

## 回答 #17

> 赞同：15
> 
> 时间：2008-08-05T00:42:56.853

我想我会使用类和多态性来试一试。我有一个之前的迭代，它使用了子类，最终导致了太多的开销。我已切换到更灵活的委托/公共属性对象模型，该模型要好得多。我的代码稍微准确一点，我希望我能想出一个更好的方法来生成“几个月前”，看起来并不过分设计。

我想我仍然会坚持使用 Jeff 的 if-then 级联，因为它的代码更少而且更简单（确保它按预期工作肯定更容易）。

对于下面的代码*PrintRelativeTime.GetRelativeTimeMessage(TimeSpan ago)*返回相对时间消息（例如“昨天”）。

```
public class RelativeTimeRange : IComparable
{
    public TimeSpan UpperBound { get; set; }

    public delegate string RelativeTimeTextDelegate(TimeSpan timeDelta);

    public RelativeTimeTextDelegate MessageCreator { get; set; }

    public int CompareTo(object obj)
    {
        if (!(obj is RelativeTimeRange))
        {
            return 1;
        }
        // note that this sorts in reverse order to the way you'd expect, 
        // this saves having to reverse a list later
        return (obj as RelativeTimeRange).UpperBound.CompareTo(UpperBound);
    }
}

public class PrintRelativeTime
{
    private static List<RelativeTimeRange> timeRanges;

    static PrintRelativeTime()
    {
        timeRanges = new List<RelativeTimeRange>{
            new RelativeTimeRange
            {
                UpperBound = TimeSpan.FromSeconds(1),
                MessageCreator = (delta) => 
                { return "one second ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = TimeSpan.FromSeconds(60),
                MessageCreator = (delta) => 
                { return delta.Seconds + " seconds ago"; }

            }, 
            new RelativeTimeRange
            {
                UpperBound = TimeSpan.FromMinutes(2),
                MessageCreator = (delta) => 
                { return "one minute ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = TimeSpan.FromMinutes(60),
                MessageCreator = (delta) => 
                { return delta.Minutes + " minutes ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = TimeSpan.FromHours(2),
                MessageCreator = (delta) => 
                { return "one hour ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = TimeSpan.FromHours(24),
                MessageCreator = (delta) => 
                { return delta.Hours + " hours ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = TimeSpan.FromDays(2),
                MessageCreator = (delta) => 
                { return "yesterday"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = DateTime.Now.Subtract(DateTime.Now.AddMonths(-1)),
                MessageCreator = (delta) => 
                { return delta.Days + " days ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = DateTime.Now.Subtract(DateTime.Now.AddMonths(-2)),
                MessageCreator = (delta) => 
                { return "one month ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = DateTime.Now.Subtract(DateTime.Now.AddYears(-1)),
                MessageCreator = (delta) => 
                { return (int)Math.Floor(delta.TotalDays / 30) + " months ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = DateTime.Now.Subtract(DateTime.Now.AddYears(-2)),
                MessageCreator = (delta) => 
                { return "one year ago"; }
            }, 
            new RelativeTimeRange
            {
                UpperBound = TimeSpan.MaxValue,
                MessageCreator = (delta) => 
                { return (int)Math.Floor(delta.TotalDays / 365.24D) + " years ago"; }
            }
        };

        timeRanges.Sort();
    }

    public static string GetRelativeTimeMessage(TimeSpan ago)
    {
        RelativeTimeRange postRelativeDateRange = timeRanges[0];

        foreach (var timeRange in timeRanges)
        {
            if (ago.CompareTo(timeRange.UpperBound) <= 0)
            {
                postRelativeDateRange = timeRange;
            }
        }

        return postRelativeDateRange.MessageCreator(ago);
    }
} 
```

* * *

## 回答 #18

> 赞同：13
> 
> 时间：2008-08-15T22:42:33.870

当您知道查看者的时区时，在日尺度上使用日历日可能会更清楚。我不熟悉 .NET 库，所以很遗憾，我不知道你会如何在 C# 中做到这一点。

在消费者网站上，您也可以在一分钟内轻松应对。“不到一分钟前”或“刚刚”就足够了。

* * *

## 回答 #19

> 赞同：13
> 
> 时间：2009-07-17T02:47:42.510

```
using System;
using System.Collections.Generic;
using System.Linq;

public static class RelativeDateHelper
{
    private static Dictionary<double, Func<double, string>> sm_Dict = null;

    private static Dictionary<double, Func<double, string>> DictionarySetup()
    {
        var dict = new Dictionary<double, Func<double, string>>();
        dict.Add(0.75, (mins) => "less than a minute");
        dict.Add(1.5, (mins) => "about a minute");
        dict.Add(45, (mins) => string.Format("{0} minutes", Math.Round(mins)));
        dict.Add(90, (mins) => "about an hour");
        dict.Add(1440, (mins) => string.Format("about {0} hours", Math.Round(Math.Abs(mins / 60)))); // 60 * 24
        dict.Add(2880, (mins) => "a day"); // 60 * 48
        dict.Add(43200, (mins) => string.Format("{0} days", Math.Floor(Math.Abs(mins / 1440)))); // 60 * 24 * 30
        dict.Add(86400, (mins) => "about a month"); // 60 * 24 * 60
        dict.Add(525600, (mins) => string.Format("{0} months", Math.Floor(Math.Abs(mins / 43200)))); // 60 * 24 * 365 
        dict.Add(1051200, (mins) => "about a year"); // 60 * 24 * 365 * 2
        dict.Add(double.MaxValue, (mins) => string.Format("{0} years", Math.Floor(Math.Abs(mins / 525600))));

        return dict;
    }

    public static string ToRelativeDate(this DateTime input)
    {
        TimeSpan oSpan = DateTime.Now.Subtract(input);
        double TotalMinutes = oSpan.TotalMinutes;
        string Suffix = " ago";

        if (TotalMinutes < 0.0)
        {
            TotalMinutes = Math.Abs(TotalMinutes);
            Suffix = " from now";
        }

        if (null == sm_Dict)
            sm_Dict = DictionarySetup();

        return sm_Dict.First(n => TotalMinutes < n.Key).Value.Invoke(TotalMinutes) + Suffix;
    }
} 
```

[与此问题的另一个答案](https://stackoverflow.com/questions/11/how-do-i-calculate-relative-time/79601#79601)相同，但作为具有静态字典的扩展方法。

* * *

## 回答 #20

> 赞同：11
> 
> 时间：2008-08-15T14:20:04.133

@杰夫

> ```
> var ts = new TimeSpan(DateTime.UtcNow.Ticks - dt.Ticks); 
> ```

反正做减法`DateTime`返回 a 。`TimeSpan`

所以你可以做

```
(DateTime.UtcNow - dt).TotalSeconds 
```

我也很惊讶地看到手动乘以常数，然后在乘法中添加注释。这是一些误导性的优化吗？

* * *

## 回答 #21

> 赞同：11
> 
> 时间：2013-10-15T09:36:10.843

你可以试试这个。我认为它会正常工作。

```
long delta = new Date().getTime() - date.getTime();
const int SECOND = 1;
const int MINUTE = 60 * SECOND;
const int HOUR = 60 * MINUTE;
const int DAY = 24 * HOUR;
const int MONTH = 30 * DAY;

if (delta < 0L)
{
  return "not yet";
}
if (delta < 1L * MINUTE)
{
  return ts.Seconds == 1 ? "one second ago" : ts.Seconds + " seconds ago";
}
if (delta < 2L * MINUTE)
{
  return "a minute ago";
}
if (delta < 45L * MINUTE)
{
  return ts.Minutes + " minutes ago";
}
if (delta < 90L * MINUTE)
{
  return "an hour ago";
}
if (delta < 24L * HOUR)
{
  return ts.Hours + " hours ago";
}
if (delta < 48L * HOUR)
{
  return "yesterday";
}
if (delta < 30L * DAY)
{
  return ts.Days + " days ago";
}
if (delta < 12L * MONTH)
{
  int months = Convert.ToInt32(Math.Floor((double)ts.Days / 30));
  return months <= 1 ? "one month ago" : months + " months ago";
}
else
{
  int years = Convert.ToInt32(Math.Floor((double)ts.Days / 365));
  return years <= 1 ? "one year ago" : years + " years ago";
} 
```

* * *

## 回答 #22

> 赞同：11
> 
> 时间：2015-09-08T14:02:39.373

您可以使用[TimeAgo 扩展](http://dotnetthoughts.net/time-ago-function-for-c/)，如下所示：

```
public static string TimeAgo(this DateTime dateTime)
{
    string result = string.Empty;
    var timeSpan = DateTime.Now.Subtract(dateTime);

    if (timeSpan <= TimeSpan.FromSeconds(60))
    {
        result = string.Format("{0} seconds ago", timeSpan.Seconds);
    }
    else if (timeSpan <= TimeSpan.FromMinutes(60))
    {
        result = timeSpan.Minutes > 1 ? 
            String.Format("about {0} minutes ago", timeSpan.Minutes) :
            "about a minute ago";
    }
    else if (timeSpan <= TimeSpan.FromHours(24))
    {
        result = timeSpan.Hours > 1 ? 
            String.Format("about {0} hours ago", timeSpan.Hours) : 
            "about an hour ago";
    }
    else if (timeSpan <= TimeSpan.FromDays(30))
    {
        result = timeSpan.Days > 1 ? 
            String.Format("about {0} days ago", timeSpan.Days) : 
            "yesterday";
    }
    else if (timeSpan <= TimeSpan.FromDays(365))
    {
        result = timeSpan.Days > 30 ? 
            String.Format("about {0} months ago", timeSpan.Days / 30) : 
            "about a month ago";
    }
    else
    {
        result = timeSpan.Days > 365 ? 
            String.Format("about {0} years ago", timeSpan.Days / 365) : 
            "about a year ago";
    }

    return result;
} 
```

或者使用来自 Timeago 的带有 Razor 扩展的[jQuery 插件。](http://ardalis.com/wiring-up-timeago-and-aspnet-mvc)

* * *

## 回答 #23

> 赞同：10
> 
> 时间：2008-08-17T15:56:26.810

您可以通过在客户端执行此逻辑来减少服务器端负载。在一些 Digg 页面上查看源代码以供参考。他们让服务器发出一个由 Javascript 处理的纪元时间值。这样您就不需要管理最终用户的时区。新的服务器端代码将类似于：

```
public string GetRelativeTime(DateTime timeStamp)
{
    return string.Format("<script>printdate({0});</script>", timeStamp.ToFileTimeUtc());
} 
```

您甚至可以在那里添加一个 NOSCRIPT 块，然后执行一个 ToString()。

* * *

## 回答 #24

> 赞同：9
> 
> 时间：2008-09-23T01:09:30.193

这是stackoverflow使用的算法，但用perlish伪代码更简洁地重写了错误修复（没有“一小时前”）。该函数需要一个（正）秒数，并返回一个人类友好的字符串，如“3 小时前”或“昨天”。

```
agoify($delta)
  local($y, $mo, $d, $h, $m, $s);
  $s = floor($delta);
  if($s<=1)            return "a second ago";
  if($s<60)            return "$s seconds ago";
  $m = floor($s/60);
  if($m==1)            return "a minute ago";
  if($m<45)            return "$m minutes ago";
  $h = floor($m/60);
  if($h==1)            return "an hour ago";
  if($h<24)            return "$h hours ago";
  $d = floor($h/24);
  if($d<2)             return "yesterday";
  if($d<30)            return "$d days ago";
  $mo = floor($d/30);
  if($mo<=1)           return "a month ago";
  $y = floor($mo/12);
  if($y<1)             return "$mo months ago";
  if($y==1)            return "a year ago";
  return "$y years ago"; 
```

* * *

## 回答 #25

> 赞同：9
> 
> 时间：2009-11-14T18:44:50.030

Java for client-side gwt usage:

```
import java.util.Date;

public class RelativeDateFormat {

 private static final long ONE_MINUTE = 60000L;
 private static final long ONE_HOUR = 3600000L;
 private static final long ONE_DAY = 86400000L;
 private static final long ONE_WEEK = 604800000L;

 public static String format(Date date) {

  long delta = new Date().getTime() - date.getTime();
  if (delta < 1L * ONE_MINUTE) {
   return toSeconds(delta) == 1 ? "one second ago" : toSeconds(delta)
     + " seconds ago";
  }
  if (delta < 2L * ONE_MINUTE) {
   return "one minute ago";
  }
  if (delta < 45L * ONE_MINUTE) {
   return toMinutes(delta) + " minutes ago";
  }
  if (delta < 90L * ONE_MINUTE) {
   return "one hour ago";
  }
  if (delta < 24L * ONE_HOUR) {
   return toHours(delta) + " hours ago";
  }
  if (delta < 48L * ONE_HOUR) {
   return "yesterday";
  }
  if (delta < 30L * ONE_DAY) {
   return toDays(delta) + " days ago";
  }
  if (delta < 12L * 4L * ONE_WEEK) {
   long months = toMonths(delta);
   return months <= 1 ? "one month ago" : months + " months ago";
  } else {
   long years = toYears(delta);
   return years <= 1 ? "one year ago" : years + " years ago";
  }
 }

 private static long toSeconds(long date) {
  return date / 1000L;
 }

 private static long toMinutes(long date) {
  return toSeconds(date) / 60L;
 }

 private static long toHours(long date) {
  return toMinutes(date) / 60L;
 }

 private static long toDays(long date) {
  return toHours(date) / 24L;
 }

 private static long toMonths(long date) {
  return toDays(date) / 30L;
 }

 private static long toYears(long date) {
  return toMonths(date) / 365L;
 }

} 
```

* * *

## 回答 #26

> 赞同：9
> 
> 时间：2010-02-01T19:51:13.127

我从比尔盖茨的一个博客中得到了这个答案。我需要在我的浏览器历史记录中找到它，然后我会给你链接。

执行相同操作的 Javascript 代码（根据要求）：

```
function posted(t) {
    var now = new Date();
    var diff = parseInt((now.getTime() - Date.parse(t)) / 1000);
    if (diff < 60) { return 'less than a minute ago'; }
    else if (diff < 120) { return 'about a minute ago'; }
    else if (diff < (2700)) { return (parseInt(diff / 60)).toString() + ' minutes ago'; }
    else if (diff < (5400)) { return 'about an hour ago'; }
    else if (diff < (86400)) { return 'about ' + (parseInt(diff / 3600)).toString() + ' hours ago'; }
    else if (diff < (172800)) { return '1 day ago'; } 
    else {return (parseInt(diff / 86400)).toString() + ' days ago'; }
} 
```

基本上，您以秒为单位工作。

* * *

## 回答 #27

> 赞同：8
> 
> 时间：2013-03-16T06:36:07.017

我认为已经有很多与这篇文章相关的答案，但是可以使用它，它就像插件一样易于使用，并且对于程序员来说也易于阅读。发送您的特定日期，并以字符串形式获取其值：

```
public string RelativeDateTimeCount(DateTime inputDateTime)
{
    string outputDateTime = string.Empty;
    TimeSpan ts = DateTime.Now - inputDateTime;

    if (ts.Days > 7)
    { outputDateTime = inputDateTime.ToString("MMMM d, yyyy"); }

    else if (ts.Days > 0)
    {
        outputDateTime = ts.Days == 1 ? ("about 1 Day ago") : ("about " + ts.Days.ToString() + " Days ago");
    }
    else if (ts.Hours > 0)
    {
        outputDateTime = ts.Hours == 1 ? ("an hour ago") : (ts.Hours.ToString() + " hours ago");
    }
    else if (ts.Minutes > 0)
    {
        outputDateTime = ts.Minutes == 1 ? ("1 minute ago") : (ts.Minutes.ToString() + " minutes ago");
    }
    else outputDateTime = "few seconds ago";

    return outputDateTime;
} 
```

* * *

## 回答 #28

> 赞同：6
> 
> 时间：2012-05-27T17:30:29.780

```
var ts = new TimeSpan(DateTime.Now.Ticks - dt.Ticks); 
```

* * *

## 回答 #29

> 赞同：6
> 
> 时间：2015-09-08T14:02:16.003

如果你想有一个像 的输出`"2 days, 4 hours and 12 minutes ago"`，你需要一个时间跨度：

```
TimeSpan timeDiff = DateTime.Now-CreatedDate; 
```

然后您可以访问您喜欢的值：

```
timeDiff.Days
timeDiff.Hours 
```

ETC...

* * *

## 回答 #30

> 赞同：5
> 
> 时间：2012-09-13T12:15:49.307

I would provide some handy extensions methods for this and make the code more readable. First, couple of extension methods for `Int32`.

```
public static class TimeSpanExtensions {

    public static TimeSpan Days(this int value) {

        return new TimeSpan(value, 0, 0, 0);
    }

    public static TimeSpan Hours(this int value) {

        return new TimeSpan(0, value, 0, 0);
    }

    public static TimeSpan Minutes(this int value) {

        return new TimeSpan(0, 0, value, 0);
    }

    public static TimeSpan Seconds(this int value) {

        return new TimeSpan(0, 0, 0, value);
    }

    public static TimeSpan Milliseconds(this int value) {

        return new TimeSpan(0, 0, 0, 0, value);
    }

    public static DateTime Ago(this TimeSpan value) {

        return DateTime.Now - value;
    }
} 
```

Then, one for `DateTime`.

```
public static class DateTimeExtensions {

    public static DateTime Ago(this DateTime dateTime, TimeSpan delta) {

        return dateTime - delta;
    }
} 
```

Now, you can do something like below:

```
var date = DateTime.Now;
date.Ago(2.Days()); // 2 days ago
date.Ago(7.Hours()); // 7 hours ago
date.Ago(567.Milliseconds()); // 567 milliseconds ago 
```

* * *

## 回答 #31

> 赞同：5
> 
> 时间：2014-09-05T01:11:31.120

```
/** 
 * {@code date1} has to be earlier than {@code date2}.
 */
public static String relativize(Date date1, Date date2) {
    assert date2.getTime() >= date1.getTime();

    long duration = date2.getTime() - date1.getTime();
    long converted;

    if ((converted = TimeUnit.MILLISECONDS.toDays(duration)) > 0) {
        return String.format("%d %s ago", converted, converted == 1 ? "day" : "days");
    } else if ((converted = TimeUnit.MILLISECONDS.toHours(duration)) > 0) {
        return String.format("%d %s ago", converted, converted == 1 ? "hour" : "hours");
    } else if ((converted = TimeUnit.MILLISECONDS.toMinutes(duration)) > 0) {
        return String.format("%d %s ago", converted, converted == 1 ? "minute" : "minutes");
    } else if ((converted = TimeUnit.MILLISECONDS.toSeconds(duration)) > 0) {
        return String.format("%d %s ago", converted, converted == 1 ? "second" : "seconds");
    } else {
        return "just now";
    }
} 
```

* * *

## 回答 #32

> 赞同：4
> 
> 时间：2013-08-06T07:54:50.763

```
public string getRelativeDateTime(DateTime date)
{
    TimeSpan ts = DateTime.Now - date;
    if (ts.TotalMinutes < 1)//seconds ago
        return "just now";
    if (ts.TotalHours < 1)//min ago
        return (int)ts.TotalMinutes == 1 ? "1 Minute ago" : (int)ts.TotalMinutes + " Minutes ago";
    if (ts.TotalDays < 1)//hours ago
        return (int)ts.TotalHours == 1 ? "1 Hour ago" : (int)ts.TotalHours + " Hours ago";
    if (ts.TotalDays < 7)//days ago
        return (int)ts.TotalDays == 1 ? "1 Day ago" : (int)ts.TotalDays + " Days ago";
    if (ts.TotalDays < 30.4368)//weeks ago
        return (int)(ts.TotalDays / 7) == 1 ? "1 Week ago" : (int)(ts.TotalDays / 7) + " Weeks ago";
    if (ts.TotalDays < 365.242)//months ago
        return (int)(ts.TotalDays / 30.4368) == 1 ? "1 Month ago" : (int)(ts.TotalDays / 30.4368) + " Months ago";
    //years ago
    return (int)(ts.TotalDays / 365.242) == 1 ? "1 Year ago" : (int)(ts.TotalDays / 365.242) + " Years ago";
} 
```

一个月和一年中的天数的转换值取自 Google。

* * *

## 回答 #33

> 赞同：4
> 
> 时间：2019-01-03T08:03:07.237

**土耳其语**本地化版本的文森特答案。

```
 const int SECOND = 1;
    const int MINUTE = 60 * SECOND;
    const int HOUR = 60 * MINUTE;
    const int DAY = 24 * HOUR;
    const int MONTH = 30 * DAY;

    var ts = new TimeSpan(DateTime.UtcNow.Ticks - yourDate.Ticks);
    double delta = Math.Abs(ts.TotalSeconds);

    if (delta < 1 * MINUTE)
        return ts.Seconds + " saniye önce";

    if (delta < 45 * MINUTE)
        return ts.Minutes + " dakika önce";

    if (delta < 24 * HOUR)
        return ts.Hours + " saat önce";

    if (delta < 48 * HOUR)
        return "dün";

    if (delta < 30 * DAY)
        return ts.Days + " gün önce";

    if (delta < 12 * MONTH)
    {
        int months = Convert.ToInt32(Math.Floor((double)ts.Days / 30));
        return months + " ay önce";
    }
    else
    {
        int years = Convert.ToInt32(Math.Floor((double)ts.Days / 365));
        return years + " yıl önce";
    } 
```

* * *

## 回答 #34

> 赞同：3
> 
> 时间：2008-08-25T06:12:29.623

当然，摆脱“一小时前”问题的简单解决方法是增加“一小时前”有效的窗口。改变

```
if (delta < 5400) // 90 * 60
{
    return "an hour ago";
} 
```

进入

```
if (delta < 7200) // 120 * 60
{
    return "an hour ago";
} 
```

这意味着 110 分钟前发生的事情将读作“一小时前”——这可能并不完美，但我会说它比“1 小时前”的当前情况要好。

* * *

## 回答 #35

> 赞同：3
> 
> 时间：2020-10-13T06:28:46.130

在某种程度上，您可以`DateTime`通过以秒到年计算相对时间来执行您的功能，请尝试以下操作：

```
using System;

public class Program {
    public static string getRelativeTime(DateTime past) {
        DateTime now = DateTime.Today;
        string rt = "";
        int time;
        string statement = "";
        if (past.Second >= now.Second) {
            if (past.Second - now.Second == 1) {
                rt = "second ago";
            }
            rt = "seconds ago";
            time = past.Second - now.Second;
            statement = "" + time;
            return (statement + rt);
        }
        if (past.Minute >= now.Minute) {
            if (past.Second - now.Second == 1) {
                rt = "second ago";
            } else {
                rt = "minutes ago";
            }
            time = past.Minute - now.Minute;
            statement = "" + time;
            return (statement + rt);
        }
        // This process will go on until years
    }
    public static void Main() {
        DateTime before = new DateTime(1995, 8, 24);
        string date = getRelativeTime(before);
        Console.WriteLine("Windows 95 was {0}.", date);
    }
} 
```

不完全有效，但是如果您对其进行一些修改和调试，它可能会完成这项工作。

* * *

## 回答 #36

> 赞同：2
> 
> 时间：2019-05-26T02:31:53.863

```
// Calculate total days in current year
int daysInYear;

for (var i = 1; i <= 12; i++)
    daysInYear += DateTime.DaysInMonth(DateTime.Now.Year, i);

// Past date
DateTime dateToCompare = DateTime.Now.Subtract(TimeSpan.FromMinutes(582));

// Calculate difference between current date and past date
double diff = (DateTime.Now - dateToCompare).TotalMilliseconds;

TimeSpan ts = TimeSpan.FromMilliseconds(diff);

var years = ts.TotalDays / daysInYear; // Years
var months = ts.TotalDays / (daysInYear / (double)12); // Months
var weeks = ts.TotalDays / 7; // Weeks
var days = ts.TotalDays; // Days
var hours = ts.TotalHours; // Hours
var minutes = ts.TotalMinutes; // Minutes
var seconds = ts.TotalSeconds; // Seconds

if (years >= 1)
    Console.WriteLine(Math.Round(years, 0) + " year(s) ago");
else if (months >= 1)
    Console.WriteLine(Math.Round(months, 0) + " month(s) ago");
else if (weeks >= 1)
    Console.WriteLine(Math.Round(weeks, 0) + " week(s) ago");
else if (days >= 1)
    Console.WriteLine(Math.Round(days, 0) + " days(s) ago");
else if (hours >= 1)
    Console.WriteLine(Math.Round(hours, 0) + " hour(s) ago");
else if (minutes >= 1)
    Console.WriteLine(Math.Round(minutes, 0) + " minute(s) ago");
else if (seconds >= 1)
    Console.WriteLine(Math.Round(seconds, 0) + " second(s) ago");

Console.ReadLine(); 
```

* * *

## 回答 #37

> 赞同：2
> 
> 时间：2020-12-10T16:00:48.177

使用解构和 Linq 获得“n [最大时间单位] 前”的“单线”：

```
TimeSpan timeSpan = DateTime.Now - new DateTime(1234, 5, 6, 7, 8, 9);

(string unit, int value) = new Dictionary<string, int>
{
    {"year(s)", (int)(timeSpan.TotalDays / 365.25)}, //https://en.wikipedia.org/wiki/Year#Intercalation
    {"month(s)", (int)(timeSpan.TotalDays / 29.53)}, //https://en.wikipedia.org/wiki/Month
    {"day(s)", (int)timeSpan.TotalDays},
    {"hour(s)", (int)timeSpan.TotalHours},
    {"minute(s)", (int)timeSpan.TotalMinutes},
    {"second(s)", (int)timeSpan.TotalSeconds},
    {"millisecond(s)", (int)timeSpan.TotalMilliseconds}
}.First(kvp => kvp.Value > 0);

Console.WriteLine($"{value} {unit} ago"); 
```

你得到`786 year(s) ago`

用当前的年份和月份，比如

```
TimeSpan timeSpan = DateTime.Now - new DateTime(2020, 12, 6, 7, 8, 9); 
```

你得到`4 day(s) ago`

随着实际日期，如

```
TimeSpan timeSpan = DateTime.Now - DateTime.Now.Date; 
```

你得到`9 hour(s) ago`

* * *

## 回答 #38

> 赞同：2
> 
> 时间：2017-09-04T01:27:10.793

这是我的功能，就像一个魅力:)

```
public static string RelativeDate(DateTime theDate)
{
   var span = DateTime.Now - theDate;
   if (span.Days > 365)
   {
      var years = (span.Days / 365);
      if (span.Days % 365 != 0)
         years += 1;
      return $"about {years} {(years == 1 ? "year" : "years")} ago";
   }
   if (span.Days > 30)
   {
      var months = (span.Days / 30);
      if (span.Days % 31 != 0)
         months += 1;
      return $"about {months} {(months == 1 ? "month" : "months")} ago";
   }
   if (span.Days > 0)
      return $"about {span.Days} {(span.Days == 1 ? "day" : "days")} ago";
   if (span.Hours > 0)
      return $"about {span.Hours} {(span.Hours == 1 ? "hour" : "hours")} ago";
   if (span.Minutes > 0)
      return $"about {span.Minutes} {(span.Minutes == 1 ? "minute" : "minutes")} ago";
   if (span.Seconds > 5)
      return $"about {span.Seconds} seconds ago";

   return span.Seconds <= 5 ? "about 5 seconds ago" : string.Empty;
} 
```

* * *

## 回答 #39

> 赞同：-1
> 
> 时间：2018-03-15T13:03:01.000

My way is much more simpler. You can tweak with the return strings as you want

```
 public static string TimeLeft(DateTime utcDate)
    {
        TimeSpan timeLeft = DateTime.UtcNow - utcDate;
        string timeLeftString = "";
        if (timeLeft.Days > 0)
        {
            timeLeftString += timeLeft.Days == 1 ? timeLeft.Days + " day" : timeLeft.Days + " days";
        }
        else if (timeLeft.Hours > 0)
        {
            timeLeftString += timeLeft.Hours == 1 ? timeLeft.Hours + " hour" : timeLeft.Hours + " hours";
        }
        else
        {
            timeLeftString += timeLeft.Minutes == 1 ? timeLeft.Minutes+" minute" : timeLeft.Minutes + " minutes";
        }
        return timeLeftString;
    } 
```

* * *

## 回答 #40

> 赞同：-1
> 
> 时间：2021-09-01T21:49:09.617

简单且 100% 有效的解决方案。

也处理以前和未来的时间..以防万一

```
 public string GetTimeSince(DateTime postDate)
    {
        string message = "";
        DateTime currentDate = DateTime.Now;
        TimeSpan timegap = currentDate - postDate;

        if (timegap.Days > 365)
        {
            message = string.Format(L("Ago") + " {0} " + L("Years"), (((timegap.Days) / 30) / 12));                
        }
        else if (timegap.Days > 30)
        {
            message = string.Format(L("Ago") + " {0} " + L("Months"), timegap.Days/30);                
        }
        else if (timegap.Days > 0)
        {
            message = string.Format(L("Ago") + " {0} " + L("Days"), timegap.Days);
        }           
        else if (timegap.Hours > 0)
        {
            message = string.Format(L("Ago") + " {0} " + L("Hours"), timegap.Hours);
        }           
        else if (timegap.Minutes > 0)
        {
            message = string.Format(L("Ago") + " {0} " + L("Minutes"), timegap.Minutes);
        }
        else if (timegap.Seconds > 0)
        {
            message = string.Format(L("Ago") + " {0} " + L("Seconds"), timegap.Seconds);
        }

        // let's handle future times..just in case       
        else if (timegap.Days < -365)
        {
            message = string.Format(L("In") + " {0} " + L("Years"), (((Math.Abs(timegap.Days)) / 30) / 12));                
        }
        else if (timegap.Days < -30)
        {
            message = string.Format(L("In") + " {0} " + L("Months"), ((Math.Abs(timegap.Days)) / 30));                
        }
        else if (timegap.Days < 0)
        {
            message = string.Format(L("In") + " {0} " + L("Days"), Math.Abs(timegap.Days));                
        }           

        else if (timegap.Hours < 0)
        {
            message = string.Format(L("In") + " {0} " + L("Hours"), Math.Abs(timegap.Hours));                
        }
        else if (timegap.Minutes < 0)
        {
            message = string.Format(L("In") + " {0} " + L("Minutes"), Math.Abs(timegap.Minutes));                
        }
        else if (timegap.Seconds < 0)
        {
            message = string.Format(L("In") + " {0} " + L("Seconds"), Math.Abs(timegap.Seconds));                
        }

        else
        {
            message = "a bit";
        }

        return message;
    } 
```

# html - Determine a user's timezone

> ID：13
> 
> 赞同：671
> 
> 时间：2008-08-01T00:42:38.903
> 
> 标签：html, browser, timezone, user-agent, timezone-offset

Is there a standard way for a web server to be able to determine a user's timezone within a web page?

Perhaps from an HTTP header or part of the `user-agent` string?

* * *

## 回答 #1

> 赞同：341
> 
> 时间：2009-11-27T17:52:21.897

```
-new Date().getTimezoneOffset()/60; 
```

该方法`getTimezoneOffset()`将从 GMT 中减去您的时间并返回分钟数。因此，如果您居住在 GMT-8，它将返回 480。

要将其计算为小时，除以 60。另外，请注意符号与您需要的相反 - 它计算的是 GMT 与您的时区的偏移量，而不是您的时区与 GMT 的偏移量。要解决此问题，只需乘以 -1。

另请注意，[w3school](http://www.w3schools.com/jsref/jsref_gettimezoneoffset.asp)说：

> 由于使用夏令时的做法，返回的值不是常数。

* * *

## 回答 #2

> 赞同：209
> 
> 时间：2008-08-03T19:30:55.720

我见过的最流行的（==标准？）确定时区的方法是简单地*询问用户自己。*如果您的网站需要订阅，这可以保存在用户的个人资料数据中。对于匿名用户，日期可以显示为 UTC 或 GMT 等。

我不是想成为一个聪明的家伙。只是有时某些问题在任何编程上下文之外都有更好的解决方案。

* * *

## 回答 #3

> 赞同：178
> 
> 时间：2008-08-01T12:19:17.417

到目前为止，还没有 HTTP 标头会报告客户端时区，尽管已建议将其包含在 HTTP 规范中。

如果是我，我可能会尝试使用客户端 JavaScript 获取时区，然后使用 Ajax 或其他方式将其提交到服务器。

* * *

## 回答 #4

> 赞同：87
> 
> 时间：2014-03-25T03:47:01.893

首先，了解 JavaScript 中的时区检测是不完善的。您可以使用对象实例获取特定日期和时间的本地*时区偏移量*，但这与完整的[IANA 时区](https://iana.org/time-zones)（如.`getTimezoneOffset``Date``America/Los_Angeles`

不过，有一些选项可以工作：

*   [大多数现代浏览器在其ECMAScript 国际化 API](https://www.ecma-international.org/ecma-402/)的实现中支持 IANA 时区，因此您可以这样做：

```
const tzid = Intl.DateTimeFormat().resolvedOptions().timeZone;
console.log(tzid);
```

结果是一个字符串，其中包含运行代码的计算机的 IANA 时区设置。

支持的环境列[在 Intl 兼容性表中](https://kangax.github.io/compat-table/esintl/#test-DateTimeFormat_resolvedOptions().timeZone_defaults_to_the_host_environment)。展开该`DateTimeFormat`部分，并查看名为`resolvedOptions().timeZone defaults to the host environment`.

*   一些库，比如[Luxon](https://moment.github.io/luxon)使用这个 API 通过函数来​​确定时区，比如`luxon.Settings.defaultZoneName`.

*   如果您需要支持更广泛的环境集，例如较旧的 Web 浏览器，您可以使用库对时区进行有根据的*猜测*。他们首先尝试`Intl`API（如果可用），当它不可用时，他们会在几个不同的时间点询问对象的`getTimezoneOffset`功能`Date`，使用结果从内部数据集中选择合适的时区。

    jsTimezoneDetect和[moment](https://github.com/pellepim/jstimezonedetect) [-timezone](https://momentjs.com/timezone)都具有此功能。

    ```
     // using jsTimeZoneDetect
      var tzid = jstz.determine().name();

      // using moment-timezone
      var tzid = moment.tz.guess(); 
    ```

    在这两种情况下，结果只能被认为是一种猜测。在许多情况下，猜测可能是正确的，但并非全部。

    此外，这些库必须定期更新以抵消许多较旧的 JavaScript 实现只知道其本地时区的*当前*夏令时规则的事实。 [更多细节在这里。](https://codeofmatt.com/2013/06/07/javascript-date-type-is-horribly-broken/)

最终，更好的方法是实际询问您的用户他们的时区。提供他们可以更改的设置。您可以使用上述选项之一来选择*默认*设置，但请不要在您的应用程序中偏离该设置。

还有完全不同的方法，*根本不*依赖用户计算机的时区设置。[相反，如果您可以收集纬度和经度坐标，则可以使用其中一种方法](https://stackoverflow.com/a/16086964/634824)将其解析为时区。这在移动设备上运行良好。

* * *

## 回答 #5

> 赞同：56
> 
> 时间：2008-08-01T15:11:59.987

JavaScript 是获取客户端本地时间的最简单方法。我建议使用[XMLHttpRequest](http://en.wikipedia.org/wiki/XMLHttpRequest)发回本地时间，如果失败，则回退到根据其 IP 地址检测到的时区。

至于地理定位，我在几个项目中使用[了 MaxMind GeoIP](http://www.maxmind.com/app/ip-location)，它运行良好，但我不确定它们是否提供时区数据。这是一项您付费的服务，他们会为您的数据库提供每月更新。它们提供多种网络语言的包装器。

* * *

## 回答 #6

> 赞同：52
> 
> 时间：2012-08-06T21:22:05.333

这是一个强大的 JavaScript 解决方案，用于确定浏览器所在的时区。

```
>>> var timezone = jstz.determine();
>>> timezone.name(); 
"Europe/London" 
```

[https://github.com/pellepim/jstimezonedetect](https://github.com/pellepim/jstimezonedetect)

* * *

## 回答 #7

> 赞同：44
> 
> 时间：2011-03-30T20:48:14.190

这是一个更完整的方法。

1.  获取用户的时区偏移量
2.  在夏令时边界上测试几天以确定它们是否在使用夏令时的区域中。

摘录如下：

```
function TimezoneDetect(){
    var dtDate = new Date('1/1/' + (new Date()).getUTCFullYear());
    var intOffset = 10000; //set initial offset high so it is adjusted on the first attempt
    var intMonth;
    var intHoursUtc;
    var intHours;
    var intDaysMultiplyBy;

    // Go through each month to find the lowest offset to account for DST
    for (intMonth=0;intMonth < 12;intMonth++){
        //go to the next month
        dtDate.setUTCMonth(dtDate.getUTCMonth() + 1);

        // To ignore daylight saving time look for the lowest offset.
        // Since, during DST, the clock moves forward, it'll be a bigger number.
        if (intOffset > (dtDate.getTimezoneOffset() * (-1))){
            intOffset = (dtDate.getTimezoneOffset() * (-1));
        }
    }

    return intOffset;
} 
```

[从 JS 获取 TZ 和 DST](https://web.archive.org/web/20140703082827/http://michaelapproved.com/articles/timezone-detect-and-ignore-daylight-saving-time-dst)（通过 Way Back Machine）

* * *

## 回答 #8

> 赞同：34
> 
> 时间：2011-04-09T19:16:47.160

使用 Unkwntech 的方法，我使用 jQuery 和 PHP 编写了一个函数。这是经过测试并且确实有效！

在您希望将时区作为变量的 PHP 页面上，将这段代码放在页面顶部附近的某处：

```
<?php
    session_start();
    $timezone = $_SESSION['time'];
?> 
```

这将读取我们现在要创建的会话变量“time”。

在同一页面上，在 <head> 中，您首先需要包含 jQuery：

```
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script> 
```

同样在 jQuery 下方的 <head> 中，粘贴以下内容：

```
<script type="text/javascript">
    $(document).ready(function() {
        if("<?php echo $timezone; ?>".length==0){
            var visitortime = new Date();
            var visitortimezone = "GMT " + -visitortime.getTimezoneOffset()/60;
            $.ajax({
                type: "GET",
                url: "http://example.org/timezone.php",
                data: 'time='+ visitortimezone,
                success: function(){
                    location.reload();
                }
            });
        }
    });
</script> 
```

您可能注意到也可能没有注意到，但您需要将 URL 更改为您的实际域。

最后一件事。您可能想知道 timezone.php 到底是什么。嗯，很简单：（创建一个名为**timezone.php**的新文件并用上面的 URL 指向它）

```
<?php
    session_start();
    $_SESSION['time'] = $_GET['time'];
?> 
```

如果这工作正常，它将首先加载页面，执行 JavaScript，然后重新加载页面。然后，您将能够读取 $timezone 变量并随意使用它！它返回当前的 UTC/GMT 时区偏移 (GMT -7) 或您所在的任何时区。

* * *

## 回答 #9

> 赞同：28
> 
> 时间：2012-09-13T02:05:11.490

[使用jQuery](http://jquery.com/)在 AJAX 请求上将时区偏移量作为 HTTP 标头提交

```
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        xhr.setRequestHeader("X-TZ-Offset", -new Date().getTimezoneOffset()/60);
    }
}); 
```

您还可以通过使用 http://momentjs.com/timezone/docs/#/using-timezones/guessing-user-timezone/ 执行类似的操作来获取实际时`moment.tz.guess();`区[名称](http://momentjs.com/timezone/docs/#/using-timezones/guessing-user-timezone/)

* * *

## 回答 #10

> 赞同：25
> 
> 时间：2012-08-30T05:08:17.503

我仍然没有在这里看到获取时区的详细答案。您不需要按 IP 地址进行地理编码或使用 PHP (lol) 或从偏移量中错误地猜测。

首先，时区不仅仅是与 GMT 的偏移量。这是一块土地，其时间规则由当地标准制定。一些国家有夏令时，并且会在不同的时间开启 DST。获取实际区域通常很重要，而不仅仅是当前偏移量。

如果您打算存储此时区，例如在用户首选项中，您需要该时区而不仅仅是偏移量。对于实时转换，这并不重要。

现在，要使用 javascript 获取时区，您可以使用以下命令：

```
>> new Date().toTimeString();
"15:46:04 GMT+1200 (New Zealand Standard Time)"
//Use some regular expression to extract the time. 
```

然而，我发现简单地使用这个返回奥尔森格式时区的强大插件更容易：

[https://github.com/scottwater/jquery.detect_timezone](https://github.com/scottwater/jquery.detect_timezone)

* * *

## 回答 #11

> 赞同：24
> 
> 时间：2010-09-16T05:59:40.993

使用 PHP`date`函数，您将获得站点所在服务器的日期时间。获得用户时间的唯一方法是使用 JavaScript。

但是我建议您，如果您的网站需要注册，那么最好的方法是询问用户，同时将注册作为必填字段。您可以在注册页面中列出各种时区并将其保存在数据库中。在此之后，如果用户登录到站点，那么您可以根据用户选择的时区设置该会话的默认时区。

您可以使用 PHP 函数设置任何特定的时区`date_default_timezone_set`。这将为用户设置指定的时区。

基本上用户的时区是到客户端的，所以我们必须使用 JavaScript。

下面是使用 PHP 和 JavaScript 获取用户时区的脚本。

```
<?php
    #http://www.php.net/manual/en/timezones.php List of Time Zones
    function showclienttime()
    {
        if(!isset($_COOKIE['GMT_bias']))
        {
?>

            <script type="text/javascript">
                var Cookies = {};
                Cookies.create = function (name, value, days) {
                    if (days) {
                        var date = new Date();
                        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                        var expires = "; expires=" + date.toGMTString();
                    }
                    else {
                        var expires = "";
                    }
                    document.cookie = name + "=" + value + expires + "; path=/";
                    this[name] = value;
                }

                var now = new Date();
                Cookies.create("GMT_bias",now.getTimezoneOffset(),1);
                window.location = "<?php echo $_SERVER['PHP_SELF'];?>";
            </script>

            <?php

        }
        else {
          $fct_clientbias = $_COOKIE['GMT_bias'];
        }

        $fct_servertimedata = gettimeofday();
        $fct_servertime = $fct_servertimedata['sec'];
        $fct_serverbias = $fct_servertimedata['minuteswest'];
        $fct_totalbias = $fct_serverbias – $fct_clientbias;
        $fct_totalbias = $fct_totalbias * 60;
        $fct_clienttimestamp = $fct_servertime + $fct_totalbias;
        $fct_time = time();
        $fct_year = strftime("%Y", $fct_clienttimestamp);
        $fct_month = strftime("%B", $fct_clienttimestamp);
        $fct_day = strftime("%d", $fct_clienttimestamp);
        $fct_hour = strftime("%I", $fct_clienttimestamp);
        $fct_minute = strftime("%M", $fct_clienttimestamp);
        $fct_second = strftime("%S", $fct_clienttimestamp);
        $fct_am_pm = strftime("%p", $fct_clienttimestamp);
        echo $fct_day.", ".$fct_month." ".$fct_year." ( ".$fct_hour.":".$fct_minute.":".$fct_second." ".$fct_am_pm." )";
    }

    showclienttime();
?> 
```

但根据我的观点，最好询问用户在您的项目中是否必须注册。

* * *

## 回答 #12

> 赞同：23
> 
> 时间：2013-01-02T18:05:55.090

不要使用 IP 地址来明确确定位置（以及因此时区）——这是因为对于 NAT、代理（越来越流行）和 VPN，IP 地址不一定真实地反映用户的实际位置，而是实现这些协议的服务器驻留。

鉴于号码可携带性的普及，类似于美国区号不再用于定位电话用户。

上面显示的 IP 地址和其他技术对于建议用户可以调整/更正**的默认值很有用。**

* * *

## 回答 #13

> 赞同：23
> 
> 时间：2011-08-27T23:00:58.053

JavaScript：

```
function maketimus(timestampz)
{
    var linktime = new Date(timestampz * 1000);
    var linkday = linktime.getDate();
    var freakingmonths = new Array();

    freakingmonths[0]  = "jan";
    freakingmonths[1]  = "feb";
    freakingmonths[2]  = "mar";
    freakingmonths[3]  = "apr";
    freakingmonths[4]  = "may";
    freakingmonths[5]  = "jun";
    freakingmonths[6]  = "jul";
    freakingmonths[7]  = "aug";
    freakingmonths[8]  = "sep";
    freakingmonths[9]  = "oct";
    freakingmonths[10] = "nov";
    freakingmonths[11] = "dec";

    var linkmonthnum = linktime.getMonth();
    var linkmonth = freakingmonths[linkmonthnum];
    var linkyear = linktime.getFullYear();
    var linkhour = linktime.getHours();
    var linkminute = linktime.getMinutes();

    if (linkminute < 10)
    {
        linkminute = "0" + linkminute;
    }

    var fomratedtime = linkday + linkmonth + linkyear + " " +
                       linkhour + ":" + linkminute + "h";
    return fomratedtime;
} 
```

只需向此函数提供 Unix 时间戳格式的时间；JavaScript 已经知道用户的时区。

像这样：

PHP：

```
echo '<script type="text/javascript">
var eltimio = maketimus('.$unix_timestamp_ofshiz.');
document.write(eltimio);
</script><noscript>pls enable javascript</noscript>'; 
```

这将始终根据该人在他/她的计算机时钟上设置的时区正确显示时间。无需向任何人询问任何内容并将其保存到地方，感谢上帝！

* * *

## 回答 #14

> 赞同：22
> 
> 时间：2012-05-27T17:25:29.937

很简单，只需像这样使用 JavaScript`getTimezoneOffset`函数：

```
-new Date().getTimezoneOffset()/60; 
```

* * *

## 回答 #15

> 赞同：20
> 
> 时间：2008-08-03T20:40:33.707

所有的魔法似乎都在

```
visitortime.getTimezoneOffset() 
```

很酷，我不知道。它可以在 Internet Explorer 等中使用吗？从那里你应该能够使用 JavaScript 到 Ajax，设置任何 cookie。我可能会自己走饼干路线。

您需要允许用户更改它。不久前，我们尝试使用地理位置（通过`maxmind`）来执行此操作，但它是错误的，以至于不值得这样做。所以我们只是让用户在他们的个人资料中设置它，并向尚未设置的用户显示通知。

* * *

## 回答 #16

> 赞同：16
> 
> 时间：2008-08-30T09:29:39.377

如果您碰巧使用[OpenID](http://openid.net/)进行身份验证，[Simple Registration Extension](http://openid.net/specs/openid-simple-registration-extension-1_0.html)将解决经过身份验证的用户的问题（您需要从 tz 转换为 numeric）。

另一种选择是从用户代理的国家偏好中推断时区。这是一种有点粗略的方法（不适用于 en-US），但可以很好地近似。

* * *

## 回答 #17

> 赞同：16
> 
> 时间：2010-05-25T00:11:51.503

这是一篇文章（带有源代码），它解释了如何在 ASP.NET（VB.NET、C#）应用程序中确定和使用本地化时间：

[**是时候了**](http://www.windowsitpro.com/article/aspnet2/it-s-about-time.aspx)

简而言之，所描述的方法依赖于 JavaScript`getTimezoneOffset`函数，该函数返回保存在会话 cookie 中并由代码隐藏用于调整 GMT 和本地时间之间的时间值的值。好处是用户不需要指定时区（代码会自动指定）。涉及的内容更多（这就是我链接到该文章的原因），但提供的代码使其非常易于使用。我怀疑您可以将逻辑转换为 PHP 和其他语言（只要您了解 ASP.NET）。

* * *

## 回答 #18

> 赞同：14
> 
> 时间：2014-09-15T01:19:39.427

使用 JavaScript 和 PHP 很简单：

即使用户可能会弄​​乱他/她的内部时钟和/或时区，但到目前为止我找到的获得偏移量的最佳方法仍然是`new Date().getTimezoneOffset();`. 它是非侵入性的，不会让人头疼，并且无需依赖第三方。

假设我有一个表，`users`其中包含一个字段`date_created int(13)`，用于存储 Unix 时间戳；

假设一个客户端`creates a new account`，数据由 接收`post`，我需要客户端`insert/update`的`date_created column`Unix 时间戳，而不是服务器的。

由于在插入/更新时需要 timezoneOffset，它在客户端提交表单时作为额外的 $_POST 元素传递，因此无需将其存储在会话和/或 cookie 中，也没有额外的服务器命中。

```
var off = (-new Date().getTimezoneOffset()/60).toString();//note the '-' in front which makes it return positive for negative offsets and negative for positive offsets
var tzo = off == '0' ? 'GMT' : off.indexOf('-') > -1 ? 'GMT'+off : 'GMT+'+off; 
```

假设服务器接收`tzo`为`$_POST['tzo']`;

```
$ts = new DateTime('now', new DateTimeZone($_POST['tzo']);
$user_time = $ts->format("F j, Y, g:i a");//will return the users current time in readable format, regardless of whether date_default_timezone() is set or not.
$user_timestamp = strtotime($user_time); 
```

插入/更新`date_created=$user_timestamp`。

检索 date_created 时，您可以像这样转换时间戳：

```
$date_created = // Get from the database
$created = date("F j, Y, g:i a",$date_created); // Return it to the user or whatever 
```

现在，这个例子可能适合一个人的需要，当涉及到插入`first`时间戳时......当涉及到额外的时间戳或表时，您可能需要考虑将 tzo 值插入到 users 表中以供将来参考，或者设置它作为会话或cookie。

PS 但是，如果用户旅行并切换时区怎么办。在 GMT+4 登录，快速到达 GMT-1 并再次登录。最后一次登录将在将来。

我想……我们想太多了。

* * *

## 回答 #19

> 赞同：14
> 
> 时间：2016-09-13T06:19:58.310

您可以使用[时刻时区](http://momentjs.com/timezone/)在客户端上执行此操作并将值发送到服务器；示例用法：

```
> moment.tz.guess()
"America/Asuncion" 
```

* * *

## 回答 #20

> 赞同：12
> 
> 时间：2017-01-10T11:56:06.450

在 PHP 中获取有效的 TZ 数据库时区名称是一个两步过程：

1.  使用 JavaScript，通过`getTimezoneOffset`. 如果本地时区落后于 UTC，则此偏移量将为正数，如果早于 UTC，则此偏移量将为负数。因此，您必须在偏移量中添加一个相反的符号。

    ```
    var timezone_offset_minutes = new Date().getTimezoneOffset();
    timezone_offset_minutes = timezone_offset_minutes == 0 ? 0 : -timezone_offset_minutes; 
    ```

    将此偏移量传递给 PHP。

2.  *在 PHP 中，使用timezone_name_from_abbr*函数将此偏移量转换为有效的时区名称。

    ```
    // Just an example.
    $timezone_offset_minutes = -360;  // $_GET['timezone_offset_minutes']

    // Convert minutes to seconds
    $timezone_name = timezone_name_from_abbr("", $timezone_offset_minutes*60, false);

    // America/Chicago
    echo $timezone_name;</code></pre> 
    ```

我写了一篇关于它的博客文章：*[如何在 PHP 中检测用户时区](http://usefulangle.com/post/31/detect-user-browser-timezone-name-in-php)*。它还包含一个演示。

* * *

## 回答 #21

> 赞同：11
> 
> 时间：2012-07-30T08:08:44.750

试试这个 PHP 代码：

```
<?php
    $ip = $_SERVER['REMOTE_ADDR'];
    $json = file_get_contents("http://api.easyjquery.com/ips/?ip=" . $ip . "&full=true");
    $json = json_decode($json,true);
    $timezone = $json['LocalTimeZone'];
?> 
```

* * *

## 回答 #22

> 赞同：11
> 
> 时间：2011-12-01T11:08:43.657

一个简单的方法是使用：

```
new Date().getTimezoneOffset(); 
```

* * *

## 回答 #23

> 赞同：10
> 
> 时间：2012-01-28T08:21:56.387

这是我的做法。这会将 PHP 默认时区设置为用户的本地时区。只需将以下内容粘贴到所有页面的顶部：

```
<?php
session_start();

if(!isset($_SESSION['timezone']))
{
    if(!isset($_REQUEST['offset']))
    {
    ?>
        <script>
        var d = new Date()
        var offset= -d.getTimezoneOffset()/60;
        location.href = "<?php echo $_SERVER['PHP_SELF']; ?>?offset="+offset;
        </script>
        <?php   
    }
    else
    {
        $zonelist = array('Kwajalein' => -12.00, 'Pacific/Midway' => -11.00, 'Pacific/Honolulu' => -10.00, 'America/Anchorage' => -9.00, 'America/Los_Angeles' => -8.00, 'America/Denver' => -7.00, 'America/Tegucigalpa' => -6.00, 'America/New_York' => -5.00, 'America/Caracas' => -4.30, 'America/Halifax' => -4.00, 'America/St_Johns' => -3.30, 'America/Argentina/Buenos_Aires' => -3.00, 'America/Sao_Paulo' => -3.00, 'Atlantic/South_Georgia' => -2.00, 'Atlantic/Azores' => -1.00, 'Europe/Dublin' => 0, 'Europe/Belgrade' => 1.00, 'Europe/Minsk' => 2.00, 'Asia/Kuwait' => 3.00, 'Asia/Tehran' => 3.30, 'Asia/Muscat' => 4.00, 'Asia/Yekaterinburg' => 5.00, 'Asia/Kolkata' => 5.30, 'Asia/Katmandu' => 5.45, 'Asia/Dhaka' => 6.00, 'Asia/Rangoon' => 6.30, 'Asia/Krasnoyarsk' => 7.00, 'Asia/Brunei' => 8.00, 'Asia/Seoul' => 9.00, 'Australia/Darwin' => 9.30, 'Australia/Canberra' => 10.00, 'Asia/Magadan' => 11.00, 'Pacific/Fiji' => 12.00, 'Pacific/Tongatapu' => 13.00);
        $index = array_keys($zonelist, $_REQUEST['offset']);
        $_SESSION['timezone'] = $index[0];
    }
}

date_default_timezone_set($_SESSION['timezone']);

//rest of your code goes here
?> 
```

* * *

## 回答 #24

> 赞同：9
> 
> 时间：2014-09-08T23:25:56.240

一种可能的选择是使用`Date`标头字段，该字段在[RFC 7231](https://www.rfc-editor.org/rfc/rfc7231#page-65)中定义并且应该包含时区。当然，不能保证该值确实是客户端的时区，但它可以是一个方便的起点。

* * *

## 回答 #25

> 赞同：2
> 
> 时间：2021-12-27T11:50:27.410

有几种方法可以确定浏览器中的时区。如果您的浏览器有可用且支持的标准功能，那么您应该使用该功能。以下是以不同格式获取相同信息的三种方法。避免使用基于某些假设或硬编码区域列表进行任何猜测的非标准解决方案，尽管如果无法做其他事情，它们可能会有所帮助。

获得此信息后，您可以将其作为非标准请求标头传递给服务器并在那里使用它。如果您还需要时区偏移量，您还可以将其传递给服务器的标头或请求有效负载，可以使用 dateObj.getTimezoneOffset() 进行检索。

1.  **使用 Intl API 获取 Olson 格式（标准和推荐方式）**：请注意，并非所有浏览器都支持。有关浏览器对此的支持的详细信息，请参阅[此链接](https://caniuse.com/?search=Intl.DateTimeFormat().resolvedOptions().timeZone)。这个 API 让您可以得到 Olson 格式的时区，例如 Asia/Kolkata、America/New_York 等。

```
Intl.DateTimeFormat().resolvedOptions().timeZone
```

2.  **使用 Date 对象获取长格式**，例如印度标准时间、东部标准时间等：所有浏览器都支持。

```
let dateObj = new Date(2021, 11, 25, 09, 30, 00);

//then 

dateObj.toString() 

//yields

Sat Dec 25 2021 09:30:00 GMT+0530 (India Standard Time) //I am located in India (IST)
```

请注意，该字符串包含长短格式的时区信息。您现在可以使用正则表达式来获取此信息：

```
let longZoneRegex = /\((.+)\)/;
dateObj.toString().match(longZoneRegex);

//yields

['(India Standard Time)', 'India Standard Time', index: 34, input: 'Sat Dec 25 2021 09:30:00 GMT+0530 (India Standard Time)', groups: undefined]

//Note that output is an array so use output[1] to get the timezone name.
```

3.  **使用 Date 对象获取短格式**，例如 GMT+0530、GMT-0500 等：所有浏览器都支持。

同样，您也可以获取短格式：

```
let shortZoneRegex = /GMT[+-]\d{1,4}/;
dateObj.toString().match(shortZoneRegex);

//yields

['GMT+0530', index: 25, input: 'Sat Dec 25 2021 09:30:00 GMT+0530 (India Standard Time)', groups: undefined]

//Note that output is an array so use output[0] to get the timezone name.
```

* * *

## 回答 #26

> 赞同：0
> 
> 时间：2021-04-13T09:46:08.563

我认为这`@Matt Johnson-Pints`是迄今为止最好的，CanIuse 搜索显示现在它已被广泛采用：

[https://caniuse.com/?search=Intl.DateTimeFormat().resolvedOptions().timeZone](https://caniuse.com/?search=Intl.DateTimeFormat().resolvedOptions().timeZone)

但是，挑战之一是考虑为什么要知道时区。因为我认为大多数人错过的一件事就是**他们可以改变！**如果用户带着他的笔记本电脑从欧洲旅行到美国，如果您之前将其存储在数据库中，那么他们的时区现在是不正确的（即使用户从未真正更新他们的设备时区）。这也是`@Mads Kristiansen`答案的问题，因为用户旅行 - 你不能依赖它作为给定的。

例如，我的 Linux 笔记本电脑关闭了“自动时区”。虽然时间可能会更新我的时区，但不会。

所以我相信答案是——你需要它做什么？客户端当然似乎提供了一种更简单的方法来确定它，但是客户端和服务器端代码都将取决于用户更新他们的时区还是自动更新。我当然可能是错的。

* * *

## 回答 #27

> 赞同：0
> 
> 时间：2020-10-13T06:43:49.217

没有办法在实际的 HTML 代码或任何`user-agent`字符串中计算时区，但您可以做一个使用 JavaScript 获取它的基本函数。

我还不知道如何用 JavaScript 编写代码，所以我的函数可能需要时间来完成。

但是，您也可以尝试使用 JavaScript 和部分`getTzimezoneOffset()`中的函数`Date`或简单地获取实际时区`new Date().getTimezoneOffset();`。

# .net - Difference between Math.Floor() and Math.Truncate()

> ID：14
> 
> 赞同：471
> 
> 时间：2008-08-01T00:59:11.177
> 
> 标签：.net, math

What is the difference between [`Math.Floor()`](http://msdn.microsoft.com/en-us/library/9a6a2sxy.aspx) and [`Math.Truncate()`](http://msdn.microsoft.com/en-us/library/system.math.truncate.aspx) in .NET?

* * *

## 回答 #1

> 赞同：536
> 
> 时间：2008-08-01T12:26:39.773

`Math.Floor`向下`Math.Ceiling`舍入、向上`Math.Truncate`舍入和向零舍入。因此，对于正数`Math.Truncate`是一样的，对于负数也是一样的。这是[参考](https://msdn.microsoft.com/en-us/library/system.math.truncate.aspx)。`Math.Floor``Math.Ceiling`

为了完整起见，`Math.Round`四舍五入到最接近的整数。如果该数字正好在两个整数之间，那么它会朝偶数四舍五入。[参考。](https://msdn.microsoft.com/en-us/library/system.math.round.aspx)

另请参阅：[Pax Diablo 的回答](https://stackoverflow.com/questions/14/whats-the-difference-between-math-floor-and-math-truncate-in-c/580252#580252)。强烈推荐！

* * *

## 回答 #2

> 赞同：417
> 
> 时间：2009-02-24T02:39:27.970

按照以下链接获取 MSDN 描述：

*   [`Math.Floor`](http://msdn.microsoft.com/en-us/library/system.math.floor.aspx)，向下舍入为负无穷大。
*   [`Math.Ceiling`](http://msdn.microsoft.com/en-us/library/system.math.ceiling.aspx)，向上取整为正无穷大。
*   [`Math.Truncate`](http://msdn.microsoft.com/en-us/library/system.math.truncate.aspx)，向上或向下舍入到零。
*   [`Math.Round`](http://msdn.microsoft.com/en-us/library/system.math.round.aspx)，四舍五入到最接近的整数或指定的小数位数。如果它在两种可能性之间完全等距，您可以指定行为，例如四舍五入以使最终数字为偶数（“ `Round(2.5,MidpointRounding.ToEven)`”变为 2）或使其远离零（“ `Round(2.5,MidpointRounding.AwayFromZero)`”变为 3）。

以下图表和表格可能会有所帮助：

```
-3        -2        -1         0         1         2         3
 +--|------+---------+----|----+--|------+----|----+-------|-+
    a                     b       c           d            e

                       a=-2.7  b=-0.5  c=0.3  d=1.5  e=2.8
                       ======  ======  =====  =====  =====
Floor                    -3      -1      0      1      2
Ceiling                  -2       0      1      2      3
Truncate                 -2       0      0      1      2
Round (ToEven)           -3       0      0      2      3
Round (AwayFromZero)     -3      -1      0      2      3 
```

请注意，这`Round`比看起来要强大得多，仅仅是因为它可以四舍五入到特定的小数位数。所有其他人总是四舍五入到零小数。例如：

```
n = 3.145;
a = System.Math.Round (n, 2, MidpointRounding.ToEven);       // 3.14
b = System.Math.Round (n, 2, MidpointRounding.AwayFromZero); // 3.15 
```

对于其他功能，您必须使用乘法/除法技巧来达到相同的效果：

```
c = System.Math.Truncate (n * 100) / 100;                    // 3.14
d = System.Math.Ceiling (n * 100) / 100;                     // 3.15 
```

* * *

## 回答 #3

> 赞同：69
> 
> 时间：2011-07-19T03:56:16.583

`Math.Floor()`向负无穷大舍入

`Math.Truncate`向上或向下舍入到零。

例如：

```
Math.Floor(-3.4)     = -4
Math.Truncate(-3.4)  = -3 
```

尽管

```
Math.Floor(3.4)     = 3
Math.Truncate(3.4)  = 3 
```

* * *

## 回答 #4

> 赞同：48
> 
> 时间：2018-02-11T15:03:22.717

`Math.floor`向左滑动...向右滑动
`Math.ceil`...
`Math.truncate`criiiiss crooooss（地板/天花板始终朝向 0） 恰恰
`Math.round`，非常光滑...（走到最近的一侧）

咱们上班去！(⌐□_□)

向左……`Math.floor`
你们现在把它拿回来……`--`
这次是两跳……`-=2`

大家拍手✋✋

你能走多低？能低点吗？一直到`floor`?

```
if (this == "wrong")
    return "i don't wanna be right"; 
```

`Math.truncate(x)`也一样`int(x)`。
通过删除正分数或负分数，您总是朝着 0 前进。

* * *

## 回答 #5

> 赞同：47
> 
> 时间：2008-08-05T11:01:47.400

一些例子：

```
Round(1.5) = 2
Round(2.5) = 2
Round(1.5, MidpointRounding.AwayFromZero) = 2
Round(2.5, MidpointRounding.AwayFromZero) = 3
Round(1.55, 1) = 1.6
Round(1.65, 1) = 1.6
Round(1.55, 1, MidpointRounding.AwayFromZero) = 1.6
Round(1.65, 1, MidpointRounding.AwayFromZero) = 1.7

Truncate(2.10) = 2
Truncate(2.00) = 2
Truncate(1.90) = 1
Truncate(1.80) = 1 
```

* * *

## 回答 #6

> 赞同：29
> 
> 时间：2015-01-02T13:09:18.093

它们在功能上与正数等价。不同之处在于它们如何处理负数。

例如：

```
Math.Floor(2.5) = 2
Math.Truncate(2.5) = 2

Math.Floor(-2.5) = -3
Math.Truncate(-2.5) = -2 
```

MSDN 链接： - [Math.Floor 方法](http://msdn.microsoft.com/en-us/library/e0b5f0xb.aspx) - [Math.Truncate 方法](http://msdn.microsoft.com/en-us/library/c2eabd70.aspx)

PS 当心 Math.Round 它可能不是你所期望的。

要获得“标准”舍入结果，请使用：

```
float myFloat = 4.5;
Console.WriteLine( Math.Round(myFloat) ); // writes 4
Console.WriteLine( Math.Round(myFloat, 0, MidpointRounding.AwayFromZero) ) //writes 5
Console.WriteLine( myFloat.ToString("F0") ); // writes 5 
```

* * *

## 回答 #7

> 赞同：28
> 
> 时间：2016-02-12T09:12:32.317

试试这个，例子：

***Math.Floor()***与 ***Math.Truncate()***

```
Math.Floor(2.56) = 2
Math.Floor(3.22) = 3
Math.Floor(-2.56) = -3
Math.Floor(-3.26) = -4

Math.Truncate(2.56) = 2
Math.Truncate(2.00) = 2
Math.Truncate(1.20) = 1
Math.Truncate(-3.26) = -3
Math.Truncate(-3.96) = -3 
```

还有***Math.Round()***

```
 Math.Round(1.6) = 2
   Math.Round(-8.56) = -9
   Math.Round(8.16) = 8
   Math.Round(8.50) = 8
   Math.Round(8.51) = 9 
```

**`math.floor()`**

返回小于或等于指定数字的最大整数。MSDN [system.math.floor](https://msdn.microsoft.com/en-us/library/system.math.floor.aspx)

**`math.truncate()`**

计算数字的整数部分。MSDN [system.math.truncate](https://msdn.microsoft.com/en-us/library/system.math.truncate(v=vs.110).aspx)

* * *

## 回答 #8

> 赞同：25
> 
> 时间：2012-06-07T18:15:14.220

[`Math.Floor()`](http://msdn.microsoft.com/en-us/library/system.math.floor.aspx)符合[IEEE 标准 754](http://standards.ieee.org/findstds/standard/754-2008.html)第 4 节的“向负无穷大”舍入。

[`Math.Truncate()`](http://msdn.microsoft.com/en-us/library/system.math.truncate.aspx)将 " 四舍五入到最接近零的整数。"

* * *

## 回答 #9

> 赞同：16
> 
> 时间：2013-09-19T11:44:21.917

`Math.Floor()`：返回小于或等于指定双精度浮点数的最大整数。

`Math.Round()`：将值四舍五入为最接近的整数或指定的小数位数。

* * *

## 回答 #10

> 赞同：5
> 
> 时间：2018-07-17T07:14:23.037

**`Math.floor()`**将始终向下舍入，即它返回 LESSER 整数。While**`round()`**将返回 NEAREST 整数

***数学.地板（）***

返回小于或等于指定数字的最大整数。

***数学.截断（）***

计算数字的整数部分。

* * *

## 回答 #11

> 赞同：3
> 
> 时间：2020-06-24T08:43:10.223

Math.Floor() ：

它给出小于或等于给定数字的最大整数。

```
 Math.Floor(3.45) =3
    Math.Floor(-3.45) =-4 
```

数学.截断（）：

它删除数字的小数位并用零替换

```
Math.Truncate(3.45)=3
 Math.Truncate(-3.45)=-3 
```

同样从上面的例子我们可以看到对于正数来说 floor 和 truncate 是相同的。

* * *

## 回答 #12

> 赞同：1
> 
> 时间：2020-03-22T19:17:02.653

截断删除小数点。

* * *

## 回答 #13

> 赞同：1
> 
> 时间：2020-11-28T16:49:35.003

按照 Floor 的数学定义，即“小于或等于一个数的最大整数”，这完全没有歧义，而 Truncate 只是去掉了小数部分，相当于向 0 舍入。

# c# - 从 LINQ 查询结果集中填充 DataSet 或 DataTable

> ID：16
> 
> 赞同：149
> 
> 时间：2008-08-01T04:59:33.643
> 
> 标签：c#, linq, web-services, .net-3.5

如何将 LINQ 查询公开为 ASMX Web 服务？
通常，从业务层，我可以返回一个 typed`DataSet`或 a`DataTable`可以序列化以通过 ASMX 传输。

如何对 LINQ 查询执行相同的操作？
有没有办法通过 LINQ 查询填充类型`DataSet`或 a ？`DataTable`

```
public static MyDataTable CallMySproc()
{
    string conn = "...";

    MyDatabaseDataContext db = new MyDatabaseDataContext(conn);
    MyDataTable dt = new MyDataTable();

    // execute a sproc via LINQ
    var query = from dr
                in db.MySproc().AsEnumerable
                select dr;

    // copy LINQ query resultset into a DataTable -this does not work !    
    dt = query.CopyToDataTable();

    return dt;
} 
```

如何将 LINQ 查询的结果集放入 a`DataSet`或 a 中`DataTable`？
或者，LINQ 查询是否可以序列化，以便我可以将其公开为 ASMX Web 服务？

* * *

## 回答 #1

> 赞同：92
> 
> 时间：2008-08-15T16:27:31.600

如问题中所述，`IEnumerable`有一个`CopyToDataTable`方法：

```
IEnumerable<DataRow> query =
    from order in orders.AsEnumerable()
    where order.Field<DateTime>("OrderDate") > new DateTime(2001, 8, 1)
    select order;

// Create a table from the query.
DataTable boundTable = query.CopyToDataTable<DataRow>(); 
```

为什么这对你不起作用？

* * *

## 回答 #2

> 赞同：28
> 
> 时间：2009-02-13T00:10:02.940

要对类执行此查询`DataContext`，您需要执行以下操作：

```
MyDataContext db = new MyDataContext();
IEnumerable<DataRow> query = 
    (from order in db.Orders.AsEnumerable()
        select new
        {
            order.Property,
            order.Property2
        })
    as IEnumerable<DataRow>;
return query.CopyToDataTable<DataRow>(); 
```

如果没有，`as IEnumerable<DataRow>;`您将看到以下编译错误：

> 无法将类型“System.Collections.Generic.IEnumerable”隐式转换为“System.Collections.Generic.IEnumerable”。存在显式转换（您是否缺少演员表？）

* * *

## 回答 #3

> 赞同：23
> 
> 时间：2008-08-15T16:42:54.097

制作一组数据传输对象、几个映射器，然后通过 .asmx 将其返回。
您*永远不*应该直接公开数据库对象，因为过程模式中的更改会在您没有注意到的情况下传播到 Web 服务使用者。

* * *

## 回答 #4

> 赞同：17
> 
> 时间：2008-08-01T14:10:55.757

如果您使用返回类型`IEnumerable`，您可以直接返回您的**查询**变量。

* * *

## 回答 #5

> 赞同：13
> 
> 时间：2008-08-08T12:17:20.750

创建一个类对象并返回一个`list(T)`查询。

* * *

## 回答 #6

> 赞同：4
> 
> 时间：2018-04-11T11:55:31.637

如果您`IEnumerable`用作返回类型，它将直接返回您的查询变量。

```
MyDataContext db = new MyDataContext();
IEnumerable<DataRow> query = 
    (from order in db.Orders.AsEnumerable()
        select new
        {
            order.Property,
            order.Property2
        })
    as IEnumerable<DataRow>;
return query.CopyToDataTable<DataRow>(); 
```

* * *

## 回答 #7

> 赞同：1
> 
> 时间：2019-06-20T20:14:05.057

为了完整起见，这些解决方案不适用于 EF Core（至少不适用于 EF Core 2.2）。正如此处其他答案中所建议的那样，投射到`IEnumerable<DataRow>`失败。实现此类和扩展方法对我[有用 https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/implement-copytodatatable-where-type-not-a-datarow](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/implement-copytodatatable-where-type-not-a-datarow)。

为什么它没有内置在 EF Core 中，我不知道。

# mysql - MySQL 中的二进制数据

> ID：17
> 
> 赞同：194
> 
> 时间：2008-08-01T05:09:55.993
> 
> 标签：mysql, database, binary-data, data-storage

如何在[MySQL](http://en.wikipedia.org/wiki/MySQL)中存储二进制数据？

* * *

## 回答 #1

> 赞同：142
> 
> 时间：2008-08-01T12:16:22.167

phpguy 的回答是正确的，但我认为那里的附加细节有很多混淆。

基本答案在`BLOB`数据类型/属性域中。**BLOB**是 Binary Large Object 的缩写，该列数据类型专门用于处理二进制数据。

请参阅[MySQL 的相关手册页](http://dev.mysql.com/doc/refman/5.7/en/blob.html)。

* * *

## 回答 #2

> 赞同：59
> 
> 时间：2008-08-01T05:12:44.193

对于这样的表：

```
CREATE TABLE binary_data (
    id INT(4) NOT NULL AUTO_INCREMENT PRIMARY KEY,
    description CHAR(50),
    bin_data LONGBLOB,
    filename CHAR(50),
    filesize CHAR(50),
    filetype CHAR(50)
); 
```

这是一个 PHP 示例：

```
<?php
    // store.php3 - by Florian Dittmer <dittmer@gmx.net>
    // Example php script to demonstrate the storing of binary files into
    // an sql database. More information can be found at http://www.phpbuilder.com/
?>

<html>
    <head><title>Store binary data into SQL Database</title></head>

    <body>
        <?php
            // Code that will be executed if the form has been submitted:

            if ($submit) {
                // Connect to the database (you may have to adjust
                // the hostname, username or password).

                mysql_connect("localhost", "root", "password");
                mysql_select_db("binary_data");

                $data = mysql_real_escape_string(fread(fopen($form_data, "r"), filesize($form_data)));

                $result = mysql_query("INSERT INTO binary_data (description, bin_data, filename, filesize, filetype) ".
                                    "VALUES ('$form_description', '$data', '$form_data_name', '$form_data_size', '$form_data_type')");

                $id= mysql_insert_id();
                print "<p>This file has the following Database ID: <b>$id</b>";

                mysql_close();
            } else {

                // else show the form to submit new data:
        ?>
        <form method="post" action="<?php echo $PHP_SELF; ?>" enctype="multipart/form-data">
            File Description:<br>
            <input type="text" name="form_description"  size="40">
            <input type="hidden" name="MAX_FILE_SIZE" value="1000000">
            <br>File to upload/store in database:<br>
            <input type="file" name="form_data"  size="40">
            <p><input type="submit" name="submit" value="submit">
        </form>

        <?php
            }
        ?>
    </body>
</html> 
```

* * *

## 回答 #3

> 赞同：42
> 
> 时间：2008-09-17T20:37:34.810

我强烈建议**不要**将二进制数据存储在关系数据库中。关系数据库旨在处理固定大小的数据；这就是他们的性能优势所在：还记得[Joel](http://www.joelonsoftware.com/articles/fog0000000319.html)关于为什么数据库如此之快的旧文章吗？因为从一条记录移动到另一条记录只需要 1 个指针增量。如果您添加未定义且大小变化很大的 BLOB 数据，您将搞砸性能。

相反，将文件存储在文件系统中，并将文件名存储在数据库中。

* * *

## 回答 #4

> 赞同：23
> 
> 时间：2008-08-02T14:57:13.043

虽然您还没有说出要存储的内容，并且您可能有充分的理由这样做，但答案通常是“作为文件系统参考”，而实际数据在文件系统的某个地方。

[http://www.onlamp.com/pub/a/onlamp/2002/07/11/MySQLtips.html](http://www.onlamp.com/pub/a/onlamp/2002/07/11/MySQLtips.html)

* * *

## 回答 #5

> 赞同：18
> 
> 时间：2010-12-31T01:04:37.700

这取决于您要存储的数据。上面的例子使用了`LONGBLOB`数据类型，但是你应该知道还有其他的二进制数据类型：

`TINYBLOB/BLOB/MEDIUMBLOB/LONGBLOB`
`VARBINARY`
`BINARY`

每个都有其用例。如果它是已知的（短）长度（例如打包数据），`BINARY`或者`VARBINARY`大部分时间都可以使用。它们还有一个额外的好处是能够对它们进行索引。

* * *

## 回答 #6

> 赞同：15
> 
> 时间：2008-09-16T04:07:09.990

虽然这不是必需的，但您可以尝试`base64`将数据编码并解码出来。这意味着数据库将只有 ascii 字符。这将需要更多的空间和时间，但与二进制数据有关的任何问题都将被消除。

* * *

## 回答 #7

> 赞同：12
> 
> 时间：2013-09-12T12:00:26.130

如果 -[不推荐](https://stackoverflow.com/a/87385/669677)- BLOB 字段存在，您可以这样保存数据：

```
mysql_query("UPDATE table SET field=X'".bin2hex($bin_data)."' WHERE id=$id"); 
```

取自[这里](https://stackoverflow.com/q/2558453/669677)的想法。

* * *

## 回答 #8

> 赞同：12
> 
> 时间：2014-05-01T09:37:09.290

当我需要存储二进制数据时，我总是使用[d0nut](https://stackoverflow.com/users/499257/d0nut)在之前的答案之一中`VARBINARY`介绍的格式。

您可以在 MySQL 网站的文档主题下找到文档：[12.4.2 The BINARY and VARBINARY Types](http://dev.mysql.com/doc/refman/5.0/en/binary-varbinary.html)。

如果您问什么是优势，请阅读问题：[why-varbinary-instead-of-varchar](https://stackoverflow.com/questions/13393718/why-varbinary-instead-of-varchar)。

* * *

## 回答 #9

> 赞同：11
> 
> 时间：2008-08-27T15:13:31.693

问题还出现了如何将数据放入 BLOB。您可以将数据放入 INSERT 语句中，如 PHP 示例所示（尽管您应该使用[mysql_real_escape_string](http://www.php.net/mysql-real-escape-string)而不是添加斜杠）。如果文件存在于数据库服务器上，也可以使用 MySQL 的[LOAD_FILE](http://dev.mysql.com/doc/refman/5.0/en/string-functions.html#function_load-file "加载文件")

# performance - 获取 π 值的最快方法是什么？

> ID：19
> 
> 赞同：340
> 
> 时间：2008-08-01T05:21:22.257
> 
> 标签：performance, algorithm, language-agnostic, unix, pi

我正在寻找获得 π 值的最快方法，作为个人挑战。更具体地说，我使用的方法不涉及使用`#define`常量，如`M_PI`，或硬编码数字。

下面的程序测试了我所知道的各种方法。理论上，内联汇编版本是最快的选择，但显然不可移植。我已将其作为基线与其他版本进行比较。在我的测试中，使用内置插件，该`4 * atan(1)`版本在 GCC 4.2 上是最快的，因为它会自动将 折叠`atan(1)`成一个常量。`-fno-builtin`指定后，版本`atan2(0, -1)`最快。

这是主要的测试程序（`pitimes.c`）：

```
#include <math.h>
#include <stdio.h>
#include <time.h>

#define ITERS 10000000
#define TESTWITH(x) {                                                       \
    diff = 0.0;                                                             \
    time1 = clock();                                                        \
    for (i = 0; i < ITERS; ++i)                                             \
        diff += (x) - M_PI;                                                 \
    time2 = clock();                                                        \
    printf("%s\t=> %e, time => %f\n", #x, diff, diffclock(time2, time1));   \
}

static inline double
diffclock(clock_t time1, clock_t time0)
{
    return (double) (time1 - time0) / CLOCKS_PER_SEC;
}

int
main()
{
    int i;
    clock_t time1, time2;
    double diff;

    /* Warmup. The atan2 case catches GCC's atan folding (which would
     * optimise the ``4 * atan(1) - M_PI'' to a no-op), if -fno-builtin
     * is not used. */
    TESTWITH(4 * atan(1))
    TESTWITH(4 * atan2(1, 1))

#if defined(__GNUC__) && (defined(__i386__) || defined(__amd64__))
    extern double fldpi();
    TESTWITH(fldpi())
#endif

    /* Actual tests start here. */
    TESTWITH(atan2(0, -1))
    TESTWITH(acos(-1))
    TESTWITH(2 * asin(1))
    TESTWITH(4 * atan2(1, 1))
    TESTWITH(4 * atan(1))

    return 0;
} 
```

`fldpi.c`以及仅适用于 x86 和 x64 系统的内联汇编内容 ( )：

```
double
fldpi()
{
    double pi;
    asm("fldpi" : "=t" (pi));
    return pi;
} 
```

还有一个构建脚本，它构建了我正在测试的所有配置（`build.sh`）：

```
#!/bin/sh
gcc -O3 -Wall -c           -m32 -o fldpi-32.o fldpi.c
gcc -O3 -Wall -c           -m64 -o fldpi-64.o fldpi.c

gcc -O3 -Wall -ffast-math  -m32 -o pitimes1-32 pitimes.c fldpi-32.o
gcc -O3 -Wall              -m32 -o pitimes2-32 pitimes.c fldpi-32.o -lm
gcc -O3 -Wall -fno-builtin -m32 -o pitimes3-32 pitimes.c fldpi-32.o -lm
gcc -O3 -Wall -ffast-math  -m64 -o pitimes1-64 pitimes.c fldpi-64.o -lm
gcc -O3 -Wall              -m64 -o pitimes2-64 pitimes.c fldpi-64.o -lm
gcc -O3 -Wall -fno-builtin -m64 -o pitimes3-64 pitimes.c fldpi-64.o -lm 
```

除了在各种编译器标志之间进行测试（我也比较了 32 位和 64 位，因为优化不同），我还尝试过切换测试的顺序。但是，该`atan2(0, -1)`版本仍然每次都名列前茅。

* * *

## 回答 #1

> 赞同：213
> 
> 时间：2008-08-02T18:22:52.690

如前所述，[蒙特卡洛方法](http://en.wikipedia.org/wiki/Monte_Carlo_method)应用了一些很棒的概念，但显然它不是最快的，不是远射，不是任何合理的衡量标准。此外，这完全取决于您正在寻找什么样的准确性。我所知道的最快的 π 是数字硬编码的那个。看看[Pi](http://functions.wolfram.com/Constants/Pi/ "圆周率")和[Pi[PDF]](http://functions.wolfram.com/PDF/Pi.pdf "圆周率公式")，有很多公式。

这是一种快速收敛的方法——每次迭代大约 14 位。[当前最快的应用程序PiFast](http://numbers.computation.free.fr/Constants/PiProgram/pifast.html "PiFast")将此公式与 FFT 结合使用。我只写公式，因为代码很简单。这个公式几乎被[拉马努金发现，被楚德诺夫斯基发现](http://numbers.computation.free.fr/Constants/Pi/piramanujan.html)。这实际上是他如何计算数十亿位数的数字 - 所以这不是一种忽视的方法。该公式将很快溢出，并且由于我们正在划分阶乘，因此延迟此类计算以删除项将是有利的。

![在此处输入图像描述](../Images/500342417b9e418f24aa937a053d8475.png)

![在此处输入图像描述](../Images/80fffa78b58a2f04bd4d3355e69e4068.png)

在哪里，

![在此处输入图像描述](../Images/7bb6addda0025ce03781a93eb5cd52ab.png)

下面是[Brent–Salamin 算法](http://mathworld.wolfram.com/Brent-SalaminFormula.html "布伦特萨拉明公式")。维基百科提到，当**a**和**b** “足够接近”时， **(a + b)² / 4t**将是 π 的近似值。我不确定“足够接近”是什么意思，但从我的测试来看，一次迭代有 2 个数字，两个有 7，三个有 15，当然这是双打，所以它可能有一个错误基于它的表示和*真实*的计算可能更准确。

```
let pi_2 iters =
    let rec loop_ a b t p i =
        if i = 0 then a,b,t,p
        else
            let a_n = (a +. b) /. 2.0 
            and b_n = sqrt (a*.b)
            and p_n = 2.0 *. p in
            let t_n = t -. (p *. (a -. a_n) *. (a -. a_n)) in
            loop_ a_n b_n t_n p_n (i - 1)
    in 
    let a,b,t,p = loop_ (1.0) (1.0 /. (sqrt 2.0)) (1.0/.4.0) (1.0) iters in
    (a +. b) *. (a +. b) /. (4.0 *. t) 
```

最后，来点 pi 高尔夫（800 位）怎么样？160 个字符！

```
int a=10000,b,c=2800,d,e,f[2801],g;main(){for(;b-c;)f[b++]=a/5;for(;d=0,g=c*2;c-=14,printf("%.4d",e+d/a),e=d%a)for(b=c;d+=f[b]*a,f[b]=d%--g,d/=g--,--b;d*=b);} 
```

* * *

## 回答 #2

> 赞同：120
> 
> 时间：2008-09-02T13:28:51.537

我真的很喜欢这个程序，因为它通过查看自己的区域来近似 π。

国际奥委会1988 年：[westley.c](http://www0.us.ioccc.org/1988/westley.c)

> ```
> #define _ -F<00||--F-OO--;
> int F=00,OO=00;main(){F_OO();printf("%1.3f\n",4.*-F/OO/OO);}F_OO()
> {
>             _-_-_-_
>        _-_-_-_-_-_-_-_-_
>     _-_-_-_-_-_-_-_-_-_-_-_
>   _-_-_-_-_-_-_-_-_-_-_-_-_-_
>  _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
>  _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
> _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
> _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
> _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
> _-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_
>  _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
>  _-_-_-_-_-_-_-_-_-_-_-_-_-_-_
>   _-_-_-_-_-_-_-_-_-_-_-_-_-_
>     _-_-_-_-_-_-_-_-_-_-_-_
>         _-_-_-_-_-_-_-_
>             _-_-_-_
> } 
> ```

* * *

## 回答 #3

> 赞同：79
> 
> 时间：2008-08-01T13:37:59.723

这是我在高中学习的计算 pi 的技术的一般描述。

我之所以分享这个，是因为我认为它足够简单，任何人都可以无限期地记住它，而且它还教给你“蒙特卡洛”方法的概念——这些方法是得出答案的统计方法，但不会立即出现可以通过随机过程推导出来。

画一个正方形，并在该正方形内刻一个象限（半圆的四分之一）（半径等于正方形边的象限，因此它尽可能多地填充正方形）

现在在广场上扔一个飞镖，并记录它落在哪里——也就是说，在广场内的任何地方选择一个随机点。当然，它落在了广场内，但它是在半圆内吗？记录这个事实。

多次重复这个过程——你会发现半圆内的点数与抛出的总数有一个比率，称之为比率x。

由于正方形的面积是 r 乘以 r，所以可以推导出半圆的面积是 x 乘以 r 乘以 r（即 x 乘以 r 的平方）。因此 x 乘以 4 会给你 pi。

这不是一种快速使用的方法。但这是蒙特卡洛方法的一个很好的例子。如果你环顾四周，你可能会发现许多超出你计算能力的问题都可以通过这些方法解决。

* * *

## 回答 #4

> 赞同：58
> 
> 时间：2009-12-22T15:40:04.047

为了完整性，一个 C++ 模板版本，对于优化的构建，将在编译时计算 PI 的近似值，并将内联到单个值。

```
#include <iostream>

template<int I>
struct sign
{
    enum {value = (I % 2) == 0 ? 1 : -1};
};

template<int I, int J>
struct pi_calc
{
    inline static double value ()
    {
        return (pi_calc<I-1, J>::value () + pi_calc<I-1, J+1>::value ()) / 2.0;
    }
};

template<int J>
struct pi_calc<0, J>
{
    inline static double value ()
    {
        return (sign<J>::value * 4.0) / (2.0 * J + 1.0) + pi_calc<0, J-1>::value ();
    }
};

template<>
struct pi_calc<0, 0>
{
    inline static double value ()
    {
        return 4.0;
    }
};

template<int I>
struct pi
{
    inline static double value ()
    {
        return pi_calc<I, I>::value ();
    }
};

int main ()
{
    std::cout.precision (12);

    const double pi_value = pi<10>::value ();

    std::cout << "pi ~ " << pi_value << std::endl;

    return 0;
} 
```

请注意，对于 I > 10，优化构建可能会很慢，对于非优化运行也是如此。对于 12 次迭代，我相信大约有 80k 次调用 value()（在没有记忆的情况下）。

* * *

## 回答 #5

> 赞同：43
> 
> 时间：2011-10-28T01:02:09.953

下面**准确回答了如何以最快的方式做到这一点 - 以最少的计算工作量**。即使你不喜欢这个答案，你也不得不承认，这确实是获得 PI 值的最快方法。

获取 Pi 值的最快**方法是：**

1.  选择你最喜欢的编程语言
2.  加载它的数学库
3.  并发现 Pi 已经在那里定义了——可以使用了！

如果您手头没有数学库..

第二种**最快**的方式（更通用的解决方案）是：

在 Internet 上查找 Pi，例如：

[http://www.eveandersson.com/pi/digits/1000000（100](http://www.eveandersson.com/pi/digits/1000000)万位......你的浮点精度是多少？）

或在这里：

[http://3.141592653589793238462643383279502884197169399375105820974944592.com/](http://3.141592653589793238462643383279502884197169399375105820974944592.com/)

或在这里：

[http://en.wikipedia.org/wiki/Pi](http://en.wikipedia.org/wiki/Pi)

找到您想要使用的任何精度算术所需的数字真的很快，并且通过定义一个常数，您可以确保您不会浪费宝贵的 CPU 时间。

这不仅是一个部分幽默的答案，而且实际上，如果有人继续在实际应用程序中计算 Pi 的值……那将是对 CPU 时间的极大浪费，不是吗？至少我没有看到一个真正的应用程序来尝试重新计算它。

**还要考虑**NASA 仅使用 15 位 Pi 来计算行星际旅行：

*   TL；DR：[https ://twitter.com/Rainmaker1973/status/1463477499434835968](https://twitter.com/Rainmaker1973/status/1463477499434835968)
*   JPL解释：[https ://www.jpl.nasa.gov/edu/news/2016/3/16/how-many-decimals-of-pi-do-we-really-need/](https://www.jpl.nasa.gov/edu/news/2016/3/16/how-many-decimals-of-pi-do-we-really-need/)

尊敬的版主：请注意OP问的是：“最快获取PI值的方法”

* * *

## 回答 #6

> 赞同：42
> 
> 时间：2008-08-24T17:14:08.060

实际上有一整本书（除其他外）专门用于计算 \pi 的*快速方法：“Pi 和 AGM”，作者 Jonathan 和 Peter Borwein（*[可在亚马逊上获得](https://rads.stackoverflow.com/amzn/click/com/047131515X "在亚马逊上可用")）。

我对 AGM 和相关算法进行了相当多的研究：这很有趣（尽管有时并不简单）。

请注意，要实现大多数现代算法来计算 \pi，您将需要一个多精度算术库（[GMP](http://gmplib.org/)是一个不错的选择，尽管我上次使用它已经有一段时间了）。

最佳算法的时间复杂度为 O(M(n)log(n))，其中 M(n) 是两个 n 位整数相乘的时间复杂度（M(n)=O(n log(n) log(log(n))) 使用基于 FFT 的算法，通常在计算 \pi 的数字时需要，这种算法在 GMP 中实现）。

请注意，尽管算法背后的数学可能并不简单，但算法本身通常是几行伪代码，并且它们的实现通常非常简单（如果您选择不编写自己的多精度算术:-)）。

* * *

## 回答 #7

> 赞同：26
> 
> 时间：2008-08-29T09:22:16.933

[BBP 公式](http://en.wikipedia.org/wiki/Bailey-Borwein-Plouffe_formula)允许您计算第n 个数字 - 以 2（或 16）为基数 - 甚至不必先处理前面的 n-1 个数字 :)

* * *

## 回答 #8

> 赞同：23
> 
> 时间：2009-03-08T03:02:12.637

我没有将 pi 定义为常数，而是始终使用`acos(-1)`.

* * *

## 回答 #9

> 赞同：22
> 
> 时间：2008-10-02T21:27:55.433

这是一个“经典”的方法，很容易实现。python（不是最快的语言）中的这个实现可以做到：

```
from math import pi
from time import time

precision = 10**6 # higher value -> higher precision
                  # lower  value -> higher speed

t = time()

calc = 0
for k in xrange(0, precision):
    calc += ((-1)**k) / (2*k+1.)
calc *= 4\. # this is just a little optimization

t = time()-t

print "Calculated: %.40f" % calc
print "Constant pi: %.40f" % pi
print "Difference: %.40f" % abs(calc-pi)
print "Time elapsed: %s" % repr(t) 
```

[您可以在此处](http://functions.wolfram.com/Constants/Pi/02/)找到更多信息。

无论如何，在 python 中获得精确的尽可能多的 pi 值的最快方法是：

```
from gmpy import pi
print pi(3000) # the rule is the same as 
               # the precision on the previous code 
```

这是 gmpy pi 方法的源代码，在这种情况下，我认为代码不如注释有用：

```
static char doc_pi[]="\
pi(n): returns pi with n bits of precision in an mpf object\n\
";

/* This function was originally from netlib, package bmp, by
 * Richard P. Brent. Paulo Cesar Pereira de Andrade converted
 * it to C and used it in his LISP interpreter.
 *
 * Original comments:
 * 
 *   sets mp pi = 3.14159... to the available precision.
 *   uses the gauss-legendre algorithm.
 *   this method requires time o(ln(t)m(t)), so it is slower
 *   than mppi if m(t) = o(t**2), but would be faster for
 *   large t if a faster multiplication algorithm were used
 *   (see comments in mpmul).
 *   for a description of the method, see - multiple-precision
 *   zero-finding and the complexity of elementary function
 *   evaluation (by r. p. brent), in analytic computational
 *   complexity (edited by j. f. traub), academic press, 1976, 151-176.
 *   rounding options not implemented, no guard digits used.
*/
static PyObject *
Pygmpy_pi(PyObject *self, PyObject *args)
{
    PympfObject *pi;
    int precision;
    mpf_t r_i2, r_i3, r_i4;
    mpf_t ix;

    ONE_ARG("pi", "i", &precision);
    if(!(pi = Pympf_new(precision))) {
        return NULL;
    }

    mpf_set_si(pi->f, 1);

    mpf_init(ix);
    mpf_set_ui(ix, 1);

    mpf_init2(r_i2, precision);

    mpf_init2(r_i3, precision);
    mpf_set_d(r_i3, 0.25);

    mpf_init2(r_i4, precision);
    mpf_set_d(r_i4, 0.5);
    mpf_sqrt(r_i4, r_i4);

    for (;;) {
        mpf_set(r_i2, pi->f);
        mpf_add(pi->f, pi->f, r_i4);
        mpf_div_ui(pi->f, pi->f, 2);
        mpf_mul(r_i4, r_i2, r_i4);
        mpf_sub(r_i2, pi->f, r_i2);
        mpf_mul(r_i2, r_i2, r_i2);
        mpf_mul(r_i2, r_i2, ix);
        mpf_sub(r_i3, r_i3, r_i2);
        mpf_sqrt(r_i4, r_i4);
        mpf_mul_ui(ix, ix, 2);
        /* Check for convergence */
        if (!(mpf_cmp_si(r_i2, 0) && 
              mpf_get_prec(r_i2) >= (unsigned)precision)) {
            mpf_mul(pi->f, pi->f, r_i4);
            mpf_div(pi->f, pi->f, r_i3);
            break;
        }
    }

    mpf_clear(ix);
    mpf_clear(r_i2);
    mpf_clear(r_i3);
    mpf_clear(r_i4);

    return (PyObject*)pi;
} 
```

* * *

**编辑：**我在剪切、粘贴和缩进方面遇到了一些问题，你可以在[这里](http://code.google.com/p/gmpy/source/browse/branches/aleax-sandbox/src/gmpy.c)找到源代码。

* * *

## 回答 #10

> 赞同：19
> 
> 时间：2008-08-06T22:54:12.827

如果最快你的意思是最快输入代码，这里是[golfscript](http://www.golfscript.com/golfscript/examples.html)解决方案：

```
;''6666,-2%{2+.2/@*\/10.3??2*+}*`1000<~\; 
```

* * *

## 回答 #11

> 赞同：18
> 
> 时间：2009-02-26T19:22:22.350

Pi正好是3！[教授。弗林克（辛普森一家）]

开玩笑，但这是 C# 中的一个（需要 .NET-Framework）。

```
using System;
using System.Text;

class Program {
    static void Main(string[] args) {
        int Digits = 100;

        BigNumber x = new BigNumber(Digits);
        BigNumber y = new BigNumber(Digits);
        x.ArcTan(16, 5);
        y.ArcTan(4, 239);
        x.Subtract(y);
        string pi = x.ToString();
        Console.WriteLine(pi);
    }
}

public class BigNumber {
    private UInt32[] number;
    private int size;
    private int maxDigits;

    public BigNumber(int maxDigits) {
        this.maxDigits = maxDigits;
        this.size = (int)Math.Ceiling((float)maxDigits * 0.104) + 2;
        number = new UInt32[size];
    }
    public BigNumber(int maxDigits, UInt32 intPart)
        : this(maxDigits) {
        number[0] = intPart;
        for (int i = 1; i < size; i++) {
            number[i] = 0;
        }
    }
    private void VerifySameSize(BigNumber value) {
        if (Object.ReferenceEquals(this, value))
            throw new Exception("BigNumbers cannot operate on themselves");
        if (value.size != this.size)
            throw new Exception("BigNumbers must have the same size");
    }

    public void Add(BigNumber value) {
        VerifySameSize(value);

        int index = size - 1;
        while (index >= 0 && value.number[index] == 0)
            index--;

        UInt32 carry = 0;
        while (index >= 0) {
            UInt64 result = (UInt64)number[index] +
                            value.number[index] + carry;
            number[index] = (UInt32)result;
            if (result >= 0x100000000U)
                carry = 1;
            else
                carry = 0;
            index--;
        }
    }
    public void Subtract(BigNumber value) {
        VerifySameSize(value);

        int index = size - 1;
        while (index >= 0 && value.number[index] == 0)
            index--;

        UInt32 borrow = 0;
        while (index >= 0) {
            UInt64 result = 0x100000000U + (UInt64)number[index] -
                            value.number[index] - borrow;
            number[index] = (UInt32)result;
            if (result >= 0x100000000U)
                borrow = 0;
            else
                borrow = 1;
            index--;
        }
    }
    public void Multiply(UInt32 value) {
        int index = size - 1;
        while (index >= 0 && number[index] == 0)
            index--;

        UInt32 carry = 0;
        while (index >= 0) {
            UInt64 result = (UInt64)number[index] * value + carry;
            number[index] = (UInt32)result;
            carry = (UInt32)(result >> 32);
            index--;
        }
    }
    public void Divide(UInt32 value) {
        int index = 0;
        while (index < size && number[index] == 0)
            index++;

        UInt32 carry = 0;
        while (index < size) {
            UInt64 result = number[index] + ((UInt64)carry << 32);
            number[index] = (UInt32)(result / (UInt64)value);
            carry = (UInt32)(result % (UInt64)value);
            index++;
        }
    }
    public void Assign(BigNumber value) {
        VerifySameSize(value);
        for (int i = 0; i < size; i++) {
            number[i] = value.number[i];
        }
    }

    public override string ToString() {
        BigNumber temp = new BigNumber(maxDigits);
        temp.Assign(this);

        StringBuilder sb = new StringBuilder();
        sb.Append(temp.number[0]);
        sb.Append(System.Globalization.CultureInfo.CurrentCulture.NumberFormat.CurrencyDecimalSeparator);

        int digitCount = 0;
        while (digitCount < maxDigits) {
            temp.number[0] = 0;
            temp.Multiply(100000);
            sb.AppendFormat("{0:D5}", temp.number[0]);
            digitCount += 5;
        }

        return sb.ToString();
    }
    public bool IsZero() {
        foreach (UInt32 item in number) {
            if (item != 0)
                return false;
        }
        return true;
    }

    public void ArcTan(UInt32 multiplicand, UInt32 reciprocal) {
        BigNumber X = new BigNumber(maxDigits, multiplicand);
        X.Divide(reciprocal);
        reciprocal *= reciprocal;

        this.Assign(X);

        BigNumber term = new BigNumber(maxDigits);
        UInt32 divisor = 1;
        bool subtractTerm = true;
        while (true) {
            X.Divide(reciprocal);
            term.Assign(X);
            divisor += 2;
            term.Divide(divisor);
            if (term.IsZero())
                break;

            if (subtractTerm)
                this.Subtract(term);
            else
                this.Add(term);
            subtractTerm = !subtractTerm;
        }
    }
} 
```

* * *

## 回答 #12

> 赞同：18
> 
> 时间：2009-09-17T16:30:44.767

如果您愿意使用近似值，`355 / 113`则适用于 6 位十进制数字，并且具有可用于整数表达式的额外优势。如今，这并不重要，因为“浮点数学协处理器”不再具有任何意义，但它曾经非常重要。

* * *

## 回答 #13

> 赞同：18
> 
> 时间：2011-02-05T05:26:05.760

使用类似机器的公式

```
176 * arctan (1/57) + 28 * arctan (1/239) - 48 * arctan (1/682) + 96 * arctan(1/12943) 

[; \left( 176 \arctan \frac{1}{57} + 28 \arctan \frac{1}{239} - 48 \arctan \frac{1}{682} + 96 \arctan \frac{1}{12943}\right) ;], for you TeX the World people. 
```

在 Scheme 中实现，例如：

`(+ (- (+ (* 176 (atan (/ 1 57))) (* 28 (atan (/ 1 239)))) (* 48 (atan (/ 1 682)))) (* 96 (atan (/ 1 12943))))`

* * *

## 回答 #14

> 赞同：17
> 
> 时间：2010-02-28T03:52:31.660

双打：

```
4.0 * (4.0 * Math.Atan(0.2) - Math.Atan(1.0 / 239.0)) 
```

这将精确到小数点后 14 位，足以填充双精度数（不准确可能是因为反正切中的其余小数被截断）。

还有赛斯，它是 3.14159265358979323846 **3**，而不是 64。

* * *

## 回答 #15

> 赞同：16
> 
> 时间：2008-09-17T17:49:15.247

## 在编译时用 D 计算 PI。

（从[DSource.org](http://www.dsource.org/projects/ddl/browser/trunk/meta/demo/calcpi.d)复制）

```
/** Calculate pi at compile time
 *
 * Compile with dmd -c pi.d
 */
module calcpi;

import meta.math;
import meta.conv;

/** real evaluateSeries!(real x, real metafunction!(real y, int n) term)
 *
 * Evaluate a power series at compile time.
 *
 * Given a metafunction of the form
 *  real term!(real y, int n),
 * which gives the nth term of a convergent series at the point y
 * (where the first term is n==1), and a real number x,
 * this metafunction calculates the infinite sum at the point x
 * by adding terms until the sum doesn't change any more.
 */
template evaluateSeries(real x, alias term, int n=1, real sumsofar=0.0)
{
  static if (n>1 && sumsofar == sumsofar + term!(x, n+1)) {
     const real evaluateSeries = sumsofar;
  } else {
     const real evaluateSeries = evaluateSeries!(x, term, n+1, sumsofar + term!(x, n));
  }
}

/*** Calculate atan(x) at compile time.
 *
 * Uses the Maclaurin formula
 *  atan(z) = z - z^3/3 + Z^5/5 - Z^7/7 + ...
 */
template atan(real z)
{
    const real atan = evaluateSeries!(z, atanTerm);
}

template atanTerm(real x, int n)
{
    const real atanTerm =  (n & 1 ? 1 : -1) * pow!(x, 2*n-1)/(2*n-1);
}

/// Machin's formula for pi
/// pi/4 = 4 atan(1/5) - atan(1/239).
pragma(msg, "PI = " ~ fcvt!(4.0 * (4*atan!(1/5.0) - atan!(1/239.0))) ); 
```

* * *

## 回答 #16

> 赞同：14
> 
> 时间：2009-01-12T18:24:48.297

这个版本（在 Delphi 中）没有什么特别之处，但它至少比[Nick Hodge 在他的博客上发布的版本](http://blogs.codegear.com/nickhodges/2009/01/09/39174)快:)。在我的机器上，进行十亿次迭代大约需要 16 秒，得到的值为**3.14159265** 25879（准确的部分以粗体显示）。

```
program calcpi;

{$APPTYPE CONSOLE}

uses
  SysUtils;

var
  start, finish: TDateTime;

function CalculatePi(iterations: integer): double;
var
  numerator, denominator, i: integer;
  sum: double;
begin
  {
  PI may be approximated with this formula:
  4 * (1 - 1/3 + 1/5 - 1/7 + 1/9 - 1/11 .......)
  //}
  numerator := 1;
  denominator := 1;
  sum := 0;
  for i := 1 to iterations do begin
    sum := sum + (numerator/denominator);
    denominator := denominator + 2;
    numerator := -numerator;
  end;
  Result := 4 * sum;
end;

begin
  try
    start := Now;
    WriteLn(FloatToStr(CalculatePi(StrToInt(ParamStr(1)))));
    finish := Now;
    WriteLn('Seconds:' + FormatDateTime('hh:mm:ss.zz',finish-start));
  except
    on E:Exception do
      Writeln(E.Classname, ': ', E.Message);
  end;
end. 
```

* * *

## 回答 #17

> 赞同：13
> 
> 时间：2009-02-20T21:21:20.913

回到过去，由于字数小、浮点运算速度慢或根本不存在，我们曾经做这样的事情：

```
/* Return approximation of n * PI; n is integer */
#define pi_times(n) (((n) * 22) / 7) 
```

对于不需要很高精度的应用程序（例如视频游戏），这非常快并且足够准确。

* * *

## 回答 #18

> 赞同：13
> 
> 时间：2009-12-22T21:13:49.913

如果您想*计算*π 的近似值（出于某种原因），您应该尝试二进制提取算法。[Bellard对](http://en.wikipedia.org/wiki/Bellard%27s_formula)[BBP](http://en.wikipedia.org/wiki/Bailey%E2%80%93Borwein%E2%80%93Plouffe_formula)的改进给出了 O(N^2) 中的 PI。

* * *

如果要*获得*π 的近似值来进行计算，则：

```
PI = 3.141592654 
```

当然，这只是一个近似值，并不完全准确。它偏离了 0.00000000004102 多一点。（十分之四，大约⁴ / [10,000,000,000]）。

* * *

如果你想用 π 做*数学*，那么给自己准备一支铅笔和纸或一个计算机代数包，并使用 π 的精确值 π。

如果你真的想要一个公式，这个很有趣：

## π = - *i* ln(-1)

* * *

## 回答 #19

> 赞同：1
> 
> 时间：2017-06-03T17:13:12.650

从圆形区域计算 π :-)

```
<input id="range" type="range" min="10" max="960" value="10" step="50" oninput="calcPi()">
<br>
<div id="cont"></div>

<script>
function generateCircle(width) {
    var c = width/2;
    var delta = 1.0;
    var str = "";
    var xCount = 0;
    for (var x=0; x <= width; x++) {
        for (var y = 0; y <= width; y++) {
            var d = Math.sqrt((x-c)*(x-c) + (y-c)*(y-c));
            if (d > (width-1)/2) {
                str += '.';
            }
            else {
                xCount++;
                str += 'o';
            }
            str += "&nbsp;" 
        }
        str += "\n";
    }
    var pi = (xCount * 4) / (width * width);
    return [str, pi];
}

function calcPi() {
    var e = document.getElementById("cont");
    var width = document.getElementById("range").value;
    e.innerHTML = "<h4>Generating circle...</h4>";
    setTimeout(function() {
        var circ = generateCircle(width);
        e.innerHTML  = "<pre>" + "π = " + circ[1].toFixed(2) + "\n" + circ[0] +"</pre>";
    }, 200);
}
calcPi();
</script>
```

* * *

## 回答 #20

> 赞同：1
> 
> 时间：2020-10-18T07:29:12.283

基本上是 C 版本的回形针优化器的答案，而且更加简化：

```
#include <stdio.h>
#include <math.h>

double calc_PI(int K) {
    static const int A = 545140134;
    static const int B = 13591409;
    static const int D = 640320;
    const double ID3 = 1.0 / ((double) D * (double) D * (double) D);
    double sum = 0.0;
    double b = sqrt(ID3);
    long long int p = 1;
    long long int a = B;
    sum += (double) p * (double) a * b;
    for (int k = 1; k < K; ++k) {
        a += A;
        b *= ID3;
        p *= (6 * k) * (6 * k - 1) * (6 * k - 2) * (6 * k - 3) * (6 * k - 4) * (6 * k - 5);
        p /= (3 * k) * (3 * k - 1) * (3 * k - 2) * k * k * k;
        p = -p;
        sum += (double) p * (double) a * b;
    }
    return 1.0 / (12 * sum);
}

int main() {
    for (int k = 1; k <= 5; ++k) {
        printf("k = %i, PI = %.16f\n", k, calc_PI(k));
    }
} 
```

但是为了更简化，这个算法采用了 Chudnovsky 的公式，如果你不是很了解代码，我可以完全简化。

摘要：我们将得到一个从 1 到 5 的数字，并将其添加到我们将用于获取 PI 的函数中。然后给你3个号码：545140134（A），13591409（B），640320（D）。然后我们将使用 D 作为`double`自身乘以 3 到另一个`double`(ID3)。然后我们将 ID3 的平方根带入另一个`double`(b) 并分配 2 个数字：1 (p)，B 的值 (a)。**请注意，C 不区分大小写。**然后`double`将通过将 p、a 和 b 的值相乘来创建 a (sum)`double`s。然后循环向上直到函数给出的数字将开始并将 A 的值加到 a，b 的值乘以 ID3，p 的值将乘以我希望你能理解的多个值，并且还除以多个值作为好。总和将再次与 p、a 和 b 相加，循环将重复，直到循环数的值大于或等于 5。然后，总和乘以 12 并由函数返回，结果为PI。

好吧，这很长，但我想你会明白的......

* * *

## 回答 #21

> 赞同：1
> 
> 时间：2021-10-18T04:21:37.663

我认为 pi 的值是圆的周长和半径之间的比率。

它可以通过常规的数学计算简单地实现

* * *

## 回答 #22

> 赞同：0
> 
> 时间：2018-06-18T10:07:01.910

## 更好的方法

要获得标准常量（如**pi**或标准概念）的输出，我们应该首先使用您正在使用的语言中可用的内置方法。它将以最快和最好的方式返回一个值。我正在使用 python 运行最快的方法来获取 pi 的值。

*   **数学库的 pi 变量**。数学库将变量 pi 存储为常数。

math_pi.py

```
import math
print math.pi 
```

使用 linux 的 time 实用程序运行脚本`/usr/bin/time -v python math_pi.py`

输出：

```
Command being timed: "python math_pi.py"
User time (seconds): 0.01
System time (seconds): 0.01
Percent of CPU this job got: 91%
Elapsed (wall clock) time (h:mm:ss or m:ss): 0:00.03 
```

*   **使用 arc cos 数学方法**

acos_pi.py

```
import math
print math.acos(-1) 
```

使用 linux 的 time 实用程序运行脚本`/usr/bin/time -v python acos_pi.py`

输出：

```
Command being timed: "python acos_pi.py"
User time (seconds): 0.02
System time (seconds): 0.01
Percent of CPU this job got: 94%
Elapsed (wall clock) time (h:mm:ss or m:ss): 0:00.03 
```

*   **使用[BBP 公式](https://en.wikipedia.org/wiki/Bailey%E2%80%93Borwein%E2%80%93Plouffe_formula)**

bbp_pi.py

```
from decimal import Decimal, getcontext
getcontext().prec=100
print sum(1/Decimal(16)**k * 
          (Decimal(4)/(8*k+1) - 
           Decimal(2)/(8*k+4) - 
           Decimal(1)/(8*k+5) -
           Decimal(1)/(8*k+6)) for k in range(100)) 
```

使用 linux 的 time 实用程序运行脚本`/usr/bin/time -v python bbp_pi.py`

输出：

```
Command being timed: "python c.py"
User time (seconds): 0.05
System time (seconds): 0.01
Percent of CPU this job got: 98%
Elapsed (wall clock) time (h:mm:ss or m:ss): 0:00.06 
```

**所以最好的方法是使用语言提供的内置方法，因为它们是最快最好的得到输出的。在 python 中使用 math.pi**

* * *

## 回答 #23

> 赞同：-1
> 
> 时间：2020-05-08T00:52:03.303

如果您不介意执行平方根和几个逆运算，那么 Chudnovsky 算法非常快。它在 2 次迭代中收敛到双精度。

```
/*
    Chudnovsky algorithm for computing PI
*/

#include <iostream>
#include <cmath>
using namespace std;

double calc_PI(int K=2) {

    static const int A = 545140134;
    static const int B = 13591409;
    static const int D = 640320;

    const double ID3 = 1./ (double(D)*double(D)*double(D));

    double sum = 0.;
    double b   = sqrt(ID3);
    long long int p = 1;
    long long int a = B;

    sum += double(p) * double(a)* b;

    // 2 iterations enough for double convergence
    for (int k=1; k<K; ++k) {
        // A*k + B
        a += A;
        // update denominator
        b *= ID3;
        // p = (-1)^k 6k! / 3k! k!^3
        p *= (6*k)*(6*k-1)*(6*k-2)*(6*k-3)*(6*k-4)*(6*k-5);
        p /= (3*k)*(3*k-1)*(3*k-2) * k*k*k;
        p = -p;

        sum += double(p) * double(a)* b;
    }

    return 1./(12*sum);
}

int main() {

    cout.precision(16);
    cout.setf(ios::fixed);

    for (int k=1; k<=5; ++k) cout << "k = " << k << "   PI = " << calc_PI(k) << endl;

    return 0;
} 
```

结果：

```
k = 1   PI = 3.1415926535897341
k = 2   PI = 3.1415926535897931
k = 3   PI = 3.1415926535897931
k = 4   PI = 3.1415926535897931
k = 5   PI = 3.1415926535897931 
```

# mysql - Throw an error preventing a table update in a MySQL trigger

> ID：24
> 
> 赞同：189
> 
> 时间：2008-08-01T12:12:19.350
> 
> 标签：mysql, database, triggers

If I have a trigger before the update on a table, how can I throw an error that prevents the update on that table?

* * *

## 回答 #1

> 赞同：163
> 
> 时间：2011-08-25T11:14:48.827

从 MySQL 5.5 开始，您可以使用以下[`SIGNAL`语法引发异常](https://dev.mysql.com/doc/refman/5.7/en/signal.html)：

```
signal sqlstate '45000' set message_text = 'My Error Message'; 
```

状态 45000 是表示“未处理的用户定义异常”的通用状态。

* * *

这是该方法的更完整示例：

```
delimiter //
use test//
create table trigger_test
(
    id int not null
)//
drop trigger if exists trg_trigger_test_ins //
create trigger trg_trigger_test_ins before insert on trigger_test
for each row
begin
    declare msg varchar(128);
    if new.id < 0 then
        set msg = concat('MyTriggerError: Trying to insert a negative value in trigger_test: ', cast(new.id as char));
        signal sqlstate '45000' set message_text = msg;
    end if;
end
//

delimiter ;
-- run the following as seperate statements:
insert into trigger_test values (1), (-1), (2); -- everything fails as one row is bad
select * from trigger_test;
insert into trigger_test values (1); -- succeeds as expected
insert into trigger_test values (-1); -- fails as expected
select * from trigger_test; 
```

* * *

## 回答 #2

> 赞同：65
> 
> 时间：2008-08-01T13:02:51.900

这是一种可能有效[的技巧。](https://web.archive.org/web/20180330233216/http://www.brokenbuild.com/blog/2006/08/15/mysql-triggers-how-do-you-abort-an-insert-update-or-delete-with-a-trigger/)它不干净，但看起来它可能会起作用：

本质上，您只是尝试更新一个不存在的列。

* * *

## 回答 #3

> 赞同：35
> 
> 时间：2012-01-28T15:46:57.407

不幸的是，@RuiDC 提供的答案在 5.5 之前的 MySQL 版本中不起作用，因为没有为存储过程实现*SIGNAL*。

我[找到](http://www.devshed.com/c/a/MySQL/Using-the-SIGNAL-Statement-for-Error-Handling/1/)的解决方案是模拟一个引发`table_name doesn't exist`错误的信号，将自定义的错误消息推送到`table_name`.

黑客可以使用触发器或使用存储过程来实现。我将按照@RuiDC 使用的示例在下面描述这两个选项。

## 使用触发器

```
DELIMITER $$
-- before inserting new id
DROP TRIGGER IF EXISTS before_insert_id$$
CREATE TRIGGER before_insert_id
    BEFORE INSERT ON test FOR EACH ROW
    BEGIN
        -- condition to check
        IF NEW.id < 0 THEN
            -- hack to solve absence of SIGNAL/prepared statements in triggers
            UPDATE `Error: invalid_id_test` SET x=1;
        END IF;
    END$$

DELIMITER ; 
```

## 使用存储过程

存储过程允许您使用动态 sql，这使得将错误生成功能封装在一个过程中成为可能。与之相对的是我们应该控制应用程序的插入/更新方法，因此它们只使用我们的存储过程（不授予插入/更新的直接权限）。

```
DELIMITER $$
-- my_signal procedure
CREATE PROCEDURE `my_signal`(in_errortext VARCHAR(255))
BEGIN
    SET @sql=CONCAT('UPDATE `', in_errortext, '` SET x=1');
    PREPARE my_signal_stmt FROM @sql;
    EXECUTE my_signal_stmt;
    DEALLOCATE PREPARE my_signal_stmt;
END$$

CREATE PROCEDURE insert_test(p_id INT)
BEGIN
    IF NEW.id < 0 THEN
         CALL my_signal('Error: invalid_id_test; Id must be a positive integer');
    ELSE
        INSERT INTO test (id) VALUES (p_id);
    END IF;
END$$
DELIMITER ; 
```

* * *

## 回答 #4

> 赞同：11
> 
> 时间：2012-11-08T16:15:33.607

以下过程是（在 mysql5 上）抛出自定义错误并同时记录它们的方法：

```
create table mysql_error_generator(error_field varchar(64) unique) engine INNODB;
DELIMITER $$
CREATE PROCEDURE throwCustomError(IN errorText VARCHAR(44))
BEGIN
    DECLARE errorWithDate varchar(64);
    select concat("[",DATE_FORMAT(now(),"%Y%m%d %T"),"] ", errorText) into errorWithDate;
    INSERT IGNORE INTO mysql_error_generator(error_field) VALUES (errorWithDate);
    INSERT INTO mysql_error_generator(error_field) VALUES (errorWithDate);
END;
$$
DELIMITER ;

call throwCustomError("Custom error message with log support."); 
```

* * *

## 回答 #5

> 赞同：6
> 
> 时间：2016-08-12T18:08:14.597

```
CREATE TRIGGER sample_trigger_msg 
    BEFORE INSERT
FOR EACH ROW
    BEGIN
IF(NEW.important_value) < (1*2) THEN
    DECLARE dummy INT;
    SELECT 
           Enter your Message Here!!!
 INTO dummy 
        FROM mytable
      WHERE mytable.id=new.id
END IF;
END; 
```

* * *

## 回答 #6

> 赞同：5
> 
> 时间：2016-04-09T23:11:16.963

您可以使用的另一种（hack）方法（如果您由于某种原因不在 5.5+ 上）：

如果您有必填字段，则在触发器中将必填字段设置为无效值，例如 NULL。这适用于 INSERT 和 UPDATE。请注意，如果 NULL 是必填字段的有效值（出于某种疯狂的原因），那么这种方法将不起作用。

```
BEGIN
    -- Force one of the following to be assigned otherwise set required field to null which will throw an error
    IF (NEW.`nullable_field_1` IS NULL AND NEW.`nullable_field_2` IS NULL) THEN
        SET NEW.`required_id_field`=NULL;
    END IF;
END 
```

如果您使用的是 5.5+，那么您可以使用其他答案中描述的信号状态：

```
BEGIN
    -- Force one of the following to be assigned otherwise use signal sqlstate to throw a unique error
    IF (NEW.`nullable_field_1` IS NULL AND NEW.`nullable_field_2` IS NULL) THEN
        SIGNAL SQLSTATE '45000' set message_text='A unique identifier for nullable_field_1 OR nullable_field_2 is required!';
    END IF;
END 
```

* * *

## 回答 #7

> 赞同：1
> 
> 时间：2020-06-01T15:48:18.507

```
DELIMITER @@
DROP TRIGGER IF EXISTS trigger_name @@
CREATE TRIGGER trigger_name 
BEFORE UPDATE ON table_name
FOR EACH ROW
BEGIN

  --the condition of error is: 
  --if NEW update value of the attribute age = 1 and OLD value was 0
  --key word OLD and NEW let you distinguish between the old and new value of an attribute

   IF (NEW.state = 1 AND OLD.state = 0) THEN
       signal sqlstate '-20000' set message_text = 'hey it's an error!';     
   END IF;

END @@ 
DELIMITER ; 
```

# c++ - 如何在 z/OS 上的 C++ 中使用 C 套接字 API

> ID：25
> 
> 赞同：173
> 
> 时间：2008-08-01T12:13:50.207
> 
> 标签：c++, c, sockets, mainframe, zos

我在让 C 套接字 API 在 z/OS 上的 C++ 中正常工作时遇到问题。

虽然我包括`sys/socket.h`，但我仍然收到编译时错误，告诉我`AF_INET`未定义。

我是否遗漏了一些明显的东西，或者这是否与在 z/OS 上使我的问题变得更加复杂这一事实有关？

我发现有一个`#ifdef`我正在击中。显然 z/OS 并不高兴，除非我定义了我正在使用的套接字的“类型”：

```
#define _OE_SOCKETS 
```

现在，我个人不知道这`_OE_SOCKETS`实际上是为了什么，所以如果有任何 z/OS 套接字程序员在那里（你们三个），也许你可以给我一个关于这一切是如何工作的纲要？

测试应用

```
#include <sys/socket.h>

int main()
{
    return AF_INET;
} 
```

编译/链接输出：

```
cxx -Wc,xplink -Wl,xplink -o inet_test inet.C

"./inet.C", line 5.16: CCN5274 (S) The name lookup for "AF_INET" did not find a declaration.
CCN0797(I) Compilation failed for file ./inet.C. Object file not created. 
```

检查 sys/sockets.h 确实包含我需要的定义，据我所知，它没有被任何`#ifdef`语句阻塞。

然而，我注意到它包含以下内容：

```
#ifdef __cplusplus
  extern "C" {
#endif 
```

基本上封装了整个文件？不确定是否重要。

* * *

## 回答 #1

> 赞同：95
> 
> 时间：2009-09-18T11:17:01.933

随身携带一份 IBM 手册：

*   [z/OS V1R11.0 XL C/C++ 编程指南](http://publibz.boulder.ibm.com/cgi-bin/bookmgr_OS390/BOOKS/CBCPG1A0/CCONTENTS?DT=20090606065305)
*   [z/OS V1R11.0 XL C/C++ 运行时库参考](http://publibz.boulder.ibm.com/cgi-bin/bookmgr_OS390/BOOKS/EDCLB1A0/CCONTENTS?DT=20090607203246)

IBM 的出版物通常都很好，但您需要习惯它们的格式，并知道在哪里可以找到答案。您会经常发现您要使用的功能受到“功能测试宏”的保护

您应该请友好的系统程序员在您的系统上安装[XL C/C++ 运行时库参考：手册页](http://www-03.ibm.com/servers/eserver/zseries/zos/le/manpgs.html) 。然后，您可以执行“man connect”之类的操作来拉出套接字 connect() API 的手册页。当我这样做时，这就是我所看到的：

格式

X/打开

```
#define _XOPEN_SOURCE_EXTENDED 1
#include <sys/socket.h>

int connect(int socket, const struct sockaddr *address, socklen_t address_len); 
```

伯克利插座

```
#define _OE_SOCKETS
#include <sys/types.h>
#include <sys/socket.h>

int connect(int socket, struct sockaddr *address, int address_len); 
```

* * *

## 回答 #2

> 赞同：44
> 
> 时间：2008-08-01T12:22:40.797

我在 GNU/Linux 中使用 C++ 中的 BSD 套接字 API 没有任何问题。这是我使用的示例程序：

```
#include <sys/socket.h>

int
main()
{
    return AF_INET;
} 
```

所以我对此的看法是 z/OS 可能是这里的复杂因素，然而，因为我以前从未使用过 z/OS，更不用说在其中编程了，所以我不能明确地说出来。:-P

* * *

## 回答 #3

> 赞同：38
> 
> 时间：2009-05-15T05:27:09.057

请参阅 z/OS XL C/C++ 编程指南中的*使用 z/OS UNIX 系统服务套接字*部分。确保包含必要的头文件并使用适当的#defines。

多年来，该文档的链接发生了变化，但您应该能够通过在[ibm.com上找到](http://www.ibm.com/)[Support & Downloads 部分](http://ibm.com/support/entry/portal/documentation)的当前位置并按标题搜索文档来轻松访问它。

* * *

## 回答 #4

> 赞同：31
> 
> 时间：2008-09-21T12:37:01.023

所以试试

```
#define _OE_SOCKETS 
```

在包含 sys/socket.h 之前

* * *

## 回答 #5

> 赞同：31
> 
> 时间：2008-10-11T00:38:49.903

_OE_SOCKETS 似乎只是启用/禁用套接字相关符号的定义。在某些库中，有一堆宏来执行此操作并不少见，以确保您不会编译/链接不需要的部分。该宏在其他套接字实现中不是标准的，它似乎是 z/OS 特有的。

看看这个页面：
[编译和链接 z/VM C Sockets Program](http://publib.boulder.ibm.com/infocenter/zvm/v5r3/index.jsp?topic=/com.ibm.zvm.v53.kiml0/sktnew.htm)

* * *

## 回答 #6

> 赞同：24
> 
> 时间：2008-08-01T13:40:16.443

@Jax：`extern "C"`事情很重要，非常非常重要。如果一个头文件没有，那么（除非它是一个仅 C++ 的头文件），你必须`#include`用它附上你的：

```
extern "C" {
#include <sys/socket.h>
// include other similarly non-compliant header files
} 
```

基本上，任何时候 C++ 程序想要链接到基于 C 的设施，这`extern "C"`都是至关重要的。实际上，这意味着外部引用中使用的名称不会像普通的 C++ 名称那样被破坏。[参考。](http://www.parashift.com/c++-faq-lite/mixing-c-and-cpp.html)

* * *

## 回答 #7

> 赞同：24
> 
> 时间：2008-09-07T08:21:50.157

您可能想看看[cpp-sockets](http://sourceforge.net/projects/cpp-sockets/)，一个用于套接字系统调用的 C++ 包装器。它适用于许多操作系统（Win32、POSIX、Linux、*BSD）。我认为它不适用于 z/OS，但您可以查看它使用的包含文件，并且您将拥有许多在其他操作系统上运行良好的测试代码示例。

* * *

## 回答 #8

> 赞同：19
> 
> 时间：2008-08-29T18:56:19.723

免责声明：我不是 C++ 程序员，但我非常了解 C。我从我拥有的一些 C 代码中改编了这些调用。

也markdown把这些奇怪的_作为我的下划线。

您应该能够使用以下内容围绕 C 套接字编写一个抽象类：

```
class my_sock {
    private int sock;
    private int socket_type;
    private socklen_t sock_len;
    private struct sockaddr_in server_addr;
    public char *server_ip;
    public unsigned short server_port;
}; 
```

然后有打开、关闭和通过套接字发送数据包的方法。

例如，公开电话可能看起来像这样：

```
int my_socket_connect()
{
    int return_code = 0;

    if ( this->socket_type != CLIENT_SOCK ) {
        cout << "This is a not a client socket!\n";
        return -1;
    }

    return_code = connect( this->local_sock, (struct sockaddr *) &this->server_addr, sizeof(this->server_addr));

    if( return_code < 0 ) {
        cout << "Connect() failure! %s\n", strerror(errno);
        return return_code;
    }

    return return_code;
} 
```

* * *

## 回答 #9

> 赞同：18
> 
> 时间：2011-04-11T18:59:23.960

使用以下 c89 标志：

```
 -D_OE_SOCKETS 
```

例子：

```
 bash-2.03$ c89 -D_OE_SOCKETS [filename].c 
```

有关更多信息，请查看 z/OS XLC/C++ 用户指南中的 c89 选项。

# arrays - 如何使用 Actionscript 3 卸载 ByteArray？

> ID：34
> 
> 赞同：96
> 
> 时间：2008-08-01T12:30:57.630
> 
> 标签：arrays, actionscript-3, apache-flex

如何`ByteArray`使用 ActionScript 3 从内存中强制卸载？

我尝试了以下方法：

```
// First non-working solution
byteArray.length = 0;
byteArray = new ByteArray();

// Second non-working solution
for ( var i:int=0; i < byteArray.length; i++ ) {
    byteArray[i] = null;
} 
```

* * *

## 回答 #1

> 赞同：34
> 
> 时间：2008-08-14T17:05:34.857

我不认为你有什么可担心的。如果`System.totalMemory`下降，您可以放松。很可能是操作系统没有回收新释放的内存（预计下次 Flash Player 会要求更多内存）。

尝试做一些占用大量内存的事情，我相信您会注意到分配给 Flash Player 的内存将减少并用于其他进程。

据我了解，从查看分配给每个进程的数量甚至分配的总量的角度来看，现代操作系统中的内存管理并不直观。

当我使用我的 Mac 5 分钟时，我的 3 GB RAM 的 95% 被使用了，并且它将保持这种状态，它永远不会出现故障。这就是操作系统处理内存的方式。

只要在其他地方不需要它，即使已经退出的进程仍然分配给它们内存（例如，这可以使它们下次启动得更快）。

* * *

## 回答 #2

> 赞同：24
> 
> 时间：2008-08-01T13:08:59.487

（我对此并不积极，但是......）

AS3 使用非确定性垃圾回收，这意味着只要运行时感觉像它，就会释放取消引用的内存（通常除非有运行的理由，否则不会释放，因为执行起来是一项昂贵的操作）。这与大多数现代垃圾收集语言（如 C# 和 Java）使用的方法相同。

假设没有其他对指向的内存`byteArray`或数组本身中的项目的引用，则在退出声明的范围后，内存将在某个时刻被释放`byteArray`。

您可以强制进行垃圾收集，尽管您确实不应该这样做。如果这样做，请仅用于测试。如果你在生产中这样做，你会损害性能而不是帮助它。

要强制 GC，请尝试（是的，两次）：

```
flash.system.System.gc();
flash.system.System.gc(); 
```

[你可以在这里阅读更多](http://www.craftymind.com/2008/04/09/kick-starting-the-garbage-collector-in-actionscript-3-with-air/)。

* * *

## 回答 #3

> 赞同：19
> 
> 时间：2008-08-01T13:08:59.127

看看这篇文章

[http://www.gskinner.com/blog/archives/2006/06/as3_resource_ma.html](http://www.gskinner.com/blog/archives/2006/06/as3_resource_ma.html)

IANA actionscript 程序员，但是我得到的感觉是，因为垃圾收集器可能不会在您想要的时候运行。

因此 [http://www.craftymind.com/2008/04/09/kick-starting-the-garbage-collector-in-actionscript-3-with-air/](http://www.craftymind.com/2008/04/09/kick-starting-the-garbage-collector-in-actionscript-3-with-air/)

所以我建议尝试他们的收藏代码，看看是否有帮助

```
private var gcCount:int;
private function startGCCycle():void{
    gcCount = 0;
    addEventListener(Event.ENTER_FRAME, doGC);
}
private function doGC(evt:Event):void{
    flash.system.System.gc();
    if(++gcCount > 1){
        removeEventListener(Event.ENTER_FRAME, doGC);
        setTimeout(lastGC, 40);
    }
}
private function lastGC():void{
    flash.system.System.gc();
} 
```

* * *

## 回答 #4

> 赞同：15
> 
> 时间：2008-08-01T14:03:22.230

我相信你已经回答了你自己的问题。

`System.totalMemory`给你正在“使用”的内存总量，而不是分配的。准确地说，您的应用程序可能只使用 20 MB，但它有 5 MB 可供将来分配。

我不确定 Adob​​e 文档是否会阐明它管理内存的方式。

* * *

## 回答 #5

> 赞同：15
> 
> 时间：2008-08-01T13:14:40.007

不幸的是，当涉及到*Flash/actionscript*中的内存管理时，您无能为力。ActionScript 被设计为易于使用（因此他们不希望人们担心内存管理）

以下是一种解决方法，而不是创建`ByteArray`变量试试这个。

```
var byteObject:Object = new Object();

byteObject.byteArray = new ByteArray();

...

//Then when you are finished delete the variable from byteObject
delete byteObject.byteArray; 
```

`byteArray`的动态属性在哪里`byteObject`，您可以释放为它分配的内存。

* * *

## 回答 #6

> 赞同：11
> 
> 时间：2008-09-17T10:09:52.217

> 因此，如果我从 MySQL 加载 20MB，在任务管理器中，应用程序的 RAM 会增加约 25MB。然后，当我关闭连接并尝试处理 ByteArray 时，RAM 永远不会释放。但是，如果我使用 System.totalMemory，flash player 会显示正在释放内存，但事实并非如此。
> 
> Flash 播放器是否在执行 Java 之类的操作并保留堆空间并在应用退出之前不释放它？

好吧，是也不是，正如您可能从无数博客文章中读到的那样，AVM2 中的 GC 是乐观的，并且会以自己神秘的方式工作。所以它确实有点像 Java 并试图保留堆空间。但是，如果您让它足够长的时间并开始执行其他消耗大量内存的操作，它将释放先前的空间。您可以在一夜之间使用分析器看到这一点，并在您的应用程序上运行一些测试。

* * *

## 回答 #7

> 赞同：10
> 
> 时间：2008-10-06T18:16:34.417

> 因此，如果我从 MySQL 加载 20MB，在任务管理器中，应用程序的 RAM 会增加约 25MB。然后，当我关闭连接并尝试处理 ByteArray 时，RAM 永远不会释放。但是，如果我使用 System.totalMemory，flash player 会显示正在释放内存，但事实并非如此。

玩家正在“释放”记忆。如果您最小化窗口并恢复它，您应该会看到内存现在更接近 System.totalMemory 显示的内容。

您可能还对使用 FlexBuilder 的分析工具感兴趣，该工具可以显示您是否确实存在内存泄漏。

* * *

## 回答 #8

> 赞同：8
> 
> 时间：2014-07-24T04:48:00.283

使用这些资源：

[http://help.adobe.com/en_US/ActionScript/3.0_ProgrammingAS3/WS5b3ccc516d4fbf351e63e3d118a9b8cbfe-7ff7.html](http://help.adobe.com/en_US/ActionScript/3.0_ProgrammingAS3/WS5b3ccc516d4fbf351e63e3d118a9b8cbfe-7ff7.html)

和这个

[http://help.adobe.com/en_US/ActionScript/3.0_ProgrammingAS3/WS5b3ccc516d4fbf351e63e3d118a9b8cbfe-7ff7.html](http://help.adobe.com/en_US/ActionScript/3.0_ProgrammingAS3/WS5b3ccc516d4fbf351e63e3d118a9b8cbfe-7ff7.html)

# sql - 检查对 SQL Server 表的更改？

> ID：36
> 
> 赞同：150
> 
> 时间：2008-08-01T12:35:56.917
> 
> 标签：sql, sql-server, datatable, rdbms

如何在不使用触发器或以任何方式修改数据库结构的情况下监视 SQL Server 数据库以了解对表的更改？我首选的编程环境是[.NET](http://en.wikipedia.org/wiki/.NET_Framework)和 C#。

我希望能够支持任何[SQL Server 2000](http://en.wikipedia.org/wiki/Microsoft_SQL_Server#Genesis) SP4 或更高版本。我的应用程序是另一家公司产品的附加数据可视化。我们的客户群数以千计，因此我不想要求我们在每次安装时都修改第三方供应商的表格。

“*对表的更改”*是指对表数据的更改，而不是对表结构的更改。

最终，我希望更改触发我的应用程序中的事件，而不是必须每隔一段时间检查更改。

* * *

考虑到我的要求（没有触发器或架构修改，SQL Server 2000 和 2005），最好的做法似乎是使用[T-SQL](http://en.wikipedia.org/wiki/Transact-SQL)`BINARY_CHECKSUM`中的函数。我计划实施的方式是这样的：

每 X 秒运行一次以下查询：

```
SELECT CHECKSUM_AGG(BINARY_CHECKSUM(*))
FROM sample_table
WITH (NOLOCK); 
```

并将其与存储的值进行比较。如果值已更改，请使用以下查询逐行浏览表：

```
SELECT row_id, BINARY_CHECKSUM(*)
FROM sample_table
WITH (NOLOCK); 
```

并将返回的校验和与存储的值进行比较。

* * *

## 回答 #1

> 赞同：100
> 
> 时间：2008-08-02T05:20:22.397

看一下 CHECKSUM 命令：

```
SELECT CHECKSUM_AGG(BINARY_CHECKSUM(*)) FROM sample_table WITH (NOLOCK); 
```

只要表格内容没有改变，每次运行时都会返回相同的数字。有关更多信息，请参阅我的帖子：

[校验和](http://msdn.microsoft.com/en-us/library/aa258245(SQL.80).aspx)

以下是我在表更改时使用它重建缓存依赖项的方法：
[ASP.NET 1.1 数据库缓存依赖项（无触发器）](http://weblogs.asp.net/jgalloway/archive/2005/05/07/406056.aspx)

* * *

## 回答 #2

> 赞同：30
> 
> 时间：2011-03-30T12:07:06.750

**不幸的是，CHECKSUM 并不总是能正常工作以检测更改**。

它只是一个原始校验和，没有循环冗余校验 (CRC) 计算。

因此你不能用它来检测所有的变化，例如对称变化导致相同的校验和！

例如。解决方案`CHECKSUM_AGG(BINARY_CHECKSUM(*))`将始终为所有 3 个具有不同内容的表提供 0：

```
 SELECT CHECKSUM_AGG(BINARY_CHECKSUM(*)) FROM 
(
  SELECT 1 as numA, 1 as numB
  UNION ALL
  SELECT 1 as numA, 1 as numB
)  q
-- delivers 0!

SELECT CHECKSUM_AGG(BINARY_CHECKSUM(*)) FROM 
(
  SELECT 1 as numA, 2 as numB
  UNION ALL
  SELECT 1 as numA, 2 as numB
)  q
-- delivers 0!

SELECT CHECKSUM_AGG(BINARY_CHECKSUM(*)) FROM 
(
  SELECT 0 as numA, 0 as numB
  UNION ALL
  SELECT 0 as numA, 0 as numB
)  q
-- delivers 0! 
```

* * *

## 回答 #3

> 赞同：24
> 
> 时间：2008-08-01T13:07:52.810

为什么不想使用触发器？如果您正确使用它们，它们是一件好事。如果您将它们用作强制引用完整性的一种方式，那就是它们从好到坏。但是，如果您将它们用于监视，则它们并不是真正的禁忌。

* * *

## 回答 #4

> 赞同：20
> 
> 时间：2008-08-03T13:59:24.063

您需要多久检查一次更改以及数据库中的表有多大（就行大小而言）？如果您使用`CHECKSUM_AGG(BINARY_CHECKSUM(*))`John 建议的方法，它将扫描指定表的每一行。提示会有所帮助，但在`NOLOCK`大型数据库中，您仍然会遇到每一行。您还需要存储每一行​​的校验和，以便告诉您已更改。

您是否考虑过从不同的角度来解决这个问题？如果您不想修改架构以添加触发器（这很有意义，这不是您的数据库），您是否考虑过与创建数据库的应用程序供应商合作？

他们可以实现一个 API，该 API 提供了一种机制来通知附属应用程序数据已更改。它可以像写入一个通知表一样简单，该表列出了修改了哪些表和哪一行。这可以通过触发器或应用程序代码来实现。从您的角度来看，这无关紧要，您唯一关心的就是定期扫描通知表。对数据库的性能影响将远远小于扫描每一行的更改。

困难的部分是说服应用程序供应商实现此功能。由于这可以通过触发器完全通过 SQL 来处理，因此您可以通过编写和测试触发器然后将代码提供给应用程序供应商来为它们完成大部分工作。通过让供应商支持触发器，它可以防止您添加触发器无意中替换了供应商提供的触发器的情况。

* * *

## 回答 #5

> 赞同：18
> 
> 时间：2008-08-06T01:54:21.687

不幸的是，我认为在 SQL2000 中没有一种干净的方法可以做到这一点。如果您将要求范围缩小到 SQL Server 2005（及更高版本），那么您就是在做生意。您可以使用`SQLDependency`. `System.Data.SqlClient`请参阅[SQL Server (ADO.NET) 中的查询通知](http://msdn.microsoft.com/en-us/library/t9x04ed2.aspx)。

* * *

## 回答 #6

> 赞同：16
> 
> 时间：2008-08-01T14:06:28.560

具有以给定时间间隔运行的 DTS 作业（或由 Windows 服务启动的作业）。每次运行时，它通过使用系统[INFORMATION_SCHEMA](http://msdn.microsoft.com/en-us/library/ms186778.aspx)表获取有关给定表的信息，并将这些数据记录在数据存储库中。将返回的有关表结构的数据与上次返回的数据进行比较。如果它不同，那么你就知道结构已经改变了。

返回有关表 ABC 中所有列的信息的示例查询（理想情况下，只列出您想要的 INFORMATION_SCHEMA 表中的列，而不是像我在这里那样使用 *select **）：

```
select * from INFORMATION_SCHEMA.COLUMNS where TABLE_NAME = 'ABC' 
```

您将监控不同的列和 INFORMATION_SCHEMA 视图，具体取决于您如何准确定义“对表的更改”。

* * *

## 回答 #7

> 赞同：13
> 
> 时间：2008-08-05T01:12:37.527

在这里疯狂猜测：如果您不想修改第三方的表格，您可以创建一个视图然后在该视图上放置触发器吗？

* * *

## 回答 #8

> 赞同：7
> 
> 时间：2014-07-24T04:58:25.450

检查最后提交日期。每个数据库都有每次提交的历史记录。我相信它是 ACID 合规性的标准。

# c# - 控制台应用程序中的可靠计时器

> ID：39
> 
> 赞同：110
> 
> 时间：2008-08-01T12:43:11.503
> 
> 标签：c#, .net, vb.net, timer

我知道在[.NET](http://en.wikipedia.org/wiki/.NET_Framework)中有三种计时器类型（请参阅*[Comparing the Timer Classes in the .NET Framework Class Library](http://msdn.microsoft.com/en-us/magazine/cc164015.aspx)*）。我选择了一个线程定时器，因为如果主线程很忙，其他类型可能会漂移，我需要它是可靠的。

这个计时器在计时器控制下的工作方式被放在另一个线程上，因此它总是可以在不忙时随着父线程上的工作开始完成而滴答作响。

控制台应用程序中这个计时器的问题是，当计时器在另一个线程上滴答作响时，主线程没有对应用程序关闭做任何事情。

我尝试添加一个`while true`循环，但是当计时器关闭时主线程太忙了。

* * *

## 回答 #1

> 赞同：62
> 
> 时间：2008-08-01T12:56:37.920

您可以使用诸如`Console.ReadLine()`阻塞主线程之类的东西，因此其他后台线程（如计时器线程）仍然可以工作。您也可以使用[AutoResetEvent](https://docs.microsoft.com/en-us/dotnet/api/system.threading.autoresetevent)来阻止执行，然后（当您需要时）您可以在该 AutoResetEvent 对象上调用 Set() 方法来释放主线程。还要确保您对 Timer 对象的引用不会超出范围并被垃圾收集。

* * *

## 回答 #2

> 赞同：22
> 
> 时间：2008-08-01T12:55:42.413

考虑使用[ManualResetEvent](https://docs.microsoft.com/en-us/dotnet/api/system.threading.manualresetevent)在处理结束时阻塞主线程，并`Reset()`在计时器处理完成后调用它。如果这需要持续运行，请考虑将其移动到服务进程而不是控制台应用程序中。

* * *

## 回答 #3

> 赞同：1
> 
> 时间：2020-12-10T16:48:40.317

根据[MSDN](https://docs.microsoft.com/en-us/dotnet/api/system.threading.timer?view=net-5.0)和其他答案，使用 System.Threading.Timer 而不立即退出的控制台应用程序的最小工作示例：

```
private static void Main()
{
    using AutoResetEvent autoResetEvent = new AutoResetEvent(false);
    using Timer timer = new Timer(state => Console.WriteLine("One second has passed"), autoResetEvent, TimeSpan.Zero, new TimeSpan(0, 0, 1));
    autoResetEvent.WaitOne();
} 
```

# php - 允许 PHP 应用程序插件的最佳方式

> ID：42
> 
> 赞同：293
> 
> 时间：2008-08-01T12:50:18.587
> 
> 标签：php, plugins, architecture, hook

我正在用 PHP 启动一个新的 Web 应用程序，这一次我想创建一些人们可以通过使用插件接口进行扩展的东西。

如何在他们的代码中编写“钩子”以便插件可以附加到特定事件？

* * *

## 回答 #1

> 赞同：167
> 
> 时间：2008-08-01T13:46:00.097

您可以使用观察者模式。实现此目的的简单功能方法：

```
<?php

/** Plugin system **/

$listeners = array();

/* Create an entry point for plugins */
function hook() {
    global $listeners;

    $num_args = func_num_args();
    $args = func_get_args();

    if($num_args < 2)
        trigger_error("Insufficient arguments", E_USER_ERROR);

    // Hook name should always be first argument
    $hook_name = array_shift($args);

    if(!isset($listeners[$hook_name]))
        return; // No plugins have registered this hook

    foreach($listeners[$hook_name] as $func) {
        $args = $func($args); 
    }
    return $args;
}

/* Attach a function to a hook */
function add_listener($hook, $function_name) {
    global $listeners;
    $listeners[$hook][] = $function_name;
}

/////////////////////////

/** Sample Plugin **/
add_listener('a_b', 'my_plugin_func1');
add_listener('str', 'my_plugin_func2');

function my_plugin_func1($args) {
    return array(4, 5);
}

function my_plugin_func2($args) {
    return str_replace('sample', 'CRAZY', $args[0]);
}

/////////////////////////

/** Sample Application **/

$a = 1;
$b = 2;

list($a, $b) = hook('a_b', $a, $b);

$str  = "This is my sample application\n";
$str .= "$a + $b = ".($a+$b)."\n";
$str .= "$a * $b = ".($a*$b)."\n";

$str = hook('str', $str);
echo $str;
?> 
```

**输出：**

```
This is my CRAZY application
4 + 5 = 9
4 * 5 = 20 
```

**笔记：**

对于此示例源代码，您必须在要扩展的实际源代码之前声明所有插件。我已经包含了一个如何处理传递给插件的单个或多个值的示例。最困难的部分是编写实际文档，其中列出了传递给每个钩子的参数。

这只是在 PHP 中完成插件系统的一种方法。还有更好的选择，我建议您查看 WordPress 文档以获取更多信息。

* * *

## 回答 #2

> 赞同：61
> 
> 时间：2009-06-01T05:59:16.400

所以假设你不想要观察者模式，因为它要求你改变你的类方法来处理监听任务，并且想要一些通用的东西。假设您不想使用`extends`继承，因为您可能已经在您的类中从其他类继承。*有一种通用的方法可以不费力*地使任何类可插入，这不是很好吗？就是这样：

```
<?php

////////////////////
// PART 1
////////////////////

class Plugin {

    private $_RefObject;
    private $_Class = '';

    public function __construct(&$RefObject) {
        $this->_Class = get_class(&$RefObject);
        $this->_RefObject = $RefObject;
    }

    public function __set($sProperty,$mixed) {
        $sPlugin = $this->_Class . '_' . $sProperty . '_setEvent';
        if (is_callable($sPlugin)) {
            $mixed = call_user_func_array($sPlugin, $mixed);
        }   
        $this->_RefObject->$sProperty = $mixed;
    }

    public function __get($sProperty) {
        $asItems = (array) $this->_RefObject;
        $mixed = $asItems[$sProperty];
        $sPlugin = $this->_Class . '_' . $sProperty . '_getEvent';
        if (is_callable($sPlugin)) {
            $mixed = call_user_func_array($sPlugin, $mixed);
        }   
        return $mixed;
    }

    public function __call($sMethod,$mixed) {
        $sPlugin = $this->_Class . '_' .  $sMethod . '_beforeEvent';
        if (is_callable($sPlugin)) {
            $mixed = call_user_func_array($sPlugin, $mixed);
        }
        if ($mixed != 'BLOCK_EVENT') {
            call_user_func_array(array(&$this->_RefObject, $sMethod), $mixed);
            $sPlugin = $this->_Class . '_' . $sMethod . '_afterEvent';
            if (is_callable($sPlugin)) {
                call_user_func_array($sPlugin, $mixed);
            }       
        } 
    }

} //end class Plugin

class Pluggable extends Plugin {
} //end class Pluggable

////////////////////
// PART 2
////////////////////

class Dog {

    public $Name = '';

    public function bark(&$sHow) {
        echo "$sHow<br />\n";
    }

    public function sayName() {
        echo "<br />\nMy Name is: " . $this->Name . "<br />\n";
    }

} //end class Dog

$Dog = new Dog();

////////////////////
// PART 3
////////////////////

$PDog = new Pluggable($Dog);

function Dog_bark_beforeEvent(&$mixed) {
    $mixed = 'Woof'; // Override saying 'meow' with 'Woof'
    //$mixed = 'BLOCK_EVENT'; // if you want to block the event
    return $mixed;
}

function Dog_bark_afterEvent(&$mixed) {
    echo $mixed; // show the override
}

function Dog_Name_setEvent(&$mixed) {
    $mixed = 'Coco'; // override 'Fido' with 'Coco'
    return $mixed;
}

function Dog_Name_getEvent(&$mixed) {
    $mixed = 'Different'; // override 'Coco' with 'Different'
    return $mixed;
}

////////////////////
// PART 4
////////////////////

$PDog->Name = 'Fido';
$PDog->Bark('meow');
$PDog->SayName();
echo 'My New Name is: ' . $PDog->Name; 
```

在第 1 部分中，您可能会`require_once()`在 PHP 脚本顶部的调用中包含这些内容。它加载类以使某些东西可插入。

在第 2 部分中，我们加载了一个类。注意我不需要对这个类做任何特别的事情，这与观察者模式有很大的不同。

在第 3 部分中，我们将类转换为“可插入的”（即支持让我们覆盖类方法和属性的插件）。因此，例如，如果您有一个网络应用程序，您可能有一个插件注册表，您可以在此处激活插件。还要注意`Dog_bark_beforeEvent()`函数。如果我`$mixed = 'BLOCK_EVENT'`在 return 语句之前设置，它会阻止狗吠，也会阻止 Dog_bark_afterEvent，因为不会有任何事件。

在第 4 部分中，这是正常的操作代码，但请注意，您可能认为会运行的代码根本不会这样运行。例如，这只狗并没有宣布它的名字是“Fido”，而是“Coco”。狗不叫“喵”，而是“汪”。当你事后想看狗的名字时，你会发现它是“不同”而不是“可可”。所有这些覆盖都在第 3 部分中提供。

那么这是如何工作的呢？好吧，让我们排除`eval()`（每个人都说它是“邪恶的”）并排除它不是观察者模式。因此，它的工作方式是一个名为 Pluggable 的偷偷摸摸的空类，它不包含 Dog 类使用的方法和属性。因此，既然发生了这种情况，魔法方法就会为我们服务。这就是为什么在第 3 部分和第 4 部分中，我们混淆了从 Pluggable 类派生的对象，而不是 Dog 类本身。相反，我们让 Plugin 类为我们对 Dog 对象进行“触摸”。（如果这是我不知道的某种设计模式——请告诉我。）

* * *

## 回答 #3

> 赞同：36
> 
> 时间：2008-08-01T17:23:43.777

*钩子*和*侦听*器方法是最常用的，但您还可以做其他事情。根据您的应用程序的大小，以及您将允许谁查看代码（这将是 FOSS 脚本还是内部的东西）将极大地影响您希望如何允许插件。

kdeloach 有一个很好的例子，但是他的实现和钩子函数有点不安全。我会要求你提供更多关于你写作的 php 应用程序性质的信息，以及你如何看待插件的适合性。

+1 向我发送 kdeloach。

* * *

## 回答 #4

> 赞同：26
> 
> 时间：2008-09-25T21:29:22.613

这是我使用过的一种方法，它试图从 Qt 信号/插槽机制中复制，一种观察者模式。对象可以发出信号。每个信号在系统中都有一个 ID - 它由发送者的 id + 对象名称组成 每个信号都可以绑定到接收者，这只是一个“可调用” 您使用总线类将信号传递给任何有兴趣接收它们的人 当某事发生时，你“发送”一个信号。下面是示例实现

```
 <?php

class SignalsHandler {

    /**
     * hash of senders/signals to slots
     *
     * @var array
     */
    private static $connections = array();

    /**
     * current sender
     *
     * @var class|object
     */
    private static $sender;

    /**
     * connects an object/signal with a slot
     *
     * @param class|object $sender
     * @param string $signal
     * @param callable $slot
     */
    public static function connect($sender, $signal, $slot) {
        if (is_object($sender)) {
            self::$connections[spl_object_hash($sender)][$signal][] = $slot;
        }
        else {
            self::$connections[md5($sender)][$signal][] = $slot;
        }
    }

    /**
     * sends a signal, so all connected slots are called
     *
     * @param class|object $sender
     * @param string $signal
     * @param array $params
     */
    public static function signal($sender, $signal, $params = array()) {
        self::$sender = $sender;
        if (is_object($sender)) {
            if ( ! isset(self::$connections[spl_object_hash($sender)][$signal])) {
                return;
            }
            foreach (self::$connections[spl_object_hash($sender)][$signal] as $slot) {
                call_user_func_array($slot, (array)$params);
            }

        }
        else {
            if ( ! isset(self::$connections[md5($sender)][$signal])) {
                return;
            }
            foreach (self::$connections[md5($sender)][$signal] as $slot) {
                call_user_func_array($slot, (array)$params);
            }
        }

        self::$sender = null;
    }

    /**
     * returns a current signal sender
     *
     * @return class|object
     */
    public static function sender() {
        return self::$sender;
    }

}   

class User {

    public function login() {
        /**
         * try to login
         */
        if ( ! $logged ) {
            SignalsHandler::signal(this, 'loginFailed', 'login failed - username not valid' );
        }
    }

}

class App {
    public static function onFailedLogin($message) {
        print $message;
    }
}

$user = new User();
SignalsHandler::connect($user, 'loginFailed', array($Log, 'writeLog'));
SignalsHandler::connect($user, 'loginFailed', array('App', 'onFailedLogin'));

$user->login();

?> 
```

* * *

## 回答 #5

> 赞同：19
> 
> 时间：2008-08-01T13:44:35.843

我相信最简单的方法是遵循 Jeff 自己的建议并查看现有代码。尝试查看 WordPress、Drupal、Joomla 和其他著名的基于 PHP 的 CMS，以了解他们的 API 挂钩的外观和感觉。通过这种方式，您甚至可以获得以前可能没有想到的想法，从而使事情变得更加强大。

一个更直接的答案是将他们将“include_once”写入他们的文件中的通用文件，这将提供他们需要的可用性。这将被分成几类，而不是在一个 MASSIVE “hooks.php”文件中提供。不过要小心，因为最终会发生的是它们包含的文件最终具有越来越多的依赖关系和功能改进。尽量保持 API 依赖性低。IE 更少的文件供他们包含。

* * *

## 回答 #6

> 赞同：16
> 
> 时间：2008-09-17T19:00:33.390

[雅虎的 Matt Zandstra 有一个名为Stickleback](http://developer.yahoo.net/blog/archives/2007/10/r3_and_stickleb.html)的简洁项目，它处理 PHP 中处理插件的大部分工作。

它强制执行插件类的接口，支持命令行接口，并且启动和运行并不难——尤其是如果您在[PHP 架构师杂志](http://www.phparch.com)中阅读了关于它的封面故事。

* * *

## 回答 #7

> 赞同：12
> 
> 时间：2008-09-17T19:38:52.970

好的建议是看看其他项目是如何做到的。许多人要求安装插件并为服务注册它们的“名称”（如 wordpress 所做的那样），因此您的代码中有“点”，您可以在其中调用识别已注册侦听器并执行它们的函数。标准的 OO 设计模式是[观察者模式](http://www.phppatterns.com/docs/design/observer_pattern)，这将是在真正面向对象的 PHP 系统中实现的一个不错的选择。

[Zend 框架](http://framework.zend.com)使用了许多挂钩方法，并且架构非常好。那将是一个很好的系统。

* * *

## 回答 #8

> 赞同：9
> 
> 时间：2013-04-22T07:41:24.147

我很惊讶这里的大多数答案似乎都是针对 Web 应用程序本地的插件，即在本地 Web 服务器上运行的插件。

如果您希望插件在不同的远程服务器上运行怎么办？最好的方法是提供一个表单，允许您定义在应用程序中发生特定事件时将调用的不同 URL。

不同的事件会根据刚刚发生的事件发送不同的信息。

这样，您只需对已提供给您的应用程序（例如通过 https）的 URL 执行 cURL 调用，远程服务器可以根据您的应用程序发送的信息执行任务。

这提供了两个好处：

1.  您不必在本地服务器上托管任何代码（安全性）
2.  代码可以在远程服务器上（可扩展性），使用 PHP 以外的其他语言（可移植性）

# html - HTML 表单中的多个提交按钮

> ID：48
> 
> 赞同：281
> 
> 时间：2008-08-01T13:01:17.303
> 
> 标签：html, forms, form-submit, submit-button

假设您在 HTML 表单中创建了一个向导。一键后退，一键前进。由于按下*后退*按钮首先出现在标记中`Enter`，因此它将使用该按钮提交表单。

例子：

```
<form>
  <!-- Put your cursor in this field and press Enter -->
  <input type="text" name="field1" />

  <!-- This is the button that will submit -->
  <input type="submit" name="prev" value="Previous Page" />

  <!-- But this is the button that I WANT to submit -->
  <input type="submit" name="next" value="Next Page" />
</form>
```

我想决定当用户按下哪个按钮来提交表单`Enter`。这样，当您按下时`Enter`，向导将移动到下一页，而不是上一页。你必须用`tabindex`它来做这个吗？

* * *

## 回答 #1

> 赞同：150
> 
> 时间：2008-08-28T09:34:40.143

我只是在做`float`右边的按钮。

这样`Prev`按钮就在按钮的左边`Next`，但`Next`在 HTML 结构中首先出现：

```
.f {
  float: right;
}
.clr {
  clear: both;
}
```

```
<form action="action" method="get">
  <input type="text" name="abc">
  <div id="buttons">
    <input type="submit" class="f" name="next" value="Next">
    <input type="submit" class="f" name="prev" value="Prev">
    <div class="clr"></div><!-- This div prevents later elements from floating with the buttons. Keeps them 'inside' div#buttons -->
  </div>
</form>
```

优于其他建议的好处：没有 JavaScript 代码，可访问，并且两个按钮都保留`type="submit"`。

* * *

## 回答 #2

> 赞同：65
> 
> 时间：2008-08-01T13:14:30.303

将之前的按钮类型更改为这样的按钮：

```
<input type="button" name="prev" value="Previous Page" /> 
```

现在*Next*按钮将是默认按钮，此外，您还可以为其添加`default`属性，以便您的浏览器将其突出显示，如下所示：

```
<input type="submit" name="next" value="Next Page" default /> 
```

* * *

## 回答 #3

> 赞同：61
> 
> 时间：2008-08-01T13:10:16.473

为您的提交按钮提供相同的名称，如下所示：

```
<input type="submit" name="submitButton" value="Previous Page" />
<input type="submit" name="submitButton" value="Next Page" /> 
```

当用户按下`Enter`并且*请求*转到服务器时，您可以检查包含表单对`submitButton`集合的服务器端代码的值。`name/value`例如，在[ASP Classic](http://en.wikipedia.org/wiki/Active_Server_Pages)中：

```
If Request.Form("submitButton") = "Previous Page" Then
    ' Code for the previous page
ElseIf Request.Form("submitButton") = "Next Page" Then
    ' Code for the next page
End If 
```

参考：*[在单个表单上使用多个提交按钮](http://www.chami.com/tips/internet/042599I.html)*

* * *

## 回答 #4

> 赞同：31
> 
> 时间：2008-08-02T11:24:57.417

如果默认情况下使用第一个按钮的事实在浏览器中是一致的，请将它们放在源代码中的正确位置，然后使用 CSS 切换它们的外观位置。

`float`例如，它们左右切换以在视觉上切换它们。

* * *

## 回答 #5

> 赞同：21
> 
> 时间：2012-10-26T09:53:08.867

有时[palotasb 提供的解决方案](https://stackoverflow.com/questions/48/multiple-submit-buttons-in-an-html-form/31910#31910)是不够的。在某些用例中，例如“过滤器”提交按钮放置在“下一个和上一个”等按钮上方。我找到了一个解决方法：*复制*需要充当隐藏 div 中默认提交按钮的提交按钮，并将其放在表单中任何其他提交按钮上方。

从技术上讲，当按下 Enter 时，它将由不同的按钮提交，而不是单击可见的 Next 按钮时提交。但是由于名称和值相同，因此结果没有区别。

```
<html>
<head>
    <style>
        div.defaultsubmitbutton {
            display: none;
        }
    </style>
</head>
<body>
    <form action="action" method="get">
        <div class="defaultsubmitbutton">
            <input type="submit" name="next" value="Next">
        </div>
        <p><input type="text" name="filter"><input type="submit" value="Filter"></p>
        <p>Filtered results</p>
        <input type="radio" name="choice" value="1">Filtered result 1
        <input type="radio" name="choice" value="2">Filtered result 2
        <input type="radio" name="choice" value="3">Filtered result 3
        <div>
            <input type="submit" name="prev" value="Prev">
            <input type="submit" name="next" value="Next">
        </div>
    </form>
</body>
</html> 
```

* * *

## 回答 #6

> 赞同：18
> 
> 时间：2008-08-26T03:44:54.507

纯 HTML 无法做到这一点。你必须依靠 JavaScript 来实现这个技巧。

但是，如果您在 HTML 页面上放置两个表单，则可以这样做。

Form1 将具有上一个按钮。

Form2 将有任何用户输入 + 下一个按钮。

当用户`Enter`在 Form2 中按下时，会触发 Next submit 按钮。

* * *

## 回答 #7

> 赞同：17
> 
> 时间：2008-08-03T13:12:21.007

我会使用 JavaScript 提交表单。该函数将由表单元素的 OnKeyPress 事件触发，并检测是否`Enter`选择了键。如果是这种情况，它将提交表单。

这里有两页提供了有关如何执行此操作的技术：[1](http://www.htmlcodetutorial.com/forms/index_famsupp_157.html)、[2](http://www.java2s.com/Code/JavaScript/Form-Control/SubmitaformViaEnter.htm)。基于这些，这里是一个使用示例（基于[here](http://www.htmlcodetutorial.com/forms/index_famsupp_157.html)）：

```
<SCRIPT TYPE="text/javascript">//<!--
function submitenter(myfield,e) {
  var keycode;
  if (window.event) {
    keycode = window.event.keyCode;
  } else if (e) {
    keycode = e.which;
  } else {
    return true;
  }

  if (keycode == 13) {
    myfield.form.submit();
    return false;
  } else {
    return true;
  }
}
//--></SCRIPT>

<INPUT NAME="MyText" TYPE="Text" onKeyPress="return submitenter(this,event)" /> 
```

* * *

## 回答 #8

> 赞同：17
> 
> 时间：2008-08-26T03:41:44.673

如果您真的只是希望它像安装对话框一样工作，只需将焦点放在“下一步”按钮 OnLoad。

这样，如果用户点击`Return`，表单就会提交并继续前进。如果他们想返回，可以点击`Tab`或点击按钮。

* * *

## 回答 #9

> 赞同：16
> 
> 时间：2008-09-16T12:16:05.913

你可以用 CSS 来做到这一点。

将按钮放在标记中，`Next`首先是按钮，然后是`Prev`按钮。

然后使用 CSS 将它们定位为您想要的方式。

* * *

## 回答 #10

> 赞同：13
> 
> 时间：2008-09-16T11:19:26.970

这在大多数浏览器中无需 JavaScript 或 CSS 即可工作：

```
<form>
    <p><input type="text" name="field1" /></p>
    <p><a href="previous.html">
    <button type="button">Previous Page</button></a>
    <button type="submit">Next Page</button></p>
</form> 
```

Firefox、Opera、Safari 和 Google Chrome 都可以使用。
与往常一样，Internet Explorer 是问题所在。

此版本在 JavaScript 开启时有效：

```
<form>
    <p><input type="text" name="field1" /></p>
    <p><a href="previous.html">
    <button type="button" onclick="window.location='previous.html'">Previous Page</button></a>
    <button type="submit">Next Page</button></p>
</form> 
```

所以这个解决方案的缺陷是：

如果您在关闭 JavaScript 的情况下使用 Internet Explorer，上一页将无法工作。

请注意，后退按钮仍然有效！

* * *

## 回答 #11

> 赞同：12
> 
> 时间：2014-03-14T14:51:50.723

如果您在一页上有多个活动按钮，那么您可以执行以下操作：

将要在`Enter`按键上触发的第一个按钮标记为表单上的默认按钮。对于第二个按钮，将其`Backspace`与键盘上的按钮相关联。事件`Backspace`代码为 8。

```
$(document).on("keydown", function(event) {
  if (event.which.toString() == "8") {
    var findActiveElementsClosestForm = $(document.activeElement).closest("form");

    if (findActiveElementsClosestForm && findActiveElementsClosestForm.length) {
      $("form#" + findActiveElementsClosestForm[0].id + " .secondary_button").trigger("click");
    }
  }
});
```

```
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>

<form action="action" method="get" defaultbutton="TriggerOnEnter">
  <input type="submit" id="PreviousButton" name="prev" value="Prev" class="secondary_button" />
  <input type="submit" id='TriggerOnEnter' name="next" value="Next" class="primary_button" />
</form>
```

* * *

## 回答 #12

> 赞同：11
> 
> 时间：2012-11-27T22:27:41.790

只需更改标签顺序即可完成此操作。把事情简单化。

另一个简单的选择是将返回按钮放在 HTML 代码中的提交按钮之后，但将其浮动到左侧，以便它出现在提交按钮之前的页面上。

* * *

## 回答 #13

> 赞同：10
> 
> 时间：2014-10-14T16:02:21.190

另一个简单的选择是在 HTML 代码中将后退按钮放在提交按钮之后，但将其浮动到左侧，因此它出现在提交按钮之前的页面上。

只需更改标签顺序即可完成此操作。把事情简单化。

* * *

## 回答 #14

> 赞同：10
> 
> 时间：2015-09-03T13:30:10.540

The first time I came up against this, I came up with an onclick()/JavaScript hack when choices are not prev/next that I still like for its simplicity. 它是这样的：

```
@model myApp.Models.myModel

<script type="text/javascript">
    function doOperation(op) {
        document.getElementById("OperationId").innerText = op;
        // you could also use Ajax to reference the element.
    }
</script>

<form>
  <input type="text" id = "TextFieldId" name="TextField" value="" />
  <input type="hidden" id="OperationId" name="Operation" value="" />
  <input type="submit" name="write" value="Write" onclick='doOperation("Write")'/>
  <input type="submit" name="read" value="Read" onclick='doOperation("Read")'/>
</form> 
```

当单击任一提交按钮时，它将所需的操作存储在隐藏字段中（这是包含在与表单关联的模型中的字符串字段）并将表单提交给控制器，控制器完成所有决定。在 Controller 中，您只需编写：

```
// Do operation according to which submit button was clicked
// based on the contents of the hidden Operation field.
if (myModel.Operation == "Read")
{
     // Do read logic
}
else if (myModel.Operation == "Write")
{
     // Do write logic
}
else
{
     // Do error logic
} 
```

您也可以使用数字操作代码稍微加强这一点，以避免字符串解析，但除非您使用枚举，否则代码的可读性、可修改性和自记录性较差，而且解析是微不足道的。

* * *

## 回答 #15

> 赞同：9
> 
> 时间：2015-03-28T21:05:52.650

来自[https://html.spec.whatwg.org/multipage/forms.html#implicit-submission](https://html.spec.whatwg.org/multipage/forms.html#implicit-submission)

> 表单元素的默认按钮是树形顺序中的第一个提交按钮，其表单所有者是该表单元素。
> 
> 如果用户代理支持让用户隐式提交表单（例如，在某些平台上，当文本字段被聚焦时，按下“回车”键会隐式提交表单）......

让下一个输入为 type="submit" 并将上一个输入更改为 type="button" 应该会提供所需的默认行为。

```
<form>
   <input type="text" name="field1" /> <!-- put your cursor in this field and press Enter -->

   <input type="button" name="prev" value="Previous Page" /> <!-- This is the button that will submit -->
   <input type="submit" name="next" value="Next Page" /> <!-- But this is the button that I WANT to submit -->
</form> 
```

* * *

## 回答 #16

> 赞同：8
> 
> 时间：2012-06-05T09:19:59.430

```
<input type="submit" name="prev" value="Previous Page"> 
<input type="submit" name="prev" value="Next Page"> 
```

保持所有提交按钮的名称相同：“prev”。

唯一的区别是`value`具有唯一值的属性。当我们创建脚本时，这些唯一值将帮助我们确定哪个提交按钮被按下。

并编写以下代码：

```
 btnID = ""
if Request.Form("prev") = "Previous Page" then
    btnID = "1"
else if Request.Form("prev") = "Next Page" then
    btnID = "2"
end if 
```

* * *

## 回答 #17

> 赞同：8
> 
> 时间：2014-03-03T06:16:35.067

这是我尝试过的：

1.  您需要确保为按钮提供不同的名称
2.  编写一个`if`语句，如果单击任一按钮，将执行所需的操作。

```
<form>
    <input type="text" name="field1" /> <!-- Put your cursor in this field and press Enter -->

    <input type="submit" name="prev" value="Previous Page" /> <!-- This is the button that will submit -->
    <input type="submit" name="next" value="Next Page" /> <!-- But this is the button that I WANT to submit -->
</form> 
```

在 PHP 中，

```
if(isset($_POST['prev']))
{
    header("Location: previous.html");
    die();
}

if(isset($_POST['next']))
{
    header("Location: next.html");
    die();
} 
```

* * *

## 回答 #18

> 赞同：7
> 
> 时间：2016-03-24T17:29:22.140

当我试图找到基本上相同的事情的答案时，我遇到了这个问题，只有 ASP.NET 控件，当我发现 ASP 按钮有一个名为的属性`UseSubmitBehavior`，允许您设置哪个提交。

```
<asp:Button runat="server" ID="SumbitButton" UseSubmitBehavior="False" Text="Submit" /> 
```

以防万一有人正在寻找 ASP.NET 按钮的方式来做到这一点。

* * *

## 回答 #19

> 赞同：6
> 
> 时间：2015-08-14T10:01:14.613

使用 JavaScript（这里是 jQuery），您可以在提交表单之前禁用 prev 按钮。

```
$('form').on('keypress', function(event) {
    if (event.which == 13) {
        $('input[name="prev"]').prop('type', 'button');
    }
}); 
```

* * *

## 回答 #20

> 赞同：2
> 
> 时间：2018-01-09T15:26:05.393

我以这种方式解决了一个非常相似的问题：

1.  如果启用了 JavaScript（现在大多数情况下），那么所有提交按钮都会在通过 JavaScript (jQuery) 加载页面时“**降级**”为按钮。**“降级**”按钮类型按钮上的点击事件也通过 JavaScript 处理。

2.  如果未启用 JavaScript，则表单将通过多个提交按钮提供给浏览器。在这种情况下，在表单中点击`Enter`a`textfield`将使用第一个按钮而不是预期的**default**提交表单，但至少该表单仍然可用：您可以使用**prev**和**next**按钮提交。

工作示例：

```
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    </head>

    <body>
        <form action="http://httpbin.org/post" method="post">
            If JavaScript  is disabled, then you CAN submit the form
            with button1, button2 or button3.

            If you press enter on a text field, then the form is
            submitted with the first submit button.

            If JavaScript is enabled, then the submit typed buttons
            without the 'defaultSubmitButton' style are converted
            to button typed buttons.

            If you press Enter on a text field, then the form is
            submitted with the only submit button
            (the one with class defaultSubmitButton)

            If you click on any other button in the form, then the
            form is submitted with that button's value.

            <br />

            <input type="text" name="text1" ></input>
            <button type="submit" name="action" value="button1" >button 1</button>
            <br />

            <input type="text" name="text2" ></input>
            <button type="submit" name="action" value="button2" >button 2</button>
            <br />

            <input type="text" name="text3" ></input>
            <button class="defaultSubmitButton" type="submit" name="action" value="button3" >default button</button>
        </form>

        <script>
            $(document).ready(function(){

                /* Change submit typed buttons without the 'defaultSubmitButton'
                   style to button typed buttons */
                $('form button[type=submit]').not('.defaultSubmitButton').each(function(){
                    $(this).attr('type', 'button');
                });

                /* Clicking on button typed buttons results in:
                   1\. Setting the form's submit button's value to
                      the clicked button's value,
                   2\. Clicking on the form's submit button */
                $('form button[type=button]').click(function( event ){
                    var form = event.target.closest('form');
                    var submit = $("button[type='submit']",form).first();
                    submit.val(event.target.value);
                    submit.click();
                });
            });
        </script>
    </body>
</html>
```

* * *

## 回答 #21

> 赞同：1
> 
> 时间：2018-04-25T06:28:32.217

您可以使用`Tabindex`来解决这个问题。更改按钮的顺序也是实现此目的的更有效方法。

更改按钮的顺序并添加`float`值以将它们分配到要在`HTML`视图中显示的所需位置。

* * *

## 回答 #22

> 赞同：0
> 
> 时间：2020-12-10T17:29:56.210

与其为多次提交、JavaScript 或类似的东西做一些上一个/下一个事情而苦苦挣扎，另一种选择是使用轮播来模拟不同的页面。这样做：

*   您不需要多个按钮、输入或提交来执行上一个/下一个操作，您`input type="submit"`只有一个`form`。
*   在提交表单之前，整个表单中的值都存在。
*   用户可以完美地转到任何上一页和任何下一页来修改值。

使用 Bootstrap 5.0.0 的示例：

```
<div id="carousel" class="carousel slide" data-ride="carousel">
    <form action="index.php" method="post" class="carousel-inner">
        <div class="carousel-item active">
            <input type="text" name="lastname" placeholder="Lastname"/>
        </div>
        <div class="carousel-item">
            <input type="text" name="firstname" placeholder="Firstname"/>
        </div>
        <div class="carousel-item">
            <input type="submit" name="submit" value="Submit"/>
        </div>
    </form>
    <a class="btn-secondary" href="#carousel" role="button" data-slide="prev">Previous page</a>
    <a class="btn-primary" href="#carousel" role="button" data-slide="next">Next page</a>
</div> 
```

* * *

## 回答 #23

> 赞同：0
> 
> 时间：2021-01-07T12:00:17.193

我认为这是一个简单的解决方案。*将Previous*按钮更改`type`为`button`，并为按钮添加一个新`onclick`属性，其值为`jQuery(this).attr('type','submit');`。

因此，当用户单击上*一个*按钮时，`type`它将更改为`submit`，并且表单将与上一个按钮一起*提交*。

```
<form>
  <!-- Put your cursor in this field and press Enter -->
  <input type="text" name="field1" />

  <!-- This is the button that will submit -->
  <input type="button" onclick="jQuery(this).attr('type','submit');" name="prev" value="Previous Page" />

  <!-- But this is the button that I WANT to submit -->
  <input type="submit" name="next" value="Next Page" />
</form> 
```

* * *

## 回答 #24

> 赞同：0
> 
> 时间：2021-08-26T15:57:17.787

一种可能比 CSS 浮动方法更现代的方法可能是使用具有`order`flex 项属性的 flexbox 的解决方案。可能是这样的：

```
<div style="display: flex">
  <input type="submit" name="next" value="Next Page" style="order: 1" />
  <input type="submit" name="prev" value="Previous Page" style="order: 0" />
</div> 
```

当然，这是否可行取决于您的文档结构，但我发现弹性项目比浮动元素更容易控制。

* * *

## 回答 #25

> 赞同：-1
> 
> 时间：2021-01-03T10:45:16.737

当用鼠标单击按钮（希望通过触摸）时，它会记录 X、Y 坐标。当它被表单调用时，情况并非如此，并且这些值通常为零。

所以你可以做这样的事情：

```
function(e) {
  const isArtificial = e.screenX === 0 && e.screenY === 0
    && e.x === 0 && e.y === 0
    && e.clientX === 0 && e.clientY === 0;

    if (isArtificial) {
      return; // DO NOTHING
    } else {
      // OPTIONAL: Don't submit the form when clicked
      // e.preventDefault();
      // e.stopPropagation();
    }

    // ...Natural code goes here
} 
```

* * *

## 回答 #26

> 赞同：-4
> 
> 时间：2008-08-05T15:08:42.037

使用您给出的示例：

```
<form>
    <input type="text" name="field1" /><!-- Put your cursor in this field and press Enter -->
    <input type="submit" name="prev" value="Previous Page" /> <!-- This is the button that will submit -->
    <input type="submit" name="next" value="Next Page" /> <!-- But this is the button that I WANT to submit -->
</form> 
```

如果您点击“上一页”，则只会提交“上一页”的值。如果您单击“下一页”，则只会提交“下一页”的值。

但是，如果您按`Enter`表单上的某个位置，则不会提交“prev”或“next”。

因此，使用伪代码可以执行以下操作：

```
If "prev" submitted then
    Previous Page was click
Else If "next" submitted then
    Next Page was click
Else
    No button was click 
```

# linq - 使用 LINQ 对集合进行分页

> ID：66
> 
> 赞同：90
> 
> 时间：2008-08-01T13:20:46.890
> 
> 标签：linq, .net-3.5

鉴于您有 a`startIndex`和 a ，您如何在 LINQ 中对集合进行分页`count`？

* * *

## 回答 #1

> 赞同：65
> 
> 时间：2008-08-01T13:22:04.483

`Skip`和`Take`扩展方法非常简单。

```
var query = from i in ideas
            select i;

var paggedCollection = query.Skip(startIndex).Take(count); 
```

* * *

## 回答 #2

> 赞同：46
> 
> 时间：2008-08-07T08:22:27.440

几个月前，我写了一篇关于 Fluent Interfaces 和 LINQ 的博客文章，其中使用了扩展方法`IQueryable<T>`和另一个类来提供以下对 LINQ 集合进行分页的自然方式。

```
var query = from i in ideas
            select i;
var pagedCollection = query.InPagesOf(10);
var pageOfIdeas = pagedCollection.Page(2); 
```

您可以从 MSDN 代码库页面获取代码：[Pipelines、Filters、Fluent API 和 LINQ to SQL](http://code.msdn.microsoft.com/productschallenge)。

* * *

## 回答 #3

> 赞同：15
> 
> 时间：2012-03-20T12:52:15.480

我解决这个问题的方式与其他人的解决方案有点不同，因为我必须使用中继器制作自己的分页器。所以我首先为我拥有的项目集合制作了一个页码集合：

```
// assumes that the item collection is "myItems"

int pageCount = (myItems.Count + PageSize - 1) / PageSize;

IEnumerable<int> pageRange = Enumerable.Range(1, pageCount);
   // pageRange contains [1, 2, ... , pageCount] 
```

使用它，我可以轻松地将项目集合划分为“页面”集合。在这种情况下，页面只是项目的集合 ( `IEnumerable<Item>`)。这是您可以使用`Skip`并`Take`从上面创建的索引中选择索引的方法`pageRange`：

```
IEnumerable<IEnumerable<Item>> pageRange
    .Select((page, index) => 
        myItems
            .Skip(index*PageSize)
            .Take(PageSize)); 
```

当然，您必须将每个页面作为一个附加集合来处理，但是例如，如果您要嵌套转发器，那么这实际上很容易处理。

* * *

*单线 TLDR*版本将是这样的：

```
var pages = Enumerable
    .Range(0, pageCount)
    .Select((index) => myItems.Skip(index*PageSize).Take(PageSize)); 
```

可以这样使用：

```
for (Enumerable<Item> page : pages) 
{
    // handle page

    for (Item item : page) 
    {
        // handle item in page
    }
} 
```

* * *

## 回答 #4

> 赞同：11
> 
> 时间：2011-07-16T20:07:57.473

这个问题有点老了，但我想发布我的分页算法来显示整个过程（包括用户交互）。

```
const int pageSize = 10;
const int count = 100;
const int startIndex = 20;

int took = 0;
bool getNextPage;
var page = ideas.Skip(startIndex);

do
{
    Console.WriteLine("Page {0}:", (took / pageSize) + 1);
    foreach (var idea in page.Take(pageSize))
    {
        Console.WriteLine(idea);
    }

    took += pageSize;
    if (took < count)
    {
        Console.WriteLine("Next page (y/n)?");
        char answer = Console.ReadLine().FirstOrDefault();
        getNextPage = default(char) != answer && 'y' == char.ToLowerInvariant(answer);

        if (getNextPage)
        {
            page = page.Skip(pageSize);
        }
    }
}
while (getNextPage && took < count); 
```

但是，如果您追求性能，并且在生产代码中，我们都追求性能，那么您不应该使用如上所示的 LINQ 的分页，而是`IEnumerator`自己实现分页的底层。事实上，它就像上面显示的 LINQ 算法一样简单，但性能更高：

```
const int pageSize = 10;
const int count = 100;
const int startIndex = 20;

int took = 0;
bool getNextPage = true;
using (var page = ideas.Skip(startIndex).GetEnumerator())
{
    do 
    {
        Console.WriteLine("Page {0}:", (took / pageSize) + 1);

        int currentPageItemNo = 0;
        while (currentPageItemNo++ < pageSize && page.MoveNext())
        {
            var idea = page.Current;
            Console.WriteLine(idea);
        }

        took += pageSize;
        if (took < count)
        {
            Console.WriteLine("Next page (y/n)?");
            char answer = Console.ReadLine().FirstOrDefault();
            getNextPage = default(char) != answer && 'y' == char.ToLowerInvariant(answer);
        }
    }
    while (getNextPage && took < count);
} 
```

`Skip()`解释：以“级联方式”多次使用的缺点是，它不会真正存储迭代的“指针”，它最后一次跳过的地方。- 相反，原始序列将预先加载跳过调用，这将导致一遍又一遍地“消耗”已经“消耗”的页面。- 您可以证明自己，当您创建序列`ideas`时，它会产生副作用。-> 即使您已经跳过 10-20 和 20-30 并且想要处理 40+，在开始迭代 40+ 之前，您会看到 10-30 的所有副作用再次执行。直接使用`IEnumerable`'s 接口的变体将记住最后一个逻辑页面的末尾位置，因此不需要显式跳过并且不会重复副作用。

# ruby - 如何在 Ruby 中将现有注释添加到 RDoc？

> ID：72
> 
> 赞同：49
> 
> 时间：2008-08-01T13:38:27.133
> 
> 标签：ruby, rdoc

我想将我现有的评论格式化为“RDoc 评论”，以便可以使用`ri`.

开始使用 RDoc 的推荐资源有哪些？

* * *

## 回答 #1

> 赞同：16
> 
> 时间：2008-08-23T04:48:20.730

有几件事让我很伤心：

*   `:main:`-- RDoc 只使用最后一个被评估的；最好确保您的项目中只有一个，并且您也不要使用`--main`命令行参数。
*   与以前相同，但对于`:title:`
*   `:section:`不太好用

* * *

## 回答 #2

> 赞同：10
> 
> 时间：2008-08-02T10:22:41.567

RDoc 使用 SimpleMarkup，因此使用 *、- 或数字创建列表等相当简单。它还将在相同列号处缩进的行视为同一段落的一部分，直到出现表示新段落的空行。您是否有一些您想要 RDoc 的评论示例，以便我们可以向您展示如何执行它们，然后您可以将其推断为您的其余评论？

# eclipse - 让 Aptana 中的 Subclipse 与最新版本的 Subversion 一起工作

> ID：79
> 
> 赞同：50
> 
> 时间：2008-08-01T13:56:33.837
> 
> 标签：eclipse, svn, aptana, subclipse

当前可通过 Aptana 的自动*插件管理器*获得的**Subclipse (1.2.4)**版本不适用于最新版本的 Subversion。

 *我在 Subclipse 网站上看到，他们为 Eclipse 提供了 1.4.2。所以我在我的更新管理器中添加了一个[新的远程更新站点。](http://subclipse.tigris.org/update_1.4.x)当我尝试安装它时，它告诉我我需要**Mylyn 3.0.0**。因此，经过大量搜索，我找到了 Mylyn 3.0.0，并在我的更新管理器中添加了[另一个新的远程更新站点。](http://download.eclipse.org/tools/mylyn/update/e3.3)然后当我尝试安装它时，它告诉我我需要**org.eclipse.ui 3.3.0**或同等版本。

查看 Aptana 的配置详细信息，它看起来像是针对 eclipse 3.2.2 构建的。

有谁知道是否有办法将构建的 Eclipse Aptana 版本升级到 3.3.0？或者是否有其他方法可以让 Subclipse 与最新版本的 Subversion 一起工作？

我知道这不一定是一个“编程”问题，但我希望没关系，因为它与编程经验高度相关。

* * *

## 回答 #1

> 赞同：18
> 
> 时间：2008-09-15T13:26:34.350

Subclipse 不需要 Mylyn，但更新站点包含一个集成 Mylyn 和 Subclipse 的插件。这适用于使用 Mylyn 的人。在您的情况下，您可能只想在更新对话框中取消选择 Mylyn。

Subclipse 还需要 Subversion 1.5 和 JavaHL 本机库的相应版本。我写了一个 FAQ 的开头来帮助人们理解 JavaHL 以及如何获得它。请参阅：[http ://desktop-eclipse.open.collab.net/wiki/JavaHL](http://desktop-eclipse.open.collab.net/wiki/JavaHL)

* * *

## 回答 #2

> 赞同：7
> 
> 时间：2008-08-01T14:41:01.110

当它在 Eclipse Europa 中运行良好时，我在 Eclipse Ganymede 中遇到了 JavaHL 问题。我不确定 Aptana 有何不同，但请尝试升级 JavaHL 或切换到 Subclipse 配置中的纯 Java SVNKit 实现。

* * *

## 回答 #3

> 赞同：4
> 
> 时间：2008-08-28T23:47:09.780

如果您不打算使用 mylyn，只需取消选中该依赖项即可。我对 Aptana 不是很熟悉，但是在 Eclipse 中，您可以扩展正在安装的内容并取消选中您不需要的任何内容。

* * *

## 回答 #4

> 赞同：3
> 
> 时间：2008-08-26T13:41:09.363

我使用更新 url 并安装了 JavaHL 适配器、Subclipse 项目本身**和**SVNKit 适配器 BETA。

在此之后它对我来说很好，这是针对 linux 平台的，希望它对你有用。*

# apache-flex - SQLStatement.execute() - 一条语句中的多个查询

> ID：80
> 
> 赞同：54
> 
> 时间：2008-08-01T13:57:07.033
> 
> 标签：apache-flex, actionscript-3, air

我用[SQL](http://en.wikipedia.org/wiki/SQL)编写了一个数据库生成脚本，并希望在我的[Adob​​e AIR](http://en.wikipedia.org/wiki/Adobe_Integrated_Runtime)应用程序中执行它：

```
Create Table tRole (
    roleID integer Primary Key
    ,roleName varchar(40)
);
Create Table tFile (
    fileID integer Primary Key
    ,fileName varchar(50)
    ,fileDescription varchar(500)
    ,thumbnailID integer
    ,fileFormatID integer
    ,categoryID integer
    ,isFavorite boolean
    ,dateAdded date
    ,globalAccessCount integer
    ,lastAccessTime date
    ,downloadComplete boolean
    ,isNew boolean
    ,isSpotlight boolean
    ,duration varchar(30)
);
Create Table tCategory (
    categoryID integer Primary Key
    ,categoryName varchar(50)
    ,parent_categoryID integer
);
... 
```

我使用以下方法在 Adob​​e AIR 中执行此操作：

```
public static function RunSqlFromFile(fileName:String):void {
    var file:File = File.applicationDirectory.resolvePath(fileName);
    var stream:FileStream = new FileStream();
    stream.open(file, FileMode.READ)
    var strSql:String = stream.readUTFBytes(stream.bytesAvailable);
    NonQuery(strSql);
}

public static function NonQuery(strSQL:String):void {
    var sqlConnection:SQLConnection = new SQLConnection();
    sqlConnection.open(File.applicationStorageDirectory.resolvePath(DBPATH));
    var sqlStatement:SQLStatement = new SQLStatement();
    sqlStatement.text = strSQL;
    sqlStatement.sqlConnection = sqlConnection;
    try {
        sqlStatement.execute();
    } catch (error:SQLError) {
        Alert.show(error.toString());
    }
} 
```

不会产生错误，但只会`tRole`存在。似乎它只查看第一个查询（直到分号 - 如果我删除它，查询将失败）。有没有办法在一个语句中调用多个查询？

* * *

## 回答 #1

> 赞同：20
> 
> 时间：2008-08-01T16:09:47.687

我最终使用了这个。这是一种 hack，但实际上效果很好。

唯一的事情是你必须非常小心你的分号。: D

```
var strSql:String = stream.readUTFBytes(stream.bytesAvailable);      
var i:Number = 0;
var strSqlSplit:Array = strSql.split(";");
for (i = 0; i < strSqlSplit.length; i++){
    NonQuery(strSqlSplit[i].toString());
} 
```

* * *

## 回答 #2

> 赞同：10
> 
> 时间：2008-08-13T16:09:09.843

[SQLite](http://en.wikipedia.org/wiki/SQLite) API 有一个类似的函数，`sqlite_prepare`它接受*一条*语句并为执行做准备，本质上是解析 SQL 并将其存储在内存中。这意味着即使语句执行了多次，SQL 也只需发送一次到数据库引擎。

无论如何，一条语句是一个单一的 SQL 查询，这就是规则。AIR SQL API 不允许将原始 SQL 发送到 SQLite，只能发送单个语句，原因很可能是 AIR 在`sqlite_prepare`与 SQLite 对话时使用了该函数。

* * *

## 回答 #3

> 赞同：3
> 
> 时间：2010-09-22T15:37:30.367

如何让你的分隔符更复杂一些，比如“;\n”，它不会经常出现。您只需要确保在创建文件时您有一两行回车即可。我最终将两个“\n\n”放入我的文件的创建中，效果很好。

# php - 平面文件数据库

> ID：85
> 
> 赞同：130
> 
> 时间：2008-08-01T14:19:52.510
> 
> 标签：php, sql, database, flat-file

在 PHP 中创建平面文件数据库结构的最佳实践是什么？

那里有很多更成熟的 PHP 平面文件框架，我尝试实现类似 SQL 的查询语法，在大多数情况下，这对于我的目的来说是最重要的。（那时我只会使用数据库）。

是否有任何优雅的技巧可以通过少量代码开销获得良好的性能和功能？

* * *

## 回答 #1

> 赞同：79
> 
> 时间：2008-08-01T17:45:06.513

那么，平面数据库的性质是什么。它们是大还是小。它是带有数组的简单数组吗？如果它简单地说用户配置文件是这样构建的：

```
$user = array("name" => "dubayou", 
              "age" => 20,
              "websites" => array("dubayou.com","willwharton.com","codecream.com"),
              "and_one" => "more"); 
```

并为该用户保存或更新*数据库记录。*

```
$dir = "../userdata/";  //make sure to put it bellow what the server can reach.
file_put_contents($dir.$user['name'],serialize($user)); 
```

并为用户加载*记录*

```
function &get_user($name){
    return unserialize(file_get_contents("../userdata/".$name));
} 
```

但同样，此实现将根据您需要的数据库的应用程序和性质而有所不同。

* * *

## 回答 #2

> 赞同：49
> 
> 时间：2008-08-08T23:00:54.507

您可能会考虑[SQLite](http://www.sqlite.org/)。它几乎与平面文件一样简单，但您确实获得了用于查询的 SQL 引擎。它[也适用于 PHP](http://ca3.php.net/sqlite)。

* * *

## 回答 #3

> 赞同：22
> 
> 时间：2008-09-21T18:21:07.343

在我看来，在您的意思（以及您接受的答案）的意义上使用“平面文件数据库”不一定是处理事情的最佳方式。首先，如果有人进入并编辑文件，使用`serialize()`and`unserialize()`可能会导致严重的头痛（事实上，他们可以将任意代码放入您的“数据库”中以每次运行。）

就个人而言，我会说 - 为什么不展望未来呢？有很多次我遇到了问题，因为我一直在创建自己的“专有”文件，并且项目已经爆炸到需要数据库的地步，我在想“你知道，我希望我写这个是为了一个数据库开始的”——因为重构代码需要太多的时间和精力。

从中我了解到，未来对我的应用程序进行校对，以便当它变得更大时，我不必花费数天时间进行重构是前进的方式。我该怎么做呢？

SQLite。它用作数据库，使用 SQL，并且很容易转换为 MySQL（特别是如果您像我一样使用抽象类进行数据库操作！）

事实上，尤其是使用“接受的答案”的方法，它可以大大减少你的应用程序的内存使用（你不必将所有的“记录”加载到 PHP 中）

* * *

## 回答 #4

> 赞同：12
> 
> 时间：2008-08-01T14:26:22.793

我正在考虑的一个框架是用于博客平台。由于您想要的任何可能的数据视图都将按日期排序，因此我正在考虑这种结构：

每个内容节点一个目录：

```
./content/YYYYMMDDHHMMSS/ 
```

每个节点的子目录包括

```
/tags  
/authors  
/comments 
```

以及节点目录中用于预渲染和后渲染内容等的简单文本文件。

这将允许一个简单的 PHP[`glob()`](http://us3.php.net/glob)调用（并且可能是结果数组的反转）来查询内容结构中的任何内容：

```
glob("content/*/tags/funny"); 
```

将返回路径，包括所有标记为“有趣”的文章。

* * *

## 回答 #5

> 赞同：9
> 
> 时间：2008-10-28T10:45:30.740

这是我们用于 Lilina 的代码：

```
<?php
/**
 * Handler for persistent data files
 *
 * @author Ryan McCue <cubegames@gmail.com>
 * @package Lilina
 * @version 1.0
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 */

/**
 * Handler for persistent data files
 *
 * @package Lilina
 */
class DataHandler {
    /**
     * Directory to store data.
     *
     * @since 1.0
     *
     * @var string
     */
    protected $directory;

    /**
     * Constructor, duh.
     *
     * @since 1.0
     * @uses $directory Holds the data directory, which the constructor sets.
     *
     * @param string $directory 
     */
    public function __construct($directory = null) {
        if ($directory === null)
            $directory = get_data_dir();

        if (substr($directory, -1) != '/')
            $directory .= '/';

        $this->directory = (string) $directory;
    }

    /**
     * Prepares filename and content for saving
     *
     * @since 1.0
     * @uses $directory
     * @uses put()
     *
     * @param string $filename Filename to save to
     * @param string $content Content to save to cache
     */
    public function save($filename, $content) {
        $file = $this->directory . $filename;

        if(!$this->put($file, $content)) {
            trigger_error(get_class($this) . " error: Couldn't write to $file", E_USER_WARNING);
            return false;
        }

        return true;
    }

    /**
     * Saves data to file
     *
     * @since 1.0
     * @uses $directory
     *
     * @param string $file Filename to save to
     * @param string $data Data to save into $file
     */
    protected function put($file, $data, $mode = false) {
        if(file_exists($file) && file_get_contents($file) === $data) {
            touch($file);
            return true;
        }

        if(!$fp = @fopen($file, 'wb')) {
            return false;
        }

        fwrite($fp, $data);
        fclose($fp);

        $this->chmod($file, $mode);
        return true;

    }

    /**
     * Change the file permissions
     *
     * @since 1.0
     *
     * @param string $file Absolute path to file
     * @param integer $mode Octal mode
     */
    protected function chmod($file, $mode = false){
        if(!$mode)
            $mode = 0644;
        return @chmod($file, $mode);
    }

    /**
     * Returns the content of the cached file if it is still valid
     *
     * @since 1.0
     * @uses $directory
     * @uses check() Check if cache file is still valid
     *
     * @param string $id Unique ID for content type, used to distinguish between different caches
     * @return null|string Content of the cached file if valid, otherwise null
     */
    public function load($filename) {
        return $this->get($this->directory . $filename);
    }

    /**
     * Returns the content of the file
     *
     * @since 1.0
     * @uses $directory
     * @uses check() Check if file is valid
     *
     * @param string $id Filename to load data from
     * @return bool|string Content of the file if valid, otherwise null
     */
    protected function get($filename) {
        if(!$this->check($filename))
            return null;

        return file_get_contents($filename);
    }

    /**
     * Check a file for validity
     *
     * Basically just a fancy alias for file_exists(), made primarily to be
     * overriden.
     *
     * @since 1.0
     * @uses $directory
     *
     * @param string $id Unique ID for content type, used to distinguish between different caches
     * @return bool False if the cache doesn't exist or is invalid, otherwise true
     */
    protected function check($filename){
        return file_exists($filename);
    }

    /**
     * Delete a file
     *
     * @param string $filename Unique ID
     */
    public function delete($filename) {
        return unlink($this->directory . $filename);
    }
}

?> 
```

它将每个条目存储为一个单独的文件，我们发现它的使用效率足够高（不会加载不需要的数据并且保存起来更快）。

* * *

## 回答 #6

> 赞同：9
> 
> 时间：2012-12-02T15:49:35.380

恕我直言，如果你想避免自制一些东西，你有两个......呃，三个选项：

1.  **SQLite**

如果您熟悉 PDO，则可以安装支持 SQLite 的 PDO 驱动程序。从未使用过它，但我已经在 MySQL 中使用过 PDO。我将在当前项目中试一试。

2.  **XML**

对于相对少量的数据，多次执行此操作。 [XMLReader](http://us1.php.net/manual/en/intro.xmlreader.php)是一个轻量级的、可读取的、游标样式的类。 [SimpleXML](http://us1.php.net/manual/en/intro.simplexml.php)使将 XML 文档读入对象变得简单，您可以像访问任何其他类实例一样访问该对象。

3.  **JSON**（更新）

少量数据的好选择，只需读/写文件和 json_decode/json_encode。不确定 PHP 是否提供了一种结构来导航 JSON 树而不将其全部加载到内存中。

* * *

## 回答 #7

> 赞同：8
> 
> 时间：2008-09-18T06:40:00.323

如果您打算使用平面文件来保存数据，请使用 XML 来构造数据。PHP 有一个[内置的 XML 解析器](http://uk.php.net/xml)。

* * *

## 回答 #8

> 赞同：7
> 
> 时间：2008-09-18T07:51:30.887

如果你想要一个人类可读的结果，你也可以使用这种类型的文件：

```
ofaurax|27|male|something|
another|24|unknown||
... 
```

这样，您只有一个文件，您可以轻松调试（并手动修复），您可以稍后添加字段（在每一行的末尾），并且 PHP 代码很简单（对于每一行，根据 | 拆分）。

但是，缺点是您应该解析整个文件以搜索某些内容（如果您有数百万个条目，那就不好了），并且您应该处理数据中的分隔符（例如，如果昵称是 WaR|ordz）。

* * *

## 回答 #9

> 赞同：7
> 
> 时间：2012-12-19T20:48:20.903

我编写了两个简单的函数，旨在将数据存储在文件中。你可以自己判断它在这种情况下是否有用。关键是将php变量（如果它是数组、字符串或对象）保存到文件中。

```
<?php
function varname(&$var) {
    $oldvalue=$var;
    $var='AAAAB3NzaC1yc2EAAAABIwAAAQEAqytmUAQKMOj24lAjqKJC2Gyqhbhb+DmB9eDDb8+QcFI+QOySUpYDn884rgKB6EAtoFyOZVMA6HlNj0VxMKAGE+sLTJ40rLTcieGRCeHJ/TI37e66OrjxgB+7tngKdvoG5EF9hnoGc4eTMpVUDdpAK3ykqR1FIclgk0whV7cEn/6K4697zgwwb5R2yva/zuTX+xKRqcZvyaF3Ur0Q8T+gvrAX8ktmpE18MjnA5JuGuZFZGFzQbvzCVdN52nu8i003GEFmzp0Ny57pWClKkAy3Q5P5AR2BCUwk8V0iEX3iu7J+b9pv4LRZBQkDujaAtSiAaeG2cjfzL9xIgWPf+J05IQ==';
    foreach($GLOBALS as $var_name => $value) {
        if ($value === 'AAAAB3NzaC1yc2EAAAABIwAAAQEAqytmUAQKMOj24lAjqKJC2Gyqhbhb+DmB9eDDb8+QcFI+QOySUpYDn884rgKB6EAtoFyOZVMA6HlNj0VxMKAGE+sLTJ40rLTcieGRCeHJ/TI37e66OrjxgB+7tngKdvoG5EF9hnoGc4eTMpVUDdpAK3ykqR1FIclgk0whV7cEn/6K4697zgwwb5R2yva/zuTX+xKRqcZvyaF3Ur0Q8T+gvrAX8ktmpE18MjnA5JuGuZFZGFzQbvzCVdN52nu8i003GEFmzp0Ny57pWClKkAy3Q5P5AR2BCUwk8V0iEX3iu7J+b9pv4LRZBQkDujaAtSiAaeG2cjfzL9xIgWPf+J05IQ==')
        {
            $var=$oldvalue;
            return $var_name;
        }
    }
    $var=$oldvalue;
    return false;
}

function putphp(&$var, $file=false)
    {
    $varname=varname($var);
    if(!$file)
    {
        $file=$varname.'.php';
    }
    $pathinfo=pathinfo($file);
    if(file_exists($file))
    {
        if(is_dir($file))
        {
            $file=$pathinfo['dirname'].'/'.$pathinfo['basename'].'/'.$varname.'.php';
        }
    }
    file_put_contents($file,'<?php'."\n\$".$varname.'='.var_export($var, true).";\n");
    return true;
} 
```

* * *

## 回答 #10

> 赞同：7
> 
> 时间：2013-05-02T13:57:13.607

这是一个鼓舞人心的实用解决方案：
[https](https://github.com/mhgolkar/FlatFire)
://github.com/mhgolkar/FlatFire 它使用多种策略来处理数据...
[复制自自述文件]

### 免费或结构化或混合

```
- STRUCTURED
Regular (table, row, column) format.
[DATABASE]
/   \
TX  TableY
    \_____________________________
    |ROW_0 Colum_0 Colum_1 Colum_2|
    |ROW_1 Colum_0 Colum_1 Colum_2|
    |_____________________________|
- FREE
More creative data storing. You can store data in any structure you want for each (free) element, its similar to storing an array with a unique "Id".
[DATABASE]
/   \
EX  ElementY (ID)
    \________________
    |Field_0 Value_0 |
    |Field_1 Value_1 |
    |Field_2 Value_2 |
    |________________|
recall [ID]: get_free("ElementY") --> array([Field_0]=>Value_0,[Field_1]=>Value_1...
- MIXD (Mixed)
Mixed databases can store both free elements and tables.If you add a table to a free db or a free element to a structured db, flat fire will automatically convert FREE or SRCT to MIXD database.
[DATABASE]
/   \
EX  TY 
```

* * *

## 回答 #11

> 赞同：5
> 
> 时间：2013-01-04T00:14:41.070

只是指出这种系统的平面文件数据库的潜在问题：

```
data|some text|more data

row 2 data|bla hbalh|more data 
```

...ETC

问题是单元格数据包含“|” 或 "\n" 则数据将丢失。有时，通过大多数人不会使用的字母组合来分割会更容易。

例如：

列拆分器：`#$% (Shift+345)`

行分离器：`^&* (Shift+678)`

文本文件：`test data#$%blah blah#$%^&*new row#$%new row data 2`

然后使用：`explode("#$%", $data); use foreach, the explode again to separate columns`

或任何类似的东西。另外，我可能会补充一点，平面文件数据库适用于数据量小（即少于 20 行）的系统，但对于大型数据库来说会占用大量内存。

# linux - gettimeofday() 是否保证为微秒级分辨率？

> ID：88
> 
> 赞同：104
> 
> 时间：2008-08-01T14:36:18.640
> 
> 标签：linux, winapi, visual-c++, unix, timer

我正在将最初为 Win32 API 编写的游戏移植到 Linux（嗯，将 Win32 端口的 OS X 端口移植到 Linux）。

`QueryPerformanceCounter`自进程启动以来， 我通过提供 uSeconds 来实现：

```
BOOL QueryPerformanceCounter(LARGE_INTEGER* performanceCount)
{
    gettimeofday(&currentTimeVal, NULL);
    performanceCount->QuadPart = (currentTimeVal.tv_sec - startTimeVal.tv_sec);
    performanceCount->QuadPart *= (1000 * 1000);
    performanceCount->QuadPart += (currentTimeVal.tv_usec - startTimeVal.tv_usec);

    return true;
} 
```

再加上`QueryPerformanceFrequency()`给出一个常数 1000000 作为频率，**在我的机器上**运行良好，给了我一个 64 位变量，它包含`uSeconds`自程序启动以来的内容。

那么*这款便携吗？*如果内核以某种方式或类似方式编译，我不想发现它的工作方式不同。但是，我认为它不能移植到 Linux 以外的其他东西上。

* * *

## 回答 #1

> 赞同：61
> 
> 时间：2008-08-01T14:53:47.497

也许。但是你有更大的问题。`gettimeofday()`如果系统上存在更改计时器的进程（即 ntpd），可能会导致计时错误。不过，在“普通”Linux 上，我相信 10us 的分辨率`gettimeofday()`是 10us。因此，它可以根据系统上运行的进程向前和向后跳跃和时间。这有效地回答了您的问题。

您应该查看`clock_gettime(CLOCK_MONOTONIC)`时间间隔。由于多核系统和外部时钟设置等原因，它遇到的问题较少。

另外，查看`clock_getres()`功能。

* * *

## 回答 #2

> 赞同：43
> 
> 时间：2008-08-02T08:08:22.230

**适用于英特尔处理器的高分辨率、低开销时序**

如果您使用的是 Intel 硬件，以下是读取 CPU 实时指令计数器的方法。它会告诉您自处理器启动以来执行的 CPU 周期数。这可能是您可以获得的用于性能测量的最细粒度的计数器。

请注意，这是 CPU 周期数。在 linux 上，您可以从 /proc/cpuinfo 获取 CPU 速度，然后除以获取秒数。将其转换为双精度非常方便。

当我在我的盒子上运行它时，我得到

```
11867927879484732
11867927879692217
it took this long to call printf: 207485 
```

这是提供大量详细信息的[英特尔开发人员指南。](http://cs.smu.ca/~jamuir/rdtscpm1.pdf)

```
#include <stdio.h>
#include <stdint.h>

inline uint64_t rdtsc() {
    uint32_t lo, hi;
    __asm__ __volatile__ (
      "xorl %%eax, %%eax\n"
      "cpuid\n"
      "rdtsc\n"
      : "=a" (lo), "=d" (hi)
      :
      : "%ebx", "%ecx");
    return (uint64_t)hi << 32 | lo;
}

main()
{
    unsigned long long x;
    unsigned long long y;
    x = rdtsc();
    printf("%lld\n",x);
    y = rdtsc();
    printf("%lld\n",y);
    printf("it took this long to call printf: %lld\n",y-x);
} 
```

* * *

## 回答 #3

> 赞同：18
> 
> 时间：2008-08-04T00:51:52.843

@伯纳德：

> 我不得不承认，你的大部分例子都是直接让我头疼的。不过，它确实可以编译，并且似乎可以工作。这对 SMP 系统或 SpeedStep 是否安全？

这是一个很好的问题......我认为代码没问题。从实际的角度来看，我们每天都在我的公司中使用它，并且我们在相当广泛的盒子上运行，从 2 到 8 个内核。当然，YMMV 等，但它似乎是一种可靠且开销低（因为它不会将上下文切换到系统空间）的计时方法。

一般来说，它的工作原理是：

*   将代码块声明为汇编程序（并且是易失的，因此优化器将不理会它）。
*   执行 CPUID 指令。除了获取一些 CPU 信息（我们不做任何事情）之外，它还会同步 CPU 的执行缓冲区，以便时序不受乱序执行的影响。
*   执行 rdtsc（读取时间戳）执行。这将获取自处理器重置以来执行的机器周期数。这是一个 64 位的值，因此以当前的 CPU 速度，它将每 194 年左右回绕一次。有趣的是，在最初的 Pentium 参考资料中，他们注意到它大约每 5800 年左右循环一次。
*   最后几行将寄存器中的值存储到变量 hi 和 lo 中，并将其放入 64 位返回值中。

具体说明：

*   乱序执行会导致不正确的结果，因此我们执行“cpuid”指令，它除了为您提供有关 cpu 的一些信息外，还同步任何乱序指令的执行。

*   大多数操作系统在启动时会同步 CPU 上的计数器，因此答案最好在几纳秒内。

*   休眠评论可能是正确的，但实际上您可能不关心跨越休眠边界的时间。

*   关于 speedstep：较新的 Intel CPU 会补偿速度变化并返回调整后的计数。我对我们网络上的一些盒子进行了快速扫描，发现只有一个盒子没有它：运行一些旧数据库服务器的 Pentium 3。（这些是 linux 盒子，所以我检查了：grep constant_tsc /proc/cpuinfo）

*   我不确定 AMD CPU，我们主要是一家英特尔商店，尽管我知道我们的一些低级系统专家进行了 AMD 评估。

希望这能满足您的好奇心，这是一个有趣且（恕我直言）未被充分研究的编程领域。你知道 Jeff 和 Joel 何时讨论程序员是否应该了解 C 语言吗？我对他们大喊：“嘿，忘记高级 C 的东西......如果你想知道计算机在做什么，你应该学习汇编程序！”

* * *

## 回答 #4

> 赞同：14
> 
> 时间：2008-08-18T15:51:01.877

你可能对[Linux 常见问题感兴趣`clock_gettime(CLOCK_REALTIME)`](http://juliusdavies.ca/posix_clocks/clock_realtime_linux_faq.html)

* * *

## 回答 #5

> 赞同：11
> 
> 时间：2008-08-04T14:44:56.950

Wine 实际上是使用 gettimeofday() 来实现 QueryPerformanceCounter() 并且众所周知，它可以让许多 Windows 游戏在 Linux 和 Mac 上运行。

启动[http://source.winehq.org/source/dlls/kernel32/cpu.c#L312](http://source.winehq.org/source/dlls/kernel32/cpu.c#L312)

导致[http://source.winehq.org/source/dlls/ntdll/time.c#L448](http://source.winehq.org/source/dlls/ntdll/time.c#L448)

* * *

## 回答 #6

> 赞同：9
> 
> 时间：2008-08-01T14:55:08.477

> gettimeofday() 的实际分辨率取决于硬件架构。英特尔处理器和 SPARC 机器提供了以微秒为单位的高分辨率计时器。其他硬件架构回退到系统的计时器，通常设置为 100 Hz。在这种情况下，时间分辨率将不太准确。

我从[高分辨率时间测量和计时器，第一部分获得了这个答案](http://web.archive.org/web/20160711223333/http://www.informit.com/guides/content.aspx?g=cplusplus&seqNum=272)

* * *

## 回答 #7

> 赞同：9
> 
> 时间：2008-08-02T17:57:06.033

> 所以它明确表示微秒，但表示系统时钟的分辨率未指定。我想在这种情况下的分辨率意味着它会增加的最小量是多少？

数据结构被定义为以微秒为测量单位，但这并不意味着时钟或操作系统实际上能够精确测量。

就像其他人建议的那样，`gettimeofday()`这是不好的，因为设置时间会导致时钟偏差并影响您的计算。 `clock_gettime(CLOCK_MONOTONIC)`是您想要的，并且`clock_getres()`会告诉您时钟的精度。

* * *

## 回答 #8

> 赞同：6
> 
> 时间：2012-06-26T15:57:14.370

[这个答案](https://stackoverflow.com/a/98/)提到了时钟调整的问题。保证刻度单位的问题和调整时间的问题都在 C++11 中与`<chrono>`库一起解决。

时钟`std::chrono::steady_clock`保证不会被调整，而且它会以相对于实时的恒定速率前进，所以像 SpeedStep 这样的技术一定不会影响它。

您可以通过转换为其中一种特化来获得类型安全单位`std::chrono::duration`，例如`std::chrono::microseconds`. 对于这种类型，刻度值使用的单位没有歧义。但是，请记住，时钟不一定具有此分辨率。您可以将持续时间转换为阿秒，而实际上没有准确的时钟。

* * *

## 回答 #9

> 赞同：4
> 
> 时间：2008-08-01T14:46:53.097

根据我的经验以及我在互联网上阅读的内容，答案是“不”，不能保证。这取决于 CPU 速度、操作系统、Linux 的风格等。

* * *

## 回答 #10

> 赞同：3
> 
> 时间：2008-08-18T15:40:14.173

在 SMP 系统中读取 RDTSC 是不可靠的，因为每个 CPU 都维护自己的计数器，并且每个计数器不能保证与另一个 CPU 同步。

我可能会建议尝试**`clock_gettime(CLOCK_REALTIME)`**。posix 手册表明这应该在所有兼容的系统上实现。它可以提供纳秒计数，但您可能需要检查**`clock_getres(CLOCK_REALTIME)`**系统以查看实际分辨率。

# svn - 你如何分支并与 TortoiseSVN 合并？

> ID：90
> 
> 赞同：164
> 
> 时间：2008-08-01T14:41:24.277
> 
> 标签：svn, tortoisesvn, branch, branching-and-merging

如何使用 TortoiseSVN 客户端与 Apache Subversion 进行[分支和合并？](http://svnbook.red-bean.com/en/1.8/svn.branchmerge.html)

* * *

## 回答 #1

> 赞同：23
> 
> 时间：2009-09-23T15:40:46.943

我的简单点击指令（**特定于 TortoiseSVN**）在 Stack Overflow 问题*[中使用 TortoiseSVN 进行分支和合并的最简单方法是什么？](https://stackoverflow.com/questions/1461922)*.

* * *

## 回答 #2

> 赞同：15
> 
> 时间：2008-08-01T14:45:37.403

[使用 Subversion 进行版本控制](http://svnbook.red-bean.com/)

一般而言，这是一个非常好的源代码控制资源。不过，并不是真正的 TortoiseSVN 特定的。

* * *

## 回答 #3

> 赞同：3
> 
> 时间：2008-10-14T18:41:45.987

您还可以尝试*[独立程序员的版本控制 - 第 1 部分](http://www.codeproject.com/KB/work/XTortoiseSVN.aspx)*，或者可能*[与 TortoiseSVN 合并](http://www.kenegozi.com/Blog/2007/07/30/merging-with-tortoisesvn.aspx)*。

# .net - “内存泄漏”的剖析

> ID：104
> 
> 赞同：178
> 
> 时间：2008-08-01T15:12:34.837
> 
> 标签：.net, performance, memory-leaks, com-interop

从 .NET 的角度来看：

*   什么是[内存泄漏](https://en.wikipedia.org/wiki/Memory_leak)？
*   如何确定您的应用程序是否泄漏？有什么影响？
*   如何防止内存泄漏？
*   如果您的应用程序有内存泄漏，它会在进程退出或被杀死时消失吗？或者，即使在进程完成后，您的应用程序中的内存泄漏是否会影响系统上的其他进程？
*   那么通过 COM Interop 和/或 P/Invoke 访问的非托管代码呢？

* * *

## 回答 #1

> 赞同：110
> 
> 时间：2008-08-01T15:28:12.543

我见过的最好的解释是免费的[Foundations of Programming 电子书的](http://codebetter.com/karlseguin/2008/06/25/foundations-of-programming-ebook/)第 7 章。

基本上，在**.NET**中，当引用的对象被植根时会发生内存泄漏，因此无法进行垃圾回收。当您保留超出预期范围的引用时，会意外发生这种情况。

当您开始收到 OutOfMemoryExceptions 或您的内存使用量超出您的预期（**PerfMon**有很好的内存计数器）时，您就会知道您有泄漏。

了解**.NET**的内存模型是避免它的最佳方式。具体来说，理解垃圾收集器是如何工作的以及引用是如何工作的——我再次请你参考这本电子书的第 7 章。此外，请注意常见的陷阱，可能是最常见的事件。如果对象**A**注册到对象**B**上的事件，则对象**A**将一直存在，直到对象**B**消失，因为**B**持有对**A**的引用。解决方案是在您完成后取消注册您的活动。

当然，一个好的内存配置文件可以让您查看对象图并探索对象的嵌套/引用，以查看引用来自何处以及负责哪个根对象（[红门蚂蚁配置文件](http://www.red-gate.com/products/ants_memory_profiler/index.htm)，JetBrains dotMemory，[memprofiler](http://memprofiler.com/)真的很好选择，或者您可以使用纯文本**WinDbg**和**SOS**，但我强烈推荐商业/视觉产品，除非您是真正的大师）。

我相信非托管代码会受到其典型的内存泄漏的影响，除了共享引用由垃圾收集器管理。最后一点我可能是错的。

* * *

## 回答 #2

> 赞同：35
> 
> 时间：2008-08-01T17:52:46.293

严格来说，内存泄漏正在消耗程序“不再使用”的内存。

“不再使用”有不止一个含义，它可能意味着“不再引用它”，即完全不可恢复，或者它可能意味着已引用、可恢复、未使用，但程序仍然保留引用。只有后者适用于 .Net 的**完美管理对象**。但是，并非所有类都是完美的，并且在某些时候，底层的非托管实现可能会永久泄漏该进程的资源。

在所有情况下，应用程序消耗的内存都比严格需要的多。副作用，取决于泄漏的数量，可能从没有到过度收集导致的减速，到一系列内存异常，最后是致命错误，然后是强制进程终止。

**当监控显示在每个垃圾回收周期后**分配给您的进程的内存越来越多时，您就知道应用程序存在内存问题。在这种情况下，您要么在内存中保留了太多，要么某些底层的非托管实现正在泄漏。

对于大多数泄漏，在进程终止时会恢复资源，但是在某些特定情况下并不总是会恢复某些资源，GDI 游标句柄因此而臭名昭著。当然，如果您有进程间通信机制，则在另一个进程中分配的内存不会被释放，直到该进程释放它或终止。

* * *

## 回答 #3

> 赞同：32
> 
> 时间：2008-08-15T16:11:41.103

我认为“什么是内存泄漏”和“有什么影响”问题已经得到了很好的回答，但我想在其他问题上添加更多内容......

**如何了解您的应用程序是否泄漏**

一种有趣的方法是打开*perfmon并为**所有堆中的 # 个字节*和*# Gen 2 集合*添加跟踪，在每种情况下都只查看您的进程。如果执行某个特定功能导致总字节数增加，并且在下一次 Gen 2 收集后该内存仍然分配，您可能会说该功能泄漏内存。

**如何预防**

其他好的意见已经给出。我只想补充一点，也许.NET 内存泄漏*最常被忽视*的原因是将事件处理程序添加到对象而不删除它们。附加到对象的事件处理程序是对该对象的一种引用形式，因此即使在所有其他引用都消失后也会阻止收集。永远记得分离事件处理程序（使用`-=`C# 中的语法）。

**当进程退出时泄漏会消失吗？COM互操作呢？**

当您的进程退出时，映射到其地址空间的所有内存都将由操作系统回收，包括由 DLL 提供的任何 COM 对象。比较少见的是，COM 对象可以从单独的进程中提供服务。在这种情况下，当您的进程退出时，您可能仍需对您使用的任何 COM 服务器进程中分配的内存负责。

* * *

## 回答 #4

> 赞同：18
> 
> 时间：2008-08-01T17:57:14.117

我将内存泄漏定义为一个对象在完成后没有释放所有分配的内存。我发现如果您在框架和第三方组件中使用 Windows API 和 COM（即其中存在错误或未正确管理的非托管代码），则可能会在您的应用程序中发生这种情况。我还发现在使用某些物品（如钢笔）后不整理可能会导致问题。

我个人遇到过内存不足异常，这些异常可能是由 dot net 应用程序中的内存泄漏引起的，但不限于此。（OOM 也可以来自 pinning 参见[Pinning Artical](https://blogs.msdn.com/yunjin/archive/2004/01/27/63642.aspx)）。如果您没有收到 OOM 错误或需要确认是否是内存泄漏导致的，那么唯一的方法是分析您的应用程序。

我还将尝试确保以下内容：

a) 实现 Idisposable 的所有内容都使用 finally 块或 using 语句进行处理，这些语句包括画笔、钢笔等（有些人主张将所有内容设置为空）

b）使用 finally 或 using 语句再次关闭任何具有 close 方法的东西（尽管我发现 using 并不总是关闭，这取决于您是否在 using 语句之外声明了对象）

c) 如果您使用的是非托管代码/Windows API，那么这些 API 会在之后得到正确处理。（有些有清理方法来释放资源）

希望这可以帮助。

* * *

## 回答 #5

> 赞同：18
> 
> 时间：2008-08-14T23:16:39.803

如果您需要诊断 .NET 中的内存泄漏，请查看以下链接：

[http://msdn.microsoft.com/en-us/magazine/cc163833.aspx](https://web.archive.org/web/20141203155344/http://msdn.microsoft.com/en-us/magazine/cc163833.aspx)

[http://msdn.microsoft.com/en-us/magazine/cc164138.aspx](https://web.archive.org/web/20150102222036/http://msdn.microsoft.com/en-us/magazine/cc164138.aspx)

这些文章描述了如何创建进程的内存转储以及如何分析它，以便您可以首先确定您的泄漏是非托管还是托管，如果它是托管的，如何确定它的来源。

微软还有一个更新的工具来帮助生成故障转储，以取代 ADPlus，称为 DebugDiag。

[http://www.microsoft.com/downloads/details.aspx?FamilyID=28bd5941-c458-46f1-b24d-f60151d875a3&displaylang=en](http://www.microsoft.com/downloads/details.aspx?FamilyID=28bd5941-c458-46f1-b24d-f60151d875a3&displaylang=en)

* * *

## 回答 #6

> 赞同：15
> 
> 时间：2008-08-16T19:54:30.497

使用 Microsoft [http://www.microsoft.com/downloads/details.aspx?familyid=86ce6052-d7f4-4aeb-9b7a-94635beebdda&displaylang=en](http://www.microsoft.com/downloads/details.aspx?familyid=86ce6052-d7f4-4aeb-9b7a-94635beebdda&displaylang=en)的 CLR Profiler是确定哪些对象持有内存、执行流程如何的好方法到这些对象的创建，以及监视哪些对象在堆上的位置（碎片，LOH等）。

* * *

## 回答 #7

> 赞同：14
> 
> 时间：2008-08-27T14:12:23.633

[Jeff Richters CLR via C#](https://www.microsoftpressstore.com/store/clr-via-c-sharp-9780735667457) book, (Ch. 20)中对垃圾收集器如何工作的最佳解释。阅读本文为理解对象如何持续存在提供了很好的基础。

意外生根对象的最常见原因之一是在类之外连接事件。如果您连接外部事件

例如

```
SomeExternalClass.Changed += new EventHandler(HandleIt); 
```

并且在你处理时忘记解开它，那么 SomeExternalClass 对你的类有一个引用。

如上所述，[SciTech 内存分析器](http://memprofiler.com)非常擅长向您显示您怀疑正在泄漏的对象的根源。

但是还有一种非常快速的方法来检查特定类型，只需使用 WnDBG（您甚至可以在附加的 VS.NET 即时窗口中使用它）：

```
.loadby sos mscorwks
!dumpheap -stat -type <TypeName> 
```

现在做一些你认为会处理该类型对象的事情（例如关闭一个窗口）。`System.GC.Collect()`在某个地方有一个可以运行几次的调试按钮很方便。

然后`!dumpheap -stat -type <TypeName>`再次运行。如果这个数字没有下降，或者没有像你预期的那样下降，那么你就有了进一步调查的基础。[（我从Ingo Rammer](http://www.thinktecture.com/staff/ingo)举办的研讨会上得到了这个提示）。

* * *

## 回答 #8

> 赞同：13
> 
> 时间：2008-08-01T15:19:25.900

我猜在托管环境中，泄漏将是您保留对大量内存的不必要引用。

* * *

## 回答 #9

> 赞同：11
> 
> 时间：2008-09-01T12:19:13.210

为什么人们认为 .NET 中的内存泄漏与任何其他泄漏不同？

内存泄漏是当您附加到资源并且不放开它时。您可以在托管和非托管编码中执行此操作。

关于 .NET 和其他编程工具，有一些关于垃圾收集的想法，以及其他将导致应用程序泄漏的情况最小化的方法。但是防止内存泄漏的最佳方法是您需要了解您的底层内存模型，以及在您使用的平台上事情是如何工作的。

相信 GC 和其他魔法会清理你的烂摊子是内存泄漏的捷径，以后很难找到。

当编码不受管理时，您通常确保清理，您知道您掌握的资源将是您清理的责任，而不是看门人的。

另一方面，在 .NET 中，很多人认为 GC 会清理所有内容。好吧，它对你有一些帮助，但你需要确保它确实如此。.NET 确实封装了很多东西，因此您并不总是知道您是在处理托管资源还是非托管资源，您需要确定您在处理什么。处理字体、GDI 资源、活动目录、数据库等通常是您需要注意的事情。

> 在管理方面，我会说一旦进程被杀死/删除，它就会消失。

我看到很多人都有这种情况，我真的希望这会结束。你不能要求用户终止你的应用程序来清理你的烂摊子！看一下浏览器，可以是 IE、FF 等，然后打开，比如 Google Reader，让它停留几天，看看会发生什么。

如果您然后在浏览器中打开另一个选项卡，浏览某个站点，然后关闭托管另一个导致浏览器泄漏的页面的选项卡，您认为浏览器会释放内存吗？IE 则不然。如果我使用 Google Reader，在我的计算机上，IE 很容易在短时间内（大约 3-4 天）吃掉 1 GiB 的内存。有些新闻页面更糟糕。

* * *

## 回答 #10

> 赞同：9
> 
> 时间：2008-08-05T22:47:49.440

> 我猜在托管环境中，泄漏将是您保留对大量内存的不必要引用。

绝对地。此外，在适当的时候不对一次性对象使用 .Dispose() 方法可能会导致内存泄漏。最简单的方法是使用 using 块，因为它最后会自动执行 .Dispose() ：

```
StreamReader sr;
using(sr = new StreamReader("somefile.txt"))
{
    //do some stuff
} 
```

如果您创建一个使用非托管对象的类，如果您没有正确实现 IDisposable，您可能会导致您的类的用户出现内存泄漏。

* * *

## 回答 #11

> 赞同：8
> 
> 时间：2008-08-04T14:09:47.117

所有内存泄漏都由程序终止解决。

泄漏足够的内存，操作系统可能会决定代表您解决问题。

* * *

## 回答 #12

> 赞同：7
> 
> 时间：2008-08-01T15:23:33.817

我同意 Bernard 的观点，即在 .net 中内存泄漏是什么。

您可以分析您的应用程序以查看其内存使用情况，并确定它是否在不应该管理大量内存时说它有泄漏。

在管理方面，我会说一旦进程被杀死/删除，它就会消失。

非托管代码是它自己的野兽，如果其中存在泄漏，它将遵循标准内存。泄漏定义。

* * *

## 回答 #13

> 赞同：6
> 
> 时间：2008-08-07T13:17:27.547

还要记住，.NET 有两个堆，一个是大对象堆。我相信大约 85k 或更大的对象被放在这个堆上。此堆与常规堆具有不同的生命周期规则。

如果您正在创建大型内存结构（字典或列表），那么谨慎地查找确切的规则是什么。

至于在进程终止时回收内存，除非您正在运行 Win98 或其等效版本，否则所有内容都会在终止时释放回操作系统。唯一的例外是跨进程打开的东西并且另一个进程仍然打开资源。

COM 对象可能很棘手。如果您始终使用该`IDispose`模式，您将是安全的。但是我遇到了一些实现`IDispose`. `Marshal.ReleaseCOMObject`这里的关键是当你完成它时打电话。COM 对象仍然使用标准的 COM 引用计数。

* * *

## 回答 #14

> 赞同：5
> 
> 时间：2008-08-20T18:39:25.953

在 .Net 中查找内存泄漏时，我发现[.Net Memory Profiler](http://memprofiler.com/)非常有用。它不像 Microsoft CLR Profiler 那样免费，但在我看来它更快、更贴切。一种

* * *

## 回答 #15

> 赞同：1
> 
> 时间：2014-08-27T15:22:06.127

一种定义是：**无法释放不可达内存，在分配进程执行过程中不能再分配给新进程。它主要可以通过使用 GC 技术来治愈或通过自动化工具检测。**

欲了解更多信息，请访问[http://all-about-java-and-weblogic-server.blogspot.in/2014/01/what-is-memory-leak-in-java.html](http://all-about-java-and-weblogic-server.blogspot.in/2014/01/what-is-memory-leak-in-java.html)。

# windows - 适用于 Windows Vista（64 位）的最佳 Subversion 客户端

> ID：108
> 
> 赞同：52
> 
> 时间：2008-08-01T15:22:29.467
> 
> 标签：windows, svn, 64-bit

我在 Windows 环境中使用[TortoiseSVN](https://web.archive.org/web/20200229173754/http://tortoisesvn.tigris.org/)已经有一段时间了。它似乎功能非常完整，并且很好地集成到了 Windows shell 中，更重要的是，向几乎没有或没有源代码控制经验的同事教授它是相当轻松的。 **但是**，自从我们迁移到 Windows Vista 64 位后，Tortoise 出现了很多 bug，似乎导致了很多 explorer.exe 异常和崩溃。旧版本的软件和最新版本（1.5.1 build 13563）都发生过这种情况。

我很好奇是否有人对将在 Windows（特别是 Vista 64 位）上运行的其他 Subversion 客户端提出建议。这里的开发人员使用各种文本编辑器，因此使用 Visual Studio 或 Dreamweaver for SVN 并不理想。

我听说过有关[Cornerstone](http://www.zennaware.com/cornerstone/)的好消息，如果存在的话，我会喜欢 Windows 上类似的东西。

* * *

我将 Vista/explorer 问题与 Tortoise 相关联，因为它们通常发生在我使用 Tortoise 中的功能时。有时调出“合并”屏幕会导致 GUI 开始表现得很奇怪，最终挂起或崩溃。

我没有看到 1.5.2——我现在正在安装，也许这会解决我的一些问题。

* * *

## 回答 #1

> 赞同：39
> 
> 时间：2008-08-01T15:27:23.093

我使用 TortoiseSVN 的 64 位版本已经很久了，在 Windows 64 位或 Vista 64 位上我从来没有遇到过问题。我目前不知道在 Vista 上工作的任何其他类似的 SVN 客户端。问题是否可能出在 TortoiseSVN 的配置甚至 Vista 的安装中？问题发生在 Vista native 还是 SP 1 上？

* * *

## 回答 #2

> 赞同：11
> 
> 时间：2008-08-01T15:32:42.473

TortoiseSVN 结合 VisualSVN for Visual Studio。

* * *

## 回答 #3

> 赞同：9
> 
> 时间：2008-08-01T15:32:11.337

我将支持迪亚戈的回答。我在 Vista x64 上大量使用 TortoiseSVN。

我确实直接从旧版本升级到 1.5.2，但从未使用过 1.5.1。你试过1.5.2吗？

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2008-08-01T17:47:54.727

我曾经有很多由 Tortoise 引起的 Explorer 崩溃（在 32 位上）。自从我在 TSVN 的“图标覆盖”配置中使用包含/排除路径设置后，它们似乎已经消失了。将图标覆盖限制在我保存源代码的特定目录中，这使得它更加稳定。

* * *

## 回答 #5

> 赞同：6
> 
> 时间：2008-08-01T15:34:43.873

我也在 Vista 中遇到资源管理器崩溃（虽然我不在 64 位版本中）。我正在使用 Vista Super Saijen（或任何他们称之为最昂贵的版本）。我对 Tortoise 没有任何错误。

但是，我的资源管理器确实每隔一天就会崩溃一次（如果它有一个“休息”的日子，有时一天会发生多次）。我不肯定它是由 TortoiseSVN 引起的。据我所知，资源管理器在 Vista 中崩溃了很多......

您是否尝试过卸载 Tortoise 并使用 Windows 一两天，看看它是否仍然崩溃？您是否每天至少重新启动一次计算机（似乎我两次重新启动之间的时间越长，崩溃越严重）？

* * *

## 回答 #6

> 赞同：6
> 
> 时间：2008-08-02T11:30:47.920

Tortoise SVN 与 Ankhsvn for VS 2005

![](../Images/cc1be0c361053ba33a55f7e9ea663fb7.png)

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2008-10-21T14:36:13.203

运行 32 位和 64 位客户端....否则从 32 位进程（包括加载和保存对话框）启动的资源管理器实例将没有 Tortoise 菜单。

在回答时也升级到最新的 1.5.3。

* * *

## 回答 #8

> 赞同：5
> 
> 时间：2009-06-06T23:59:35.177

我安装了 Tortoise 但很少在[SmartSVN](https://www.smartsvn.com/)上使用它。它是一个基于 Java 的应用程序，因此看起来不像原生 Windows 应用程序，但性能非常好。有一个功能减少的免费版本，但付费版本不是很贵（79 美元），而且物有所值。我发现最大的好处是类似于 Tortoise 中的“检查修改”功能的实时视图，每次 UI 获得焦点时都会自动刷新。您可以轻松地查看您在整个源代码树中所做的更改。它还具有 shell 集成，虽然我无法评论该功能，因为我还没有安装它，因为我已经安装了 Tortoise。

# c# - 在 C#/VB.NET 中解码 T-SQL CAST

> ID：109
> 
> 赞同：68
> 
> 时间：2008-08-01T15:23:05.190
> 
> 标签：c#, sql, vb.net, ascii, hex

最近，我们的网站被[Asprox 僵尸网络](https://en.wikipedia.org/wiki/Asprox_botnet) [SQL 注入](http://en.wikipedia.org/wiki/SQL_injection)攻击的死灰复燃。无需详细说明，攻击尝试通过将[T-SQL](http://en.wikipedia.org/wiki/Transact-SQL)命令编码为 ASCII 编码的 BINARY 字符串来执行 SQL 代码。它看起来像这样：

```
DECLARE%20@S%20NVARCHAR(4000);SET%20@S=CAST(0x44004500...06F007200%20AS%20NVARCHAR(4000));EXEC(@S);-- 
```

我能够在 SQL 中对此进行解码，但我对此有点谨慎，因为我不知道当时究竟发生了什么。

我尝试编写一个简单的解码工具，因此我可以在不接触[SQL Server](http://en.wikipedia.org/wiki/Microsoft_SQL_Server)的情况下解码这种类型的文本。我需要解码的主要部分是：

```
CAST(0x44004500...06F007200 AS
NVARCHAR(4000)) 
```

我已经尝试了以下所有命令，但没有成功：

```
txtDecodedText.Text =
    System.Web.HttpUtility.UrlDecode(txtURLText.Text);
txtDecodedText.Text =
    Encoding.ASCII.GetString(Encoding.ASCII.GetBytes(txtURLText.Text));
txtDecodedText.Text =
    Encoding.Unicode.GetString(Encoding.Unicode.GetBytes(txtURLText.Text));
txtDecodedText.Text =
    Encoding.ASCII.GetString(Encoding.Unicode.GetBytes(txtURLText.Text));
txtDecodedText.Text =
    Encoding.Unicode.GetString(Convert.FromBase64String(txtURLText.Text)); 
```

在不使用 SQL Server 的情况下转换此编码的正确方法是什么？是否可以？我将采用 VB.NET 代码，因为我也熟悉它。

* * *

好的，我确定我在这里遗漏了一些东西，所以这就是我所在的位置。

由于我的输入是一个基本字符串，我只从编码部分的片段开始 - 4445434C41（转换为 DECLA） - 第一次尝试是这样做......

```
txtDecodedText.Text = Encoding.UTF8.GetString(Encoding.UTF8.GetBytes(txtURL.Text)); 
```

...它所做的只是返回与我输入的完全相同的内容，因为它将每个字符转换为一个字节。

我意识到我需要手动将每两个字符解析为一个字节，因为我还不知道有什么方法可以做到这一点，所以现在我的小解码器看起来像这样：

```
while (!boolIsDone)
{
    bytURLChar = byte.Parse(txtURLText.Text.Substring(intParseIndex, 2));
    bytURL[intURLIndex] = bytURLChar;
    intParseIndex += 2;
    intURLIndex++;

    if (txtURLText.Text.Length - intParseIndex < 2)
    {
        boolIsDone = true;
    }
}

txtDecodedText.Text = Encoding.UTF8.GetString(bytURL); 
```

前几对的情况看起来不错，但是当循环到达“4C”对时，循环停止并说字符串的格式不正确。

有趣的是，当我单步调试调试器并到达我能够解析的字节数组上的 GetString 方法时，我得到“，-+”作为结果。

我如何弄清楚我缺少什么 - 我是否需要对每个字节进行“直接转换”而不是尝试解析它？

* * *

## 回答 #1

> 赞同：24
> 
> 时间：2008-08-05T17:02:30.870

I went back to Michael's post, did some more poking and realized that I did need to do a double conversion, and eventually worked out this little nugget:

```
Convert.ToString(Convert.ToChar(Int32.Parse(EncodedString.Substring(intParseIndex, 2), System.Globalization.NumberStyles.HexNumber))); 
```

From there I simply made a loop to go through all the characters 2 by 2 and get them "hexified" and then translated to a string.

To Nick, and anybody else interested, I went ahead and [posted my little application](http://www.codeplex.com/urldecoder) over in [CodePlex](http://en.wikipedia.org/wiki/CodePlex). Feel free to use/modify as you need.

* * *

## 回答 #2

> 赞同：8
> 
> 时间：2008-08-02T01:38:14.077

尝试删除第`0x`一个，然后调用`Encoding.UTF8.GetString`. 我认为这可能有效。

本质上：0x44004500

去掉 0x，然后总是两个字节是一个字符：

```
44 00 = D

45 00 = E

6F 00 = o

72 00 = r 
```

所以它绝对是一个带有两个字节/字符的 Unicode/UTF 格式。

# sql - ASP.NET 站点地图

> ID：120
> 
> 赞同：43
> 
> 时间：2008-08-01T15:50:08.537
> 
> 标签：sql, asp.net, xml, sitemap

有没有人有创建基于 SQL 的 ASP.NET 站点地图提供程序的经验？

我的默认 XML 文件`web.sitemap`与我的 Menu 和 SiteMapPath 控件一起正常工作，但我需要一种方法让我的站点用户动态地创建和修改页面。

我还需要将页面查看权限绑定到标准`ASP.NET`会员系统中。

* * *

## 回答 #1

> 赞同：16
> 
> 时间：2008-09-23T22:41:11.773

MSDN 杂志的 Jeff Prosise 版本运行良好，但有一些缺陷：

`AddNode`对您菜单上的外部网站链接（www.google.com 等）感到害怕

这是我的修复`BuildSiteMap()`：

```
SiteMapNode node = GetSiteMapNodeFromReader(reader);
string url = node.Url;
if (url.Contains(":"))
{
    string garbage = Guid.NewGuid().ToString();  // SiteMapNode needs unique URLs
    node.Url = "~/dummy_" + garbage + ".aspx";
    AddNode(node, _root);
    node.Url = url;
}
else
{
    AddNode(node, _root);
} 
```

`SQLDependency`缓存很酷，但是如果您不想每次加载菜单时都访问数据库（以检查依赖项是否已更改）并且您的菜单不会经常更改，那么为什么不使用`HttpRuntime.Cache`呢？

```
public override SiteMapNode RootNode
{
    get
    {
        SiteMapNode temp = (SiteMapNode)HttpRuntime.Cache["SomeKeyName"];
        if (temp == null)
        {
            temp = BuildSiteMap();
            HttpRuntime.Cache.Insert("SomeKeyName", temp, null, DateTime.Now.AddHours(1), Cache.NoSlidingExpiration);
        }
        return temp;
    }
} 
```

# java - 将 CSV 转换为 XML 文件的 Java lib 或应用程序？

> ID：123
> 
> 赞同：121
> 
> 时间：2008-08-01T16:08:52.353
> 
> 标签：java, xml, csv, data-conversion

*Java*中是否存在允许我将`CSV`数据文件转换为文件的现有应用程序或库`XML`？

标签将`XML`通过可能包含列标题的第一行提供。

* * *

## 回答 #1

> 赞同：70
> 
> 时间：2008-08-01T18:51:12.090

也许这可能会有所帮助：[JSefa](http://jsefa.sourceforge.net/quick-tutorial.html)

您可以使用此工具读取 CSV 文件并将其序列化为 XML。

* * *

## 回答 #2

> 赞同：48
> 
> 时间：2008-09-10T07:06:23.977

和上面的其他人一样，我不知道任何一步的方法来做到这一点，但如果你准备好使用非常简单的外部库，我建议：

[用于解析 CSV 的OpenCsv](http://opencsv.sourceforge.net/)（小巧、简单、可靠且易于使用）

**Xstream**解析/序列化 XML（非常非常容易使用，并创建完全人类可读的 xml）

使用与上面相同的示例数据，代码如下所示：

```
package fr.megiste.test;

import java.io.FileReader;
import java.io.FileWriter;
import java.util.ArrayList;
import java.util.List;

import au.com.bytecode.opencsv.CSVReader;

import com.thoughtworks.xstream.XStream;

public class CsvToXml {     

    public static void main(String[] args) {

        String startFile = "./startData.csv";
        String outFile = "./outData.xml";

        try {
            CSVReader reader = new CSVReader(new FileReader(startFile));
            String[] line = null;

            String[] header = reader.readNext();

            List out = new ArrayList();

            while((line = reader.readNext())!=null){
                List<String[]> item = new ArrayList<String[]>();
                    for (int i = 0; i < header.length; i++) {
                    String[] keyVal = new String[2];
                    String string = header[i];
                    String val = line[i];
                    keyVal[0] = string;
                    keyVal[1] = val;
                    item.add(keyVal);
                }
                out.add(item);
            }

            XStream xstream = new XStream();

            xstream.toXML(out, new FileWriter(outFile,false));

        } catch (Exception e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
    }
} 
```

产生以下结果：（Xstream 允许对结果进行非常精细的调整......）

```
<list>
  <list>
    <string-array>
      <string>string</string>
      <string>hello world</string>
    </string-array>
    <string-array>
      <string>float1</string>
      <string>1.0</string>
    </string-array>
    <string-array>
      <string>float2</string>
      <string>3.3</string>
    </string-array>
    <string-array>
      <string>integer</string>
      <string>4</string>
    </string-array>
  </list>
  <list>
    <string-array>
      <string>string</string>
      <string>goodbye world</string>
    </string-array>
    <string-array>
      <string>float1</string>
      <string>1e9</string>
    </string-array>
    <string-array>
      <string>float2</string>
      <string>-3.3</string>
    </string-array>
    <string-array>
      <string>integer</string>
      <string>45</string>
    </string-array>
  </list>
  <list>
    <string-array>
      <string>string</string>
      <string>hello again</string>
    </string-array>
    <string-array>
      <string>float1</string>
      <string>-1</string>
    </string-array>
    <string-array>
      <string>float2</string>
      <string>23.33</string>
    </string-array>
    <string-array>
      <string>integer</string>
      <string>456</string>
    </string-array>
  </list>
  <list>
    <string-array>
      <string>string</string>
      <string>hello world 3</string>
    </string-array>
    <string-array>
      <string>float1</string>
      <string>1.40</string>
    </string-array>
    <string-array>
      <string>float2</string>
      <string>34.83</string>
    </string-array>
    <string-array>
      <string>integer</string>
      <string>4999</string>
    </string-array>
  </list>
  <list>
    <string-array>
      <string>string</string>
      <string>hello 2 world</string>
    </string-array>
    <string-array>
      <string>float1</string>
      <string>9981.05</string>
    </string-array>
    <string-array>
      <string>float2</string>
      <string>43.33</string>
    </string-array>
    <string-array>
      <string>integer</string>
      <string>444</string>
    </string-array>
  </list>
</list> 
```

* * *

## 回答 #3

> 赞同：30
> 
> 时间：2008-08-09T11:06:58.973

我知道您要求使用 Java，但这让我觉得这是一项非常适合脚本语言的任务。这是一个用 Groovy 编写的快速（非常简单）的解决方案。

**测试.csv**

```
string,float1,float2,integer
hello world,1.0,3.3,4
goodbye world,1e9,-3.3,45
hello again,-1,23.33,456
hello world 3,1.40,34.83,4999
hello 2 world,9981.05,43.33,444 
```

**csvtoxml.groovy**

```
#!/usr/bin/env groovy

def csvdata = []
new File("test.csv").eachLine { line ->
    csvdata << line.split(',')
}

def headers = csvdata[0]
def dataRows = csvdata[1..-1]

def xml = new groovy.xml.MarkupBuilder()

// write 'root' element
xml.root {
    dataRows.eachWithIndex { dataRow, index ->
        // write 'entry' element with 'id' attribute
        entry(id:index+1) {
            headers.eachWithIndex { heading, i ->
                // write each heading with associated content
                "${heading}"(dataRow[i])
            }
        }
    }
} 
```

将以下 XML 写入标准输出：

```
<root>
  <entry id='1'>
    <string>hello world</string>
    <float1>1.0</float1>
    <float2>3.3</float2>
    <integer>4</integer>
  </entry>
  <entry id='2'>
    <string>goodbye world</string>
    <float1>1e9</float1>
    <float2>-3.3</float2>
    <integer>45</integer>
  </entry>
  <entry id='3'>
    <string>hello again</string>
    <float1>-1</float1>
    <float2>23.33</float2>
    <integer>456</integer>
  </entry>
  <entry id='4'>
    <string>hello world 3</string>
    <float1>1.40</float1>
    <float2>34.83</float2>
    <integer>4999</integer>
  </entry>
  <entry id='5'>
    <string>hello 2 world</string>
    <float1>9981.05</float1>
    <float2>43.33</float2>
    <integer>444</integer>
  </entry>
</root> 
```

但是，代码进行了非常简单的解析（不考虑引用或转义的逗号），并且它没有考虑可能的缺失数据。

* * *

## 回答 #4

> 赞同：19
> 
> 时间：2008-09-27T23:43:44.917

我有一个用于处理 CSV 和平面文件的开源框架。也许值得一看：[JFileHelpers](http://jfilehelpers.com "JFileHelpers")。

使用该工具包，您可以使用 bean 编写代码，例如：

```
@FixedLengthRecord()
public class Customer {
    @FieldFixedLength(4)
    public Integer custId;

    @FieldAlign(alignMode=AlignMode.Right)
    @FieldFixedLength(20)
    public String name;

    @FieldFixedLength(3)
    public Integer rating;

    @FieldTrim(trimMode=TrimMode.Right)
    @FieldFixedLength(10)
    @FieldConverter(converter = ConverterKind.Date, 
    format = "dd-MM-yyyy")
    public Date addedDate;

    @FieldFixedLength(3)
    @FieldOptional
    public String stockSimbol;  
} 
```

然后只需使用以下方法解析您的文本文件：

```
FileHelperEngine<Customer> engine = 
    new FileHelperEngine<Customer>(Customer.class); 
List<Customer> customers = 
    new ArrayList<Customer>();

customers = engine.readResource(
    "/samples/customers-fixed.txt"); 
```

您将拥有一组已解析对象。

希望有帮助！

* * *

## 回答 #5

> 赞同：18
> 
> 时间：2008-08-21T23:17:56.070

此解决方案不需要任何 CSV 或 XML 库，而且我知道，它不处理任何非法字符和编码问题，但您可能也对它感兴趣，前提是您的 CSV 输入不违反上述规则。

**注意：**除非您知道自己在做什么或没有机会使用其他库（可能在某些官僚项目中），否则您不应使用此代码...对较旧的运行时环境使用 StringBuffer...

所以我们开始：

```
BufferedReader reader = new BufferedReader(new InputStreamReader(
        Csv2Xml.class.getResourceAsStream("test.csv")));
StringBuilder xml = new StringBuilder();
String lineBreak = System.getProperty("line.separator");
String line = null;
List<String> headers = new ArrayList<String>();
boolean isHeader = true;
int count = 0;
int entryCount = 1;
xml.append("<root>");
xml.append(lineBreak);
while ((line = reader.readLine()) != null) {
    StringTokenizer tokenizer = new StringTokenizer(line, ",");
    if (isHeader) {
        isHeader = false;
        while (tokenizer.hasMoreTokens()) {
            headers.add(tokenizer.nextToken());
        }
    } else {
        count = 0;
        xml.append("\t<entry id=\"");
        xml.append(entryCount);
        xml.append("\">");
        xml.append(lineBreak);
        while (tokenizer.hasMoreTokens()) {
            xml.append("\t\t<");
            xml.append(headers.get(count));
            xml.append(">");
            xml.append(tokenizer.nextToken());
            xml.append("</");
            xml.append(headers.get(count));
            xml.append(">");
            xml.append(lineBreak);
            count++;
        }
        xml.append("\t</entry>");
        xml.append(lineBreak);
        entryCount++;
    }
}
xml.append("</root>");
System.out.println(xml.toString()); 
```

输入 test.csv （从本页的另一个答案中窃取）：

```
string,float1,float2,integer
hello world,1.0,3.3,4
goodbye world,1e9,-3.3,45
hello again,-1,23.33,456
hello world 3,1.40,34.83,4999
hello 2 world,9981.05,43.33,444 
```

结果输出：

```
<root>
    <entry id="1">
        <string>hello world</string>
        <float1>1.0</float1>
        <float2>3.3</float2>
        <integer>4</integer>
    </entry>
    <entry id="2">
        <string>goodbye world</string>
        <float1>1e9</float1>
        <float2>-3.3</float2>
        <integer>45</integer>
    </entry>
    <entry id="3">
        <string>hello again</string>
        <float1>-1</float1>
        <float2>23.33</float2>
        <integer>456</integer>
    </entry>
    <entry id="4">
        <string>hello world 3</string>
        <float1>1.40</float1>
        <float2>34.83</float2>
        <integer>4999</integer>
    </entry>
    <entry id="5">
        <string>hello 2 world</string>
        <float1>9981.05</float1>
        <float2>43.33</float2>
        <integer>444</integer>
    </entry>
</root> 
```

* * *

## 回答 #6

> 赞同：16
> 
> 时间：2008-08-01T19:21:57.517

我不明白你为什么要这样做。这听起来几乎像货物崇拜编码。

将 CSV 文件转换为 XML 不会增加任何价值。您的程序已经在读取 CSV 文件，因此认为您需要 XML 是行不通的。

另一方面，读取 CSV 文件，对值做*一些事情*，然后序列化为 XML 确实有意义（好吧，尽可能多地使用 XML 可以有意义......;)）但你应该已经有了一种方法序列化为 XML。

* * *

## 回答 #7

> 赞同：16
> 
> 时间：2010-08-11T05:49:54.877

最大的不同是[JSefa](http://jsefa.sourceforge.net/index.html)带来的是它可以将你的 java 对象序列化为 CSV/XML/etc 文件，并且可以反序列化回 java 对象。它由注释驱动，使您可以对输出进行大量控制。

JFileHelpers 看起来也很有趣。

* * *

## 回答 #8

> 赞同：15
> 
> 时间：2008-10-02T06:08:16.347

您可以使用 Groovy 非常轻松地做到这一点，并且代码非常易读。

`contacts.xml`基本上，将为 中的每一行写入 text 变量`contactData.csv`，并且 fields 数组包含每一列。

```
def file1 = new File('c:\\temp\\ContactData.csv')
def file2 = new File('c:\\temp\\contacts.xml')

def reader = new FileReader(file1)
def writer = new FileWriter(file2)

reader.transformLine(writer) { line ->
    fields =  line.split(',')

    text = """<CLIENTS>
    <firstname> ${fields[2]} </firstname>
    <surname> ${fields[1]} </surname>
    <email> ${fields[9]} </email>
    <employeenumber> password </employeenumber>
    <title> ${fields[4]} </title>
    <phone> ${fields[3]} </phone>
    </CLIENTS>"""
} 
```

* * *

## 回答 #9

> 赞同：13
> 
> 时间：2008-10-16T14:33:17.330

您可以使用**XSLT**。谷歌它，你会发现一些例子，例如[CSV 到 XML](http://andrewjwelch.com/code/xslt/csv/csv-to-xml_v2.html) 如果你使用**XSLT**，你可以将 XML 转换成你想要的任何格式。

* * *

## 回答 #10

> 赞同：8
> 
> 时间：2008-08-02T19:06:38.717

据我所知，没有现成的库可以为您执行此操作，但是生成能够从 CSV 转换为 XML 的工具只需要您编写一个粗略的 CSV 解析器并连接 JDOM（或您的 XML Java 库选择）带有一些胶水代码。

* * *

## 回答 #11

> 赞同：8
> 
> 时间：2008-08-04T01:07:07.633

我所知道的没有任何东西可以在没有你至少编写一点代码的情况下做到这一点......你将需要 2 个单独的库：

*   CSV 解析器框架
*   XML 序列化框架

我推荐的 CSV 解析器（除非你想有一点乐趣来编写自己的 CSV 解析器）是 OpenCSV（用于解析 CSV 数据的 SourceForge 项目）

XML 序列化框架应该是可以扩展的，以防您想将大型（或巨大）CSV 文件转换为 XML：我的建议是 Sun Java Streaming XML Parser Framework（参见[此处](https://sjsxp.java.net/)），它允许拉解析和序列化。

* * *

## 回答 #12

> 赞同：8
> 
> 时间：2008-09-30T21:22:05.090

Daniel Parker还有一个很好的[ServingXML](http://servingxml.sourceforge.net/)库，它能够将几乎任何纯文本格式转换为 XML 并返回。

可以在[此处](http://servingxml.sourceforge.net/examples/index.html#d62e305)找到您的案例示例：它使用 CSV 文件中的字段标题作为 XML 元素名称。

* * *

## 回答 #13

> 赞同：4
> 
> 时间：2008-08-01T16:31:43.430

这可能是一个太基本或有限的解决方案，但你不能[`String.split()`](https://docs.oracle.com/javase/7/docs/api/java/lang/String.html#split(java.lang.String))在文件的每一行上做一个，记住第一行的结果数组来生成 XML，然后用正确的 XML 吐出每一行的数组数据元素填充循环的每次迭代？

* * *

## 回答 #14

> 赞同：4
> 
> 时间：2015-04-29T20:01:12.840

Jackson 处理器系列具有多种数据格式的后端，而不仅仅是 JSON。这包括 XML ( [https://github.com/FasterXML/jackson-dataformat-xml](https://github.com/FasterXML/jackson-dataformat-xml) ) 和 CSV ( [https://github.com/FasterXML/jackson-dataformat-csv/](https://github.com/FasterXML/jackson-dataformat-csv/) ) 后端。

转换将依赖于使用 CSV 后端读取输入，使用 XML 后端写入。如果您拥有（或可以定义）针对每行 (CSV) 条目的 POJO，则这是最容易做到的。这不是一个严格的要求，因为来自 CSV 的内容也可能被读取为“无类型”（一系列`String`数组），但需要在 XML 输出上做更多的工作。

对于 XML 端，您需要一个包装器根对象来包含`List`要序列化的数组或对象。

* * *

## 回答 #15

> 赞同：3
> 
> 时间：2008-09-16T16:07:45.670

对于 CSV 部分，您可以使用[我的小型开源库](https://github.com/aburmeis/decs)

* * *

## 回答 #16

> 赞同：3
> 
> 时间：2014-04-16T00:12:54.063

我遇到了同样的问题，需要一个应用程序来为我的一个项目将 CSV 文件转换为 XML 文件，但在网上找不到任何免费且足够好的东西，所以我编写了自己的 Java Swing CSVtoXML 应用程序。

可从我的网站[HERE](https://sites.google.com/site/ibrabel/freewares/csvtoxml)获得。希望它会帮助你。

如果没有，您可以像我一样轻松编写自己的代码；源代码在 jar 文件中，如果不满足您的要求，请根据需要进行修改。

# java - 您将如何从对象方法中访问对象属性？

> ID：126
> 
> 赞同：104
> 
> 时间：2008-08-01T16:10:30.337
> 
> 标签：java, php, oop, theory

从不是 getter/setter 方法的对象方法中访问对象属性的“纯粹”或“正确”方法是什么？

我知道从对象外部你应该使用 getter/setter，但从内部你会这样做：

爪哇：

```
String property = this.property; 
```

PHP：

```
$property = $this->property; 
```

或者你会这样做：

爪哇：

```
String property = this.getProperty(); 
```

PHP：

```
$property = $this->getProperty(); 
```

如果我的 Java 有点偏离，请原谅我，我已经一年没有用 Java 编程了......

**编辑：**

似乎人们假设我只是在谈论私有或受保护的变量/属性。当我学习 OO 时，我被教导要对每个单独的属性使用 getter/setter，即使它是公开的（实际上我被告知永远不要公开任何变量/属性）。所以，我可能是从一开始的错误假设开始的。似乎回答这个问题的人可能会说你应该拥有公共属性，而那些不需要 getter 和 setter，这与我所学的内容和我所说的内容背道而驰，尽管也许这需要讨论为好。不过，对于不同的问题，这可能是一个很好的话题……

* * *

## 回答 #1

> 赞同：65
> 
> 时间：2008-08-01T16:13:47.600

这具有宗教战争的潜力，但在我看来，如果您使用的是 getter/setter，您也应该在内部使用它 - 使用两者都会导致维护问题（例如，有人将代码添加到*需要*每次设置该属性时运行，并且在内部设置该属性而没有调用该设置器）。

* * *

## 回答 #2

> 赞同：44
> 
> 时间：2008-08-01T18:23:59.040

就个人而言，我觉得保持一致很重要。如果您有 getter 和 setter，请使用它们。唯一一次我会直接访问一个字段是当访问器有很多开销时。你可能会觉得你的代码不必要地膨胀了，但它肯定可以在未来省去很多麻烦。经典例子：

稍后，您可能希望更改该字段的工作方式。也许它应该即时计算，或者您可能想为后备存储使用不同的类型。如果您直接访问属性，那么这样的更改可能会一次性破坏大量代码。

* * *

## 回答 #3

> 赞同：27
> 
> 时间：2008-09-19T00:13:34.160

我很惊讶这种情绪是多么一致，`getters`而且二传手很好。我推荐 Allen Holub 的煽动性文章“ [Getters and Setters are Evil](http://www.javaworld.com/javaworld/jw-09-2003/jw-0905-toolbox.html) ”。当然，标题是为了震撼价值，但作者提出了有效的观点。

从本质上讲，如果您拥有`getters`并且`setters`对于每个私有字段，您就可以使这些字段与公共字段一样好。您将很难更改私有字段的类型，而不会对每个调用它的类产生连锁反应`getter`。

此外，从严格的面向对象的角度来看，对象应该响应与其（希望）单一职责相对应的消息（方法）。绝大多数`getters`并且`setters`对其组成对象没有意义；`Pen.dispenseInkOnto(Surface)`对我来说比`Pen.getColor()`.

Getter 和 setter 还鼓励类的用户向对象请求一些数据，执行计算，然后在对象中设置一些其他值，这就是众所周知的过程编程。你最好简单地告诉对象做你首先要做的事情；也称为[信息专家](http://en.wikipedia.org/wiki/GRASP_%28object-oriented_design%29#Information_Expert)成语。

然而，getter 和 setter 在层的边界上是必不可少的——UI、持久性等等。对类内部的限制访问，例如 C++ 的friend 关键字、Java 的包保护访问、.NET 的内部访问以及[Friend 类模式](http://moffdub.wordpress.com/2008/09/17/friend-classes-in-java-and-c-sharp/)，可以帮助您减少`getters`仅对需要它们的人的可见性和设置器。

* * *

## 回答 #4

> 赞同：20
> 
> 时间：2008-08-01T16:19:04.283

这取决于如何使用该属性。例如，假设您有一个具有 name 属性的学生对象。如果尚未检索到名称，您可以使用 Get 方法从数据库中提取名称。这样，您就可以减少对数据库的不必要调用。

现在假设您的对象中有一个私有整数计数器，用于计算名称被调用的次数。您可能不想从对象内部使用 Get 方法，因为它会产生无效的计数。

* * *

## 回答 #5

> 赞同：15
> 
> 时间：2008-09-24T17:24:17.733

PHP 提供了无数种方法来处理这个问题，包括魔术方法`__get`和`__set`，但我更喜欢显式的 getter 和 setter。原因如下：

1.  验证可以放在 setter（和 getter 中）
2.  Intellisense 使用显式方法
3.  毫无疑问，属性是只读的、只写的还是读写的
4.  检索虚拟属性（即计算值）看起来与常规属性相同
5.  您可以轻松设置从未在任何地方实际定义过的对象属性，然后将其变为无证

* * *

## 回答 #6

> 赞同：14
> 
> 时间：2008-08-01T16:43:30.880

> 我只是在这里过火了吗？

也许 ;）

另一种方法是使用私有/受保护的方法来实际进行获取（缓存/db/etc），并使用一个公共包装器来增加计数：

PHP：

```
public function getName() {
    $this->incrementNameCalled();
    return $this->_getName();
}

protected function _getName() {
    return $this->name;
} 
```

然后从对象本身内部：

PHP：

```
$name = $this->_getName(); 
```

这样，您仍然可以将第一个参数用于其他用途（例如发送一个标志以指示是否在此处使用缓存数据）。

* * *

## 回答 #7

> 赞同：13
> 
> 时间：2011-06-04T15:42:09.807

我一定错过了这里的重点，为什么要在对象内部使用 getter 来访问该对象的属性？

以此得出结论，吸气剂应该称为吸气剂，吸气剂应该称为吸气剂。

所以我会说在对象方法内部直接访问一个属性，特别是看到在该对象中调用另一个方法（无论如何它只会直接访问该属性然后返回它）只是一个毫无意义的浪费练习（或者我误解了这个问题）。

* * *

## 回答 #8

> 赞同：9
> 
> 时间：2008-08-22T11:15:45.690

如果您的意思是“纯粹主义者”的“最封装”，那么我通常将我的所有字段声明为私有，然后在类本身中使用“this.field”。对于其他类，包括子类，我使用 getter 访问实例状态。

* * *

## 回答 #9

> 赞同：9
> 
> 时间：2008-09-24T17:04:35.240

该问题不需要基于意见的答案。[从高内聚](https://en.wikipedia.org/wiki/Cohesion_(computer_science))、低[耦合](https://en.wikipedia.org/wiki/Coupling_(computer_programming))原理到[SOLID原理](https://en.wikipedia.org/wiki/SOLID)，它是计算科学几十年来很好地涵盖的主题。

*纯粹*的，正确的，OO方式是最小化耦合和最大化内聚。因此，两者都应该避免，并遵循[得墨忒耳法则，](https://en.wikipedia.org/wiki/Law_of_Demeter)然后使用[告诉不要问](http://c2.com/cgi/wiki?TellDontAsk)的方法。

与其获取将两个类[紧密耦合](https://stackoverflow.com/questions/2832017/what-is-the-difference-between-loose-coupling-and-tight-coupling-in-object-orien)的对象属性的值，不如将对象用作参数，例如

```
 doSomethingWithProperty() {
     doSomethingWith( this.property ) ;
  } 
```

如果属性是本机类型，例如 int，则使用访问方法，将其命名为问题域而不是编程域。

```
 doSomethingWithProperty( this.daysPerWeek() ) ; 
```

这些将允许您维护封装和任何后置条件或相关不变量。您也可以使用 setter 方法来维护任何前置条件或依赖不变量，但不要陷入将它们命名为 setter 的陷阱，在使用习语时，请回到好莱坞原则来命名。

* * *

## 回答 #10

> 赞同：9
> 
> 时间：2010-01-20T08:32:59.530

最好使用访问器方法，即使在对象内也是如此。以下是我立即想到的要点：

1.  应该这样做是为了保持与从对象外部进行的访问的一致性。

2.  在某些情况下，这些访问器方法可能不仅仅是访问字段；他们可能会做一些额外的处理（虽然这种情况很少见）。如果是这种情况，直接访问该字段将意味着您缺少该附加处理，并且如果始终在这些访问期间完成此处理，您的程序可能会出错。

* * *

## 回答 #11

> 赞同：8
> 
> 时间：2008-08-06T14:43:54.830

我可能是错的，因为我是自学者，但我从不在我的 Java 类中使用公共属性，它们始终是私有的或受保护的，因此外部代码必须由 getter/setter 访问。它更适合维护/修改目的。对于内部类代码...如果 getter 方法很简单，我直接使用该属性，但我总是使用 setter 方法，因为如果我愿意，我可以轻松地添加代码来触发事件。

* * *

## 回答 #12

> 赞同：8
> 
> 时间：2008-08-18T17:37:01.130

我发现使用 setter/getter 使我的代码更易于阅读。我也喜欢它在其他类使用这些方法时提供的控件，如果我更改属性将存储的数据。

* * *

## 回答 #13

> 赞同：8
> 
> 时间：2008-08-18T17:43:29.323

具有公共或受保护属性的私有字段。对值的访问应该通过属性，如果它们将在方法中多次使用，则应将其复制到局部变量。当且仅当您对应用程序的其余部分进行如此彻底的调整、摇摆和优化时，通过它们的关联属性访问值已成为瓶颈（我保证，这永远不会发生）如果您甚至开始考虑让属性以外的任何东西直接接触它们的支持变量。

.NET 开发人员可以使用自动属性来强制执行此操作，因为您甚至在设计时都看不到支持变量。

* * *

## 回答 #14

> 赞同：8
> 
> 时间：2008-08-22T11:34:06.987

如果我不编辑该属性，我将使用公共方法`get_property()`，除非它是特殊情况，例如另一个对象中的 MySQLi 对象，在这种情况下，我将公开该属性并将其称为`$obj->object_property`.

在对象内部，对我来说它总是 $this->property。

* * *

## 回答 #15

> 赞同：8
> 
> 时间：2008-10-01T10:51:49.700

这取决于。这更像是一个风格问题，没有硬性规定。

* * *

## 回答 #16

> 赞同：6
> 
> 时间：2008-08-01T16:56:55.830

好吧，似乎使用 C# 3.0 属性的默认实现，您可以做出决定；您必须使用（可能是私有的）属性设置器设置属性。

我个人只在不这样做会导致对象处于不太理想的状态时才使用私有成员，例如在初始化或涉及缓存/延迟加载时。

* * *

## 回答 #17

> 赞同：6
> 
> 时间：2008-09-15T09:46:13.973

我喜欢[cmcculloh](https://stackoverflow.com/questions/126/how-would-you-access-object-properties-from-within-an-object-method#132)的答案，但似乎最正确的是[Greg Hurlman](https://stackoverflow.com/questions/126/how-would-you-access-object-properties-from-within-an-object-method#127)的答案。如果您从一开始就开始使用 getter/setter 和/或您习惯于使用它们，请始终使用 getter/setter。

顺便说一句，我个人发现使用 getter/setter 使代码更易于阅读和以后调试。

* * *

## 回答 #18

> 赞同：5
> 
> 时间：2008-08-01T17:01:27.240

正如一些评论中所述：有时你应该，有时你不应该。私有变量的重要之处在于，当您更改某些内容时，您可以看到它们使用的所有位置。如果您的 getter/setter 做了您需要的事情，请使用它。如果没关系，你自己决定。

相反的情况是，如果你使用 getter/setter 并且有人更改了 getter/setter，他们必须分析 getter 和 setter 在内部使用的所有位置，看看它是否搞砸了。

# mysql - 如何将数据从 SQL Server 2005 导出到 MySQL

> ID：129
> 
> 赞同：90
> 
> 时间：2008-08-01T16:22:42.420
> 
> 标签：mysql, sql-server, csv, sql-server-2005, bcp

我一直在反对`SQL Server 2005`尝试获取大量数据。我得到了一个包含近 300 个表的数据库，我需要将其转换为 MySQL 数据库。我的第一个电话是使用 bcp 但不幸的是它不会产生有效的 CSV - 字符串没有被封装，所以你不能处理任何有一个带有逗号的字符串的行（或者你用作分隔符的任何行）而且我仍然需要手写所有的创建表语句，因为显然 CSV 并没有告诉你任何关于数据类型的信息。

更好的是，如果有一些工具可以同时连接 SQL Server 和 MySQL，然后复制。您会丢失视图、存储过程、触发器等，但将仅使用基本类型的表从一个数据库复制到另一个数据库并不难……是吗？

有人知道这样的工具吗？我不介意它做了多少假设或进行了哪些简化，只要它支持整数、浮点数、日期时间和字符串。无论如何，我必须做很多修剪、规范化等，所以我不关心保留密钥、关系或类似的东西，但我需要快速的初始数据集！

* * *

## 回答 #1

> 赞同：59
> 
> 时间：2008-08-01T17:54:08.163

我发现最好的方法是 MySQL 提供的[MySQL Migration Toolkit](http://www.mysql.com/products/tools/migration-toolkit/)。我已经成功地将它用于一些大型迁移项目。

* * *

## 回答 #2

> 赞同：9
> 
> 时间：2008-09-15T16:11:20.677

SQL Server 2005“Standard”、“Developer”和“Enterprise”版本有[SSIS](http://en.wikipedia.org/wiki/SQL_Server_Integration_Services)，它取代了 SQL Server 2000 中的 DTS。SSIS 有一个到它自己的 DB 的内置连接，你可以找到其他人编写的连接mysql。[这](http://jmayo.spaces.live.com/blog/cns!5F243997972597CE!399.entry)是一个例子。建立连接后，您应该能够创建一个在两者之间移动数据的 SSIS 包。

我不必将数据从 SQLServer 移动到 MySQL，但我想一旦安装了 MySQL 连接，它的工作方式与在两个 SQLServer DB 之间移动数据相同，这非常简单。

* * *

## 回答 #3

> 赞同：9
> 
> 时间：2008-09-15T16:23:13.380

使用 MSSQL Management Studio，我已经使用 MySQL OLE DB 转换了表。右键单击您的数据库并从那里转到“任务->导出数据”，您可以指定 MsSQL OLE DB 源、MySQL OLE DB 源并在两个数据源之间创建列映射。

您很可能希望提前在 MySQL 目标上设置数据库和表（导出将希望自动创建表，但这通常会导致失败）。您可以通过右键单击数据库使用“Tasks->Generate Scripts”在 MySQL 中快速创建表。生成创建脚本后，您需要逐步搜索/替换 MSSQL 到 MYSQL 中存在的关键字和类型。

当然，您也可以像平常一样备份数据库，并找到一个实用程序来恢复 MYSQL 上的 MSSQL 备份。但是，我不确定是否存在。

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2008-08-01T16:36:42.080

滚动您自己的 PHP 解决方案肯定会奏效，但我不确定是否有一种好方法可以自动将架构从一个数据库复制到另一个数据库（也许这是您的问题）。

如果您只是复制数据，和/或无论如何您都需要自定义代码来在两个 DB 之间的修改模式之间进行转换，我建议您使用 PHP 5.2+ 和 PDO 库。您将能够使用 PDO ODBC 进行连接（并使用 MSSQL 驱动程序）。使用其他库将大型文本字段和多字节字符从 MSSQL 导入 PHP 时遇到了很多问题。

* * *

## 回答 #5

> 赞同：6
> 
> 时间：2008-08-01T16:47:54.927

另一个可以尝试的工具是[SQLMaestro 套件](http://www.sqlmaestro.com)。确定精确的工具有点棘手，但他们有各种各样的工具，包括免费的和购买的，可以处理多个数据库平台的各种任务。我建议首先为 MySQL 尝试数据向导工具，因为我相信它会有你需要的适当的“导入”工具。

# .net - XSD 数据集和忽略外键

> ID：134
> 
> 赞同：39
> 
> 时间：2008-08-01T16:33:38.183
> 
> 标签：.net, database, xsd

[我在当前应用程序中使用.NET](https://en.wikipedia.org/wiki/.NET_Framework) [XSD](https://en.wikipedia.org/wiki/XML_Schema_%28W3C%29) `DataSet`和`TableAdapter`功能设置了一个非常标准的表。我的`contracts`表包含一些标准合同信息，其中有一列用于`primary department`. 此列是我的表的[外键](https://en.wikipedia.org/wiki/Foreign_key)，我`Departments`在其中存储基本的`department name`, `id`, `notes`。这是我的[SQL Server](https://en.wikipedia.org/wiki/Microsoft_SQL_Server)中的所有设置和功能。

当我使用 XSD 工具时，我可以一次拖动两个表，它会自动检测/创建我在这两个表之间的外键。当我在我的主页上并查看合同数据时，这非常有用。

然而，当我去我的管理页面修改部门数据时，我通常会做这样的事情：

```
Dim dtDepartment As New DepartmentDataTable()
Dim taDepartment As New DepartmentTableAdapter()

taDepartment.Fill(dtDepartment) 
```

但是，此时会抛出一个异常，大意是这里有一个外键引用被破坏，我猜是因为我没有`Contract DataTable`填充。

我该如何解决这个问题？我知道我可以简单地从 XSD 中删除外键以使事情正常工作，但是在那里进行额外的完整性检查并使 XSD 架构与数据库中的 SQL 架构相匹配是很好的。

* * *

## 回答 #1

> 赞同：13
> 
> 时间：2008-08-01T19:52:14.227

您可以尝试关闭 DataSet 上的 Check-constraints（它在其属性中），或更改该关系的属性，并将键更改为简单引用 - 由您决定。

# c# - 压缩/解压缩文件夹和文件

> ID：145
> 
> 赞同：60
> 
> 时间：2008-08-01T17:13:08.933
> 
> 标签：c#, .net, file, compression

有谁知道在 C# 中快速压缩或解压缩文件和文件夹的好方法？可能需要处理大文件。

* * *

## 回答 #1

> 赞同：27
> 
> 时间：2008-08-05T12:04:41.127

.Net 2.0 框架命名空间`System.IO.Compression`支持 GZip 和 Deflate 算法。这里有两种方法可以压缩和解压缩可以从文件对象中获取的字节流。您可以在下面的方法中替换`GZipStream`以`DefaultStream`使用该算法。但是，这仍然存在处理使用不同算法压缩的文件的问题。

```
public static byte[] Compress(byte[] data)
{
    MemoryStream output = new MemoryStream();

    GZipStream gzip = new GZipStream(output, CompressionMode.Compress, true);
    gzip.Write(data, 0, data.Length);
    gzip.Close();

    return output.ToArray();
}

public static byte[] Decompress(byte[] data)
{
    MemoryStream input = new MemoryStream();
    input.Write(data, 0, data.Length);
    input.Position = 0;

    GZipStream gzip = new GZipStream(input, CompressionMode.Decompress, true);

    MemoryStream output = new MemoryStream();

    byte[] buff = new byte[64];
    int read = -1;

    read = gzip.Read(buff, 0, buff.Length);

    while (read > 0)
    {
        output.Write(buff, 0, read);
        read = gzip.Read(buff, 0, buff.Length);
    }

    gzip.Close();

    return output.ToArray();
} 
```

* * *

## 回答 #2

> 赞同：22
> 
> 时间：2008-08-01T17:30:56.277

我一直使用 SharpZip 库。

[这是一个链接](http://sharpdevelop.net/OpenSource/SharpZipLib/Download.aspx)

* * *

## 回答 #3

> 赞同：10
> 
> 时间：2008-08-01T17:28:24.253

从 .Net 1.1 开始，唯一可用的方法是进入 java 库。

[使用 J# 类库中的 Zip 类使用 C# 压缩文件和数据](https://docs.microsoft.com/en-us/archive/msdn-magazine/2003/june/using-jsharp-class-libraries-to-compress-files-and-data-with-csharp)

不确定这在最近的版本中是否发生了变化。

* * *

## 回答 #4

> 赞同：10
> 
> 时间：2008-08-01T18:04:25.023

正如 Tom 指出的那样，您可以使用[SharpZip 等第三方库。](http://sharpdevelop.net/OpenSource/SharpZipLib/)

另一种方法（不参加第 3 方）是使用 Windows Shell API。您需要在 C# 项目中设置对 Microsoft Shell 控件和自动化 COM 库的引用。杰拉德·吉布森 (Gerald Gibson) 举了一个例子：

[Internet Archive 的死页副本](http://web.archive.org/web/20130724085455/http://geraldgibson.net/dnn/Home/CZipFileCompression/tabid/148/Default.aspx)

* * *

## 回答 #5

> 赞同：8
> 
> 时间：2013-11-17T16:08:25.950

我的回答是闭上眼睛，选择[DotNetZip](http://dotnetzip.codeplex.com/)。它已经过一个大型社区的测试。

* * *

## 回答 #6

> 赞同：6
> 
> 时间：2012-05-13T02:01:39.030

[GZipStream](http://www.dotnetperls.com/gzipstream)是一个非常好的实用程序。

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2008-08-04T23:52:51.290

这在 java 中很容易做到，如上所述，您可以从 C# 访问 java.util.zip 库。参考见：

[java.util.zip javadocs](http://java.sun.com/j2se/1.4.2/docs/api/java/util/zip/package-summary.html)
[示例代码](http://www.devx.com/getHelpOn/10MinuteSolution/20447)

我前一阵子用它来对文件夹结构进行深度（递归）压缩，但我认为我从未使用过解压缩。如果我有这么大的动力，我可能会拉出该代码并稍后将其编辑到此处。

* * *

## 回答 #8

> 赞同：5
> 
> 时间：2011-12-08T22:29:36.020

另一个不错的选择也是[DotNetZip](http://dotnetzip.codeplex.com/)。

* * *

## 回答 #9

> 赞同：0
> 
> 时间：2018-01-09T18:35:19.950

您可以使用以下方法创建 zip 文件：

```
public async Task<string> CreateZipFile(string sourceDirectoryPath, string name)
{
    var path = HostingEnvironment.MapPath(TempPath) + name;
    await Task.Run(() =>
    {
        if (File.Exists(path)) File.Delete(path);
        ZipFile.CreateFromDirectory(sourceDirectoryPath, path);
    });
    return path;
} 
```

然后您可以使用以下方法解压缩 zip 文件：

1-此方法适用于 zip 文件路径

```
public async Task ExtractZipFile(string filePath, string destinationDirectoryName)
{
    await Task.Run(() =>
    {
        var archive = ZipFile.Open(filePath, ZipArchiveMode.Read);
        foreach (var entry in archive.Entries)
        {
            entry.ExtractToFile(Path.Combine(destinationDirectoryName, entry.FullName), true);
        }
        archive.Dispose();
    });
} 
```

2-此方法适用于 zip 文件流

```
public async Task ExtractZipFile(Stream zipFile, string destinationDirectoryName)
{
    string filePath = HostingEnvironment.MapPath(TempPath) + Utility.GetRandomNumber(1, int.MaxValue);
    using (FileStream output = new FileStream(filePath, FileMode.Create))
    {
        await zipFile.CopyToAsync(output);
    }
    await Task.Run(() => ZipFile.ExtractToDirectory(filePath, destinationDirectoryName));
    await Task.Run(() => File.Delete(filePath));
} 
```

# php - 如何跟踪文件下载

> ID：146
> 
> 赞同：87
> 
> 时间：2008-08-01T17:14:58.337
> 
> 标签：php, apache, logging, download, analytics

我有一个在 Flash 播放器中播放 mp3 的网站。如果用户单击“播放”，Flash 播放器会自动下载 mp3 并开始播放。

是否有一种简单的方法可以跟踪特定歌曲剪辑（或任何二进制文件）已下载了多少次？

* * *

> 播放链接是指向实际 mp3 文件的链接还是指向弹出播放器的一些 javascript 代码的链接？
> 
> 如果是后者，您可以轻松地在其中添加自己的日志记录代码以跟踪对其的点击次数。
> 
> 如果是前者，您将需要能够跟踪 Web 服务器日志本身并做出区分的东西。我的托管计划附带 Webalizer，它很好地做到了这一点。

这是一个javascript代码，可以回答这个问题。

但是，很高兴知道如何使用其他方法（无需切换主机）来跟踪下载。

* * *

## 回答 #1

> 赞同：42
> 
> 时间：2008-08-01T17:33:58.750

有趣的是我两天前为我所有的音乐写了一个 php 媒体库。我有一个类似的问题。我正在为播放器使用[http://musicplayer.sourceforge.net/ 。](http://musicplayer.sourceforge.net/)播放列表是通过 php 构建的。所有音乐请求都转到一个名为 xfer.php?file=WHATEVER 的脚本

```
$filename = base64_url_decode($_REQUEST['file']);
header("Cache-Control: public");
header('Content-disposition: attachment; filename='.basename($filename));
header("Content-Transfer-Encoding: binary");
header('Content-Length: '. filesize($filename));

//  Put either file counting code here, either a db or static files
//
readfile($filename);  //and spit the user the file

function base64_url_decode($input) {
    return base64_decode(strtr($input, '-_,', '+/='));
} 
```

当您调用文件时，请使用以下内容：

```
function base64_url_encode($input) {
     return strtr(base64_encode($input), '+/=', '-_,');
} 
```

[http://us.php.net/manual/en/function.base64-encode.php](http://us.php.net/manual/en/function.base64-encode.php)

如果您正在使用需要 mp3 文件或其他文件的实际链接的 JavaScript 或 Flash 播放器（例如 JW 播放器），您可以附加文本“&type=.mp3”，以便最终链接变为：“www.mp3”。 example.com/xfer.php?file=34842ffjfjxfh&type=.mp3"。这样看起来它以 mp3 扩展名结尾而不影响文件链接。

* * *

## 回答 #2

> 赞同：30
> 
> 时间：2008-08-01T17:51:55.407

使用您的 httpd 日志文件。安装[http://awstats.sourceforge.net/](http://awstats.sourceforge.net/)

* * *

## 回答 #3

> 赞同：26
> 
> 时间：2009-10-02T02:12:55.877

使用 bash：

```
grep mp3 /var/log/httpd/access_log | wc 
```

* * *

## 回答 #4

> 赞同：14
> 
> 时间：2008-10-12T09:10:45.970

如果您的歌曲/二进制文件由 apache 提供，您可以轻松地 grep access_log 以找出下载次数。一个简单的 post-logrotate 脚本可以 grep 日志并在数据库中维护您的计数统计信息。由于不在您的实时请求代码路径中，因此具有性能优势。离线执行统计信息等非关键性操作是将您的网站扩展到大量用户的好主意。

* * *

## 回答 #5

> 赞同：13
> 
> 时间：2008-08-01T17:42:04.723

您甚至可以设置一个 Apache .htaccess 指令，将 *.mp3 请求转换为 dubayou 正在使用的查询字符串。这可能是保持直接请求并且仍然能够将日志功能滑入响应中的一种优雅方式。

* * *

## 回答 #6

> 赞同：7
> 
> 时间：2008-08-01T17:24:24.290

播放链接是指向实际 mp3 文件的链接还是指向弹出播放器的一些 javascript 代码的链接？

如果是后者，您可以轻松地在其中添加自己的日志记录代码以跟踪对其的点击次数。

如果是前者，您将需要能够跟踪 Web 服务器日志本身并做出区分的东西。我的托管计划带有 webalizer，它很好地做到了这一点。

* * *

## 回答 #7

> 赞同：4
> 
> 时间：2008-09-04T18:44:22.260

你的音乐库有数据库吗？如果在下载 mp3 时运行任何服务器代码，那么您可以在那里添加额外的代码以增加播放次数。您还可以让 javascript 发出第二个请求来增加播放次数，但这可能会导致人/机器人错误地增加次数。

我曾经在一家互联网广播网站工作，我们使用单独的表格来跟踪每首歌曲的播放时间。我们的流由运行 icecast 的 perl 脚本提供支持，因此每次新曲目开始播放时我们都会触发数据库请求。然后为了计算播放次数，我们将运行一个查询来计算一首歌曲的 id 在播放日志中出现的次数。

* * *

## 回答 #8

> 赞同：4
> 
> 时间：2016-06-09T09:38:50.137

我在使用 AWSStats / 阅读 Web 服务器日志等问题时遇到的问题是，大型下载通常可以拆分为日志中的数据块。这使得协调下载的确切数量变得非常困难。

我建议使用 Google Analytics [Event Tracking](https://developers.google.com/analytics/devguides/collection/analyticsjs/events)，因为每次点击下载链接都会注册一次。

# .net - 如何将 SVN 修订号与我的 ASP.NET 网站同步？

> ID：163
> 
> 赞同：100
> 
> 时间：2008-08-01T18:00:13.830
> 
> 标签：.net, asp.net, svn, versioning

Stack Overflow 底部有一个 subversion 版本号：

> svn 修订：679

我想在我的`.NET Web Site/Application`、Windows 窗体、WPD 项目/解决方案中使用这种自动版本控制。

我该如何实施？

* * *

## 回答 #1

> 赞同：32
> 
> 时间：2008-08-01T18:24:30.550

看起来 Jeff 正在使用[CruiseControl.NET](https://web.archive.org/web/20090130045625/http://confluence.public.thoughtworks.org/display/CCNET/What+is+CruiseControl.NET) ，这是基于对播客记录的一些翻阅。这似乎具有从源代码控制到生产的自动化部署能力。这可能是插入发生的地方吗？

* * *

## 回答 #2

> 赞同：28
> 
> 时间：2008-08-16T18:00:22.303

我们使用[xUnit.net](http://www.codeplex.com/xunit)进行自动化构建。我们使用`CruiseControl.net`（并且正在试用 TeamCity）。我们为持续集成而运行的 MSBuild 任务会自动为我们更改内部版本号，因此生成的构建 ZIP 文件包含一组正确版本化的 DLL 和 EXE。

我们的[MSBuild 文件](http://www.codeplex.com/xunit/SourceControl/FileView.aspx?itemId=115610&changeSetId=20735)包含一个用于 DLL 的 UsingTask 引用，它执行正则表达式替换：（欢迎您使用此 DLL，因为它也包含在 MS-PL 许可证中）

```
  <使用任务
     AssemblyFile="3rdParty\CodePlex.MSBuildTasks.dll"
     TaskName="CodePlex.MSBuildTasks.RegexReplace"/>

```

接下来，我们提取 CI 系统自动提供的内部版本号。如果需要，您也可以让源代码控制提供商提供源修订号，但我们发现 CI 系统中的 build # 更有用，因为不仅可以通过 CI 版本号查看集成结果，还提供了一个链接回构建中包含的变更集。

```
<!-- 级联尝试查找内部版本号 -->

 <PropertyGroup Condition="'$(BuildNumber)' == ''">
   <BuildNumber>$(BUILD_NUMBER)</BuildNumber>
 </属性组>
 <PropertyGroup Condition="'$(BuildNumber)' == ''">
   <BuildNumber>$(ccnetlabel)</BuildNumber>
 </属性组>
 <PropertyGroup Condition="'$(BuildNumber)' == ''">
   <BuildNumber>0</BuildNumber>
 </属性组>

```

（我们尝试使用来自 TeamCity 的 BUILD_NUMBER，然后尝试来自 CC.net 的 ccnetlabel，如果两者都不存在，我们默认为 0，以便我们可以手动测试自动构建脚本。）

接下来，我们有一个任务，它将内部版本号设置到一个 GlobalAssemblyInfo.cs 文件中，我们链接到我们所有的项目中：

```
<目标名称="SetVersionNumber">
   <正则表达式替换
       模式='AssemblyVersion\("(\d+\.\d+\.\d+)\.\d+"\)'
       替换='AssemblyVersion("$1.$(BuildNumber)")'
       文件='GlobalAssemblyInfo.cs'/>
   <Exec Command="attrib -r xunit.installer\App.manifest"/>
 </目标>

```

这将找到 AssemblyVersion 属性，并将 abcd 版本号替换为 abcBuildNumber。我们通常将源检查到树中，固定构建器编号的前三个部分，第四部分为零（fe，今天是 1.0.2.0）。

在您的构建过程中，确保 SetVersionNumber 任务在您的构建任务之前。最后，我们使用我们的 Zip 任务来压缩构建结果，以便我们拥有每个自动构建的二进制文件的历史记录。

* * *

## 回答 #3

> 赞同：25
> 
> 时间：2008-08-01T18:08:16.590

您可以通过在代码中的任何位置添加以下内容来做到这一点

```
$Id:$ 
```

因此，例如@Jeff 做了：

```
<div id="svnrevision">svn revision: $Id:$</div> 
```

并在服务器签入时将 $Id:$ 替换为当前修订号。我也[找到了这个参考](http://www.compuphase.com/svnrev.htm)。

还有**$Date:$** , **$Rev:$** , **$Revision:$**

* * *

## 回答 #4

> 赞同：17
> 
> 时间：2008-12-17T10:17:00.347

如果您正在使用`ASP.Net MVC`（就像 StackOverflow 一样），我编写了一个[易于遵循的 3 步指南，介绍如何自动获取和显示最新的 SVN 修订版](http://www.fatlemon.co.uk/2008/12/automatic-svn-revision-numbering-in-aspnet-mvc/ "ASP.Net MVC 中的自动 SVN 修订编号 - www.fatlemon.co.uk")。该指南的灵感来自于对这个问题的思考！:o)

* * *

## 回答 #5

> 赞同：10
> 
> 时间：2008-09-15T19:04:33.680

@Balloon 如果您使用的是 TortoiseSVN，则可以使用打包的[SubWCRev](http://tortoisesvn.net/docs/release/TortoiseSVN_en/tsvn-subwcrev.html)程序。它查询工作副本并告诉您最高的修订号。诚然，这似乎是一种解决服务器端问题的客户端方法，但由于它是一个很好的命令行程序，您应该能够相当容易地捕获它的输出以供使用。

* * *

## 回答 #6

> 赞同：9
> 
> 时间：2008-08-13T01:28:33.427

`$rev`和其他类似的文件是对单个文件的修订，因此除非文件更改，否则它们不会更改。网页上的数字是（很可能，我在这里假设）整个项目的 svn 修订号。这与其他人一直指出的文件修订不同。

在这种情况下，我假设 CCNET 正在提取项目的修订号并用该编号重写网页的一部分。任何 CI 解决方案都应该能够做到这一点，自己使用 CCNET 和 Teamcity 进行设置（虽然不是网页，而是部署/组装版本的自动版本控制）。

为了让您执行此操作，请使用支持它的 CI 解决方案，或使用您的构建过程（MSbuild/Nant）来存储该版本并将其写入文件，然后再“部署”它。

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2008-10-01T11:51:48.137

要添加到@BradWilson 的答案：*“如果需要，您还可以让源代码控制提供商提供源修订号”*

连接 Subversion 和 MSBuild： [MSBuild 社区任务项目](http://msbuildtasks.tigris.org/)

# windows - 为所有浏览器嵌入 Windows Media Player

> ID：164
> 
> 赞同：63
> 
> 时间：2008-08-01T18:02:22.797
> 
> 标签：windows, embed, media

**编辑：**这个问题写于 2008 年，就像 3 年前的互联网时代一样。如果这个问题仍然与您的环境相关，请接受我的哀悼。其他所有人都应转换为[您的浏览器支持](https://videojs.com/html5-video-support/)的格式（如果需要 Internet Explorer，那将是 H.264，如果不需要，则可能是 AV1、VP8/VP9）并使用[`<video>`元素](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video).

* * *

我们在内部站点上使用[WMV](http://en.wikipedia.org/wiki/Windows_Media_Video)视频，并将它们嵌入到网站中。这在 Internet Explorer 上运行良好，但在 Firefox 上却不行。我找到了使它在 Firefox 中工作的方法，但随后它在 Internet Explorer 中停止工作。

我们暂时还不想使用 Silverlight，尤其是因为我们无法确定所有客户端都将运行安装了 Windows Media Player 的 Windows XP。

是否有某种通用代码将 WMP 嵌入到 Internet Explorer 和 Firefox 中，或者我们是否需要实现一些用户代理检测并为不同的浏览器提供不同的 HTML？

* * *

## 回答 #1

> 赞同：46
> 
> 时间：2008-08-03T14:27:20.967

以下适用于 Firefox 和 Internet Explorer：

```
<object id="mediaplayer" classid="clsid:22d6f312-b0f6-11d0-94ab-0080c74c7e95" codebase="http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#version=5,1,52,701" standby="loading microsoft windows media player components..." type="application/x-oleobject" width="320" height="310">
<param name="filename" value="./test.wmv">
     <param name="animationatstart" value="true">
     <param name="transparentatstart" value="true">
     <param name="autostart" value="true">
     <param name="showcontrols" value="true">
     <param name="ShowStatusBar" value="true">
     <param name="windowlessvideo" value="true">
     <embed src="./test.wmv" autostart="true" showcontrols="true" showstatusbar="1" bgcolor="white" width="320" height="310">
</object> 
```

* * *

## 回答 #2

> 赞同：19
> 
> 时间：2008-08-08T18:29:13.057

我可以推荐[jQuery Media Plugin](http://malsup.com/jquery/media/)吗？为所有类型的视频提供嵌入代码，而不仅仅是 WMV 并进行浏览器检测，将所有混乱的 switch/case 语句排除在模板之外。

* * *

## 回答 #3

> 赞同：8
> 
> 时间：2009-08-04T14:55:37.377

使用以下内容。它适用于 Firefox 和 Internet Explorer。

```
 <object id="MediaPlayer1" width="690" height="500" classid="CLSID:22D6F312-B0F6-11D0-94AB-0080C74C7E95"
            codebase="http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"
            standby="Loading Microsoft® Windows® Media Player components..." type="application/x-oleobject"
            >
            <param name="FileName" value='<%= GetSource() %>' />
            <param name="AutoStart" value="True" />
            <param name="DefaultFrame" value="mainFrame" />
            <param name="ShowStatusBar" value="0" />
            <param name="ShowPositionControls" value="0" />
            <param name="showcontrols" value="0" />
            <param name="ShowAudioControls" value="0" />
            <param name="ShowTracker" value="0" />
            <param name="EnablePositionControls" value="0" />

            <!-- BEGIN PLUG-IN HTML FOR FIREFOX-->
            <embed  type="application/x-mplayer2" pluginspage="http://www.microsoft.com/Windows/MediaPlayer/"
                src='<%= GetSource() %>' align="middle" width="600" height="500" defaultframe="rightFrame"
                 id="MediaPlayer2" /> 
```

在 JavaScript 中，

```
 function playVideo() {
        try{
                if(-1 != navigator.userAgent.indexOf("MSIE"))
                {
                        var obj = document.getElementById("MediaPlayer1");
                            obj.Play();

                }
                else
                {
                            var player = document.getElementById("MediaPlayer2");
                            player.controls.play();

                }
             }  
        catch(error) {
            alert(error)
        } 

        } 
```

* * *

## 回答 #4

> 赞同：6
> 
> 时间：2008-11-10T19:52:28.537

Elizabeth Castro 有一篇关于这个问题的有趣文章：[Bye Bye Embed](http://www.alistapart.com/articles/byebyeembed/)。值得一读她如何解决这个问题，以及处理 QuickTime 内容。

* * *

## 回答 #5

> 赞同：5
> 
> 时间：2008-08-02T11:05:55.460

~~在网络上部署视频的最佳方式是使用 Flash——它更容易干净地嵌入到网页中，并且可以在或多或少的任何浏览器和平台组合上播放。使用 Windows Media Player 的唯一原因是，如果您正在流式传输内容并且需要非常强大的数字版权管理，即使这样，供应商现在也开始使用 Flash 来处理这些内容。请参阅 BBC 的 iPlayer 以获得极好的示例。~~

~~我建议您切换到 Flash，即使是内部使用。您永远不知道将来谁需要访问它，这将为您提供最佳的未来兼容性。~~

编辑 - 2013 年 3 月 20 日。有趣的是，这些老问题如何不时重现！今天的世界多么不同，这一切看起来多么过时。我今天无论如何都不会推荐仅使用 Flash 的路线 - 这些天的最佳做法可能是使用 HTML 5 嵌入 H264 编码的视频，并使用 Flash 后备，如下所述：http: [//diveintohtml5.info/video.html](http://diveintohtml5.info/video.html)

* * *

## 回答 #6

> 赞同：5
> 
> 时间：2008-08-01T18:08:53.080

你可以使用条件注释让 IE 和 Firefox 做不同的事情

```
<![if !IE]>
<p> Firefox only code</p>
<![endif]>

<!--[if IE]>
<p>Internet Explorer only code</p>
<![endif]--> 
```

浏览器本身会忽略不适合他们阅读的代码。

* * *

## 回答 #7

> 赞同：3
> 
> 时间：2008-08-04T02:14:59.477

使用 ffmpeg 编码 Flash 视频实际上非常容易。您可以使用一个命令从几乎任何视频格式进行转换，ffmpeg 足够聪明，可以解决剩下的问题，并且它将使用您机器上的每个处理器。调用它很容易：

```
ffmpeg -i input.avi output.flv 
```

ffmpeg 会猜测你想要的比特率，但如果你想指定一个，你可以使用 -b 选项，`-b 500000`例如 500kbps。当然有很多选择，但我通常不用太多修修补补就能得到很好的结果。如果您正在寻找更多选项，这是一个很好的起点：[视频选项](http://ffmpeg.mplayerhq.hu/ffmpeg-doc.html#SEC9)。

您不需要特殊的网络服务器来显示 Flash 视频。通过简单地将 .flv 文件推送到标准 Web 服务器，并使用好的 swf 播放器（如[flowplayer](http://flowplayer.org/) ）链接到它们，我已经做得很好了。

如果您可以确定所有用户将始终仅使用 [最新的、最新版本的] Windows，那么 WMV 就很好，但即便如此，Flash 通常更适合 Web。该播放器甚至非常可换肤，并且可以使用 javascript 进行控制。

* * *

## 回答 #8

> 赞同：3
> 
> 时间：2013-06-06T16:03:02.890

我在 MSDN 上找到了一篇关于[在 Firefox 中使用 WMP的好文章。](http://msdn.microsoft.com/en-us/library/windows/desktop/dd562847.aspx)

根据 MSDN 的文章，经过反复试验，我发现使用 JavaScript 比使用条件注释或嵌套的“EMBED/OBJECT”标签要好。

我创建了一个基于给定参数生成 WMP 对象的 JS 函数：

```
<script type="text/javascript">
    function generateWindowsMediaPlayer(
        holderId,   // String
        height,     // Number
        width,      // Number
        videoUrl    // String
        // you can declare more arguments for more flexibility
        ) {
        var holder = document.getElementById(holderId);

        var player = '<object ';
        player += 'height="' + height.toString() + '" ';
        player += 'width="' + width.toString() + '" ';

        videoUrl = encodeURI(videoUrl); // Encode for special characters

        if (navigator.userAgent.indexOf("MSIE") < 0) {
            // Chrome, Firefox, Opera, Safari
            //player += 'type="application/x-ms-wmp" '; //Old Edition
            player += 'type="video/x-ms-wmp" '; //New Edition, suggested by MNRSullivan (Read Comments)
            player += 'data="' + videoUrl + '" >';
        }
        else {
            // Internet Explorer
            player += 'classid="clsid:6BF52A52-394A-11d3-B153-00C04F79FAA6" >';
            player += '<param name="url" value="' + videoUrl + '" />';
        }

        player += '<param name="autoStart" value="false" />';
        player += '<param name="playCount" value="1" />';
        player += '</object>';

        holder.innerHTML = player;
    }
</script> 
```

然后我通过编写一些标记和内联 JS 来使用该函数，如下所示：

```
<div id='wmpHolder'></div>

<script type="text/javascript">        
    window.addEventListener('load', generateWindowsMediaPlayer('wmpHolder', 240, 320, 'http://mysite.com/path/video.ext'));
</script> 
```

您可以使用***jQuery.ready***代替***窗口加载事件***来使代码更加向后兼容和跨浏览器。

我在 Windows 7/8 上测试了 IE 9-10、Chrome 27、Firefox 21、Opera 12 和 Safari 5 上的代码。

* * *

## 回答 #9

> 赞同：2
> 
> 时间：2009-11-06T20:00:01.033

我在 Elizabeth Castro 的网站上发现了一些在 FireFox 和 IE 中都有效的东西（感谢本网站上的链接）——我在这里尝试了所有其他版本，但无法让它们在两种浏览器中都工作

```
<object classid="CLSID:6BF52A52-394A-11d3-B153-00C04F79FAA6" 
  id="player" width="320" height="260">
  <param name="url" 
    value="http://www.sarahsnotecards.com/catalunyalive/fishstore.wmv" />
  <param name="src" 
    value="http://www.sarahsnotecards.com/catalunyalive/fishstore.wmv" />
  <param name="showcontrols" value="true" />
  <param name="autostart" value="true" />
  <!--[if !IE]>-->
  <object type="video/x-ms-wmv" 
    data="http://www.sarahsnotecards.com/catalunyalive/fishstore.wmv" 
    width="320" height="260">
    <param name="src" 
      value="http://www.sarahsnotecards.com/catalunyalive/fishstore.wmv" />
    <param name="autostart" value="true" />
    <param name="controller" value="true" />
  </object>
  <!--<![endif]-->
</object> 
```

查看她的网站：[http](http://www.alistapart.com/articles/byebyeembed/) ://www.alistapart.com/articles/byebyeembed/以及初始对象标签中带有 classid 的版本

* * *

## 回答 #10

> 赞同：1
> 
> 时间：2020-12-11T11:59:32.313

2020 年 12 月：

*   我们现在有 Firefox 83.0 和 Chrome 87.0
*   Internet Explorer 已死，已被新的基于 Chromium 的 Edge 87.0 取代
*   银光死了
*   Windows XP 已死
*   WMV 不是标准：[https ://www.w3schools.com/html/html_media.asp](https://www.w3schools.com/html/html_media.asp)

要回答这个问题：

*   您必须将您的 WMV 文件转换为另一种格式：MP4、WebM 或 Ogg 视频。
*   [然后使用HTML 5`<video>`元素](https://www.w3schools.com/html/html5_video.asp)将其嵌入到您的页面中。

我认为这个问题应该结束。

# sql-server - 如何对 SQL Server 数据库进行版本控制？

> ID：173
> 
> 赞同：331
> 
> 时间：2008-08-01T18:33:08.333
> 
> 标签：sql-server, database, svn, version-control

我想让我的数据库处于版本控制之下。

我总是希望那里至少有*一些*数据（正如[alumb](https://stackoverflow.com/users/80/alumb)提到的：用户类型和管理员）。我还经常需要大量生成的测试数据来进行性能测量。

如何将版本控制应用于我的数据库？

* * *

## 回答 #1

> 赞同：187
> 
> 时间：2008-08-02T17:33:54.927

Martin Fowler 写了我最喜欢的关于这个主题的文章，[http](http://martinfowler.com/articles/evodb.html) ://martinfowler.com/articles/evodb.html 。*我选择不按照alumb*和其他人的建议将模式转储置于版本控制之下，因为我想要一种简单的方法来升级我的生产数据库。

对于一个只有一个生产数据库实例的 Web 应用程序，我使用了两种技术：

# 数据库升级脚本

包含将模式从版本 N 移动到 N+1 所需的 DDL 的序列数据库升级脚本。（这些进入您的版本控制系统。） _version_history_ 表，类似于

```
create table VersionHistory (
    Version int primary key,
    UpgradeStart datetime not null,
    UpgradeEnd datetime
    ); 
```

每次运行与新版本相对应的升级脚本时都会获取一个新条目。

这样可以确保很容易查看存在的数据库模式版本，并且数据库升级脚本只运行一次。同样，这些**不是**数据库转储。相反，每个脚本代表从一个版本移动到下一个版本所需的**更改。**它们是您应用于生产数据库以“升级”它的脚本。

# 开发人员沙箱同步

1.  用于备份、清理和收缩生产数据库的脚本。每次升级到生产数据库后运行它。
2.  用于在开发人员的工作站上恢复（并在必要时调整）备份的脚本。每个开发人员在每次升级到生产数据库后都会运行此脚本。

*一个警告：我的自动化测试是针对一个模式正确但空的数据库运行的，所以这个建议不能完全满足你的需要。*

* * *

## 回答 #2

> 赞同：45
> 
> 时间：2008-08-26T07:23:51.707

Red Gate 的 SQL Compare 产品不仅允许您进行对象级别的比较，并从中生成更改脚本，而且还允许您将数据库对象导出到按对象类型组织的文件夹层次结构中，只需创建一个 [objectname].sql这些目录中的每个对象的脚本。对象类型层次结构如下：

\Functions
\Security
\Security\Roles
\Security\Schemas
\Security\Users
\Stored Procedures
\Tables

如果您在进行更改后将脚本转储到同一根目录，则可以使用它来更新您的 SVN 存储库，并单独保留每个对象的运行历史记录。

* * *

## 回答 #3

> 赞同：39
> 
> 时间：2008-08-01T19:28:25.447

这是围绕发展的“难题”之一。据我所知，没有完美的解决方案。

如果您只需要存储数据库结构而不是数据，您可以将数据库导出为 SQL 查询。（在企业管理器中：右键单击数据库 -> 生成 SQL 脚本。我建议在选项选项卡上设置“为每个对象创建一个文件”）然后您可以将这些文本文件提交到 svn 并使用 svn 的 diff 和日志记录功能。

我将它与一个批处理脚本绑定在一起，该脚本接受几个参数并设置数据库。我还添加了一些额外的查询来输入用户类型和管理员用户等默认数据。（如果您想了解更多信息，请发布一些内容，我可以将脚本放在可访问的地方）

如果您还需要保留所有数据，我建议您备份数据库并使用 Redgate ( [http://www.red-gate.com/](http://www.red-gate.com/) ) 产品进行比较。它们并不便宜，但值得每一分钱。

* * *

## 回答 #4

> 赞同：39
> 
> 时间：2015-06-24T10:36:56.450

首先，您必须选择适合您的版本控制系统：

*   集中式版本控制系统 - 用户在处理文件之前/之后签出/签入的标准系统，文件保存在单个中央服务器中

*   分布式版本控制系统 - 正在克隆存储库的系统，每个克隆实际上是存储库的完整备份，因此如果任何服务器崩溃，则可以使用任何克隆的存储库来恢复它 选择适合您需要的正确系统后，您需要设置作为每个版本控制系统核心的存储库所有这些都在以下文章中进行了解释：http: [//solutioncenter.apexsql.com/sql-server-source-control-part-i-understanding -源代码控制基础/](http://solutioncenter.apexsql.com/sql-server-source-control-part-i-understanding-source-control-basics/)

设置存储库后，如果是中央版本控制系统的工作文件夹，您可以阅读[这篇文章](http://solutioncenter.apexsql.com/sql-server-source-control-part-ii-integration/ "本文")。它展示了如何在开发环境中使用以下方法设置源代码控制：

*   通过 MSSCCI 提供程序的 SQL Server Management Studio，

*   Visual Studio 和 SQL Server 数据工具

*   第三方工具 ApexSQL 源代码控制

* * *

## 回答 #5

> 赞同：25
> 
> 时间：2010-07-01T09:10:15.997

在 Red Gate，我们提供了一种工具[SQL Source Control](http://www.red-gate.com/products/SQL_Source_Control/index.htm)，它使用 SQL Compare 技术将您的数据库与 TFS 或 SVN 存储库链接。此工具集成到 SSMS 中，让您可以像往常一样工作，但现在它允许您提交对象。

对于基于迁移的方法（更适合自动化部署），我们提供[SQL 变更自动化](http://www.red-gate.com/products/sql-development/readyroll/)（以前称为 ReadyRoll），它可以将一组增量脚本作为 Visual Studio 项目创建和管理。

在 SQL Source Control 中，可以指定静态数据表。这些作为 INSERT 语句存储在源代码管理中。

如果您谈论的是测试数据，我们建议您使用工具或通过您定义的部署后脚本生成测试数据，或者您只需将生产备份恢复到开发环境。

* * *

## 回答 #6

> 赞同：22
> 
> 时间：2008-09-16T18:16:59.680

您可能想查看 Liquibase ( [http://www.liquibase.org/](http://www.liquibase.org/) )。即使您不使用该工具本身，它也可以很好地处理数据库更改管理或重构的概念。

* * *

## 回答 #7

> 赞同：21
> 
> 时间：2008-10-15T09:44:04.590

+1 为推荐 RedGate 工具的每个人提供额外的建议和警告。

SqlCompare 还有一个文档化的 API：例如，您可以编写一个控制台应用程序，在签入时将源代码控制的脚本文件夹与 CI 集成测试数据库同步，这样当有人从他们的脚本文件夹签入对架构的更改时它会与匹配的应用程序代码更改一起自动部署。这有助于缩小与忘记将本地数据库中的更改传播到共享开发数据库的开发人员之间的差距（我认为大约有一半的开发人员 :)）。

需要注意的是，使用脚本解决方案或其他方式，RedGate 工具足够流畅，很容易忘记抽象背后的 SQL 现实。如果重命名表中的所有列，SqlCompare 无法将旧列映射到新列，并将删除表中的所有数据。它会产生警告，但我看到人们点击过去。我认为，这里有一个值得一提的普遍观点，即到目前为止，您只能自动化数据库版本控制和升级——抽象非常容易泄漏。

* * *

## 回答 #8

> 赞同：16
> 
> 时间：2008-08-07T21:12:01.990

我们使用[DBGhost](http://www.innovartis.co.uk/)来管理我们的 SQL 数据库。然后你把你的脚本在你的版本控制中构建一个新的数据库，它要么构建一个新的数据库，要么将任何现有的数据库升级到版本控制中的模式。这样您就不必担心创建更改脚本（尽管您仍然可以这样做，例如，如果您想更改列的数据类型并需要转换数据）。

* * *

## 回答 #9

> 赞同：16
> 
> 时间：2011-02-25T20:18:05.107

在 VS 2010 中，使用数据库项目。

1.  编写数据库脚本
2.  更改脚本或直接在您的数据库服务器上
3.  使用“数据”>“架构比较”进行同步

打造完美的数据库版本控制解决方案，让数据库同步变得轻而易举。

* * *

## 回答 #10

> 赞同：12
> 
> 时间：2008-08-06T22:51:35.923

您还可以查看迁移解决方案。这些允许您在 C# 代码中指定您的数据库架构，并使用 MSBuild 向上和向下滚动您的数据库版本。

我目前正在使用[DbUp](https://dbup.github.io/)，并且运行良好。

* * *

## 回答 #11

> 赞同：12
> 
> 时间：2008-09-24T06:11:22.250

使用更改脚本将数据库脚本保存到版本控制中是一种很好的方法，这样您就可以升级您拥有的任何数据库。此外，您可能希望保存不同版本的模式，以便无需应用所有更改脚本即可创建完整数据库。处理脚本应该是自动化的，这样您就不必进行手动工作。

我认为为每个开发人员拥有一个单独的数据库而不使用共享数据库很重要。这样，开发人员可以独立于其他开发人员创建测试用例和开发阶段。

自动化工具应该有处理数据库元数据的方法，它告诉哪些数据库处于什么开发状态，哪些表包含版本可控数据等等。

* * *

## 回答 #12

> 赞同：10
> 
> 时间：2008-08-02T17:54:50.687

您没有提及有关您的目标环境或约束的任何细节，因此这可能并不完全适用......但是如果您正在寻找一种有效跟踪不断发展的数据库模式并且不反对使用的想法的方法Ruby，ActiveRecord 的迁移就在你的小巷里。

迁移使用 Ruby DSL 以编程方式定义数据库转换；每个转换都可以应用或（通常）回滚，允许您在任何给定时间点跳转到不同版本的数据库模式。定义这些转换的文件可以像任何其他源代码一样签入版本控制。

因为迁移是[ActiveRecord](http://ar.rubyonrails.com/)的一部分，所以它们通常在全栈 Rails 应用程序中使用；但是，您可以毫不费力地使用独立于 Rails 的 ActiveRecord。有关在Rails 之外使用 AR 迁移的更详细的处理方法，请参见[此处。](http://rails.aizatto.com/2007/05/27/activerecord-migrations-without-rails/)

* * *

## 回答 #13

> 赞同：10
> 
> 时间：2009-07-07T12:58:34.487

每个数据库都应该在源代码控制之下。缺少的是一种工具，可以自动将所有数据库对象和“配置数据”写入文件，然后可以将其添加到任何源代码控制系统中。如果您使用的是 SQL Server，那么我的解决方案在这里：[http](http://dbsourcetools.codeplex.com/) ://dbsourcetools.codeplex.com/ 。玩得开心。- 内森。

* * *

## 回答 #14

> 赞同：9
> 
> 时间：2009-05-16T11:31:13.480

这很简单。

1.  当基础项目准备好后，您必须创建完整的数据库脚本。此脚本已提交给 SVN。这是第一个版本。

2.  之后，所有开发人员都会创建更改脚本（ALTER...、新表、存储过程等）。

3.  当您需要当前版本时，您应该执行所有新的更改脚本。

4.  当应用程序发布到生产环境时，您会返回到 1（但它当然会是后续版本）。

Nant 将帮助您执行这些更改脚本。:)

记住。当有纪律时，一切都很好。每次提交数据库更改时，也会提交代码中的相应函数。

* * *

## 回答 #15

> 赞同：8
> 
> 时间：2008-08-07T21:21:01.050

如果您有一个小型数据库并且想要对整个事物进行版本控制，那么[这个批处理脚本](http://weblogs.asp.net/jgalloway/archive/2006/10/28/Batch-files-to-check-SQL-2005-_2800_MDF_2900_-files-in-and-out-of-Subversion-source-control.aspx)可能会有所帮助。它分离、压缩 MSSQL 数据库 MDF 文件并将其签入 Subversion。

如果您主要想对架构进行版本化并且只有少量参考数据，则可以使用[SubSonic Migrations](http://web.archive.org/web/20120419154556/http://blog.wekeroad.com:80/blog/subsonic-using-migrations)来处理它。这样做的好处是您可以轻松地向上或向下迁移到任何特定版本。

* * *

## 回答 #16

> 赞同：8
> 
> 时间：2008-09-24T05:49:35.517

因为我们的应用程序必须跨多个 RDBMS 工作，所以我们使用数据库中性[Torque](http://db.apache.org/torque/)格式 (XML) 将模式定义存储在版本控制中。我们还以 XML 格式对数据库的参考数据进行版本控制，如下所示（其中“关系”是参考表之一）：

```
 <Relationship RelationshipID="1" InternalName="Manager"/>
  <Relationship RelationshipID="2" InternalName="Delegate"/>
  etc. 
```

然后，我们使用本土工具生成架构升级和参考数据升级脚本，这些脚本需要从数据库版本 X 升级到版本 X + 1。

* * *

## 回答 #17

> 赞同：7
> 
> 时间：2008-08-06T23:00:16.310

我们不存储数据库模式，我们将更改存储到数据库。我们所做的是存储模式更改，以便我们为任何版本的数据库构建更改脚本并将其应用于客户的数据库。我编写了一个与我们的主应用程序一起分发的数据库实用程序应用程序，它可以读取该脚本并知道需要应用哪些更新。它还具有足够的智能来根据需要刷新视图和存储过程。

* * *

## 回答 #18

> 赞同：7
> 
> 时间：2008-09-24T12:53:48.757

为了使转储到源代码控制系统的速度更快一点，您可以使用 sysobjects 中的版本信息查看自上次以来哪些对象已更改。

**设置：**在要增量检查的每个数据库中创建一个表，以保存上次检查时的版本信息（第一次运行时为空）。如果要重新扫描整个数据结构，请清除此表。

```
IF ISNULL(OBJECT_ID('last_run_sysversions'), 0) <> 0 DROP TABLE last_run_sysversions
CREATE TABLE last_run_sysversions (
    name varchar(128), 
    id int, base_schema_ver int,
    schema_ver int,
    type char(2)
) 
```

**正常运行模式：**您可以从这个 sql 中获取结果，并为您感兴趣的那些生成 sql 脚本，并将它们放入您选择的源代码控制中。

```
IF ISNULL(OBJECT_ID('tempdb.dbo.#tmp'), 0) <> 0 DROP TABLE #tmp
CREATE TABLE #tmp (
    name varchar(128), 
    id int, base_schema_ver int,
    schema_ver int,
    type char(2)
)

SET NOCOUNT ON

-- Insert the values from the end of the last run into #tmp
INSERT #tmp (name, id, base_schema_ver, schema_ver, type) 
SELECT name, id, base_schema_ver, schema_ver, type FROM last_run_sysversions

DELETE last_run_sysversions
INSERT last_run_sysversions (name, id, base_schema_ver, schema_ver, type)
SELECT name, id, base_schema_ver, schema_ver, type FROM sysobjects

-- This next bit lists all differences to scripts.
SET NOCOUNT OFF

--Renamed.
SELECT 'renamed' AS ChangeType, t.name, o.name AS extra_info, 1 AS Priority
FROM sysobjects o INNER JOIN #tmp t ON o.id = t.id
WHERE o.name <> t.name /*COLLATE*/
AND o.type IN ('TR', 'P' ,'U' ,'V')
UNION 

--Changed (using alter)
SELECT 'changed' AS ChangeType, o.name /*COLLATE*/, 
       'altered' AS extra_info, 2 AS Priority
FROM sysobjects o INNER JOIN #tmp t ON o.id = t.id 
WHERE (
   o.base_schema_ver <> t.base_schema_ver
OR o.schema_ver      <> t.schema_ver
)
AND  o.type IN ('TR', 'P' ,'U' ,'V')
AND  o.name NOT IN ( SELECT oi.name 
         FROM sysobjects oi INNER JOIN #tmp ti ON oi.id = ti.id
         WHERE oi.name <> ti.name /*COLLATE*/
         AND oi.type IN ('TR', 'P' ,'U' ,'V')) 
UNION

--Changed (actually dropped and recreated [but not renamed])
SELECT 'changed' AS ChangeType, t.name, 'dropped' AS extra_info, 2 AS Priority
FROM #tmp t
WHERE    t.name IN ( SELECT ti.name /*COLLATE*/ FROM #tmp ti
         WHERE NOT EXISTS (SELECT * FROM sysobjects oi
                           WHERE oi.id = ti.id))
AND  t.name IN ( SELECT oi.name /*COLLATE*/ FROM sysobjects oi
         WHERE NOT EXISTS (SELECT * FROM #tmp ti
                           WHERE oi.id = ti.id)
         AND   oi.type  IN ('TR', 'P' ,'U' ,'V'))
UNION

--Deleted
SELECT 'deleted' AS ChangeType, t.name, '' AS extra_info, 0 AS Priority
FROM #tmp t
WHERE NOT EXISTS (SELECT * FROM sysobjects o
                  WHERE o.id = t.id)
AND t.name NOT IN (  SELECT oi.name /*COLLATE*/ FROM sysobjects oi
         WHERE NOT EXISTS (SELECT * FROM #tmp ti
                           WHERE oi.id = ti.id)
         AND   oi.type  IN ('TR', 'P' ,'U' ,'V'))
UNION

--Added
SELECT 'added' AS ChangeType, o.name /*COLLATE*/, '' AS extra_info, 4 AS Priority
FROM sysobjects o
WHERE NOT EXISTS (SELECT * FROM #tmp t
                  WHERE o.id = t.id)
AND      o.type  IN ('TR', 'P' ,'U' ,'V')
AND  o.name NOT IN ( SELECT ti.name /*COLLATE*/ FROM #tmp ti
         WHERE NOT EXISTS (SELECT * FROM sysobjects oi
                           WHERE oi.id = ti.id))
ORDER BY Priority ASC 
```

**注意：**如果您在任何数据库中使用非标准排序规则，则需要替换`/* COLLATE */`为您的数据库排序规则。IE`COLLATE Latin1_General_CI_AI`

* * *

## 回答 #19

> 赞同：7
> 
> 时间：2010-09-23T02:35:41.337

我不久前写了这个应用程序，[http:](http://sqlschemasourcectrl.codeplex.com/) //sqlschemasourcectrl.codeplex.com/ 它将根据需要扫描您的 MSFT SQL 数据库，并自动将您的对象（表、视图、过程、函数、sql 设置）转储到 SVN。奇迹般有效。我将它与 Unfuddle 一起使用（它允许我在签到时收到警报）

* * *

## 回答 #20

> 赞同：6
> 
> 时间：2008-08-03T01:49:58.983

典型的解决方案是根据需要转储数据库并备份这些文件。

根据您的开发平台，可能有可用的开源插件。滚动你自己的代码来完成它通常是相当微不足道的。

注意：您可能希望备份数据库转储而不是将其放入版本控制中。这些文件在版本控制中会变得非常快，并导致整个源代码控制系统变慢（我现在回忆起一个 CVS 恐怖故事）。

* * *

## 回答 #21

> 赞同：6
> 
> 时间：2008-10-09T14:54:12.467

迁移到 x64 平台后，我们需要对 SQL 数据库进行版本控制，而我们的旧版本因迁移而中断。我们编写了一个 C# 应用程序，它使用 SQLDMO 将所有 SQL 对象映射到一个文件夹：

```
                根
                    服务器名称
                       数据库名称
                          模式对象
                             数据库触发器*
                                .ddltrigger.sql
                             职能
                                ..function.sql
                             安全
                                角色
                                   应用程序角色
                                      .approle.sql
                                   数据库角色
                                      .role.sql
                                架构*
                                   .schema.sql
                                用户
                                   .user.sql
                             贮存
                                全文目录*
                                   .全文.sql
                             存储过程
                                ..proc.sql
                             同义词*
                                .synonym.sql
                             表
                                ..table.sql
                                约束
                                   ...chkconst.sql
                                   ...defconst.sql
                                索引
                                   ...索引.sql
                                钥匙
                                   ... fkey.sql
                                   ...pkey.sql
                                   ...ukey.sql
                                触发器
                                   ...触发器.sql
                             类型
                                用户定义的数据类型
                                   ..uddt.sql
                                XML 模式集合*
                                   ..xmlschema.sql
                             意见
                                ..view.sql
                                索引
                                   ...索引.sql
                                触发器
                                   ...触发器.sql

```

然后，应用程序会将新编写的版本与存储在 SVN 中的版本进行比较，如果有差异，它将更新 SVN。我们确定每晚运行一次该过程就足够了，因为我们没有对 SQL 进行太多更改。它允许我们跟踪对我们关心的所有对象的更改，并且它允许我们在出现严重问题时重建我们的完整模式。

* * *

## 回答 #22

> 赞同：6
> 
> 时间：2011-02-24T18:28:51.967

我同意 ESV 的回答，出于这个确切原因，我不久前开始了一个小项目，以帮助在一个非常简单的文件中维护数据库更新，然后可以维护一个长边源代码。它允许对开发人员以及 UAT 和生产进行轻松更新。该工具适用于 SQL Server 和 MySQL。

一些项目特点：

*   允许架构更改
*   允许价值树种群
*   允许单独的测试数据插入，例如。UAT
*   允许回滚选项（非自动）
*   保持对 SQL Server 和 MySQL 的支持
*   能够使用一个简单的命令将现有数据库导入版本控制（仅限 SQL 服务器......仍在使用 MySQL）

请查看[代码](http://code.google.com/p/databaseversioncontrol/)以获取更多信息。

* * *

## 回答 #23

> 赞同：6
> 
> 时间：2015-06-23T11:26:15.587

这是一个非常古老的问题，然而，即使是现在，也有很多人试图解决这个问题。他们所要做的就是研究 Visual Studio 数据库项目。没有这个，任何数据库开发看起来都非常软弱。从代码组织到部署再到版本控制，它简化了一切。

* * *

## 回答 #24

> 赞同：5
> 
> 时间：2008-08-22T17:13:23.350

我们刚刚开始使用 Team Foundation Server。如果你的数据库是中型的，那么 Visual Studio 有一些很好的项目集成，内置比较、数据比较、数据库重构工具、数据库测试框架，甚至数据生成工具。

但是，该模型不太适合非常大的数据库或第三方数据库（加密对象）。所以，我们所做的是只存储我们自定义的对象。Visual Studio / Team Foundation Server 非常适合这一点。

[TFS 数据库首席拱门。博客](http://blogs.msdn.com/gertd/)

[MS TFS 站点](http://msdn.microsoft.com/en-us/tfs2008/default.aspx)

* * *

## 回答 #25

> 赞同：5
> 
> 时间：2008-09-16T17:55:32.807

不久前，我发现了一个 VB bas 模块，它使用 DMO 和 VSS 对象将整个数据库脚本化并放入 VSS。我把它变成了一个 VB 脚本并在[这里](http://glossopian.co.uk/pmwiki.php?n=Main.DBtoVSS)发布。您可以轻松地取出 VSS 调用并使用 DMO 的东西来生成所有脚本，然后从调用 VBScript 的同一个批处理文件中调用 SVN 来签入它们。

* * *

## 回答 #26

> 赞同：5
> 
> 时间：2009-05-15T19:26:32.893

我还在通过数据库扩展属性系列过程存储的数据库中使用一个版本。我的应用程序有每个版本步骤的脚本（即从 1.1 移动到 1.2）。部署后，它会查看当前版本，然后逐个运行脚本，直到到达最后一个应用程序版本。没有具有直接“最终”版本的脚本，即使部署在干净的数据库上，也会通过一系列升级步骤进行部署。

现在我想补充的是，两天前我在 MS 校园看到了关于新的和即将推出的 VS DB 版本的演示。演示文稿专门针对这个主题，我被炸飞了。您绝对应该检查一下，新工具专注于在 T-SQL 脚本 (CREATE) 中保留模式定义，这是一个运行时增量引擎，用于将部署模式与定义的模式进行比较，并执行增量 ALTER 和与源代码集成的集成，最多并包括用于自动构建删除的 MSBUILD 持续集成。drop 将包含一种新的文件类型，即 .dbschema 文件，可以将其带到部署站点，并且命令行工具可以执行实际的“增量”并运行部署。我有一篇关于此主题的博客文章，其中包含 VSDE 下载的链接，您应该查看它们：[http://rusanu.com/2009/05/15/version-control-and-your-database/](http://rusanu.com/2009/05/15/version-control-and-your-database/)

* * *

## 回答 #27

> 赞同：3
> 
> 时间：2009-08-06T10:28:36.633

根据我的经验，解决方案是双重的：

1.  您需要处理多个开发人员在开发过程中对开发数据库所做的更改。

2.  您需要处理客户站点中的数据库升级。

为了处理#1，您需要一个强大的数据库差异/合并工具。最好的工具应该能够尽可能地执行自动合并，同时允许您手动解决未处理的冲突。

完美的工具应该通过使用 3 路合并算法来处理合并操作，该算法考虑到在 THEIRS 数据库和 MINE 数据库中所做的更改，相对于 BASE 数据库。

我编写了一个为 SQLite 数据库提供手动合并支持的商业工具，我目前正在为 SQLite 添加对 3 路合并算法的支持。在[http://www.sqlitecompare.com上查看](http://www.sqlitecompare.com)

为了处理#2，您将需要一个升级框架。

基本思想是开发一个自动升级框架，该框架知道如何从现有的 SQL 模式升级到更新的 SQL 模式，并且可以为每个现有的数据库安装构建升级路径。

查看我在[http://www.codeproject.com/KB/database/sqlite_upgrade.aspx](http://www.codeproject.com/KB/database/sqlite_upgrade.aspx)中关于该主题的文章，以大致了解我在说什么。

祝你好运

利龙·列维

* * *

## 回答 #28

> 赞同：3
> 
> 时间：2009-11-02T22:17:17.307

查看 DBGhost [http://www.innovartis.co.uk/](http://www.innovartis.co.uk/)。我已经以自动化方式使用了 2 年，效果很好。它允许我们的数据库构建就像 Java 或 C 构建一样发生，除了数据库。你知道我的意思。

* * *

## 回答 #29

> 赞同：2
> 
> 时间：2017-01-10T16:16:55.723

我建议使用比较工具为您的数据库即兴创作版本控制系统。两个不错的选择是[xSQL Schema Compare](http://www.xsql.com/products/sql_server_schema_compare/?utm_source=pragmatic&utm_medium=articles&utm_campaign=xsql)和[xSQL Data Compare](http://www.xsql.com/products/sql_server_data_compare/?utm_source=pragmatic&utm_medium=articles&utm_campaign=xsql)。

现在，如果您的目标是仅将数据库的模式置于版本控制之下，您可以简单地使用 xSQL 模式比较来生成模式的 xSQL 快照并将这些文件添加到您的版本控制中。然后，要恢复或更新到特定版本，只需将数据库的当前版本与目标版本的快照进行比较。

此外，如果您还想将数据置于版本控制之下，您可以使用 xSQL 数据比较为您的数据库生成更改脚本并将 .sql 文件添加到版本控制中。然后，您可以执行这些脚本以恢复/更新到您想要的任何版本。请记住，对于“恢复”功能，您需要生成更改脚本，当执行该脚本时，将使版本 3 与版本 2 相同，而对于“更新”功能，您需要生成执行相反操作的更改脚本。

最后，通过一些基本的批处理编程技能，您可以使用 xSQL Schema Compare 和 xSQL Data Compare 的命令行版本来自动化整个过程

免责声明：我隶属于 xSQL。

# c# - 如何从 Web 服务打印 HTML 文档？

> ID：174
> 
> 赞同：85
> 
> 时间：2008-08-01T18:33:48.287
> 
> 标签：c#, html, web-services, printing

我想从 C# Web 服务打印 HTML。Web 浏览器控制是多余的，在服务环境中不能很好地运行，在安全约束非常严格的系统上也不能很好地运行。是否有任何类型的免费`.NET`库可以支持基本 HTML 页面的打印？这是我到目前为止的代码，它不能正常运行。

```
public void PrintThing(string document)
{
    if (Thread.CurrentThread.GetApartmentState() != ApartmentState.STA)
    {
        Thread thread =
            new Thread((ThreadStart) delegate { PrintDocument(document); });
        thread.SetApartmentState(ApartmentState.STA);
        thread.Start();
    }
    else
    {
        PrintDocument(document);
    }
}

protected void PrintDocument(string document)
{
    WebBrowser browser = new WebBrowser();
    browser.DocumentText = document;
    while (browser.ReadyState != WebBrowserReadyState.Complete)
    {
        Application.DoEvents();
    }
    browser.Print();
} 
```

当从 UI 类型线程调用时，这工作正常，但从服务类型线程调用时没有任何反应。更改`Print()`为会`ShowPrintPreviewDialog()`产生以下 IE 脚本错误：

> **错误：** `dialogArguments.___IE_PrintType`为空或不是对象。
> 
> 网址：`res://ieframe.dll/preview.dlg`

并出现一个小的空白打印预览对话框。

* * *

## 回答 #1

> 赞同：36
> 
> 时间：2008-08-03T18:06:30.913

您可以使用以下命令从命令行打印：

> rundll32.exe %WINDIR%\System32\mshtml.dll,PrintHTML "%1"

其中 %1 是要打印的 HTML 文件的文件路径。

如果您不需要从内存中打印（或者可以在临时文件中写入磁盘），您可以使用：

```
using (Process printProcess = new Process())
{
    string systemPath = Environment.GetFolderPath(Environment.SpecialFolder.System);
    printProcess.StartInfo.FileName = systemPath + @"\rundll32.exe";
    printProcess.StartInfo.Arguments = systemPath + @"\mshtml.dll,PrintHTML """ + fileToPrint + @"""";
    printProcess.Start();
} 
```

注意 我认为这只适用于 Windows 2000 及更高版本。

* * *

## 回答 #2

> 赞同：7
> 
> 时间：2008-08-02T00:42:35.310

我知道 Visual Studio 本身（至少在 2003 版本中）直接引用 IE dll 来呈现“设计视图”。

这可能值得研究。

否则，我想不出 Web Browser 控件之外的任何东西。

* * *

## 回答 #3

> 赞同：6
> 
> 时间：2012-08-15T13:27:40.940

简单的！将您的问题分成两个更简单的部分：

1.  [将 HTML 呈现为 PDF](https://stackoverflow.com/a/5635643/284795)
2.  打印 PDF ( [SumatraPDF](http://blog.kowalczyk.info/software/sumatrapdf/manual.html#manual-cmd-line) )

> *   `-print-to-default $file.pdf` 在默认打印机上打印 PDF 文件
> *   `-print-to $printer_name $file.pdf` 在给定的打印机上打印 PDF

* * *

## 回答 #4

> 赞同：4
> 
> 时间：2010-04-12T17:57:20.060

如果您有预算（约 3000 美元），请查看[PrinceXML](http://www.princexml.com)。

它将 HTML 呈现为 PDF，在服务环境中运行良好，并支持高级功能，例如在表格单元格中间不破坏页面（许多浏览器目前不支持）。

* * *

## 回答 #5

> 赞同：2
> 
> 时间：2019-09-08T02:35:05.200

对我来说效果很好的工具是 HiQPdf。 [https://www.hiqpdf.com/](https://www.hiqpdf.com/)

价格合理（起价 245 美元），它可以将 HTML 渲染为 PDF，还可以直接管理 PDF 文件的打印。

* * *

## 回答 #6

> 赞同：1
> 
> 时间：2009-06-17T17:36:22.350

也许这会有所帮助。[http://www.codeproject.com/KB/printing/printhml.aspx](http://www.codeproject.com/KB/printing/printhml.aspx) 也不确定您尝试从哪个线程访问浏览器控件，但它需要是 STA

注意 - 链接中提到的项目确实允许您导航到页面并执行打印而不显示打印对话框。

* * *

## 回答 #7

> 赞同：-2
> 
> 时间：2008-09-20T17:37:33.710

我不知道具体的工具，但有一些工具可以记录/重放点击。换句话说，您可以自动执行打印对话框上的“点击”。（我知道这是一个 hack，但是当所有其他方法都失败时......）

# youtube - 以编程方式注释 YouTube 视频

> ID：175
> 
> 赞同：53
> 
> 时间：2008-08-01T18:36:14.070
> 
> 标签：youtube, reverse-engineering

我希望能够显示带有重叠注释的普通 YouTube 视频，由每帧的彩色矩形组成。唯一的要求是这应该以编程方式完成。

YouTube 现在有注释，但需要您使用它们的前端手动创建它们。我希望能够生成它们。这样做的最佳方法是什么？

一些想法：

> 1.  构建自己的 Flash 播放器（嗯？）
> 2.  不知何故绘制了 YouTube Flash 播放器。这行得通吗？
> 3.  逆向工程和劫持 YouTube 的注释系统。要么弄乱本地文件，要么重定向它下载注释的尝试。（使用 Greasemonkey？Firefox 插件？）

不重要的想法：

> 下载视频

* * *

## 回答 #1

> 赞同：18
> 
> 时间：2008-09-15T18:54:44.310

YouTube 提供了一个[ActionScript API](http://code.google.com/apis/youtube/flash_api_reference.html)。

使用它，您可以使用他们的 API 将视频加载到 Flash 中，然后让您的 Flash 应用程序在视频上方的图层上创建注释。

或者，如果您不想在 Flash 中创建内容，则可以使用 YouTube 的 JavaScript API 在网页上的 YouTube 播放器上绘制 HTML DIV。请记住，当您将播放器嵌入到`WMODE="transparent"`参数列表中时。

因此，使用 YouTube 中的示例：

```
 <script type="text/javascript">

    var params = { allowScriptAccess: "always" };
    var atts = { id: "myytplayer", wmode: "transparent" };
    swfobject.embedSWF("http://www.youtube.com/v/VIDEO_ID&enablejsapi=1&playerapiid=ytplayer", 
                       "ytapiplayer", "425", "356", "8", null, null, params, atts);

  </script> 
```

然后您应该能够使用 CSS/DHTML 在 YouTube 电影上绘制注释。

* * *

## 回答 #2

> 赞同：8
> 
> 时间：2008-09-20T02:28:20.793

Joe Berkovitz 编写了一个示例应用程序`ReviewTube`，名为“允许用户为任何 YouTube 视频创建基于时间的字幕，类似于隐藏式字幕。这些字幕可以公开访问，并且该网站的访问者可以浏览带有字幕的视频集。想想它是 YouTube 的“字幕涂鸦墙”！”

该应用程序是用于演示构建 Flex 应用程序的 MVCS 框架/方法的示例。

[http://www.joeberkovitz.com/blog/reviewtube/](http://www.joeberkovitz.com/blog/reviewtube/)

不确定这是否有助于彩色矩形等，但这是一个不错的起点。

* * *

## 回答 #3

> 赞同：5
> 
> 时间：2008-08-10T10:44:36.443

播放器本身有一个[Javascript API](http://code.google.com/apis/youtube/js_api_reference.html)，如果您选择制作自己的`annotation-thingamajig`.

# linux - 每个虚拟主机的error_log？

> ID：176
> 
> 赞同：123
> 
> 时间：2008-08-01T18:37:40.150
> 
> 标签：linux, apache, virtualhost

在一台运行 Apache 和 PHP 5 的 Linux 服务器上，我们有多个带有单独日志文件的虚拟主机。我们似乎无法将`error_log`虚拟主机之间的 php 分开。

`<Location>`在中覆盖此设置`httpd.conf`似乎没有任何作用。

有没有办法`error_logs`为每个虚拟主机设置单独的 php？

* * *

## 回答 #1

> 赞同：144
> 
> 时间：2010-08-26T15:29:29.597

如果有人来看它应该是这样的：

```
<VirtualHost *:80>
    ServerName example.com
    DocumentRoot /var/www/domains/example.com/html
    ErrorLog /var/www/domains/example.com/apache.error.log
    CustomLog /var/www/domains/example.com/apache.access.log common
    php_flag log_errors on
    php_flag display_errors on
    php_value error_reporting 2147483647
    php_value error_log /var/www/domains/example.com/php.error.log
</VirtualHost> 
```

这仅用于*开发*，因为`display_error`已打开。您会注意到 Apache 错误日志与 PHP 错误日志是分开的。好东西在`php.error.log`。

看看这里的`error_reporting`关键[http://www.php.net/manual/en/errorfunc.configuration.php#ini.error-reporting](http://www.php.net/manual/en/errorfunc.configuration.php#ini.error-reporting)

* * *

## 回答 #2

> 赞同：88
> 
> 时间：2008-08-01T19:58:45.837

要设置*Apache*（*而不是 PHP*）日志，最简单的方法是：

```
<VirtualHost IP:Port>
   # Stuff,
   # More Stuff,
   ErrorLog /path/where/you/want/the/error.log
</VirtualHost> 
```

如果没有前导“/”，则假定是相对的。

[Apache 错误日志页面](http://httpd.apache.org/docs/1.3/mod/core.html#errorlog)

* * *

## 回答 #3

> 赞同：14
> 
> 时间：2008-08-02T01:10:41.027

我通常只是在一个`.htaccess`文件*或*`vhost.conf`我正在处理的域中指定它。将此添加到以下文件之一：

```
php_admin_value error_log "/var/www/vhosts/example.com/error_log" 
```

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2008-08-01T22:20:05.117

error_log() 的默认行为是输出到 Apache 错误日志。如果这没有发生，请检查您的 php.ini 设置中的 error_log 指令。保持未设置以将 Apache 日志文件用于当前虚拟主机。

* * *

## 回答 #5

> 赞同：7
> 
> 时间：2010-04-02T20:50:36.650

不要设置`error_log`你的`syslog`东西去哪里`eg /var/log/apache2`，因为它们的错误会被`ErrorLog`. `subdir`相反，在您的*项目文件夹*中为日志创建一个并执行`php_value` `error_log "/path/to/project/logs"`. 这适用于`.htaccess` *文件和虚拟主机*。还要确保你`php_flag` `log_errors`穿上

* * *

## 回答 #6

> 赞同：6
> 
> 时间：2008-08-29T06:13:17.963

尝试添加`php_value error_log '/path/to/php_error_log`到您的 VirtualHost 配置。

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2008-09-22T23:29:15.800

是的，你可以试试

```
php_value error_log "/var/log/php_log" 
```

或者，如果用户想要进行日志记录，您可以让用户在脚本的开头使用`.htaccess`。`ini_set()`

另一种选择是启用脚本默认到`php.ini`包含脚本的文件夹中，然后转到用户/主机的根文件夹，然后到服务器的根目录，或类似的东西。这将允许主机添加他们自己的`php.ini`值和他们自己的`error_log`位置。

* * *

## 回答 #8

> 赞同：5
> 
> 时间：2009-07-02T23:54:59.463

```
php_value error_log "/var/log/httpd/vhost_php_error_log" 
```

它对我有用，但我必须更改日志文件的权限。

否则 Apache 会将日志写入其`error_log`.

* * *

## 回答 #9

> 赞同：4
> 
> 时间：2008-08-09T02:51:15.417

我的 Apache 在 httpd.conf 中有类似的东西。只需更改 ErrorLog 和 CustomLog 设置

```
<VirtualHost myvhost:80>
    ServerAdmin webmaster@dummy-host.example.com
    DocumentRoot /opt/web
    ServerName myvhost
    ErrorLog logs/myvhost-error_log
    CustomLog logs/myvhost-access_log common
</VirtualHost> 
```

* * *

## 回答 #10

> 赞同：3
> 
> 时间：2008-09-22T23:22:10.077

你可以试试：

```
 <VirtualHost myvhost:80>
       php_value error_log "/var/log/httpd/vhost_php_error_log"
    </Virtual Host> 
```

但我不确定它是否会起作用。我在我的网站上尝试过，但没有成功。

* * *

## 回答 #11

> 赞同：2
> 
> 时间：2018-05-31T06:58:39.437

创建简单的虚拟主机：

示例主机名：-`thecontrolist.localhost`

1.  C:\Windows\System32\驱动程序\等

    `127.0.0.1 thecontrolist.localhost` 在主机文件中

2.  C:\xampp\apache\conf\extra\httpd-vhosts.conf

    ```
    <VirtualHost *>
      ServerName thecontrolist.localhost
      ServerAlias thecontrolist.localhost
      DocumentRoot "/xampp/htdocs/thecontrolist"
      <Directory "/xampp/htdocs/thecontrolist">
        Options +Indexes +Includes +FollowSymLinks +MultiViews
        AllowOverride All
        Require local
      </Directory>
    </VirtualHost> 
    ```

3.  不要忘记重新启动您的 apache。更多[检查](https://wiki.apache.org/httpd/ExampleVhosts)这个链接

# algorithm - 创建色轮的功能

> ID：180
> 
> 赞同：71
> 
> 时间：2008-08-01T18:42:19.343
> 
> 标签：algorithm, language-agnostic, colors, color-space

这是我多次伪解决的问题，但从未完全找到解决方案。

问题是想出一种方法来生成`N`颜色，尽可能区分`N`参数在哪里。

* * *

## 回答 #1

> 赞同：27
> 
> 时间：2008-08-02T19:03:52.170

我对此的第一个想法是“如何在一个空间中生成 N 个向量，使彼此之间的距离最大化”。

您可以看到 RGB（或您使用的任何其他构成颜色空间基础的比例）只是向量。看看[Random Point Picking](http://mathworld.wolfram.com/topics/RandomPointPicking.html)。一旦你有一组最大化分开的向量，你可以将它们保存在哈希表或其他东西中以备后用，然后对它们执行随机旋转以获得你想要的所有颜色，这些颜色彼此之间的距离最大！

多考虑这个问题，最好将颜色以线性方式映射，可能按字典顺序（0,0,0）→（255,255,255），然后均匀分布。

我真的不知道这将如何运作，但它应该因为，让我们说：

```
n = 10 
```

我们知道我们有 16777216 种颜色 (256^3)。

我们可以使用[Buckles 算法 515](https://stackoverflow.com/questions/561/using-combinations-of-sets-as-test-data#794)来查找按字典顺序索引的颜色。![\frac {\binom {256^3} {3}} {n} * i](../Images/512a4be8f66860652fcb7534b40445ec.png). 您可能必须编辑算法以避免溢出，并可能增加一些小的速度改进。

* * *

## 回答 #2

> 赞同：20
> 
> 时间：2008-09-12T19:00:13.403

最好在“感知均匀”色彩空间中找到最远的颜色，例如 CIELAB（使用 L*、a*、b* 坐标之间的欧几里德距离作为距离度量），然后转换为您选择的色彩空间。通过调整色彩空间以近似人类视觉系统中的非线性来实现感知均匀性。

* * *

## 回答 #3

> 赞同：11
> 
> 时间：2008-09-18T16:01:24.593

一些相关资源：

[ColorBrewer](http://colorbrewer.org) - 设计用于在地图上最大程度区分的颜色集。

[Escaping RGBland: Selecting Colors for Statistical Graphics](http://epub.wu-wien.ac.at/dyn/openURL?id=oai:epub.wu-wien.ac.at:epub-wu-01_c87) - 一份技术报告，描述了一组用于在 hcl 颜色空间中生成良好（即最大可区分）颜色集的算法。

* * *

## 回答 #4

> 赞同：10
> 
> 时间：2008-09-27T16:39:09.837

这是一些代码，用于在指定亮度的 HSL 色轮周围均匀分配 RGB 颜色。

```
class cColorPicker
{
public:
    void Pick( vector<DWORD>&v_picked_cols, int count, int bright = 50 );
private:
    DWORD HSL2RGB( int h, int s, int v );
    unsigned char ToRGB1(float rm1, float rm2, float rh);
};
/**

  Evenly allocate RGB colors around HSL color wheel

  @param[out] v_picked_cols  a vector of colors in RGB format
  @param[in]  count   number of colors required
  @param[in]  bright  0 is all black, 100 is all white, defaults to 50

  based on Fig 3 of http://epub.wu-wien.ac.at/dyn/virlib/wp/eng/mediate/epub-wu-01_c87.pdf?ID=epub-wu-01_c87

*/

void cColorPicker::Pick( vector<DWORD>&v_picked_cols, int count, int bright )
{
    v_picked_cols.clear();
    for( int k_hue = 0; k_hue < 360; k_hue += 360/count )
        v_picked_cols.push_back( HSL2RGB( k_hue, 100, bright ) );
}
/**

  Convert HSL to RGB

  based on http://www.codeguru.com/code/legacy/gdi/colorapp_src.zip

*/

DWORD cColorPicker::HSL2RGB( int h, int s, int l )
{
    DWORD ret = 0;
    unsigned char r,g,b;

    float saturation = s / 100.0f;
    float luminance = l / 100.f;
    float hue = (float)h;

    if (saturation == 0.0) 
    {
      r = g = b = unsigned char(luminance * 255.0);
    }
    else
    {
      float rm1, rm2;

      if (luminance <= 0.5f) rm2 = luminance + luminance * saturation;  
      else                     rm2 = luminance + saturation - luminance * saturation;
      rm1 = 2.0f * luminance - rm2;   
      r   = ToRGB1(rm1, rm2, hue + 120.0f);   
      g = ToRGB1(rm1, rm2, hue);
      b  = ToRGB1(rm1, rm2, hue - 120.0f);
    }

    ret = ((DWORD)(((BYTE)(r)|((WORD)((BYTE)(g))<<8))|(((DWORD)(BYTE)(b))<<16)));

    return ret;
}

unsigned char cColorPicker::ToRGB1(float rm1, float rm2, float rh)
{
  if      (rh > 360.0f) rh -= 360.0f;
  else if (rh <   0.0f) rh += 360.0f;

  if      (rh <  60.0f) rm1 = rm1 + (rm2 - rm1) * rh / 60.0f;   
  else if (rh < 180.0f) rm1 = rm2;
  else if (rh < 240.0f) rm1 = rm1 + (rm2 - rm1) * (240.0f - rh) / 60.0f;      

  return static_cast<unsigned char>(rm1 * 255);
}

int _tmain(int argc, _TCHAR* argv[])
{
    vector<DWORD> myCols;
    cColorPicker colpick;
    colpick.Pick( myCols, 20 );
    for( int k = 0; k < (int)myCols.size(); k++ )
        printf("%d: %d %d %d\n", k+1,
        ( myCols[k] & 0xFF0000 ) >>16,
        ( myCols[k] & 0xFF00 ) >>8,
        ( myCols[k] & 0xFF ) );

    return 0;
} 
```

* * *

## 回答 #5

> 赞同：5
> 
> 时间：2008-08-02T18:16:07.867

设置颜色的顺序不也是一个因素吗？

就像如果你使用 Dillie-Os 的想法，你需要尽可能多地混合颜色。0 64 128 256 是从一个到下一个。但是轮子中的 0 256 64 128 会更“分开”

这有意义吗？

* * *

## 回答 #6

> 赞同：3
> 
> 时间：2008-08-01T19:36:46.067

我读过人眼无法区分少于 4 个值的地方。所以这是要记住的事情。以下算法无法对此进行补偿。

我不确定这是否正是您想要的，但这是随机生成非重复颜色值的一种方法：

（注意，前面的伪代码不一致）

```
//colors entered as 0-255 [R, G, B]
colors = []; //holds final colors to be used
rand = new Random();

//assumes n is less than 16,777,216
randomGen(int n){
   while (len(colors) < n){
      //generate a random number between 0,255 for each color
      newRed = rand.next(256);
      newGreen = rand.next(256);
      newBlue = rand.next(256);
      temp = [newRed, newGreen, newBlue];
      //only adds new colors to the array
      if temp not in colors {
         colors.append(temp);
      }
   }
} 
```

您可以优化它以获得更好的可见性的一种方法是比较每种新颜色与数组中所有颜色之间的距离：

```
for item in color{
   itemSq = (item[0]^2 + item[1]^2 + item[2]^2])^(.5);
   tempSq = (temp[0]^2 + temp[1]^2 + temp[2]^2])^(.5);
   dist = itemSq - tempSq;
   dist = abs(dist);
}
//NUMBER can be your chosen distance apart.
if dist < NUMBER and temp not in colors {
   colors.append(temp);
} 
```

但是这种方法会显着减慢您的算法。

另一种方法是放弃随机性并系统地检查每 4 个值，并在上面的示例中为数组添加一种颜色。

* * *

## 回答 #7

> 赞同：3
> 
> 时间：2011-10-19T01:58:23.423

```
function random_color($i = null, $n = 10, $sat = .5, $br = .7) {
    $i = is_null($i) ? mt_rand(0,$n) : $i;
    $rgb = hsv2rgb(array($i*(360/$n), $sat, $br));
    for ($i=0 ; $i<=2 ; $i++) 
        $rgb[$i] = dechex(ceil($rgb[$i]));
    return implode('', $rgb);
}

function hsv2rgb($c) { 
    list($h,$s,$v)=$c; 
    if ($s==0) 
        return array($v,$v,$v); 
    else { 
        $h=($h%=360)/60; 
        $i=floor($h); 
        $f=$h-$i; 
        $q[0]=$q[1]=$v*(1-$s); 
        $q[2]=$v*(1-$s*(1-$f)); 
        $q[3]=$q[4]=$v; 
        $q[5]=$v*(1-$s*$f); 
        return(array($q[($i+4)%6]*255,$q[($i+2)%6]*255,$q[$i%6]*255)); //[1] 
    } 
} 
```

因此，只需调用标识颜色、可能颜色数量、饱和度和亮度的`random_color()`函数即可。`$i``$n``$sat``$br`

* * *

## 回答 #8

> 赞同：3
> 
> 时间：2014-02-07T17:43:13.243

为了实现“最可区分”，我们需要使用像 Lab（或任何其他感知线性颜色空间）这样的感知色彩空间，而不是 RGB。此外，我们可以量化这个空间以减小空间的大小。

使用所有可能的量化条目生成完整的 3D 空间，并使用 运行 K-means 算法`K=N`。由此产生的中心/“手段”应该彼此之间几乎是最可区分的。

# c# - 浮点数解析：是否有 Catch All 算法？

> ID：192
> 
> 赞同：71
> 
> 时间：2008-08-01T19:23:13.117
> 
> 标签：c#, .net, asp.net, internationalization, globalization

多元文化编程的有趣部分之一是数字格式。

*   美国人使用 10,000.50
*   德国人使用 10.000,50
*   法国使用 10 000,50

我的第一种方法是获取字符串，将其向后解析，直到遇到分隔符并将其用作小数分隔符。这样做有一个明显的缺陷：10.000 会被解释为 10。

另一种方法：如果字符串包含 2 个不同的非数字字符，则使用最后一个作为小数分隔符并丢弃其他字符。如果我只有一个，请检查它是否多次出现，如果出现则丢弃它。如果它只出现一次，请检查它后面是否有 3 位数字。如果是，则丢弃它，否则，将其用作小数分隔符。

显而易见的“最佳解决方案”是检测用户的文化或浏览器，但如果您有一个使用 en-US Windows/浏览器的法国人，这将不起作用。

`Double.(Try)Parse()`.net 框架是否包含一些比尝试自动检测数字格式更好的神秘黑魔法浮点解析器？

* * *

## 回答 #1

> 赞同：31
> 
> 时间：2008-08-01T23:17:53.657

我认为在这种情况下你能做的最好的事情就是听取他们的意见，然后向他们展示你认为他们的意思。如果他们不同意，请向他们展示您期望的格式并让他们再次输入。

* * *

## 回答 #2

> 赞同：27
> 
> 时间：2008-08-01T20:02:08.357

我不知道问题的 ASP.NET 方面，但 .NET 有一个非常强大的类：[System.Globalization.CultureInfo](https://docs.microsoft.com/dotnet/api/system.globalization.cultureinfo)。您可以使用以下代码解析包含双精度值的字符串：

```
double d = double.Parse("100.20", CultureInfo.CurrentCulture);
//  -- OR --
double d = double.Parse("100.20", CultureInfo.CurrentUICulture); 
```

如果 ASP.NET 以某种方式（即使用 HTTP 请求标头）将当前用户的 CultureInfo 传递给 CultureInfo.CurrentCulture 或 CultureInfo.CurrentUICulture，这些都可以正常工作。

* * *

## 回答 #3

> 赞同：12
> 
> 时间：2008-08-01T20:05:12.750

你不可能取悦所有人。如果我输入十作为 10.000，而有人输入一万作为 10.000，如果不了解输入的文化，您将无法处理。以某种方式检测文化（浏览器、系统设置 - 用例是什么？ASP？内部应用程序，还是向世界开放？），或提供预期格式的示例，并尽可能使用最宽松的解析器。大概是这样的：

```
double d = Double.Parse("5,000.00", NumberStyles.Any, CultureInfo.InvariantCulture); 
```

* * *

## 回答 #4

> 赞同：10
> 
> 时间：2008-08-02T12:28:12.517

法语和英语中的 12.345 之间的差异是 1000 倍。如果您提供 max < 1000*min 的预期范围，您可以轻松猜到。

以一个人（包括婴儿和儿童）的身高为例，单位为毫米。

通过使用 200-3000 的范围，1.800 或 1,800 的输入可以明确地解释为 1 米和 80 厘米，而 912.300 或 912,300 的输入可以明确地解释为 91 厘米和 2.3 毫米。

# sql-server - 升级 SQL Server 6.5

> ID：194
> 
> 赞同：40
> 
> 时间：2008-08-01T19:26:37.883
> 
> 标签：sql-server, migration

是的，我知道。2008 年的运行副本的存在`SQL Server 6.5`是荒谬的。

`6.5`那规定，从 迁移到的最佳方式是`2005`什么？有没有直接的路径？我发现的大多数文档都涉及升级`6.5`到`7`.

我是否应该忘记本机`SQL Server`升级实用程序，编写所有对象和数据的脚本，然后尝试从头开始重新创建？

我打算在这个周末尝试升级，但服务器问题将其推迟到下一个。因此，任何想法都会在一周内受到欢迎。

*更新。这就是我最终这样做的方式：*

*   备份有问题的数据库并在`6.5`.
*   `SQL Server 2000`对Master执行`instcat.sql`。`6.5`这允许`SQL Server 2000`OLEDB 提供程序连接到`6.5`.
*   使用`SQL Server 2000`'sstandalone`"Import and Export Data"`创建 DTS 包，`OLEDB`用于连接 6.5。这成功地将所有的表复制`6.5`到一个新的`2005`数据库中（也使用`OLEDB`）。
*   使用`6.5`的企业管理器将所有数据库的索引和触发器脚本化为 .sql 文件。
*   在 2005 年的 Management Studio 中针对数据库的新副本执行该 .sql 文件。
*   使用 6.5 的企业管理器编写所有存储过程的脚本。
*   `.sql`针对`2005`数据库执行该文件。几十个存储过程存在问题，使它们与`2005`. 主要是`non-ANSI joins`和`quoted identifier issues`。
*   更正了所有这些问题并重新执行了`.sql`文件。
*   重新创建了`6.5`的登录名`2005`并授予他们适当的权限。

更正存储过程时有一些冲洗/重复（有数百个需要更正），但升级效果很好。

能够使用 Management Studio 而不是`Query Analyzer`and`Enterprise Manager 6.5`是一个如此惊人的区别。一些需要 20-30 秒的报表查询`6.5 database`现在在 1-2 秒内运行，无需任何修改、新索引或任何东西。我没想到会有这种立竿见影的改善。

* * *

## 回答 #1

> 赞同：11
> 
> 时间：2008-08-01T19:34:49.067

嘿，我也仍然被困在那个营地。我们必须支持的第三方应用程序最终会进入 2K5，所以我们几乎已经完蛋了。但我能感觉到你的痛苦 8^D

也就是说，从我从我们的 DBA 那里听到的一切，关键是先将数据库转换为 8.0 格式，然后转到 2005。我相信他们为此使用了内置的迁移/升级工具。在 6.5 和 8.0 之间有一些大步骤比直接从 6.5 到 2005 解决得更好。

如果您还不知道的话，您最大的痛苦是 DTS 已被 SSIS 取代。有一个 shell 类型的模块可以运行您现有的 DTS 包，但您需要在 SSIS 中手动重新创建它们。这是否容易取决于包本身的复杂性，但到目前为止我已经完成了一些工作并且它们非常顺利。

* * *

## 回答 #2

> 赞同：6
> 
> 时间：2008-08-04T01:29:18.307

您可以将 6.5 升级到 SQL Server 2000。您可能更容易获得 SQL Server 或 2000 版的 MSDE。微软有一个关于[从 6.5 到 2000](http://www.microsoft.com/technet/prodtechnol/sql/2000/deploy/sqlugrd.mspx#EQFAC)的页面。一旦有了 2000 格式的数据库，SQL Server 2005 就可以轻松地将其升级到 2005 格式。

如果您没有 SQL Server 2000，您可以直接从 Microsoft[下载 MSDE 2000版本。](http://www.microsoft.com/downloads/details.aspx?familyid=413744D1-A0BC-479F-BAFA-E4B278EB9147&displaylang=en)

* * *

## 回答 #3

> 赞同：3
> 
> 时间：2008-08-03T23:56:54.077

我绝不是权威，但我相信唯一受支持的路径是从 6.5 到 7。当然那将是最理智的路线，那么我相信您可以轻松地从 7 直接迁移到 2005。

至于编写所有对象的脚本 - 我建议不要这样做，因为您将不可避免地错过一些东西（除非您的数据库真的很琐碎）。

* * *

## 回答 #4

> 赞同：3
> 
> 时间：2008-08-04T00:23:55.690

如果你能找到 Visual Studio 6.0 的专业版或其他一些超级企业版——它附带了一份[MSDE](http://en.wikipedia.org/wiki/MSDE)（基本上是 SQL Express 的前身）。我相信 MSDE 2000 仍然可以从 Microsoft 免费下载，但我不知道您是否可以直接从 6.5 迁移到 2000。

我认为从概念上讲，您不太可能面临任何危险。然而，多年的实践告诉我，您总是会错过一些不会立即显现的对象、权限或其他数据库项目。如果您可以编写整个转储脚本，那就更好了。因为您不太可能错过某些东西 - 如果您确实错过了某些东西，它可以很容易地添加到脚本中并修复。我会避免像瘟疫一样的任何手动步骤（除了按一次回车键）。

# php - 使用 h1 到 h6 从数组生成标签云的最佳方法是什么？

> ID：227
> 
> 赞同：78
> 
> 时间：2008-08-01T21:40:55.833
> 
> 标签：php, arrays, tag-cloud

我有以下数组：

```
$artist = array("the roots", "michael jackson", "billy idol", "more", "and more", "and_YET_MORE");
$count = array(5, 3, 9, 1, 1, 3); 
```

我想生成一个标签云，其中包含标签中数字较高的艺术家和`$count`封闭`h6`标签中数字最少的艺术家`h1`。

* * *

## 回答 #1

> 赞同：41
> 
> 时间：2010-05-31T11:53:57.940

您还需要向其添加对数函数。（取自我的 Drupal 模块 tagadelic，用于创建标签云[http://drupal.org/project/tagadelic](http://drupal.org/project/tagadelic)）：

```
db_query('SELECT COUNT(*) AS count, id, name FROM ... ORDER BY count DESC');

$steps = 6;
$tags = array();
$min = 1e9;
$max = -1e9;

while ($tag = db_fetch_object($result)) {
    $tag->number_of_posts = $tag->count; #sets the amount of items a certain tag has attached to it
    $tag->count = log($tag->count);
    $min = min($min, $tag->count);
    $max = max($max, $tag->count);
    $tags[$tag->tid] = $tag;
}
// Note: we need to ensure the range is slightly too large to make sure even
// the largest element is rounded down.
$range = max(.01, $max - $min) * 1.0001;

foreach ($tags as $key => $value) {
    $tags[$key]->weight = 1 + floor($steps * ($value->count - $min) / $range);
} 
```

然后在您的视图或模板中：

```
foreach ($tags as $tag) {
    $output .= "<h$tag->weight>$tag->name</h$tag->weight>"
} 
```

* * *

## 回答 #2

> 赞同：32
> 
> 时间：2008-08-01T23:10:56.510

从我的头顶上...

```
$artist = array("the roots","michael jackson","billy idol","more","and more","and_YET_MORE");
$count = array(5,3,9,1,1,3);
$highest = max($count);
for (int $x = 0; $x < count($artist); $x++)
{
    $normalized = $count[$x] / $highest;
    $heading = ceil($normalized * 6); // 6 heading types
    echo "<h".$heading.">".$artist[$x]."</h".$heading.">";
} 
```

* * *

## 回答 #3

> 赞同：26
> 
> 时间：2008-08-03T13:01:24.243

也许这有点学术和离题，但`hX`由于文档结构和所有类似的原因，标签可能不是标签云的最佳选择。

也许`span`s 或 an`ol`具有适当的类属性（加上一些 CSS）？

* * *

## 回答 #4

> 赞同：9
> 
> 时间：2008-09-17T21:29:41.770

已经使用这个片段一段时间了，信用是 prism-perfect.net。虽然不使用 H 标签

```
<div id="tags">
    <div class="title">Popular Searches</div>
    <?php
        // Snippet taken from [prism-perfect.net]

        include "/path/to/public_html/search/settings/database.php";
        include "/path/to/public_html/search/settings/conf.php";

        $query = "SELECT query AS tag, COUNT(*) AS quantity
        FROM sphider_query_log
        WHERE results > 0
        GROUP BY query
        ORDER BY query ASC
        LIMIT 10";

        $result = mysql_query($query) or die(mysql_error());

        while ($row = mysql_fetch_array($result)) {

            $tags[$row['tag']] = $row['quantity'];
        }

        // change these font sizes if you will
        $max_size = 30; // max font size in %
        $min_size = 11; // min font size in %

        // get the largest and smallest array values
        $max_qty = max(array_values($tags));
        $min_qty = min(array_values($tags));

        // find the range of values
        $spread = $max_qty - $min_qty;
        if (0 == $spread) { // we don't want to divide by zero
            $spread = 1;
        }

        // determine the font-size increment
        // this is the increase per tag quantity (times used)
        $step = ($max_size - $min_size)/($spread);

        // loop through our tag array
        foreach ($tags as $key => $value) {

            // calculate CSS font-size
            // find the $value in excess of $min_qty
            // multiply by the font-size increment ($size)
            // and add the $min_size set above
            $size = $min_size + (($value - $min_qty) * $step);
            // uncomment if you want sizes in whole %:
            // $size = ceil($size);

            // you'll need to put the link destination in place of the /search/search.php...
            // (assuming your tag links to some sort of details page)
            echo '<a href="/search/search.php?query='.$key.'&search=1" style="font-size: '.$size.'px"';
            // perhaps adjust this title attribute for the things that are tagged
            echo ' title="'.$value.' things tagged with '.$key.'"';
            echo '>'.$key.'</a> ';
            // notice the space at the end of the link
        }
    ?>
</div> 
```

* * *

## 回答 #5

> 赞同：7
> 
> 时间：2008-08-01T23:58:35.650

@瑞安

这是正确的，但它实际上使数量最少的标签更大。此代码已经过测试：

```
$artist = array("the roots","michael jackson","billy idol","more","and more","and_YET_MORE");
$count = array(5,3,9,1,1,3);
$highest = max($count);
for ($x = 0; $x < count($artist); $x++) {
    $normalized =  ($highest - $count[$x]+1) / $highest;
    $heading = ceil($normalized * 6); // 6 heading types
    echo "<h$heading>{$artist[$x]}</h$heading>";
} 
```

* * *

## 回答 #6

> 赞同：2
> 
> 时间：2010-07-14T18:19:27.060

此方法适用于`SQL/PostgreSQL`狂热分子。它在数据库中完成整个工作，并打印带有“slugified”链接的文本。它`ORM`仅将 Doctrine 用于 sql 调用，我没有使用对象。假设我们有 10 个尺寸：

```
public function getAllForTagCloud($fontSizes = 10)
{
    $sql = sprintf("SELECT count(tag) as tagcount,tag,slug, 
    floor((count(*) * %d )/(select max(t) from 
        (select count(tag) as t from magazine_tag group by tag) t)::numeric(6,2)) 
         as ranking 
         from magazine_tag mt group by tag,slug", $fontSizes);

    $q = Doctrine_Manager::getInstance()->getCurrentConnection();
    return $q->execute($sql);
} 
```

然后你用一些 CSS 类打印它们，从 .tagranking10 （最好的）到 .tagranking1 （最差的）：

```
<?php foreach ($allTags as $tag): ?>
    <span class="<?php echo 'tagrank'.$tag['ranking'] ?>">
        <?php echo sprintf('<a rel="tag" href="/search/by/tag/%s">%s</a>', 
            $tag['slug'], $tag['tag']
        ); ?>
    </span>
<?php endforeach; ?> 
```

这是`CSS`：

```
/* put your size of choice */
.tagrank1{font-size: 0.3em;}
.tagrank2{font-size: 0.4em;}
.tagrank3{font-size: 0.5em;} 
/* go on till tagrank10 */ 
```

此方法显示所有标签。如果你有很多，你可能不希望你的标签云成为*标签风暴*。`HAVING TO`在这种情况下，您将在 SQL 查询中附加一个子句：

```
-- minimum tag count is 8 --

HAVING count(tag) > 7 
```

就这样

* * *

## 回答 #7

> 赞同：1
> 
> 时间：2008-10-02T21:47:32.207

作为 Rails 的助手：

```
def tag_cloud (strings, counts)
    max = counts.max
    strings.map { |a| "<span style='font-size:#{((counts[strings.index(a)] * 4.0)/max).ceil}em'>#{a}</span> "  }
end 
```

从视图中调用它：

```
<%= tag_cloud($artists, $counts) %> 
```

这会输出`<span style='font-size:_em'>`数组中的元素，这些元素将被转换为视图中的字符串，最终呈现如下：

```
<span style='font-size:3em'>the roots</span>
<span style='font-size:2em'>michael jackson</span> 
<span style='font-size:4em'>billy idol</span> 
<span style='font-size:1em'>more</span> 
<span style='font-size:1em'>and more</span> 
<span style='font-size:2em'>and_YET_MORE</span> 
```

最好有一个`class`属性并引用上面 Brendan 提到的样式表中的类。比在`h1-h6`语义上使用要好得多，并且使用`<span>`.

* * *

## 回答 #8

> 赞同：1
> 
> 时间：2017-01-28T04:39:42.870

我知道这是一个非常古老的帖子，但我仍然在发布我的观点，因为它可能对将来的某人有所帮助。

这是我在我的网站中使用的标签云： [http ://www.vbausefulcodes.in/](http://www.vbausefulcodes.in/)

```
<?php
$input= array("vba","macros","excel","outlook","powerpoint","access","database","interview questions","sendkeys","word","excel projects","visual basic projects","excel vba","macro","excel visual basic","tutorial","programming","learn macros","vba examples");

$rand_tags = array_rand($input, 5);
for ($x = 0; $x <= 4; $x++) {
    $size = rand ( 1 , 4 );
    echo "<font size='$size'>" . $input[$rand_tags[$x]] . " " . "</font>";
}

echo "<br>";
$rand_tags = array_rand($input, 7);
for ($x = 0; $x <= 6; $x++) {
    $size = rand ( 1 , 4 );
    echo "<font size='$size'>" . $input[$rand_tags[$x]] . " " . "</font>";
}

echo "<br>";
$rand_tags = array_rand($input, 5);
for ($x = 0; $x <= 4; $x++) {
    $size = rand ( 1 , 4 );
    echo "<font size='$size'>" . $input[$rand_tags[$x]] . " " . "</font>";
}
?> 
```

# windows - 以编程方式使用 mailto 协议注册 Windows 程序

> ID：231
> 
> 赞同：41
> 
> 时间：2008-08-01T22:08:14.453
> 
> 标签：windows, mailto

如何使`mailto:`链接注册到我的程序中？

然后我将如何在我的程序中处理该事件？

我从快速谷歌搜索中找到的大多数解决方案都是如何手动执行此操作，但如果我的程序用户单击一个按钮，我需要为他们自动执行此操作，例如“设置为默认电子邮件客户端”。

#Edit：删除了对 Delphi 的引用，因为答案与您的语言无关。

* * *

## 回答 #1

> 赞同：19
> 
> 时间：2008-08-05T01:49:25.940

*@Dillie-O：您的回答使我朝着正确的方向前进（我应该期望它只是注册表更改）并且我得到了这个工作。但我将把它标记为答案，因为我将提供一些我在处理这个问题时发现的额外信息。*

这个问题的解决方案实际上并不取决于您使用的编程语言，只要有一些方法可以修改 Windows 注册表设置。

最后，这是答案：

*   要将程序与计算机上**所有用户**的 mailto 协议相关联，请将 HKEY_CLASSES_ROOT\mailto\shell\open\command 默认值更改为：
    “*您的程序的可执行文件*”“%1”
*   要将[程序与**当前用户**](http://windowsxp.mvps.org/permail.htm)的 mailto 协议关联，请将 HKEY_CURRENT_USER\Software\Classes\mailto\shell\open\command 默认值更改为：
    “*您的程序的可执行文件*”“%1”

%1 将替换为整个 mailto URL。例如，给定链接：

```
<a href="mailto:user@example.com">Email me</a> 
```

将执行以下内容：
“*您的程序的可执行文件*”“mailto:user@example.com”

更新（通过 shellscape 的评论）：
从 Windows 8 开始，此方法不再按预期工作。Win8 强制执行以下密钥：HKEY_CURRENT_USER\Software\Microsoft\Windows\Shell\Associati‌​ons\URLAssociations\‌​MAILTO\UserChoice，所选应用程序的 ProgID 已对其进行哈希处理且无法伪造。这是皇家皮塔饼。

* * *

## 回答 #2

> 赞同：13
> 
> 时间：2008-08-01T22:12:30.170

据我所见，有一些注册表项可以设置默认邮件客户端。其中之一是：

系统密钥：`[HKEY_CLASSES_ROOT\mailto\shell\open\command]`

值名称：`(Default)`

数据类型：（`REG_SZ`字符串值）

价值数据：`Mail program command-line`。

我不熟悉`Delphi 7`，但我确信那里有一些*注册表编辑库*可用于修改此值。

有些地方列出的不仅仅是这个*键*，其他地方只是这个键，所以你可能需要稍微测试一下才能找到合适的。

# mysql - SQL Server 2005 执行 MySQL REPLACE INTO？

> ID：234
> 
> 赞同：88
> 
> 时间：2008-08-01T22:13:34.100
> 
> 标签：mysql, sql-server, sql-server-2005

MySQL 有这个非常有用但专有的`REPLACE INTO`SQL 命令。

这可以在 SQL Server 2005 中轻松模拟吗？

开始一个新的事务，`Select()`然后做一个或者`UPDATE`或者`INSERT`和`COMMIT`总是有点痛苦，特别是在应用程序中做它时，因此总是保留两个版本的语句。

我想知道是否有一种简单**通用**的方法可以在 SQL Server 2005 中实现这样的功能？

* * *

## 回答 #1

> 赞同：61
> 
> 时间：2008-08-15T12:50:22.350

这让我对 MSSQL 感到恼火（[在我的博客上咆哮](http://bizvprog.blogspot.com/2008/04/annoying-fundamental-flaw-with-sql.html)）。我希望 MSSQL 支持`upsert`。

@Dillie-O 的代码在旧 SQL 版本中是一个好方法（+1 票），但它仍然基本上是两个 IO 操作（`exists`然后是`update`or `insert`）

[这篇文章](https://stackoverflow.com/questions/13540/insert-update-stored-proc-on-sql-server)有一个更好的方法，基本上是：

```
--try an update
update tablename 
set field1 = 'new value',
    field2 = 'different value',
    ...
where idfield = 7

--insert if failed
if @@rowcount = 0 and @@error = 0
    insert into tablename 
           ( idfield, field1, field2, ... )
    values ( 7, 'value one', 'another value', ... ) 
```

如果是更新，则将其减少到一个 IO 操作，如果是插入，则将其减少到两个。

MS Sql2008`merge`从 SQL:2003 标准引入：

```
merge tablename as target
using (values ('new value', 'different value'))
    as source (field1, field2)
    on target.idfield = 7
when matched then
    update
    set field1 = source.field1,
        field2 = source.field2,
        ...
when not matched then
    insert ( idfield, field1, field2, ... )
    values ( 7,  source.field1, source.field2, ... ) 
```

现在它实际上只是一个 IO 操作，但是代码很糟糕:-(

* * *

## 回答 #2

> 赞同：20
> 
> 时间：2008-08-01T22:22:37.823

您正在寻找的功能传统上称为 UPSERT。至少知道它的名称可能会帮助您找到所需的内容。

我不认为 SQL Server 2005 有任何很好的方法来做到这一点。2008 年引入了可用于完成此操作的 MERGE 语句，如下所示：[http](http://www.databasejournal.com/features/mssql/article.php/3739131) ://www.databasejournal.com/features/mssql/article.php/3739131或[http://blogs.conchango.com/davidportas/archive/ 2007/11/14/SQL-Server-2008-MERGE.aspx](http://blogs.conchango.com/davidportas/archive/2007/11/14/SQL-Server-2008-MERGE.aspx)

Merge 在 2005 年的测试版中可用，但他们在最终版本中将其删除。

* * *

## 回答 #3

> 赞同：17
> 
> 时间：2008-08-01T22:31:36.137

upsert/merge 正在做的事情是......

```
IF EXISTS (SELECT * FROM [Table] WHERE Id = X)
   UPDATE [Table] SET...
ELSE
   INSERT INTO [Table] 
```

所以希望这些文章和这个伪代码的结合可以让事情发生变化。

* * *

## 回答 #4

> 赞同：10
> 
> 时间：2008-09-21T22:05:23.887

我写了[一篇](http://www.samsaffron.com/blog/archive/2007/04/04/14.aspx)关于这个问题的博客文章。

底线是，如果您想要便宜的更新并且想要安全地并发使用，请尝试：

```
update t
set hitCount = hitCount + 1
where pk = @id

if @@rowcount < 1 
begin 
   begin tran
      update t with (serializable)
      set hitCount = hitCount + 1
      where pk = @id
      if @@rowcount = 0
      begin
         insert t (pk, hitCount)
         values (@id,1)
      end
   commit tran
end 
```

这样，您有 1 个更新操作和最多 3 个插入操作。因此，如果您通常进行更新，这是一个安全且便宜的选择。

我也会非常小心，不要使用任何对并发使用不安全的东西。在生产中很容易出现主键违规或重复行。

# .net - 基于 XSD 数据集创建 SQLite 数据库

> ID：246
> 
> 赞同：43
> 
> 时间：2008-08-01T22:34:42.853
> 
> 标签：.net, database, sqlite

有谁知道是否有一种方法可以基于 XSD 创建 SQLite 数据库`DataSet`？过去，我只使用了一个基本的 SQLite 管理器，但`.NET`如果可能的话，我想在我的开发中多融合一些东西。

* * *

## 回答 #1

> 赞同：18
> 
> 时间：2008-10-06T23:58:50.823

我怀疑在一般情况下这很难；XML Schema 允许一些非常奇怪的类型构造。例如，我不确定您将如何进行替换组或对类型限制的扩展。

然而，应该可以很快地将某些东西组合在一起（尤其是从 System.Xml.Schema 中的类映射），它适用于 90% 的模式（即具有一些简单数据类型的序列和选择元素）。

* * *

## 回答 #2

> 赞同：6
> 
> 时间：2008-08-30T09:14:30.083

也许您可以使用 XSL 转换将 XSD 转换为 SQL 表定义。同样，我找不到任何先前的例子，但我认为这是可能的。

我想象一个用于 XSD->SQL 的通用 XSLT，一旦编写，就可以应用于任何这样的场景（并且也是跨平台的）。也许以前有人这样做过......

* * *

## 回答 #3

> 赞同：4
> 
> 时间：2008-08-04T17:05:37.853

我相信您可以编写一个小应用程序，它接受一个 XSD 文件并将其解析为 SQL 脚本。不过，我从来没有见过可以做到这一点的代码，但这并不是说它不存在。

# c# - 向 .NET 应用程序添加脚本功能

> ID：260
> 
> 赞同：80
> 
> 时间：2008-08-01T23:22:08.983
> 
> 标签：c#, .net, scripting, compiler-construction

我有一个用 C# 编写的小游戏。它使用数据库作为后端。这是一个集[换式卡牌游戏](http://en.wikipedia.org/wiki/Collectible_card_game)，我想将卡牌的功能实现为脚本。

我的意思是我本质上有一个接口 ，`ICard`它是一个卡片类实现的 ( `public class Card056: ICard`) 并且它包含一个由游戏调用的函数。

现在，为了使事物可维护/可修改，我希望将每张卡的类作为数据库中的源代码，并在首次使用时对其进行编译。因此，当我必须添加/更改卡片时，我只需将其添加到数据库并告诉我的应用程序刷新，而不需要任何程序集部署（特别是因为我们将讨论每张卡片 1 个程序集，这意味着数百个程序集） .

那可能吗？从源文件注册一个类，然后实例化它，等等。

```
ICard Cards[current] = new MyGame.CardLibrary.Card056();
Cards[current].OnEnterPlay(ref currentGameState); 
```

该语言是 C#，但如果可以使用任何 .NET 语言编写脚本，则额外奖励。

* * *

## 回答 #1

> 赞同：42
> 
> 时间：2008-08-02T01:49:46.220

[Oleg Shilo 的 C# Script 解决方案（在 The Code Project 中](https://www.codeproject.com/Articles/8656/C-Script-The-Missing-Puzzle-Piece)）确实是在您的应用程序中提供脚本功能的一个很好的介绍。

另一种方法是考虑专门为脚本构建的语言，例如[IronRuby](https://en.wikipedia.org/wiki/IronRuby)、[IronPython](https://en.wikipedia.org/wiki/IronPython)或[Lua](https://en.wikipedia.org/wiki/Lua_%28programming_language%29)。

IronPython 和 IronRuby 现在都可以使用。

有关嵌入 IronPython 的指南，请阅读 [如何通过 10 个简单步骤在现有应用程序中嵌入 IronPython 脚本支持](https://blogs.msdn.microsoft.com/jmstall/2005/09/01/how-to-embed-ironpython-script-support-in-your-existing-app-in-10-easy-steps/)。

Lua 是游戏中常用的脚本语言。有一个用于 .NET 的 Lua 编译器，可从 CodePlex 获得——http: [//www.codeplex.com/Nua](http://www.codeplex.com/Nua)

如果您想了解如何在 .NET 中构建编译器，那么该代码库非常适合阅读。

完全不同的角度是尝试[PowerShell](https://en.wikipedia.org/wiki/PowerShell)。有许多将 PowerShell 嵌入应用程序的示例——这里有一个关于该主题的完整项目： [Powershell Tunnel](http://code.msdn.microsoft.com/PowerShellTunnel/Wiki/View.aspx?title=PowerShellTunnel%20Reference "PowerShell 隧道")

* * *

## 回答 #2

> 赞同：8
> 
> 时间：2008-08-02T04:18:15.517

您也许可以为此使用 IronRuby。

否则，我建议您有一个放置预编译程序集的目录。然后，您可以在数据库中引用程序集和类，并使用反射在运行时加载正确的程序集。

如果你真的想在运行时编译你可以使用 CodeDOM，那么你可以使用反射来加载动态程序集。[可能有帮助的 Microsoft 文档文章](https://docs.microsoft.com/dotnet/api/microsoft.csharp.csharpcodeprovider)。

* * *

## 回答 #3

> 赞同：7
> 
> 时间：2008-08-06T16:28:19.783

如果您不想使用 DLR，您可以[使用 Boo（它有一个解释器）](http://docs.codehaus.org/display/BOO/Boo+as+an+embedded+scripting+language)，或者您可以考虑[CodePlex 上的 Script.NET (S#) 项目](https://archive.codeplex.com/?p=scriptdotnet)。使用 Boo 解决方案，您可以在编译脚本或使用解释器之间进行选择，Boo 是一种很好的脚本语言，具有灵活的语法和通过其开放编译器架构可扩展的语言。不过，Script.NET 看起来也不错，您可以轻松地扩展该语言及其开源项目，并使用非常友好的编译器生成器 ( [Irony.net](https://github.com/IronyProject/) )。

* * *

## 回答 #4

> 赞同：6
> 
> 时间：2008-08-02T06:16:23.967

您可以使用任何 DLR 语言，这些语言提供了一种非常轻松地托管您自己的脚本平台的方法。但是，您不必为此使用脚本语言。您可以使用 C# 并使用 C# 代码提供程序对其进行编译。只要你在它自己的AppDomain中加载它，你就可以随心所欲地加载和卸载它。

* * *

## 回答 #5

> 赞同：5
> 
> 时间：2008-09-17T01:41:29.067

我建议使用[LuaInterface](http://luaforge.net/projects/luainterface/)，因为它已经完全实现了 Lua，但看起来 Nua 并不完整，并且可能没有实现一些非常有用的功能（协程等）。

如果你想使用一些外部预打包的 Lua 模块，我建议使用 1.5.x 中的一些东西，而不是 2.x 系列，它构建完全托管的代码并且不能公开必要的 C API。

* * *

## 回答 #6

> 赞同：5
> 
> 时间：2012-07-17T17:08:51.790

我将 LuaInterface1.3 + Lua 5.0 用于 NET 1.1 应用程序。

Boo 的问题在于，每次您动态解析/编译/评估代码时，它都会创建一组 boo 类，因此您会遇到内存泄漏。

另一方面，Lua 不这样做，所以它非常稳定并且工作得很好（我可以将对象从 C# 传递到 Lua 并向后传递）。

到目前为止，我还没有把它放在 PROD 中，但看起来很有希望。

**我确实在使用 LuaInterface + Lua 5.0 的 PROD 中遇到了内存泄漏问题**，因此我使用了 Lua 5.2 并使用 DllImport 直接链接到 C#。**内存泄漏在 LuaInterface 库中。**

Lua 5.2：来自[http://luabinaries.sourceforge.net](http://luabinaries.sourceforge.net)和[http://sourceforge.net/projects/luabinaries/files/5.2/Windows%20Libraries/Dynamic/lua-5.2_Win32_dll7_lib.zip/download](http://sourceforge.net/projects/luabinaries/files/5.2/Windows%20Libraries/Dynamic/lua-5.2_Win32_dll7_lib.zip/download)

一旦我这样做了，我所有的内存泄漏都消失了，应用程序非常稳定。

* * *

## 回答 #7

> 赞同：4
> 
> 时间：2008-08-01T23:49:57.103

是的，我考虑过这一点，但我很快发现另一种领域特定语言 (DSL) 会有点过分。

从本质上讲，他们需要以可能无法预测的方式与我的游戏状态进行交互。例如，一张牌可以有一条规则“当这张牌进场时，你所有的不死随从对飞行敌人的攻击力+3，除非敌人受到祝福”。由于集换式卡牌游戏是基于回合的，GameState 管理器将触发 OnStageX 事件并让卡牌以卡牌需要的任何方式修改其他卡牌或 GameState。

如果我尝试创建一个 DSL，我必须实现一个相当大的功能集，并且可能会不断更新它，这会将维护工作转移到另一部分，而不会实际删除它。

这就是为什么我想继续使用“真正的”.NET 语言，以便基本上能够触发事件并让卡以任何方式（在代码访问安全性的限制内）操纵游戏状态。

* * *

## 回答 #8

> 赞同：4
> 
> 时间：2008-08-10T15:24:23.553

我的部门销售的主要应用程序做了非常相似的事情来提供客户定制（这意味着我不能发布任何来源）。我们有一个加载动态 VB.NET 脚本的 C# 应用程序（尽管可以轻松支持任何 .NET 语言 - 选择 V​​B 是因为定制团队来自 ASP 背景）。

使用 .NET 的 CodeDom，我们使用 VB 从数据库编译脚本`CodeDomProvider`（令人讨厌的是，它默认为 .NET 2，如果您想支持 3.5 功能，您需要将带有“CompilerVersion”=“v3.5”的字典传递给它的构造函数）。使用`CodeDomProvider.CompileAssemblyFromSource`方法编译它（你可以通过设置强制它只在内存中编译。

这将导致内存中有数百个程序集，但是您可以将所有动态类的代码放在一个程序集中，并在发生任何更改时重新编译整个代码。这样做的好处是您可以在测试时添加一个标志以使用[PDB](http://en.wikipedia.org/wiki/Program_database)在磁盘上编译，从而允许您通过动态代码进行调试。

* * *

## 回答 #9

> 赞同：3
> 
> 时间：2010-11-27T02:12:59.443

.NET 的下一个版本（5.0？）有很多关于打开“编译器即服务”的讨论，这将使诸如直接脚本评估之类的事情成为可能。

# c - MessageBox 的 GTK 实现

> ID：263
> 
> 赞同：39
> 
> 时间：2008-08-01T23:27:24.993
> 
> 标签：c, linux, gtk, x11

我一直在尝试`MessageBox`使用 GTK 实现 Win32。该应用程序使用 SDL/OpenGL，因此这不是 GTK 应用程序。

我在函数内部处理初始化（`gtk_init`）之类的东西`MessageBox`，如下所示：

```
int MessageBox(HWND hwnd, const char* text, const char* caption, UINT type)
{
    GtkWidget *window = NULL;
    GtkWidget *dialog = NULL;

    gtk_init(&gtkArgc, &gtkArgv);
    window = gtk_window_new(GTK_WINDOW_TOPLEVEL);
    g_signal_connect(G_OBJECT(window), "delete_event", G_CALLBACK(delete_event), NULL);
    g_signal_connect(G_OBJECT(window), "destroy", G_CALLBACK(destroy), NULL);
    // gcallback calls gtk_main_quit()
    gtk_init_add((GtkFunction)gcallback, NULL);

    if (type & MB_YESNO) {
        dialog = gtk_message_dialog_new(GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_QUESTION, GTK_BUTTONS_YES_NO, text);
    } else {
        dialog = gtk_message_dialog_new(GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_INFO, GTK_BUTTONS_OK, text);
    }

    gtk_window_set_title(GTK_WINDOW(dialog), caption);
    gint result = gtk_dialog_run(GTK_DIALOG(dialog));

    gtk_main();

    gtk_widget_destroy(dialog);

    if (type & MB_YESNO) {
        switch (result) {
        default:
        case GTK_RESPONSE_DELETE_EVENT:
        case GTK_RESPONSE_NO:
            return IDNO;
            break;
        case GTK_RESPONSE_YES:
            return IDYES;
            break;
        }
    }

    return IDOK;
} 
```

现在，我绝不是一个经验丰富的 GTK 程序员，而且我意识到我可能做错了什么。

但是，我的问题是最后一个对话框弹出了这个函数，直到进程退出。有任何想法吗？

* * *

## 回答 #1

> 赞同：17
> 
> 时间：2008-08-03T02:30:05.907

嗯。。好。我建议这样的代码，然后：

```
typedef struct {
    int type;
    int result;
} DialogData;

static gboolean
display_dialog(gpointer user_data)
{
    DialogData *dialog_data = user_data;
    GtkWidget *dialog;

    if (dialog_data->type & MB_YESNO)
        dialog = gtk_message_dialog_new(...);
    else
        dialog = gtk_message_dialog_new(...);

    // Set title, etc.

    dialog_data->result = gtk_dialog_run(...);

    gtk_main_quit();  // Quits the main loop run in MessageBox()

    return FALSE;
}

int MessageBox(...)
{
    DialogData dialog_data;

    dialog_data.type = type;

    gtk_idle_add(display_dialog, &dialog_data);

    gtk_main();

    // Do stuff based on dialog_data.result
} 
```

该结构是必需的，因为您需要传递几条数据。该`gtk_idle_add()`调用添加了一个在主循环运行且空闲时运行的方法，调用的`FALSE`返回值`display_dialog()`意味着它只运行一次。从对话框中得到结果后，我们退出主循环。这将导致`gtk_main()`in 您的 main`MessageBox()`方法返回，您将能够从那里访问结果。

* * *

## 回答 #2

> 赞同：7
> 
> 时间：2010-06-02T15:59:04.987

要使用 GTK+ 管理对话框，请使用 GtkDialog 和[gtk_dialog_run()](http://library.gnome.org/devel/gtk/stable/GtkDialog.html#gtk-dialog-run)而不是自己管理窗口和主循环。

**编辑/附录：**

我的意思是“只使用”：我不明白你为什么要创建一个从不使用的窗口和一个似乎没用的主循环（至少从你发布的代码中）。你可以写一些简短的东西：

```
int MessageBox(HWND hwnd, const char* text, const char* caption, UINT type)
{
    GtkWidget *dialog ;

    /* Instead of 0, use GTK_DIALOG_MODAL to get a modal dialog box */

    if (type & MB_YESNO)
        dialog = gtk_message_dialog_new(NULL, 0, GTK_MESSAGE_QUESTION, GTK_BUTTONS_YES_NO, text );
    else
        dialog = gtk_message_dialog_new(NULL, 0, GTK_MESSAGE_INFO, GTK_BUTTONS_OK, text );

    gtk_window_set_title(GTK_WINDOW(dialog), caption);
    gint result = gtk_dialog_run(GTK_DIALOG(dialog));
    gtk_widget_destroy( GTK_WIDGET(dialog) );

    if (type & MB_YESNO)
    {
        switch (result)
        {
        default:
        case GTK_RESPONSE_DELETE_EVENT:
        case GTK_RESPONSE_NO:
            return IDNO;
        case GTK_RESPONSE_YES:
            return IDYES;
        }
        return IDOK;
    } 
} 
```

* * *

## 回答 #3

> 赞同：5
> 
> 时间：2008-08-02T18:49:30.390

一些东西：

您正在创建（而不是使用）一个不必要的顶层窗口，名为`window`. 您可以删除这些行：

```
window = gtk_window_new(GTK_WINDOW_TOPLEVEL);
g_signal_connect(G_OBJECT(window), "delete_event", G_CALLBACK(delete_event), NULL);
g_signal_connect(G_OBJECT(window), "destroy", G_CALLBACK(destroy), NULL); 
```

此外，流程似乎不太正确。 `gtk_main()`启动 GTK 主循环，该循环一直阻塞，直到有东西退出。 `gtk_dialog_run()`也会启动一个主循环，但只要单击其中一个按钮就会退出。

我认为删除`gtk_init_add()`and`gtk_main()`调用并简单地处理返回值可能就足够了。也不需要`gtk_widget_destroy()`调用，因为对话框窗口会在 gtk_dialog_run() 返回时自动销毁。

# c++ - BerkeleyDB 并发

> ID：264
> 
> 赞同：37
> 
> 时间：2008-08-01T23:28:51.577
> 
> 标签：c++, berkeley-db

*   BerkeleyDB 的 C++ 实现可以合理支持的最佳并发级别是多少？
*   在吞吐量因资源争用而开始受到影响之前，我可以在数据库上敲击多少线程？

我已经阅读了手册并且知道如何设置锁的数量、储物柜、数据库页面大小等，但我只是想从具有 BDB 并发实际经验的人那里得到一些建议。

我的应用程序非常简单，我将获取和放置每个大约 1KB 的记录。没有游标，没有删除。

* * *

## 回答 #1

> 赞同：15
> 
> 时间：2008-08-03T12:34:36.060

这取决于您正在构建什么样的应用程序。创建一个有代表性的测试场景，然后开始尝试。然后你就会知道确定的答案。

除了您的用例之外，它还取决于 CPU、内存、前端总线、操作系统、缓存设置等。

说真的，只是测试你自己的场景。

如果您需要一些数字（这实际上在您的场景中可能没有任何意义）：

*   [Oracle Berkeley DB：性能指标和基准](http://www.oracle.com/technology/products/berkeley-db/pdf/berkeley-db-perf.pdf)
*   [性能指标和基准：
    Berkeley DB](http://staff.rcost.unisannio.it/visaggio/berkleyDB.pdf)

* * *

## 回答 #2

> 赞同：8
> 
> 时间：2008-10-13T21:59:37.117

我非常同意 Daan 的观点：创建一个测试程序，并确保它访问数据的方式尽可能地模仿您期望应用程序具有的模式。这对于 BDB 非常重要，因为不同的访问模式会产生非常不同的吞吐量。

除此之外，这些是我发现对吞吐量有重大影响的一般因素：

1.  访问方法（在你的情况下我猜是 BTREE）。

2.  您配置 DBD 的持久性级别（例如，在我的情况下，“DB_TXN_WRITE_NOSYNC”环境标志将写入性能提高了一个数量级，但它会损害持久性）

3.  工作集是否适合缓存？

4.  读取次数与。写。

5.  您的访问范围有多分散（请记住，BTREE 具有页面级锁定 - 因此使用不同线程访问不同页面是一个很大的优势）。

6.  访问模式 - 意味着线程相互锁定甚至死锁的可能性有多大，以及您的死锁解决策略是什么（这可能是一个杀手）。

7.  硬件（用于缓存的磁盘和内存）。

这相当于以下几点：扩展基于 DBD 的解决方案以提供更高的并发性有两种关键方法；要么尽量减少设计中的锁数量，要么添加更多硬件。

* * *

## 回答 #3

> 赞同：5
> 
> 时间：2008-08-02T18:21:21.993

这不取决于硬件以及线程和东西的数量吗？

我会做一个简单的测试，并用越来越多的线程敲击来运行它，看看什么看起来最好。

* * *

## 回答 #4

> 赞同：3
> 
> 时间：2008-08-04T07:45:38.717

在处理性能未知的数据库时，我所做的是测量我的查询的周转时间。我一直在增加线程数，直到周转时间下降，并降低线程数，直到周转时间得到改善（嗯，这是我环境中的进程，但无论如何）。

有移动平均线和各种指标，但从中得到的教训是：只要适应目前的情况即可。您永远不知道 DBA 何时会提高性能或硬件会升级，或者在您运行时可能会出现另一个进程来加载系统。所以适应。

哦，还有一件事：如果可以的话，避免流程切换 - 批量处理。

* * *

哦，我应该说清楚：这一切都发生在运行时，而不是在开发期间。

* * *

## 回答 #5

> 赞同：3
> 
> 时间：2008-09-16T17:31:11.087

按照我的理解，Samba 创建[tdb](http://sourceforge.net/projects/tdb/)以允许任何特定数据库文件的“多个并发*写入者*”。因此，如果您的工作负载有多个编写器，您的性能可能会很差（例如，Samba 项目选择编写自己的系统，显然是因为它对 Berkeley DB 在这种情况下的性能不满意）。

另一方面，如果您的工作负载有很多读者，那么问题是您的操作系统如何处理多个读者。

# svn - 最佳实践：协作环境、Bin 目录、SVN

> ID：265
> 
> 赞同：38
> 
> 时间：2008-08-01T23:29:32.853
> 
> 标签：svn, collaboration

在使用 SVN 的协作开发环境中签入 BIN 目录的最佳实践是什么？是否应该从签入中排除项目级别的引用？添加所有 bin 目录更容易吗？

我开发了很多 DotNetNuke 站点，似乎在多开发人员环境中，正确设置环境始终是一项艰巨的任务。

最终目标（当然）是让新的开发人员从 SVN 签出主干，恢复 DNN 数据库并让这一切都“正常工作”......

* * *

## 回答 #1

> 赞同：19
> 
> 时间：2008-08-01T23:40:28.463

任何预期在 GAC 中的程序集都应留在 GAC 中。这包括 System.web.dll 或您将在生产中部署到 GAC 的任何其他第 3 方 dll。这意味着新开发人员必须安装这些程序集。

所有其他第 3 方程序集应通过相对路径进行引用。我的典型结构是：

```
-Project
--Project.sln
--References
---StructureMap.dll
---NUnit.dll
---System.Web.Mvc.dll
--Project.Web
---Project.Web.Proj
---Project.Web.Proj files
--Project
---Project.Proj
---Project.Proj files 
```

Project.Web 和 Project 相对引用根/References 文件夹中的程序集。这些 .dll 被检入 subversion。

除此之外， */bin */bin/* obj 应该在您的全局忽略路径中。

使用此设置，对程序集的所有引用要么通过 GAC（因此应该在所有计算机上工作），要么与解决方案中的每个项目相关。

* * *

## 回答 #2

> 赞同：4
> 
> 时间：2008-08-01T23:44:05.883

这是一个 .Net 特定的问题吗？

一般来说，最好的做法是不要签入从 SCM 中已经存在的文件中自动构建的任何内容。理想情况下，所有这些都是作为自动构建过程的一部分创建的。

如果`bin`您所指的目录包含第三方二进制文件，而不是您的项目的构建，请忽略（否决？）此建议。

* * *

## 回答 #3

> 赞同：4
> 
> 时间：2008-09-11T13:03:13.643

[Tree Surgeon](http://www.codeplex.com/treesurgeon)是一个很棒的工具，它可以创建一个空的 .NET 开发树。经过多年的使用，它已经过调整，并实施了许多最佳实践。

* * *

## 回答 #4

> 赞同：2
> 
> 时间：2008-08-02T18:30:34.673

当我编写 Java 代码时，Maven 对解决这个问题有很大帮助。我们将 pom.xml 提交到 scs，maven 存储库包含我们所有的依赖项。对我来说，这似乎是一个不错的方法。

* * *

## 回答 #5

> 赞同：1
> 
> 时间：2008-08-13T22:25:16.183

我们遵循使用包含所有供应商特定标头和二进制文件的供应商目录的做法。目标是任何人都应该能够通过检查并运行一些顶级构建脚本来构建产品。

# c# - 如何按值对字典进行排序？

> ID：289
> 
> 赞同：890
> 
> 时间：2008-08-02T00:40:58.200
> 
> 标签：c#, .net, sorting, dictionary

我经常需要按值对字典（由键和值组成）进行排序。例如，我有一个单词哈希和我想按频率排序的相应频率。

有一个`SortedList`对单个值（比如频率）有好处的，我想映射回这个词。

[SortedDictionary](http://msdn.microsoft.com/en-us/library/f7fta44c.aspx)按键排序，而不是按值排序。有些人求助于[自定义类](http://www.codeproject.com/KB/recipes/lookupcollection.aspx)，但有更清洁的方法吗？

* * *

## 回答 #1

> 赞同：562
> 
> 时间：2008-08-04T15:22:03.867

使用 LINQ：

```
Dictionary<string, int> myDict = new Dictionary<string, int>();
myDict.Add("one", 1);
myDict.Add("four", 4);
myDict.Add("two", 2);
myDict.Add("three", 3);

var sortedDict = from entry in myDict orderby entry.Value ascending select entry; 
```

这也将提供很大的灵活性，因为您可以选择前 10、20 10% 等。或者，如果您将词频索引用于`type-ahead`，您也可以包括`StartsWith`从句。

* * *

## 回答 #2

> 赞同：549
> 
> 时间：2008-08-02T01:15:42.123

采用：

```
using System.Linq.Enumerable;
...
List<KeyValuePair<string, string>> myList = aDictionary.ToList();

myList.Sort(
    delegate(KeyValuePair<string, string> pair1,
    KeyValuePair<string, string> pair2)
    {
        return pair1.Value.CompareTo(pair2.Value);
    }
); 
```

由于您的目标是 .NET 2.0 或更高版本，因此您可以将其简化为 lambda 语法——它是等效的，但更短。如果您的目标是 .NET 2.0，则只能在使用 Visual Studio 2008（或更高版本）的编译器时使用此语法。

```
var myList = aDictionary.ToList();

myList.Sort((pair1,pair2) => pair1.Value.CompareTo(pair2.Value)); 
```

* * *

## 回答 #3

> 赞同：320
> 
> 时间：2010-11-11T17:16:38.323

你可以使用：

```
var ordered = dict.OrderBy(x => x.Value).ToDictionary(x => x.Key, x => x.Value); 
```

* * *

## 回答 #4

> 赞同：173
> 
> 时间：2008-08-02T00:43:38.837

环顾四周，并使用一些 C# 3.0 特性，我们可以做到这一点：

```
foreach (KeyValuePair<string,int> item in keywordCounts.OrderBy(key=> key.Value))
{ 
    // do something with item.Key and item.Value
} 
```

这是我见过的最干净的方式，类似于 Ruby 处理哈希的方式。

* * *

## 回答 #5

> 赞同：169
> 
> 时间：2011-06-22T10:26:16.147

您可以按值对字典进行排序并将其保存回自身（这样当您对它进行 foreach 时，值会按顺序出现）：

```
dict = dict.OrderBy(x => x.Value).ToDictionary(x => x.Key, x => x.Value); 
```

当然，它可能不正确，但它确实有效。[海仑定律](https://www.hyrumslaw.com/)意味着这很可能会继续有效。

* * *

## 回答 #6

> 赞同：64
> 
> 时间：2008-08-02T00:47:48.797

在高层次上，您别无选择，只能浏览整个 Dictionary 并查看每个值。

也许这会有所帮助： [http](http://bytes.com/forum/thread563638.html) ://bytes.com/forum/thread563638.html 来自 John Timney 的复制/粘贴：

```
Dictionary<string, string> s = new Dictionary<string, string>();
s.Add("1", "a Item");
s.Add("2", "c Item");
s.Add("3", "b Item");

List<KeyValuePair<string, string>> myList = new List<KeyValuePair<string, string>>(s);
myList.Sort(
    delegate(KeyValuePair<string, string> firstPair,
    KeyValuePair<string, string> nextPair)
    {
        return firstPair.Value.CompareTo(nextPair.Value);
    }
); 
```

* * *

## 回答 #7

> 赞同：27
> 
> 时间：2008-12-19T22:47:08.330

无论如何，您永远无法对字典进行排序。它们实际上没有被订购。字典的保证是键和值集合是可迭代的，并且可以通过索引或键检索值，但不能保证任何特定的顺序。因此，您需要将名称值对放入列表中。

* * *

## 回答 #8

> 赞同：22
> 
> 时间：2012-12-13T06:19:09.490

您不对 Dictionary 中的条目进行排序。.NET 中的字典类被实现为一个哈希表——这个数据结构根据定义是不可排序的。

如果您需要能够迭代您的集合（按键） - 您需要使用 SortedDictionary，它被实现为二叉搜索树。

但是，在您的情况下，源结构无关紧要，因为它是按不同的字段排序的。您仍然需要按频率对其进行排序，并将其放入按相关字段（频率）排序的新集合中。所以在这个集合中，频率是键，词是值。由于许多单词可以具有相同的频率（并且您将使用它作为键），因此您既不能使用 Dictionary 也不能使用 SortedDictionary（它们需要唯一的键）。这为您留下了一个 SortedList。

我不明白您为什么坚持在主/第一本词典中维护指向原始项目的链接。

如果您的集合中的对象具有更复杂的结构（更多字段），并且您需要能够使用几个不同的字段作为键来有效地访问/排序它们 - 您可能需要一个自定义数据结构，该结构将由主存储组成支持 O(1) 插入和删除 (LinkedList) 和几个索引结构 - 字典/SortedDictionaries/SortedLists。这些索引将使用复杂类中的一个字段作为键，并将指向 LinkedList 中的 LinkedListNode 的指针/引用作为值。

您需要协调插入和删除以使索引与主集合（LinkedList）保持同步，并且我认为删除会非常昂贵。这类似于数据库索引的工作方式——它们非常适合查找，但当您需要执行许多插入和删除时，它们就会成为负担。

只有当您要进行一些查找繁重的处理时，上述所有内容才是合理的。如果您只需要在按频率排序后输出它们，那么您可以只生成一个（匿名）元组列表：

```
var dict = new SortedDictionary<string, int>();
// ToDo: populate dict

var output = dict.OrderBy(e => e.Value).Select(e => new {frequency = e.Value, word = e.Key}).ToList();

foreach (var entry in output)
{
    Console.WriteLine("frequency:{0}, word: {1}",entry.frequency,entry.word);
} 
```

* * *

## 回答 #9

> 赞同：15
> 
> 时间：2015-07-20T11:01:19.383

你可以使用：

```
Dictionary<string, string> dic= new Dictionary<string, string>();
var ordered = dic.OrderBy(x => x.Value);
return ordered.ToDictionary(t => t.Key, t => t.Value); 
```

* * *

## 回答 #10

> 赞同：12
> 
> 时间：2010-06-30T11:12:21.697

或者为了好玩，您可以使用一些 LINQ 扩展优点：

```
var dictionary = new Dictionary<string, int> { { "c", 3 }, { "a", 1 }, { "b", 2 } };
dictionary.OrderBy(x => x.Value)
  .ForEach(x => Console.WriteLine("{0}={1}", x.Key,x.Value)); 
```

* * *

## 回答 #11

> 赞同：10
> 
> 时间：2010-04-23T09:36:26.570

使用 VB.NET对列表进行排序`SortedDictionary`以绑定到控件中：`ListView`

```
Dim MyDictionary As SortedDictionary(Of String, MyDictionaryEntry)

MyDictionaryListView.ItemsSource = MyDictionary.Values.OrderByDescending(Function(entry) entry.MyValue)

Public Class MyDictionaryEntry ' Need Property for GridViewColumn DisplayMemberBinding
    Public Property MyString As String
    Public Property MyValue As Integer
End Class 
```

XAML：

```
<ListView Name="MyDictionaryListView">
    <ListView.View>
        <GridView>
            <GridViewColumn DisplayMemberBinding="{Binding Path=MyString}" Header="MyStringColumnName"></GridViewColumn>
            <GridViewColumn DisplayMemberBinding="{Binding Path=MyValue}" Header="MyValueColumnName"></GridViewColumn>
         </GridView>
    </ListView.View>
</ListView> 
```

* * *

## 回答 #12

> 赞同：6
> 
> 时间：2016-02-26T07:15:13.757

如果您只想拥有一个按值排序的“临时”列表，那么其他答案也很好。但是，如果您想让一个按 排序的字典`Key`自动与另一个按 排序的字典*同步*`Value`，您可以使用[`Bijection<K1, K2>`class](http://ecsharp.net/doc/code/classLoyc_1_1Collections_1_1Bijection.html)。

`Bijection<K1, K2>`允许您使用两个现有字典初始化集合，因此如果您希望其中一个未排序，并且希望另一个排序，您可以使用如下代码创建双射

```
var dict = new Bijection<Key, Value>(new Dictionary<Key,Value>(), 
                               new SortedDictionary<Value,Key>()); 
```

您可以`dict`像使用任何普通字典（它实现`IDictionary<K, V>`）一样使用，然后调用`dict.Inverse`以获取按 . 排序的“逆”字典`Value`。

`Bijection<K1, K2>`是[Loyc.Collections.dll](http://core.loyc.net/)的一部分，但如果需要，您可以简单地将[源代码](https://github.com/qwertie/Loyc/blob/master/Core/Loyc.Collections/Other/Bijection.cs)复制到您自己的项目中。

**注意**：如果有多个 key 的值相同，则不能使用`Bijection`，但可以手动在普通`Dictionary<Key,Value>`和 a之间进行同步[`BMultiMap<Value,Key>`](http://loyc.net/doc/code/classLoyc_1_1Collections_1_1BMultiMap_3_01K_00_01V_01_4.html)。

* * *

## 回答 #13

> 赞同：5
> 
> 时间：2019-02-26T12:39:54.530

实际上在 C# 中，字典没有 sort() 方法。由于您对按值排序更感兴趣，因此在为它们提供键之前，您无法获取值。简而言之，您需要使用 LINQ 遍历它们`OrderBy()`，

```
var items = new Dictionary<string, int>();
items.Add("cat", 0);
items.Add("dog", 20);
items.Add("bear", 100);
items.Add("lion", 50);

// Call OrderBy() method here on each item and provide them the IDs.
foreach (var item in items.OrderBy(k => k.Key))
{
    Console.WriteLine(item);// items are in sorted order
} 
```

你可以做一个技巧：

```
var sortedDictByOrder = items.OrderBy(v => v.Value); 
```

或者：

```
var sortedKeys = from pair in dictName
            orderby pair.Value ascending
            select pair; 
```

它还取决于您存储的值类型：单个（如 string、int）或多个（如 List、Array、用户定义的类）。如果它是单一的，您可以列出它然后应用排序。
如果它是用户定义的类，那么该类必须实现 IComparable`ClassName: IComparable<ClassName>`并重写`compareTo(ClassName c)`，因为它们比 LINQ 更快且更面向对象。

* * *

## 回答 #14

> 赞同：3
> 
> 时间：2010-04-02T22:36:32.783

获得排序字典的最简单方法是使用内置`SortedDictionary`类：

```
//Sorts sections according to the key value stored on "sections" unsorted dictionary, which is passed as a constructor argument
System.Collections.Generic.SortedDictionary<int, string> sortedSections = null;
if (sections != null)
{
    sortedSections = new SortedDictionary<int, string>(sections);
} 
```

`sortedSections`将包含排序后的版本`sections`

* * *

## 回答 #15

> 赞同：2
> 
> 时间：2015-02-02T10:46:01.693

假设我们有一个字典

```
 Dictionary<int, int> dict = new Dictionary<int, int>();
   dict.Add(21,1041);
   dict.Add(213, 1021);
   dict.Add(45, 1081);
   dict.Add(54, 1091);
   dict.Add(3425, 1061);
   sict.Add(768, 1011); 
```

1）你可以使用**`temporary dictionary to store values as`**：

```
 Dictionary<int, int> dctTemp = new Dictionary<int, int>();

        foreach (KeyValuePair<int, int> pair in dict.OrderBy(key => key.Value))
        {
            dctTemp .Add(pair.Key, pair.Value);
        } 
```

* * *

## 回答 #16

> 赞同：2
> 
> 时间：2020-05-18T17:35:06.343

必需的命名空间：`using System.Linq;`

```
Dictionary<string, int> counts = new Dictionary<string, int>();
counts.Add("one", 1);
counts.Add("four", 4);
counts.Add("two", 2);
counts.Add("three", 3); 
```

按描述顺序：

```
foreach (KeyValuePair<string, int> kvp in counts.OrderByDescending(key => key.Value))
{
// some processing logic for each item if you want.
} 
```

按升序排序：

```
foreach (KeyValuePair<string, int> kvp in counts.OrderBy(key => key.Value))
{
// some processing logic for each item if you want.
} 
```

* * *

## 回答 #17

> 赞同：1
> 
> 时间：2020-11-15T06:30:08.923

排序和打印：

```
var items = from pair in players_Dic
                orderby pair.Value descending
                select pair;

// Display results.
foreach (KeyValuePair<string, int> pair in items)
{
    Debug.Log(pair.Key + " - " + pair.Value);
} 
```

将降序更改为升序以更改排序顺序

* * *

## 回答 #18

> 赞同：0
> 
> 时间：2021-12-28T21:40:36.873

根据定义，字典是一种无序的关联结构，仅包含以可散列方式的值和键。换句话说，没有一种可预见的方式来订购字典。

参考从python语言阅读这篇文章。

链接 [python数据结构](https://docs.python.org/3/tutorial/datastructures.html#dictionaries)

* * *

## 回答 #19

> 赞同：-2
> 
> 时间：2012-07-24T12:24:01.903

您可以按值对字典进行排序，并使用以下代码在字典中获取结果：

```
Dictionary <<string, string>> ShareUserNewCopy = 
       ShareUserCopy.OrderBy(x => x.Value).ToDictionary(pair => pair.Key,
                                                        pair => pair.Value); 
```

* * *

## 回答 #20

> 赞同：-2
> 
> 时间：2014-05-31T22:30:00.483

鉴于您有一本字典，您可以使用下面的一个衬里直接按值对它们进行排序：

```
var x = (from c in dict orderby c.Value.Order ascending select c).ToDictionary(c => c.Key, c=>c.Value); 
```

# sql - 是否有用于数据库结构更改的版本控制系统？

> ID：308
> 
> 赞同：129
> 
> 时间：2008-08-02T01:52:54.653
> 
> 标签：sql, database, oracle, version-control

我经常遇到以下问题。

我对需要数据库中的新表或列的项目进行一些更改。我进行了数据库修改并继续我的工作。通常，我记得写下更改，以便可以在实时系统上复制它们。然而，我并不总是记得我改变了什么，我也不总是记得把它写下来。

所以，我推送到实时系统并得到一个很大的、明显的错误，那就是没有`NewColumnX`，呃。

不管这可能不是这种情况的最佳实践，是否有数据库的版本控制系统？我不关心具体的数据库技术。我只想知道是否存在。如果它恰好可以与 MS SQL Server 一起使用，那就太好了。

* * *

## 回答 #1

> 赞同：64
> 
> 时间：2008-08-02T06:23:33.737

在 Ruby on Rails 中，有一个[迁移](http://wiki.rubyonrails.org/rails/pages/UnderstandingMigrations)的概念——更改数据库的快速脚本。

您生成一个迁移文件，其中包含增加 db 版本的规则（例如添加一列）和降级版本的规则（例如删除一列）。每个迁移都有编号，并且一张表会跟踪您当前的数据库版本。

要*向上迁移*，您可以运行一个名为“db:migrate”的命令，它会查看您的版本并应用所需的脚本。您可以以类似的方式向下迁移。

迁移脚本本身保存在版本控制系统中——每当您更改数据库时，您都会签入一个新脚本，任何开发人员都可以应用它来将他们的本地数据库更新到最新版本。

* * *

## 回答 #2

> 赞同：32
> 
> 时间：2008-09-26T20:29:07.343

我有点老派，因为我使用源文件来创建数据库。实际上有 2 个文件 - project-database.sql 和 project-updates.sql - 第一个用于模式和持久数据，第二个用于修改。当然，两者都在源代码控制之下。

当数据库发生变化时，我首先更新 project-database.sql 中的主模式，然后将相关信息复制到 project-updates.sql，例如 ALTER TABLE 语句。然后我可以将更新应用到开发数据库、测试、迭代直到完成。然后，签入文件，再次测试，并应用于生产。

另外，我通常在 db 中有一个表 - 配置 - 例如：

**SQL**

```
CREATE TABLE Config
(
    cfg_tag VARCHAR(50),
    cfg_value VARCHAR(100)
);

INSERT INTO Config(cfg_tag, cfg_value) VALUES
( 'db_version', '$Revision: $'),
( 'db_revision', '$Revision: $'); 
```

然后，我将以下内容添加到更新部分：

```
UPDATE Config SET cfg_value='$Revision: $' WHERE cfg_tag='db_revision'; 
```

`db_version`唯一会在重新创建数据库时发生更改，并且可以`db_revision`指示数据库偏离基线的程度。

我可以将更新保存在它们自己单独的文件中，但我选择将它们混合在一起并使用剪切和粘贴来提取相关部分。需要进行更多的内务处理，即从 $Revision 1.1 $ 中删除 ':' 以冻结它们。

* * *

## 回答 #3

> 赞同：14
> 
> 时间：2010-07-10T21:56:52.070

[MyBatis](http://mybatis.org/)（以前的 iBatis）有一个[模式迁移](http://mybatis.org/java.html)工具，可以在命令行上使用。它是用java编写的，但可以用于任何项目。

> 为了实现良好的数据库变更管理实践，我们需要确定几个关键目标。因此，MyBatis Schema Migration System（或简称 MyBatis Migrations）旨在：

*   使用任何数据库，新的或现有的
*   利用源代码控制系统（例如 Subversion）
*   使并发开发人员或团队能够独立工作
*   允许冲突非常明显且易于管理
*   允许向前和向后迁移（分别进化，下放）
*   使数据库的当前状态易于访问和理解
*   尽管有访问权限或官僚主义，仍可进行迁移
*   使用任何方法
*   鼓励良好、一致的做法

* * *

## 回答 #4

> 赞同：12
> 
> 时间：2011-07-08T14:51:41.783

Redgate 有一个名为[SQL Source Control](http://www.red-gate.com/products/sql-development/sql-source-control/)的产品。它与 TFS、SVN、SourceGear Vault、Vault Pro、Mercurial、Perforce 和 Git 集成。

* * *

## 回答 #5

> 赞同：11
> 
> 时间：2009-05-28T02:12:15.637

我强烈推荐[SQL delta](http://www.sqldelta.com/deltasqlserver.html)。当我完成对我的功能进行编码并将这些脚本检查到我的源代码控制工具中时，我只是使用它来生成差异脚本（Mercurial :)）

他们有 SQL 服务器和 Oracle 版本。

* * *

## 回答 #6

> 赞同：11
> 
> 时间：2010-07-10T21:26:04.217

我想知道没有人提到基于 Java 的开源工具[liquibase](http://www.liquibase.org/)，它应该适用于几乎所有支持 jdbc 的数据库。与 rails 相比，它使用 xml 而不是 ruby​​ 来执行架构更改。虽然我不喜欢领域特定语言的 xml，但 xml 非常酷的优势是 liquibase 知道如何回滚某些操作，例如

```
<createTable tableName="USER"> 
   <column name="firstname" type="varchar(255)"/>
</createTable> 
```

所以你不需要自己处理这个

还支持纯 sql 语句或数据导入。

* * *

## 回答 #7

> 赞同：10
> 
> 时间：2008-08-02T01:56:51.573

大多数数据库引擎应该支持将数据库转储到文件中。无论如何，我知道 MySQL 确实如此。这只是一个文本文件，所以你可以将它提交给 Subversion，或者你使用的任何东西。在文件上运行差异也很容易。

* * *

## 回答 #8

> 赞同：10
> 
> 时间：2008-09-10T19:49:15.843

如果您使用的是 SQL Server，则很难击败 Data Dude（又名 Visual Studio 的数据库版）。一旦掌握了窍门，就可以轻而易举地在数据库的源代码控制版本和生产版本之间进行模式比较。只需单击一下，您就可以生成差异 DDL。

MSDN 上有一个非常有用的教学[视频](http://msdn.microsoft.com/en-us/vsts2008/cc659682.aspx)。

我知道 DBMS_METADATA 和 Toad，但如果有人能为 Oracle 想出一个 Data Dude，那么生活会非常美好。

* * *

## 回答 #9

> 赞同：9
> 
> 时间：2008-08-02T06:05:04.770

对于 Oracle，我使用[Toad](http://www.toadsoft.com/)，它可以将模式转储到多个离散文件（例如，每个表一个文件）。我有一些脚本在 Perforce 中管理这个集合，但我认为它应该在几乎任何版本控制系统中都可以轻松实现。

* * *

## 回答 #10

> 赞同：9
> 
> 时间：2008-08-31T11:25:21.103

在版本控制器中进行初始创建表语句，然后添加更改表语句，但不要编辑文件，只需按顺序命名更多更改文件，甚至作为“更改集”，这样您就可以找到特定部署的所有更改。

我能看到的最困难的部分是跟踪依赖关系，例如，对于特定的部署表 B 可能需要在表 A 之前更新。

* * *

## 回答 #11

> 赞同：9
> 
> 时间：2008-09-01T20:57:01.673

看一下 oracle 包 DBMS_METADATA。

特别是，以下方法特别有用：

*   `DBMS_METADATA.GET_DDL`
*   `DBMS_METADATA.SET_TRANSFORM_PARAM`
*   `DBMS_METADATA.GET_GRANTED_DDL`

一旦您熟悉了它们的工作原理（非常自我解释），您就可以编写一个简单的脚本来将这些方法的结果转储到可以置于源代码控制之下的文本文件中。祝你好运！

不确定 MSSQL 是否有这么简单的东西。

* * *

## 回答 #12

> 赞同：8
> 
> 时间：2008-08-30T18:58:40.787

我与编码并行编写我的数据库发布脚本，并将发布脚本保存在 SS 的项目特定部分中。如果我对需要更改数据库的代码进行更改，那么我会同时更新发布脚本。在发布之前，我在一个干净的开发数据库（从生产中复制结构）上运行发布脚本并对其进行最终测试。

* * *

## 回答 #13

> 赞同：8
> 
> 时间：2008-09-15T15:01:05.603

多年来，我断断续续地这样做了——管理（或尝试管理）模式版本。最佳方法取决于您拥有的工具。如果您能获得 Quest Software 工具“Schema Manager”，您将处于良好状态。Oracle 有自己的劣质工具，也称为“模式管理器”（很混乱？），我不推荐。

如果没有自动化工具（请参阅此处有关 Data Dude 的其他评论），您将直接使用脚本和 DDL 文件。选择一种方法，记录它，并严格遵循它。我喜欢在任何给定时刻重新创建数据库的能力，所以我更喜欢对整个数据库（如果我是 DBA）或开发人员模式（如果我在产品中）进行完整的 DDL 导出-开发模式）。

* * *

## 回答 #14

> 赞同：8
> 
> 时间：2008-09-17T15:50:33.847

PLSQL Developer 是 All Arround Automations 的一个工具，它有一个用于存储库的插件，可以在 Visual Source Safe 中正常工作（但不是很好）。

> 来自网络：
> 
> > 版本控制插件提供了 PL/SQL Developer IDE >> 和任何支持 Microsoft SCC 接口规范的版本控制系统之间的紧密集成。>>这包括最流行的版本控制系统，例如 Microsoft Visual SourceSafe、>>Merant PVCS 和 MKS Source Integrity。

[http://www.allroundautomations.com/plsvcs.html](http://www.allroundautomations.com/plsvcs.html)

* * *

## 回答 #15

> 赞同：8
> 
> 时间：2008-09-17T18:04:28.393

[ER Studio](http://www.embarcadero.com/products/erstudio/)允许您将数据库模式反转到该工具中，然后您可以将其与实时数据库进行比较。

示例：将您的开发模式反转到 ER Studio 中——将其与生产进行比较，它将列出所有差异。它可以编写更改脚本，也可以自动推送它们。

在 ER Studio 中创建模式后，您可以保存创建脚本或将其保存为专有二进制文件并将其保存在版本控制中。如果您想回到该方案的过去版本，只需检查它并将其推送到您的数据库平台。

* * *

## 回答 #16

> 赞同：7
> 
> 时间：2008-08-02T07:48:56.107

有一个名为 Ruckusing 的 PHP5“数据库迁移框架”。我没有使用它，但[示例](http://code.google.com/p/ruckusing/wiki/CompleteExamples)显示了这个想法，如果您在需要时使用该语言创建数据库，您只需跟踪源文件。

* * *

## 回答 #17

> 赞同：4
> 
> 时间：2008-09-26T18:12:01.993

我们使用[MS Team System Database Edition](http://msdn.microsoft.com/en-us/vsts2008/products/bb933747.aspx)取得了相当大的成功。它或多或少地与 TFS 版本控制和 Visual Studio 无缝集成，使我们能够轻松地管理存储的过程、视图等。解决冲突可能会很痛苦，但是一旦完成，版本历史就完整了。此后，迁移到 QA 和生产非常简单。

公平地说，它是 1.0 版产品，但并非没有一些问题。

* * *

## 回答 #18

> 赞同：4
> 
> 时间：2014-12-22T11:58:25.810

You can use [Microsoft SQL Server Data Tools](http://msdn.microsoft.com/en-gb/data/tools.aspx) in visual studio to generate scripts for database objects as part of a SQL Server Project. You can then add the scripts to source control using the source control integration that is built into visual studio. Also, SQL Server Projects allow you verify the database objects using a compiler and generate deployment scripts to update an existing database or create a new one.

* * *

## 回答 #19

> 赞同：3
> 
> 时间：2008-09-01T07:29:33.593

在没有用于表更改的 VCS 的情况下，我一直将它们记录在 wiki 中。至少那时我可以看到它何时以及为什么被改变。它远非完美，因为不是每个人都在这样做，而且我们有多个产品版本在使用，但总比没有好。

* * *

## 回答 #20

> 赞同：3
> 
> 时间：2008-09-26T17:53:42.597

我会推荐两种方法之一。首先，投资 Sybase 的[PowerDesigner](http://www.sybase.com/products/modelingdevelopment/powerdesigner)。企业版。它允许您设计物理数据模型等等。但它带有一个存储库，允许您签入您的模型。每个新签入都可以是一个新版本，它可以将任何版本与任何其他版本进行比较，甚至可以与您当时数据库中的内容进行比较。然后它将显示每个差异的列表并询问应该迁移哪些......然后它会构建脚本来执行此操作。它并不便宜，但价格便宜两倍，投资回报率约为 6 个月。

另一个想法是打开 DDL 审计（在 Oracle 中工作）。这将创建一个包含您所做的每一个更改的表。如果您从上次将数据库更改移动到 prod 的时间戳查询更改到现在，您将获得已完成的所有操作的有序列表。一些用于消除零和变化的 where 子句，例如 create table foo；其次是删除表 foo；你可以轻松地构建一个 mod 脚本。为什么将更改保留在 wiki 中，这是双倍的工作。让数据库为您跟踪它们。

* * *

## 回答 #21

> 赞同：3
> 
> 时间：2010-01-10T02:59:51.697

Schema Compare for Oracle 是专门设计用于将更改从我们的 Oracle 数据库迁移到另一个的工具。请访问下面的 URL 以获取下载链接，您可以在其中使用该软件进行全功能试用。

[http://www.red-gate.com/Products/schema_compare_for_oracle/index.htm](http://www.red-gate.com/Products/schema_compare_for_oracle/index.htm)

* * *

## 回答 #22

> 赞同：2
> 
> 时间：2008-09-22T18:17:48.637

两本书推荐：Ambler 和 Sadalage 的“重构数据库”和 Ambler 的“敏捷数据库技术”。

有人提到 Rails 迁移。我认为它们工作得很好，即使在 Rails 应用程序之外。我在一个带有 SQL Server 的 ASP 应用程序上使用了它们，我们正在迁移到 Rails。您将迁移脚本本身检查到 VCS 中。这是[Pragmatic Dave Thomas](http://pragdave.blogs.pragprog.com/pragdave/2006/07/migrations_outs.html)关于这个主题的帖子。

# security - PHP 会话安全

> ID：328
> 
> 赞同：125
> 
> 时间：2008-08-02T02:41:34.493
> 
> 标签：security, php

使用 PHP 维护负责任的会话安全有哪些指导方针？网络上到处都是信息，现在是时候将它们全部放在一个地方了！

* * *

## 回答 #1

> 赞同：88
> 
> 时间：2008-08-11T02:38:06.737

为了确保您的会话安全，需要做几件事：

1.  在对用户进行身份验证或执行敏感操作时使用 SSL。
2.  每当安全级别更改（例如登录）时，重新生成会话 ID。如果您愿意，您甚至可以在每个请求中重新生成会话 ID。
3.  让会话超时
4.  不要使用寄存器全局变量
5.  在服务器上存储身份验证详细信息。也就是说，不要在 cookie 中发送用户名等详细信息。
6.  检查`$_SERVER['HTTP_USER_AGENT']`. 这为会话劫持增加了一个小障碍。您还可以检查 IP 地址。但这会导致由于多个 Internet 连接上的负载平衡等而更改 IP 地址的用户出现问题（在我们这里的环境中就是这种情况）。
7.  锁定对文件系统上会话的访问或使用自定义会话处理
8.  对于敏感操作，请考虑要求登录用户再次提供其身份验证详细信息

* * *

## 回答 #2

> 赞同：15
> 
> 时间：2008-08-02T02:43:42.790

一个指导原则是每次会话的安全级别更改时调用[session_regenerate_id 。](http://www.php.net/session_regenerate_id)这有助于防止会话劫持。

* * *

## 回答 #3

> 赞同：11
> 
> 时间：2008-08-02T02:55:07.743

我认为主要问题之一（正在 PHP 6 中解决）是 register_globals。现在用来避免的标准方法之一`register_globals`是使用`$_REQUEST`,`$_GET`或`$_POST`数组。

做到这一点的“正确”方法（从 5.2 开始，虽然那里有点问题，但从 6 开始稳定，即将推出）是通过[filters](http://us.php.net/filter)。

所以而不是：

```
$username = $_POST["username"]; 
```

你会这样做：

```
$username = filter_input(INPUT_POST, 'username', FILTER_SANITIZE_STRING); 
```

甚至只是：

```
$username = filter_input(INPUT_POST, 'username'); 
```

* * *

## 回答 #4

> 赞同：11
> 
> 时间：2010-04-06T16:05:47.180

我的两（或更多）美分：

*   不相信任何人
*   过滤输入、转义输出（cookie、会话数据也是您的输入）
*   避免 XSS（保持你的 HTML 格式正确，看看[PHPTAL](http://phptal.org)或[HTMLPurifier](http://htmlpurifier.org/)）
*   [纵深防御](http://en.wikipedia.org/wiki/Defense_in_Depth_%28computing%29)
*   不公开数据

关于这个主题有一本很小但很好的书：[Chris Shiflett 的 Essential PHP Security](http://phpsecurity.org/)。

[基本 PHP 安全 http://shiflett.org/images/essential-php-security-small.png](http://shiflett.org/images/essential-php-security-small.png)

在本书的主页上，您会找到一些有趣的代码示例和示例章节。

您可以使用上述技术（IP 和 UserAgent），如下所述：[如何避免身份盗用](http://devzone.zend.com/article/11906)

* * *

## 回答 #5

> 赞同：9
> 
> 时间：2009-03-05T22:33:27.497

[这篇会话固定论文](http://www.acros.si/papers/session_fixation.pdf)有很好的指示可能会发生攻击。另请参阅[Wikipedia 上的会话固定页面](http://en.wikipedia.org/wiki/Session_fixation)。

* * *

## 回答 #6

> 赞同：5
> 
> 时间：2008-08-06T20:44:55.820

根据我的经验，使用 IP 地址并不是最好的主意。例如; 我的办公室有两个根据负载使用的 IP 地址，我们经常遇到使用 IP 地址的问题。

相反，我选择将会话存储在我服务器上域的单独数据库中。这样文件系统上的任何人都无法访问该会话信息。这对 3.0 之前的 phpBB 非常有帮助（他们已经修复了这个问题），但我认为这仍然是一个好主意。

* * *

## 回答 #7

> 赞同：3
> 
> 时间：2008-08-02T03:16:19.480

这非常简单明了，但请确保在每次使用后进行[session_destroy 。](http://www.php.net/session_destroy)如果用户没有明确注销，这可能很难实现，因此可以设置一个计时器来执行此操作。

这是关于 setTimer() 和 clearTimer()的一个很好的[教程。](http://www.elated.com/articles/javascript-timers-with-settimeout-and-setinterval/)

* * *

## 回答 #8

> 赞同：3
> 
> 时间：2008-08-03T13:14:48.600

PHP 会话和安全性（除了会话劫持）的主要问题在于您所处的环境。默认情况下，PHP 将会话数据存储在操作系统临时目录中的文件中。没有任何特别的想法或计划，这是一个世界可读的目录，因此您的所有会话信息对任何有权访问服务器的人都是公开的。

至于在多个服务器上维护会话。那时最好将 PHP 切换到用户处理的会话，它会调用您提供的函数来 CRUD（创建、读取、更新、删除）会话数据。此时，您可以将会话信息存储在数据库或类似 memcache 的解决方案中，以便所有应用程序服务器都可以访问数据。

如果您在共享服务器上，存储您自己的会话也可能是有利的，因为它可以让您将其存储在数据库中，您通常比文件系统拥有更多的控制权。

* * *

## 回答 #9

> 赞同：3
> 
> 时间：2011-07-19T21:40:37.627

我像这样设置我的会话-

在登录页面上：

```
$_SESSION['fingerprint'] = md5($_SERVER['HTTP_USER_AGENT'] . PHRASE . $_SERVER['REMOTE_ADDR']); 
```

（配置页面上定义的短语）

然后在整个站点其余部分的标题上：

```
session_start();
if ($_SESSION['fingerprint'] != md5($_SERVER['HTTP_USER_AGENT'] . PHRASE . $_SERVER['REMOTE_ADDR'])) {       
    session_destroy();
    header('Location: http://website login page/');
    exit();     
} 
```

* * *

## 回答 #10

> 赞同：3
> 
> 时间：2011-10-13T02:40:01.833

# php.ini

```
session.cookie_httponly = 1
change session name from default PHPSESSID 
```

# eq Apache 添加标头：

```
X-XSS-Protection    1 
```

* * *

## 回答 #11

> 赞同：2
> 
> 时间：2008-08-04T21:38:05.603

我会检查 IP 和用户代理，看看它们是否改变

```
if ($_SESSION['user_agent'] != $_SERVER['HTTP_USER_AGENT']
    || $_SESSION['user_ip'] != $_SERVER['REMOTE_ADDR'])
{
    //Something fishy is going on here?
} 
```

* * *

## 回答 #12

> 赞同：2
> 
> 时间：2008-08-09T03:28:43.640

如果您使用[session_set_save_handler()](http://www.php.net/manual/en/function.session-set-save-handler.php)您可以设置自己的会话处理程序。例如，您可以将会话存储在数据库中。有关数据库会话处理程序的示例，请参阅 php.net 注释。

如果您有多个服务器，数据库会话也很好，否则如果您使用基于文件的会话，则需要确保每个网络服务器都可以访问相同的文件系统来读取/写入会话。

* * *

## 回答 #13

> 赞同：2
> 
> 时间：2008-08-18T17:12:34.847

您需要确保会话数据是安全的。通过查看您的 php.ini 或使用 phpinfo() 您可以找到会话设置。_session.save_path_ 告诉您它们的保存位置。

检查文件夹及其父级的权限。它不应该是公开的 (/tmp) 或可供共享服务器上的其他网站访问。

假设您仍然想使用 php session，您可以通过更改 _session.save_path_ 将 php 设置为使用其他文件夹，或者通过更改 _session.save_handler_ 将数据保存在数据库中。

您也许可以在您的 php.ini 中设置 _session.save_path_ （一些提供商允许这样做），或者对于 apache + mod_php，在您的站点根文件夹中的 .htaccess 文件中设置： `php_value session.save_path "/home/example.com/html/session"`. 您也可以在运行时使用 _session_save_path()_ 设置它。

检查[Chris Shiflett 的教程](http://shiflett.org/articles/storing-sessions-in-a-database)或[Zend_Session_SaveHandler_DbTable](http://framework.zend.com/manual/en/zend.session.savehandler.dbtable.html)以设置和替代会话处理程序。

# c++ - 在这种情况下我应该使用嵌套类吗？

> ID：330
> 
> 赞同：58
> 
> 时间：2008-08-02T02:51:36.470
> 
> 标签：c++, oop, class, nested-class

我正在研究一组用于视频播放和录制的类。我有一个主类，它的作用类似于公共接口，具有类似、、、等的方法......`play()`然后我有主力类，它们执行视频解码和视频编码。`stop()``pause()``record()`

我刚刚了解了 C++ 中嵌套类的存在，我很想知道程序员对使用它们的看法。我有点警惕，不确定有什么好处/缺点，但它们似乎（根据我正在阅读的书）可用于我的情况。

这本书建议在像我这样的场景中，一个好的解决方案是将主力类嵌套在接口类中，因此对于客户端不打算使用的类没有单独的文件，并避免任何可能的命名冲突？我不知道这些理由。嵌套类对我来说是一个新概念。只是想看看程序员对这个问题的看法。

* * *

## 回答 #1

> 赞同：30
> 
> 时间：2008-08-02T03:00:24.613

我有点不愿意在这里使用嵌套类。如果您为“多媒体驱动程序”创建一个抽象基类来处理后端工作（主力），并为前端工作创建一个单独的类怎么办？前端类可以获取已实现驱动程序类的指针/引用（针对适当的媒体类型和情况），并对主力结构执行抽象操作。

我的理念是继续前进，让客户以一种优雅的方式访问这两种结构，只是假设它们会被串联使用。

我会在 Qt 中引用类似[QTextDocument的东西。](http://qt-project.org/doc/qt-4.8/qtextdocument.html)您为裸机数据处理提供直接接口，但将权限传递给 QTextEdit 之类的对象以进行操作。

* * *

## 回答 #2

> 赞同：9
> 
> 时间：2008-09-17T11:50:28.090

您将使用嵌套类来创建实现主类所需的（小）辅助类。或者例如，定义一个接口（一个具有抽象方法的类）。

在这种情况下，嵌套类的主要缺点是这使得重用它们变得更加困难。也许您想在另一个项目中使用您的 VideoDecoder 类。如果将其设为 VideoPlayer 的嵌套类，则无法以优雅的方式执行此操作。

相反，将其他类放在单独的 .h/.cpp 文件中，然后您可以在 VideoPlayer 类中使用这些文件。VideoPlayer的客户端现在只需要包含声明VideoPlayer的文件，仍然不需要知道你是如何实现它的。

* * *

## 回答 #3

> 赞同：5
> 
> 时间：2008-08-05T08:29:13.527

决定是否使用嵌套类的一种方法是考虑这个类是起辅助作用还是它自己的一部分。

如果它只是为了帮助另一个类而存在，那么我通常将其设为嵌套类。对此有很多警告，其中一些似乎是矛盾的，但这一切都归结为经验和直觉。

* * *

## 回答 #4

> 赞同：4
> 
> 时间：2008-08-05T08:37:19.097

听起来像是您可以使用[策略模式的情况](http://en.wikipedia.org/wiki/Strategy_pattern)

* * *

## 回答 #5

> 赞同：4
> 
> 时间：2008-09-16T09:31:01.600

有时对用户隐藏实现类是合适的——在这些情况下，最好将它们放在 foo_internal.h 中而不是放在公共类定义中。这样，您的 foo.h 的读者将不会看到您希望他们不为之烦恼的内容，但您仍然可以针对您的接口的每个具体实现编写测试。

* * *

## 回答 #6

> 赞同：4
> 
> 时间：2008-09-21T00:39:00.797

我们遇到了一个半旧的 Sun C++ 编译器和嵌套类的可见性问题，这些问题在标准中发生了变化。当然，这不是不做嵌套类的理由，如果您计划在包括旧编译器在内的许多平台上编译软件，这只是需要注意的事情。

* * *

## 回答 #7

> 赞同：4
> 
> 时间：2008-09-25T23:34:32.203

好吧，如果您在接口类中使用指向主力类的指针，并且不将它们作为参数或接口方法中的返回类型公开，则不需要在接口头文件中包含这些工作马的定义（您只需转发声明它们）。这样，您界面的用户就不需要知道后台的类。

您绝对不需要为此嵌套类。事实上，随着项目的发展，单独的类文件实际上会使您的代码更具可读性和更易于管理。如果您需要子类化（例如针对不同的内容/编解码器类型），它也会在以后帮助您。

这是有关[PIMPL 模式](http://www.apibook.com/Chapter_3.pdf)的更多信息（第 3.1.1 节）。

* * *

## 回答 #8

> 赞同：2
> 
> 时间：2008-09-18T15:19:37.250

仅当您无法使用可能的外部类的公共接口将内部类实现为单独的类时，才应使用内部类。内部类增加了类的大小、复杂性和责任，因此应谨慎使用它们。

您的编码器/解码器类听起来更适合[策略模式](http://en.wikipedia.org/wiki/Strategy_pattern)

* * *

## 回答 #9

> 赞同：1
> 
> 时间：2008-09-20T07:37:30.033

避免嵌套类的一个原因是，如果您打算用 swig ( [http://www.swig.org](http://www.swig.org) ) 包装代码以与其他语言一起使用。Swig 目前在嵌套类方面存在问题，因此与暴露任何嵌套类的库进行交互变得非常痛苦。

* * *

## 回答 #10

> 赞同：1
> 
> 时间：2008-09-23T19:07:55.030

要记住的另一件事是您是否曾设想过工作功能的不同实现（例如解码和编码）。在这种情况下，您肯定需要一个具有不同具体类的抽象基类来实现这些功能。为每种类型的实现嵌套一个单独的子类实际上并不合适。

# language-agnostic - 何时使用无符号值而不是有符号值？

> ID：336
> 
> 赞同：86
> 
> 时间：2008-08-02T03:34:44.763
> 
> 标签：language-agnostic, types

什么时候适合在有符号变量上使用无符号变量？`for`循环呢？

我听到了很多关于这个的意见，我想看看是否有任何类似的共识。

```
for (unsigned int i = 0; i < someThing.length(); i++) {  
    SomeThing var = someThing.at(i);  
    // You get the idea.  
} 
```

我知道 Java 没有无符号值，这一定是[Sun Microsystems](https://en.wikipedia.org/wiki/Sun_Microsystems)的一个有意识的决定。

* * *

## 回答 #1

> 赞同：70
> 
> 时间：2008-08-02T03:49:21.987

我很高兴在这个主题上找到[了一个很好的对话](https://web.archive.org/web/20170323034837/http://coding.derkeiler.com/Archive/C_CPP/comp.lang.c/2004-02/1382.html)，因为我之前并没有真正考虑过。

总之，有符号是一个很好的通用选择——即使你确定所有数字都是正数——如果你要对变量进行算术运算（比如在典型的 for 循环情况下）。

unsigned 在以下情况下开始变得更有意义：

*   你**要按位做一些事情**，比如掩码，或者
*   您**迫切**希望利用符号位**来获得额外的正值范围**。

就个人而言，我喜欢签名，因为我不相信自己会保持一致并避免混合两种类型（就像文章警告的那样）。

* * *

## 回答 #2

> 赞同：10
> 
> 时间：2008-08-02T04:31:54.803

在上面的示例中，当 'i' 始终为正并且更高的范围将是有益的时，无符号将很有用。就像您使用“声明”语句一样，例如：

```
#declare BIT1 (unsigned int 1)
#declare BIT32 (unsigned int reallybignumber) 
```

特别是当这些值永远不会改变时。

但是，如果您正在执行一个会计程序，其中人们对他们的钱不负责任并且经常处于亏损状态，那么您肯定会想要使用“签名”。

我确实同意圣徒的观点，但一个好的经验法则是使用带符号的，C 实际上默认使用它，所以你被覆盖了。

* * *

## 回答 #3

> 赞同：10
> 
> 时间：2008-11-10T19:04:05.793

我认为，如果您的业务案例表明负数无效，您会*希望*显示或抛出错误。

With that in mind, I only just recently found out about unsigned integers while working on a project processing data in a binary file and storing the data into a database. I was purposely "corrupting" the binary data, and ended up getting negative values instead of an expected error. I found that even though the value converted, the value was not valid for my business case.
My program did not error, and I ended up getting wrong data into the database. It would have been better if I had used `uint` and had the program fail.

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2008-08-04T13:35:41.273

当您比较有符号和无符号类型时，C 和 C++ 编译器会生成警告；在您的示例代码中，您不能使循环变量无符号并让编译器生成没有警告的代码（假设上述警告已打开）。

自然地，您编译时会出现警告，对吗？

而且，您是否考虑过使用“将警告视为错误”进行编译以更进一步？

使用有符号数字的缺点是有重载它们的诱惑，例如，值 0->n 是菜单选择，-1 表示没有选择任何内容 - 而不是创建一个有两个变量的类，一个指示是否选择了某些东西，另一个用于存储该选择是什么。在不知不觉中，您正在到处测试负数，编译器抱怨您希望如何将菜单选择与您拥有的菜单选择数量进行比较——但这很危险，因为它们是不同的类型. 所以不要那样做。

* * *

## 回答 #5

> 赞同：6
> 
> 时间：2008-08-02T05:51:57.247

`size_t`这通常是一个不错的选择，或者`size_type`如果您使用的是 STL 类。

# python - Python 中的 XML 处理

> ID：337
> 
> 赞同：82
> 
> 时间：2008-08-02T03:35:55.697
> 
> 标签：python, xml

我即将构建一个需要构建 XML 文档并将其发布到 Web 服务的项目的一部分，并且我想用 Python 来完成它，作为扩展我在其中的技能的一种手段。

不幸的是，虽然我非常了解 .NET 中的 XML 模型，但我不确定 Python 中的 XML 模型的优缺点是什么。

有人有在 Python 中进行 XML 处理的经验吗？你建议我从哪里开始？我将要构建的 XML 文件将相当简单。

* * *

## 回答 #1

> 赞同：35
> 
> 时间：2008-08-02T04:01:34.600

就我个人而言，我在一个 XML 繁重的项目中使用了几个内置选项，并决定将[pulldom](http://docs.python.org/lib/module-xml.dom.pulldom.html)作为不太复杂的文档的最佳选择。

特别是对于简单的小东西，我喜欢事件驱动的解析理论，而不是为一个相对简单的结构设置一大堆回调。 [这是关于如何使用 API 的一个很好的快速讨论](http://www.prescod.net/python/pulldom.html)。

我喜欢的是：您可以在`for`循环中处理解析，而不是使用回调。您还会延迟完整解析（“拉”部分），并且仅在调用`expandNode()`. 这在不牺牲易用性和简单性的情况下满足了我对“负责任”效率的一般要求。

* * *

## 回答 #2

> 赞同：33
> 
> 时间：2008-08-02T15:21:03.587

[ElementTree](http://effbot.org/zone/element-index.htm)有一个不错的 pythony API。我认为它甚至作为 python 2.5 的一部分提供

它是在纯 python 中，正如我所说，非常好，但如果你最终需要更高的性能，那么[lxml](http://codespeak.net/lxml/)会公开相同的 API 并在后台使用 libxml2。理论上，您可以在发现需要时将其换掉。

* * *

## 回答 #3

> 赞同：8
> 
> 时间：2008-09-16T04:35:28.113

通常有 3 种主要的处理 XML 的方法：dom、sax 和 xpath。如果您有能力一次将整个 xml 文件加载到内存中，并且您不介意处理数据结构，并且您正在查看大部分/大部分模型，则 dom 模型很好。如果您只关心几个标签，并且/或者您正在处理大文件并且可以按顺序处理它们，那么 sax 模型非常棒。xpath 模型各有一点——您可以选择所需数据元素的路径，但它需要使用更多库。

如果你想直接使用 Python 打包，minidom 是你的答案，但它很蹩脚，文档是“这里是 dom 上的文档，去弄清楚”。这真的很烦人。

就个人而言，我喜欢 cElementTree，它是 ElementTree 的一个更快（基于 c 的）实现，它是一个类似 dom 的模型。

我使用过 sax 系统，在很多方面它们的感觉更像是“pythonic”，但我通常最终会创建基于状态的系统来处理它们，而这就是疯狂（和错误）。

如果你喜欢研究，我说使用 minidom，如果你想要运行良好的好代码，我会说使用 ElementTree。

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2008-09-23T19:42:58.003

我已经在几个项目中使用过 ElementTree 并推荐它。

它是 Python 的，随 Python 2.5 一起提供，包括 c 版本的 cElementTree (xml.etree.cElementTree)，它比纯 Python 版本快 20 倍，并且非常易于使用。

lxml 具有一些性能优势，但它们并不均衡，您应该首先针对您的用例检查基准。

据我了解，ElementTree 代码可以很容易地移植到 lxml。

* * *

## 回答 #5

> 赞同：8
> 
> 时间：2008-10-14T18:26:04.833

这在一定程度上取决于文档需要有多复杂。

我在编写 XML 时经常使用 minidom，但通常只是读取文档，进行一些简单的转换，然后将它们写回。直到我需要对元素属性进行排序的能力（以满足不能正确解析 XML 的古老应用程序）之前，这已经足够好用了。那时我放弃了，自己编写了 XML。

如果您只处理简单的文档，那么自己动手会比学习框架更快、更简单。如果您可以想象手动编写 XML，那么您也可以手动编写它（只需记住正确转义特殊字符，并使用`str.encode(codec, errors="xmlcharrefreplace")`）。除了这些混乱之外，XML 足够规则，以至于您*不需要*特殊的库来编写它。如果文档太复杂而无法手动编写，那么您可能应该查看已经提到的框架之一。在任何时候都不需要编写通用的 XML 编写器。

* * *

## 回答 #6

> 赞同：7
> 
> 时间：2011-10-31T14:05:09.450

您也可以尝试[untangle](https://github.com/stchris/untangle)来解析简单的 XML 文档。

* * *

## 回答 #7

> 赞同：6
> 
> 时间：2008-08-02T18:04:10.543

由于您提到您将构建“相当简单”的 XML，[minidom 模块](http://www.python.org/doc/current/lib/module-xml.dom.minidom.html)（Python 标准库的一部分）可能会满足您的需要。如果您对 XML 的 DOM 表示有任何经验，您应该会发现该 API 非常简单。

* * *

## 回答 #8

> 赞同：6
> 
> 时间：2008-08-03T08:34:57.103

我编写了一个接收 XML 请求并创建 XML 响应的 SOAP 服务器。（不幸的是，这不是我的项目，所以它是封闭源代码，但这是另一个问题）。

对我来说，如果您有一个“适合”模式的数据结构，那么创建 (SOAP) XML 文档是相当简单的。

我保留信封，因为响应信封（几乎）与请求信封相同。然后，由于我的数据结构是一个（可能是嵌套的）字典，我创建了一个字符串，将该字典转换为 <key>value</key> 项。

这是递归简化的任务，我最终得到了正确的结构。这一切都是在 python 代码中完成的，目前对于生产使用来说已经足够快了。

您也可以（相对）轻松地构建列表，尽管取决于您的客户，除非您给出长度提示，否则您可能会遇到问题。

对我来说，这要简​​单得多，因为字典比一些自定义类更容易工作。对于书籍而言，生成 XML 比解析要容易得多！

* * *

## 回答 #9

> 赞同：5
> 
> 时间：2014-04-17T21:32:13.397

# 在 Python 中认真使用 XML 时，请使用 lxml

Python 带有 ElementTree 内置库，但 lxml 在速度和功能（模式验证、sax 解析、XPath、各种迭代器和许多其他特性）方面对其进行了扩展。

您必须安装它，但在许多地方，它已经被假定为标准设备的一部分（例如，Google AppEngine 不允许基于 C 的 Python 包，但对 lxml、pyyaml 和其他少数几个例外）。

# 使用 E-factory 构建 XML 文档（来自 lxml）

您的问题是关于构建 XML 文档。

使用lxml有很多方法，我花了一段时间才找到一个，它似乎易于使用且易于阅读。

[来自lxml doc 中关于使用 E-factory 的](http://lxml.de/tutorial.html#the-e-factory)示例代码（略微简化）：

* * *

E-factory 为生成 XML 和 HTML 提供了一种简单而紧凑的语法：

```
>>> from lxml.builder import E

>>> html = page = (
...   E.html(       # create an Element called "html"
...     E.head(
...       E.title("This is a sample document")
...     ),
...     E.body(
...       E.h1("Hello!"),
...       E.p("This is a paragraph with ", E.b("bold"), " text in it!"),
...       E.p("This is another paragraph, with a", "\n      ",
...         E.a("link", href="http://www.python.org"), "."),
...       E.p("Here are some reserved characters: <spam&egg>."),
...     )
...   )
... )

>>> print(etree.tostring(page, pretty_print=True))
<html>
  <head>
    <title>This is a sample document</title>
  </head>
  <body>
    <h1>Hello!</h1>
    <p>This is a paragraph with <b>bold</b> text in it!</p>
    <p>This is another paragraph, with a
      <a href="http://www.python.org">link</a>.</p>
    <p>Here are some reserved characters: &lt;spam&amp;egg&gt;.</p>
  </body>
</html> 
```

* * *

我很欣赏 E-factory 它遵循的东西

### 代码几乎与生成的 XML 文档一样读取

可读性很重要。

### 允许创建任何 XML 内容

支持以下内容：

*   命名空间的使用
*   一个元素内的开始和结束文本节点
*   格式化属性内容的函数（参见[完整 lxml 示例](http://lxml.de/tutorial.html#the-e-factory)中的 func CLASS ）

### 允许带有列表的非常易读的结构

例如：

```
from lxml import etree
from lxml.builder import E
lst = ["alfa", "beta", "gama"]
xml = E.root(*[E.record(itm) for itm in lst])
etree.tostring(xml, pretty_print=True) 
```

导致：

```
<root>
  <record>alfa</record>
  <record>beta</record>
  <record>gama</record>
</root> 
```

## 结论

我强烈推荐阅读 lxml 教程——它写得很好，会给你更多使用这个强大库的理由。

lxml 唯一的缺点是它必须被编译。有关如何在几分之一秒内从 wheel 格式包安装 lxml[的更多提示](https://stackoverflow.com/a/23141779/346478)，请参阅SO answer。

* * *

## 回答 #10

> 赞同：3
> 
> 时间：2012-12-12T03:25:50.733

我强烈推荐`SAX - Simple API for XML`- 在 Python 库中实现。正如之前的海报所讨论的，它们相当容易通过 evendriven 设置和处理`XML`，`API`并且与验证`DOM`样式`XML`解析器不同，内存占用量低。

* * *

## 回答 #11

> 赞同：2
> 
> 时间：2008-09-16T06:20:01.683

我假设 .NET 处理 XML 的方式建立在某个版本的 MSXML 之上，在这种情况下，我假设使用例如 minidom 会让您有宾至如归的感觉。但是，如果您正在进行简单的处理，任何库都可能会这样做。

在 Python 中处理 XML 时，我也更喜欢使用 ElementTree，因为它是一个非常简洁的库。

* * *

## 回答 #12

> 赞同：2
> 
> 时间：2008-10-13T22:17:10.467

如果您要构建 SOAP 消息，请查看[soaplib](http://trac.optio.webfactional.com/)。它在底层使用 ElementTree，但它为序列化和反序列化消息提供了更简洁的接口。

# string - 生成字符串所有可能排列的列表

> ID：361
> 
> 赞同：164
> 
> 时间：2008-08-02T06:57:57.957
> 
> 标签：string, language-agnostic, cross-platform

我将如何生成一个长度在 x 和 y 字符之间的字符串的所有可能排列的列表，其中包含一个可变的字符列表。

任何语言都可以，但它应该是可移植的。

* * *

## 回答 #1

> 赞同：69
> 
> 时间：2008-08-02T07:48:07.607

有几种方法可以做到这一点。常用方法使用递归、记忆化或动态编程。基本思想是您生成一个长度为 1 的所有字符串的列表，然后在每次迭代中，对于上一次迭代中生成的所有字符串，将该字符串分别与字符串中的每个字符连接起来。（下面代码中的变量索引跟踪上一次和下一次迭代的开始）

一些伪代码：

```
list = originalString.split('')
index = (0,0)
list = [""]
for iteration n in 1 to y:
  index = (index[1], len(list))
  for string s in list.subset(index[0] to end):
    for character c in originalString:
      list.add(s + c) 
```

然后，您需要删除所有长度小于 x 的字符串，它们将是列表中的第一个 (x-1) * len(originalString) 条目。

* * *

## 回答 #2

> 赞同：40
> 
> 时间：2012-01-10T18:00:20.177

最好使用回溯

```
#include <stdio.h>
#include <string.h>

void swap(char *a, char *b) {
    char temp;
    temp = *a;
    *a = *b;
    *b = temp;
}

void print(char *a, int i, int n) {
    int j;
    if(i == n) {
        printf("%s\n", a);
    } else {
        for(j = i; j <= n; j++) {
            swap(a + i, a + j);
            print(a, i + 1, n);
            swap(a + i, a + j);
        }
    }
}

int main(void) {
    char a[100];
    gets(a);
    print(a, 0, strlen(a) - 1);
    return 0;
} 
```

* * *

## 回答 #3

> 赞同：26
> 
> 时间：2008-08-05T04:57:52.987

你会得到很多字符串，这是肯定的......

![\sum_{i=x}^y{\frac{r!}{{(ri)}!}}](../Images/5180bc02a8bd48926178252e99645294.png)
其中 x 和 y 是您定义它们的方式，而 r 是我们从中选择的字符数——如果我理解正确的话。您绝对应该根据需要生成这些，而不是草率地说，生成一个 powerset 然后过滤字符串的长度。

以下绝对不是生成这些的最佳方法，但它仍然很有趣。

Knuth（第 4 卷，第 2 分册，7.2.1.3）告诉我们，(s,t)-combination 等价于 s+1 个事物，每次 t 重复使用 - (s,t)-combination 是Knuth 等于![{t \选择 {s+t}](../Images/be87d141fe5089a25bd9579d20e6c89f.png)。我们可以通过首先生成二进制形式的每个 (s,t)-组合（因此，长度为 (s+t)）并计算每个 1 左侧的 0 的数量来解决这个问题。

10001000011101 --> 变成排列：{0, 3, 4, 4, 4, 1}

* * *

## 回答 #4

> 赞同：15
> 
> 时间：2010-11-09T13:58:06.167

根据 Knuth，Python 示例的非递归解决方案：

```
def nextPermutation(perm):
    k0 = None
    for i in range(len(perm)-1):
        if perm[i]<perm[i+1]:
            k0=i
    if k0 == None:
        return None

    l0 = k0+1
    for i in range(k0+1, len(perm)):
        if perm[k0] < perm[i]:
            l0 = i

    perm[k0], perm[l0] = perm[l0], perm[k0]
    perm[k0+1:] = reversed(perm[k0+1:])
    return perm

perm=list("12345")
while perm:
    print perm
    perm = nextPermutation(perm) 
```

* * *

## 回答 #5

> 赞同：13
> 
> 时间：2008-11-14T19:36:49.200

您可能会查看“[有效地枚举集合的子集](http://applied-math.org/subset.pdf)”，它描述了一种算法来完成您想要的部分工作 - 快速生成从长度 x 到 y 的 N 个字符的所有子集。它包含 C 中的实现。

对于每个子集，您仍然必须生成所有排列。例如，如果你想要“abcde”中的 3 个字符，这个算法会给你“abc”、“abd”、“abe”……但你必须对每个字符进行置换才能得到“acb”、“bac”、 “bca”等

* * *

## 回答 #6

> 赞同：13
> 
> 时间：2010-04-04T18:18:01.510

一些基于[Sarp 的回答的](https://stackoverflow.com/questions/361/generate-list-of-all-possible-permutations-of-a-string/147211#147211)Java 代码：

```
public class permute {

    static void permute(int level, String permuted,
                    boolean used[], String original) {
        int length = original.length();
        if (level == length) {
            System.out.println(permuted);
        } else {
            for (int i = 0; i < length; i++) {
                if (!used[i]) {
                    used[i] = true;
                    permute(level + 1, permuted + original.charAt(i),
                       used, original);
                    used[i] = false;
                }
            }
        }
    }

    public static void main(String[] args) {
        String s = "hello";
        boolean used[] = {false, false, false, false, false};
        permute(0, "", used, s);
    }
} 
```

* * *

## 回答 #7

> 赞同：13
> 
> 时间：2010-07-05T09:06:37.387

这是 C# 中的一个简单解决方案。

它只生成给定字符串的不同排列。

```
 static public IEnumerable<string> permute(string word)
    {
        if (word.Length > 1)
        {

            char character = word[0];
            foreach (string subPermute in permute(word.Substring(1)))
            {

                for (int index = 0; index <= subPermute.Length; index++)
                {
                    string pre = subPermute.Substring(0, index);
                    string post = subPermute.Substring(index);

                    if (post.Contains(character))
                            continue;                       

                    yield return pre + character + post;
                }

            }
        }
        else
        {
            yield return word;
        }
    } 
```

* * *

## 回答 #8

> 赞同：12
> 
> 时间：2014-01-08T11:00:51.093

这里有很多很好的答案。我还建议在 C++ 中使用一个非常简单的递归解决方案。

```
#include <string>
#include <iostream>

template<typename Consume>
void permutations(std::string s, Consume consume, std::size_t start = 0) {
    if (start == s.length()) consume(s);
    for (std::size_t i = start; i < s.length(); i++) {
        std::swap(s[start], s[i]);
        permutations(s, consume, start + 1);
    }
}

int main(void) {
    std::string s = "abcd";
    permutations(s, [](std::string s) {
        std::cout << s << std::endl;
    });
} 
```

**注意**：具有重复字符的字符串不会产生唯一的排列。

* * *

## 回答 #9

> 赞同：8
> 
> 时间：2008-08-02T07:56:07.933

我只是在 Ruby 中快速完成了这个：

```
def perms(x, y, possible_characters)
  all = [""]
  current_array = all.clone
  1.upto(y) { |iteration|
    next_array = []
    current_array.each { |string|
      possible_characters.each { |c|
        value = string + c
        next_array.insert next_array.length, value
        all.insert all.length, value
      }
    }
    current_array = next_array
  }
  all.delete_if { |string| string.length < x }
end 
```

您可能会研究用于内置排列类型函数的语言 API，并且您可能能够编写更优化的代码，但如果数字都那么高，我不确定是否有很多方法可以得到很多结果.

无论如何，代码背后的想法是从长度为 0 的字符串开始，然后跟踪所有长度为 Z 的字符串，其中 Z 是迭代中的当前大小。然后，遍历每个字符串并将每个字符附加到每个字符串上。最后，删除任何低于 x 阈值的内容并返回结果。

我没有使用可能毫无意义的输入（空字符列表、x 和 y 的奇怪值等）对其进行测试。

* * *

## 回答 #10

> 赞同：8
> 
> 时间：2008-09-16T05:15:26.813

这是 Mike 的 Ruby 版本到 Common Lisp 的翻译：

```
(defun perms (x y original-string)
  (loop with all = (list "")
        with current-array = (list "")
        for iteration from 1 to y
        do (loop with next-array = nil
                 for string in current-array
                 do (loop for c across original-string
                          for value = (concatenate 'string string (string c))
                          do (push value next-array)
                             (push value all))
                    (setf current-array (reverse next-array)))
        finally (return (nreverse (delete-if #'(lambda (el) (< (length el) x)) all))))) 
```

还有另一个版本，稍微短一些，使用更多的循环设施功能：

```
(defun perms (x y original-string)
  (loop repeat y
        collect (loop for string in (or (car (last sets)) (list ""))
                      append (loop for c across original-string
                                   collect (concatenate 'string string (string c)))) into sets
        finally (return (loop for set in sets
                              append (loop for el in set when (>= (length el) x) collect el))))) 
```

* * *

## 回答 #11

> 赞同：8
> 
> 时间：2008-09-29T01:34:58.510

C ++中的递归解决方案

```
int main (int argc, char * const argv[]) {
        string s = "sarp";
        bool used [4];
        permute(0, "", used, s);
}

void permute(int level, string permuted, bool used [], string &original) {
    int length = original.length();

    if(level == length) { // permutation complete, display
        cout << permuted << endl;
    } else {
        for(int i=0; i<length; i++) { // try to add an unused character
            if(!used[i]) {
                used[i] = true;
                permute(level+1, original[i] + permuted, used, original); // find the permutations starting with this string
                used[i] = false;
            }
        }
} 
```

* * *

## 回答 #12

> 赞同：8
> 
> 时间：2008-10-20T00:17:50.220

下面是一个简单的单词 C# 递归解决方案：

**方法：**

```
public ArrayList CalculateWordPermutations(string[] letters, ArrayList words, int index)
        {
            bool finished = true;
            ArrayList newWords = new ArrayList();
            if (words.Count == 0)
            {
                foreach (string letter in letters)
                {
                    words.Add(letter);
                }
            }

            for(int j=index; j<words.Count; j++)
            {
                string word = (string)words[j];
                for(int i =0; i<letters.Length; i++)
                {
                    if(!word.Contains(letters[i]))
                    {
                        finished = false;
                        string newWord = (string)word.Clone();
                        newWord += letters[i];
                        newWords.Add(newWord);
                    }
                }
            }

            foreach (string newWord in newWords)
            {   
                words.Add(newWord);
            }

            if(finished  == false)
            {
                CalculateWordPermutations(letters, words, words.Count - newWords.Count);
            }
            return words;
        } 
```

**来电：**

```
string[] letters = new string[]{"a","b","c"};
ArrayList words = CalculateWordPermutations(letters, new ArrayList(), 0); 
```

* * *

## 回答 #13

> 赞同：8
> 
> 时间：2011-02-07T21:56:58.350

...这是C版本：

```
void permute(const char *s, char *out, int *used, int len, int lev)
{
    if (len == lev) {
        out[lev] = '\0';
        puts(out);
        return;
    }

    int i;
    for (i = 0; i < len; ++i) {
        if (! used[i])
            continue;

        used[i] = 1;
        out[lev] = s[i];
        permute(s, out, used, len, lev + 1);
        used[i] = 0;
    }
    return;
} 
```

* * *

## 回答 #14

> 赞同：8
> 
> 时间：2011-02-22T18:45:03.570

> 置换 (ABC) -> A.perm(BC) -> A.perm[B.perm(C)] -> A.perm[( ***B** *C), (C* **B*** )] -> [( ***A** *BC ), (B* **A** *C), (BC* **A*** ), ( ***A** *CB), (C* **A** *B), (CB* **A*** )] 要在插入每个字母表时删除重复项，请检查前一个字符串是否以相同的字母表结尾（为什么？-锻炼）

```
public static void main(String[] args) {

    for (String str : permStr("ABBB")){
        System.out.println(str);
    }
}

static Vector<String> permStr(String str){

    if (str.length() == 1){
        Vector<String> ret = new Vector<String>();
        ret.add(str);
        return ret;
    }

    char start = str.charAt(0);
    Vector<String> endStrs = permStr(str.substring(1));
    Vector<String> newEndStrs = new Vector<String>();
    for (String endStr : endStrs){
        for (int j = 0; j <= endStr.length(); j++){
            if (endStr.substring(0, j).endsWith(String.valueOf(start)))
                break;
            newEndStrs.add(endStr.substring(0, j) + String.valueOf(start) + endStr.substring(j));
        }
    }
    return newEndStrs;
} 
```

打印没有重复的所有排列

* * *

## 回答 #15

> 赞同：7
> 
> 时间：2009-02-15T10:02:43.563

在 Perl 中，如果你想限制自己使用小写字母，你可以这样做：

```
my @result = ("a" .. "zzzz"); 
```

这给出了使用小写字符的 1 到 4 个字符之间的所有可能字符串。对于大写，更改`"a"`为`"A"`和。`"zzzz"``"ZZZZ"`

对于混合大小写，它变得更加困难，并且可能无法使用 Perl 的内置运算符之一来实现。

* * *

## 回答 #16

> 赞同：7
> 
> 时间：2012-04-20T00:21:53.210

有效的红宝石答案：

```
class String
  def each_char_with_index
    0.upto(size - 1) do |index|
      yield(self[index..index], index)
    end
  end
  def remove_char_at(index)
    return self[1..-1] if index == 0
    self[0..(index-1)] + self[(index+1)..-1]
  end
end

def permute(str, prefix = '')
  if str.size == 0
    puts prefix
    return
  end
  str.each_char_with_index do |char, index|
    permute(str.remove_char_at(index), prefix + char)
  end
end

# example
# permute("abc") 
```

* * *

## 回答 #17

> 赞同：7
> 
> 时间：2013-06-19T04:23:42.563

以下 Java 递归打印给定字符串的所有排列：

```
//call it as permut("",str);

public void permut(String str1,String str2){
    if(str2.length() != 0){
        char ch = str2.charAt(0);
        for(int i = 0; i <= str1.length();i++)
            permut(str1.substring(0,i) + ch + str1.substring(i,str1.length()),
                     str2.substring(1,str2.length()));
    }else{
    System.out.println(str1);
    }
} 
```

以下是上述“permut”方法的更新版本，它使 n! (n 阶乘) 与上述方法相比，递归调用更少

```
//call it as permut("",str);

public void permut(String str1,String str2){
   if(str2.length() > 1){
       char ch = str2.charAt(0);
       for(int i = 0; i <= str1.length();i++)
          permut(str1.substring(0,i) + ch + str1.substring(i,str1.length()),
                 str2.substring(1,str2.length()));
   }else{
    char ch = str2.charAt(0);
    for(int i = 0; i <= str1.length();i++)
        System.out.println(str1.substring(0,i) + ch +    str1.substring(i,str1.length()),
                 str2.substring(1,str2.length()));
   }
} 
```

* * *

## 回答 #18

> 赞同：6
> 
> 时间：2010-10-24T22:01:36.817

```
import java.util.*;

public class all_subsets {
    public static void main(String[] args) {
        String a = "abcd";
        for(String s: all_perm(a)) {
            System.out.println(s);
        }
    }

    public static Set<String> concat(String c, Set<String> lst) {
        HashSet<String> ret_set = new HashSet<String>();
        for(String s: lst) {
            ret_set.add(c+s);
        }
        return ret_set;
    }

    public static HashSet<String> all_perm(String a) {
        HashSet<String> set = new HashSet<String>();
        if(a.length() == 1) {
            set.add(a);
        } else {
            for(int i=0; i<a.length(); i++) {
                set.addAll(concat(a.charAt(i)+"", all_perm(a.substring(0, i)+a.substring(i+1, a.length()))));
            }
        }
        return set;
    }
} 
```

* * *

## 回答 #19

> 赞同：5
> 
> 时间：2008-08-02T09:40:54.693

我不确定你为什么要首先这样做。任何中等大的 x 和 y 值的结果集都将是巨大的，并且会随着 x 和/或 y 变大而呈指数增长。

假设您的可能字符集是字母表中的 26 个小写字母，并且您要求您的应用程序生成长度 = 5 的所有排列。假设您没有耗尽内存，您将获得 11,881,376（即 26 次方） 5) 字符串返回。将该长度增加到 6，您将获得 308,915,776 个字符串。这些数字很快就变得非常大。

这是我用 Java 编写的解决方案。您需要提供两个运行时参数（对应于 x 和 y）。玩得开心。

```
public class GeneratePermutations {
    public static void main(String[] args) {
        int lower = Integer.parseInt(args[0]);
        int upper = Integer.parseInt(args[1]);

        if (upper < lower || upper == 0 || lower == 0) {
            System.exit(0);
        }

        for (int length = lower; length <= upper; length++) {
            generate(length, "");
        }
    }

    private static void generate(int length, String partial) {
        if (length <= 0) {
            System.out.println(partial);
        } else {
            for (char c = 'a'; c <= 'z'; c++) {
                generate(length - 1, partial + c);
            }
        }
    }
} 
```

* * *

## 回答 #20

> 赞同：5
> 
> 时间：2011-08-03T07:11:34.030

这是我在javascript中提出的非递归版本。它不是基于上面 Knuth 的非递归的，尽管它在元素交换方面有一些相似之处。我已经验证了它对最多 8 个元素的输入数组的正确性。

快速优化将是预飞行`out`阵列并避免`push()`.

基本思想是：

1.  给定一个源数组，生成第一组新数组，依次将第一个元素与每个后续元素交换，每次都保持其他元素不受干扰。例如：给定 1234，生成 1234、2134、3214、4231。

2.  使用前一次遍历中的每个数组作为新遍历的种子，但不是交换第一个元素，而是将第二个元素与每个后续元素交换。另外，这一次，不要在输出中包含原始数组。

3.  重复步骤 2 直到完成。

这是代码示例：

```
function oxe_perm(src, depth, index)
{
    var perm = src.slice();     // duplicates src.
    perm = perm.split("");
    perm[depth] = src[index];
    perm[index] = src[depth];
    perm = perm.join("");
    return perm;
}

function oxe_permutations(src)
{
    out = new Array();

    out.push(src);

    for (depth = 0; depth < src.length; depth++) {
        var numInPreviousPass = out.length;
        for (var m = 0; m < numInPreviousPass; ++m) {
            for (var n = depth + 1; n < src.length; ++n) {
                out.push(oxe_perm(out[m], depth, n));
            }
        }
    }

    return out;
} 
```

* * *

## 回答 #21

> 赞同：3
> 
> 时间：2008-09-15T17:32:15.787

在红宝石中：

```
str = "a"
100_000_000.times {puts str.next!} 
```

它非常快，但需要一些时间 =)。当然，如果你对短字符串不感兴趣，你可以从“aaaaaaaa”开始。

不过，我可能误解了实际问题 - 在其中一篇文章中，听起来好像您只需要一个蛮力的字符串库，但在主要问题中，听起来您需要置换一个特定的字符串。

你的问题有点类似于这个：[http](http://beust.com/weblog/archives/000491.html) ://beust.com/weblog/archives/000491.html （列出所有没有数字重复的整数，这导致了很多语言解决它，用ocaml 人使用排列，一些 java 人使用另一种解决方案）。

* * *

## 回答 #22

> 赞同：3
> 
> 时间：2011-10-02T09:13:57.093

我今天需要这个，尽管已经给出的答案为我指明了正确的方向，但它们并不是我想要的。

这是一个使用 Heap 方法的实现。数组的长度必须至少为 3 并且出于实际考虑不大于 10 左右，具体取决于您想要做什么，耐心和时钟速度。

在进入循环之前，`Perm(1 To N)`使用第一个排列、`Stack(3 To N)`零*和`Level`**`2`进行初始化。在循环调用结束时`NextPerm`，完成后将返回 false。

* VB 会为你做到这一点。

** 您可以稍微更改 NextPerm 以使其变得不必要，但这样更清晰。

```
Option Explicit

Function NextPerm(Perm() As Long, Stack() As Long, Level As Long) As Boolean
Dim N As Long
If Level = 2 Then
    Swap Perm(1), Perm(2)
    Level = 3
Else
    While Stack(Level) = Level - 1
        Stack(Level) = 0
        If Level = UBound(Stack) Then Exit Function
        Level = Level + 1
    Wend
    Stack(Level) = Stack(Level) + 1
    If Level And 1 Then N = 1 Else N = Stack(Level)
    Swap Perm(N), Perm(Level)
    Level = 2
End If
NextPerm = True
End Function

Sub Swap(A As Long, B As Long)
A = A Xor B
B = A Xor B
A = A Xor B
End Sub

'This is just for testing.
Private Sub Form_Paint()
Const Max = 8
Dim A(1 To Max) As Long, I As Long
Dim S(3 To Max) As Long, J As Long
Dim Test As New Collection, T As String
For I = 1 To UBound(A)
    A(I) = I
Next
Cls
ScaleLeft = 0
J = 2
Do
    If CurrentY + TextHeight("0") > ScaleHeight Then
        ScaleLeft = ScaleLeft - TextWidth(" 0 ") * (UBound(A) + 1)
        CurrentY = 0
        CurrentX = 0
    End If
    T = vbNullString
    For I = 1 To UBound(A)
        Print A(I);
        T = T & Hex(A(I))
    Next
    Print
    Test.Add Null, T
Loop While NextPerm(A, S, J)
J = 1
For I = 2 To UBound(A)
    J = J * I
Next
If J <> Test.Count Then Stop
End Sub 
```

其他方法由不同的作者描述。Knuth 描述了两种，一种给出词汇顺序，但复杂而缓慢，另一种被称为平易近人的方法。高杰和王殿军也写了一篇有趣的论文。

* * *

## 回答 #23

> 赞同：3
> 
> 时间：2014-02-13T21:08:50.737

这是一个描述如何打印字符串排列的链接。 [http://nipun-linuxtips.blogspot.in/2012/11/print-all-permutations-of-characters-in.html](http://nipun-linuxtips.blogspot.in/2012/11/print-all-permutations-of-characters-in.html)

* * *

## 回答 #24

> 赞同：2
> 
> 时间：2011-05-26T14:22:12.887

python 中的这段代码，当调用`allowed_characters`设置为`[0,1]`和最多 4 个字符时，将生成 2^4 个结果：

`['0000', '0001', '0010', '0011', '0100', '0101', '0110', '0111', '1000', '1001', '1010', '1011', '1100', '1101', '1110', '1111']`

```
def generate_permutations(chars = 4) :

#modify if in need!
    allowed_chars = [
        '0',
        '1',
    ]

    status = []
    for tmp in range(chars) :
        status.append(0)

    last_char = len(allowed_chars)

    rows = []
    for x in xrange(last_char ** chars) :
        rows.append("")
        for y in range(chars - 1 , -1, -1) :
            key = status[y]
            rows[x] = allowed_chars[key] + rows[x]

        for pos in range(chars - 1, -1, -1) :
            if(status[pos] == last_char - 1) :
                status[pos] = 0
            else :
                status[pos] += 1
                break;

    return rows

import sys

print generate_permutations() 
```

希望这对你有用。适用于任何字符，而不仅仅是数字

* * *

## 回答 #25

> 赞同：2
> 
> 时间：2021-02-16T16:52:25.070

以前的许多答案都使用了回溯。这是在初始排序后**生成排列的渐近最优方式 O(n*n!)**

```
class Permutation {

    /* runtime -O(n) for generating nextPermutaion
     * and O(n*n!) for generating all n! permutations with increasing sorted array as start
     * return true, if there exists next lexicographical sequence
     * e.g [a,b,c],3-> true, modifies array to [a,c,b]
     * e.g [c,b,a],3-> false, as it is largest lexicographic possible */
    public static boolean nextPermutation(char[] seq, int len) {
        // 1
        if (len <= 1)
            return false;// no more perm
        // 2: Find last j such that seq[j] <= seq[j+1]. Terminate if no such j exists
        int j = len - 2;
        while (j >= 0 && seq[j] >= seq[j + 1]) {
            --j;
        }
        if (j == -1)
            return false;// no more perm
        // 3: Find last l such that seq[j] <= seq[l], then exchange elements j and l
        int l = len - 1;
        while (seq[j] >= seq[l]) {
            --l;
        }
        swap(seq, j, l);
        // 4: Reverse elements j+1 ... count-1:
        reverseSubArray(seq, j + 1, len - 1);
        // return seq, add store next perm

        return true;
    }
    private static void swap(char[] a, int i, int j) {
        char temp = a[i];
        a[i] = a[j];
        a[j] = temp;
    }

    private static void reverseSubArray(char[] a, int lo, int hi) {
        while (lo < hi) {
            swap(a, lo, hi);
            ++lo;
            --hi;
        }
    }
    public static void main(String[] args) {
        String str = "abcdefg";
        char[] array = str.toCharArray();
        Arrays.sort(array);
        int cnt=0;
        do {
            System.out.println(new String(array));
            cnt++;
        }while(nextPermutation(array, array.length));
        System.out.println(cnt);//5040=7!
    }
    //if we use "bab"-> "abb", "bab", "bba", 3(#permutations)
} 
```

* * *

## 回答 #26

> 赞同：1
> 
> 时间：2020-09-20T13:25:48.970

递归方法

```
func StringPermutations(inputStr string) (permutations []string) {
    for i := 0; i < len(inputStr); i++ {
        inputStr = inputStr[1:] + inputStr[0:1]
        if len(inputStr) <= 2 {
            permutations = append(permutations, inputStr)
            continue
        }
        leftPermutations := StringPermutations(inputStr[0 : len(inputStr)-1])
        for _, leftPermutation := range leftPermutations {
            permutations = append(permutations, leftPermutation+inputStr[len(inputStr)-1:])
        }
    }
    return
} 
```

* * *

## 回答 #27

> 赞同：0
> 
> 时间：2008-09-16T05:33:25.930

虽然这不能准确回答您的问题，但这里有一种方法可以从多个相同长度的字符串中生成字母的每个排列：例如，如果您的单词是“coffee”、“joomla”和“moodle”，您可以期望输出像“coodle”、“joodee”、“joffle”等。

基本上，组合的数量是（单词数）的幂（每个单词的字母数）。因此，在 0 和组合数 - 1 之间选择一个随机数，将该数字转换为基数（单词数），然后使用该数字的每个数字作为从哪个单词中获取下一个字母的指示符。

例如：在上面的例子中。3 个单词，6 个字母 = 729 种组合。选择一个随机数：465。转换为基数 3：122020。从单词 1 中取出第一个字母，从单词 2 中取出第 2 个字母，从单词 2 中取出第 3 个字母，从单词 0 中取出第 4 个字母......你会得到......“joofle”。

如果您想要所有排列，只需从 0 到 728 循环。当然，如果您只是选择一个随机值，那么~~更简单~~且不易混淆的方法是遍历字母。如果你想要所有的排列，这个方法可以让你避免递归，而且它让你看起来像你知道数学^(（tm）)！

如果组合的数量过多，您可以将其分解为一系列较小的单词并在最后将它们连接起来。

* * *

## 回答 #28

> 赞同：0
> 
> 时间：2012-07-26T15:20:23.230

c#迭代：

```
public List<string> Permutations(char[] chars)
    {
        List<string> words = new List<string>();
        words.Add(chars[0].ToString());
        for (int i = 1; i < chars.Length; ++i)
        {
            int currLen = words.Count;
            for (int j = 0; j < currLen; ++j)
            {
                var w = words[j];
                for (int k = 0; k <= w.Length; ++k)
                {
                    var nstr = w.Insert(k, chars[i].ToString());
                    if (k == 0)
                        words[j] = nstr;
                    else
                        words.Add(nstr);
                }
            }
        }
        return words;
    } 
```

* * *

## 回答 #29

> 赞同：0
> 
> 时间：2013-07-05T04:15:14.483

python中的递归解决方案。这段代码的好处是它导出了一个字典，键是字符串，所有可能的排列都是值。包括所有可能的字符串长度，因此实际上，您正在创建一个超集。

如果您只需要最终排列，则可以从字典中删除其他键。

在这段代码中，排列字典是全局的。

在基本情况下，我将值作为两种可能性存储在一个列表中。`perms['ab'] = ['ab','ba']`.

对于较高的字符串长度，该函数引用较低的字符串长度并结合先前计算的排列。

该函数做了两件事：

*   用较小的字符串调用自己
*   如果已经可用，则返回特定字符串的排列列表。如果返回到自身，这些将用于附加到字符并创建更新的排列。

内存贵。

```
perms = {}
def perm(input_string):
    global perms
    if input_string in perms:
        return perms[input_string] # This will send a list of all permutations
    elif len(input_string) == 2:
        perms[input_string] = [input_string, input_string[-1] + input_string [-2]]
        return perms[input_string]
    else:
        perms[input_string] = []
        for index in range(0, len(input_string)):
            new_string = input_string[0:index] + input_string[index +1:]
            perm(new_string)
            for entries in perms[new_string]:
                perms[input_string].append(input_string[index] + entries)
    return perms[input_string] 
```

* * *

## 回答 #30

> 赞同：0
> 
> 时间：2013-08-22T17:51:53.097

```
def gen( x,y,list): #to generate all strings inserting y at different positions
list = []
list.append( y+x )
for i in range( len(x) ):
    list.append( func(x,0,i) + y + func(x,i+1,len(x)-1) )
return list 

def func( x,i,j ): #returns x[i..j]
z = '' 
for i in range(i,j+1):
    z = z+x[i]
return z 

def perm( x , length , list ): #perm function
if length == 1 : # base case
    list.append( x[len(x)-1] )
    return list 
else:
    lists = perm( x , length-1 ,list )
    lists_temp = lists #temporarily storing the list 
    lists = []
    for i in range( len(lists_temp) ) :
        list_temp = gen(lists_temp[i],x[length-2],lists)
        lists += list_temp 
    return lists 
```

* * *

## 回答 #31

> 赞同：0
> 
> 时间：2013-10-19T01:34:11.233

使用驱动程序方法的递归解决方案`main()`。

```
public class AllPermutationsOfString {
public static void stringPermutations(String newstring, String remaining) {
    if(remaining.length()==0)
        System.out.println(newstring);

    for(int i=0; i<remaining.length(); i++) {
        String newRemaining = remaining.replaceFirst(remaining.charAt(i)+"", "");
        stringPermutations(newstring+remaining.charAt(i), newRemaining);
    }
}

public static void main(String[] args) {
    String string = "abc";
    AllPermutationsOfString.stringPermutations("", string); 
} 
```

}

* * *

## 回答 #32

> 赞同：0
> 
> 时间：2014-01-23T03:28:19.943

```
def permutation(str)
  posibilities = []
  str.split('').each do |char|
    if posibilities.size == 0
      posibilities[0] = char.downcase
      posibilities[1] = char.upcase
    else
      posibilities_count = posibilities.length
      posibilities = posibilities + posibilities
      posibilities_count.times do |i|
        posibilities[i] += char.downcase
        posibilities[i+posibilities_count] += char.upcase
      end
    end
  end
  posibilities
end 
```

这是我对非递归版本的看法

* * *

## 回答 #33

> 赞同：0
> 
> 时间：2014-07-13T07:51:36.230

蟒蛇解决方案：

```
from itertools import permutations
s = 'ABCDEF'
p = [''.join(x) for x in permutations(s)] 
```

* * *

## 回答 #34

> 赞同：0
> 
> 时间：2015-06-27T08:44:42.390

那么这是一个优雅的、非递归的 O(n!) 解决方案：

```
public static StringBuilder[] permutations(String s) {
        if (s.length() == 0)
            return null;
        int length = fact(s.length());
        StringBuilder[] sb = new StringBuilder[length];
        for (int i = 0; i < length; i++) {
            sb[i] = new StringBuilder();
        }
        for (int i = 0; i < s.length(); i++) {
            char ch = s.charAt(i);
            int times = length / (i + 1);
            for (int j = 0; j < times; j++) {
                for (int k = 0; k < length / times; k++) {
                    sb[j * length / times + k].insert(k, ch);
                }
            }
        }
        return sb;
    } 
```

* * *

## 回答 #35

> 赞同：0
> 
> 时间：2016-06-05T08:42:14.117

为java语言编写的代码：

包 namo.algorithms;

导入 java.util.Scanner；

公共类排列{

```
public static int totalPermutationsCount = 0;
    public static void main(String[] args) {

        Scanner sc = new Scanner(System.in);
        System.out.println("input string : ");
        String inputString = sc.nextLine();
        System.out.println("given input String ==> "+inputString+ " :: length is = "+inputString.length());
        findPermuationsOfString(-1, inputString);
        System.out.println("**************************************");
        System.out.println("total permutation strings ==> "+totalPermutationsCount);
    }

    public  static void findPermuationsOfString(int fixedIndex, String inputString) {
        int currentIndex = fixedIndex +1;

        for (int i = currentIndex; i < inputString.length(); i++) {
            //swap elements and call the findPermuationsOfString()

            char[] carr = inputString.toCharArray();
            char tmp = carr[currentIndex];
            carr[currentIndex] = carr[i];
            carr[i] = tmp;
            inputString =  new String(carr);

            //System.out.println("chat At : current String ==> "+inputString.charAt(currentIndex));
            if(currentIndex == inputString.length()-1) {
                totalPermutationsCount++;
                System.out.println("permuation string ==> "+inputString);
            } else {
                //System.out.println("in else block>>>>");
                findPermuationsOfString(currentIndex, inputString);
                 char[] rarr = inputString.toCharArray();
                    char rtmp = carr[i];
                    carr[i] = carr[currentIndex];
                    carr[currentIndex] = rtmp;
                    inputString =  new String(carr);
            }
        }
    } 
```

}

* * *

## 回答 #36

> 赞同：-1
> 
> 时间：2017-02-06T06:00:48.347

可以使用递归函数计算可能的字符串排列。以下是可能的解决方案之一。

```
public static String insertCharAt(String s, int index, char c) {
        StringBuffer sb = new StringBuffer(s);
        StringBuffer sbb = sb.insert(index, c);
        return sbb.toString();
}

public static ArrayList<String> getPerm(String s, int index) {
        ArrayList<String> perm = new ArrayList<String>();

        if (index == s.length()-1) {
            perm.add(String.valueOf(s.charAt(index)));
            return perm;
        }

        ArrayList<String> p = getPerm(s, index+1);
        char c = s.charAt(index);

        for(String pp : p) {
            for (int idx=0; idx<pp.length()+1; idx++) {
                String ss = insertCharAt(pp, idx, c);
                perm.add(ss);
            }
        }

        return perm;    
}

public static void testGetPerm(String s) {
        ArrayList<String> perm = getPerm(s,0);
        System.out.println(s+" --> total permutation are :: "+perm.size());
        System.out.println(perm.toString());
} 
```

# email - 如何确保以编程方式发送的电子邮件不会自动标记为垃圾邮件？

> ID：371
> 
> 赞同：453
> 
> 时间：2008-08-02T08:19:18.260
> 
> 标签：email, email-spam

这是一个棘手的问题，我一直依赖技术，例如基于权限的电子邮件（即只发送给您有权发送的人），而不是使用公然*的垃圾邮件*术语。

最近，我以编程方式发送的一些电子邮件已经开始自动进入人们的垃圾邮件文件夹，我想知道我能做些什么。

尽管这些特定的电子邮件不会被人类标记为垃圾邮件，具体来说，它们是包含人们已经支付了很多钱的许可证密钥的电子邮件，所以我认为他们不会认为它们是垃圾邮件

我认为这是一个很大的话题，我本质上是一个无知的傻瓜。

* * *

## 回答 #1

> 赞同：348
> 
> 时间：2008-08-02T10:21:54.300

使用电子邮件认证方法，例如[SPF](http://en.wikipedia.org/wiki/Sender_Policy_Framework)和[DKIM](https://help.ubuntu.com/community/Postfix/DKIM)来证明您的电子邮件和您的域名属于同一个，并防止您的域名被欺骗。SPF 网站包含一个为您的站点生成 DNS 信息的向导。

[检查](http://remote.12dt.com/)您的[反向 DNS](http://en.wikipedia.org/wiki/Reverse_DNS_lookup)以确保您的邮件服务器的 IP 地址指向您用于发送邮件的域名。

确保您使用的 IP 地址[不在黑名单上](http://www.spamhaus.org/lookup.lasso)

确保回复地址是有效的现有地址。

在“收件人”字段中使用收件人的完整真实姓名，而不仅仅是电子邮件地址（例如`"John Smith" <john@blacksmiths-international.com>`）。

监控您的滥用帐户，例如 abuse@yourdomain.com 和 postmaster@yourdomain.com。这意味着 - 确保这些帐户存在，阅读发送给他们的内容，并对投诉采取行动。

最后，让退订变得**非常**容易。否则，您的用户将通过按**垃圾邮件**按钮取消订阅，这将影响您的声誉。

也就是说，让 Hotmail 接受您的电子邮件仍然是一门黑艺术。

* * *

## 回答 #2

> 赞同：30
> 
> 时间：2008-08-02T23:00:53.237

在尽可能多的主要电子邮件提供商上注册一个帐户（gmail/yahoo/hotmail/aol/等）。如果您对电子邮件进行更改，无论是重大改写、更改发送电子邮件的代码、更改您的电子邮件服务器等，请确保将测试邮件发送到您的所有帐户并确认它们没有被标记为垃圾邮件。

* * *

## 回答 #3

> 赞同：26
> 
> 时间：2010-04-05T16:37:33.087

[上一个答案](https://stackoverflow.com/questions/1658043/troubleshooting-php-mail/1658064#1658064)的几个要点：

*   **最重要的是：**发件人地址（“发件人”）是否属于在您发送电子邮件的服务器上运行的域？如果没有，那就这样吧。切勿使用发件人地址，例如`xxx@gmail.com`. 用户`reply-to`如果您需要回复以到达不同的地址。

*   您的服务器是否在黑名单上（例如在 spamhaus.org 上检查 IP）？当邻居表现不佳时，当您在共享主机上时，这是一种可能性。

*   邮件是否被垃圾邮件过滤器过滤？使用具有垃圾邮件文件夹的免费邮件程序打开一个帐户并找出答案。此外，请尝试将邮件发送到完全不过滤垃圾邮件的地址。

*   您是否可能需要 mail() 的第五个参数“-f”来添加发件人地址？（参见 PHP 手册中的 mail() 命令）

*   如果您有权访问日志文件，当然要检查这些文件。

*   您是否检查“发件人：”地址是否有可能的退回邮件（“退回给发件人”）？您还可以设置一个单独的“出错地址”。

* * *

## 回答 #4

> 赞同：25
> 
> 时间：2008-08-02T08:32:04.287

您可以告诉您的用户在完成订单时将您的发件人地址添加到他们的联系人中，如果他们这样做，将会有很大帮助。

否则，我会尝试从您的一些用户那里获取日志。有时他们会在邮件的标题中详细说明为什么它被标记为垃圾邮件，您可以使用它来调整文本。

您可以尝试的其他事情：

*   将您的网站名称或地址放在主题中
*   将邮件中的所有链接都指向您的域（而不是 email.com）
*   在电子邮件中输入地址或其他联系信息

* * *

## 回答 #5

> 赞同：24
> 
> 时间：2008-08-03T01:39:56.117

在发送电子邮件之前，请确认您拥有正确的电子邮件地址。如果有人在注册时提供了错误的电子邮件地址，请尽快击败他们。

始终在每封电子邮件中包含明确的“如何退订”信息。不要求用户登录退订，它应该是一键退订的唯一网址。

这将防止人们将您的邮件标记为垃圾邮件，因为“退订”太难了。

* * *

## 回答 #6

> 赞同：17
> 
> 时间：2012-10-03T19:21:46.057

除了所有其他答案之外，如果您要发送包含 URL 作为链接文本的 HTML 电子邮件，请确保 URL 与链接文本匹配。我知道如果不是，Thunderbird 会自动将它们标记为骗局。

错误的方法：

```
Go to your account now: <a href="http://www.paypal.com.phishers-anonymous.org/">http://www.paypal.com</a> 
```

正确的方式：

```
Go to your account now: <a href="http://www.yourdomain.org/">http://www.yourdomain.org</a> 
```

或者使用不相关的链接文本而不是 URL：

```
<a href="http://www.yourdomain.org/">Click here to go to your account</a> 
```

* * *

## 回答 #7

> 赞同：16
> 
> 时间：2008-08-06T15:12:16.537

您可以考虑处理交付问题的第三方电子邮件服务：

*   确切目标
*   垂直响应
*   持续接触
*   活动监视器
*   艾玛
*   返回路径
*   智能联系
*   银色流行音乐

* * *

## 回答 #8

> 赞同：16
> 
> 时间：2008-08-13T13:44:47.530

有时，发送电子邮件就像黑魔法一样。反向 DNS 非常重要。

我发现仔细跟踪 NDR 非常有帮助。我将所有 NDR 定向到一个地址，并且我有一个 Windows 服务将它们解析出来（Google ListNanny）。我将尽可能多的来自 NDR 的信息放入数据库，然后运行报告以查看我是否突然开始被某个域阻止。此外，您应该避免向以前标记为 NDR 的地址发送电子邮件，因为这通常是垃圾邮件的良好指示。

如果您需要一次发送一堆客户服务电子邮件，最好在每封电子邮件之间设置一个延迟，因为如果您一次向一个域发送太多几乎相同的电子邮件，您肯定会收到他们的邮件。黑名单。

有些域有时无法交付。Comcast.net 是最糟糕的。

确保您的 IP 未在[http://www.mxtoolbox.com/blacklists.aspx](http://www.mxtoolbox.com/blacklists.aspx)等网站上列出。

* * *

## 回答 #9

> 赞同：15
> 
> 时间：2008-11-08T18:24:04.223

我不想告诉你，但我和其他人可能正在使用白名单默认值来控制我们对垃圾邮件的过滤。

这意味着来自未知来源的所有电子邮件都会自动成为垃圾邮件并转移到垃圾邮件文件夹中。（我不会让我的电子邮件服务删除垃圾邮件，因为我想始终检查到达的误报，通过快速扫描文件夹很容易做到这一点。）

我什至有来自自己的电子邮件进入垃圾邮件桶，因为（1）我通常不向自己发送电子邮件，并且（2）有垃圾邮件发送者在发送给我的垃圾邮件中伪造我的回信地址。

因此，要摆脱垃圾邮件的指定，我必须考虑您的邮件可能是合法的（来自发件人和主题信息）并首先以纯文本形式打开它（我对所有传入邮件的默认设置，无论是否为垃圾邮件）以查看它是否合法. 我的垃圾邮件文件夹不会使用电子邮件中的任何链接，因此我可以防止棘手的图像链接和其他不当行为。

如果我希望将来来自同一来源的邮件进入我的收件箱而不被转用于垃圾邮件审查，我将向我的电子邮件客户端指定。对于那些使用批量邮件转发器和每个邮件的唯一发件人地址的组织来说，这太糟糕了。他们从来没有得到我的认可，总是出现在我的垃圾邮件文件夹中，如果我很忙，我永远不会看他们。

最后，如果一封电子邮件在纯文本中无法辨认，即使以 HTML 格式发送，我也很可能会删除它，除非我知道它是由于来源和以前的宝贵经验而对我感兴趣的东西。

正如您所看到的，它最终处于用户控制之下，并且没有任何自动化行为可以让这样的系统相信您的邮件仅从其结构来看是合法的。在这种情况下，您需要表现得很好，不要做任何类似于网络钓鱼的事情，并让愿意信任您的邮件的用户轻松将您添加到他们的白名单中。

* * *

## 回答 #10

> 赞同：14
> 
> 时间：2008-08-02T13:45:57.197

雅虎使用一种称为发件人 ID 的方法，可以在[SPF 设置向导](http://old.openspf.org/wizard.html?mydomain=stackoverflow.com)中进行配置并输入到您的 DNS 中。对于 Exchange、Hotmail、AOL、Yahoo 和其他人来说，重要的之一是为您的域提供反向 DNS。这些将解决大部分问题。但是，您永远无法阻止某人故意阻止您或自定义规则。

* * *

## 回答 #11

> 赞同：14
> 
> 时间：2008-08-11T00:59:26.203

我的应用程序的一封电子邮件经常被标记为垃圾邮件。它是带有单个链接的 html，我在正文中以文本/html 内容类型的 html 形式发送。

我对这个问题最成功的解决方案是撰写电子邮件，使其看起来像是由电子邮件客户端生成的。

我将电子邮件更改为多部分/替代 mime 文档，现在我生成 text/plain 和 text/html 部分。

Outlook 不再将电子邮件检测为垃圾邮件。

* * *

## 回答 #12

> 赞同：12
> 
> 时间：2008-08-06T01:54:22.433

您需要一个反向 DNS 条目。您不需要将相同的内容发送给同一用户两次。您需要使用一些常见的 webmail 和电子邮件客户端对其进行测试。就我个人而言，我通过一个新安装的垃圾邮件刺客、一个训练有素的垃圾邮件刺客以及多个 hotmail、gmail 和 aol 帐户来运行我的。

但是您是否看到过似乎没有链接到或宣传任何内容的垃圾邮件？这是一个试图影响您的贝叶斯过滤器的垃圾邮件发送者。如果他能获得高评价，然后在他未来的电子邮件中包含一些单词，那么它可能会自动学习为好。因此，您无法真正猜测在您发送邮件时用户的过滤器将被设置为什么。

最后，我没有按域对列表进行排序，而是将其随机化。

* * *

## 回答 #13

> 赞同：11
> 
> 时间：2008-08-03T13:57:01.633

我发现在正文中使用收件人的真实姓名是通过垃圾邮件过滤器的可靠方法。

* * *

## 回答 #14

> 赞同：8
> 
> 时间：2008-08-13T13:13:47.623

在英国，最好的做法也是为您的公司提供真实的实际地址及其注册号码。

这样一来，一切都是公开和诚实的，他们不太可能手动将其标记为垃圾邮件。

* * *

## 回答 #15

> 赞同：8
> 
> 时间：2008-08-31T12:50:48.400

我要补充：

单击“退订”后提供真正的退订。我见过真正的时事通讯提供了一个虚拟退订链接，点击显示“已成功退订”，但我仍会收到更多时事通讯。

* * *

## 回答 #16

> 赞同：8
> 
> 时间：2012-05-18T19:04:26.110

您可以做的最重要的事情是确保您向其发送电子邮件的人在收到您的电子邮件时不太可能点击“垃圾邮件”按钮。因此，请遵守以下经验法则：

*   确保您已获得要向其发送电子邮件的人的许可。永远不要向没有向您请求的人发送电子邮件。

*   在每条消息的顶部清楚地确定您是谁，以及该人收到电子邮件的原因。

*   至少每月一次，向您列表中的人发送一封提醒电子邮件（如果您正在运行列表），迫使他们选择重新加入列表，以便继续接收您的通信。是的，这意味着你的名单会随着时间的推移而变短，但好处是你名单上的人被“收买”了，不太可能标记你的电子邮件。

*   保持您的内容高度相关和有用。

*   为人们提供一种简单的方式来选择退出进一步的通信。

*   使用像 SendGrid 这样的电子邮件发送服务，努力维护良好的 IP 声誉。

*   避免使用短链接 - 这些通常被列入黑名单。

遵循这些经验法则会有很长的路要走。

* * *

## 回答 #17

> 赞同：7
> 
> 时间：2008-08-06T19:31:01.397

过去，我在工作中在这里做过的许多网站上都遇到过同样的问题。确保用户收到电子邮件的唯一有保证的方法是建议用户将您添加到安全列表中。任何其他方法实际上只是可以帮助它并且不能保证的东西。

* * *

## 回答 #18

> 赞同：7
> 
> 时间：2017-01-28T22:51:01.410

很可能是注册您的服务的人在输入电子邮件时输入了您未更正的输入错误。例如：**chris@gmial.com** -或- **james@hotnail.com**。

并且此类域被配置为用作*垃圾邮件陷阱*，它将自动标记您的电子邮件服务器的 IP 和/或域并损害其声誉。

为避免这种情况，请仔细检查您在订阅产品时输入的电子邮件地址。此外，在向他们发送产品密钥或接受他们的订阅之前，发送一封确认电子邮件以真正确保该电子邮件地址 100% 由输入确认电子邮件的人验证。验证电子邮件应要求收件人单击链接或回复，以便真正确认邮箱的所有者是注册人。

* * *

## 回答 #19

> 赞同：5
> 
> 时间：2008-10-28T13:28:51.067

听起来您正在根据一些反馈来确定接收端卡住了什么。您应该自己检查出站邮件是否存在明显的“垃圾邮件”。

购买任何像样的垃圾邮件控制系统，并通过它发送出站邮件。如果您发送大量邮件，则无论如何都应该这样做，因为存在发送出站病毒的风险，特别是如果您有桌面 Windows 用户。

例如，Proofpoint 在单个部署中包含垃圾邮件 + 防病毒 + 一些信誉服务。（我曾经在那里工作，所以我碰巧知道这一点。我相信这个领域的其他供应商也有类似的功能。）但你明白了。如果您通过基本的商业垃圾邮件控制设置发送邮件，但它没有通过，则它不应该离开您的网络。

此外，还有一些公司可以帮助您提高非垃圾邮件、出站电子邮件的发送率，例如人身保护令。

* * *

## 回答 #20

> 赞同：4
> 
> 时间：2018-01-03T11:16:07.153

谷歌为此提供了工具和指南。您可以在以下网址找到它们： [https](https://postmaster.google.com/) ://postmaster.google.com/注册并验证您的域名，Google 会提供该 IP 地址和域的单独评分。

从[批量发件人指南](https://support.google.com/mail/answer/81126)：

身份验证可确保您的邮件可以正确分类。缺乏身份验证的电子邮件很可能会被拒绝或放入垃圾邮件文件夹，因为它们很可能是用于网络钓鱼诈骗的伪造邮件。此外，出于安全原因，带有附件的未经身份验证的电子邮件可能会被彻底拒绝。

为确保 Gmail 可以识别您的身份：

*   使用一致的 IP 地址发送批量邮件。
*   为您发送邮件的 IP 地址保留有效的反向 DNS 记录，并指向您的域。
*   在您发送的每封批量邮件的“发件人：”标题中使用相同的地址。我们还推荐以下内容：

*   使用 DKIM 签署消息。我们不会验证使用少于 1024 位的密钥签名的消息。

*   发布 SPF 记录。
*   发布 DMARC 政策。

* * *

## 回答 #21

> 赞同：3
> 
> 时间：2017-06-27T08:19:19.687

我总是使用： [https ://www.mail-tester.com/](https://www.mail-tester.com/)

它给了我关于发送电子邮件的技术部分的反馈。像 SPF-records、DKIM、Spamassassin score 等等。即使我知道需要什么，我还是会不断出错，mail-tester.com 可以很容易地找出可能出错的地方。

* * *

## 回答 #22

> 赞同：2
> 
> 时间：2020-06-15T14:01:21.883

首先，您需要确保所需的电子邮件身份验证机制（如 SPF 和 DKIM）到位。这两种是证明您是电子邮件的实际发件人并且不是真正的欺骗的突出方式。这减少了电子邮件被过滤为垃圾邮件的机会。

第二件事是，您可以根据不同的 DNSBL 检查您的域名的反向 DNS 输出。在终端上使用以下简单命令：

```
 **dig a +short (domain-name).(blacklist-domain-name)**

  ie.  dig a +short example.com.dsn.rfc-clueless.org
  > 127.0.0.2 
```

在上述示例中，这意味着您的域“example.com”被列入黑名单，但由于域设置合规性（rfc-clueless.org 列出存在合规性问题的域）

*注意：我更喜欢[multivalley](http://multirbl.valli.org/)和[pepipost 工具](https://tools.pepipost.com/email-blacklist-checker)来检查域列表。*

from address/reply-to-id 应该是正确的，始终在您的电子邮件正文中使用可见的取消订阅按钮（这将帮助您的用户从您的电子邮件列表中退出而不会破坏您的域声誉）

* * *

## 回答 #23

> 赞同：2
> 
> 时间：2020-11-19T14:44:40.003

大多数以编程方式生成的电子邮件的目的通常是事务性的、触发性的或警报性质的——这意味着这些是重要的电子邮件，不应成为垃圾邮件。

话虽如此，在将电子邮件标记为垃圾邮件之前需要考虑多个参数。虽然电子邮件列表的质量是要考虑的最重要的参数，但我在这里从讨论中跳过它，因为这里我们谈论的是发送给我们自己或已知电子邮件地址的重要电子邮件。

除了列表质量，其他 3 个重要参数是：

1.  发件人信誉
2.  符合电子邮件标准和身份验证（SPF、DKIM、DMARC、rDNS）
3.  电子邮件内容

**发件人信誉 = 发送 IP 地址的信誉 + 返回路径/信封域的信誉 + 从域的信誉。**

您的发件人信誉没有直接的答案。这是因为有多个权威机构，如 SenderScore、声誉权威机构等，他们维护您的域的声誉评分。除了 Gmail、Yahoo、Outlook 等 ISP 之外，它们还维护每个域的声誉。

但是，您可以使用**GradeMyEmail**等免费工具来 360 度全方位了解您的声誉以及电子邮件设置的潜在问题或任何其他与合规相关的问题。

**有时，如果您使用新域来发送电子邮件，那么也会发现这些域进入垃圾邮件。您应该检查您的域是否列在任何全局阻止列表中。同样，GradeMyEmail 和 MultiRBL 是识别黑名单列表的有用工具。**

一旦您非常确定发件人信誉评分，您应该检查您的电子邮件发送域是否符合所有电子邮件身份验证和标准。

1.  防晒指数
2.  DKIM
3.  DMARC
4.  反向 DNS

为此，您可以再次使用 GradeMyEmail 或 MXToolbox 来了解您的身份验证的潜在问题。

您的 SPF、DKIM 和 DMARC 应始终通过，以确保您的电子邮件符合标准电子邮件身份验证。以下是这些身份验证在 Gmail 中的外观示例： [![电子邮件认证](../Images/ca00305df0a9b142441b44a087d19d21.png)](https://i.stack.imgur.com/ZK2Ud.png)

同样，您可以使用 Mail-Tester 之类的工具来扫描完整的电子邮件内容并告诉可能触发垃圾邮件过滤器的潜在关键字。

* * *

## 回答 #24

> 赞同：1
> 
> 时间：2019-08-19T21:46:54.143

要允许**DMARC**检查 SPF 通过并在使用 sendmail 时**对齐**，请确保将信封发件人地址（`-f`或参数）设置为与标头地址`-r`中的域匹配的内容。`From:`

## 使用 PHP：

使用 PHP 的内置`mail()`函数而不设置第 5 个参数将导致 DMARC SPF 检查如果未正确完成则未对齐。默认情况下，sendmail 将使用网络服务器的用户作为[RFC5321](https://www.rfc-editor.org/rfc/rfc5321) .MailFrom / Return Path 标头发送电子邮件。

例如，假设您`domain.com`在`host.com`Web 服务器上托管您的网站。如果不设置附加参数参数：

```
mail($to,$subject,$message,$headers); // Wrong way 
```

电子邮件收件人将收到一封包含以下邮件标题的电子邮件：

```
Return-Path: <your-website-user@server.host.com>
From: <your-website-user@domain.com> 
```

即使这通过了 SPF 检查，它也会未对齐（因为 domain.com 和 host.com 不匹配），这意味着 DMARC SPF 检查将因未对齐而失败。

相反，您**必须**通过在 PHP`mail()`函数中包含第 5 个参数来将信封发件人地址传递给 sendmail，例如：

```
mail($to,$subject,$message,$headers, '-r bounce_email@domain.com'); // Right way 
```

在这种情况下，电子邮件收件人将收到一封包含以下邮件标头的电子邮件：

```
Return-Path: <bounce_email@domain.com>
From: <your-website-user@domain.com> 
```

由于这两个标头都包含来自 的地址`domain.com`，因此 SPF 将通过并对齐，这意味着 DMARC 也将通过 SPF 检查。

# java - 某些 Java 泛型类型转换中的类型安全警告是什么意思？

> ID：382
> 
> 赞同：80
> 
> 时间：2008-08-02T08:58:27.540
> 
> 标签：java, generics, warnings, casting, type-safety

*Java 警告*的含义是什么？

> 类型安全：从 Object 到 List<Integer> 的转换实际上是在检查擦除的类型 List

当我尝试将 Object 强制转换为具有通用信息的类型时，我收到此警告，例如在以下代码中：

```
Object object = getMyList();
List<Integer> list = (List<Integer>) object; 
```

* * *

## 回答 #1

> 赞同：54
> 
> 时间：2008-08-02T08:58:48.430

出现此警告是因为 Java 实际上并未在运行时将类型信息存储在使用泛型的对象中。因此，如果`object`实际上是 a `List<String>`，则在运行时将没有`ClassCastException`，除非从列表中访问与变量中定义的泛型类型不匹配的项目。

如果项目被添加到列表中，这可能会导致进一步的复杂性，并且使用这种不正确的通用类型信息。任何仍然持有对列表的引用但具有正确的泛型类型信息的代码现在将具有不一致的列表。

要删除警告，请尝试：

```
List<?> list = (List<?>) object; 
```

但是，请注意，您将无法使用某些方法，例如 add，因为编译器不知道您是否尝试添加不正确类型的对象。上面的方法在很多情况下都有效，但如果你必须使用 add 或一些类似的受限方法，你将不得不在 Eclipse 中遇到黄色下划线（或`SuppressWarning`注释）。

# search - Lucene 评分结果

> ID：387
> 
> 赞同：44
> 
> 时间：2008-08-02T09:28:17.683
> 
> 标签：search, lucene

在 Lucene 中，如果您有多个索引，每个索引只覆盖一个分区。为什么在不同的索引上进行相同的搜索会返回不同分数的结果？来自不同服务器的结果完全匹配。

即，如果我搜索：

*   姓名 - 约翰·史密斯
*   出生日期 - 1934 年 11 月 11 日

**分区 0**将返回 0.345 的分数

**分区 1**将返回 0.337 的分数

两者都完全匹配名称和出生日期。

* * *

## 回答 #1

> 赞同：19
> 
> 时间：2008-08-02T09:51:00.883

[评分](http://lucene.apache.org/core/3_6_0/api/all/org/apache/lucene/search/Similarity.html)包含逆文档频率（IDF）。如果术语“John Smith”在一个分区中，0 次，100 次，在分区 1 中，一次。在分区 1 中搜索 John Smith 的得分会更高，因为该词更稀缺。

为了解决这个问题，您必须让您的索引覆盖所有分区，或者您需要覆盖 IDF。

* * *

## 回答 #2

> 赞同：13
> 
> 时间：2008-08-02T09:52:36.870

因为如果我没有完全弄错的话，分数是在指数上确定的。

如果您有不同的索引（索引的更多/更少或不同的数据），分数会有所不同：

[http://lucene.apache.org/core/3_6_0/scoring.html](http://lucene.apache.org/core/3_6_0/scoring.html)

（警告：包含数学:-)）

* * *

## 回答 #3

> 赞同：8
> 
> 时间：2008-08-02T20:03:06.483

您可能还对[`explain()`方法](https://lucene.apache.org/core/3_6_2/api/all/org/apache/lucene/search/IndexSearcher.html#explain(org.apache.lucene.search.Query,%20int))的输出和结果[`Explanation`对象](https://lucene.apache.org/core/3_6_0/api/all/org/apache/lucene/search/Explanation.html)感兴趣，这将使您了解事物的评分方式。

# ios - 横向模式下的 iPhone 应用程序，2008 系统

> ID：402
> 
> 赞同：99
> 
> 时间：2008-08-02T10:47:08.460
> 
> 标签：ios, objective-c, landscape

请注意，这个问题来自 2008 年，现在仅具有历史意义。

* * *

无论设备的位置如何，创建从一开始就以横向模式运行的 iPhone 应用程序的最佳方法是什么？

以编程方式和使用 Interface Builder。

* * *

## 回答 #1

> 赞同：47
> 
> 时间：2010-03-27T21:13:17.970

# 仅历史性答案。过时了。

请注意，这个答案现在已经非常过时了/

这个答案**只是历史的好奇**。

* * *

令人振奋的消息！正如下面 Andrew 所发现的，Apple 已在 4.0+ 中修复了此问题。

看起来不再需要在每个视图上强制视图的大小，并且景观“仅在第一次工作”的具体严重问题已经解决。

截至 2011 年 4 月，无法测试甚至构建低于 4.0 的任何东西，所以这个问题纯粹是历史上的好奇。这么长时间给开发者带来了多大的麻烦，真是不可思议！

* * *

这是原始的讨论和解决方案。现在这完全无关紧要，因为这些系统甚至无法运行。

* * *

要完全完成这项工作是极其困难的——至少有三个问题/错误在起作用。

试试这个..[界面生成器景观设计](http://www.iphonedevsdk.com/forum/iphone-sdk-development/7366-interface-builder-landscape-design.html#post186977)

特别注意它说*“并且你需要在任何地方正确使用 shouldAutorotateToInterfaceOrientation”*它意味着无处不在，你的所有全屏视图。

希望对这场噩梦有所帮助！

***一个重要的提醒是手头***的另一个众所周知的问题：如果您尝试在多个视图（所有景观）之间进行交换，***它根本不起作用***。记住这一点很重要，否则你会在这个问题上浪费几天的时间。这实际上是不可能的。这是 iOS 平台上最大的已知漏洞。从字面上看，没有办法让硬件使您加载的第二个视图成为风景。烦人但简单的解决方法，以及您必须做的，是拥有一个微不足道的主 UIViewController，它什么也不做，只是坐在那里让您在视图之间交换。

换句话说，在 iOS 中因为一个重大的已知错误：

```
[window addSubview:happyThing.view];
[window makeKeyAndVisible]; 
```

***你只能这样做一次***。稍后，如果您尝试删除 happyThing.view，而是将 newThing.view 放在那里，它不起作用 - 就是这样。机器永远不会将视图旋转为横向。没有任何技巧可以修复，即使 Apple 也无法使其正常工作。您必须采用的解决方法是拥有一个整体 UIViewController，它只是坐在那里并只保存您的各种视图（happyThing、newThing 等）。希望能帮助到你！

* * *

## 回答 #2

> 赞同：40
> 
> 时间：2008-08-31T14:38:14.460

来自 Apple 开发网站：

> 要以横向模式启动应用程序以便状态栏立即位于适当的位置，请编辑 Info.plist 文件以添加具有适当值（UIInterfaceOrientationLandscapeRight 或 UIInterfaceOrientationLandscapeLeft）的 UIInterfaceOrientation 键，如清单 2 所示。
> 
> 清单 2：以横向模式启动应用程序
> 
> ```
> <key>UIInterfaceOrientation</key>
> <string>UIInterfaceOrientationLandscapeRight</string> 
> ```

* * *

## 回答 #3

> 赞同：28
> 
> 时间：2010-05-07T11:02:01.247

*所有帖子的总结和整合，经过我自己的测试；检查下面的 4.x、5.x 的更新。*

从 3.2 开始，您无法从代码更改正在运行的应用程序的方向。

但是您可以以固定的方向启动应用程序，尽管这样做并不简单。

试试这个食谱：

1.  `UISupportedInterfaceOrientations`在`Info.plist`文件中设置您的方向
2.  在您的窗口中定义一个 480x320 的“基本视图控制器”。每个其他视图都将作为子视图添加到其视图中。
3.  在所有视图控制器中设置`shouldAutorotateToInterfaceOrientation:`方法（当然，返回您在 plist 中定义的相同值）
4.  在所有视图控制器中设置背景视图

    `self.view.frame = CGRectMake(0, 0, 480, 320)`

    在`viewDidLoad`方法中。

**更新（iOS 4.x、5.x）**：Apple iOS App Programming Guide 在“Advanced App Tricks”一章中有“Launching in Landscape Mode”段落。

参考：

*   [界面生成器景观设计](http://www.iphonedevsdk.com/forum/iphone-sdk-development/7366-interface-builder-landscape-design.html#post186977)
*   [界面生成器景观设计-1](http://www.iphonedevsdk.com/forum/iphone-sdk-development/7366-interface-builder-landscape-design.html#post190014)

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2009-11-20T20:58:38.277

首先我在 info.plist 中设置

```
<key>UIInterfaceOrientation</key>
<string>UIInterfaceOrientationLandscapeRight</string> 
```

然后我把这段代码放在 applicationDidFinishLaunching 中：

```
CGAffineTransform rotate = CGAffineTransformMakeRotation(1.57079633);
[window setTransform:rotate];

CGRect contentRect = CGRectMake(0, 0, 480, 320); 
window.bounds = contentRect; 
[window setCenter:CGPointMake(160.0f, 240.0f)]; 
```

这样我就可以在 Interface Builder 中以横向模式处理视图。

* * *

## 回答 #5

> 赞同：7
> 
> 时间：2008-08-31T15:01:21.957

sasb 和 michaelpryor 的回答似乎是正确的，但如果它不适合你，试试这个替代方案：

```
- (void)applicationDidFinishLaunchingUIApplication *)application {
    application.statusBarOrientation = UIInterfaceOrientationLandscapeRight;
} 
```

或者这个：

```
[[UIDevice currentDevice] setOrientation:UIInterfaceOrientationLandscapeRight]; 
```

或者这个：

```
[application setStatusBarOrientation: UIInterfaceOrientationLandscapeRight animated:NO]; 
```

您可能还需`window makeKeyAndVisible;`要先打电话。

几个链接：[在横向模式下开发](http://www.iphonedevsdk.com/forum/iphone-sdk-development/1664-developing-landscape-mode.html)，[iPhone SDK：如何只强制横向模式？](http://discussions.apple.com/thread.jspa?threadID=1454154&tstart=135)

@Robert：请参阅[iPhone SDK、NDA 和 Stack Overflow](https://stackoverflow.com/questions/23482/the-iphone-sdk-nda-and-stack-overflow)。

* * *

## 回答 #6

> 赞同：6
> 
> 时间：2010-11-27T07:38:02.030

我很惊讶还没有人提出这个答案：

`shouldAutorotateToInterfaceOrientation`在我的所有测试中，当关闭模态视图控制器时，即使是 UINavigationController 的一部分，也会尊重父视图控制器的首选方向设置。所以解决这个问题很简单：

创建一个带有 UIImageView 作为背景的虚拟 UIViewController。将图像设置为您的应用在启动时使用的 default.png 图像。

当`viewWillAppear`在你的根视图控制器中被调用时，只显示没有动画的虚拟视图控制器。

当`viewDidAppear`在您的虚拟视图控制器中被调用时，使用漂亮的交叉溶解动画关闭视图控制器。

这不仅有效，而且看起来不错！顺便说一句，为了澄清，我这样做根视图控制器是`viewWillAppear`这样的：

```
- (void)viewWillAppear:(BOOL)animated
{
 if ( dummy != nil ) {
  [dummy setModalTransitionStyle:UIModalTransitionStyleCrossDissolve];
  [self presentModalViewController:dummy animated:NO];
  [dummy release];
  dummy = nil;
 }
...
} 
```

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2008-09-04T21:57:05.077

最新的 iPhone OS 编程指南对此有完整的部分，并附有示例代码。我相信这是最近添加的，所以也许你错过了。它解释了您必须遵守的所有条件；基本上...

*   设置 Info.plist 属性（这会更改状态栏的位置，但不会更改视图）
*   在您的 UIViewController viewDidLoad: 方法或 applicationDidFinishLaunching: 方法上手动围绕其中心旋转视图，或实现自动旋转（“自动调整行为”，第 124 页）

查找“以横向模式启动”，第 102 页。

* * *

## 回答 #8

> 赞同：4
> 
> 时间：2011-03-06T07:56:44.363

看到这个答案：[横向模式仅适用于 iPhone 或 iPad](https://stackoverflow.com/questions/2647786/landscape-mode-only-for-iphone-or-ipad/2647807#2647807)

1.  向 plist 添加方向
2.  shouldAutorotateToInterfaceOrientation = YES 在所有文件中

虽然如果你使用混合模式，你可能会更好

```
[[UIDevice currentDevice] setOrientation:UIInterfaceOrientationLandscapeRight]; 
```

# com - 在 VB6 IDE 中工作时卸载 COM 控件

> ID：419
> 
> 赞同：37
> 
> 时间：2008-08-02T11:52:01.543
> 
> 标签：com, vb6

我日常工作的一部分是维护和扩展遗留的 VB6 应用程序。通用引擎是用 C/C++ 编写的，VB6 使用这些函数来提高性能。

对于异步编程，C 接口是不够的，我们依靠 COM 控件向 VB6 触发事件。

我的问题是，当我在 VB6 中注册控件时，VB 会将此控件加载到内存中，并且在我退出 VB6 IDE 之前不会将其卸载。由于控件一直加载，我无法在 VC6 中重新编译它，因为 DLL 文件被锁定。

我发现的一个解决方案不是在 VB 中启用控件，而是使用`CreateObject()`我的控件的全名。那么问题是我必须将我的控件声明为一个对象，因为 VB6 对我正在使用的接口一无所知，而且我无法访问 IntelliSense，这很痛苦。

知道如何告诉 VB6 在退出应用程序后或直接在 IDE 中卸载控件吗？

* * *

## 回答 #1

> 赞同：27
> 
> 时间：2008-08-20T03:58:09.347

我很确定没有强制 VB6 卸载控件的好方法。

这就是我所做的......而不是并行运行 Visual C 和 Visual Basic，而是*在*VC 下运行 VB6：

1.  加载VC
2.  打开包含您的 COM 对象的项目
3.  编辑、更改等。
4.  在 VC 中，使用适当的命令行参数将输出可执行文件设置为 VB6.EXE 以加载 VB6 工作区
5.  现在只需按 F5 即可启动 VB6 IDE 并加载您的 VB6 项目
6.  当您想再次更改 COM 代码时，退出 VB6.EXE，进行更改，然后再次按 F5。只要您保存工作区，VB6 就会记住您打开了哪些窗口以及所有项目设置。

这种方法的优点：

*   您可以在 COM 对象中设置断点并使用完整的源调试器对其进行调试
*   您可以愉快地同时在 C 和 VB 中调试
*   每当 VB6 运行时，它始终具有最新版本的 COM DLL

# internet-explorer - 以编程方式启动 IE Mobile 收藏夹屏幕

> ID：427
> 
> 赞同：29
> 
> 时间：2008-08-02T12:12:02.363
> 
> 标签：internet-explorer, windows-mobile, pocketpc

有没有办法通过指定任何命令行参数直接启动 IE Mobile 的“收藏夹”屏幕？

* * *

## 回答 #1

> 赞同：5
> 
> 时间：2008-08-04T17:28:46.590

以 HTML 收藏夹文件作为参数运行 IE 怎么样？

> IExplore 文件：//\windows\fav.htm

* * *

## 回答 #2

> 赞同：3
> 
> 时间：2008-08-26T15:21:09.920

我认为如果没有代码，这将非常困难。

想到两个选择：

*   找出 IE 发送哪些 Windows 消息以打开收藏夹屏幕并在您的应用程序中重播这些消息。您首先需要查看 IE 是否正在运行以及是否将其置于前台。如果没有，则开始该过程。也许您可以使用 Windows CE Remote Spy 找到正确的窗口和有关收藏夹按钮的信息？
*   其他选项是针对 IE 存储其收藏夹信息的位置工作。您必须编写自己的 UI 来解析收藏夹等。

* * *

## 回答 #3

> 赞同：3
> 
> 时间：2011-02-16T17:30:08.733

使用此行创建一个链接文件：`26#"\Windows\iexplore.exe" -f`

# ruby-on-rails - 在 Rails 应用程序中实现“记住我”

> ID：438
> 
> 赞同：57
> 
> 时间：2008-08-02T12:56:58.590
> 
> 标签：ruby-on-rails, ruby, http

我的 Rails 应用程序有一个带有“记住我”复选框的登录框。选中该框的用户即使在关闭浏览器后仍应保持登录状态。我通过将用户的 id 存储在用户的会话中来跟踪用户是否登录。

但是会话在 Rails 中作为会话 cookie 实现，它不是持久的。我可以*让*他们坚持：

```
class ApplicationController < ActionController::Base
  before_filter :update_session_expiration_date

  private

  def update_session_expiration_date
    options = ActionController::Base.session_options
    unless options[:session_expires]
      options[:session_expires] = 1.year.from_now
    end
  end
end 
```

但这似乎是一种 hack，这对于这种常见的功能来说是令人惊讶的。有没有更好的办法？

**编辑**

Gareth 的回答非常好，但我仍然希望熟悉 Rails 2 的人回答（因为它是独一无二的`CookieSessionStore`）。

* * *

## 回答 #1

> 赞同：29
> 
> 时间：2008-08-02T16:10:42.817

您几乎可以肯定不应该将会话 cookie 延长为长期存在。

尽管本文没有专门讨论 Rails [，但本文](http://fishbowl.pastiche.org/2004/01/19/persistent_login_cookie_best_practice)还是详细解释了“记住我”的最佳实践。

总之，虽然你应该：

*   向用户表添加额外的列以接受较大的随机值
*   在客户端上设置一个长寿命的 cookie，它结合了用户 ID 和随机值
*   当新会话开始时，检查 id/value cookie 是否存在，如果匹配，则对新用户进行身份验证。

作者还建议在每次登录时使随机值无效并重置 cookie。就我个人而言，我不喜欢这样，因为您无法在两台计算机上保持登录状态。我倾向于确保我的密码更改功能也重置随机值，从而锁定其他机器上的会话。

最后一点，他给出的关于使某些功能（密码更改/电子邮件更改等）对自动认证会话不可用的建议非常值得遵循，但在现实世界中很少见。

* * *

## 回答 #2

> 赞同：13
> 
> 时间：2008-09-16T21:37:36.440

我花了一段时间思考这个问题并得出了一些结论。默认情况下，Rails 会话 cookie 是防篡改的，因此您真的不必担心 cookie 在客户端被修改。

这是我所做的：

*   会话 cookie 设置为长寿命（6 个月左右）
*   会话存储内部
    *   设置为登录 + 24 小时的“过期”日期
    *   用户身份
    *   Authenticated = true 所以我可以允许匿名用户会话（由于 cookie 防篡改保护不危险）
*   我在应用程序控制器中添加了一个 before_filter 来检查会话的“过期”部分。

当用户选中“记住我”框时，我只是将 session[:expireson] 日期设置为登录 + 2 周。没有人可以窃取 cookie 并永远保持登录状态或伪装成另一个用户，因为 rails session cookie 是防篡改的。

* * *

## 回答 #3

> 赞同：11
> 
> 时间：2008-09-17T14:17:34.023

我建议您查看具有此实现的 RESTful_Authentication 插件，或者只是切换您的实现以使用 RESTful Authentication_plugin。在 Railscasts 上有一个关于如何使用这个插件的很好的解释：

[railscasts #67 restful_authentication](http://railscasts.com/episodes/67-restful-authentication)

这是插件本身的链接

[restful_authentication](http://rubygems.org/gems/restful_authentication)

* * *

## 回答 #4

> 赞同：6
> 
> 时间：2008-08-06T21:30:25.180

restful_authentication 插件有一个很好的实现：

[http://agilewebdevelopment.com/plugins/restful_authentication](http://agilewebdevelopment.com/plugins/restful_authentication)

* * *

## 回答 #5

> 赞同：5
> 
> 时间：2008-09-01T21:46:46.840

请注意，您不想保留他们的会话，只保留他们的身份。当他们返回您的站点时，您将为他们创建一个新会话。通常，您只需为用户分配一个 GUID，将其写入他们的 cookie，然后在他们回来时使用它来查找他们。不要使用他们的登录名或用户 ID 作为令牌，因为它很容易被猜到并允许狡猾的访问者劫持其他用户的帐户。

* * *

## 回答 #6

> 赞同：4
> 
> 时间：2008-09-20T08:58:47.127

这对我来说就像一个魅力：

[http://squarewheel.wordpress.com/2007/11/03/session-cookie-expiration-time-in-rails/](http://squarewheel.wordpress.com/2007/11/03/session-cookie-expiration-time-in-rails/)

现在我的 CookieStore 会话在两周后到期，因此用户必须再次提交他们的登录凭据才能持续登录两周。

基本上，它很简单：

1.  在 vendor/plugins 目录中包含一个文件
2.  仅使用一行在应用程序控制器中设置会话到期值

* * *

## 回答 #7

> 赞同：4
> 
> 时间：2011-01-16T04:26:53.270

我会选择 Devise 来为 Rails 提供出色的身份验证解决方案。

# python - 如何从 Mac 上的显示名称中找到字体的完整路径？

> ID：469
> 
> 赞同：47
> 
> 时间：2008-08-02T15:11:16.430
> 
> 标签：python, macos, fonts, photoshop

我正在使用 Photoshop 的 javascript API 来查找给定 PSD 中的字体。

给定 API 返回的字体名称，我想在光盘上找到字体名称对应的实际物理字体文件。

这一切都发生在 OSX 上运行的 python 程序中，所以我想我正在寻找以下之一：

*   一些 Photoshop javascript
*   一个 Python 函数
*   我可以从 python 调用的 OSX API

* * *

## 回答 #1

> 赞同：21
> 
> 时间：2008-08-06T03:01:23.890

不幸的是，唯一未被弃用的 API 位于 ApplicationServices 框架中，该框架没有网桥支持文件，因此在网桥中不可用。如果您想使用 ctypes，您可以在查找 ATSFontRef 后使用 ATSFontGetFileReference。

至少从 10.5 开始，Cocoa 没有任何原生支持来获取字体的位置。

* * *

## 回答 #2

> 赞同：7
> 
> 时间：2008-08-02T16:56:53.893

打开一个终端（应用程序->实用程序->终端）并输入：

```
locate InsertFontHere 
```

这将吐出具有您想要的名称的每个文件。

警告：可能有很多事情要经历。

* * *

## 回答 #3

> 赞同：6
> 
> 时间：2008-08-02T17:42:28.607

我还没有找到任何可以直接做到这一点的东西。我认为您必须遍历系统上的各种字体文件夹：`/System/Library/Fonts`, `/Library/Fonts`，并且可能还有一个用户级目录`~/Library/Fonts`。

* * *

## 回答 #4

> 赞同：5
> 
> 时间：2008-10-12T07:02:40.173

Cocoa 中必须有一个方法来获取字体列表，然后您必须使用 PyObjC 绑定来调用它。

根据您需要它们的用途，您可能只使用以下内容..

```
import os
def get_font_list():
    fonts = []
    for font_path in ["/Library/Fonts", os.path.expanduser("~/Library/Fonts")]:
        if os.path.isdir(font_path):
            fonts.extend(
                [os.path.join(font_path, cur_font) 
                 for cur_font in os.listdir(font_path)
                ]
            )
    return fonts 
```

# .net - 网络服务的本土消费

> ID：470
> 
> 赞同：25
> 
> 时间：2008-08-02T15:11:47.523
> 
> 标签：.net, web-services

我一直在为一个`.net`应用程序编写一些 Web 服务，现在我已经准备好使用它们了。我见过很多例子，其中有使用服务的本地代码，而不是使用 Visual Studio 在添加 Web 引用时创建的自动生成的方法。

这有什么好处吗？

* * *

## 回答 #1

> 赞同：11
> 
> 时间：2008-08-02T15:33:13.390

不，你正在做的很好。不要让那些人迷惑你。

如果您使用 .net 编写了 Web 服务，那么由 .net 生成的参考代理将非常合适。您描述的情况（您既是生产者又是消费者）是理想的情况。

如果您需要连接到在编译时*未知*的 Web 服务，那么您将需要一种更动态的方法，您可以在其中推断 Web 服务的“形状”。

但是从使用自动生成的代理类开始，在遇到限制之前不要担心。当你这样做时 - 回到堆栈溢出;-)

# c# - WinForms ComboBox 数据绑定陷阱

> ID：482
> 
> 赞同：56
> 
> 时间：2008-08-02T16:09:56.780
> 
> 标签：c#, winforms, data-binding

假设您正在执行以下操作

```
List<string> myitems = new List<string>
{
    "Item 1",
    "Item 2",
    "Item 3"
};

ComboBox box = new ComboBox();
box.DataSource = myitems;

ComboBox box2 = new ComboBox();
box2.DataSource = myitems 
```

所以现在我们有 2 个组合框绑定到该数组，一切正常。但是，当您更改一个组合框的值时，它会将两个组合框更改为您刚刚选择的那个。

现在，我知道数组总是通过引用传递（当我学习 C:D 时才知道），但是为什么组合框会一起改变呢？我根本不相信组合框控件正在修改集合。

作为一种解决方法，这不会实现预期/期望的功能

```
ComboBox box = new ComboBox();
box.DataSource = myitems.ToArray(); 
```

* * *

## 回答 #1

> 赞同：39
> 
> 时间：2008-08-02T17:18:12.680

这与如何在 dotnet 框架中设置数据绑定有关，尤其是`BindingContext`. 在高层次上，这意味着如果您没有另行指定，则每个表单和表单的所有控件都共享相同的`BindingContext`. 当您设置`DataSource`属性时，`ComboBox`将使用`BindingContext`来获取`ConcurrenyMangager`包装列表的 a。`ConcurrenyManager`跟踪列表中的当前选定位置等内容。

当您设置`DataSource`第二个`ComboBox`时，它将使用相同`BindingContext`的（表单），这将产生对与`ConcurrencyManager`上面用于设置数据绑定的相同的引用。

要获得更详细的解释，请参阅[BindingContext](https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.bindingcontext)。

* * *

## 回答 #2

> 赞同：22
> 
> 时间：2008-08-21T14:48:34.283

更好的解决方法（取决于数据源的大小）是声明两个`BindingSource`对象（自 2.00 起新增）将集合绑定到这些对象，然后将它们绑定到组合框。

我附上一个完整的例子。

```
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Windows.Forms;

namespace WindowsFormsApplication2
{
    public partial class Form1 : Form
    {
        private BindingSource source1 = new BindingSource();
        private BindingSource source2 = new BindingSource();

        public Form1()
        {
            InitializeComponent();
            Load += new EventHandler(Form1Load);
        }

        void Form1Load(object sender, EventArgs e)
        {
            List<string> myitems = new List<string>
            {
                "Item 1",
                "Item 2",
                "Item 3"
            };

            ComboBox box = new ComboBox();
            box.Bounds = new Rectangle(10, 10, 100, 50);
            source1.DataSource = myitems;
            box.DataSource = source1;

            ComboBox box2 = new ComboBox();
            box2.Bounds = new Rectangle(10, 80, 100, 50);
            source2.DataSource = myitems;
            box2.DataSource = source2;

            Controls.Add(box);
            Controls.Add(box2);
        }
    }
} 
```

如果您想更加困惑，请尝试始终在构造函数中声明绑定。这可能会导致一些*非常*奇怪的错误，因此我总是在 Load 事件中绑定。

# python - 在 Windows 上获取 PDF 的预览 JPEG？

> ID：502
> 
> 赞同：58
> 
> 时间：2008-08-02T17:01:58.500
> 
> 标签：python, windows, image, pdf

我有一个跨平台 (Python) 应用程序，它需要生成 PDF 第一页的 JPEG 预览。

在 Mac 上，我正在生成[sips](http://web.archive.org/web/20090309234215/http://developer.apple.com:80/documentation/Darwin/Reference/ManPages/man1/sips.1.html)。我可以在 Windows 上做同样简单的事情吗？

* * *

## 回答 #1

> 赞同：43
> 
> 时间：2008-08-10T08:08:33.543

ImageMagick 无论如何都将 PDF->bitmap 转换委托给 GhostScript，所以这里有一个您可以使用的命令（它基于`ps:alpha`ImageMagick 中委托列出的实际命令，只是调整为使用 JPEG 作为输出）：

```
gs -q -dQUIET -dPARANOIDSAFER -dBATCH -dNOPAUSE -dNOPROMPT \
-dMaxBitmap=500000000 -dLastPage=1 -dAlignToPixels=0 -dGridFitTT=0 \
-sDEVICE=jpeg -dTextAlphaBits=4 -dGraphicsAlphaBits=4 -r72x72 \
-sOutputFile=$OUTPUT -f$INPUT 
```

其中`$OUTPUT`和`$INPUT`是输出和输入文件名。调整`72x72`到您需要的任何分辨率。（显然，如果您将整个命令写成一行，请去掉反斜杠。）

这有两个好处：

1.  您不再需要安装 ImageMagick。并不是说我反对 ImageMagick（我非常喜欢它），但我相信简单的解决方案。
2.  ImageMagick 进行两步转换。首先是 PDF->PPM，然后是 PPM->JPEG。这样，转换是一步完成的。

其他需要考虑的事项：对于我测试过的文件，PNG 的压缩效果优于 JPEG。如果要使用 PNG，`-sDEVICE=jpeg`请将`-sDEVICE=png16m`.

* * *

## 回答 #2

> 赞同：16
> 
> 时间：2008-08-02T18:49:07.740

您可以为此使用 ImageMagick 的转换实用程序，请参阅[http://studio.imagemagick.org/pipermail/magick-users/2002-May/002636.html](https://web.archive.org/web/20120413111338/http://studio.imagemagick.org/pipermail/magick-users/2002-May/002636.html)中的一些示例 ：

> ```
> Convert taxes.pdf taxes.jpg 
> ```
> 
> 将两页 PDF 文件转换为 [2] jpeg 文件：tax.jpg.0, tax.jpg.1
> 
> 我还可以将这些 JPEGS 转换为缩略图，如下所示：
> 
> ```
> convert -size 120x120 taxes.jpg.0 -geometry 120x120 +profile '*' thumbnail.jpg 
> ```
> 
> 我什至可以将 PDF 直接转换为 jpeg 缩略图，如下所示：
> 
> ```
> convert -size 120x120 taxes.pdf -geometry 120x120 +profile '*' thumbnail.jpg 
> ```
> 
> 这将导致两个页面的 thumbnail.jpg.0 和 thumbnail.jpg.1。

* * *

## 回答 #3

> 赞同：5
> 
> 时间：2008-08-10T07:10:19.153

PC 是否可能安装了 Acrobat？我认为 Acrobat 安装了一个 shell 扩展，因此 PDF 文档第一页的预览出现在 Windows 资源管理器的缩略图视图中。您可以通过需要包装的 IExtractImage COM API 自己获取缩略图。[VBAccelerator 在 C# 中有一个示例](http://www.vbaccelerator.com/home/net/code/libraries/shell_projects/Thumbnail_Extraction/article.asp)，您可以将其移植到 Python。

# ruby-on-rails - 进行 HTTP 调用时，Ruby 中频繁的 SystemExit

> ID：514
> 
> 赞同：23
> 
> 时间：2008-08-02T17:26:39.793
> 
> 标签：ruby-on-rails, ruby, crash

我有一个 Ruby on Rails 网站，可以对外部 Web 服务进行 HTTP 调用。

大约每天一次，我收到一封 SystemExit（下面的堆栈跟踪）错误电子邮件，其中对服务的调用失败。如果我稍后在我的网站上尝试完全相同的查询，它就可以正常工作。自从该网站上线以来就一直在发生这种情况，我没有运气追踪到是什么原因造成的。

Ruby 是 1.8.6 版，rails 是 1.2.6 版。

其他人有这个问题吗？

这是错误和堆栈跟踪。

> 发生 SystemExit /usr/local/lib/ruby/gems/1.8/gems/rails-1.2.6/lib/fcgi_handler.rb:116:in exit' /usr/local/lib/ruby/gems/1.8/gems/ rails-1.2.6/lib/fcgi_handler.rb:116:in exit_now_handler' /usr/local/lib/ruby/gems/1.8/gems/activesupport-1.4.4/lib/active_support/inflector.rb:250:in to_proc ' /usr/local/lib/ruby/1.8/net/protocol.rb:133:in call' /usr/local/lib/ruby/1.8/net/protocol.rb:133:in sysread' /usr/local/ lib/ruby/1.8/net/protocol.rb:133:in rbuf_fill' /usr/local/lib/ruby/1.8/timeout.rb:56:in timeout' /usr/local/lib/ruby/1.8/timeout. rb:76:in timeout' /usr/local/lib/ruby/1.8/net/protocol.rb:132:in rbuf_fill' /usr/local/lib/ruby/1.8/net/protocol.rb:116:in readuntil ' /usr/local/lib/ruby/1.8/net/protocol.rb:126:in readline' /usr/local/lib/ruby/1.8/net/http.rb:2017:在 read_status_line'/usr/local/lib/ruby/1.8/net/http.rb:2006:in read_new'/usr/local/lib/ruby/1.8/net/http.rb:1047:in request'/usr/ local/lib/ruby/1.8/net/http.rb:945:in request_get' /usr/local/lib/ruby/1.8/net/http.rb:380:in get_response' /usr/local/lib/ruby/ 1.8/net/http.rb:543:in start' /usr/local/lib/ruby/1.8/net/http.rb:379:in get_response'

* * *

## 回答 #1

> 赞同：9
> 
> 时间：2008-08-02T17:50:34.987

众所周知，在 Ruby 中使用 fcgi 是非常错误的。

几乎每个人都因为这个原因搬到了[Mongrel](http://mongrel.rubyforge.org/)，我建议你也这样做。

* * *

## 回答 #2

> 赞同：8
> 
> 时间：2008-08-03T05:22:20.457

我使用 FCGI 已经有一段时间了，但我认为如果线程花费太长时间，FCGI 进程可能会抛出 SystemExit。这可能是 Web 服务没有响应，甚至是缓慢的 DNS 查询。一些谷歌结果显示 Python 和 FCGI 存在类似的错误，因此迁移到 mongrel 将是一个好主意。 [这篇文章](http://blog.codahale.com/2006/06/19/time-for-a-grown-up-server-rails-mongrel-apache-capistrano-and-you/)是我用来设置 mongrel 的参考，我仍然参考它。

* * *

## 回答 #3

> 赞同：5
> 
> 时间：2008-08-30T04:55:25.743

我过去常常在 Apache1/fastcgi 上得到这些。我认为这是由于在 Ruby 完成之前 fastcgi 挂断造成的。

切换到 mongrel 是很好的第一步，但还有更多工作要做。从活动页面上的 Web 服务中剔除是一个坏主意，尤其是从 Rails 中。Rails 不是线程安全的。您可以支持的并发连接数等于集群中 mongrel（或乘客进程）的数量。

如果您有一个 mongrel 并且有人访问一个调用 Web 服务的页面需要 10 秒才能超时，那么在此期间对您网站的每个请求都将超时。大多数负载均衡器只是盲目地循环通过你的 mongrel，所以如果你有两个 mongrel，其他所有请求都会超时。

任何可能出乎意料的慢的事情都需要在作业队列中发生。第一次点击 /slow/action 会将作业添加到队列中，然后 /slow/action 通过页面刷新或通过 ajax 查询不断刷新，直到作业完成，然后您从作业队列中获取结果。现在有一些 Rails 的作业队列，但最古老且可能使用最广泛的一个是[BackgroundRB](http://backgroundrb.rubyforge.org/)。

根据您的应用程序的性质，另一种选择是每 N 分钟通过 cron 剔除服务，在本地缓存数据，并从缓存中读取您的实时页面。

* * *

## 回答 #4

> 赞同：1
> 
> 时间：2008-08-11T16:36:06.327

我也会看看[Passenger](http://modrails.com/)。它比传统的 Apache/nginx + Mongrel 解决方案容易上手。

# python - Python 代码库的持续集成系统

> ID：535
> 
> 赞同：68
> 
> 时间：2008-08-02T18:43:54.787
> 
> 标签：python, continuous-integration, extreme-programming

我开始使用**Python**代码库开展一个爱好项目，我想建立某种形式的持续集成（即每次签到时运行一组测试用例，并向负责人发送 nag 电子邮件测试失败时的人）类似于**CruiseControl**或**TeamCity**。

我意识到我可以在大多数**VCSes**中使用钩子来做到这一点，但这要求测试在与版本控制服务器相同的机器上运行，这并不像我想要的那样优雅。有人对适合**Python**代码库的小型、用户友好、开源持续集成系统有任何建议吗？

* * *

## 回答 #1

> 赞同：32
> 
> 时间：2008-08-02T19:06:40.667

我们在工作中运行[Buildbot - Trac](http://buildbot.net/trac)。我没有过多地使用它，因为我的代码库还不是发布周期的一部分。但是我们在不同的环境（OSX/Linux/Win）上运行测试，它会发送电子邮件——而且它是用 Python 编写的。

* * *

## 回答 #2

> 赞同：29
> 
> 时间：2008-08-02T18:56:56.460

一种可能性是哈德逊。它是用 Java 编写的，但与 Python 项目集成：

> [哈德森拥抱 Python](http://redsolo.blogspot.com/2007/11/hudson-embraces-python.html)

然而，我自己从未尝试过。

（ 2011 年 9 月**更新**：在商标争议之后，Hudson 已更名为[Jenkins](http://jenkins-ci.org/)。）

* * *

## 回答 #3

> 赞同：19
> 
> 时间：2008-08-03T12:09:18.357

其次是 Buildbot - Trac 集成。[您可以在Buildbot 网站](http://buildbot.net/trac/wiki/BuildbotAndTrac)上找到有关集成的更多信息。在我之前的工作中，我们编写并使用了他们提到的插件 (tracbb)。该插件所做的是重写所有 Buildbot url，以便您可以在 Trac 中使用 Buildbot。（[http://example.com/tracbb](http://example.com/tracbb)）。

Buildbot 的真正好处是配置是用 Python 编写的。您可以将自己的 Python 代码直接集成到配置中。编写自己的 BuildSteps 来执行特定任务也很容易。

我们使用 BuildSteps 从 SVN 获取源、拉取依赖项、将测试结果发布到 WebDAV 等等。

我编写了一个 X10 接口，以便我们可以发送带有构建结果的信号。当构建失败时，我们打开了红色熔岩灯。构建成功后，绿色的熔岩灯亮了。美好的时光 ：-）

* * *

## 回答 #4

> 赞同：18
> 
> 时间：2008-09-15T00:11:21.250

我们使用 Buildbot 和 Hudson 进行 Jython 开发。两者都很有用，但有不同的优点和缺点。

Buildbot 的配置是纯 Python 的，一旦掌握了它就非常简单（查看 epydoc 生成的 API 文档以获取最新信息）。Buildbot 可以更轻松地定义非测试任务和分发测试人员。但是，它确实没有单独测试的概念，只有文本、HTML 和摘要输出，所以如果你想拥有多级可浏览的测试输出等，你必须自己构建它，或者只使用 Hudson。

Hudson 非常支持从整体结果向下钻取到测试套件和单个测试；它也非常适合比较构建之间的测试输出，但是分布式（主/从）的东西相对更复杂，因为您也需要在从属上的 Java 环境；此外，Hudson 对主从之间的不稳定网络链接的容忍度较低。

因此，为了获得这两种工具的优势，我们运行一个 Hudson 实例，它可以捕获常见的测试失败，然后我们使用 Buildbot 进行多平台回归。

以下是我们的实例：

*   [杰通哈德森](http://bob.underboss.org:8080/job/jython/lastBuild/testReport/)
*   [Jython 构建机器人](http://www.acm.uiuc.edu/jython-buildbot/waterfall)

* * *

## 回答 #5

> 赞同：7
> 
> 时间：2008-09-16T16:51:46.063

我们正在使用与 trac 集成的[Bitten 。](http://bitten.edgewall.org/)它是基于python的。

* * *

## 回答 #6

> 赞同：6
> 
> 时间：2008-09-22T21:18:15.147

TeamCity 有一些 Python[集成](http://www.jetbrains.net/confluence/display/TW/Python+Unit+Test+Reporting)。

但是 TeamCity 是：

*   不是开源的
*   不小，而是功能丰富
*   对中小型团队免费。

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2012-02-02T21:42:23.507

对于较小的代码库，我对[Travis-CI](http://travis-ci.org/)有很好的经验。主要优点是：

*   设置在不到一半的配置文件屏幕中完成
*   您可以自己安装或只使用免费托管版本
*   github存储库的半自动设置
*   在网站上不需要帐户；通过 github 登录

一些限制：

*   不支持 Python 作为第一类语言（截至撰写本文时；但您可以使用 pip 和 apt-get 安装 python 依赖项；请参阅[本教程](http://www.travisswicegood.com/2011/11/11/travis-and-python/)）

*   代码必须托管在github上（至少在使用正式版时）

# forms - 基于表单的网站身份验证权威指南

> ID：549
> 
> 赞同：5522
> 
> 时间：2008-08-02T19:51:50.250
> 
> 标签：forms, http, security, authentication, language-agnostic

> #### 版主备注：
> 
> 这个问题不适合我们的问答格式以及当前适用于 Stack Overflow的[话题性规则。](/help/on-topic)对于内容仍然有价值的此类问题，我们通常使用“历史锁定”。但是，此问题的答案得到积极维护，历史锁定不允许编辑答案。因此，已应用“wiki 答案”锁定以允许编辑答案。您应该假设存在通常由历史锁定处理的话题性问题（即这个问题不是 Stack Overflow 的话题性问题的一个很好的例子）。

## 网站基于表单的身份验证

我们认为 Stack Overflow 不应该只是针对非常具体的技术问题的资源，还应该提供有关如何解决常见问题变体的一般指南。“基于表单的网站身份验证”应该是此类实验的一个很好的主题。

### 它应包括以下主题：

*   如何登录
*   如何退出
*   如何保持登录状态
*   管理 cookie（包括推荐设置）
*   SSL/HTTPS 加密
*   如何存储密码
*   使用秘密问题
*   忘记用户名/密码功能
*   使用[nonce](https://en.wikipedia.org/wiki/Cryptographic_nonce)防止[跨站点请求伪造 (CSRF)](https://en.wikipedia.org/wiki/Cross-site_request_forgery)
*   [开放ID](http://openid.net/)
*   “记住我”复选框
*   浏览器自动完成用户名和密码
*   秘密 URL（受摘要保护的公共[URL ）](https://en.wikipedia.org/wiki/Uniform_Resource_Locator)
*   检查密码强度
*   电子邮件验证
*   *以及更多关于* [基于表单的身份验证](http://en.wikipedia.org/wiki/Form-based_authentication)...

### 它不应包括以下内容：

*   角色和授权
*   HTTP 基本认证

### 请通过以下方式帮助我们：

1.  建议子主题
2.  提交关于这个主题的好文章
3.  编辑官方答案

* * *

## 回答 #1

> 赞同：3903
> 
> 时间：2009-01-25T11:27:46.093

## 第一部分：如何登录

我们假设您已经知道如何构建一个登录+密码 HTML 表单，该表单将值 POST 到服务器端的脚本以进行身份​​验证。以下部分将讨论可靠实用的身份验证模式，以及如何避免最常见的安全陷阱。

**使用 HTTPS 还是不使用 HTTPS？**

除非连接已经是安全的（即，使用 SSL/TLS 通过 HTTPS 进行隧道连接），否则您的登录表单值将以明文形式发送，这样任何人在浏览器和 Web 服务器之间的线路上窃听都可以在登录时读取它们通过通过。这种类型的窃听通常由政府进行，但一般来说，我们不会处理“拥有”的电线，而是说：只需使用 HTTPS。

本质上，在登录期间防止窃听/数据包嗅探的唯一**实用方法是使用 HTTPS 或其他基于证书的加密方案（例如**[TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security)）或经过验证和测试的质询-响应方案（例如[Diffie-Hellman](https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange)基于 SRP）。窃听攻击者*可以轻松绕过任何其他方法。*

当然，如果您愿意有点不切实际，您也可以采用某种形式的双因素身份验证方案（例如 Google Authenticator 应用程序、物理“冷战式”密码本或 RSA 密钥生成器加密狗）。如果应用得当，这甚至可以在不安全的连接下工作，但很难想象开发人员愿意实现双因素身份验证而不是 SSL。

**（不要）滚动你自己的 JavaScript 加密/散列**

考虑到在您的网站上设置 SSL 证书的成本和技术难度（尽管现在[可以避免](https://letsencrypt.org/)），一些开发人员很想推出自己的浏览器内散列或加密方案，以避免通过不安全的线路传递明文登录。

虽然这是一个崇高的想法，但它本质上是无用的（并且可能是一个[安全漏洞](https://stackoverflow.com/questions/1380168/does-it-make-security-sense-to-hash-password-on-client-end)），除非它与上述之一相结合 - 也就是说，要么使用强加密来保护线路，要么使用久经考验的挑战 - 响应机制（如果你不知道那是什么，只知道它是数字安全中最难证明、最难设计和最难实现的概念之一）。

虽然散列密码确实*可以*有效防止**密码泄露**，但它很容易受到重放攻击、中间人攻击/劫持（如果攻击者可以在不安全的 HTML 页面到达您的浏览器，他们可以简单地注释掉 JavaScript 中的散列）或暴力攻击（因为您将用户名、盐和散列密码都交给了攻击者）。

**反人类的验证码**

[CAPTCHA](https://en.wikipedia.org/wiki/CAPTCHA)旨在阻止一种特定类型的攻击：无需人工操作的自动字典/蛮力试错法。毫无疑问，这是一个真正的威胁，但是，有一些方法可以无缝地处理它，不需要验证码，专门设计的服务器端登录限制方案——我们稍后会讨论这些。

知道 CAPTCHA 实现的创建方式不同；它们通常不是人类可以解决的，它们中的大多数实际上对机器人无效，它们都对廉价的第三世界劳动力无效（根据[OWASP](https://en.wikipedia.org/wiki/OWASP)，目前的血汗工厂费率为每 500 次测试 12 美元），并且一些实现可能是在某些国家/地区在技术上是非法的（请参阅[OWASP 身份验证备忘单](https://www.owasp.org/index.php/Authentication_Cheat_Sheet)）。如果您必须使用 CAPTCHA，请使用 Google 的[reCAPTCHA](https://en.wikipedia.org/wiki/ReCAPTCHA)，因为根据定义，它是 OCR 难的（因为它使用了已经 OCR 错误分类的图书扫描）并且非常努力地使用户友好。

就我个人而言，我倾向于发现 CAPTCHAS 很烦人，并且仅在用户多次登录失败并且限制延迟被最大化时才使用它们作为最后的手段。这种情况很少会发生，以至于无法接受，它会加强整个系统。

**存储密码/验证登录**

在我们近年来看到的所有高度公开的黑客攻击和用户数据泄漏之后，这可能最终成为常识，但必须说：不要在数据库中以明文形式存储密码。用户数据库通常会通过 SQL 注入被黑客入侵、泄露或收集，如果您存储的是原始的明文密码，那么为了您的登录安全，这就是即时游戏结束。

因此，如果您无法存储密码，如何检查从登录表单发布的登录名+密码组合是否正确？答案是使用[密钥派生函数](https://en.wikipedia.org/wiki/Key_derivation_function)进行散列。每当创建新用户或更改密码时，您都会获取密码并通过 KDF 运行它，例如 Argon2、bcrypt、scrypt 或 PBKDF2，将明文密码（“correcthorsebatterystaple”）变成一个长的、看起来随机的字符串，存储在数据库中要安全得多。要验证登录，您对输入的密码运行相同的哈希函数，这次传入盐并将生成的哈希字符串与存储在数据库中的值进行比较。Argon2、bcrypt 和 scrypt 已经用哈希值存储了盐。查看 sec.stackexchange 上的这篇[文章](https://security.stackexchange.com/a/31846/8340)以获取更多详细信息。

使用盐的原因是散列本身是不够的——你需要添加一个所谓的“盐”来保护散列不受[彩虹表](https://en.wikipedia.org/wiki/Rainbow_table)的影响。盐可以有效地防止两个完全匹配的密码被存储为相同的哈希值，如果攻击者正在执行密码猜测攻击，可以防止一次扫描整个数据库。

密码散列不应该用于密码存储，因为用户选择的密码不够强大（即通常不包含足够的熵），并且可以通过访问散列的攻击者在相对较短的时间内完成密码猜测攻击。这就是使用 KDF 的原因 - 这些有效地[“拉伸密钥”](https://en.wikipedia.org/wiki/Key_stretching)，这意味着攻击者每次猜测密码都会导致哈希算法重复多次，例如 10,000 次，这导致攻击者猜测密码的速度要慢 10,000 倍。

**会话数据 - “您以 Spiderman69 身份登录”**

一旦服务器根据您的用户数据库验证了登录名和密码并找到匹配项，系统需要一种方法来记住浏览器已经过身份验证。这个事实应该只存储在服务器端的会话数据中。

> 如果您不熟悉会话数据，以下是它的工作原理：一个随机生成的字符串存储在即将到期的 cookie 中，并用于引用存储在服务器上的数据集合 - 会话数据。如果您使用的是 MVC 框架，那么这无疑已经处理好了。

如果可能，请确保会话 cookie 在发送到浏览器时设置了安全和仅 HTTP 标志。HttpOnly 标志对通过 XSS 攻击读取的 cookie 提供了一些保护。安全标志确保 cookie 仅通过 HTTPS 发送回来，因此可以防止网络嗅探攻击。cookie 的值不应是可预测的。在出现引用不存在会话的 cookie 时，应立即替换其值以防止[会话固定](https://owasp.org/www-community/attacks/Session_fixation)。

会话状态也可以在客户端维护。这是通过使用 JWT（JSON Web 令牌）等技术实现的。

## 第二部分：如何保持登录状态——臭名昭著的“记住我”复选框

持久登录 Cookie（“记住我”功能）是一个危险区域；一方面，当用户了解如何处理它们时，它们完全与传统登录一样安全；另一方面，对于粗心的用户来说，它们是一个巨大的安全风险，他们可能会在公共计算机上使用它们而忘记注销，并且可能不知道浏览器 cookie 是什么或如何删除它们。

就个人而言，我喜欢对我定期访问的网站进行持久登录，但我知道如何安全地处理它们。如果您确信您的用户知道相同的内容，您可以使用无愧于心的持久登录。如果不是 - 好吧，那么您可能会同意这样一种哲学，即粗心的用户登录凭据如果被黑客入侵，就会自找麻烦。我们也不会去用户家中撕下所有那些用他们在显示器边缘排列的密码的便签纸。

当然，有些系统承受不起*任何*帐户被黑的后果；对于此类系统，您无法证明拥有持久登录是合理的。

**如果您决定实施持久登录 cookie，您可以这样做：**

1.  首先，花点时间阅读[Paragon Initiative](https://paragonie.com/blog/2015/04/secure-authentication-php-with-long-term-persistence)关于该主题的文章。您需要正确掌握一堆元素，并且这篇文章很好地解释了每个元素。

2.  重申一下最常见的陷阱之一，**不要将持久登录 COOKIE（令牌）存储在您的数据库中，只存储它的哈希值！**登录令牌是密码等效的，因此如果攻击者掌握了您的数据库，他们可以使用令牌登录到任何帐户，就像它们是明文登录密码组合一样。因此，在存储持久登录令牌时，使用散列（根据[https://security.stackexchange.com/a/63438/5002](https://security.stackexchange.com/a/63438/5002)，弱散列可以很好地实现此目的）。

## 第三部分：使用秘密问题

**不要实施“秘密问题”**。“秘密问题”功能是一种安全反模式。从必读列表中的链接号 4 中阅读论文。你可以问莎拉佩林关于那个，在她的雅虎之后！电子邮件帐户在之前的总统竞选期间被黑了，因为她的安全问题的答案是……“瓦西拉高中”！

即使有用户指定的问题，大多数用户也很可能会选择：

*   一个“标准”的秘密问题，比如母亲的娘家姓或最喜欢的宠物

*   任何人都可以从他们的博客、LinkedIn 个人资料或类似内容中提取的一个简单的琐事

*   任何比猜密码更容易回答的问题。对于任何体面的密码，这是您可以想象的每一个问题

**总之，安全问题在几乎所有形式和变体中本质上都是不安全的，并且不应该出于任何原因在身份验证方案中使用。**

安全问题在野外存在的真正原因是，它们方便地节省了一些无法访问其电子邮件以获取重新激活代码的用户的支持电话的成本。这是以牺牲安全和莎拉佩林的声誉为代价的。值得？可能不是。

## 第 IV 部分：忘记密码功能

我已经提到了为什么你不应该**使用安全问题**来处理忘记/丢失的用户密码；不言而喻，您永远不应该通过电子邮件向用户发送他们的实际密码。在这个领域至少还有两个非常常见的陷阱需要避免：

1.  不要将忘记的密码*重置*为自动生成的强密码 - 众所周知，这样的密码很难记住，这意味着用户必须更改或写下来 - 例如，在显示器边缘的亮黄色便利贴上。与其设置新密码，不如让用户立即选择一个新密码——这就是他们想要做的事情。（如果用户普遍使用密码管理器来存储/管理通常不写下来就无法记住的密码，则可能是一个例外）。

2.  始终对数据库中丢失的密码代码/令牌进行哈希处理。***再次***，此代码是密码等效项的另一个示例，因此必须对其进行哈希处理，以防攻击者获得您的数据库。当请求丢失密码代码时，将明文代码发送到用户的电子邮件地址，然后对其进行哈希处理，将哈希值保存在您的数据库中 - 并*丢弃原始*. 就像密码或持久登录令牌一样。

最后一点：始终确保您输入“丢失的密码代码”的界面至少与您的登录表单本身一样安全，否则攻击者会简单地使用它来获取访问权限。确保生成很长的“丢失密码”（例如，16 个区分大小写的字母数字字符）是一个好的开始，但请考虑添加与登录表单本身相同的限制方案。

## 第五部分：检查密码强度

首先，您需要阅读这篇小文章进行现实检查：[500 个最常见的密码](http://www.whatsmypass.com/?p=415)

好的，所以也许该列表不是任何*地方**任何*系统上最常见密码的*规范*列表，但它很好地表明了当没有实施强制策略时人们将如何选择他们的密码。此外，当您将其与对最近被盗密码的公开分析进行比较时，该列表看起来非常接近家常便饭。

 **所以：没有最低密码强度要求，2% 的用户使用前 20 个最常见的密码之一。含义：如果攻击者仅获得 20 次尝试，那么您网站上 50 个帐户中就有 1 个是可破解的。

阻止这一点需要计算密码的熵，然后应用阈值。美国国家标准与技术研究院 (NIST)[特别出版物 800-63](https://en.wikipedia.org/wiki/Password_strength#NIST_Special_Publication_800-63)有一组非常好的建议。结合字典和键盘布局分析（例如，'qwertyuiop' 是一个错误的密码），可以[拒绝 99%](https://cubicspot.blogspot.com/2012/01/how-to-calculate-password-strength-part.html)的 18 位熵级别的所有错误选择的密码。简单地计算密码强度并向用户[显示视觉强度计](https://blogs.dropbox.com/tech/2012/04/zxcvbn-realistic-password-strength-estimation/)是好的，但还不够。除非强制执行，否则很多用户很可能会忽略它。

对于高熵密码的用户友好性，强烈推荐Randall Munroe 的[密码强度 xkcd 。](https://xkcd.com/936/)

利用 Troy Hunt 的[Have I Been Pwned API](https://haveibeenpwned.com/API/)来检查用户密码与公共数据泄露中泄露的密码。

## 第 VI 部分：更多 - 或：防止快速登录尝试

首先，看一下数字：[密码恢复速度 - 您的密码可以保存多长时间](https://www.lockdown.co.uk/?pg=combi&s=articles)

如果您没有时间浏览该链接中的表格，以下是它们的列表：

1.  *破解一个弱密码几乎不需要时间*，即使你是用算盘破解它

2.  **如果不区分大小写**，则*几乎不需要时间*来破解字母数字 9 字符的密码

***   如果长度**小于 8**个字符（台式电脑一次最多可以搜索整个键空间 7 个字符），破解复杂的符号、字母和数字、大小写密码*几乎不需要任何时间*数天甚至数小时）

    ***   **但是，*如果您被限制为每秒尝试一次，即使是 6 个字符的密码也将花费大量时间！******* 

 ****那么我们可以从这些数字中学到什么？好吧，很多，但我们可以专注于最重要的部分：防止大量快速连续登录尝试（即*暴力*攻击）确实并不难。但预防它*并不*像看起来那么容易。

一般来说，您有三种选择都可以有效抵抗暴力攻击*（和字典攻击，但由于您已经采用了强密码策略，因此它们不应该成为问题）*：

*   在 N 次尝试失败后显示**验证码**（非常烦人，而且通常无效——但我在这里重复自己）

*   **在 N 次尝试失败后**锁定帐户**并要求电子邮件验证（这是等待发生的[DoS攻击）](https://en.wikipedia.org/wiki/Denial-of-service_attack)**

***   最后，**登录限制**：也就是说，在 N 次尝试失败后设置尝试之间的时间延迟（是的，DoS 攻击仍然可能，但至少它们的可能性要小得多，而且实施起来要复杂得多）。** 

 ****最佳实践#1：**随着失败尝试次数的增加而增加的短时间延迟，例如：

*   1 次尝试失败 = 无延迟
*   2 次失败尝试 = 2 秒延迟
*   3 次失败尝试 = 4 秒延迟
*   4 次失败尝试 = 8 秒延迟
*   5 次失败尝试 = 16 秒延迟
*   等等

DoS 攻击这种方案是非常不切实际的，因为由此产生的锁定时间略大于先前锁定时间的总和。

> 澄清一下：延迟*不是*将响应返回给浏览器之前的延迟。它更像是一个超时或不应期，在此期间，对特定帐户或从特定 IP 地址的登录尝试根本不会被接受或评估。也就是说，正确的凭据不会在成功登录时返回，不正确的凭据不会触发延迟增加。

**最佳实践 #2：**中等长度的时间延迟，在 N 次尝试失败后生效，例如：

*   1-4 次失败尝试 = 无延迟
*   5 次失败尝试 = 15-30 分钟延迟

DoS 攻击这种方案是非常不切实际的，但肯定是可行的。此外，可能需要注意的是，如此长的延迟对于合法用户来说可能非常烦人。健忘的用户会不喜欢你。

**最佳实践#3：**结合这两种方法 - 在 N 次尝试失败后生效的固定、短时间延迟，例如：

*   1-4 次失败尝试 = 无延迟
*   5 次以上失败尝试 = 20 秒延迟

或者，具有固定上限的延迟增加，例如：

*   1 次尝试失败 = 5 秒延迟
*   2 次失败尝试 = 15 秒延迟
*   3 次以上失败尝试 = 45 秒延迟

这个最终方案取自 OWASP 最佳实践建议（必读列表中的链接 1），并且应该被视为最佳实践，即使它被承认在限制方面。

> *但是，根据经验，我会说：您的密码策略越强，您就越不会因延迟而困扰用户。如果您需要强（区分大小写的字母数字 + 所需的数字和符号）9+ 个字符的密码，您可以在激活限制之前为用户提供 2-4 次非延迟密码尝试。*

DoS 攻击这个最终的登录限制方案是***非常***不切实际的。最后一点，始终允许持久性 (cookie) 登录（和/或 CAPTCHA 验证的登录表单）通过，因此合法用户甚至不会*在攻击进行时*被延迟。这样，非常不切实际的 DoS 攻击就变成了*非常*不切实际的攻击。

此外，对管理员帐户进行更积极的限制是有意义的，因为这些是最有吸引力的入口点

## 第七部分：分布式蛮力攻击

顺便说一句，更高级的攻击者会尝试通过“传播他们的活动”来规避登录限制：

*   在僵尸网络上分发尝试以防止 IP 地址标记

*   他们不会选择一个用户并尝试 50.000 个最常见的密码（由于我们的限制，他们不能这样做），而是选择最常见的密码并尝试针对 50.000 个用户。这样，他们不仅可以绕过验证码和登录限制等最大尝试次数，而且成功的机会也会增加，因为最常见的 1 号密码比 49.995 号更有可能

*   将每个用户帐户的登录请求间隔 30 秒，以便在雷达下潜行

在这里，最佳实践是**记录系统范围内的失败登录次数**，并使用站点的错误登录频率的运行平均值作为上限，然后对所有用户施加上限。

太抽象了？让我改写一下：

假设您的网站在过去 3 个月内平均每天有 120 次错误登录。使用它（运行平均值），您的系统可能会将全局限制设置为 3 倍——即。24 小时内 360 次失败的尝试。然后，如果在一天内所有帐户的失败尝试总数超过了该数字（或者甚至更好，监控加速率并在计算的阈值上触发），它会激活系统范围的登录限制——这意味着所有用户的短暂延迟（仍然，cookie 登录和/或备份 CAPTCHA 登录除外）。

我还发布了一个问题，其中包含[更多详细信息以及关于如何避免棘手的陷阱](https://stackoverflow.com/questions/479233/what-is-the-best-distributed-brute-force-countermeasure)以抵御分布式暴力攻击的非常好的讨论

## 第 VIII 部分：双因素身份验证和身份验证提供程序

凭据可能会受到破坏，无论是通过漏洞利用、密码被写下和丢失、带有密钥的笔记本电脑被盗，还是用户登录到钓鱼网站。登录可以通过双重身份验证得到进一步保护，该身份验证使用带外因素，例如从电话、SMS 消息、应用程序或加密狗收到的一次性代码。一些提供商提供双因素身份验证服务。

身份验证可以完全委托给单点登录服务，由另一个提供者处理收集凭据。这会将问题推给受信任的第三方。Google 和 Twitter 都提供基于标准的 SSO 服务，而 Facebook 提供类似的专有解决方案。

## 关于 Web 身份验证的必读链接

1.  [OWASP 认证指南](https://www.owasp.org/index.php/Authentication_Cheat_Sheet)/ [OWASP 认证备忘单](https://www.owasp.org/index.php/Authentication_Cheat_Sheet)
2.  [Web 上客户端身份验证的注意事项（非常易读的 MIT 研究论文）](https://pdos.csail.mit.edu/papers/webauth:sec10.pdf)
3.  [维基百科：HTTP cookie](https://en.wikipedia.org/wiki/HTTP_cookie#Drawbacks_of_cookies)
4.  [后备认证的个人知识问题：Facebook时代的安全问题（非常可读的伯克利研究论文）](https://cups.cs.cmu.edu/soups/2008/proceedings/p13Rabkin.pdf)

* * *

## 回答 #2

> 赞同：430
> 
> 时间：2008-08-02T20:40:45.533

# 权威文章

### 发送凭据

100% 安全发送凭据的唯一实用方法是使用[SSL](http://en.wikipedia.org/wiki/SSL)。使用 JavaScript 对密码进行哈希处理是不安全的。客户端密码散列的常见缺陷：

*   如果客户端和服务器之间的连接未加密，那么您所做的一切都[容易受到中间人攻击](https://stackoverflow.com/questions/14907581/ssl-and-man-in-the-middle-misunderstanding)。攻击者可以替换传入的 javascript 以破坏散列或将所有凭据发送到他们的服务器，他们可以监听客户端响应并完美地模拟用户等等。具有受信任证书颁发机构的 SSL 旨在防止中间人攻击。
*   如果您不在服务器上执行额外的冗余工作，服务器收到的散列密码的[安全性会降低。](https://security.stackexchange.com/questions/45254/owasp-recommendation-on-client-side-password-hashing)

还有另一种称为**SRP**的安全方法，但它已获得专利（尽管它是[免费许可](http://srp.stanford.edu/license.txt)的），而且很少有好的实现可用。

### 存储密码

永远不要将密码作为明文存储在数据库中。即使您不关心自己网站的安全性，也不会。假设您的某些用户将重复使用其在线银行帐户的密码。因此，存储散列密码，并丢弃原始密码。并确保密码不会出现在访问日志或应用程序日志中。OWASP[推荐使用 Argon2](https://www.owasp.org/index.php/Password_Storage_Cheat_Sheet#Impose_infeasible_verification_on_attacker)作为新应用的首选。如果这不可用，则应使用 PBKDF2 或 scrypt。最后，如果以上都不可用，请使用 bcrypt。

哈希本身也是不安全的。例如，相同的密码意味着相同的哈希——这使得哈希查找表成为一次破解大量密码的有效方法。相反，存储**盐渍**哈希。盐是在散列之前附加到密码的字符串 - 每个用户使用不同的（随机）盐。salt 是一个公共值，因此您可以将它们与哈希一起存储在数据库中。有关更多信息，请参见[此处](http://www.codeproject.com/Articles/704865/Salted-Password-Hashing-Doing-it-Right)。

这意味着您不能向用户发送他们忘记的密码（因为您只有哈希）。除非您对用户进行了身份验证，否则请勿重置用户的密码（用户必须证明他们能够阅读发送到存储（并经过验证）的电子邮件地址的电子邮件。）

### 安全问题

安全问题是不安全的 - 避免使用它们。为什么？安全问题所做的任何事情，密码都会做得更好。阅读第 III 部分：在[@Jens Roland中](http://srp.stanford.edu/license.txt)***使用秘密问题***在此 wiki 中回答此处。

### 会话 cookie

用户登录后，服务器会向用户发送会话 cookie。服务器可以从 cookie 中检索用户名或 id，但没有其他人可以生成这样的 cookie（TODO 解释机制）。

[Cookie 可以被劫持](http://en.wikipedia.org/wiki/Session_hijacking)：它们仅与客户端机器的其余部分和其他通信一样安全。它们可以从磁盘读取，在网络流量中嗅探，通过跨站点脚本攻击解除，从中毒的 DNS 钓鱼，因此客户端将其 cookie 发送到错误的服务器。不要发送持久性 cookie。Cookie 应在客户端会话结束时过期（浏览器关闭或离开您的域）。

如果您想自动登录您的用户，您可以设置一个持久性 cookie，但它应该与完整会话 cookie 不同。您可以设置用户已自动登录的附加标志，并且需要真实登录以进行敏感操作。这在希望为您提供无缝、个性化购物体验但仍保护您的财务详细信息的购物网站中很受欢迎。例如，当您返回访问亚马逊时，他们会向您显示一个看起来您已登录的页面，但当您下订单（或更改您的送货地址、信用卡等）时，他们会要求您确认你的密码。

另一方面，银行和信用卡等金融网站只有敏感数据，不应允许自动登录或低安全模式。

### 外部资源清单

*   [Web 上客户端身份验证的注意事项 (PDF)](http://pdos.csail.mit.edu/papers/webauth:sec10.pdf)
    21 页的学术文章，其中包含许多很棒的技巧。
*   [Ask YC: Best Practices for User Authentication](http://news.ycombinator.com/item?id=205572)
    论坛关于该主题的讨论
*   [您可能错误地](http://www.codinghorror.com/blog/archives/000953.html)
    存储了密码 关于存储密码的介绍性文章
*   [讨论：编码恐怖：您可能错误地存储](http://news.ycombinator.com/item?id=55660)
    了密码 关于编码恐怖文章的论坛讨论。
*   永远不要将密码存储在数据库中！
    关于在数据库中存储密码的另一个警告。
*   [密码破解](http://en.wikipedia.org/wiki/Password_cracking)
    维基百科关于几种密码散列方案弱点的文章。
*   [彩虹表足够了：关于安全密码方案你需要知道的关于](http://www.securityfocus.com/blogs/262)
    彩虹表以及如何防御它们以及其他线程的讨论。包括广泛的讨论。

* * *

## 回答 #3

> 赞同：168
> 
> 时间：2011-08-08T15:32:34.210

首先，强烈警告这个答案不是最适合这个确切的问题。它绝对不应该是最佳答案！

我将继续提及 Mozilla 提出的[BrowserID](https://browserid.org/)（或者更准确地说，是[Verified Email Protocol](https://wiki.mozilla.org/Identity/Verified_Email_Protocol/Latest)），本着为未来更好的身份验证方法寻找升级路径的精神。

我会这样总结：

1.  Mozilla 是一家非营利组织，其[价值观](http://www.mozilla.org/about/manifesto.en.html)与为这个问题找到好的解决方案非常吻合。
2.  今天的现实是大多数网站都使用基于表单的身份验证
3.  基于表单的身份验证有一个很大的缺点，那就是增加了[网络钓鱼](http://en.wikipedia.org/wiki/Phishing)的风险。要求用户将敏感信息输入到由远程实体控制的区域，而不是由其用户代理（浏览器）控制的区域。
4.  由于浏览器是隐式信任的（用户代理的整个想法是代表用户行事），它们可以帮助改善这种情况。
5.  这里阻碍进展的主要力量是[部署僵局](http://www.w3.org/2011/identity-ws/papers/idbrowser2011_submission_10.pdf)。必须将解决方案分解为可以单独提供一些增量收益的步骤。
6.  用于表达内置于互联网基础设施中的身份的最简单的去中心化方法是域名。
7.  作为表达身份的第二层，每个域都管理自己的一组帐户。
8.  “帐户`@`域”形式简洁明了，并得到广泛的协议和 URI 方案的支持。当然，这样的标识符是最普遍认可的电子邮件地址。
9.  电子邮件提供商已经是事实上的主要在线身份提供商。如果您可以证明您控制了该帐户的关联电子邮件地址，则当前的密码重置流程通常可以让您控制该帐户。
10.  验证电子邮件协议旨在提供一种基于公钥加密的安全方法，用于简化向域 B 证明您在域 A 上拥有帐户的过程。
11.  对于不支持验证电子邮件协议的浏览器（目前全部），Mozilla 提供了一个 shim，它在客户端 JavaScript 代码中实现该协议。
12.  对于不支持验证电子邮件协议的电子邮件服务，该协议允许第三方充当受信任的中介，声称他们已经验证了用户对帐户的所有权。拥有大量此类第三方是不可取的；此功能仅用于允许升级路径，并且更希望电子邮件服务自己提供这些断言。
13.  Mozilla 提供自己的服务，以充当此类受信任的第三方。实施验证电子邮件协议的服务提供商（即依赖方）可以选择信任或不信任 Mozilla 的断言。Mozilla 的服务使用发送带有确认链接的电子邮件的传统方式来验证用户的帐户所有权。
14.  除了他们可能希望提供的任何其他身份验证方法之外，服务提供商当然可以提供此协议作为选项。
15.  这里寻求的一个很大的用户界面好处是“身份选择器”。当用户访问网站并选择进行身份验证时，他们的浏览器会向他们显示电子邮件地址的选择（“个人”、“工作”、“政治活动”等），他们可能会使用这些地址向该网站表明自己的身份。
16.  作为这项工作的一部分，正在寻求的另一个重要的用户界面好处是[帮助浏览器更多地了解用户的会话](https://wiki.mozilla.org/Identity/Verified_Email_Protocol/Latest-Session)——他们目前主要以谁的身份登录——因此它可能会在浏览器 chrome 中显示。
17.  由于该系统的分布式特性，它避免了锁定到 Facebook、Twitter、Google 等主要网站。任何个人都可以拥有自己的域，因此可以充当自己的身份提供者。

这并不是严格意义上的“基于表单的网站身份验证”。但这是从当前基于表单的身份验证规范过渡到更安全的东西的努力：浏览器支持的身份验证。

* * *

## 回答 #4

> 赞同：149
> 
> 时间：2012-05-22T12:11:20.310

我只是想我会分享这个我发现工作得很好的解决方案。

我称之为**虚拟场**（虽然我没有发明这个所以不要相信我）。

简而言之：您只需将其插入您的`<form>`并在验证时检查它是否为空：

```
<input type="text" name="email" style="display:none" /> 
```

诀窍是欺骗机器人认为它必须将数据插入到必填字段中，这就是我将输入命名为“电子邮件”的原因。如果您已经有一个名为 email 的字段正在使用，您应该尝试将虚拟字段命名为其他名称，例如“company”、“phone”或“emailaddress”。只需选择您知道不需要的内容，以及听起来人们通常认为合乎逻辑的内容来填写网络表单。`input`现在使用 CSS 或 JavaScript/jQuery隐藏该字段 - 任何最适合您的 - 只是**不要**将输入设置`type`为`hidden`，否则机器人不会上当。

当您验证表单（客户端或服务器端）时，请检查您的虚拟字段是否已填写，以确定它是由人类还是机器人发送的。

例子：

**如果是人类：** 用户将看不到虚拟字段（在我的情况下名为“电子邮件”）并且不会尝试填充它。因此，当表单已发送时，虚拟字段的值仍应为空。

**在机器人的情况下：**机器人将看到一个字段，其类型是`text`和名称`email`（或您所称的任何名称），并会在逻辑上尝试用适当的数据填充它。它不在乎你是否使用一些花哨的 CSS 来设置输入表单的样式，Web 开发人员一直都在这样做。无论 dummy 字段中的值是什么，只要它比`0`字符大，我们都不在乎。

我结合[CAPTCHA](http://en.wikipedia.org/wiki/CAPTCHA)在留言簿上使用了这种方法，从那以后我再也没有看到过任何垃圾邮件。我之前使用过仅限 CAPTCHA 的解决方案，但最终，它导致每小时大约有五个垃圾邮件帖子。在表单中添加虚拟字段已停止（至少到现在为止）所有垃圾邮件的出现。

我相信这也可以与登录/身份验证表单一起使用。

**警告**：当然，这种方法不是 100% 万无一失的。可以对机器人进行编程以忽略`display:none`应用了样式的输入字段。您还必须考虑使用某种形式的自动完成（就像大多数浏览器都内置了！）为他们自动填写所有表单字段的人。他们也可以选择一个虚拟字段。

您也可以通过使虚拟字段可见但在屏幕边界之外来稍微改变这一点，但这完全取决于您。

要有创意！

* * *

## 回答 #5

> 赞同：87
> 
> 时间：2011-08-08T16:29:10.103

我不认为上面的答案是“错误的”，但是还有很多没有涉及到的身份验证领域（或者更确切地说，重点是“如何实现 cookie 会话”，而不是“哪些选项可用以及交易是什么-offs”。

我建议的编辑/答案是

*   问题更多在于帐户设置而不是密码检查。
*   使用双因素身份验证比更聪明的密码加密方式更安全
*   不要尝试实现自己的登录表单或密码的数据库存储，除非存储的数据在创建帐户和自行生成时没有价值（即 Facebook、[Flickr](http://en.wikipedia.org/wiki/Flickr)等 web 2.0 风格）

    1.  摘要身份验证是所有主要浏览器和服务器都支持的基于标准的方法，即使通过安全通道也不会发送密码。

这避免了任何需要“会话”或 cookie，因为浏览器本身每次都会重新加密通信。它是最“轻量级”的开发方式。

但是，我不建议这样做，除非是公共的、低价值的服务。这是上面其他一些答案的问题 - 不要尝试重新实现服务器端身份验证机制 - 这个问题已得到解决并得到大多数主要浏览器的支持。不要使用cookies。不要在您自己的手动数据库中存储任何内容。只需根据请求询问请求是否经过身份验证。其他一切都应该由配置和第三方受信任的软件支持。

所以 ...

首先，我们将最初创建帐户（使用密码）与随后重新检查密码混淆了。如果我是 Flickr 并且第一次创建您的网站，那么新用户可以访问零值（空白网络空间）。我真的不在乎创建帐户的人是否对他们的名字撒谎。如果我正在创建医院内联网/外联网的帐户，其价值在于所有医疗记录，因此我*确实*关心帐户创建者的身份 (*)。

这是非常非常困难的部分。*唯一*体面的解决方案是信任网络。例如，您以医生身份加入医院。你用你的照片、护照号码和公钥创建一个托管在某个地方的网页，然后用私钥对它们进行哈希处理。然后您访问医院，系统管理员查看您的护照，查看照片是否与您匹配，然后使用医院私钥对网页/照片哈希进行哈希处理。从现在开始，我们可以安全地交换密钥和令牌。任何信任医院的人都可以（顺便说一句，这里有秘诀）。系统管理员还可以为您提供[RSA](http://en.wikipedia.org/wiki/RSA_%28security_firm%29)加密狗或其他双重身份验证。

但这很*麻烦*，而且不是 web 2.0。但是，这是创建新帐户的唯一安全方法，这些帐户可以访问非自行创建的有价值信息。

1.  Kerberos 和 SPNEGO - 具有可信第三方的单点登录机制 - 基本上，用户针对可信第三方进行验证。（注意，这绝不是不可信的[OAuth](http://en.wikipedia.org/wiki/OAuth)）

2.  [SRP](http://en.wikipedia.org/wiki/Secure_Remote_Password_protocol) - 一种没有受信任第三方的巧妙密码认证。但是在这里，我们进入了“使用两因素身份验证更安全，即使这更昂贵”的领域

3.  [SSL](http://en.wikipedia.org/wiki/SSL)客户端——给客户端一个公钥证书（在所有主流浏览器中都支持——但对客户端机器的安全性提出了质疑）。

最后，这是一个权衡 - 安全漏洞的成本与实施更安全方法的成本是多少。有一天，我们可能会看到一种适当的[PKI](http://en.wikipedia.org/wiki/Public-key_infrastructure)被广泛接受，因此不再拥有自己的滚动身份验证表单和数据库。一天...

* * *

## 回答 #6

> 赞同：59
> 
> 时间：2011-08-08T23:07:08.973

散列时，不要使用 MD5 等快速散列算法（存在许多硬件实现）。使用类似 SHA-512 的东西。对于密码，较慢的哈希值更好。

创建散列的速度越快，任何蛮力检查器的工作速度就越快。因此，较慢的哈希将减慢暴力破解。对于较长的密码（8 位 +），慢速哈希算法将使暴力破解变得不切实际

* * *

## 回答 #7

> 赞同：56
> 
> 时间：2012-11-24T21:15:52.187

关于身份验证系统，我最喜欢的规则是：使用密码，而不是密码。容易记住，很难破解。更多信息：[编码恐怖：密码与密码短语](http://www.codinghorror.com/blog/2005/07/passwords-vs-pass-phrases.html)

* * *

## 回答 #8

> 赞同：32
> 
> 时间：2015-07-18T01:18:52.113

我想添加一个我使用过的建议，基于深度防御。您不需要为管理员使用与普通用户相同的身份验证和身份验证系统。您可以在单独的 url 上有一个单独的登录表单，为将授予高权限的请求执行单独的代码。这个可以做出对普通用户来说完全是痛苦的选择。我使用的一种方法是实际打乱登录 URL 以供管理员访问，并通过电子邮件向管理员发送新 URL。立即停止任何蛮力攻击，因为您的新 URL 可能非常困难（非常长的随机字符串），但您的管理员用户唯一的不便之处是关注他们电子邮件中的链接。攻击者甚至不知道在哪里发布。

* * *

## 回答 #9

> 赞同：21
> 
> 时间：2015-08-16T17:31:35.713

我不知道最好将其作为答案还是作为评论来回答。我选择了第一个选项。

关于第一个答案中的**第四部分：忘记密码功能**，我想说明一下时间攻击。

在**记住您的密码**表单中，攻击者可能会检查完整的电子邮件列表并检测哪些已注册到系统（请参见下面的链接）。

关于忘记密码表单，我要补充一点，使用一些延迟功能来相等的成功和不成功查询之间的时间是一个好主意。

[https://crypto.stanford.edu/~dabo/papers/webtiming.pdf](https://crypto.stanford.edu/~dabo/papers/webtiming.pdf)

* * *

## 回答 #10

> 赞同：19
> 
> 时间：2015-04-29T01:06:29.373

我想补充一条非常重要的评论：-

*   “在*公司的* **内部**网环境中”，如果不是全部，上述大部分内容可能都不适用！

许多公司部署“仅供内部使用”的网站，这些网站实际上是恰好通过 URL 实现的“公司应用程序”。这些 URL 可以*（据说......）*只能在“公司的内部网络”中解析。*（哪个网络神奇地包括所有连接 VPN 的“公路勇士”。）*

当用户尽职地连接到上述网络时，他们的身份*（“身份验证”）* [已经......]“确凿地知道”，因为他们允许*（“授权”）*做某些事情......例如。 ..“访问这个网站。”

这种“身份验证+授权”服务可以由几种不同的技术提供，例如 LDAP *(Microsoft OpenDirectory)*或 Kerberos。

从您的角度来看，您只知道这一点：*任何*合法地在您的网站上结束的人都*必须*伴随着 [一个神奇地包含...的环境变量] 一个“令牌”。（*即*没有这样的标记必须是直接的理由`404 Not Found`。）

令牌的价值对您来说没有意义，*但是，*如果需要，“存在适当的方法”，您的网站可以“[权威地]询问知道（LDAP ...等）的人”任何*和所有（！）*你可能有的问题。换句话说，你**没有**利用*任何*“本土逻辑”。相反，你询问管理局并暗中相信它的裁决。

嗯……这是从“狂野的互联网”中进行的一次*相当大的心理转变。*

* * *

## 回答 #11

> 赞同：9
> 
> 时间：2016-08-10T13:27:44.113

使用[OpenID Connect](http://openid.net/connect/)或[User-Managed Access](https://kantarainitiative.org/confluence/display/uma/Home)。

因为没有什么比不做更有效的了。********

# unit-testing - 如何使用集合的组合作为测试数据

> ID：561
> 
> 赞同：27
> 
> 时间：2008-08-02T21:34:24.223
> 
> 标签：unit-testing, language-agnostic, testing

我想用一组边缘案例和正常值的元组来测试一个函数。例如，在测试一个函数时，`true`只要给定三个构成有效三角形的长度就返回，我会遇到特定情况，负数/小数/大数，接近溢出的值等；更重要的是，主要目的是生成这些值的组合，*无论*是否*重复*，以获得一组测试数据。

```
(inf,0,-1), (5,10,1000), (10,5,5), (0,-1,5), (1000,inf,inf),
... 
```

> *作为说明：我实际上知道这个问题的答案，但它可能对其他人有帮助，对这里的人来说是一个挑战！--稍后会发布我的答案。*

* * *

## 回答 #1

> 赞同：18
> 
> 时间：2008-08-03T19:06:00.327

绝对可以，尤其是在处理大量这些排列/组合时，我绝对可以看到第一遍将是一个问题。

python 中有趣的实现，尽管我基于“算法 515”（见下文）用 C 和 Ocaml 编写了一个不错的实现。他用 Fortran 写了他的，因为当时所有的“算法 XX”论文都很常见，嗯，那个汇编或 c。我不得不重新编写它并进行一些小的改进以使用数组而不是数字范围。这个是随机访问的，我仍在努力实现 Knuth 第 4 卷分册 2 中提到的一些不错的实现。我将向读者解释这是如何工作的。虽然如果有人好奇，我不会反对写一些东西。

```
/** [combination c n p x]
 * get the [x]th lexicographically ordered set of [p] elements in [n]
 * output is in [c], and should be sizeof(int)*[p] */
void combination(int* c,int n,int p, int x){
    int i,r,k = 0;
    for(i=0;i<p-1;i++){
        c[i] = (i != 0) ? c[i-1] : 0;
        do {
            c[i]++;
            r = choose(n-c[i],p-(i+1));
            k = k + r;
        } while(k < x);
        k = k - r;
    }
    c[p-1] = c[p-2] + x - k;
} 
```

~“算法 515：从字典索引生成向量”；Buckles, BP 和 Lybanon, M. ACM Transactions on Mathematical Software，Vol。3，第 2 期，1977 年 6 月。

* * *

## 回答 #2

> 赞同：4
> 
> 时间：2008-10-04T08:52:47.767

使用全新的 Python 2.6，您可以使用 itertools 模块返回 iterables 的笛卡尔积的标准解决方案：

```
import itertools

print list(itertools.product([1,2,3], [4,5,6]))
   [(1, 4), (1, 5), (1, 6),
   (2, 4), (2, 5), (2, 6),
   (3, 4), (3, 5), (3, 6)] 
```

您可以提供“重复”参数以使用可迭代和自身执行产品：

```
print list(itertools.product([1,2], repeat=3))
[(1, 1, 1), (1, 1, 2), (1, 2, 1), (1, 2, 2),
(2, 1, 1), (2, 1, 2), (2, 2, 1), (2, 2, 2)] 
```

你也可以用组合来调整一些东西：

```
print list(itertools.combinations('123', 2))
[('1', '2'), ('1', '3'), ('2', '3')] 
```

如果顺序很重要，则有排列：

```
print list(itertools.permutations([1,2,3,4], 2))
[(1, 2), (1, 3), (1, 4),
   (2, 1), (2, 3), (2, 4),
   (3, 1), (3, 2), (3, 4),
   (4, 1), (4, 2), (4, 3)] 
```

当然，所有那些很酷的东西并不完全相同，但你可以以某种方式使用它们来解决你的问题。

请记住，您可以使用 list()、tuple() 和 set() 将元组或列表转换为集合，反之亦然。

* * *

## 回答 #3

> 赞同：3
> 
> 时间：2008-08-03T00:04:59.023

有趣的问题！

我会通过选择组合来做到这一点，类似于 python 中的以下内容。最难的部分可能是第一次通过验证，即`if f(1,2,3) returns true`，这是一个正确的结果吗？一旦你验证了这一点，那么这就是回归测试的良好基础。

制作一组你知道全部为真的测试用例（例如，这个三角形案例为 3,4,5）和一组你知道全部为假的测试用例（例如 0,1 ,inf)。然后您可以更轻松地验证测试是否正确。

```
# xpermutations 来自 http://code.activestate.com/recipes/190465
从 xpermutations 导入 *

长度=[-1,0,1,5,10,0,1000,'inf']
for c in xselections(lengths,3): # or xuniqueselections
    打印 c

```

```
(-1,-1,-1);
(-1,-1,0);
(-1,-1,1);
(-1,-1,5);
(-1,-1,10);
(-1,-1,0);
(-1,-1,1000);
(-1,-1,inf);
(-1,0,-1);
(-1,0,0);
...

```

* * *

## 回答 #4

> 赞同：2
> 
> 时间：2008-08-16T13:31:37.727

我认为您可以使用[行测试属性](http://blog.donnfelker.com/2008/04/01/NUnit247AndTheRowTestAttributeWithExample.aspx)（在 MbUnit 和更高版本的 NUnit 中可用）来执行此操作，您可以在其中指定多个集合来填充一个单元测试。

* * *

## 回答 #5

> 赞同：0
> 
> 时间：2008-09-17T03:15:18.467

虽然可以创建大量测试数据并查看会发生什么，但尝试最小化正在使用的数据会更有效。

从典型的 QA 角度来看，您可能希望识别不同的输入分类。为每个分类生成一组输入值并确定适当的输出。

这是输入值类别的示例

*   具有小数字的有效三角形，例如（10 亿、2、10 亿、20 亿）
*   具有大数字的有效三角形，例如 (0.000001, 0.00002, 0.00003)
*   “几乎”平坦的有效钝角三角形，例如 (10, 10, 19.9999)
*   “几乎”平坦的有效锐角三角形，例如 (10, 10, 0000001)
*   具有至少一个负值的无效三角形
*   两条边之和等于第三条边的无效三角形
*   两条边之和大于第三条边的无效三角形
*   非数字的输入值

...

一旦您对该函数的输入分类列表感到满意，您就可以创建实际的测试数据。测试每个项目的所有排列可能会有所帮助。(例如 (2,3,4), (2,4,3), (3,2,4), (3,4,2), (4,2,3), (4,3,2))通常，您会发现遗漏了一些分类（例如将 inf 作为输入参数的概念）。

一段时间内的随机数据也可能会有所帮助，它可以在代码中发现奇怪的错误，但通常没有效率。

更有可能的是，此函数正在应用附加规则的某些特定上下文中使用。（例如，只有整数值或值必须以 0.01 为增量等）这些添加到输入参数的分类列表中。

# c# - 如何在 Medium Trust 中写入 Web.Config？

> ID：562
> 
> 赞同：51
> 
> 时间：2008-08-02T21:39:11.733
> 
> 标签：c#, asp.net, medium-trust

将我的第一个大小适中的网络应用程序上传到我的共享主机给我带来了一系列新的挑战，我的意思是，不眠之夜。问题是我肯定没有开发我的中等信任应用程序（或者知道那是什么。）

我减轻了所有问题，保存一个。

我为管理员编写了一个安装程序，以便能够指定他们的连接字符串和其他首选项，但我找不到以中等信任度写入 web.config 的方法。有没有人有解决方案，还是我应该将首选项放在另一个文件中？

* * *

## 回答 #1

> 赞同：24
> 
> 时间：2008-08-02T23:33:30.740

这实际上听起来像 IIS 的`Low`级别。如果是，那么您将无法写入任何文件，而不仅仅是 web.config。

以下是 IIS 帮助文件中的级别：

> *   完全（内部）- 指定不受限制的权限。授予 ASP.NET 应用程序访问受操作系统安全性约束的任何资源的权限。支持所有特权操作。
> *   高 (web_hightrust.config) - 指定高级别的代码访问安全性，这意味着默认情况下应用程序不能执行以下任何一项操作：
>     *   调用非托管代码。
>     *   调用服务组件。
>     *   写入事件日志。
>     *   访问消息队列服务队列。
>     *   访问 ODBC、OleDb 或 Oracle 数据源。
> *   中等 (web_mediumtrust.config) - 指定中等级别的代码访问安全性，这意味着除了高信任级别限制之外，ASP.NET 应用程序默认不能执行以下任何操作：
>     *   访问应用程序目录之外的文件。
>     *   访问注册表。
>     *   进行网络或 Web 服务调用。
> *   低 (web_lowtrust.config) - 指定低级别的代码访问安全性，这意味着，除了中等信任级别限制之外，应用程序默认不能执行以下任何操作：
>     *   写入文件系统。
>     *   调用断言方法。
> *   Minimal (web_minimaltrust.config) - 指定代码访问安全的最低级别，这意味着应用程序只有执行权限。

我建议，如果您对安装程序一无所知，请让它`web.config`在内存中创建一个用户可以在本地保存并`FTP`随后保存的内存。

# c# - Java 和 C# 中的 int 和 Integer 有什么区别？

> ID：564
> 
> 赞同：271
> 
> 时间：2008-08-02T21:47:34.820
> 
> 标签：c#, java, integer, int

当我遇到[Joel Spolsky](http://en.wikipedia.org/wiki/Joel_Spolsky)说一些特定类型的程序员知道Java/C#（面向对象编程语言）中的 an和 an之间的区别时，我正在阅读*[更多 Joel on Software 。](https://rads.stackoverflow.com/amzn/click/com/1430209879)*`int``Integer`

那么区别是什么呢？

* * *

## 回答 #1

> 赞同：253
> 
> 时间：2008-08-02T21:55:45.477

**在 Java 中，** “int”类型是原始类型，而“Integer”类型是对象。

**在 C# 中，** 'int' 类型与值类型相同`System.Int32`并且是[值类型](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/value-types)（即更像 java 'int'）。整数（就像任何其他值类型一样）可以[装箱](https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/types/boxing-and-unboxing)（“包装”）到对象中。

* * *

对象和原语之间的区别在某种程度上超出了这个问题的范围，但总结一下：

**对象**为多态提供了便利，通过引用传递（或者更准确地说是通过值传递引用），并从[堆中](http://en.wikipedia.org/wiki/Dynamic_memory_allocation)分配。相反，**原语**是按值传递的不可变类型，通常从[堆栈](https://en.wikipedia.org/wiki/Stack-based_memory_allocation)中分配。

* * *

## 回答 #2

> 赞同：155
> 
> 时间：2008-08-02T22:05:08.093

嗯，在 Java 中，int 是原始类型，而 Integer 是对象。意思是，如果你创建了一个新的整数：

```
Integer i = new Integer(6); 
```

你可以在 i 上调用一些方法：

```
String s = i.toString();//sets s the string representation of i 
```

而使用 int：

```
int i = 6; 
```

你不能在它上面调用任何方法，因为它只是一个原语。所以：

```
String s = i.toString();//will not work!!! 
```

会产生错误，因为 int 不是对象。

int 是 Java 中为数不多的原语之一（还有 char 和其他一些原语）。我不是 100% 确定，但我认为 Integer 对象或多或少只有一个 int 属性和一大堆与该属性交互的方法（例如 toString() 方法）。所以 Integer 是一种处理 int 的奇特方式（就像 String 可能是处理一组字符的奇特方式一样）。

我知道 Java 不是 C，但由于我从未用 C 编程，这是我能得出的最接近答案的答案。希望这可以帮助！

[整数对象 javadoc](http://docs.oracle.com/javase/7/docs/api/java/lang/Integer.html)

[整数 Ojbect 与 int 原始比较](http://mindprod.com/jgloss/intvsinteger.html)

* * *

## 回答 #3

> 赞同：40
> 
> 时间：2008-08-03T02:32:50.690

我将补充上面给出的优秀答案，并讨论装箱和拆箱，以及这如何适用于 Java（尽管 C# 也有）。我将只使用 Java 术语，因为我对此更加*熟悉*。

正如上面提到的答案，`int`只是一个数字（称为未*装箱*类型），而是`Integer`一个对象（包含数字，因此是*装箱*类型）。用 Java 术语来说，这意味着（除了不能在 上调用方法`int`），您不能在集合（、、等）中存储或其他`int`非对象类型。为了存储它们，您必须首先将它们装入相应的盒装类型中。`List``Map`

Java 5 以后有一些称为*自动装箱*和*自动拆箱*的东西，它允许装箱/拆箱在幕后完成。比较对比： Java 5 版本：

```
Deque<Integer> queue;

void add(int n) {
    queue.add(n);
}

int remove() {
    return queue.remove();
} 
```

Java 1.4 或更早版本（也没有泛型）：

```
Deque queue;

void add(int n) {
    queue.add(Integer.valueOf(n));
}

int remove() {
    return ((Integer) queue.remove()).intValue();
} 
```

必须注意，尽管 Java 5 版本很简洁，但两个版本都生成相同的字节码。因此，尽管自动装箱和自动拆箱非常方便，因为您编写的代码更少，但这些操作*确实*发生在幕后，运行时成本相同，因此您仍然必须了解它们的存在。

希望这可以帮助！

* * *

## 回答 #4

> 赞同：29
> 
> 时间：2008-08-04T14:11:03.557

我将在这里发帖，因为其他一些帖子相对于 C# 有点不准确。

**正确：** `int`是`System.Int32`.
**错误：** `float`不是 的别名`System.Float`，而是`System.Single`

基本上，int 是 C# 编程语言中的保留关键字，是`System.Int32`值类型的别名。

但是，float 和 Float 并不相同，因为 '' `float`'' 的正确系统类型是 System.Single。有一些像这样的类型具有保留关键字，这些关键字似乎与类型名称不直接匹配。

`int`在 C# 中，'' '' 和 '' '' 或任何其他对或关键字/系统类型之间没有区别`System.Int32`，定义枚举时除外。使用枚举，您可以指定要使用的存储大小，在这种情况下，您只能使用保留关键字，而不是系统运行时类型名称。

int 中的值是存储在堆栈中、内存中还是作为引用的堆对象取决于上下文以及您如何使用它。

方法中的此声明：

```
int i; 
```

根据优化定义一个`i`类型的变量，存在于寄存器或堆栈中。`System.Int32`类型（结构或类）中的相同声明定义了一个成员字段。方法参数列表中的相同声明定义了一个参数，具有与局部变量相同的存储选项。（请注意，如果您开始将迭代器方法混入其中，则本段无效，这些完全是不同的野兽）

要获取堆对象，可以使用装箱：

```
object o = i; 
```

`i`这将在堆上创建内容的盒装副本。在 IL 中，您可以直接访问堆对象上的方法，但在 C# 中，您需要将其转换回 int，这将创建另一个副本。因此，如果不创建新 int 值的新盒装副本，就无法在 C# 中轻松更改堆上的对象。（呃，这一段读起来并不容易。）

* * *

## 回答 #5

> 赞同：21
> 
> 时间：2008-08-05T20:49:13.017

关于 Java 1.5 和[自动装箱](http://en.wikipedia.org/wiki/Autoboxing#Autoboxing)，在比较 Integer 对象时会出现一个重要的“怪癖”。

在 Java 中，值为 -128 到 127 的 Integer 对象是不可变的（也就是说，对于一个特定的整数值，比如 23，通过程序实例化的值为 23 的所有 Integer 对象都指向*完全相同的*对象）。

例如，这将返回 true：

```
Integer i1 = new Integer(127);
Integer i2 = new Integer(127);
System.out.println(i1 == i2); //  true 
```

虽然这返回错误：

```
Integer i1 = new Integer(128);
Integer i2 = new Integer(128);
System.out.println(i1 == i2); //  false 
```

== 通过引用进行比较（变量是否指向同一个对象）。

根据您使用的 JVM，此结果可能会有所不同，也可能不会有所不同。Java 1.5 的规范自动装箱要求整数（-128 到 127）始终装箱到同一个包装器对象。

一个办法？=) 在比较 Integer 对象时，应始终使用 Integer.equals() 方法。

```
System.out.println(i1.equals(i2)); //  true 
```

更多信息在[java.net](http://today.java.net/pub/a/today/2005/03/24/autoboxing.html)上的例子[bexhuff.com](http://bexhuff.com/2006/11/java-1-5-autoboxing-wackyness)

* * *

## 回答 #6

> 赞同：20
> 
> 时间：2008-08-06T11:08:52.283

[在 Java 中， JVM](http://java.sun.com/docs/books/jvms/second_edition/html/Concepts.doc.html#22930)中有两种基本类型。1) 原始类型和 2) 引用类型。int 是原始类型，而 Integer 是类类型（这是一种引用类型）。

原始值不与其他原始值共享状态。类型为原始类型的变量始终保存该类型的原始值。

```
int aNumber = 4;
int anotherNum = aNumber;
aNumber += 6;
System.out.println(anotherNum); // Prints 4 
```

对象是动态创建的类实例或数组。引用值（通常只是引用）是指向这些对象的指针和一个特殊的空引用，它不引用任何对象。可能有许多对同一对象的引用。

```
Integer aNumber = Integer.valueOf(4);
Integer anotherNumber = aNumber; // anotherNumber references the 
                                 // same object as aNumber 
```

同样在 Java 中，一切都是按值传递的。对于对象，传递的值是对对象的引用。所以java中int和Integer之间的另一个区别是它们是如何在方法调用中传递的。例如在

```
public int add(int a, int b) {
    return a + b;
}
final int two = 2;
int sum = add(1, two); 
```

变量*2*作为原始整数类型 2 传递。而在

```
public int add(Integer a, Integer b) {
    return a.intValue() + b.intValue();
}
final Integer two = Integer.valueOf(2);
int sum = add(Integer.valueOf(1), two); 
```

变量*2*作为对包含整数值 2 的对象的引用传递。

* * *

@WolfmanDragon：通过引用传递会像这样工作：

```
public void increment(int x) {
  x = x + 1;
}
int a = 1;
increment(a);
// a is now 2 
```

当调用 increment 时，它会将引用（指针）传递给变量*a*。而*增量*函数直接修改变量*a*。

对于对象类型，它的工作方式如下：

```
public void increment(Integer x) {
  x = Integer.valueOf(x.intValue() + 1);
}
Integer a = Integer.valueOf(1);
increment(a);
// a is now 2 
```

你现在看到区别了吗？

* * *

## 回答 #7

> 赞同：11
> 
> 时间：2008-08-02T23:37:10.077

在 C# 中，int 只是 的***别名***，`System.Int32`string的别名`System.String`，double的别名`System.Double`等...

就我个人而言，我更喜欢 int、string、double 等，因为它们不需要`using System;`声明:) 一个愚蠢的理由，我知道......

* * *

## 回答 #8

> 赞同：10
> 
> 时间：2014-07-31T10:07:55.403

使用包装类的原因有很多：

1.  我们得到额外的行为（例如我们可以使用方法）
2.  我们可以存储空值，而在原语中我们不能
3.  集合支持存储对象而不是原语。

* * *

## 回答 #9

> 赞同：8
> 
> 时间：2008-08-04T21:02:54.910

Java 已经回答了这个问题，这是 C# 的答案：

“Integer”不是 C# 中的有效类型名称，“int”只是 System.Int32 的别名。此外，与 Java（或 C++）不同，C# 中没有任何特殊的原始类型，C# 中类型的每个实例（包括 int）都是一个对象。这是一些演示代码：

```
void DoStuff()
{
    System.Console.WriteLine( SomeMethod((int)5) );
    System.Console.WriteLine( GetTypeName<int>() );
}

string SomeMethod(object someParameter)
{
    return string.Format("Some text {0}", someParameter.ToString());
}

string GetTypeName<T>()
{
    return (typeof (T)).FullName;
} 
```

* * *

## 回答 #10

> 赞同：8
> 
> 时间：2008-08-06T14:33:33.090

我在以前的答案中没有看到的另一件事：在 Java 中，原始包装类（如 Integer、Double、Float、Boolean... 和 String）被认为是不变的，因此当您传递这些类的实例时，调用的方法不能以任何方式更改您的数据，与大多数其他类相反，其内部数据可以通过其公共方法更改。因此，除了构造函数之外，这些类只有“getter”方法，没有“setter”。

在Java程序中，字符串文字存储在堆内存的单独部分中，只有文字的一个实例，以节省内存重用这些实例

* * *

## 回答 #11

> 赞同：8
> 
> 时间：2009-01-31T02:49:09.053

在像 Java 这样的平台中，`int`s 是原语，而 s`Integer`是一个包含整数字段的对象。重要的区别是原语总是按值传递，并且根据定义是不可变的。

任何涉及原始变量的操作总是返回一个新值。另一方面，对象是通过引用传递的。有人可能会争辩说，指向对象的点（也称为引用）也是按值传递的，但内容不是。

* * *

## 回答 #12

> 赞同：8
> 
> 时间：2011-12-11T07:19:32.320

int 用于声明原始变量

```
e.g. int i=10; 
```

Integer 用于创建 Integer 类的引用变量

```
Integer a = new Integer(); 
```

* * *

## 回答 #13

> 赞同：7
> 
> 时间：2014-05-17T11:56:58.703

在此之前您是否编程过 (int) 是您可以为变量设置的原始类型之一（就像 char、float 等）。

但是 Integer 是一个包装类，您可以使用它对 int 变量执行一些功能（例如将其转换为字符串或反之亦然，...），但请注意包装类中的方法是静态的，因此您可以使用它们任何时候都无需创建 Integer 类的实例。作为回顾：

```
int x;
Integer y; 
```

x 和 y 都是 int 类型的变量，但是 y 被一个 Integer 类包装，并且有几个你可以使用的方法，但是如果你需要调用 Integer 包装类的一些函数，你可以简单地做到这一点。

```
Integer.toString(x); 
```

但请注意 x 和 y 都是正确的，但如果您只想将它​​们用作原始类型，请使用简单形式（用于定义 x）。

* * *

## 回答 #14

> 赞同：7
> 
> 时间：2016-06-13T19:31:43.493

**爪哇：**

`int`, `double`, `long`, `byte`, `float`, `double`, `short`, `boolean`, `char`- 基元。用于保存语言支持的基本数据类型。原始类型不是对象层次结构的一部分，它们不继承 Object。Thet can'be pass by reference to a method。

`Double`, `Float`, `Long`, `Integer`, `Short`, `Byte`, `Character`, 和`Boolean`, 是类型 Wrappers，封装在`java.lang`. 所有数字类型包装器都定义了允许从给定值或该值的字符串表示构造对象的构造函数。即使是最简单的计算，使用对象也会增加开销。

从 JDK 5 开始，Java 包含了两个非常有用的特性：自动装箱和自动拆箱。自动装箱/拆箱极大地简化了必须将原始类型转换为对象的代码，反之亦然。

构造函数示例：

```
Integer(int num)
Integer(String str) throws NumberFormatException
Double(double num)
Double(String str) throws NumberFormatException 
```

装箱/拆箱示例：

```
class ManualBoxing {
        public static void main(String args[]) {
        Integer objInt = new Integer(20);  // Manually box the value 20.
        int i = objInt.intValue();  // Manually unbox the value 20
        System.out.println(i + " " + iOb); // displays 20 20
    }
} 
```

自动装箱/自动拆箱示例：

```
class AutoBoxing {
    public static void main(String args[]) {
        Integer objInt = 40; // autobox an int
        int i = objInt ; // auto-unbox
        System.out.println(i + " " + iOb); // displays 40 40
    }
} 
```

PS Herbert Schildt 的书被作为参考。

* * *

## 回答 #15

> 赞同：4
> 
> 时间：2014-07-17T06:02:03.273

在两种语言（Java 和 C#）`int`中都是 4 字节有符号整数。

与 Java 不同，C# 提供有符号和无符号整数值。由于 Java 和 C# 是面向对象的，因此这些语言中的某些操作不会直接映射到运行时提供的指令上，因此需要将其定义为某种类型的对象的一部分。

C#`System.Int32`使用属于堆上的引用类型的一部分内存提供了哪个值类型。

java 提供`java.lang.Integer`了在`int`. 中的方法`Integer`不能直接编译为运行时指令。因此我们将一个 int 值装箱以将其转换为 Integer 的实例，并使用需要某种类型实例的方法（如`toString()`，`parseInt()`等`valueOf()`）。

在 C# 中，变量 int 是指`System.Int32.Any`内存中的 4 字节值，可以解释为原始 int，可以通过 System.Int32 的实例进行操作。所以 int 是`System.Int32.When`使用整数相关方法的别名，如`int.Parse()`等`int.ToString()`。整数被编译成FCL`System.Int32`结构调用相应的方法，如`Int32.Parse()`, `Int32.ToString()`。

* * *

## 回答 #16

> 赞同：4
> 
> 时间：2014-08-07T10:50:29.320

Java 和 C# 中的 int 和 Integer 是用于表示不同事物的两个不同术语。它是可以分配给可以精确存储的变量的原始数据类型之一。一次其声明类型的一个值。

**例如：**

```
int number = 7; 
```

`int`分配给包含值 7 的变量 number 的数据类型在哪里。所以 an`int`只是一个原语而不是一个对象。

而 an`Integer`是具有静态方法的原始数据类型的包装类。这可以用作需要对象的方法的参数，而 int 可以用作需要整数值的方法的参数，可以用于算术表达式。

**例如：**

```
Integer number = new Integer(5); 
```

* * *

## 回答 #17

> 赞同：4
> 
> 时间：2015-11-26T10:54:15.217

一个 int 变量保存一个 32 位有符号整数值。Integer（大写 I）持有对（类）类型 Integer 或 null 的对象的引用。

Java 自动在两者之间进行转换；每当 Integer 对象作为 int 运算符的参数出现或分配给 int 变量，或将 int 值分配给 Integer 变量时，从 Integer 到 int。这种铸造称为装箱/拆箱。

如果引用 null 的 Integer 变量被显式或隐式拆箱，则会引发 NullPointerException。

* * *

## 回答 #18

> 赞同：4
> 
> 时间：2017-04-27T07:25:54.037

在 Java 中，`int`类型是原始数据类型，而`Integer`类型是对象。

在 C# 中，`int`类型也是与`System.Int32`. An `integer`（就像任何其他值类型一样）可以装箱（“包装”）到对象中。

* * *

## 回答 #19

> 赞同：3
> 
> 时间：2016-02-28T18:42:46.323

在 Java 中，int 是一种原始数据类型，而 Integer 是一个 Helper 类，它用于将一种数据类型转换为另一种数据类型。

例如：

```
double doubleValue = 156.5d;
Double doubleObject  = new Double(doubleValue);
Byte myByteValue = doubleObject.byteValue ();
String myStringValue = doubleObject.toString(); 
```

原始数据类型存储了 Helper 类复杂的最快可用内存，并存储在 heep 内存中。

来自“David Gassner”Java Essential Training 的参考资料。

* * *

## 回答 #20

> 赞同：2
> 
> 时间：2017-08-04T09:57:22.740

“int”是 Java 中 Wrapper Class 中的原始数据类型和“Integer”。“整数”可以用作需要对象的方法的参数，而“int”可以用作需要整数值的方法的参数，可用于算术表达式。

* * *

## 回答 #21

> 赞同：1
> 
> 时间：2017-03-06T05:08:39.983

`int`在库函数c#中预定义但在java中我们可以创建对象`Integer`

* * *

## 回答 #22

> 赞同：1
> 
> 时间：2018-06-05T11:35:14.763

**01.整数可以为空。但 int 不能为空。**

```
Integer value1 = null; //OK

int value2 = null      //Error 
```

**02\. 只能将 Wrapper Classes 类型值传递给任何集合类。**

（包装类 - 布尔型、字符型、字节型、短型、整数型、长型、浮点型、双精度型）

```
List<Integer> element = new ArrayList<>();
int valueInt = 10;
Integer  valueInteger = new Integer(value);
element.add(valueInteger); 
```

但是通常我们将原始值添加到集合类中？第02点正确吗？

```
List<Integer> element = new ArrayList<>();
element.add(5); 
```

是的 02 是正确的，因为`autoboxing.`

> 自动装箱是 Java 编译器在原始类型与其对应的包装类之间进行的自动转换。

然后 5 通过自动装箱转换为整数值。

* * *

## 回答 #23

> 赞同：0
> 
> 时间：2016-09-22T09:53:52.680

根据我的知识，如果你在 java 中学习，那么当你写 int a; 然后在 java 泛型中它会编译像`Integer a = new Integer()`. 因此，根据泛型`Integer`不使用但`int`使用。所以那里有如此大的差异。

* * *

## 回答 #24

> 赞同：0
> 
> 时间：2018-02-15T21:04:45.903

（Java 版本）简单来说`int`是原始的（不能有空值），整数是 int 的包装对象。

一个使用 Integer 与 int 的示例，当您想再次比较和 int 变量 null 时，它会抛出错误。

```
int a;
//assuming a value you are getting from data base which is null
if(a ==null) // this is wrong - cannot compare primitive to null
{
do something...}

Instead you will use,
Integer a;
//assuming a value you are getting from data base which is null
if(a ==null) // this is correct/legal
{ do something...} 
```

* * *

## 回答 #25

> 赞同：0
> 
> 时间：2019-06-03T07:01:04.717

**int**是原始数据类型。 **Integer**是一个包装类。它可以将 int 数据存储为对象。

* * *

## 回答 #26

> 赞同：0
> 
> 时间：2019-07-03T05:35:18.697

int 是原始数据类型，而 Integer 是对象。使用 Integer 创建对象将使您能够访问 Integer 类中可用的所有方法。但是，如果您使用 int 创建原始数据类型，您将无法使用这些 inbuild 方法，您必须自己定义它们。但是，如果您不想要任何其他方法并希望使程序更节省内存，则可以使用原始数据类型，因为创建对象会增加内存消耗。

# sql-server - 将 SQL Server 数据库从测试部署到实时

> ID：580
> 
> 赞同：30
> 
> 时间：2008-08-02T23:30:59.090
> 
> 标签：sql-server, sql-server-2005, deployment, release-management

我想知道你们如何管理 2 个 SQL Server 之间的数据库部署，特别是 SQL Server 2005。现在，有一个开发和一个实时的。由于这应该是构建脚本的一部分（标准 Windows 批处理，即使这些脚本的当前复杂性，我可能会切换到 PowerShell 左右），Enterprise Manager/Management Studio Express 不计算在内。

您是否只需复制 .mdf 文件并附加它？在处理二进制数据时我总是有点小心，因为这似乎是一个兼容性问题（即使开发和实时应该始终运行相同版本的服务器）。

或者 - 鉴于 T-SQL 中缺少“EXPLAIN CREATE TABLE” - 您是否会执行将现有数据库导出到可以在目标服务器上运行的 SQL 脚本的操作？如果是，是否有一种工具可以自动将给定的数据库转储到 SQL 查询中并在命令行下运行？（同样，Enterprise Manager/Management Studio Express 不算在内）。

最后 - 鉴于实时数据库已经包含数据这一事实，部署可能不涉及创建所有表，而是检查结构和 ALTER TABLE 实时表的差异，这可能还需要在现有字段更改时进行数据验证/转换。

现在，我听到了很多关于[Red Gate](http://www.red-gate.com/products/index.htm)产品的好消息，但对于爱好项目，价格有点高。

那么，您使用什么来自动将 SQL Server 数据库从 Test 部署到 Live？

* * *

## 回答 #1

> 赞同：19
> 
> 时间：2008-08-02T23:51:09.410

我已经开始手动编码我的所有 DDL（创建/更改/删除）语句，将它们作为文本文件添加到我的 .sln 中，并使用普通版本控制（使用颠覆，但任何修订控制都应该工作）。这样，我不仅获得了版本控制的好处，而且从开发/阶段实时更新对于代码和数据库来说是相同的过程——标签、分支等都是一样的。

否则，如果您没有公司为您购买，我同意 redgate 价格昂贵。如果你可以让一家公司为你购买它，那真的很值得！

* * *

## 回答 #2

> 赞同：13
> 
> 时间：2008-08-02T23:40:04.733

对于我的项目，我交替使用 REd Gate 的 SQL Compare 和 Microsoft 的 Database Publishing Wizard，您可以 [在此处](http://www.microsoft.com/downloads/details.aspx?familyid=56E5B1C5-BF17-42E0-A410-371A838E570A&displaylang=en)免费下载。

该向导不像 SQL 比较或 SQL 数据比较那样灵巧，但它可以解决问题。一个问题是它生成的脚本可能需要重新排列和/或编辑才能一次完成。

从好的方面来说，它可以移动您的架构和数据，这对于免费工具来说还不错。

* * *

## 回答 #3

> 赞同：7
> 
> 时间：2008-08-18T10:47:50.613

不要忘记微软的解决方案：[Visual Studio 2008 数据库版](http://msdn.microsoft.com/en-gb/vsts2008/products/bb933747.aspx)。包括用于将更改部署到数据库、为模式和/或数据更改生成数据库之间的差异、单元测试、测试数据生成的工具。

它相当昂贵，但我使用了试用版一段时间，并认为它很棒。它使数据库与任何其他代码一样易于使用。

* * *

## 回答 #4

> 赞同：5
> 
> 时间：2008-08-04T18:00:50.893

像 Rob Allen 一样，我使用 Redgate 的 SQL Compare / Data Compare。我还使用 Microsoft 的数据库发布向导。我还有一个我用 C# 编写的控制台应用程序，它接受一个 sql 脚本并在服务器上运行它。这样，您可以从命令行或批处理脚本中运行带有“GO”命令的大型脚本。

我在控制台应用程序中使用 Microsoft.SqlServer.BatchParser.dll 和 Microsoft.SqlServer.ConnectionInfo.dll 库。

* * *

## 回答 #5

> 赞同：3
> 
> 时间：2008-08-03T00:37:03.903

我的工作方式与 Karl 相同，将用于创建和更改表的所有 SQL 脚本保存在我保存在源代码控制中的文本文件中。事实上，为了避免必须让脚本检查实时数据库以确定要运行的 ALTER 的问题，我通常这样工作：

*   在第一个版本中，我将测试期间的所有内容都放在一个 SQL 脚本中，并将所有表视为 CREATE。这意味着我最终会在测试过程中大量删除和读取表格，但这在项目的早期并不是什么大问题（因为我通常在那个时候破解我正在使用的数据）。
*   在所有后续版本中，我做了两件事：我制作了一个新的文本文件来保存升级 SQL 脚本，其中只包含该版本的 ALTER。我对原始文件进行了更改，还创建了一个新的数据库脚本。这种方式升级只运行升级脚本，但如果我们必须重新创建数据库，我们不需要运行 100 个脚本即可到达那里。
*   根据我部署数据库更改的方式，我通常还会在保存数据库版本的数据库中放置一个版本表。然后，与其对运行哪些脚本做出任何人工决定，我运行创建/升级脚本的任何代码都使用版本来确定运行什么。

如果您从测试转移到生产的部分内容是数据，那么这不会做的一件事是有帮助，但是如果您想管理结构而不是为一个漂亮但昂贵的数据库管理包付费，那真的不是很困难。我还发现这是一种很好的方式来保持你的数据库的心理轨迹。

* * *

## 回答 #6

> 赞同：2
> 
> 时间：2008-08-03T00:22:03.997

如果您有一家公司购买它，Quest Software 的 Toad 内置了这种管理功能。它基本上是一个两次单击操作来比较两个模式并生成一个从一个到另一个的同步脚本。

他们有适用于大多数流行数据库的版本，当然包括 Sql Server。

* * *

## 回答 #7

> 赞同：2
> 
> 时间：2008-08-03T01:38:02.640

我同意编写一切脚本是最好的方法，也是我在工作中提倡的。您应该编写从数据库和对象创建到填充查找表的所有内容。

您在 UI 中所做的任何事情都不会翻译（尤其是对于更改......对于第一次部署来说不是那么多），并且最终需要像 Redgate 提供的工具。

* * *

## 回答 #8

> 赞同：2
> 
> 时间：2008-08-04T17:38:59.753

使用 SMO/DMO，生成模式的脚本并不难。数据更有趣，但仍然可行。

一般来说，我采用“编写脚本”的方法，但您可能需要考虑以下方面的内容：

*   区分开发和暂存，以便您可以使用数据子集进行开发......我将创建一个工具来简单地拉下一些生产数据，或者在涉及安全性的情况下生成假数据。
*   对于团队开发，对数据库的每次更改都必须在团队成员之间进行协调。架构和数据更改可以混合使用，但单个脚本应启用给定功能。一旦您的所有功能都准备就绪，您可以将它们捆绑在一个 SQL 文件中，并针对生产恢复运行该文件。
*   一旦您的登台被接受，您就可以在生产机器上再次运行单个 SQL 文件。

我使用过 Red Gate 工具，它们是**很棒的**工具，但如果你买不起，那么构建工具并以这种方式工作也离理想不远。

* * *

## 回答 #9

> 赞同：2
> 
> 时间：2008-08-26T17:39:20.960

我正在使用 Subsonic 的迁移机制，所以我只有一个 dll，其中的类按顺序排列，有 2 个方法，向上和向下。有一个持续集成/构建脚本挂钩到 nant，这样我就可以自动升级我的数据库。

它不是世界上最好的东西，但它胜过编写 DDL。

* * *

## 回答 #10

> 赞同：2
> 
> 时间：2008-08-28T00:22:08.193

[RedGate SqlCompare](http://www.red-gate.com/products/SQL_Compare/index.htm)在我看来是一种方法。我们定期进行数据库部署，自从我开始使用该工具以来，我从未回头。非常直观的界面，最终节省了大量时间。

专业版还将负责源代码控制集成的脚本。

* * *

## 回答 #11

> 赞同：2
> 
> 时间：2010-06-08T21:33:36.510

我还为我的所有对象和数据维护脚本。为了部署，我编写了这个免费实用程序 - [http://www.sqldart.com](http://www.sqldart.com)。它可以让您重新排序脚本文件，并将在事务中运行全部内容。

* * *

## 回答 #12

> 赞同：1
> 
> 时间：2008-08-13T15:41:44.627

我同意将所有内容保存在源代码管理中并手动编写所有更改的脚本。对单个版本的架构的更改会进入专门为该版本创建的脚本文件。所有存储的过程、视图等都应该放入单独的文件中，就源代码控制而言，应该像 .cs 或 .aspx 一样对待。我使用一个 powershell 脚本来生成一个大的 .sql 文件来更新可编程性的东西。

我不喜欢自动应用架构更改，例如新表、新列等。在进行生产发布时，我喜欢逐个命令执行更改脚本，以确保每个命令都按预期工作。没有什么比在生产环境中运行一个大的更改脚本并出现错误更糟糕的了，因为您忘记了一些在开发过程中没有出现的小细节。

我还了解到，索引需要像代码文件一样对待，并放入源代码控制中。

而且您绝对应该拥有超过 2 个数据库 - 开发和实时数据库。您应该有一个每个人都用于日常开发任务的开发数据库。然后是一个模拟生产的暂存数据库，用于进行集成测试。如果可行，那么可能是最近的完整生产副本（从完整备份中恢复），因此您的最后一轮安装测试与尽可能接近真实的东西背道而驰。

* * *

## 回答 #13

> 赞同：1
> 
> 时间：2008-08-26T15:38:22.000

我将所有数据库创建作为 DDL，然后将该 DDL 包装到模式维护类中。首先，我可能会做各种事情来创建 DDL，但基本上我会在代码中维护所有模式。这也意味着，如果需要执行不能很好地映射到 SQL 的非 DDL 事情，您可以编写过程逻辑并在 DDL/DML 块之间运行它。

然后我的 dbs 有一个定义当前版本的表，因此可以编写一组相对简单的测试：

1.  数据库存在吗？如果不创建它。
2.  数据库是当前版本吗？如果没有，则按顺序运行使架构更新的方法（您可能希望提示用户确认并 - 理想情况下 - 此时进行备份）。

对于单用户应用程序，我只是在适当的位置运行它，对于网络应用程序，如果版本不匹配并且我们运行独立的模式维护应用程序，我们目前将用户锁定在外。对于多用户，这将取决于特定的环境。

优势？好吧，我非常有信心使用这种方法的应用程序的架构在这些应用程序的所有实例中都是一致的。它并不完美，有问题，但它有效......

在团队环境中开发时存在一些问题，但无论如何这或多或少是给定的！

墨菲

* * *

## 回答 #14

> 赞同：1
> 
> 时间：2008-11-27T03:15:45.337

我目前正在为你做同样的事情。不仅部署SQL Server数据库从测试到上线，还包括从本地->集成->测试->生产的全过程。所以每天可以让我轻松的是我[使用 Red-Gate SQL Compare 执行 NAnt 任务](http://tech.wowkhmer.com/post/2008/11/11/NAnt-task-with-Red-Gate-SQL-Compare.aspx)。我不为 RedGate 工作，但我不得不说这是一个不错的选择。

# php - 使用 PHP 访问 Exchange 的最佳方式？

> ID：588
> 
> 赞同：57
> 
> 时间：2008-08-03T00:03:58.510
> 
> 标签：php, windows, exchange-server, webdav, mapi

我正在用 PHP 编写一个 CMS 应用程序，其中一个要求是它必须能够与客户的 Exchange 服务器交互。我之前已经写过几次这个功能，并且一直使用[WebDAV](http://en.wikipedia.org/wiki/WebDAV)来完成它，但现在我不再使用它了。

我将在 Windows server 2008 上的 IIS 或 Apache（无偏好）上运行该站点。我需要做的一些事情包括将联系人添加到给定用户的地址簿、作为给定用户发送电子邮件以及运行联系人报告用户。

所有这一切都可以通过 WebDAV 轻松完成，但如果有更好的方法不需要任何可能很快就会被弃用的功能。

有任何想法吗？

### 更新：

贾斯汀，我喜欢使用 com 对象的想法，我只是担心维护第三个产品以使一切正常......

约翰，我可以用 C# 编写一个 Web 服务来与这些函数交互，并使用我的 PHP 应用程序访问它，但它也有点偏僻。

到目前为止，我并不是 100% 相信其中任何一个都比 WebDAV 更好......

谁能告诉我我在哪里傻？

* * *

## 回答 #1

> 赞同：24
> 
> 时间：2008-08-03T07:50:37.617

**截至 2020 年的更新：**
自从这个问题和事情发生以来已经有十多年了。Microsft 现在有一个[Rest API](https://docs.microsoft.com/en-us/exchange/client-developer/exchange-web-services/office-365-rest-apis-for-mail-calendars-and-contacts)，可以让您轻松访问这些数据。

* * *

**原始答案**

我没有使用 PHP 来做到这一点，但有使用 C# 来实现相同目标的经验。

Outlook API 是一种自动化 Outlook 的方法，而不是直接连接到 Exchange。我以前在 C# 应用程序中采用过这种方法，它确实有效，尽管可能有问题。

如果您希望直接连接到 Exchange 服务器，则需要研究扩展 MAPI。

过去我使用这个包装器[MAPIEx: Extended MAPI Wrapper](http://www.codeproject.com/KB/IP/CMapiEx.aspx)。

这是一个 C# 项目，但我相信您可以在 PHP5 Windows 服务器上使用一些 .NET 代码。或者，它有一个您可以使用的 C++ 核心 DLL。我发现它非常好，并且有一些很好的示例应用程序。

* * *

抱歉，目前还没有跟踪帖子的方法。

我同意在您的应用程序上添加更多层并依赖 3rd 方代码可能会很可怕（这是理所当然的。）

今天我阅读了另一篇[有趣的帖子](https://stackoverflow.com/questions/4508/mapi-and-managed-code-experiences)，标记为 MAPI，主题不同。不过这里的关键是它与[这篇重要的 MS 文章](http://blogs.msdn.com/mstehle/archive/2007/10/03/fyi-why-are-mapi-and-cdo-1-21-not-supported-in-managed-net-code.aspx)相关联。到目前为止，我一直没有意识到使用托管代码与 MAPI 接口的问题，尽管组件中的 C++ 代码应该不受此错误的影响，因为它是非托管的。

此博客条目还建议了连接到 MAPI/Exchange 服务器的其他方法。在这种情况下，由于这些新事实[http://us3.php.net/imap](http://us3.php.net/imap)可能是其他用户建议的答案。

* * *

## 回答 #2

> 赞同：14
> 
> 时间：2008-08-05T02:35:02.820

您的客户是否使用 Exchange 2007？如果是这样，我会看看[Exchange Web Services](http://msdn.microsoft.com/en-us/library/bb204119(EXCHG.80).aspx)。如果不是，尽管它可能很麻烦，但我认为 WebDAV 是你最好的选择。

我个人不喜欢使用 Outlook.Application COM 对象路由，因为它的安全提示（“应用程序正在尝试访问您的联系人。允许这个？”等）可能会导致服务器出现问题。我还认为使用 Outlook 完成类似模拟的任务会很困难，例如以给定用户的身份发送邮件。

* * *

## 回答 #3

> 赞同：12
> 
> 时间：2011-05-04T13:47:32.997

我发布了一个开源的 MIT 许可库，允许您使用 Exchange Web 服务在 PHP 中执行一些基本操作。

[用于 PHP 的 Exchange Web 服务](https://github.com/Heartspring/Exchange-Web-Services-for-PHP)

我只在 Linux 上测试过它，但我看不出它为什么不能在 Windows 安装的 PHP 上运行。

* * *

## 回答 #4

> 赞同：10
> 
> 时间：2008-09-01T20:33:44.037

我不能高度推荐 Dmitry Streblechenko 的[Redemption Data Objects](http://www.dimastr.com/redemption/rdo_introduction.htm)库。它是一个 COM 组件，为 Extended MAPI 提供了一个健全的 API，使用起来很愉快。Exchange API 目标从一个版本移动到下一个版本：“使用 M：驱动器！不，使用 WebDAV！不，使用 ExOLEDB！……不，使用 Web 服务！” 唯一不变的是好的旧 MAPI。

* * *

## 回答 #5

> 赞同：7
> 
> 时间：2008-08-03T03:07:30.150

我不是 PHP 开发人员，但 Google 说 PHP 5+ 可以实例化 COM 组件。如果您可以在一个机器上安装 Outlook，您可以围绕 COM 组件编写一个 PHP Web 服务来处理您需要的请求。

```
$outlook = COM("Outlook.Application") 
```

[Outlook API 参考](http://msdn.microsoft.com/en-us/library/aa193231.aspx)

* * *

## 回答 #6

> 赞同：7
> 
> 时间：2013-02-01T13:20:33.430

我建议使用**“ [PHP Exchange Web Services](https://github.com/jamesiarmes/php-ews) ”**或简短**的 php-ews。**

[wiki](https://github.com/jamesiarmes/php-ews/wiki)下的大量文档对我帮助很大。

* * *

## 回答 #7

> 赞同：6
> 
> 时间：2012-05-09T18:47:12.453

这个[Zarafa PHP MAPI](http://developer.zarafa.com/php-ext/)扩展看起来可以工作。

* * *

## 回答 #8

> 赞同：5
> 
> 时间：2008-08-04T17:00:40.327

我会调查 IMAP

[IMAP、POP3 和 NNTP](http://us3.php.net/imap)

* * *

## 回答 #9

> 赞同：5
> 
> 时间：2018-10-09T16:31:54.517

[https://github.com/Garethp/php-ews](https://github.com/Garethp/php-ews)

它最后一次更新是在 3 个月前，所以它被维护了

# python - cx_Oracle：如何迭代结果集？

> ID：594
> 
> 赞同：55
> 
> 时间：2008-08-03T01:15:08.507
> 
> 标签：python, sql, database, oracle, cx-oracle

有几种方法可以迭代结果集。每个的权衡是什么？

* * *

## 回答 #1

> 赞同：54
> 
> 时间：2008-08-03T01:17:36.393

规范的方法是使用内置的游标迭代器。

```
curs.execute('select * from people')
for row in curs:
    print row 
```

* * *

您可以使用`fetchall()`一次获取所有行。

```
for row in curs.fetchall():
    print row 
```

使用它来创建一个包含返回值的 Python 列表会很方便：

```
curs.execute('select first_name from people')
names = [row[0] for row in curs.fetchall()] 
```

这对于较小的结果集可能很有​​用，但如果结果集很大，则可能会产生不良的副作用。

*   您必须等待整个结果集返回到您的客户端进程。

*   您可能会占用客户端中的大量内存来保存已建立的列表。

*   Python 可能需要一段时间来构建和解构您将立即丢弃的列表。

* * *

如果您知道结果集中返回了单行，则可以调用`fetchone()`以获取单行。

```
curs.execute('select max(x) from t')
maxValue = curs.fetchone()[0] 
```

* * *

最后，您可以循环遍历结果集，一次获取一行。一般来说，这样做比使用迭代器没有特别的优势。

```
row = curs.fetchone()
while row:
    print row
    row = curs.fetchone() 
```

* * *

## 回答 #2

> 赞同：27
> 
> 时间：2008-09-24T02:51:00.173

我首选的方法是游标迭代器，但首先设置游标的 arraysize 属性。

```
curs.execute('select * from people')
curs.arraysize = 256
for row in curs:
    print row 
```

In this example, cx_Oracle will fetch rows from Oracle 256 rows at a time, reducing the number of network round trips that need to be performed

* * *

## 回答 #3

> 赞同：6
> 
> 时间：2008-08-24T17:28:26.200

似乎也有办法`psyco-pg`做到这一点......据我所知，它似乎创建了类似字典的行代理来将键查找映射到查询返回的内存块中。在这种情况下，获取整个答案并在行上使用类似的代理工厂似乎很有用。不过仔细想想，感觉更像是 Lua 而不是 Python。

此外，这应该适用于所有[PEP-249 DBAPI2.0](http://www.python.org/dev/peps/pep-0249/)接口，而不仅仅是 Oracle，还是您的意思是使用*Oracle**最快*？

# c# - 强大的随机数生成

> ID：601
> 
> 赞同：42
> 
> 时间：2008-08-03T02:05:59.620
> 
> 标签：c#, c++, random

我正在寻找不使用特殊硬件的高性能、相当强大的 RNG。它可以使用数学方法（Mersenne Twister 等），它可以从机器中“收集熵”，无论如何。在 Linux/etc 上，我们有一个`drand48()`生成 48 个随机位的。我想要一个用于 C++ 或 C# 的类似函数/类，它可以生成超过 32 位的随机性，并且低位与高位一样随机。

它不必是加密安全的，但它不能使用或基于 C 语言`rand()`或 .NET `System.Random`。

任何源代码、源链接等将不胜感激！如果做不到这一点，我应该寻找什么类型的 RNG？

* * *

## 回答 #1

> 赞同：31
> 
> 时间：2008-08-03T02:18:57.987

对于 C++，[Boost.Random](http://www.boost.org/libs/random/)可能是您正在寻找的。它支持 MT（在许多其他算法中），并且可以通过`nondet_random`类收集熵。看看这个！:-)

* * *

## 回答 #2

> 赞同：8
> 
> 时间：2008-08-03T02:26:33.213

[Gnu 科学库](http://www.gnu.org/software/gsl)(GSL) 有一套相当广泛的 RN 生成器、测试工具等。如果您使用的是 linux，它可能已经在您的系统上可用。

* * *

## 回答 #3

> 赞同：7
> 
> 时间：2008-08-13T18:08:03.457

注意 Gnu 科学图书馆。它是根据 GPL 而不是 LGPL 获得许可的。

正如其他人提到的，Boost 随机类是一个好的开始。它们的实现符合 TR1 的 PRNG 代码：

[http://www.boost.org/doc/libs/1_35_0/libs/random/index.html](http://www.boost.org/doc/libs/1_35_0/libs/random/index.html) [http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2003/n1452.html](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2003/n1452.html)

如果您有最新版本的 G++ 编译器，您可能会发现 TR1 库已包含在内

* * *

## 回答 #4

> 赞同：5
> 
> 时间：2012-06-26T16:05:10.290

C++11 采用了基于 boost.random 的健壮随机数库。您可以使用不同的算法访问多个随机数引擎，以满足您的质量、速度或大小要求。质量实现甚至可以访问您的平台通过`std::random_device`.

此外，还有许多适配器可以生成特定的发行版，从而消除了手动进行此类操作的需要（经常做错的事情）。

[`#include <random>`](http://en.cppreference.com/w/cpp/numeric/random)

* * *

## 回答 #5

> 赞同：2
> 
> 时间：2012-03-29T10:32:22.057

`Boost.Random`是我RNG的首选

[http://www.boost.org/doc/libs/random](http://www.boost.org/doc/libs/random)

# c++ - 使用 Visual Studio 2005 为 Windows NT 4.0 构建？

> ID：609
> 
> 赞同：21
> 
> 时间：2008-08-03T02:48:43.497
> 
> 标签：c++, visual-studio, compatibility, windows-nt

我尝试迁移的 MFC 应用程序使用`afxext.h`，这会导致`_AFXDLL`设置，如果我设置会导致此错误`/MT`：

> 请为 _AFXDLL 构建使用 /MD 开关

迄今为止，我的研究表明，使用 Visual Studio（在本例中为 C++）2005 构建在 Windows NT 4.0 上执行的应用程序是不可能的。

这是真的吗？有没有可用的解决方法？

* * *

## 回答 #1

> 赞同：9
> 
> 时间：2008-08-03T16:54:12.277

不，有许多使用 VS2005 构建的应用程序必须支持 Windows XP、2000、NT 以及整个堆栈。问题是（默认情况下）VS2005 想要使用 NT 上不存在的库/导出。

有关一些背景信息，请参阅[此线程](http://www.mombu.com/microsoft/windows-programmer-win32/t-vs2005-and-nt4-392831.html)。

然后开始通过预处理器宏限制您的依赖关系，并避免使用 NT 不支持的 API。

* * *

## 回答 #2

> 赞同：4
> 
> 时间：2008-08-23T01:16:26.200

为了摆脱 _AFXDLL 错误，您是否尝试更改设置以使用 MFC 作为静态库而不是 DLL？这类似于您在将运行时库更改为静态而不是 DLL 时已经在做的事情。

* * *

## 回答 #3

> 赞同：3
> 
> 时间：2008-10-14T12:32:59.617

解决方法是修复多线程 DLL。[简单的说明](http://social.msdn.microsoft.com/Forums/en-US/vcgeneral/thread/2435c3ab-f732-467e-8224-5f4e3f12c10b/)。简短的摘要：

> 出厂的 8.0 C 运行时库 DLL (MSVCR80.DLL) 不支持 NT 4.0 SP6 的原因有一个：微软的某个人添加了一个`GetLongPathNameW`在 NT 4.0 上的 kernel32.dll 中不存在的函数调用。
> 
> CRTLIB.C 在第 577 行，调用了`GetLongPathNameW`. 只需将其替换为：`ret = 0;` 仅在 NT 4.0 上使用此版本的 MSVCR80.DLL。

一旦你得到这些工作，想出一个更通用的解决方案应该是微不足道的。

* * *

## 回答 #4

> 赞同：1
> 
> 时间：2008-09-18T16:18:02.307

虽然我不熟悉 afxext.h，但我想知道它是什么使它与 Windows NT4 不兼容......

但是，要回答最初的问题：“我迄今为止的研究表明，使用 Visual Studio（在本例中为 C++）2005 构建在 Windows NT 4.0 上执行的应用程序是不可能的。”

答案应该是肯定的，特别是如果应用程序最初是在 NT4 上编写或运行的！除了 afxext.h 之外，这应该很容易。

我发现麻烦的另一件事是人们抛弃 NT 术语的松散性质。诚然，大多数人认为“NT”是 Windows NT4，但它仍然含糊不清，因为“大多数人”不等于“所有人”。

实际上，“NT”一词等同于 NT 系列。NT系列是NT3、NT4、NT5（2000、XP、2003）和NT6（Vista）。

Win32 是一个子系统，您也可以针对您的 C/C++ 代码。所以我认为没有理由不能针对这个 NT4 平台和子系统，或者，如果这是一个平台移植练习，请删除 VC 可能强加的 MFC 依赖项。

将 afxext.h 添加到混合中，这听起来像是子系统兼容性问题。它是我 Google 研究中 MFC 的一部分。afxext.h 似乎是 MFC（Microsoft 基础类）扩展。

你能去掉你对 MFC 的依赖吗？这是什么类型的应用程序？（CLR、服务、GUI 界面？）您可以在 VC 8.0 中将项目转换为非托管 C++ 项目吗？

希望其中一些对您有所帮助。

* * *

## 回答 #5

> 赞同：-1
> 
> 时间：2008-11-20T23:04:42.693

这个想法是需要exe链接到静态库。

请尝试此“配置属性”、“常规”、“MFC 的使用”到“在静态库中使用 MFC”“配置属性”、“常规”、“ATL 的使用”到“ATL 的静态链接”

“配置属性”、“C\C++”、“代码生成”、“运行时库”到“多线程 (\MT)”

测试平台构建机器：Window XP SP2 上的 Visual Studio 2005 客户端机器：Window XP SP2（未安装 VS2005）

# performance - 前 10000 个素数的最有效代码？

> ID：622
> 
> 赞同：64
> 
> 时间：2008-08-03T05:45:21.423
> 
> 标签：performance, algorithm, primes

我想打印前 10000 个素数。谁能给我最有效的代码？说明：

1.  如果您的代码在 n > 10000 时效率低下，则无关紧要。
2.  代码的大小无关紧要。
3.  您不能以任何方式对值进行硬编码。

* * *

## 回答 #1

> 赞同：50
> 
> 时间：2008-08-03T06:03:35.973

[Atkin 的筛子](http://en.wikipedia.org/wiki/Sieve_of_Atkin)可能是您正在寻找的，它的上限运行时间是 O(N/log log N)。

如果你只运行比 6 的倍数多 1 和少 1 的数字，它可能会更快，因为所有高于 3 的素数都与某个 6 的倍数相差 1。 [我的声明的资源](http://primes.utm.edu/notes/faq/six.html)

* * *

## 回答 #2

> 赞同：39
> 
> 时间：2008-08-05T23:49:43.963

我推荐一种筛子，要么是[埃拉托色尼](http://web.archive.org/web/20140705111241/http://primes.utm.edu/links/programs/sieves/Eratosthenes/C_source_code/)筛子，要么[是阿特金筛子。](http://cr.yp.to/primegen.html)

筛子或 Eratosthenes 可能是查找素数列表的最直观的方法。基本上你：

1.  写下从 2 到您想要的任何限制的数字列表，比如说 1000。
2.  取第一个没有被划掉的数字（对于第一次迭代，这是 2）并从列表中划掉该数字的所有倍数。
3.  重复步骤 2，直到到达列表末尾。所有没有划掉的数字都是素数。

显然，可以进行很多优化以使该算法更快地工作，但这是基本思想。

Atkin 的筛子使用了类似的方法，但遗憾的是我对此了解的不够多，无法向您解释。但我确实知道，我链接的算法需要 8 秒才能计算出古代 Pentium II-350 上 1000000000 以内的所有素数

埃拉托色尼筛源代码：[http ://web.archive.org/web/20140705111241/http://primes.utm.edu/links/programs/sieves/Eratosthenes/C_source_code/](http://web.archive.org/web/20140705111241/http://primes.utm.edu/links/programs/sieves/Eratosthenes/C_source_code/)

阿特金筛源代码：[http ://cr.yp.to/primegen.html](http://cr.yp.to/primegen.html)

* * *

## 回答 #3

> 赞同：20
> 
> 时间：2008-08-31T22:20:44.647

这并不严格违反硬编码限制，但非常接近。为什么不以编程方式下载此列表并将其打印出来呢？

[http://primes.utm.edu/lists/small/10000.txt](http://primes.utm.edu/lists/small/10000.txt)

* * *

## 回答 #4

> 赞同：13
> 
> 时间：2008-08-27T20:26:27.947

[GateKiller](https://stackoverflow.com/questions/622/most-efficient-code-for-the-first-10000-prime-numbers#2753)`break`，`if`在`foreach`循环中添加一个怎么样？这会大大加快速度，因为如果像 6 可以被 2 整除，您就不需要检查 3 和 5。（如果我有足够的声誉，我会投票支持您的解决方案:-) ... **）**

```
ArrayList primeNumbers = new ArrayList();

for(int i = 2; primeNumbers.Count < 10000; i++) {
    bool divisible = false;

    foreach(int number in primeNumbers) {
        if(i % number == 0) {
            divisible = true;
            break;
        }
    }

    if(divisible == false) {
        primeNumbers.Add(i);
        Console.Write(i + " ");
    }
} 
```

* * *

## 回答 #5

> 赞同：13
> 
> 时间：2012-04-24T16:30:15.850

在 Haskell 中，我们几乎可以逐字逐句写下埃拉托色尼筛的数学定义，“*素数是大于 1 的自然数，没有任何合数，通过枚举每个素数的倍数来找到合数*”：

```
import Data.List.Ordered (minus, union)

primes = 2 : minus [3..] (foldr (\p r -> p*p : union [p*p+p, p*p+2*p..] r)
                                [] primes) 
```

`primes !! 10000`几乎是瞬时的。

参考：

*   [埃拉托色尼筛](http://en.wikipedia.org/wiki/Sieve_of_Eratosthenes)
*   [Richard Bird 的筛子（见第 10,11 页）](http://www.cs.hmc.edu/~oneill/papers/Sieve-JFP.pdf)
*   [减号，联合](http://www.haskell.org/haskellwiki/Prime_numbers#Initial_definition)

* * *

[上面的代码很容易调整为仅处理赔率，**`primes = 2 : 3 : minus [5,7..] (foldr (\p r -> p*p : union [p*p+2*p, p*p+4*p..] r) [] (tail primes))`**. 通过折叠成树状结构可以大大提高时间复杂度（大约比最佳值高一个*对数*因子），并且通过[多级素数生产可以](https://stackoverflow.com/questions/13894417/double-stream-feed-to-prevent-unneeded-memoization/13895347#13895347)[显着提高](http://ideone.com/se0bsB)空间复杂度，在]

```
primes = 2 : _Y ( (3:) . sieve 5 . _U . map (\p -> [p*p, p*p+2*p..]) )
  where
    _Y g = g (_Y g)                        -- non-sharing fixpoint combinator
    _U ((x:xs):t) = x : (union xs . _U . pairs) t       -- ~= nub.sort.concat
    pairs    (xs:ys:t)  = union xs ys : pairs t
    sieve k s@(x:xs) | k < x      = k : sieve (k+2) s   -- ~= [k,k+2..]\\s,
                     | otherwise  =     sieve (k+2) xs  --   when s⊂[k,k+2..] 
```

[（在 Haskell 中，括号用于分组，函数调用仅通过并列表示，**`(:)`**是列表的*cons*运算符，并且**`(.)`**是函数组合运算符：）**`(f . g) x = (\y -> f (g y)) x = f (g x)`**。]

* * *

## 回答 #6

> 赞同：11
> 
> 时间：2008-10-06T20:03:30.423

@Matt: log(log(10000)) 是~2

从维基百科文章（你引用[的）阿特金筛子](http://en.wikipedia.org/wiki/Sieve_of_Atkin)：

> `O(N/log log N)`该筛子使用仅具有 N ^(1/2+o(1))位内存的操作来计算最多 N 个素数。`O(N)` 这比使用操作和 O(N ^(1/2) (log log N)/log N) 位内存的 Eratosthenes 的筛子要好一些[（AOL Atkin，DJ Bernstein，2004）](http://www.ams.org/mcom/2004-73-246/S0025-5718-03-01501-1/S0025-5718-03-01501-1.pdf)。这些渐近计算复杂性包括简单的优化，例如车轮分解，以及将计算拆分为更小的块。

`O(N)`考虑到（对于 Eratosthenes）和（对于 Atkin）的渐近计算复杂性，`O(N/log(log(N)))`我们不能说（对于 small `N=10_000`）如果实施哪种算法会更快。

Achim Flammenkamp 在[The Sieve of Eratosthenes](http://wwwhomes.uni-bielefeld.de/achim/prime_sieve.html)中写道：

被引用：

@num1

> 对于大于 10^9 的区间，当然对于大于 10^10 的区间，埃拉托色尼筛法的性能要优于使用不可约二元二次形式的阿特金斯和伯恩斯坦筛法。有关背景信息，请参阅他们的论文以及 W. Galway 博士的第 5 段。论文。

因此，对于`10_000`Eratosthenes 的 Sieve 可以比 Atkin 的 Sieve 更快。

要回答 OP，代码是[prime_sieve.c](http://wwwhomes.uni-bielefeld.de/achim/prime_sieve.c)（由 引用`num1`）

* * *

## 回答 #7

> 赞同：10
> 
> 时间：2008-08-29T07:06:43.937

使用 GMP，可以编写以下内容：

```
#include <stdio.h>
#include <gmp.h>

int main() {
  mpz_t prime;
  mpz_init(prime);
  mpz_set_ui(prime, 1);
  int i;
  char* num = malloc(4000);
  for(i=0; i<10000; i++) {
    mpz_nextprime(prime, prime);
    printf("%s, ", mpz_get_str(NULL,10,prime));
  }
} 
```

在我的 2.33GHz Macbook Pro 上，它执行如下：

```
time ./a.out > /dev/null

real    0m0.033s
user    0m0.029s
sys    0m0.003s 
```

在同一台笔记本电脑上计算 1,000,000 个素数：

```
time ./a.out > /dev/null

real    0m14.824s
user    0m14.606s
sys     0m0.086s 
```

GMP 针对这类事情进行了高度优化。除非您真的想通过编写自己的算法来理解算法，否则建议您在 C 下使用 libGMP。

* * *

## 回答 #8

> 赞同：7
> 
> 时间：2008-08-03T18:52:17.093

根本没有效率，但您可以使用正则表达式来测试素数。

```
/^1?$|^(11+?)\1+$/ 
```

这将测试，对于由*k*个“<code>1”组成的字符串，*k*是否*不是素数*（即该字符串是由一个“<code>1”还是由任意数量的“<code>1”组成，可以表示为*n*元积）。

* * *

## 回答 #9

> 赞同：5
> 
> 时间：2008-08-05T19:55:17.557

我已经修改了[CodeProject](http://www.codeproject.com/KB/recipes/highspeed_primenumbers.aspx)上的代码来创建以下内容：

```
ArrayList primeNumbers = new ArrayList();

for(int i = 2; primeNumbers.Count < 10000; i++) {
    bool divisible = false;

    foreach(int number in primeNumbers) {
        if(i % number == 0) {
            divisible = true;
        }
    }

    if(divisible == false) {
        primeNumbers.Add(i);
        Console.Write(i + " ");
    }
} 
```

在我的 ASP.NET 服务器上进行测试需要大约 1 分钟的时间。

* * *

## 回答 #10

> 赞同：4
> 
> 时间：2008-08-20T23:45:54.110

[Eratosthenes 的筛子](http://en.wikipedia.org/wiki/Sieve_of_Eratosthenes)是要走的路，因为它简单且速度快。我在 C 中的实现

```
#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <math.h>

int main(void)
{
    unsigned int lim, i, j;

    printf("Find primes upto: ");
    scanf("%d", &lim);
    lim += 1;
    bool *primes = calloc(lim, sizeof(bool));

    unsigned int sqrtlim = sqrt(lim);
    for (i = 2; i <= sqrtlim; i++)
        if (!primes[i])
            for (j = i * i; j < lim; j += i)
                primes[j] = true;

    printf("\nListing prime numbers between 2 and %d:\n\n", lim - 1);
    for (i = 2; i < lim; i++)
        if (!primes[i])
            printf("%d\n", i);

    return 0;
} 
```

查找素数的 CPU 时间（在 Pentium Dual Core E2140 1.6 GHz 上，使用单核）

> ~ 4s for lim = 100,000,000

* * *

## 回答 #11

> 赞同：3
> 
> 时间：2009-09-07T18:52:12.030

这是我几天前在 PowerShell 中编写的 Eratosthenes 筛。它有一个参数，用于标识应返回的素数数量。

```
#
# generate a list of primes up to a specific target using a sieve of eratosthenes
#
function getPrimes { #sieve of eratosthenes, http://en.wikipedia.org/wiki/Sieve_of_Eratosthenes
    param ($target,$count = 0)
    $sieveBound = [math]::ceiling(( $target - 1 ) / 2) #not storing evens so count is lower than $target
    $sieve = @($false) * $sieveBound
    $crossLimit = [math]::ceiling(( [math]::sqrt($target) - 1 ) / 2)
    for ($i = 1; $i -le $crossLimit; $i ++) {
        if ($sieve[$i] -eq $false) {
            $prime = 2 * $i + 1
            write-debug "Found: $prime"
            for ($x = 2 * $i * ( $i + 1 ); $x -lt $sieveBound; $x += 2 * $i + 1) {
                $sieve[$x] = $true
            }
        }
    }
    $primes = @(2)
    for ($i = 1; $i -le $sieveBound; $i ++) {
        if($count -gt 0 -and $primes.length -ge $count) {
            break;
        }
        if($sieve[$i] -eq $false) {
            $prime = 2 * $i + 1
            write-debug "Output: $prime"
            $primes += $prime
        }
    }
    return $primes
} 
```

* * *

## 回答 #12

> 赞同：2
> 
> 时间：2009-02-16T05:17:44.037

改编自[GateKiller](https://stackoverflow.com/questions/622/most-efficient-code-for-the-first-10000-prime-numbers/2753#2753)并继续使用，这是我使用的最终版本。

```
 public IEnumerable<long> PrimeNumbers(long number)
    {
        List<long> primes = new List<long>();
        for (int i = 2; primes.Count < number; i++)
        {
            bool divisible = false;

            foreach (int num in primes)
            {
                if (i % num == 0)
                    divisible = true;

                if (num > Math.Sqrt(i))
                    break;
            }

            if (divisible == false)
                primes.Add(i);
        }
        return primes;
    } 
```

基本相同，但我添加了“Sqrt 中断”建议并更改了一些变量以使其更适合我。（我正在研究欧拉，需要第 10001 个素数）

* * *

## 回答 #13

> 赞同：2
> 
> 时间：2009-06-19T18:12:35.903

筛子似乎是错误的答案。筛子为您提供**最多为****N**的素数，而不是**前 N 个**素数。运行@Imran 或@Andrew Szeto，你得到的素数最多为 N。

如果您继续尝试筛子以获得越来越大的数字，直到您达到一定大小的结果集，并使用一些已经获得的数字缓存，筛子可能仍然可用，但我相信它仍然不会比像@Pat's 这样的解决方案快.

* * *

## 回答 #14

> 赞同：2
> 
> 时间：2010-02-22T07:45:46.507

在 Python 中

```
import gmpy
p=1
for i in range(10000):
    p=gmpy.next_prime(p)
    print p 
```

* * *

## 回答 #15

> 赞同：2
> 
> 时间：2016-04-19T17:07:28.123

[BenGoldberg 提到](https://stackoverflow.com/a/36668089/4156577)的双端队列筛算法值得仔细研究，不仅因为它非常优雅，还因为它在实践中偶尔有用（不像 Atkin 的筛子，这是一个纯粹的学术练习）。

双端队列筛算法背后的基本思想是使用一个小的滑动筛，它的大小仅足以包含每个当前“活动”素数因子的至少一个单独的倍数 - 即平方不超过最小数的素数目前以移动筛为代表。与 SoE 的另一个区别是双端队列筛将实际因子存储到复合的槽中，而不是布尔值。

该算法根据需要扩展筛子窗口的大小，从而在很宽的范围内实现相当均匀的性能，直到筛子开始明显超过 CPU 的 L1 高速缓存的容量。最后一个完全拟合的素数是 25,237,523（第 1,579,791 个素数），这为算法的合理操作范围提供了一个粗略的数字。

该算法相当简单和健壮，甚至比未分段的埃拉托色尼筛法在更广泛的范围内具有性能。后者要快得多，只要它的筛子完全适合缓存，即对于具有字节大小布尔值的仅赔率筛子，最多 2^16。然后它的性能越来越下降，尽管它总是比双端队列快得多，尽管有障碍（至少在 C/C++、Pascal 或 Java/C# 等编译语言中）。

这是 C# 中 deque sieve 算法的渲染，因为我发现这种语言 - 尽管有许多缺陷 - 对于原型算法和实验来说比极其繁琐和迂腐的 C++ 更实用。*（旁注：我正在使用免费的[LINQPad](https://www.linqpad.net/)，它可以让我直接投入其中，而无需设置项目、makefile、目录或诸如此类的所有混乱，并且它为我提供了与 python 提示相同程度的交互性）。*

C# 没有显式的双端队列类型，但纯`List<int>`文本足以很好地演示算法。

注意：这个版本没有对素数使用双端队列，因为从 n 个素数中弹出 sqrt(n) 根本没有意义。去掉 100 个素数并留下 9900 有什么好处？至少通过这种方式，所有素数都被收集在一个整洁的向量中，为进一步处理做好准备。

```
static List<int> deque_sieve (int n = 10000)
{
    Trace.Assert(n >= 3);

    var primes = new List<int>()  {  2, 3  };
    var sieve = new List<int>()  {  0, 0, 0  };

    for (int sieve_base = 5, current_prime_index = 1, current_prime_squared = 9; ; )
    {
        int base_factor = sieve[0];

        if (base_factor != 0)
        {
            // the sieve base has a non-trivial factor - put that factor back into circulation
            mark_next_unmarked_multiple(sieve, base_factor);
        }
        else if (sieve_base < current_prime_squared)  // no non-trivial factor -> found a non-composite
        {
            primes.Add(sieve_base);

            if (primes.Count == n)
                return primes;
        }
        else // sieve_base == current_prime_squared
        {
            // bring the current prime into circulation by injecting it into the sieve ...
            mark_next_unmarked_multiple(sieve, primes[current_prime_index]);

            // ... and elect a new current prime
            current_prime_squared = square(primes[++current_prime_index]);
        }

        // slide the sieve one step forward
        sieve.RemoveAt(0);  sieve_base += 2;
    }
} 
```

下面是两个辅助函数：

```
static void mark_next_unmarked_multiple (List<int> sieve, int prime)
{
    int i = prime, e = sieve.Count;

    while (i < e && sieve[i] != 0)
        i += prime;

    for ( ; e <= i; ++e)  // no List<>.Resize()...
        sieve.Add(0);

    sieve[i] = prime;
}

static int square (int n)
{
    return n * n;
} 
```

理解该算法的最简单方法可能是将其想象为一个特殊的分段埃拉托色尼筛，分段大小为 1，伴随着一个溢出区域，当素数射过分段末端时，它们会在该溢出区域停止。除了段的单个单元格（aka `sieve[0]`）在我们到达它时已经被筛选，因为它在溢出区域的一部分时被碾过。

由 表示的数字`sieve[0]`保存在 中`sieve_base`，尽管`sieve_front`or`window_base`也是一个好名字，可以与 Ben 的代码或分段/窗口筛的实现相比较。

如果`sieve[0]`包含一个非零值，则该值是 的一个因子`sieve_base`，因此可以被识别为复合的。由于单元 0 是该因子的倍数，因此很容易计算其下一跳，即 0 加上该因子。如果该单元格已经被另一个因子占据，那么我们只需再次添加该因子，依此类推，直到我们找到当前没有其他因子停放的因子的倍数（如果需要，扩展筛子）。这也意味着不需要像在正常的分段筛中那样存储从一个段到下一个段的各种素数的当前工作偏移量。每当我们在 中找到一个因子时`sieve[0]`，它的当前工作偏移量为 0。

当前的素数通过以下方式发挥作用。一个素数只有在它自己出现在流中后才能成为当前的（即当它被检测为素数时，因为没有用因子标记），并且它将保持当前状态，直到`sieve[0]`到达它的平方的确切时刻。由于较小的素数的活动，这个素数的所有较低倍数都必须被剔除，就像在正常的 SoE 中一样。但是没有一个较小的素数可以从正方形中删除，因为正方形的唯一因素是素数本身，并且此时它还没有流通。这解释了算法在这种情况下采取的行动`sieve_base == current_prime_squared`（顺便说一句，这意味着`sieve[0] == 0`）。

现在这种情况`sieve[0] == 0 && sieve_base < current_prime_squared`很容易解释：这意味着它`sieve_base`不能是任何小于当前素数的素数的倍数，否则它会被标记为合数。I 也不能是当前素数的更高倍数，因为它的值小于当前素数的平方。因此它必须是一个新的素数。

该算法显然受到埃拉托色尼筛法的启发，但同样明显的是，它非常不同。埃拉托色尼筛法的卓越速度源于其基本操作的简单性：一个单一的索引添加和一个操作的每个步骤的存储是它在很长一段时间内所做的一切。

这是一个简单的、未分段的 Eratosthenes 筛，我通常使用它来筛选 ushort 范围内的因子素数，即高达 2^16。对于这篇文章，我已通过替换将其修改为超过 2^ `int`16`ushort`

```
static List<int> small_odd_primes_up_to (int n)
{
    var result = new List<int>();

    if (n < 3)
        return result;

    int sqrt_n_halved = (int)(Math.Sqrt(n) - 1) >> 1, max_bit = (n - 1) >> 1;
    var odd_composite = new bool[max_bit + 1];

    for (int i = 3 >> 1; i <= sqrt_n_halved; ++i)
        if (!odd_composite[i])
            for (int p = (i << 1) + 1, j = p * p >> 1; j <= max_bit; j += p)
                odd_composite[j] = true;

    result.Add(3);  // needs to be handled separately because of the mod 3 wheel

    // read out the sieved primes
    for (int i = 5 >> 1, d = 1; i <= max_bit; i += d, d ^= 3)
        if (!odd_composite[i])
            result.Add((i << 1) + 1);

    return result;
} 
```

在筛选前 10000 个素数时，将超过 32 KiByte 的典型 L1 缓存，但该函数仍然非常快（即使在 C# 中也只有几分之一毫秒）。

如果将此代码与 deque sieve 进行比较，那么很容易看出 deque sieve 的操作要复杂得多，并且它无法有效地摊销其开销，因为它总是连续进行最短可能的交叉操作（在跳过所有已经被划掉的倍数之后，正好是一个划线）。

注意：C# 代码使用`int`而不是，`uint`因为较新的编译器习惯于为 生成不合标准的代码`uint`，可能是为了将人们推向有符号整数......在上面我使用的代码的 C++ 版本中`unsigned`，自然；基准必须在 C++ 中，因为我希望它基于所谓的足够的双端队列类型（`std::deque<unsigned>`；使用 没有性能提升`unsigned short`）。以下是我的 Haswell 笔记本电脑 (VC++ 2015/x64) 的编号：

```
deque vs simple: 1.802 ms vs 0.182 ms
deque vs simple: 1.836 ms vs 0.170 ms 
deque vs simple: 1.729 ms vs 0.173 ms 
```

注意：C# 时间几乎是 C++ 时间的两倍，这对 C# 来说非常好，并且表明`List<int>`即使被滥用为双端队列也不会懈怠。

简单的筛选代码仍然会将双端队列从水中吹走，即使它已经在其正常工作范围之外运行（L1 缓存大小超过 50%，伴随着缓存抖动）。这里的主要部分是筛选出的素数的读取，这不受缓存问题的影响很大。在任何情况下，该函数都是为筛选因素的因素而设计的，即 3 级筛选层次结构中的第 0 级，通常它只需要返回几百个因素或少量的数千个因素。因此它的简单性。

通过使用分段筛并优化用于提取已筛出的素数的代码（步进 mod 3 并展开两次，或 mod 15 并展开一次），性能可以提高一个数量级以上，并且可以挤出更多的性能代码通过使用带有所有装饰的 mod 16 或 mod 30 轮子（即所有残留物的完全展开）。类似的事情在我对代码审查中[查找素数定位素数](https://codereview.stackexchange.com/a/125057/56653)的回答中进行了解释，其中讨论了类似的问题。但是很难看出为一次性任务改进亚毫秒时间的意义......

为了让事情更深入一点，这里是筛选多达 100,000,000 个的 C++ 时间：

```
deque vs simple: 1895.521 ms vs 432.763 ms
deque vs simple: 1847.594 ms vs 429.766 ms
deque vs simple: 1859.462 ms vs 430.625 ms 
```

相比之下，C# 中带有一些花里胡哨的分段筛子在 95 毫秒内完成了相同的工作（没有可用的 C++ 计时，因为我目前只在 C# 中进行代码挑战）。

在像 Python 这样的解释型语言中，情况可能看起来完全不同，其中每个操作都有很高的成本，并且解释器开销使由于预测与错误预测的分支或子周期操作（移位、加法）与多周期操作（乘法）造成的所有差异相形见绌，甚至是除法）。这势必会削弱埃拉托色尼筛法的简单性优势，这可能会使双端队列解决方案更具吸引力。

此外，该主题中其他受访者报告的许多时间可能都以**输出时间**为主。那是一场完全不同的战争，我的主要武器是这样一个简单的类：

```
class CCWriter
{
    const int SPACE_RESERVE = 11;  // UInt31 + '\n'

    public static System.IO.Stream BaseStream;
    static byte[] m_buffer = new byte[1 << 16];  // need 55k..60k for a maximum-size range
    static int m_write_pos = 0;
    public static long BytesWritten = 0;         // for statistics

    internal static ushort[] m_double_digit_lookup = create_double_digit_lookup();

    internal static ushort[] create_double_digit_lookup ()
    {
        var lookup = new ushort[100];

        for (int lo = 0; lo < 10; ++lo)
            for (int hi = 0; hi < 10; ++hi)
                lookup[hi * 10 + lo] = (ushort)(0x3030 + (hi << 8) + lo);

        return lookup;
    }

    public static void Flush ()
    {
        if (BaseStream != null && m_write_pos > 0)
            BaseStream.Write(m_buffer, 0, m_write_pos);

        BytesWritten += m_write_pos;
        m_write_pos = 0;
    }

    public static void WriteLine ()
    {
        if (m_buffer.Length - m_write_pos < 1)
            Flush();

        m_buffer[m_write_pos++] = (byte)'\n';
    }

    public static void WriteLinesSorted (int[] values, int count)
    {
        int digits = 1, max_value = 9;

        for (int i = 0; i < count; ++i)
        {
            int x = values[i];

            if (m_buffer.Length - m_write_pos < SPACE_RESERVE)
                Flush();

            while (x > max_value)
                if (++digits < 10)
                    max_value = max_value * 10 + 9;
                else
                    max_value = int.MaxValue;               

            int n = x, p = m_write_pos + digits, e = p + 1;

            m_buffer[p] = (byte)'\n';

            while (n >= 10)
            {
                int q = n / 100, w = m_double_digit_lookup[n - q * 100];
                n = q;
                m_buffer[--p] = (byte)w;
                m_buffer[--p] = (byte)(w >> 8);
            }

            if (n != 0 || x == 0)
                m_buffer[--p] = (byte)((byte)'0' + n);

            m_write_pos = e;
        }
    }
} 
```

写入 10000 个（排序的）数字需要不到 1 毫秒的时间。它是一个静态类，因为它旨在将文本包含在编码挑战提交中，以最少的麻烦和零开销。

一般来说，我发现如果对整个批次进行集中工作会*更快*，这意味着筛选某个范围，然后将所有素数提取到一个向量/数组中，然后爆破整个数组，然后筛选下一个范围等等，而不是将所有东西混合在一起。具有专注于特定任务的单独功能还可以更容易地混合和匹配，它可以重用，并且可以简化开发/测试。

* * *

## 回答 #16

> 赞同：1
> 
> 时间：2011-03-11T02:25:23.013

这是我的 VB 2008 代码，它在我的工作笔记本电脑上在 1 分 27 秒内找到所有质数 <10,000,000。它会跳过偶数，只查找小于测试数 sqrt 的素数。它仅用于查找从 0 到标记值的素数。

```
Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles 
Button1.Click

    Dim TestNum As Integer
    Dim X As Integer
    Dim Z As Integer
    Dim TM As Single
    Dim TS As Single
    Dim TMS As Single
    Dim UnPrime As Boolean
    Dim Sentinal As Integer
    Button1.Text = "Thinking"
    Button1.Refresh()
    Sentinal = Val(SentinalTxt.Text)
    UnPrime = True
    Primes(0) = 2
    Primes(1) = 3
    Z = 1
    TM = TimeOfDay.Minute
    TS = TimeOfDay.Second
    TMS = TimeOfDay.Millisecond
    For TestNum = 5 To Sentinal Step 2
        Do While Primes(X) <> 0 And UnPrime And Primes(X) ^ 2 <= TestNum
            If Int(TestNum / Primes(X)) - (TestNum / Primes(X)) = 0 Then
                UnPrime = False
            End If
            X = X + 1

        Loop
        If UnPrime = True Then
            X = X + 1
            Z = Z + 1
            Primes(Z) = TestNum
        End If
        UnPrime = True
        X = 0
    Next
    Button1.Text = "Finished with " & Z
    TM = TimeOfDay.Minute - TM
    TS = TimeOfDay.Second - TS
    TMS = TimeOfDay.Millisecond - TMS
    ShowTime.Text = TM & ":" & TS & ":" & TMS
End Sub 
```

* * *

## 回答 #17

> 赞同：1
> 
> 时间：2014-03-02T01:15:02.170

以下 Mathcad 代码在 3 分钟内计算出前一百万个素数。

请记住，这将对所有数字使用浮点双精度，并且基本上可以解释。我希望语法清楚。

![在此处输入图像描述](../Images/abea9c76f58a96e945c2213f44830973.png)

* * *

## 回答 #18

> 赞同：1
> 
> 时间：2016-04-16T18:33:01.887

这是一个使用 SoE 形式的 C++ 解决方案：

```
#include <iostream>
#include <deque>

typedef std::deque<int> mydeque;

void my_insert( mydeque & factors, int factor ) {
    int where = factor, count = factors.size();
    while( where < count && factors[where] ) where += factor;
    if( where >= count ) factors.resize( where + 1 );
    factors[ where ] = factor;
}

int main() {
    mydeque primes;
    mydeque factors;
    int a_prime = 3, a_square_prime = 9, maybe_prime = 3;
    int cnt = 2;
    factors.resize(3);
    std::cout << "2 3 ";

    while( cnt < 10000 ) {
        int factor = factors.front();
        maybe_prime += 2;
        if( factor ) {
            my_insert( factors, factor );
        } else if( maybe_prime < a_square_prime ) {
            std::cout << maybe_prime << " ";
            primes.push_back( maybe_prime );
            ++cnt;
        } else {
            my_insert( factors, a_prime );
            a_prime = primes.front();
            primes.pop_front();
            a_square_prime = a_prime * a_prime;
        }
        factors.pop_front();
    }

    std::cout << std::endl;
    return 0;
} 
```

请注意，这个版本的 Sieve 可以无限地计算素数。

另请注意，STL通过下标执行、、和随机访问`deque`需要时间。`O(1)``push_back``pop_front`

该`resize`操作需要`O(n)`时间，其中`n`是要添加的元素的数量。由于我们使用此函数的方式，我们可以将其视为一个小常数。

`while`循环体in`my_insert`是执行`O(log log n)`次数，其中`n`等于变量`maybe_prime`。这是因为对于 的每个素因子， 的条件表达式`while`将计算为真一次`maybe_prime`。请参阅Wikipedia 上的“[除数函数”。](https://en.wikipedia.org/wiki/Divisor_function "除数函数")

乘以次数`my_insert`被称为，表明`O(n log log n)`列出素数应该花费时间`n`......这就是埃拉托色尼筛应该具有的时间复杂度，这并不奇怪。

然而，虽然这段代码**很**有效，但它并不是**最有效**的......我强烈建议使用专门的库来生成素数，例如[primesieve](http://primesieve.org/ "初筛")。任何真正高效、优化良好的解决方案都需要比任何人都想输入到 Stackoverflow 中的更多代码。

* * *

## 回答 #19

> 赞同：1
> 
> 时间：2016-05-12T03:40:03.553

使用埃拉托色尼筛法，与“已知范围”的素数算法相比，计算速度要快得多。

通过使用它的 wiki ( [https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes](https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes) ) 中的伪代码，我可以在 C# 上找到解决方案。

```
/// Get non-negative prime numbers until n using Sieve of Eratosthenes.
public int[] GetPrimes(int n) {
    if (n <= 1) {
        return new int[] { };
    }

    var mark = new bool[n];
    for(var i = 2; i < n; i++) {
        mark[i] = true;
    }

    for (var i = 2; i < Math.Sqrt(n); i++) {
        if (mark[i]) {
            for (var j = (i * i); j < n; j += i) {
                mark[j] = false;
            }
        }
    }

    var primes = new List<int>();
    for(var i = 3; i < n; i++) {
        if (mark[i]) {
            primes.Add(i);
        }
    }

    return primes.ToArray();
} 
```

GetPrimes(100000000) 需要 2 秒和 330 毫秒。

***注意****：值可能因硬件规格而异。*

* * *

## 回答 #20

> 赞同：1
> 
> 时间：2017-05-06T11:48:38.673

这是我的代码，它在我的笔记本电脑上在 0.049655 秒内找到前 10,000 个质数，在 6 秒内找到前 1,000,000 个质数，在 15 秒内找到前 2,000,000 个
一点解释。此方法使用 2 种技术来查找素数

1.  首先，任何非素数都是素数的倍数的组合，因此此代码通过将测试数除以较小的素数而不是任何数字来进行测试，这对于 4 位数字减少了至少 10 倍的计算，甚至更多更大的数字
2.  其次，除了除以素数之外，它只除以小于或等于被测试数的根的素数，这进一步减少了计算，这是因为任何大于该数的根的数都会有一个对应数必须小于数字的根，但是由于我们已经测试了所有小于根的数字，因此我们不需要为大于所测试数字的根的数字而烦恼。

前 10,000 个素数的示例输出
[https://drive.google.com/open?id=0B2QYXBiLI-lZMUpCNFhZeUphck0](https://drive.google.com/open?id=0B2QYXBiLI-lZMUpCNFhZeUphck0) [https://drive.google.com/open?id=0B2QYXBiLI-lZbmRtTkZETnp6Ykk](https://drive.google.com/open?id=0B2QYXBiLI-lZbmRtTkZETnp6Ykk)

这是 C 语言的代码，输入 1 然后输入 10,000 以打印出前 10,000 个素数。
编辑：我忘记了这个包含数学库，如果你在 Windows 或 Visual Studio 上应该没问题，但在 Linux 上你必须使用 -lm 参数编译代码，否则代码可能不起作用
示例：gcc -Wall -o "%e " "%f" -lm

```
#include <stdio.h>
#include <math.h>
#include <time.h>
#include <limits.h>

/* Finding prime numbers */
int main()
{   
    //pre-phase
    char d,w;
    int l,o;
    printf("  1\. Find first n number of prime numbers or Find all prime numbers smaller than n ?\n"); // this question helps in setting the limits on m or n value i.e l or o 
    printf("     Enter 1 or 2 to get anwser of first or second question\n");
    // decision making
    do
    {
        printf("  -->");
        scanf("%c",&d);
        while ((w=getchar()) != '\n' && w != EOF);
        if ( d == '1')
        {
            printf("\n  2\. Enter the target no. of primes you will like to find from 3 to 2,000,000 range\n  -->");
            scanf("%10d",&l);
            o=INT_MAX;
            printf("  Here we go!\n\n");
            break;
        }
        else if ( d == '2' )
        {
            printf("\n  2.Enter the limit under which to find prime numbers from 5 to 2,000,000 range\n  -->");
            scanf("%10d",&o);
            l=o/log(o)*1.25;
            printf("  Here we go!\n\n");
            break;
        }
        else printf("\n  Try again\n");
    }while ( d != '1' || d != '2' );

    clock_t start, end;
    double cpu_time_used;
    start = clock(); /* starting the clock for time keeping */

    // main program starts here
    int i,j,c,m,n; /* i ,j , c and m are all prime array 'p' variables and n is the number that is being tested */
    int s,x;

    int p[ l ]; /* p is the array for storing prime numbers and l sets the array size, l was initialized in pre-phase */
    p[1]=2;
    p[2]=3;
    p[3]=5;
    printf("%10dst:%10d\n%10dnd:%10d\n%10drd:%10d\n",1,p[1],2,p[2],3,p[3]); // first three prime are set
    for ( i=4;i<=l;++i ) /* this loop sets all the prime numbers greater than 5 in the p array to 0 */
        p[i]=0;

    n=6; /* prime number testing begins with number 6 but this can lowered if you wish but you must remember to update other variables too */
    s=sqrt(n); /* 's' does two things it stores the root value so that program does not have to calaculate it again and again and also it stores it in integer form instead of float*/
    x=2; /* 'x' is the biggest prime number that is smaller or equal to root of the number 'n' being tested */

    /* j ,x and c are related in this way, p[j] <= prime number x <= p[c] */

    // the main loop begins here
    for ( m=4,j=1,c=2; m<=l && n <= o;)
    /* this condition checks if all the first 'l' numbers of primes are found or n does not exceed the set limit o */
    {
            // this will divide n by prime number in p[j] and tries to rule out non-primes
            if ( n%p[j]==0 )
            {
                /* these steps execute if the number n is found to be non-prime */

                ++n; /* this increases n by 1 and therefore sets the next number 'n' to be tested */
                s=sqrt(n); /* this calaulates and stores in 's' the new root of number 'n' */
                if ( p[c] <= s && p[c] != x ) /* 'The Magic Setting' tests the next prime number candidate p[c] and if passed it updates the prime number x */
                {
                    x=p[c];
                    ++c;
                }
                j=1;
                /* these steps sets the next number n to be tested and finds the next prime number x if possible for the new number 'n' and also resets j to 1 for the new cycle */
                continue; /* and this restarts the loop for the new cycle */
            }
            // confirmation test for the prime number candidate n
            else if ( n%p[j]!=0 && p[j]==x )
            {
                /* these steps execute if the number is found to be prime */
                p[m]=n;
                printf("%10dth:%10d\n",m,p[m]);
                ++n;
                s = sqrt(n);
                ++m;
                j=1;
                /* these steps stores and prints the new prime number and moves the 'm' counter up and also sets the next number n to be tested and also resets j to 1 for the new cycle */
                continue; /* and this restarts the loop */
                /* the next number which will be a even and non-prime will trigger the magic setting in the next cycle and therfore we do not have to add another magic setting here*/
            }
            ++j; /* increases p[j] to next prime number in the array for the next cycle testing of the number 'n' */
            // if the cycle reaches this point that means the number 'n' was neither divisible by p[j] nor was it a prime number
            // and therfore it will test the same number 'n' again in the next cycle with a bigger prime number
    }
    // the loops ends
    printf("  All done !!\n");
    end = clock();
    cpu_time_used = ((double) (end - start)) / CLOCKS_PER_SEC;
    printf("  Time taken : %lf sec\n",cpu_time_used);
} 
```

* * *

## 回答 #21

> 赞同：0
> 
> 时间：2010-12-27T17:37:23.507

我用python写了这个，因为我刚开始学习它，它工作得很好。[此代码生成的第 10,000 个素数与http://primes.utm.edu/lists/small/10000.txt](http://primes.utm.edu/lists/small/10000.txt)中提到的相同。要检查是否`n`是素数，请除以`n`从`2`到的数字`sqrt(n)`。如果这个数字范围中的任何一个完全划分`n`，那么它就不是素数。

```
import math
print ("You want prime till which number??")
a = input()
a = int(a)
x = 0
x = int(x)
count = 1
print("2 is prime number")
for c in range(3,a+1):
    b = math.sqrt(c)
    b = int(b)
    x = 0
    for b in range(2,b+1):
        e  = c % b
        e = int(e)
        if (e == 0):
            x = x+1
    if (x == 0):
        print("%d is prime number" % c)
        count = count + 1
print("Total number of prime till %d is %d" % (a,count)) 
```

* * *

## 回答 #22

> 赞同：0
> 
> 时间：2012-04-23T19:46:21.880

我花了一些时间编写一个计算大量素数的程序，这是我用来计算包含前 1.000.000.000 个素数的文本文件的代码。它是德语的，但有趣的部分是方法`calcPrimes()`。素数存储在名为 Primzahlen 的数组中。我推荐使用 64 位 CPU，因为计算是使用 64 位整数。

```
import java.io.*;
class Primzahlengenerator {
    long[] Primzahlen;
    int LastUnknown = 2;
    public static void main(String[] args)  {
        Primzahlengenerator Generator = new Primzahlengenerator();
        switch(args.length) {
            case 0:  //Wenn keine Argumente übergeben worden:
                Generator.printHelp(); //Hilfe ausgeben
                return; //Durchfallen verhindern
            case 1:
                try {
                    Generator.Primzahlen = new long[Integer.decode(args[0]).intValue()];
                }
                catch (NumberFormatException e) {
                    System.out.println("Das erste Argument muss eine Zahl sein, und nicht als Wort z.B. \"Tausend\", sondern in Ziffern z.B. \"1000\" ausgedrückt werden.");//Hinweis, wie man die Argumente angeben muss ausgeben
                    Generator.printHelp();                    //Generelle Hilfe ausgeben
                    return;
                }
                break;//dutchfallen verhindern

            case 2:
                switch (args[1]) {
                    case "-l":
                        System.out.println("Sie müsen auch eine Datei angeben!"); //Hilfemitteilung ausgeben
                        Generator.printHelp();                                    //Generelle Hilfe ausgeben
                        return;
                }
                break;//durchfallen verhindern
            case 3:
                try {
                    Generator.Primzahlen = new long[Integer.decode(args[0]).intValue()];
                }
                catch (NumberFormatException e) {
                    System.out.println("Das erste Argument muss eine Zahl sein, und nicht als Wort z.B. \"Tausend\", sondern in Ziffern z.B. \"1000\" ausgedrückt werden.");//Hinweis, wie man die Argumente angeben muss ausgeben
                    Generator.printHelp();                      //Generelle Hilfe ausgeben
                    return;
                }
                switch(args[1]) {
                    case "-l":
                        Generator.loadFromFile(args[2]);//Datei Namens des Inhalts von Argument 3 lesen, falls Argument 2 = "-l" ist
                        break;
                    default:
                        Generator.printHelp();
                        break;
                }
                break;
            default:
                Generator.printHelp();
                return;
        }
        Generator.calcPrims();
    }
    void printHelp() {
        System.out.println("Sie müssen als erstes Argument angeben, die wieviel ersten Primzahlen sie berechnen wollen.");   //Anleitung wie man das Programm mit Argumenten füttern muss
        System.out.println("Als zweites Argument können sie \"-l\" wählen, worauf die Datei, aus der die Primzahlen geladen werden sollen,");
        System.out.println("folgen muss. Sie muss genauso aufgebaut sein, wie eine Datei Primzahlen.txt, die durch den Aufruf \"java Primzahlengenerator 1000 > Primzahlen.txt\" entsteht.");
    }
    void loadFromFile(String File) {
        // System.out.println("Lese Datei namens: \"" + File + "\"");
        try{
            int x = 0;
            BufferedReader in = new BufferedReader(new FileReader(File));
            String line;
            while((line = in.readLine()) != null) {
                Primzahlen[x] = new Long(line).longValue();
                x++;
            }
            LastUnknown = x;
        } catch(FileNotFoundException ex) {
            System.out.println("Die angegebene Datei existiert nicht. Bitte geben sie eine existierende Datei an.");
        } catch(IOException ex) {
            System.err.println(ex);
        } catch(ArrayIndexOutOfBoundsException ex) {
            System.out.println("Die Datei enthält mehr Primzahlen als der reservierte Speicherbereich aufnehmen kann. Bitte geben sie als erstes Argument eine größere Zahl an,");
            System.out.println("damit alle in der Datei enthaltenen Primzahlen aufgenommen werden können.");
            }
        /* for(long prim : Primzahlen) {
            System.out.println("" + prim);
        } */
        //Hier soll code stehen, der von der Datei mit angegebenem Namen ( Wie diese aussieht einfach durch angeben von folgendem in cmd rausfinden:
        //java Primzahlengenerator 1000 > 1000Primzahlen.txt
        //da kommt ne textdatei, die die primzahlen enthält. mit Long.decode(String ziffern).longValue();
        //erhält man das was an der entsprechenden stelle in das array soll. die erste zeile soll in [0] , die zweite zeile in [1] und so weiter.
        //falls im arry der platz aus geht(die exception kenn ich grad nich, aber mach mal:
        //int[] foo = { 1, 2, 3};
        //int bar = foo[4];
        //dann kriegst ne exception, das ist die gleiche die man kriegt, wenn im arry der platzt aus geht.
    }
    void calcPrims() {
        int PrimzahlNummer = LastUnknown;
        // System.out.println("LAstUnknown ist: " + LastUnknown);
        Primzahlen[0] = 2;
        Primzahlen[1] = 3;
        long AktuelleZahl = Primzahlen[PrimzahlNummer - 1];
        boolean IstPrimzahl;
        // System.out.println("2");
        // System.out.println("3");
        int Limit = Primzahlen.length;
        while(PrimzahlNummer < Limit) {
            IstPrimzahl = true;
            double WurzelDerAktuellenZahl = java.lang.Math.sqrt(AktuelleZahl);
            for(int i = 1;i < PrimzahlNummer;i++) {
                if(AktuelleZahl % Primzahlen[i] == 0) {
                    IstPrimzahl = false;
                    break;
                }
                if(Primzahlen[i] > WurzelDerAktuellenZahl) break;
            }
            if(IstPrimzahl) {
                Primzahlen[PrimzahlNummer] = AktuelleZahl;
                PrimzahlNummer++;
                // System.out.println("" + AktuelleZahl);
            }
            AktuelleZahl = AktuelleZahl + 2;
        }
        for(long prim : Primzahlen) {
            System.out.println("" + prim);
        }
    }
} 
```

* * *

## 回答 #23

> 赞同：0
> 
> 时间：2016-08-14T00:20:37.247

我一直致力于寻找素数大约一年。这是我发现最快的：

```
import static java.lang.Math.sqrt;
import java.io.PrintWriter;
import java.io.File;
public class finder {
    public static void main(String[] args) {
        primelist primes = new primelist();
        primes.insert(3);
        primes.insert(5);
        File file = new File("C:/Users/Richard/Desktop/directory/file0024.txt");
        file.getParentFile().mkdirs();
        long time = System.nanoTime();
        try{
            PrintWriter printWriter = new PrintWriter ("file0024.txt"); 
            int linenum = 0;
            printWriter.print("2");
            printWriter.print (" , ");
            printWriter.print("3");
            printWriter.print (" , ");
            int up;
            int down;           
            for(int i =1; i<357913941;i++){//
                if(linenum%10000==0){
                    printWriter.println ("");
                    linenum++;
                }
                down = i*6-1;
                if(primes.check(down)){
                    primes.insert(down);
                    //System.out.println(i*6-1);
                    printWriter.print ( down );
                    printWriter.print (" , ");
                    linenum++;  
                }
                up = i*6+1;
                if(primes.check(up)){
                    primes.insert(up);
                    //System.out.println(i*6+1);
                    printWriter.print ( up );
                    printWriter.print (" , ");
                    linenum++;  
                }
            }
            printWriter.println ("Time to execute");
            printWriter.println (System.nanoTime()-time);
            //System.out.println(primes.length);
            printWriter.close ();
        }catch(Exception e){}
    } 
}
class node{
    node next;
    int x;
    public node (){
        node next;
        x = 3;
    }
    public node(int z) {
        node next;
        x = z;
    }
}
class primelist{
    node first;
    int length =0;
    node current;
    public void insert(int x){
        node y = new node(x);
        if(current == null){
            current = y;
            first = y;
        }else{
            current.next = y;
            current = y;
        }
        length++;
    }
    public boolean check(int x){
        int p = (int)sqrt(x);
        node y = first;
        for(int i = 0;i<length;i++){
            if(y.x>p){
                return true;
            }else if(x%y.x ==0){
                return false;
            }
            y = y.next;
        }
        return true;
    }
} 
```

1902465190909 纳秒从 2 开始到达 2147483629。

* * *

## 回答 #24

> 赞同：0
> 
> 时间：2018-01-20T15:50:48.837

这是我制作的代码：

* * *

```
enter code here
#include <cmath>
#include <cstdio>
#include <vector>
#include <iostream>
#include <algorithm>
using namespace std;

int main() {
/* Enter your code here. Read input from STDIN. Print output to STDOUT*/   

unsigned long int n;

int prime(unsigned long int);

scanf("%ld",&n);

unsigned long int val;

for(unsigned long int i=0;i<n;i++)
{
    int flag=0;

    scanf("%ld",&val);

    flag=prime(val);

    if(flag==1)
        printf("yes\n");

    else
        printf("no\n");
}

return 0;

}

int prime(unsigned long int n)
{

if(n==2) return 1;

else if (n == 1||n%2==0)  return 0;

for (unsigned long int i=3; i<=sqrt(n); i+=2)
    if (n%i == 0)
        return 0;

return 1;
} 
```

* * *

## 回答 #25

> 赞同：0
> 
> 时间：2018-06-09T21:49:48.420

在 Javascript 中使用 Array.prototype.find() 方法。2214.486 毫秒

```
function isPrime (number) {

  function prime(element) {
    let start = 2;
    while (start <= Math.sqrt(element)) {
      if (element % start++ < 1) {
        return false;
      }
    }
    return element > 1;
  }

  return [number].find(prime)

}

function logPrimes (n) {

  let count = 0
  let nth = n

  let i = 0
  while (count < nth) {
    if (isPrime(i)) {
      count++
      console.log('i', i) //NOTE: If this line is ommited time to find 10,000th prime is 121.157ms
      if (count === nth) {
        console.log('while i', i)
        console.log('count', count)
      }
    }
    i++
  }

}

console.time(logPrimes)

logPrimes(10000)

console.timeEnd(logPrimes) // 2214.486ms 
```

* * *

## 回答 #26

> 赞同：0
> 
> 时间：2018-07-29T19:25:08.200

我可以给你一些提示，你必须执行它。

1.  对于每个数字，得到该数字的一半。例如，对于检查 21，仅通过将其从范围 2-10 中除来获得余数。
2.  如果是奇数，只除以奇数，反之亦然。如 21，只除以 3、5、7、9。

到目前为止我最有效的方法。

* * *

## 回答 #27

> 赞同：0
> 
> 时间：2018-11-16T05:34:35.510

由于您只想要前 10000 个素数，而不是编写复杂的算法，我将建议以下

```
boolean isPrime(int n){
//even but is prime
    if(n==2)
        return true;
//even numbers filtered already 
    if(n==0 || n==1 || n%2==0)
        return false;

// loop for checking only odd factors
// i*i <= n  (same as i<=sqrt(n), avoiding floating point calculations)
    for(int i=3 ; i*i <=n ; i+=2){
    // if any odd factor divides n then its not a prime!
        if(n%i==0)
            return false;
    }
// its prime now
    return true;
} 
```

现在呼叫是您需要的首要任务

```
for(int i=1 ; i<=1000 ; i++){
    if(isPrime(i)){
       //do something
    }
} 
```

* * *

## 回答 #28

> 赞同：0
> 
> 时间：2019-11-13T02:49:48.077

这是一个老问题，但这里每个人都缺少一些东西......

对于这么小的素数，试除法并没有*那么*慢……只有 25 个低于 100 的素数。要测试的素数这么少，而且这么小的素数，我们可以拿出一个巧妙的把戏！

如果 a 与 b 互质，则 gcd ab = 1。互质。有趣的词。意味着它不共享*任何主要因素*。因此，我们可以通过一次 GCD 调用来测试多个素数的可分性。多少？嗯，前 15 个素数的乘积小于 2^64。并且接下来10的乘积也小于2^64。这就是我们需要的全部 25 个。但是这值得吗？

让我们来看看：

```
check x = null $ filter ((==0) . (x `mod`)) $ [<primes up to 101>]
Prelude> length $ filter check [101,103..85600]
>>> 9975
(0.30 secs, 125,865,152 bytes

a = 16294579238595022365 :: Word64
b = 14290787196698157718
pre = [2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97]
primes = (pre ++) $ filter ((==1) . gcd a) $ filter ((==1) . gcd b) [99,101..85600]
main = print $ length primes

Prelude> main
>>> 10000
(0.05 secs, 36,387,520 bytes) 
```

那里提高了 6 倍。

（`length`是强制计算列表。默认情况下，Haskell 一次打印 1 个 Unicode 字符，因此实际*打印*列表将支配时间或支配实际使用的代码量。）

当然，这是在 GHCi 中运行的——一个运行解释代码的 repl——在旧笔记本电脑上，它不会将这些数字中的任何一个解释为`int64`s 甚至`BigInt`s，即使你要求它也不会（好吧，你*可以*强制它，但它很丑陋，并没有真正的帮助）。它将那里的每个数字解释为可以通过字典查找专门针对某些特定类型的通用*整数类*事物，并且它正在遍历链表（由于未编译，此处未融合）3次。有趣的是，手动融合两个过滤器实际上会减慢 REPL 中的速度。

让我们编译它：

```
...\Haskell\8.6\Testbed>Primes.exe +RTS -s
10000
606,280 bytes allocated in the heap
Total   time    0.000s  (  0.004s elapsed) 
```

使用 RTS 报告，因为 Windows。一些行被修剪是因为它们不相关——它们是其他 GC 数据，或者只是部分执行的测量值，加起来等于 0.004 秒（或更少）。它也不是不断折叠，因为 Haskell 实际上并没有做太多。如果我们不断地折叠自己（`main = print 10000`），我们会得到显着降低的分配：

```
...Haskell\8.6\Testbed>Primes.exe +RTS -s
10000
47,688 bytes allocated in the heap
Total   time    0.000s  (  0.001s elapsed) 
```

从字面上看，足以加载运行时，然后发现除了打印一个数字并退出之外别无他法。让我们添加车轮分解：

```
wheel = scanl (+) 7 $ cycle [4, 2, 4, 2, 4, 6, 2, 6]
primes = (pre ++) $ filter ((==1) . gcd a) $ filter ((==1) . gcd b) $ takeWhile (<85600) wheel

Total   time    0.000s  (  0.003s elapsed) 
```

相对于我们的参考减少了大约 1/3 `main = print 10000`，但肯定还有更多优化的空间。例如，它实际上停止在那里执行 GC，而通过调整不应该有任何堆使用。出于某种原因，在此处进行分析编译实际上将运行时间缩短到 2 毫秒：

```
Tue Nov 12 21:13 2019 Time and Allocation Profiling Report  (Final)

   Primes.exe +RTS -p -RTS

total time  =        0.00 secs   (2 ticks @ 1000 us, 1 processor)
total alloc =     967,120 bytes  (excludes profiling overheads) 
```

我现在将保持原样，我很确定随机抖动开始占主导地位。

* * *

## 回答 #29

> 赞同：0
> 
> 时间：2020-05-16T03:52:19.613

```
def compute_primes(bound):
"""
Return a list of the prime numbers in range(2, bound)
Implement the Sieve of Eratosthenes
https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes
"""
primeNumber = [True for i in range(bound + 1)]
start_prime_number = 2
primes = []
while start_prime_number * start_prime_number <=bound:
    # If primeNumber[start_prime_number] is not changed, then it is a prime
    if primeNumber[start_prime_number]:
        # Update all multiples of start_prime_number
        for i in range(start_prime_number * start_prime_number, bound + 1, start_prime_number):
            primeNumber[i] = False
    start_prime_number += 1

# Print all prime numbers
for start_prime_number in range(2, bound + 1):
    if primeNumber[start_prime_number]:
        primes.append(start_prime_number)

return primes 
```

打印(len(compute_primes(200)))

打印（len（compute_primes（2000）））

* * *

## 回答 #30

> 赞同：-1
> 
> 时间：2012-05-08T04:15:08.367

```
using System;

namespace ConsoleApplication2
{
    class Program
    {
        static void Main(string[] args)
        {
            int n, i = 3, j, c;
            Console.WriteLine("Please enter your integer: ");
            n = Convert.ToInt32(Console.ReadLine());
            if (n >= 1)
            {
                Console.WriteLine("First " + n + " Prime Numbers are");
                Console.WriteLine("2");
            }
            for(j=2;j<=n;)
            {
                for(c=2;c<=i-1;c++)
                {
                    if(i%c==0)
                        break;
                }
                    if(c==i)
                    {
                        Console.WriteLine(i);
                        j++;
                    }
                    i++;                                
            }
            Console.Read();
        }
    }
} 
```

# ruby - 何时使用 lambda，何时使用 Proc.new？

> ID：626
> 
> 赞同：342
> 
> 时间：2008-08-03T06:40:54.120
> 
> 标签：ruby, lambda, proc

在 Ruby 1.8 中，一方面 proc/lambda 之间存在细微差别，另一方面`Proc.new`。

*   这些区别是什么？
*   你能就如何决定选择哪一个提供指导吗？
*   在 Ruby 1.9 中，proc 和 lambda 是不同的。这是怎么回事？

* * *

## 回答 #1

> 赞同：380
> 
> 时间：2008-08-03T15:21:52.760

`lambda`procs created with和 procs created with之间另一个重要但微妙的区别`Proc.new`是它们如何处理`return`语句：

*   在`lambda`-created proc 中，`return`语句仅从 proc 本身返回
*   在`Proc.new`-created proc 中，该`return`语句更令人惊讶：它不仅从 proc 中返回控制权，**而且还从包含 proc 的方法中返回控制！**

这是`lambda`-created proc 的`return`实际操作。它以您可能期望的方式运行：

```
def whowouldwin

  mylambda = lambda {return "Freddy"}
  mylambda.call

  # mylambda gets called and returns "Freddy", and execution
  # continues on the next line

  return "Jason"

end

whowouldwin
#=> "Jason" 
```

现在这是一个`Proc.new`-created proc`return`做同样的事情。您即将看到 Ruby 打破了广受赞誉的“最小惊喜原则”的案例之一：

```
def whowouldwin2

  myproc = Proc.new {return "Freddy"}
  myproc.call

  # myproc gets called and returns "Freddy", 
  # but also returns control from whowhouldwin2!
  # The line below *never* gets executed.

  return "Jason"

end

whowouldwin2         
#=> "Freddy" 
```

由于这种令人惊讶的行为（以及更少的打字），我倾向于在制作 procs 时使用`lambda`over 。`Proc.new`

* * *

## 回答 #2

> 赞同：95
> 
> 时间：2009-10-04T05:23:22.903

为了提供进一步的说明：

Joey 说 的返回行为`Proc.new`令人惊讶。但是，当您认为 Proc.new 的行为类似于块时，这并不奇怪，因为这正是块的行为方式。另一方面，lambas 的行为更像方法。

这实际上解释了为什么 Procs 在涉及到 arity（参数数量）时是灵活的，而 lambdas 则不是。块不需要提供所有参数，但方法需要提供（除非提供默认值）。虽然提供 lambda 参数 default 在 Ruby 1.8 中不是一个选项，但现在在 Ruby 1.9 中支持使用替代 lambda 语法（如 webmat 所述）：

```
concat = ->(a, b=2){ "#{a}#{b}" }
concat.call(4,5) # => "45"
concat.call(1)   # => "12" 
```

并且 Michiel de Mare（OP）对于 Procs 和 lambda 在 Ruby 1.9 中的行为与 arity 相同是不正确的。我已经验证他们仍然保持上面指定的 1.8 的行为。

`break`语句在 Procs 或 lambdas 中实际上没有多大意义。在 Procs 中，break 会从已经完成的 Proc.new 中返回。而且从 lambda 中中断是没有任何意义的，因为它本质上是一种方法，而且你永远不会从方法的顶层中断。

`next`, `redo`, 并且`raise`在 Procs 和 lambdas 中的行为相同。而`retry`两者都不允许，并且会引发异常。

最后，`proc`永远不要使用该方法，因为它不一致并且具有意外行为。在 Ruby 1.8 中，它实际上返回了一个 lambda！在 Ruby 1.9 中，这已得到修复，它返回一个 Proc。如果要创建 Proc，请坚持使用`Proc.new`.

有关更多信息，我强烈推荐 O'Reilly 的*The Ruby Programming Language*，这是我获取大部分信息的来源。

* * *

## 回答 #3

> 赞同：42
> 
> 时间：2008-08-03T07:28:54.070

我发现[这个页面](http://raulparolari.com/Ruby2/lambda_Proc)`Proc.new`显示了和之间的区别`lambda`。根据该页面，唯一的区别是 lambda 严格限制它接受的参数数量，而`Proc.new`将缺少的参数转换为`nil`. 这是一个示例 IRB 会话，说明了差异：

```
irb(main):001:0> l = lambda { |x, y| x + y }
=> #<过程：0x00007fc605ec0748@(irb):1>
irb(main):002:0> p = Proc.new { |x, y| x + y }
=> #<过程：0x00007fc605ea8698@(irb):2>
irb(main):003:0> l.call "hello", "world"
=>“你好世界”
irb(main):004:0> p.call "hello", "world"
=>“你好世界”
irb(main):005:0> l.call“你好”
ArgumentError：参数数量错误（1 对 2）
    来自 (irb):1
    来自 (irb):5:in `call'
    来自 (irb):5
    从 :0
irb(main):006:0> p.call“你好”
TypeError：无法将 nil 转换为字符串
    来自 (irb):2:in `+'
    来自 (irb):2
    来自 (irb):6:in `call'
    来自 (irb):6
    从 :0
```

该页面还建议使用 lambda，除非您特别想要容错行为。我同意这种观点。使用 lambda 似乎更简洁一些，而且差异如此之小，在一般情况下似乎是更好的选择。

至于 Ruby 1.9，对不起，我还没有研究 1.9，但我不认为他们会改变它（不过不要相信我的话，你似乎听说过一些改变，所以我可能在那里错了）。

* * *

## 回答 #4

> 赞同：15
> 
> 时间：2008-09-10T23:32:34.683

Proc 比较老，但是 return 的语义对我来说是非常违反直觉的（至少在我学习语言时），因为：

1.  如果您使用的是 proc，那么您很可能会使用某种功能范式。
2.  Proc 可以返回封闭范围之外（请参阅先前的响应），这基本上是一个 goto，并且本质上是高度非功能性的。

Lambda 在功能上更安全，更容易推理——我总是使用它而不是 proc。

* * *

## 回答 #5

> 赞同：11
> 
> 时间：2008-11-19T21:28:28.783

我不能说太多的细微差别。但是，我可以指出，Ruby 1.9 现在允许 lambda 和块的可选参数。

这是 1.9 下 stabby lambda 的新语法：

```
stabby = ->(msg='inside the stabby lambda') { puts msg } 
```

Ruby 1.8 没有这种语法。声明块/lambdas 的传统方式也不支持可选参数：

```
# under 1.8
l = lambda { |msg = 'inside the stabby lambda'|  puts msg }
SyntaxError: compile error
(irb):1: syntax error, unexpected '=', expecting tCOLON2 or '[' or '.'
l = lambda { |msg = 'inside the stabby lambda'|  puts msg } 
```

然而，Ruby 1.9 即使使用旧语法也支持可选参数：

```
l = lambda { |msg = 'inside the regular lambda'|  puts msg }
#=> #<Proc:0x0e5dbc@(irb):1 (lambda)>
l.call
#=> inside the regular lambda
l.call('jeez')
#=> jeez 
```

如果你想为 Leopard 或 Linux 构建 Ruby1.9，请查看[这篇文章](http://programblings.com/2008/11/18/installing-ruby-19preview1-on-os-x-leopard/)（无耻的自我宣传）。

* * *

## 回答 #6

> 赞同：11
> 
> 时间：2008-12-09T14:17:51.017

看到它的一个好方法是 lambdas 在它们自己的范围内执行（好像它是一个方法调用），而 Procs 可以被视为与调用方法内联执行，至少这是决定使用哪一个的好方法在每种情况下。

* * *

## 回答 #7

> 赞同：11
> 
> 时间：2011-10-06T18:33:20.840

简短的回答：重要的是做什么`return`：lambda 从自身返回，proc 从自身和调用它的函数返回。

不太清楚的是为什么要使用每个。lambda 是我们期望在函数式编程意义上应该做的事情。它基本上是一个自动绑定当前范围的匿名方法。在这两者中，lambda 是您可能应该使用的。

另一方面，Proc 对于实现语言本身非常有用。例如，您可以使用它们实现“if”语句或“for”循环。在 proc 中找到的任何返回都将从调用它的方法中返回，而不仅仅是“if”语句。这就是语言的工作方式，“if”语句的工作方式，所以我的猜测是 Ruby 在幕后使用它，他们只是将它暴露出来，因为它看起来很强大。

只有在创建新的语言结构（如循环、if-else 结构等）时才真正需要它。

* * *

## 回答 #8

> 赞同：7
> 
> 时间：2009-06-25T11:22:32.633

我没有注意到对问题中的第三种方法“proc”的任何评论，它已被弃用，但在 1.8 和 1.9 中处理方式不同。

这是一个相当冗长的示例，可以很容易地看到三个类似调用之间的差异：

```
def meth1
  puts "method start"

  pr = lambda { return }
  pr.call

  puts "method end"  
end

def meth2
  puts "method start"

  pr = Proc.new { return }
  pr.call

  puts "method end"  
end

def meth3
  puts "method start"

  pr = proc { return }
  pr.call

  puts "method end"  
end

puts "Using lambda"
meth1
puts "--------"
puts "using Proc.new"
meth2
puts "--------"
puts "using proc"
meth3 
```

* * *

## 回答 #9

> 赞同：6
> 
> 时间：2008-08-28T13:50:12.320

[Ruby 中的闭包](https://innig.net/software/ruby/closures-in-ruby.html)很好地概述了块、lambda 和 proc 如何在 Ruby 中使用 Ruby 工作。

* * *

## 回答 #10

> 赞同：5
> 
> 时间：2014-10-29T16:22:59.553

lambda 按预期工作，就像在其他语言中一样。

有线`Proc.new`令人惊讶和困惑。

`return`由 proc 创建的语句`Proc.new`不仅会从自身返回控制权，*还会从包含它的方法*返回控制权。

```
def some_method
  myproc = Proc.new {return "End."}
  myproc.call

  # Any code below will not get executed!
  # ...
end 
```

您可以争辩说`Proc.new`将代码插入到封闭的方法中，就像块一样。但是`Proc.new`创建一个对象，而块是对象的*一部分*。

lambda 和 之间还有另一个区别`Proc.new`，那就是它们对（错误）参数的处理。lambda 抱怨它，而`Proc.new`忽略额外的参数或将缺少参数视为 nil。

```
irb(main):021:0> l = -> (x) { x.to_s }
=> #<Proc:0x8b63750@(irb):21 (lambda)>
irb(main):022:0> p = Proc.new { |x| x.to_s}
=> #<Proc:0x8b59494@(irb):22>
irb(main):025:0> l.call
ArgumentError: wrong number of arguments (0 for 1)
        from (irb):21:in `block in irb_binding'
        from (irb):25:in `call'
        from (irb):25
        from /usr/bin/irb:11:in `<main>'
irb(main):026:0> p.call
=> ""
irb(main):049:0> l.call 1, 2
ArgumentError: wrong number of arguments (2 for 1)
        from (irb):47:in `block in irb_binding'
        from (irb):49:in `call'
        from (irb):49
        from /usr/bin/irb:11:in `<main>'
irb(main):050:0> p.call 1, 2
=> "1" 
```

顺便说一句，`proc`在 Ruby 1.8 中创建了一个 lambda，而在 Ruby 1.9+ 中的行为类似于`Proc.new`，这确实令人困惑。

* * *

## 回答 #11

> 赞同：3
> 
> 时间：2008-09-07T02:31:40.607

详细说明 Accordion Guy 的回应：

请注意，`Proc.new`通过传递一个块来创建一个过程。我相信这`lambda {...}`被解析为一种文字，而不是传递一个块的方法调用。 `return`从附加到方法调用的块内部进行的 ing 将从方法返回，而不是从块返回，这个`Proc.new`案例就是一个例子。

（这是 1.8。我不知道如何转换为 1.9。）

* * *

## 回答 #12

> 赞同：3
> 
> 时间：2015-04-28T13:15:25.247

`Proc.new`我对此有点晚了，但是评论中根本没有提到一件很棒但鲜为人知的事情。根据[文档](http://ruby-doc.org/core-2.2.1/Proc.html#method-c-new)：

> `Proc::new`只能在带有附加块的方法中调用不带块的方法，在这种情况下，该**块将转换为`Proc`**对象。

也就是说，`Proc.new`让我们链接产生方法：

```
def m1
  yield 'Finally!' if block_given?
end

def m2
  m1 &Proc.new
end

m2 { |e| puts e } 
#⇒ Finally! 
```

* * *

## 回答 #13

> 赞同：3
> 
> 时间：2018-11-15T10:00:54.907

值得强调的是，`return`在proc 中返回的是词法封闭*的方法，即创建proc*的方法，**而不是**调用proc 的方法。这是 procs 的闭包属性的结果。所以下面的代码什么也不输出：

```
def foo
  proc = Proc.new{return}
  foobar(proc)
  puts 'foo'
end

def foobar(proc)
  proc.call
  puts 'foobar'
end

foo 
```

虽然 proc 在 in 中执行`foobar`，但它是在 in 中创建的`foo`，因此`return`退出`foo`，而不仅仅是`foobar`. 正如查尔斯考德威尔在上面写的那样，它有一种 GOTO 的感觉。在我看来，`return`在其词法上下文中执行的块中很好，但在在不同上下文中执行的 proc 中使用时就不那么直观了。

* * *

## 回答 #14

> 赞同：1
> 
> 时间：2008-08-11T02:09:46.683

行为上的差异`return`是恕我直言，两者之间最重要的差异。我也更喜欢 lambda，因为它比 Proc.new 打字少:-)

# sql - 交换数据库中的唯一索引列值

> ID：644
> 
> 赞同：68
> 
> 时间：2008-08-03T09:55:26.257
> 
> 标签：sql, database

我有一个数据库表，其中一个字段（不是主键）上有一个唯一索引。现在我想将此列下的值交换为两行。怎么可能做到这一点？我知道的两个黑客是：

1.  删除这两行并重新插入它们。
2.  使用其他值更新行并交换，然后更新为实际值。

但我不想选择这些，因为它们似乎不是解决问题的合适方法。谁能帮帮我？

* * *

## 回答 #1

> 赞同：37
> 
> 时间：2012-09-15T12:38:09.643

神奇的词在这里是**DEFERRABLE**：

```
DROP TABLE ztable CASCADE;
CREATE TABLE ztable
    ( id integer NOT NULL PRIMARY KEY
    , payload varchar
    );
INSERT INTO ztable(id,payload) VALUES (1,'one' ), (2,'two' ), (3,'three' );
SELECT * FROM ztable;

    -- This works, because there is no constraint
UPDATE ztable t1
SET payload=t2.payload
FROM ztable t2
WHERE t1.id IN (2,3)
AND t2.id IN (2,3)
AND t1.id <> t2.id
    ;
SELECT * FROM ztable;

ALTER TABLE ztable ADD CONSTRAINT OMG_WTF UNIQUE (payload)
    DEFERRABLE INITIALLY DEFERRED
    ;

    -- This should also work, because the constraint 
    -- is deferred until "commit time"
UPDATE ztable t1
SET payload=t2.payload
FROM ztable t2
WHERE t1.id IN (2,3)
AND t2.id IN (2,3)
AND t1.id <> t2.id
    ;
SELECT * FROM ztable; 
```

结果：

```
DROP TABLE
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "ztable_pkey" for table "ztable"
CREATE TABLE
INSERT 0 3
 id | payload
----+---------
  1 | one
  2 | two
  3 | three
(3 rows)

UPDATE 2
 id | payload
----+---------
  1 | one
  2 | three
  3 | two
(3 rows)

NOTICE:  ALTER TABLE / ADD UNIQUE will create implicit index "omg_wtf" for table "ztable"
ALTER TABLE
UPDATE 2
 id | payload
----+---------
  1 | one
  2 | two
  3 | three
(3 rows) 
```

* * *

## 回答 #2

> 赞同：15
> 
> 时间：2008-08-03T12:26:35.843

我认为您应该选择解决方案 2。我知道的任何 SQL 变体中都没有“交换”功能。

如果您需要定期执行此操作，我建议使用解决方案 1，具体取决于软件的其他部分如何使用这些数据。如果您不小心，您可能会遇到锁定问题。

但简而言之：除了您提供的解决方案之外，没有其他解决方案。

* * *

## 回答 #3

> 赞同：6
> 
> 时间：2008-12-10T12:19:55.950

除了安迪欧文的回答

这对我有用（在 SQL Server 2005 上）在类似的情况下，我有一个复合键，我需要交换一个作为唯一约束一部分的字段。

键：pID，LNUM rec1：10、0 rec2：10、1 rec3：10、2

我需要交换 LNUM 以便结果是

键：pID，LNUM rec1：10、1 rec2：10、2 rec3：10、0

所需的 SQL：

```
UPDATE    DOCDATA    
SET       LNUM = CASE LNUM
              WHEN 0 THEN 1
              WHEN 1 THEN 2 
              WHEN 2 THEN 0 
          END
WHERE     (pID = 10) 
  AND     (LNUM IN (0, 1, 2)) 
```

* * *

## 回答 #4

> 赞同：6
> 
> 时间：2012-04-04T19:40:12.450

还有另一种适用于 SQL Server 的方法：在 UPDATE 语句中使用临时表连接。

该问题是由同时具有相同值的两行引起的*，*但是如果您一次更新两行（更新为它们的新的唯一值），则不会违反约束。

伪代码：

```
-- setup initial data values:
insert into data_table(id, name) values(1, 'A')
insert into data_table(id, name) values(2, 'B')

-- create temp table that matches live table
select top 0 * into #tmp_data_table from data_table

-- insert records to be swapped
insert into #tmp_data_table(id, name) values(1, 'B')
insert into #tmp_data_table(id, name) values(2, 'A')

-- update both rows at once! No index violations!
update data_table set name = #tmp_data_table.name
from data_table join #tmp_data_table on (data_table.id = #tmp_data_table.id) 
```

感谢 Rich H 提供的这项技术。- 标记

* * *

## 回答 #5

> 赞同：4
> 
> 时间：2008-09-16T14:57:15.247

假设您知道要更新的两行的 PK... 这适用于 SQL Server，不能代表其他产品。SQL 在语句级别是（应该是）原子的：

```
CREATE TABLE testing
(
    cola int NOT NULL,
    colb CHAR(1) NOT NULL
);

CREATE UNIQUE INDEX UIX_testing_a ON testing(colb);

INSERT INTO testing VALUES (1, 'b');
INSERT INTO testing VALUES (2, 'a');

SELECT * FROM testing;

UPDATE testing
SET colb = CASE cola WHEN 1 THEN 'a'
                WHEN 2 THEN 'b'
                END
WHERE cola IN (1,2);

SELECT * FROM testing; 
```

所以你将从：

```
cola    colb
------------
1       b
2       a 
```

到：

```
cola    colb
------------
1       a
2       b 
```

* * *

## 回答 #6

> 赞同：3
> 
> 时间：2008-08-03T13:22:25.340

我也认为#2 是最好的选择，尽管我会确保将它包装在一个事务中，以防在更新过程中出现问题。

用不同的值更新唯一索引值的替代方法（因为你问过）是将行中的所有其他值更新为另一行的值。这样做意味着您可以单独保留唯一索引值，最后，您会得到所需的数据。但请注意，如果其他表在外键关系中引用此表，则数据库中的所有关系都保持不变。

* * *

## 回答 #7

> 赞同：3
> 
> 时间：2009-06-24T03:58:34.487

我也有同样的问题。这是我在 PostgreSQL 中提出的方法。在我的例子中，我的唯一索引是一个序列值，在我的行上定义了一个明确的用户顺序。用户将在网络应用程序中随机排列行，然后提交更改。

我打算添加一个“之前”触发器。在那个触发器中，每当我的唯一索引值更新时，我都会查看是否有任何其他行已经保存了我的新值。如果是这样，我会给他们我的旧价值，并有效地窃取他们的价值。

我希望 PostgreSQL 将允许我在之前的触发器中进行这种洗牌。

我会回帖，让你知道我的里程。

* * *

## 回答 #8

> 赞同：2
> 
> 时间：2012-04-20T19:12:34.247

在 SQL Server 中，MERGE 语句可以更新通常会破坏 UNIQUE KEY/INDEX 的行。（只是测试了这个，因为我很好奇。）

但是，您必须使用临时表/变量来提供 MERGE w/必要的行。

* * *

## 回答 #9

> 赞同：2
> 
> 时间：2016-04-27T14:15:25.287

对于 Oracle，有一个选项 DEFERRED，但您必须将其添加到您的约束中。

```
SET CONSTRAINT emp_no_fk_par DEFERRED; 
```

要推迟在整个会话期间可推迟的所有约束，您可以使用 ALTER SESSION SET constraints=DEFERRED 语句。

[来源](http://www.databasedesign-resource.com/deferred-integrity-constraints.html)

* * *

## 回答 #10

> 赞同：2
> 
> 时间：2017-03-18T18:00:46.593

我通常会想到一个我的表中绝对没有索引可以拥有的值。通常 - 对于唯一的列值 - 这真的很容易。例如，对于列“位置”的值（有关几个元素顺序的信息），它是 0。

然后您可以将值 A 复制到变量中，使用值 B 更新它，然后从变量中设置值 B。两个查询，我知道没有更好的解决方案。

* * *

## 回答 #11

> 赞同：1
> 
> 时间：2010-03-19T19:29:59.727

Oracle 延迟了完整性检查，正好解决了这个问题，但它在 SQL Server 或 MySQL 中都不可用。

* * *

## 回答 #12

> 赞同：1
> 
> 时间：2018-11-06T08:56:58.307

1）切换名称的ID

```
id    student 

1     Abbot   
2     Doris  
3     Emerson 
4     Green  
5     Jeames 
```

对于样本输入，输出为：

学生证

```
1     Doris   
2     Abbot   
3     Green   
4     Emerson 
5     Jeames 
```

“万一有n行怎么办……”

# c# - 自动更新版本号

> ID：650
> 
> 赞同：113
> 
> 时间：2008-08-03T11:12:52.463
> 
> 标签：c#, visual-studio, versioning

我希望每次构建都增加我的应用程序的版本属性，但我不确定如何在 Visual Studio (2005/2008) 中启用此功能。我试图将 AssemblyVersion 指定为 1.0.*，但它并没有得到我想要的。

我也在使用设置文件，并且在早期尝试中，当程序集版本更改时，我的设置被重置为默认值，因为应用程序在另一个目录中查找设置文件。

我希望能够以 1.1.38 的形式显示版本号，因此当用户发现问题时，我可以记录他们正在使用的版本，并告诉他们如果他们有旧版本进行升级。

对版本控制如何工作的简短解释也将不胜感激。内部版本号和修订号何时增加？

* * *

## 回答 #1

> 赞同：97
> 
> 时间：2008-08-03T11:41:38.490

使用“内置”的东西，你不能，因为使用 1.0.* 或 1.0.0.* 将用编码的日期/时间戳替换修订和内部版本号，这通常也是一个好方法。

有关详细信息，请参阅 /v 标记中的[程序集链接器](http://msdn2.microsoft.com/en-us/library/c405shex(vs.80).aspx)文档。

至于自动递增数字，请使用 AssemblyInfo 任务：

[装配信息任务](http://code.msdn.microsoft.com/AssemblyInfoTaskvers)

这可以配置为自动增加内部版本号。

有2个陷阱：

1.  版本字符串中的 4 个数字中的每一个都限制为 65535。这是 Windows 限制，不太可能得到修复。
    *   [为什么内部版本号限制为 65535？](http://blogs.msdn.com/msbuild/archive/2007/01/03/why-are-build-numbers-limited-to-65535.aspx)
2.  使用 with 和 Subversion 需要做一些小改动：
    *   [使用 MSBuild 在构建时生成程序集版本信息（包括 SubVersion 修复）](http://www.andrewconnell.com/blog/archive/2006/08/29/4078.aspx)

检索版本号非常容易：

```
Version v = Assembly.GetExecutingAssembly().GetName().Version;
string About = string.Format(CultureInfo.InvariantCulture, @"YourApp Version {0}.{1}.{2} (r{3})", v.Major, v.Minor, v.Build, v.Revision); 
```

* * *

而且，澄清一下：在 .net 或至少在 C# 中，构建实际上是第三个数字，而不是某些人（例如习惯于 Major.Minor.Release.Build 的 Delphi 开发人员）可能期望的第四个。

在 .net 中，它是 Major.Minor.Build.Revision。

* * *

## 回答 #2

> 赞同：21
> 
> 时间：2008-09-30T20:58:08.940

VS.NET 默认 Assembly 版本为 1.0.* 并在自动递增时使用以下逻辑：它将构建部分设置为自 2000 年 1 月 1 日以来的天数，并将修订部分设置为自午夜以来的秒数，当地时间，除以二。请参阅此[MSDN 文章](http://msdn.microsoft.com/en-us/library/system.reflection.assemblyversionattribute.assemblyversionattribute.aspx)。

程序集版本位于 assemblyinfo.vb 或 assemblyinfo.cs 文件中。从文件中：

```
' Version information for an assembly consists of the following four values:
'
'      Major Version
'      Minor Version 
'      Build Number
'      Revision
'
' You can specify all the values or you can default the Build and Revision Numbers 
' by using the '*' as shown below:
' <Assembly: AssemblyVersion("1.0.*")> 

<Assembly: AssemblyVersion("1.0.0.0")> 
<Assembly: AssemblyFileVersion("1.0.0.0")> 
```

* * *

## 回答 #3

> 赞同：11
> 
> 时间：2013-03-04T20:58:20.747

我发现在需要产品版本的地方使用以下内容简单地显示上次构建的日期效果很好：

```
System.IO.File.GetLastWriteTime(System.Reflection.Assembly.GetExecutingAssembly().Location).ToString("yyyy.MM.dd.HH.mm.ss") 
```

而不是尝试从以下内容获取版本：

```
System.Reflection.Assembly assembly = System.Reflection.Assembly.GetExecutingAssembly();
object[] attributes = assembly.GetCustomAttributes(typeof(System.Reflection.AssemblyFileVersionAttribute), false);
object attribute = null;

if (attributes.Length > 0)
{
    attribute = attributes[0] as System.Reflection.AssemblyFileVersionAttribute;
} 
```

* * *

## 回答 #4

> 赞同：5
> 
> 时间：2008-08-03T18:46:33.517

你用的是什么源代码控制系统？

几乎所有这些都具有某种形式的 $Id $ 标签，当文件被签入时会被扩展。

我通常使用某种形式的hackery 将其显示为版本号。

另一种选择是使用日期作为内部版本号：080803-1448

* * *

## 回答 #5

> 赞同：5
> 
> 时间：2017-05-10T14:08:29.120

*[Visual Studio 2017，**.csproj**属性]*

要自动更新您的 PackageVersion/Version/AssemblyVersion 属性（或任何其他属性），首先，创建一个新`Microsoft.Build.Utilities.Task`类，该类将获取您当前的内部版本号并发回更新后的编号（我建议仅为该类创建一个单独的项目）。

我手动更新major.minor 编号，但让MSBuild 自动更新内部版本号（1.1\. **1**、1.1\. **2**、1.1\. **3**等:)

```
using Microsoft.Build.Framework;
using System;
using System.Collections.Generic;
using System.Text;

public class RefreshVersion : Microsoft.Build.Utilities.Task
{
    [Output]
    public string NewVersionString { get; set; }
    public string CurrentVersionString { get; set; } 

    public override bool Execute()
    {       
        Version currentVersion = new Version(CurrentVersionString ?? "1.0.0");

        DateTime d = DateTime.Now;
        NewVersionString = new Version(currentVersion.Major, 
            currentVersion.Minor, currentVersion.Build+1).ToString();
        return true;
    }

} 
```

然后调用您最近在 MSBuild 过程中创建的任务，在 .csproj 文件中添加下一个代码：

```
<Project Sdk="Microsoft.NET.Sdk">    
...
<UsingTask TaskName="RefreshVersion" AssemblyFile="$(MSBuildThisFileFullPath)\..\..\<dll path>\BuildTasks.dll" />
<Target Name="RefreshVersionBuildTask" BeforeTargets="Pack" Condition="'$(Configuration)|$(Platform)'=='Release|AnyCPU'">
   <RefreshVersion CurrentVersionString="$(PackageVersion)">
          <Output TaskParameter="NewVersionString" PropertyName="NewVersionString" />             
   </RefreshVersion>
   <Message Text="Updating package version number to $(NewVersionString)..." Importance="high" />
   <XmlPoke XmlInputPath="$(MSBuildProjectDirectory)\mustache.website.sdk.dotNET.csproj" Query="/Project/PropertyGroup/PackageVersion" Value="$(NewVersionString)" />
</Target>
...
<PropertyGroup>
 ..
 <PackageVersion>1.1.4</PackageVersion>
 .. 
```

挑选Visual Studio Pack项目选项（仅在构建之前更改`BeforeTargets="Build"`为执行任务）时，将触发刷新代码以计算新版本号，并且`XmlPoke`任务将相应地更新.csproj属性（是的，它将修改文件）。

在使用 NuGet 库时，我还将包发送到 NuGet 存储库，只需将下一个构建任务添加到上一个示例。

```
<Message Text="Uploading package to NuGet..." Importance="high" />
<Exec WorkingDirectory="$(MSBuildProjectDirectory)\bin\release" Command="c:\nuget\nuget push *.nupkg -Source https://www.nuget.org/api/v2/package" IgnoreExitCode="true" /> 
```

`c:\nuget\nuget`是我拥有 NuGet 客户端的地方（请记住通过调用`nuget SetApiKey <my-api-key>`或在 NuGet 推送调用中包含该密钥来保存您的 NuGet API 密钥）。

以防万一它对某人有所帮助^_^。

* * *

## 回答 #6

> 赞同：1
> 
> 时间：2008-08-04T19:51:49.610

前段时间我写了一个快速而肮脏的 exe，它会更新 assemblyinfo.{cs/vb} 中的版本号 - 我还使用 rxfind.exe（一个简单而强大的基于正则表达式的搜索替换工具）来做作为构建过程的一部分，从命令行进行更新。其他一些有用的提示：

1.  将组件信息分成产品部分（公司名称、版本等）和组件特定部分（组件名称等）。看[这里](http://blog.darrenstokes.com/2007/12/17/ease-versioning-multiple-assemblies-by-splitting-up-assemblyinfo/)
2.  另外 - 我使用 subversion，所以我发现将内部版本号设置为 subversion 修订号很有帮助，从而可以很容易地始终返回生成程序集的代码库（例如 1.4.100.1502 是从修订版 1502 构建的）。

* * *

## 回答 #7

> 赞同：0
> 
> 时间：2010-02-28T21:16:35.570

如果您想要一个在每次编译完成时更新的自动递增数字，您可以使用预构建事件中的[VersionUpdater 。](http://testdox.wordpress.com/versionupdater/)如果您愿意，您的预构建事件可以检查构建配置，以便版本号只会在发布构建时增加（例如）。

* * *

## 回答 #8

> 赞同：0
> 
> 时间：2021-04-19T16:31:55.373

这是一个手动替代选项：这是我编写的一个快速而肮脏的 PowerShell 片段，它在我们的 Jenkins 构建系统的预构建步骤中被调用。

`AssemblyVersion`它将and的最后一位数字设置为由构建系统自动设置`AssemblyFileVersion`的环境变量的值。`BUILD_NUMBER`

```
if (Test-Path env:BUILD_NUMBER) {
    Write-Host "Updating AssemblyVersion to $env:BUILD_NUMBER"

    # Get the AssemblyInfo.cs
    $assemblyInfo = Get-Content -Path .\MyShinyApplication\Properties\AssemblyInfo.cs

    # Replace last digit of AssemblyVersion
    $assemblyInfo = $assemblyInfo -replace 
        "^\[assembly: AssemblyVersion\(`"([0-9]+)\.([0-9]+)\.([0-9]+)\.[0-9]+`"\)]", 
        ('[assembly: AssemblyVersion("$1.$2.$3.' + $env:BUILD_NUMBER + '")]')
    Write-Host  ($assemblyInfo -match '^\[assembly: AssemblyVersion')

    # Replace last digit of AssemblyFileVersion
    $assemblyInfo = $assemblyInfo -replace 
        "^\[assembly: AssemblyFileVersion\(`"([0-9]+)\.([0-9]+)\.([0-9]+)\.[0-9]+`"\)]", 
        ('[assembly: AssemblyFileVersion("$1.$2.$3.' + $env:BUILD_NUMBER + '")]')
    Write-Host  ($assemblyInfo -match '^\[assembly: AssemblyFileVersion')

    $assemblyInfo | Set-Content -Path .\MyShinyApplication\Properties\AssemblyInfo.cs -Encoding UTF8
} else {
    Write-Warning "BUILD_NUMBER is not set."
} 
```

# asp.net - IIS 6/ASP.NET Windows 身份验证清单？

> ID：651
> 
> 赞同：33
> 
> 时间：2008-08-03T11:21:54.520
> 
> 标签：asp.net, iis, authentication, active-directory

我一直无法让我的 ASP.NET 应用程序自动将用户登录到我正在构建的 Intranet 站点。无论是谷歌搜索还是我应用的实验，IE7 总是显示一个登录框。

我在 Web.config 中设置了 Windows 身份验证模式，禁用匿名访问并在 IIS 中配置了正确的默认域，但它仍然要求用户登录，更烦人的是，用户也需要提供域（*DOMAIN\auser* )，这会导致非技术访问者出现问题。感谢 Zeus 的密码记忆功能。

我不是网络管理员，因此有关 Active Directory 的某些内容可能设置不正确，或者可能只是我遗漏了一些非常简单的内容。请注意，我不想模拟用户，我只需要知道 IPrincipal.Name 属性与我的用户数据库中的有效记录相匹配，从而验证用户对我的应用程序的身份。

为此，拥有一份以这种方式协同工作的 AD、ASP.NET 和 IIS 的所有配置要求的清单将非常有用，作为调试的参考，并有望减少一些用户摩擦。

* * *

## 回答 #1

> 赞同：20
> 
> 时间：2008-08-03T15:24:38.290

听起来您已经涵盖了所有服务器端基础——也许这是一个客户端问题？我假设您的用户在 IE7 中启用了集成身份验证？（工具 -> Internet 选项 -> 高级 -> 安全）。这是默认启用的。

另外，您的站点是否被 IE7 正确识别为在本地 Intranet 区域中？IE7 默认只允许在该区域自动登录，因此如果 IE 认为您的站点在 Internet 上，则会提示用户。我相信使用带有点的主机名会导致 IE 将站点放入 Internet 区域。

* * *

## 回答 #2

> 赞同：1
> 
> 时间：2008-09-18T07:43:15.787

1.  打开`Active Directory Users and Computers`MMC 管理单元

2.  `computers`从`TreeView`（左侧）展开部分

3.  检查计算机是否已在您的域中注册。

此外，您必须使用该计算机上的域帐户登录，否则将显示该身份验证框。

* * *

## 回答 #3

> 赞同：0
> 
> 时间：2008-08-05T18:01:12.640

在 IIS 中，启用匿名访问并允许 web.config 处理用户身份验证。

# php - 加密密码

> ID：657
> 
> 赞同：38
> 
> 时间：2008-08-03T11:50:33.137
> 
> 标签：php, encryption, passwords

加密密码的最快且安全的方法是什么（最好使用 PHP），无论您选择哪种方法，它是否可移植？

换句话说，如果我稍后将我的网站迁移到不同的服务器，我的密码会继续有效吗？

正如我被告知的那样，我现在使用的方法取决于服务器上安装的库的确切版本。

* * *

## 回答 #1

> 赞同：33
> 
> 时间：2008-08-03T12:48:36.657

如果您正在为您的登录系统选择一种加密方法，那么速度不是您的朋友，Jeff 与 Thomas Ptacek 就密码问题争论不休，得出的[结论](http://chargen.matasano.com/chargen/2007/9/7/enough-with-the-rainbow-tables-what-you-need-to-know-about-s.html)是您应该使用您能负担得起的最慢、最安全的加密方法.

> 来自 Thomas Ptacek 的博客：
> 速度正是您在密码哈希函数中不想要的。
> 
> 现代密码方案受到增量密码破解程序的攻击。
> 
> 增量破解者不会预先计算所有可能的破解密码。他们单独考虑每个密码散列，并通过密码散列函数提供字典，就像您的 PHP 登录页面一样。像 Ophcrack 这样的彩虹表破解器使用空间来攻击密码；像 John the Ripper、Crack 和 LC5 这样的增量破解者使用时间：统计和计算。
> 
> 密码攻击游戏以破解密码 X 的时间计分。对于彩虹表，该时间取决于您的表需要多大以及搜索速度有多快。使用增量破解程序，时间取决于您可以使密码哈希函数运行多快。
> 
> 你可以更好地优化你的密码哈希函数，你的密码哈希函数得到的越快，你的方案就越弱。MD5 和 SHA1，甚至像 DES 这样的传统分组密码，都被设计成速度很快。MD5、SHA1 和 DES 是弱密码哈希。在现代 CPU 上，像 DES 和 MD5 这样的原始加密构建块可以进行位切片、矢量化和并行化，以使密码搜索速度快如闪电。Game-over FPGA 实施仅需数百美元。

* * *

## 回答 #2

> 赞同：16
> 
> 时间：2008-08-03T13:48:25.367

我和彼得在一起。开发人员似乎不理解密码。我们都选择（我也对此感到内疚）MD5 或 SHA1，因为它们速度很快。想一想（因为最近有人向我指出）这没有任何意义。我们应该选择一个愚蠢缓慢的散列算法。我的意思是，在事情的规模上，一个繁忙的网站会散列密码什么？每 1/2 分钟？谁在乎它是否需要 0.8 秒与服务器明智的 0.03 秒？但是这种额外的缓慢对于防止所有类型的常见暴力攻击来说是巨大的。

根据我的阅读，bcrypt 专为安全密码散列而设计。它基于河豚，并且有很多实现。

对于 PHP，请查看[PHP Pass](http://www.openwall.com/phpass/)

对于任何使用 .NET 的人，请查看[BCrypt.NET](http://derekslager.com/blog/posts/2007/10/bcrypt-dotnet-strong-password-hashing-for-dotnet-and-mono.ashx)

* * *

## 回答 #3

> 赞同：9
> 
> 时间：2008-09-17T18:06:17.920

应该指出的是，您不想*加密*密码，而是要对其进行**哈希**处理。

加密的密码可以被解密，让别人看到密码。散列是一种单向操作，因此用户的原始密码（以加密方式）消失了。

* * *

至于您应该选择哪种算法 - 使用当前公认的标准：

*   SHA-256

当你对用户的密码进行哈希处理时，一定要在其他一些垃圾中也用它来哈希处理。例如：

*   密码：`password1`
*   盐：`PasswordSaltDesignedForThisQuestion`

将盐附加到用户的密码：

```
String s = HashStringSHA256("password1PasswordSaltDesignedForThisQuestion"); 
```

* * *

## 回答 #4

> 赞同：7
> 
> 时间：2008-09-17T18:16:58.393

无论您做什么，都不要编写自己的加密算法。这样做几乎可以保证（除非你是密码学家）算法中会有一个缺陷，使得破解变得微不足道。

* * *

## 回答 #5

> 赞同：1
> 
> 时间：2008-08-04T23:07:15.673

我不一定要寻找最快但很好的平衡，正在开发此代码的某些服务器相当慢，散列和存储密码的脚本需要 5-6 秒才能运行，而且我已经将它缩小到散列（如果我评论它运行的散列，在 1-2 秒内）。

它不一定是最安全的，我不是为银行编码（现在），但我当然***不会将***密码存储为纯文本。

* * *

## 回答 #6

> 赞同：1
> 
> 时间：2016-07-16T07:47:48.057

考虑使用`bcrypt`它用于许多现代框架，如 laravel。

* * *

## 回答 #7

> 赞同：0
> 
> 时间：2018-05-18T18:27:40.983

[`password_hash ( string $password , int $algo [, array $options ] )`](http://php.net/password_hash). （PHP 5 >= 5.5.0，PHP 7）

`password_hash()`使用强大的单向散列算法创建新的密码散列。`password_hash()`兼容`crypt()`。因此，由创建的密码哈希`crypt()`可以与`password_hash()`.

* * *

## 回答 #8

> 赞同：0
> 
> 时间：2019-11-09T10:05:17.823

插入数据库时​​使用此函数 Password_harsh($password,PASSWORD_DEFAULT); 当从数据库中选择时，您使用函数 if(password_verify($password,$databasePassword)){ 将您插入的密码与数据库中的密码进行比较

```
}else{
echo "password not correct";
} 
```

这将以安全的格式对密码进行严苛

# python - 使用 'in' 匹配数组中 Python 对象的属性

> ID：683
> 
> 赞同：58
> 
> 时间：2008-08-03T13:19:16.983
> 
> 标签：python, arrays, iteration

我不记得我是否在做梦，但我似乎记得有一个功能允许类似的东西，

```
foo in iter_attr(array of python objects, attribute name)
```

我查看了文档，但这种事情不属于任何明显列出的标题

* * *

## 回答 #1

> 赞同：47
> 
> 时间：2008-09-11T22:42:14.047

使用列表推导会构建一个临时列表，如果正在搜索的序列很大，它可能会吃掉你所有的记忆。即使序列不大，构建列表也意味着在`in`开始搜索之前迭代整个序列。

可以通过使用生成器表达式来避免临时列表：

```
foo = 12
foo in (obj.id for obj in bar) 
```

现在，只要`obj.id == 12`在 的开头附近`bar`，搜索就会很快，即使`bar`是无限长的。

`hasattr`正如@Matt 建议的那样，如果其中的任何对象`bar`都可能缺少`id`属性，那么使用它是一个好主意：

```
foo = 12
foo in (obj.id for obj in bar if hasattr(obj, 'id')) 
```

* * *

## 回答 #2

> 赞同：12
> 
> 时间：2008-08-03T15:59:19.797

您是否正在寻找具有特定属性的对象列表？如果是这样，[列表推导](http://docs.python.org/tut/node7.html#SECTION007140000000000000000)是执行此操作的正确方法。

```
result = [obj for obj in listOfObjs if hasattr(obj, 'attributeName')] 
```

* * *

## 回答 #3

> 赞同：10
> 
> 时间：2008-08-27T20:13:49.943

你总是可以自己写一个：

```
def iterattr(iterator, attributename):
    for obj in iterator:
        yield getattr(obj, attributename) 
```

将与任何迭代的东西一起工作，无论是元组、列表还是其他任何东西。

我喜欢 python，它使这样的东西变得非常简单，而且没有比必要的麻烦，而且在使用中这样的东西非常优雅。

* * *

## 回答 #4

> 赞同：7
> 
> 时间：2008-08-03T14:30:50.850

不，你不是在做梦。Python 有一个非常出色的列表理解系统，可以让您非常优雅地操作列表，并且根据您想要完成的具体内容，这可以通过多种方式完成。本质上，您所做的是说“如果条件匹配，则列表中的项目”，并且您可以从中迭代结果或将结果转储到新列表中。

我将在此处[引用 Dive Into Python](http://diveintopython.net/functional_programming/filtering_lists.html)中的一个示例，因为它非常优雅，而且他们比我聪明。在这里，他们获取目录中的文件列表，然后过滤列表中与正则表达式条件匹配的所有文件。

> ```
>  files = os.listdir(path)                               
>     test = re.compile("test\.py$", re.IGNORECASE)          
>     files = [f for f in files if test.search(f)] 
> ```

对于您的示例，您可以在没有正则表达式的情况下执行此操作，对于您的表达式最后为匹配返回 true 的任何内容。还有其他选项，例如使用 filter() 函数，但如果我要选择，我会选择这个。

埃里克·斯普尔

* * *

## 回答 #5

> 赞同：6
> 
> 时间：2011-02-05T08:10:41.457

您正在考虑的功能可能是`operator.attrgettter`. 例如，要获取包含每个对象的“id”属性值的列表：

```
import operator
ids = map(operator.attrgetter("id"), bar)
```

如果您想检查列表是否包含一个 id == 12 的对象，那么一种简洁高效（即不会不必要地迭代整个列表）的方法是：

```
any(obj.id == 12 for obj in bar)
```

如果您想将 'in' 与 attrgetter 一起使用，同时仍保留列表的惰性迭代：

```
import operator,itertools
foo = 12
foo in itertools.imap(operator.attrgetter("id"), bar) 
```

* * *

## 回答 #6

> 赞同：5
> 
> 时间：2008-08-03T16:13:29.363

我的想法可以使用列表推导来实现，但我认为有一个函数可以以稍微简洁的方式做到这一点。

即“bar”是一个对象列表，所有这些对象都具有“id”属性

神话般的功能方式：

```
foo = 12
foo in iter_attr(bar, 'id')
```

列表理解方式：

```
foo = 12
foo in [obj.id for obj in bar]
```

回想起来，列表理解方式无论如何都非常简洁。

* * *

## 回答 #7

> 赞同：3
> 
> 时间：2008-08-27T20:30:22.070

如果您打算搜索任何大小合适的东西，最好的选择是使用字典或集合。否则，您基本上必须遍历迭代器的每个元素，直到找到您想要的元素。

如果这不一定是性能敏感代码，那么列表理解方式应该可以工作。但请注意，它的效率相当低，因为它遍历迭代器的每个元素，然后再次返回，直到找到它想要的。

请记住，python 拥有最有效的散列算法之一。使用它来发挥你的优势。

* * *

## 回答 #8

> 赞同：0
> 
> 时间：2008-08-03T15:47:22.100

我认为：

```
#!/bin/python
bar in dict(Foo) 
```

是你在想什么。当试图查看某个键是否存在于 python（python 的哈希表版本）中的字典中时，有两种检查方法。首先是**`has_key()`**附加到字典的方法，其次是上面给出的示例。它将返回一个布尔值。

那应该回答你的问题。

现在有点偏离主题，将其与之前给出的*列表理解*答案联系起来（为了更清楚一点）。 *List Comprehensions*从带有修饰符的基本*for 循环*构造一个列表。作为一个例子（稍微澄清一下），一种在*列表理解*`in dict`中使用语言结构的方法：

 *假设您有一个二维字典**`foo`**，并且您只想要包含 key 的二维字典**`bar`**。一种相对简单的方法是使用带有条件的*列表推导*，如下所示：

```
#!/bin/python
baz = dict([(key, value) for key, value in foo if bar in value]) 
```

注意**`if bar in value`**语句末尾的**，这是一个修改子句，它告诉*列表理解*只保留那些满足条件的键值对。** 在这种情况下**`baz`**是一个新字典，它只包含来自 foo 的字典其中包含 bar （希望我没有错过该代码示例中的任何内容...您可能需要查看[docs.python.org 教程](http://docs.python.org/tut/node7.html#SECTION007140000000000000000)和[secnetix.de](http://www.secnetix.de/olli/Python/list_comprehensions.hawk)中的列表理解文档，如果这两个站点都是很好的参考您将来有问题。）。*

# php - 将 PHP 连接到 IBM i (AS/400)

> ID：696
> 
> 赞同：37
> 
> 时间：2008-08-03T14:03:28.830
> 
> 标签：php, database, odbc, db2, ibm-midrange

我有一个即将进行的项目，我需要将我们的网站`PHP5/Apache 1.3/OpenBSD 4.1`（我已经做了一些检查，但遇到了一些障碍。

据我所知，IBM 的 DB2 扩展和 DB2 软件只能在 Linux 下运行。我尝试使用 IBM 的所有软件编译扩展，甚至尝试了他们的预编译 ibm_db2 扩展，但没有成功。IBM 只支持 Linux，所以我在内核中打开了 Linux 仿真，但这似乎没有任何帮助。

如果有人遇到过让所有东西都在 OpenBSD 下本地运行，那就太好了，但我想我可能需要做的是设置第二台运行 CentOS 并安装了 DB2 的服务器（很可能通过 ZendCore for IBM，因为它似乎可以做所有事情这对我来说）和驱动程序，以便我可以设置一个小型事务服务器，我可以针对该服务器发布并获取我需要的 DB2 数据的 JSON 表示。

第二种选择是否显得矫枉过正，还是其他人有更好的想法？

* * *

## 回答 #1

> 赞同：18
> 
> 时间：2008-08-03T14:39:09.710

[您是否看过使用unixODBC](http://www.unixodbc.org/)连接到服务器？如果我没记错的话，它支持 IBM DB2 并在 OpenBSD 上编译。查看[http://www.php.net/odbc](http://www.php.net/odbc)以获取有关 PHP 方面的更多信息。

如果你不能让它工作，那么在 Linux 服务器上设置 Web 服务的选项可能就是你所能做的。

* * *

## 回答 #2

> 赞同：4
> 
> 时间：2008-08-27T20:03:12.293

与其设置第二个盒子，不如看看 iSeries 的 PHP 连接器？我的大型机人员说在这里设置我们的 iSeries 非常容易。

我们用 PHP 编写了一个简单的服务器，它从 DB2 数据中加载数据模型，对它们进行序列化，然后将它们返回给调用者。这种方法意味着只有另一个 PHP 应用程序可以使用该服务，但它只是在两端序列化对象并将其发送到管道中要快得多。

以下是 IBM 提供的关于该主题的 PDF：http: [//i-seriesusergroup.org/wp-content/uploads/2006/09/PHP%20for%20i5OS%20NESDND.pdf](http://i-seriesusergroup.org/wp-content/uploads/2006/09/PHP%20for%20i5OS%20NESDND.pdf)

* * *

## 回答 #3

> 赞同：2
> 
> 时间：2008-08-03T21:31:14.353

看起来网络服务将成为我的答案。根据 PHP 文档，在生产机器上，我宁愿不必编译和维护我自己的 PHP 特殊安装，因为需要编译 ODBC 支持。

* * *

## 回答 #4

> 赞同：2
> 
> 时间：2008-08-24T23:10:28.840

第二个@John Downey，我已经通过unixODBC 在AS/400 上使用PHP 连接。

检查您的 phpinfo() 以查看其中是否有 unixODBC。我不必在 SLES 10 上编译它。

* * *

## 回答 #5

> 赞同：1
> 
> 时间：2008-08-19T21:51:57.950

Web 服务几乎可以肯定是要走的路。我相信您已经想到了这一点，但是由于您在两边都使用 PHP，您可以通过使用 serialize() 来构建您的响应数据而不是构建一个正确的 XML 文档来简化一些事情。从长远来看，它不太灵活，但它可能会让你更快地启动和运行。

* * *

## 回答 #6

> 赞同：1
> 
> 时间：2008-08-25T03:20:53.200

事实上，Web 服务似乎是解决问题的好方法。避免使用完全独立的操作系统的一种方法是在 Java 的 AS400 工具之上用 Java 编写 Web 服务（顺便说一句，这些工具非常好）。这至少应该让您也可以在 OpenBSD 机器上运行您的服务层。

* * *

## 回答 #7

> 赞同：1
> 
> 时间：2008-09-23T13:42:07.653

您也可以使用标准 ODBC 驱动程序直接连接。IBM 版本通常为您提供更多功能，例如能够调用程序之类的东西。如果您只需要 SQL 和存储过程，那么 ODBC 应该可以工作。

* * *

## 回答 #8

> 赞同：1
> 
> 时间：2008-10-01T18:16:11.147

为什么不使用 PHP 的 PDO？我不得不在这里猜测，因为我找不到所有可用于 OpenBSD 的端口的公开列表，但由于有一个用于 FreeBSD、NetBSD 等的端口，也许你也很幸运。

（我想即使 OpenBSD 链接到 FreeBSD 的搬运工手册，[Freshports](http://www.freshports.org/)也不适用于您的系统？）

如果 PDO 不可用，并且我希望您使用端口，并且根据以下链接，可以使用 php5-ODBC：

*   [http://www.openbsd.org/pkg-stable40.html](http://www.openbsd.org/pkg-stable40.html)

所以假设你通过端口管理你的系统，有你的指针。

希望有帮助！

# .net - 可脱离网络运行的 .net 嵌入式数据库

> ID：705
> 
> 赞同：39
> 
> 时间：2008-08-03T14:41:43.103
> 
> 标签：.net, database, embedded-database

我一直在（现在仍然）在寻找要在 .net (c#) 应用程序中使用的嵌入式数据库。警告：应用程序（或至少数据库）存储在网络驱动器上，但一次只能由 1 个用户使用。

现在，我的第一个想法是[SQL Server Compact edition](http://www.microsoft.com/sql/editions/compact/default.mspx)。这确实很好地集成了，但它不能脱离网络运行。

[Firebird](http://web.archive.org/web/20100615004036/http://firebirdsql.org/dotnetfirebird/)似乎也有同样的问题，但 .net 集成似乎并不是真正的一流，而且基本上没有记录。

[Blackfish SQL](http://web.archive.org/web/20150510070451/http://www.codegear.com/products/blackfish)看起来很有趣，但没有 .net 版本的试用版。定价也还可以。

有什么其他的建议可以很好地与 .net 配合使用**并且**在不需要实际安装服务器软件的情况下在网络上运行？

* * *

## 回答 #1

> 赞同：26
> 
> 时间：2008-08-03T14:48:52.497

在阅读您的问题时，我想到了[SQLite ，我很确定](http://www.sqlite.org/)*如果*您一次只限制 1 个用户，则可以从网络驱动器访问它。

[.NET 上的 SQLite - 在 3 分钟内启动并运行](http://web.archive.org/web/20100208133236/www.mikeduncan.com/sqlite-on-dotnet-in-3-mins/)

* * *

## 回答 #2

> 赞同：10
> 
> 时间：2008-10-21T19:20:27.840

我推荐 Advantage Database Server (www.advantagedatabase.com)。它是一个成熟的嵌入式数据库，具有强大的支持，并且可以从许多开发语言（除了 .NET）访问。“本地”版本是免费的，以 DLL 的形式在您的应用程序中运行，不需要在服务器/网络共享上安装，并且支持所有主要的数据库功能。您可以将数据库和/或应用程序文件全部存储在网络上；它不关心数据在哪里。

免责声明：我是 ADS 研发组的工程师。我保证，它摇滚:)

* * *

## 回答 #3

> 赞同：9
> 
> 时间：2008-08-03T15:48:43.657

听起来 ADO/Access 非常适合您的需求。它已融入 MS 堆栈、经验丰富且多用户。

您可以像这样以编程方式创建数据库：

```
Dim catalog as New ADOX.Catalog
Catalog.Create("Provider=Microsoft.Jet.OLEDB.4.0;Data Source=\\server\path\to\db.mdb") 
```

然后，您可以使用标准 ADO.NET 方法与数据库进行交互。

* * *

## 回答 #4

> 赞同：9
> 
> 时间：2008-08-09T12:51:41.973

您可以使用嵌入的 firebird，它只是一个 dll，您需要随应用一起提供。

关于未记录的事情，这不是真的，firebird .NET 驱动程序实现了 ADO 接口，所以如果你知道 ADO，你可以使用 Firebird，基本上你将使用 FBConnection 等代替 SQLConnection，但我的建议是编写一个数据访问层并仅在代码上使用接口，如下所示：

```
using FirebirdSql.Data.FirebirdClient;

public static IDbConnection MyConnection()
{
    FbConnection cn = new FbConnection("...");
    return cn;
} 
```

这个例子非常简单，但您不需要更多。

我们在所有应用程序中都使用 firebird，没有任何问题，您至少应该尝试一下。

* * *

## 回答 #5

> 赞同：8
> 
> 时间：2008-08-03T14:57:18.907

查看[VistaDB](http://www.gibraltarsoftware.com/VistaDB)。他们有一个非常好的产品，服务器版本（3.4）是 Beta 并且非常接近发布。

* * *

## 回答 #6

> 赞同：7
> 
> 时间：2009-04-22T21:01:35.847

这里的帖子有点晚了。而且已经提到了[VistaDB](http://www.gibraltarsoftware.com/VistaDB)，但我想指出，VistaDB 是 100% 托管的（因为您的帖子被标记为 .net）。它可以从共享网络驱动器运行，并且部署了 1MB xcopy。

既然你提到了 SQL CE，我们还支持 T-SQL 语法和数据类型（实际上比 SQL CE 更多），并具有可更新的视图、TSQL Procs 和 SQL CE 中缺少的其他东西。

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2008-08-03T15:34:17.523

为什么不使用[SQL Server 2005 Express 版](http://www.microsoft.com/sql/editions/express/default.mspx)？

这实际上取决于您所说的“嵌入式”是什么意思——但是您可以将 SQLServer2005E 与您的应用程序一起重新分发，而用户永远不必知道它的存在。

[在应用程序中嵌入 SQL Server Express](http://msdn.microsoft.com/en-us/library/ms165660.aspx)

[将 SQL Server Express 嵌入到自定义应用程序中](http://msdn.microsoft.com/en-us/library/bb264562.aspx)

* * *

## 回答 #8

> 赞同：4
> 
> 时间：2009-04-22T21:18:38.643

我很困惑。

您需要一个嵌入式数据库 - 数据库本身存储在服务器上。这意味着将数据文件存储在网络共享上。然后您说 SQL Compact Edition 将无法工作……除非您查看此文档：

Word 文档：
[在 SQL Server 2005 Compact Edition 和 SQL Server 2005 Express Edition 之间进行选择](http://download.microsoft.com/download/A/4/7/A47B7B0E-976D-4F49-B15D-F02ADE638EBE/Compact_Express_Comparison.doc)

在第 8 页上，“网络共享上的数据文件存储”旁边有一个漂亮的绿色大勾号。

所以在我看来，你的第一个想法是正确的。

* * *

## 回答 #9

> 赞同：2
> 
> 时间：2008-08-10T02:55:20.930

还有[瓦伦蒂娜](http://www.paradigmasoft.com/en/products/developer/adk/VNET)。当我在做一些 Real Basic 项目时，我偶然发现了这个产品。RB版非常好。

* * *

## 回答 #10

> 赞同：2
> 
> 时间：2010-05-16T15:18:27.793

你考虑过OODB吗？从各种开源替代方案中，我推荐[db4o](http://www.db4o.com)（对不起，自我推销:)），它可以在嵌入式或客户端/服务器模式下运行。

最好的

阿德里亚诺

* * *

## 回答 #11

> 赞同：0
> 
> 时间：2020-06-18T20:44:01.777

这个问题现在很古老，而且发生了很多变化。对于我的特定目的，[LiteDB](https://www.litedb.org/)是首选。它是开源的，并且有一个[GitHub Repository](https://github.com/mbdavid/LiteDB)。

Apart from that, [SQLite](https://sqlite.org/index.html) is basically the industry standard for embedded databases. There are attempts to port the code to .NET, but the prime use case involves a native library (e.g., the [sqlite Nuget package](https://www.nuget.org/packages/sqlite/)) and/or a .NET P/Invoke wrapper like [Microsoft.Data.SQLite](https://www.nuget.org/packages/Microsoft.Data.Sqlite).

# c# - .NET 测试框架建议

> ID：709
> 
> 赞同：55
> 
> 时间：2008-08-03T14:53:53.550
> 
> 标签：c#, .net, visual-studio, unit-testing, nunit

我希望在我的工作中引入一个单元测试框架。我们正在使用 Visual Studio 2005（尽管我们可能会在接下来的六个月内迁移到 2008）并且主要使用 C# 工作。如果框架具有某种最好的 IDE 集成，但我对没有集成但设置起来仍然相对简单的框架持开放态度。我会以某种方式抵抗它，所以如果我能确保我所推动的不是颈部疼痛，那将有助于我的情况。

到目前为止，我所做的研究中明显的选择指向 NUnit，但我想在将它推荐给我的团队之前获得实际使用过它的人的印象。

有人用过[NUnit](https://en.wikipedia.org/wiki/NUnit)吗？如果是这样，是否有任何我应该注意的陷阱或限制？还有其他好的选择吗？如果是这样，如果您同时使用了 NUnit，我将非常感谢您了解它们的优缺点。

* * *

## 回答 #1

> 赞同：44
> 
> 时间：2008-08-03T14:59:20.993

我认为[NUnit](https://en.wikipedia.org/wiki/NUnit) **是**你最好的选择。使用[TestDriven.NET](https://testdriven.net/)，您可以在 Visual Studio 中获得很好的集成。（如果您正在使用 ReSharper，它还有一个单元测试运行器）。NUnit 易于使用并遵循既定的范例。您还会发现大量使用它的项目、教程和指南，这些总是有帮助的。

您的另一个主要选择可能是[MbUnit](https://en.wikipedia.org/wiki/List_of_unit_testing_frameworks#.NET_programming_languages)，它越来越将自己定位为选择的[BDD](https://en.wikipedia.org/wiki/Behavior-driven_development)框架（与[Gallio](http://www.gallio.org)结合使用）。

* * *

## 回答 #2

> 赞同：18
> 
> 时间：2008-08-03T14:57:44.600

Scott Hanselman 对此有一个很好的*播客*，题为：

> “.NET 单元测试框架的过去、现在和未来”

：

[汉塞尔分钟#112](http://www.hanselminutes.com/default.aspx?showID=130)

* * *

## 回答 #3

> 赞同：8
> 
> 时间：2008-08-03T15:07:20.213

Visual Studio 2008 有一个内置的测试项目类型，其工作方式与 NUnit 类似，但显然与 Visual Studio 有更紧密的集成（可以在每个构建上运行，并在升级时以类似于转换结果页面的方式显示结果解决方案文件），但它显然不如 NUnit 成熟，因为它很新，我不确定它如何处理模拟。

但是，当您的团队迁移到 Visual Studio 2008 时，值得研究一下。

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2008-09-16T10:48:30.493

Visual Studio 2008 的内置单元测试还可以，但它很难与[CruiseControl.NET](https://en.wikipedia.org/wiki/CruiseControl)集成，肯定比普通的 NUnit 难很多。

因此，如果您打算进行出色的自动化测试，请选择 NUnit。

* * *

## 回答 #5

> 赞同：6
> 
> 时间：2008-10-01T12:57:34.203

我们一直在使用[xUnit.net](https://en.wikipedia.org/wiki/XUnit.net)。它似乎结合了 NUnit、[MbUnit](https://en.wikipedia.org/wiki/List_of_unit_testing_frameworks#.NET_programming_languages)和[MSTest](https://en.wikipedia.org/wiki/Visual_Studio_Unit_Testing_Framework)的所有优点。

* * *

## 回答 #6

> 赞同：5
> 
> 时间：2008-09-16T10:46:09.033

当我开始单元测试时，我从 NUnit 开始，因为它易于设置和使用。[目前我正在使用ReSharper](https://en.wikipedia.org/wiki/JetBrains#ReSharper_Ultimate)附带的内置测试运行器。这样，我可以轻松地在代码和测试结果之间切换。

顺便说一句，NUnit 会检测您何时编译了代码，因此您无需在 NUnit 中进行任何刷新。当您选择运行特定测试时，ReSharper 会自动进行构建。

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2009-04-18T09:00:33.180

也试试[PEX](http://research.microsoft.com/en-us/projects/Pex/)工具。

它是 Microsoft 自己的，可能很快就会集成到[VSTS](https://visualstudio.microsoft.com/team-services/)中。它确实支持 NUnit、[MbUnit](https://en.wikipedia.org/wiki/List_of_unit_testing_frameworks#.NET_programming_languages)和[xUnit.net](https://en.wikipedia.org/wiki/XUnit.net)。

我还使用一个小型控制台应用程序来测试一个类或一个小型库。[您可以从此处](http://ysgitdiary.blogspot.com/2009/04/example-console-application-in-c-ready.html)复制粘贴代码。

* * *

## 回答 #8

> 赞同：5
> 
> 时间：2011-05-28T20:03:05.930

如果您正在寻找功能测试自动化，VSTT 2010（Visual Studio Team System Test）应该是一个不错的选择。Web 服务测试、UI 测试、[BizTalk](https://en.wikipedia.org/wiki/Microsoft_BizTalk_Server)测试和数据驱动测试支持。请看[VSTT](https://docs.microsoft.com/en-us/previous-versions/visualstudio/visual-studio-2008/ee338734(v=vs.90))。

* * *

## 回答 #9

> 赞同：4
> 
> 时间：2008-08-03T19:36:48.470

[MbUnit](https://en.wikipedia.org/wiki/List_of_unit_testing_frameworks#.NET_programming_languages)值得一看。它有一组可与 NUnit 相媲美的特性。[它有自己的 GUI，或者如果你有ReSharper](https://en.wikipedia.org/wiki/JetBrains#ReSharper_Ultimate)可以集成到 Visual Studio 中。如果你正在做任何类型的[TDD](https://en.wikipedia.org/wiki/Test-driven_development) ，我也会推荐*Rhino Mocks*。

* * *

## 回答 #10

> 赞同：3
> 
> 时间：2008-08-07T01:55:51.120

我也会说[MbUnit](https://en.wikipedia.org/wiki/List_of_unit_testing_frameworks#.NET_programming_languages)。我喜欢通过指定输入来多次运行单个测试，结果就在测试函数的正上方。这是对我的意思的可怕描述，所以[这里有一个链接可以告诉你我的意思](http://www.hanselman.com/blog/MbUnitUnitTestingOnCrack.aspx)。

# .net - 为什么 VFP .NET OLEdb 提供程序不能在 64 位 Windows 中工作？

> ID：717
> 
> 赞同：31
> 
> 时间：2008-08-03T15:07:10.073
> 
> 标签：.net, sql-server-2005, oledb, legacy, visual-foxpro

我使用 VB 编写了一个 Windows 服务，该服务从 Visual Foxpro 数据库中读取一些遗留数据以插入到 SQL 2005 中。问题是这种使用在 Windows server 2003 32 位中运行良好，但客户端最近移至 Windows 2003 64 位现在该服务将无法正常工作。我收到一条消息，指出未找到 VFP .NET OLEdb 提供程序。我进行了研究，一切似乎都表明没有解决方案。任何帮助，请...

* * *

## 回答 #1

> 赞同：15
> 
> 时间：2008-08-03T19:42:03.687

您是否尝试过将目标 CPU 更改为`x86`而不是`"Any CPU"`在高级编译器选项中？我知道这`OLEDB`通过强制使用 32 位版本解决了其他提供商的一些问题。

* * *

## 回答 #2

> 赞同：9
> 
> 时间：2008-08-03T22:48:47.490

您需要使用目标`CPU`集进行编译`x86`以强制您的代码`32 bit`使用`VFP OLE Db provider`.

[Microsoft 已声明](http://msdn.microsoft.com/en-us/vfoxpro/bb190293.aspx)没有发布`64-bit`Visual FoxPro OLE Db 提供程序版本的计划。值得一提的是，微软[还表示](http://msdn.microsoft.com/en-us/vfoxpro/bb308952.aspx)VFP 9 是最终版本，`Visual FoxPro`支持将以`2015`. 如果你需要`OLE DB`提供者`VFP 9`，你可以在[这里](http://www.microsoft.com/downloads/details.aspx?FamilyId=E1A87D8F-2D58-491F-A0FA-95A3289C5FD4&displaylang=en)得到。

* * *

## 回答 #3

> 赞同：1
> 
> 时间：2008-08-06T22:33:32.760

`Sybase Anywhere`有一个`OLEDB provider`表`VFP`。它在服务器支持的页面中声明`64 bit Windows`，不知道`OLEDB provider`：

> 支持 64 位 Windows 和 Linux 服务器
> 
> 为了进一步增强可扩展性，在适用于 Windows 和 Linux 的 Advantage 数据库服务器中添加了对 x86_64 架构的支持。在具有 x86_64 处理器和 64 位操作系统的计算机上，Advantage 数据库服务器现在可以使用超过 4GB 的内存。额外的内存将允许更多用户同时访问服务器，并增加服务器在处理查询时可以缓存的信息量。

我自己没有尝试过，但VFP 新闻组的[一些人](http://weblogs.foxite.com/andykramek/archive/2008/01/05/5530.aspx)报告说它工作正常。

[链接到 Advantage 服务器/VFP 页面](http://devzone.advantagedatabase.com/dz/webhelp/Advantage9.0/Advantage.htm)

# python - Class views in Django

> ID：742
> 
> 赞同：62
> 
> 时间：2008-08-03T15:55:28.633
> 
> 标签：python, django, views, oop

[Django](http://www.djangoproject.com/) view points to a function, which can be a problem if you want to change only a bit of functionality. Yes, I could have million keyword arguments and even more if statements in the function, but I was thinking more of an object oriented approach.

For example, I have a page that displays a user. This page is very similar to page that displays a group, but it's still not so similar to just use another data model. Group also has members etc...

One way would be to point views to class methods and then extend that class. Has anyone tried this approach or has any other idea?

* * *

## 回答 #1

> 赞同：46
> 
> 时间：2008-08-29T04:29:22.053

I've created and used my own generic view classes, defining **`__call__`** so an instance of the class is callable. I really like it; while Django's generic views allow some customization through keyword arguments, OO generic views (if their behavior is split into a number of separate methods) can have much more fine-grained customization via subclassing, which lets me repeat myself a lot less. (I get tired of rewriting the same create/update view logic anytime I need to tweak something Django's generic views don't quite allow).

I've posted some code at [djangosnippets.org](http://www.djangosnippets.org/snippets/1009/).

The only real downside I see is the proliferation of internal method calls, which may impact performance somewhat. I don't think this is much of a concern; it's rare that Python code execution would be your performance bottleneck in a web app.

**UPDATE**: Django's own [generic views](http://docs.djangoproject.com/en/dev/topics/class-based-views/) are now class-based.

**UPDATE**: FWIW, I've changed my opinion on class-based views since this answer was written. After having used them extensively on a couple of projects, I feel they tend to lead to code that is satisfyingly DRY to write, but very hard to read and maintain later, because functionality is spread across so many different places, and subclasses are so dependent on every implementation detail of the superclasses and mixins. I now feel that [TemplateResponse](https://docs.djangoproject.com/en/dev/ref/template-response/) and view decorators is a better answer for decomposing view code.

* * *

## 回答 #2

> 赞同：13
> 
> 时间：2010-05-27T13:02:08.360

I needed to use class based views, but I wanted to be able to use the full name of the class in my URLconf without always having to instantiate the view class before using it. What helped me was a surprisingly simple metaclass:

```
class CallableViewClass(type):
    def __call__(cls, *args, **kwargs):
        if args and isinstance(args[0], HttpRequest):
            instance = super(CallableViewClass, cls).__call__()
            return instance.__call__(*args, **kwargs)
        else:
            instance = super(CallableViewClass, cls).__call__(*args, **kwargs)
            return instance

class View(object):
    __metaclass__ = CallableViewClass

    def __call__(self, request, *args, **kwargs):
        if hasattr(self, request.method):
            handler = getattr(self, request.method)
            if hasattr(handler, '__call__'):
                return handler(request, *args, **kwargs)
        return HttpResponseBadRequest('Method Not Allowed', status=405) 
```

I can now both instantiate view classes and use the instances as view functions, OR I can simply point my URLconf to my class and have the metaclass instantiate (and call) the view class for me. This works by checking the first argument to `__call__` – if it's a `HttpRequest`, it must be an actual HTTP request because it would be nonsense to attept to instantiate a view class with an `HttpRequest` instance.

```
class MyView(View):
    def __init__(self, arg=None):
        self.arg = arg
    def GET(request):
        return HttpResponse(self.arg or 'no args provided')

@login_required
class MyOtherView(View):
    def POST(request):
        pass

# And all the following work as expected.
urlpatterns = patterns(''
    url(r'^myview1$', 'myapp.views.MyView', name='myview1'),
    url(r'^myview2$', myapp.views.MyView, name='myview2'),
    url(r'^myview3$', myapp.views.MyView('foobar'), name='myview3'),
    url(r'^myotherview$', 'myapp.views.MyOtherView', name='otherview'),
) 
```

(I posted a snippet for this at [http://djangosnippets.org/snippets/2041/](http://djangosnippets.org/snippets/2041/))

* * *

## 回答 #3

> 赞同：9
> 
> 时间：2008-08-07T10:44:23.957

If you're simply displaying data from models, why not use the [Django Generic Views](https://docs.djangoproject.com/en/1.2/ref/generic-views/)? They're designed to let you easy show data from a model without having to write your own view and stuff about mapping URL paramaters to views, fetching data, handling edge cases, rendering output, etc.

* * *

## 回答 #4

> 赞同：3
> 
> 时间：2008-08-26T11:38:36.913

You can always create a class, override the *`__call__`* function and then point the URL file to an instance of the class. You can take a look at the [FormWizard](http://code.djangoproject.com/browser/django/trunk/django/contrib/formtools/wizard.py) class to see how this is done.

* * *

## 回答 #5

> 赞同：2
> 
> 时间：2008-08-11T22:59:42.277

Unless you want to do something a little complex, using the generic views are the way to go. They are far more powerful than their name implies, and if you are just displaying model data generic views will do the job.

* * *

## 回答 #6

> 赞同：1
> 
> 时间：2008-08-03T17:40:25.553

Sounds to me like you're trying to combine things that shouldn't be combined. If you need to do different processing in your view depending on if it's a User or Group object you're trying to look at then you should use two different view functions.

On the other hand there can be common idioms you'd want to extract out of your object_detail type views... perhaps you could use a decorator or just helper functions?

-Dan

* * *

## 回答 #7

> 赞同：1
> 
> 时间：2008-08-26T11:30:50.050

If you want to share common functionality between pages I suggest you look at custom tags. They're quite [easy to create](https://docs.djangoproject.com/en/1.1/howto/custom-template-tags/), and are very powerful.

Also, [templates can extend from other templates](https://code.djangoproject.com/wiki/ExtendingTemplates). This allows you to have a base template to set up the layout of the page and to share this between other templates which fill in the blanks. You can nest templates to any depth; allowing you to specify the layout on separate groups of related pages in one place.

* * *

## 回答 #8

> 赞同：1
> 
> 时间：2008-09-23T19:05:51.633

Generic views will usually be the way to go, but ultimately you're free to handle URLs however you want. FormWizard does things in a class-based way, as do some apps for RESTful APIs.

Basically with a URL you are given a bunch of variables and place to provide a callable, what callable you provide is completely up to you - the standard way is to provide a function - but ultimately Django puts no restrictions on what you do.

I do agree that a few more examples of how to do this would be good, FormWizard is probably the place to start though.

* * *

## 回答 #9

> 赞同：1
> 
> 时间：2014-10-08T05:53:09.677

You can use the Django Generic Views. You can easily achieve desired functionality thorough Django generic Views

# string - 将字符串格式化为标题大小写

> ID：746
> 
> 赞同：30
> 
> 时间：2008-08-03T16:03:48.290
> 
> 标签：string, language-agnostic, format, title-case

如何将字符串格式化为[标题大小写](http://www.grammar-monster.com/lessons/capital_letters_title_case.htm)？

* * *

## 回答 #1

> 赞同：16
> 
> 时间：2008-08-03T16:05:57.537

这是在 C# 中执行此操作的简单静态方法：

```
public static string ToTitleCaseInvariant(string targetString)
{
    return System.Threading.Thread.CurrentThread.CurrentCulture.TextInfo.ToTitleCase(targetString);
} 
```

* * *

## 回答 #2

> 赞同：13
> 
> 时间：2008-08-03T19:10:58.723

在我冒着吸引吹毛求疵者愤怒的风险的情况下，我会警惕自动升级所有以空格开头的单词。

我至少会考虑为文章和连词等异常情况实施字典。看哪：

> “美女和野兽”

当涉及到专有名词时，事情变得更加丑陋。

* * *

## 回答 #3

> 赞同：10
> 
> 时间：2008-08-03T18:22:47.213

这是一个 Perl 解决方案[http://daringfireball.net/2008/05/title_case](http://daringfireball.net/2008/05/title_case)

这是一个 Ruby 解决方案[http://frankschmitt.org/projects/title-case](http://frankschmitt.org/projects/title-case)

这是一个 Ruby 单线解决方案：[http ://snippets.dzone.com/posts/show/4702](http://snippets.dzone.com/posts/show/4702)

```
'some string here'.gsub(/\b\w/){$&.upcase} 
```

one-liner 所做的是使用正则表达式将每个单词的第一个字符替换为大写版本。

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2008-08-04T21:16:22.760

> 比如说，要在 C 中使用 ascii 代码 ( [http://www.asciitable.com/](http://www.asciitable.com/) ) 来查找 char 的整数值并从中减去 32。

如果您打算接受 az 和 AZ 之外的字符，这是一个糟糕的解决方案。

例如：ASCII 134：å，ASCII 143：Å。
使用算术得到你：ASCII 102：f

使用库调用，不要假设你可以对你的角色使用整数算术来取回有用的东西。Unicode 很[棘手](http://www.joelonsoftware.com/articles/Unicode.html)。

* * *

## 回答 #5

> 赞同：6
> 
> 时间：2010-06-09T04:24:08.593

在 Silverlight`ToTitleCase`中，`TextInfo`类中没有。

这是一个简单的基于正则表达式的方法。

注意：Silverlight 没有预编译的正则表达式，但对我来说，这种性能损失不是问题。

```
 public string TitleCase(string str)
    {
        return Regex.Replace(str, @"\w+", (m) =>
        {
            string tmp = m.Value;
            return char.ToUpper(tmp[0]) + tmp.Substring(1, tmp.Length - 1).ToLower();
        });
    } 
```

* * *

## 回答 #6

> 赞同：5
> 
> 时间：2008-08-03T16:12:43.747

用什么语言？

在 PHP 中是：

[ucwords()](http://php.net/manual/en/function.ucwords.php)

例子：

```
$HelloWorld = ucwords('hello world'); 
```

* * *

## 回答 #7

> 赞同：5
> 
> 时间：2008-08-03T16:33:51.193

如果您使用的语言具有受支持的方法/功能，则只需使用它（如在 C#`ToTitleCase`方法中）

如果没有，那么您将需要执行以下操作：

1.  读入字符串
2.  取第一个字
3.  将该单词的第一个字母大写¹
4.  前进并找到下一个单词
5.  如果不在字符串末尾，则转到 3，否则退出

¹要在 C 中大写它 - 使用[ascii 代码](http://www.asciitable.com)找到 char 的整数值并从中减去 32。

代码中需要进行更多的错误检查（确保字母有效等），并且“大写”功能需要对字母强加某种“标题大小写方案”以检查不需要的单词to be capatilised ('and', 'but' etc. [Here](http://answers.google.com/answers/threadview?id=349913) is a good scheme)

* * *

## 回答 #8

> 赞同：5
> 
> 时间：2008-09-29T22:35:06.873

在 Perl 中：

```
$string =~ s/(\w+)/\u\L$1/g; 
```

甚至在常见问题解答中也是如此。

* * *

## 回答 #9

> 赞同：5
> 
> 时间：2016-03-02T10:32:44.070

在 Java 中，您可以使用以下代码。

```
public String titleCase(String str) {
    char[] chars = str.toCharArray();
    for (int i = 0; i < chars.length; i++) {
        if (i == 0) {
            chars[i] = Character.toUpperCase(chars[i]);
        } else if ((i + 1) < chars.length && chars[i] == ' ') {
            chars[i + 1] = Character.toUpperCase(chars[i + 1]);
        }
    }
    return new String(chars);
} 
```

* * *

## 回答 #10

> 赞同：4
> 
> 时间：2011-03-02T22:29:42.833

类似 Excel 的 PROPER：

```
public static string ExcelProper(string s) {
    bool upper_needed = true;
    string result = "";
    foreach (char c in s) {
        bool is_letter = Char.IsLetter(c);
        if (is_letter)
            if (upper_needed)
                result += Char.ToUpper(c);
            else
                result += Char.ToLower(c);
        else
            result += c;
        upper_needed = !is_letter;
    }
    return result;
} 
```

* * *

## 回答 #11

> 赞同：2
> 
> 时间：2010-06-09T04:09:49.593

`http://titlecase.com/`有一个[API](http://titlecase.com)

* * *

## 回答 #12

> 赞同：1
> 
> 时间：2012-11-19T07:59:34.533

这是 Python 中的一个实现：[https ://launchpad.net/titlecase.py](https://launchpad.net/titlecase.py)

我刚刚在 C++ 中完成的这个实现的一个端口：http: [//codepad.org/RrfcsZzO](http://codepad.org/RrfcsZzO)

* * *

## 回答 #13

> 赞同：1
> 
> 时间：2009-12-07T16:56:51.797

我认为使用 CultureInfo 并不总是可靠的，这是手动操作字符串的简单方便的方法：

```
string sourceName = txtTextBox.Text.ToLower();
string destinationName = sourceName[0].ToUpper();

for (int i = 0; i < (sourceName.Length - 1); i++) {
  if (sourceName[i + 1] == "")  {
    destinationName += sourceName[i + 1];
  }
  else {
    destinationName += sourceName[i + 1];
  }
}
txtTextBox.Text = desinationName; 
```

* * *

## 回答 #14

> 赞同：1
> 
> 时间：2010-06-09T04:07:56.463

Excel中有一个内置公式`PROPER(n)`。

很高兴看到我不必自己写！

* * *

## 回答 #15

> 赞同：1
> 
> 时间：2017-12-15T11:54:52.580

这是一个简单的例子：

```
public static string ToTitleCaseInvariant(string str)
{
    return System.Threading.Thread.CurrentThread.CurrentCulture.TextInfo.ToTitleCase(str);
} 
```

* * *

## 回答 #16

> 赞同：0
> 
> 时间：2020-12-12T14:20:39.237

在 C# 中，您可以简单地使用

```
CultureInfo.InvariantCulture.TextInfo.ToTitleCase(str.ToLowerInvariant()) 
```

*   不变的
*   适用于大写字符串

* * *

## 回答 #17

> 赞同：0
> 
> 时间：2019-10-31T12:21:40.127

在 C# 中

```
using System.Globalization;  
using System.Threading;  
protected void Page_Load(object sender, EventArgs e)  
{  
  CultureInfo cultureInfo   = Thread.CurrentThread.CurrentCulture;  
  TextInfo textInfo = cultureInfo.TextInfo;  
  Response.Write(textInfo.ToTitleCase("WelcometoHome<br />"));  
  Response.Write(textInfo.ToTitleCase("Welcome to Home"));  
Response.Write(textInfo.ToTitleCase("Welcome@to$home<br/>").Replace("@","").Replace("$", ""));  
} 
```

* * *

## 回答 #18

> 赞同：-1
> 
> 时间：2008-08-03T16:25:07.700

在不使用现成函数的情况下，将字符串转换为标题大小写的超简单低级算法：

```
 convert first character to uppercase.
for each character in string,
    if the previous character is whitespace,
        convert character to uppercase. 
```

这假定无论字符是否区分大小写（例如，'+'），“将字符转换为大写”都会正确执行此操作。

* * *

## 回答 #19

> 赞同：-1
> 
> 时间：2008-09-29T23:27:40.743

在这里，您有一个 C++ 版本。它有一组不可大写的单词，如代词和介词。但是，如果您要处理重要文本，我不建议您自动执行此过程。

```
#include <iostream>
#include <string>
#include <vector>
#include <cctype>
#include <set>

using namespace std;

typedef vector<pair<string, int> > subDivision;
set<string> nonUpperCaseAble;

subDivision split(string & cadena, string delim = " "){
    subDivision retorno;
    int pos, inic = 0;
    while((pos = cadena.find_first_of(delim, inic)) != cadena.npos){
        if(pos-inic > 0){
            retorno.push_back(make_pair(cadena.substr(inic, pos-inic), inic));
        }
        inic = pos+1;
    }
    if(inic != cadena.length()){
        retorno.push_back(make_pair(cadena.substr(inic, cadena.length() - inic), inic));
    }
    return retorno;
}

string firstUpper (string & pal){
    pal[0] = toupper(pal[0]);
    return pal;
}

int main()
{
    nonUpperCaseAble.insert("the");
    nonUpperCaseAble.insert("of");
    nonUpperCaseAble.insert("in");
    // ...

    string linea, resultado;
    cout << "Type the line you want to convert: " << endl;
    getline(cin, linea);

    subDivision trozos = split(linea);
    for(int i = 0; i < trozos.size(); i++){
        if(trozos[i].second == 0)
        {
            resultado += firstUpper(trozos[i].first);
        }
        else if (linea[trozos[i].second-1] == ' ')
        {
            if(nonUpperCaseAble.find(trozos[i].first) == nonUpperCaseAble.end())
            {
                resultado += " " + firstUpper(trozos[i].first);
            }else{
                resultado += " " + trozos[i].first;
            }
        }
        else
        {
            resultado += trozos[i].first;
        }       
    }

    cout << resultado << endl;
    getchar();
    return 0;
} 
```

* * *

## 回答 #20

> 赞同：-1
> 
> 时间：2008-09-16T11:11:27.223

使用 perl 你可以这样做：

```
my $tc_string = join ' ', map { ucfirst($\_) } split /\s+/, $string; 
```

# c# - 如何从类型创建新的对象实例

> ID：752
> 
> 赞同：858
> 
> 时间：2008-08-03T16:29:03.607
> 
> 标签：c#, .net, performance, reflection, types

人们可能并不总是在编译时知道`Type`对象的 ，但可能需要创建`Type`.

如何从 a 中获取新的对象实例`Type`？

* * *

## 回答 #1

> 赞同：995
> 
> 时间：2008-08-03T16:35:34.233

`Activator`根命名空间中的类`System`非常强大。

将参数传递给构造函数等有很多重载。在以下位置查看文档：

> [http://msdn.microsoft.com/en-us/library/system.activator.createinstance.aspx](http://msdn.microsoft.com/en-us/library/system.activator.createinstance.aspx)

或（新路径）

> [https://docs.microsoft.com/en-us/dotnet/api/system.activator.createinstance](https://docs.microsoft.com/en-us/dotnet/api/system.activator.createinstance)

下面是一些简单的例子：

```
ObjectType instance = (ObjectType)Activator.CreateInstance(objectType);

ObjectType instance = (ObjectType)Activator.CreateInstance("MyAssembly","MyNamespace.ObjectType"); 
```

* * *

## 回答 #2

> 赞同：173
> 
> 时间：2008-08-25T13:33:25.257

```
ObjectType instance = (ObjectType)Activator.CreateInstance(objectType); 
```

该类`Activator`有一个通用变体，使这更容易一些：

```
ObjectType instance = Activator.CreateInstance<ObjectType>(); 
```

* * *

## 回答 #3

> 赞同：167
> 
> 时间：2015-04-30T16:13:00.737

编译表达式是最好的方法！（为了在运行时重复创建实例的性能）。

```
static readonly Func<X> YCreator = Expression.Lambda<Func<X>>(
   Expression.New(typeof(Y).GetConstructor(Type.EmptyTypes))
 ).Compile();

X x = YCreator(); 
```

统计（2012）：

```
 Iterations: 5000000
    00:00:00.8481762, Activator.CreateInstance(string, string)
    00:00:00.8416930, Activator.CreateInstance(type)
    00:00:06.6236752, ConstructorInfo.Invoke
    00:00:00.1776255, Compiled expression
    00:00:00.0462197, new 
```

统计数据（2015，.net 4.5，x64）：

```
 Iterations: 5000000
    00:00:00.2659981, Activator.CreateInstance(string, string)
    00:00:00.2603770, Activator.CreateInstance(type)
    00:00:00.7478936, ConstructorInfo.Invoke
    00:00:00.0700757, Compiled expression
    00:00:00.0286710, new 
```

统计数据（2015，.net 4.5，x86）：

```
 Iterations: 5000000
    00:00:00.3541501, Activator.CreateInstance(string, string)
    00:00:00.3686861, Activator.CreateInstance(type)
    00:00:00.9492354, ConstructorInfo.Invoke
    00:00:00.0719072, Compiled expression
    00:00:00.0229387, new 
```

统计数据（2017，LINQPad 5.22.02/x64/.NET 4.6）：

```
 Iterations: 5000000
    No args
    00:00:00.3897563, Activator.CreateInstance(string assemblyName, string typeName)
    00:00:00.3500748, Activator.CreateInstance(Type type)
    00:00:01.0100714, ConstructorInfo.Invoke
    00:00:00.1375767, Compiled expression
    00:00:00.1337920, Compiled expression (type)
    00:00:00.0593664, new
    Single arg
    00:00:03.9300630, Activator.CreateInstance(Type type)
    00:00:01.3881770, ConstructorInfo.Invoke
    00:00:00.1425534, Compiled expression
    00:00:00.0717409, new 
```

统计数据（2019，x64/.NET 4.8）：

```
Iterations: 5000000
No args
00:00:00.3287835, Activator.CreateInstance(string assemblyName, string typeName)
00:00:00.3122015, Activator.CreateInstance(Type type)
00:00:00.8035712, ConstructorInfo.Invoke
00:00:00.0692854, Compiled expression
00:00:00.0662223, Compiled expression (type)
00:00:00.0337862, new
Single arg
00:00:03.8081959, Activator.CreateInstance(Type type)
00:00:01.2507642, ConstructorInfo.Invoke
00:00:00.0671756, Compiled expression
00:00:00.0301489, new 
```

统计数据（2019，x64/.NET Core 3.0）：

```
Iterations: 5000000
No args
00:00:00.3226895, Activator.CreateInstance(string assemblyName, string typeName)
00:00:00.2786803, Activator.CreateInstance(Type type)
00:00:00.6183554, ConstructorInfo.Invoke
00:00:00.0483217, Compiled expression
00:00:00.0485119, Compiled expression (type)
00:00:00.0434534, new
Single arg
00:00:03.4389401, Activator.CreateInstance(Type type)
00:00:01.0803609, ConstructorInfo.Invoke
00:00:00.0554756, Compiled expression
00:00:00.0462232, new 
```

完整代码：

```
static X CreateY_New()
{
    return new Y();
}

static X CreateY_New_Arg(int z)
{
    return new Y(z);
}

static X CreateY_CreateInstance()
{
    return (X)Activator.CreateInstance(typeof(Y));
}

static X CreateY_CreateInstance_String()
{
    return (X)Activator.CreateInstance("Program", "Y").Unwrap();
}

static X CreateY_CreateInstance_Arg(int z)
{
    return (X)Activator.CreateInstance(typeof(Y), new object[] { z, });
}

private static readonly System.Reflection.ConstructorInfo YConstructor =
    typeof(Y).GetConstructor(Type.EmptyTypes);
private static readonly object[] Empty = new object[] { };
static X CreateY_Invoke()
{
    return (X)YConstructor.Invoke(Empty);
}

private static readonly System.Reflection.ConstructorInfo YConstructor_Arg =
    typeof(Y).GetConstructor(new[] { typeof(int), });
static X CreateY_Invoke_Arg(int z)
{
    return (X)YConstructor_Arg.Invoke(new object[] { z, });
}

private static readonly Func<X> YCreator = Expression.Lambda<Func<X>>(
   Expression.New(typeof(Y).GetConstructor(Type.EmptyTypes))
).Compile();
static X CreateY_CompiledExpression()
{
    return YCreator();
}

private static readonly Func<X> YCreator_Type = Expression.Lambda<Func<X>>(
   Expression.New(typeof(Y))
).Compile();
static X CreateY_CompiledExpression_Type()
{
    return YCreator_Type();
}

private static readonly ParameterExpression YCreator_Arg_Param = Expression.Parameter(typeof(int), "z");
private static readonly Func<int, X> YCreator_Arg = Expression.Lambda<Func<int, X>>(
   Expression.New(typeof(Y).GetConstructor(new[] { typeof(int), }), new[] { YCreator_Arg_Param, }),
   YCreator_Arg_Param
).Compile();
static X CreateY_CompiledExpression_Arg(int z)
{
    return YCreator_Arg(z);
}

static void Main(string[] args)
{
    const int iterations = 5000000;

    Console.WriteLine("Iterations: {0}", iterations);

    Console.WriteLine("No args");
    foreach (var creatorInfo in new[]
    {
        new {Name = "Activator.CreateInstance(string assemblyName, string typeName)", Creator = (Func<X>)CreateY_CreateInstance},
        new {Name = "Activator.CreateInstance(Type type)", Creator = (Func<X>)CreateY_CreateInstance},
        new {Name = "ConstructorInfo.Invoke", Creator = (Func<X>)CreateY_Invoke},
        new {Name = "Compiled expression", Creator = (Func<X>)CreateY_CompiledExpression},
        new {Name = "Compiled expression (type)", Creator = (Func<X>)CreateY_CompiledExpression_Type},
        new {Name = "new", Creator = (Func<X>)CreateY_New},
    })
    {
        var creator = creatorInfo.Creator;

        var sum = 0;
        for (var i = 0; i < 1000; i++)
            sum += creator().Z;

        var stopwatch = new Stopwatch();
        stopwatch.Start();
        for (var i = 0; i < iterations; ++i)
        {
            var x = creator();
            sum += x.Z;
        }
        stopwatch.Stop();
        Console.WriteLine("{0}, {1}", stopwatch.Elapsed, creatorInfo.Name);
    }

    Console.WriteLine("Single arg");
    foreach (var creatorInfo in new[]
    {
        new {Name = "Activator.CreateInstance(Type type)", Creator = (Func<int, X>)CreateY_CreateInstance_Arg},
        new {Name = "ConstructorInfo.Invoke", Creator = (Func<int, X>)CreateY_Invoke_Arg},
        new {Name = "Compiled expression", Creator = (Func<int, X>)CreateY_CompiledExpression_Arg},
        new {Name = "new", Creator = (Func<int, X>)CreateY_New_Arg},
    })
    {
        var creator = creatorInfo.Creator;

        var sum = 0;
        for (var i = 0; i < 1000; i++)
            sum += creator(i).Z;

        var stopwatch = new Stopwatch();
        stopwatch.Start();
        for (var i = 0; i < iterations; ++i)
        {
            var x = creator(i);
            sum += x.Z;
        }
        stopwatch.Stop();
        Console.WriteLine("{0}, {1}", stopwatch.Elapsed, creatorInfo.Name);
    }
}

public class X
{
  public X() { }
  public X(int z) { this.Z = z; }
  public int Z;
}

public class Y : X
{
    public Y() {}
    public Y(int z) : base(z) {}
} 
```

* * *

## 回答 #4

> 赞同：25
> 
> 时间：2014-11-03T06:11:55.120

它很简单。假设您的类名是`Car`并且命名空间是`Vehicles`，然后将参数作为`Vehicles.Car`返回类型的对象传递`Car`。像这样，您可以动态创建任何类的任何实例。

```
public object GetInstance(string strNamesapace)
{         
     Type t = Type.GetType(strNamesapace); 
     return  Activator.CreateInstance(t);         
} 
```

如果您的[完全限定名称](https://msdn.microsoft.com/en-us/library/dfb3cx8s%28v=vs.71%29.aspx)（即，`Vehicles.Car`在这种情况下）在另一个程序集中，则`Type.GetType`将为空。在这种情况下，您需要遍历所有程序集并找到`Type`. 为此，您可以使用以下代码

```
public object GetInstance(string strFullyQualifiedName)
{
     Type type = Type.GetType(strFullyQualifiedName);
     if (type != null)
         return Activator.CreateInstance(type);
     foreach (var asm in AppDomain.CurrentDomain.GetAssemblies())
     {
         type = asm.GetType(strFullyQualifiedName);
         if (type != null)
             return Activator.CreateInstance(type);
     }
     return null;
 } 
```

您可以通过调用上述方法来获取实例。

```
object objClassInstance = GetInstance("Vehicles.Car"); 
```

* * *

## 回答 #5

> 赞同：19
> 
> 时间：2015-06-30T12:51:58.807

不使用反射：

```
private T Create<T>() where T : class, new()
{
    return new T();
} 
```

* * *

## 回答 #6

> 赞同：16
> 
> 时间：2008-08-25T13:31:35.433

如果这是为了在应用程序实例中被大量调用的东西，编译和缓存动态代码会快得多，而不是使用激活器或`ConstructorInfo.Invoke()`. 动态编译的两个简单选项是编译的[Linq 表达式](http://rogeralsing.com/2008/02/28/linq-expressions-creating-objects/)或一些简单的[`IL`操作码和`DynamicMethod`](http://web.archive.org/web/20140926050502/http://www.ozcandegirmenci.com/post/2008/02/Create-object-instances-Faster-than-Reflection.aspx). 无论哪种方式，当您开始进入紧密循环或多次调用时，差异都会很大。

* * *

## 回答 #7

> 赞同：12
> 
> 时间：2013-07-22T21:03:41.997

如果您想使用默认构造函数，那么`System.Activator`前面介绍的解决方案可能是最方便的。但是，如果该类型缺少默认构造函数或者您必须使用非默认构造函数，则可以选择使用反射或`System.ComponentModel.TypeDescriptor`. 在反射的情况下，只知道类型名称（及其命名空间）就足够了。

使用反射的示例：

```
ObjectType instance = 
    (ObjectType)System.Reflection.Assembly.GetExecutingAssembly().CreateInstance(
        typeName: objectType.FulName, // string including namespace of the type
        ignoreCase: false,
        bindingAttr: BindingFlags.Default,
        binder: null,  // use default binder
        args: new object[] { args, to, constructor },
        culture: null, // use CultureInfo from current thread
        activationAttributes: null
    ); 
```

使用示例`TypeDescriptor`：

```
ObjectType instance = 
    (ObjectType)System.ComponentModel.TypeDescriptor.CreateInstance(
        provider: null, // use standard type description provider, which uses reflection
        objectType: objectType,
        argTypes: new Type[] { types, of, args },
        args: new object[] { args, to, constructor }
    ); 
```

* * *

## 回答 #8

> 赞同：10
> 
> 时间：2010-08-17T14:30:14.463

通用`T t = new T();`不行吗？

* * *

## 回答 #9

> 赞同：10
> 
> 时间：2015-06-30T16:35:24.747

鉴于此问题，当存在无参数 ctor 时，Activator 将起作用。如果这是一个约束考虑使用

```
System.Runtime.Serialization.FormatterServices.GetSafeUninitializedObject() 
```

* * *

## 回答 #10

> 赞同：6
> 
> 时间：2012-09-09T23:08:58.957

```
public AbstractType New
{
    get
    {
        return (AbstractType) Activator.CreateInstance(GetType());
    }
} 
```

* * *

## 回答 #11

> 赞同：3
> 
> 时间：2015-03-24T18:10:05.570

我可以解决这个问题，因为我希望为任意类（使用默认构造函数）实现一个简单的 CloneObject 方法

使用泛型方法，您可以要求类型实现 New()。

```
Public Function CloneObject(Of T As New)(ByVal src As T) As T
    Dim result As T = Nothing
    Dim cloneable = TryCast(src, ICloneable)
    If cloneable IsNot Nothing Then
        result = cloneable.Clone()
    Else
        result = New T
        CopySimpleProperties(src, result, Nothing, "clone")
    End If
    Return result
End Function 
```

使用非泛型假设该类型具有默认构造函数，如果没有，则捕获异常。

```
Public Function CloneObject(ByVal src As Object) As Object
    Dim result As Object = Nothing
    Dim cloneable As ICloneable
    Try
        cloneable = TryCast(src, ICloneable)
        If cloneable IsNot Nothing Then
            result = cloneable.Clone()
        Else
            result = Activator.CreateInstance(src.GetType())
            CopySimpleProperties(src, result, Nothing, "clone")
        End If
    Catch ex As Exception
        Trace.WriteLine("!!! CloneObject(): " & ex.Message)
    End Try
    Return result
End Function 
```

# .net - 本地化日期格式描述符

> ID：761
> 
> 赞同：22
> 
> 时间：2008-08-03T17:30:20.473
> 
> 标签：.net, internationalization, date, globalization

本地化日期格式描述符的最佳方法是什么？

任何来自不使用 mm/dd/yyyy 格式的文化的人都知道，必须以这种格式输入日期很烦人。.NET 框架提供了一些非常好的本地化支持，因此根据用户文化解析日期很简单，但您通常还希望显示有关所需格式的有用提示（特别是区分 yy 和 yyyy 可在大多数文化）。

以对大多数用户有意义的方式执行此操作的最佳方法是什么（例如，dd/M/yyy 令人困惑，因为大小写的变化以及一个和两个字母之间的切换）。

* * *

## 回答 #1

> 赞同：7
> 
> 时间：2008-08-03T18:18:54.400

[只需使用 ISO-8601](http://en.wikipedia.org/wiki/ISO_8601)。这是一个国际标准。

```
Date and time (current at page generation) expressed according to ISO 8601:
Date:                           2014-07-05
Combined date and time in UTC:  2014-07-05T04:00:25+00:00
                                2014-07-05T04:00:25Z
Week:                           2014-W27
Date with week number:          2014-W27-6
Ordinal date:                   2014-186 
```

* * *

## 回答 #2

> 赞同：4
> 
> 时间：2008-08-04T18:50:34.100

我必须同意我的 DD/MM/YYYY 成长过程中 OP 的“错误”日期真的很糟糕，而且我发现 ISO 8601 日期和时间非常容易使用。一旦标准正确，[engtech](https://stackoverflow.com/questions/761/#770)就有了不需要本地化的明显答案。

我打算将堆栈溢出的生日输入表单报告为一个错误，因为它对世界上的大多数人来说是多么痛苦。

* * *

## 回答 #3

> 赞同：2
> 
> 时间：2008-08-03T17:31:31.313

这是我目前的方法。有什么建议么？

```
Regex singleMToDoubleRegex = new Regex("(?<!m)m(?!m)");
Regex singleDToDoubleRegex = new Regex("(?<!d)d(?!d)");
CultureInfo currentCulture = CultureInfo.CurrentUICulture;

// If the culture is netural there is no date pattern to use, so use the default.
if (currentCulture.IsNeutralCulture)
{
    currentCulture = CultureInfo.InvariantCulture;
}

// Massage the format into a more general user friendly form.
string shortDatePattern = CultureInfo.CurrentUICulture.DateTimeFormat.ShortDatePattern.ToLower();
shortDatePattern = singleMToDoubleRegex.Replace(shortDatePattern, "mm");
shortDatePattern = singleDToDoubleRegex.Replace(shortDatePattern, "dd"); 
```

* * *

## 回答 #4

> 赞同：2
> 
> 时间：2008-08-04T08:14:56.973

国际标准的问题在于几乎没有人使用它们。我尽可能地尝试，但我被迫在现实生活中几乎所有地方都使用 dd/mm/yyyy，这意味着我已经习惯了使用 ISO-8601 始终是一个有意识的过程。对于大多数甚至不尝试使用 ISO-8601 的人来说，情况更糟。如果你能在可能的地方实现国际化，我认为这是一个很大的优势。

* * *

## 回答 #5

> 赞同：1
> 
> 时间：2008-08-03T17:37:43.063

如何给出格式（mm/dd/yyyy 或 dd/mm/yyyy），然后打印用户文化中今天的日期。MSDN 有一篇关于[为个人的文化格式化 DateTime](http://msdn.microsoft.com/en-us/library/5hh873ya(VS.71).aspx)的文章，使用 CultureInfo 对象可能有助于执行此操作。格式（大多数人都熟悉）与以该格式表示的当前日期相结合，应该足以让人们知道他们应该如何输入日期。（还包括一个日历控件，供那些仍然无法弄清楚的人使用）。

* * *

## 回答 #6

> 赞同：1
> 
> 时间：2008-08-04T19:13:17.940

简短的表格很方便，有助于避免拼写错误。根据需要进行本地化，但一定要显示预期的格式（不要让用户盲目）。提供日期选择器控件作为填写字段的*可选*助手。

作为额外的，即时解析和长格式日期显示也可能有所帮助。

* * *

## 回答 #7

> 赞同：0
> 
> 时间：2008-09-19T17:02:14.677

**最佳选择**：我建议使用标准日期选择器。

**替代**方法：每次编辑控件的内容更改时，对其进行解析并显示（在单独的控件中？）日期的长格式（即：输入“03/04/09”显示“您的输入：2009 年 3 月 4 日” )

# python - Python 和 MySQL

> ID：766
> 
> 赞同：45
> 
> 时间：2008-08-03T17:44:07.450
> 
> 标签：python, mysql, postgresql, bpgsql

我可以让 Python 与 Postgresql 一起工作，但我无法让它与 MySQL 一起工作。主要问题是，在我拥有的共享主机帐户上，我无法安装诸如 Django 或 PySQL 之类的东西，在我的计算机上安装它们时通常会失败，所以也许我无法在主机上安装是件好事。

我发现[bpgsql](http://barryp.org/software/bpgsql/)非常好，因为它不需要安装，它是一个我可以查看、读取然后调用函数的单个文件。有人知道 MySQL 的类似情况吗？

* * *

## 回答 #1

> 赞同：27
> 
> 时间：2008-08-04T21:54:11.857

MySQLdb是我以前用过的。

如果您的主机使用 Python 2.5 或更高版本，则内置对 sqlite3 数据库的支持（sqlite 允许您拥有一个关系数据库，它只是文件系统中的一个文件）。但买家要注意，sqlite 不适合生产，所以它可能取决于你想用它做什么。

另一种选择可能是打电话给你的主人并抱怨，或者更换主人。老实说，这些天来，任何支持 python 和 mysql 的自尊网络主机都应该预先安装 MySQLdb。

* * *

## 回答 #2

> 赞同：7
> 
> 时间：2008-08-03T18:32:27.693

[我个人对http://www.SiteGround.com](http://www.SiteGround.com)作为网络主机 没有任何经验。

这只是一个猜测，但共享主机通过 MySQLdb 模块支持 Python 和 MySQL 是很常见的（例如，GoDaddy 就是这样做的）。尝试以下 CGI 脚本来查看是否安装了 MySQLdb。

```
#!/usr/bin/python

module_name = 'MySQLdb'
head = '''Content-Type: text/html

%s is ''' % module_name

try:
    __import__(module_name)
    print head + 'installed'
except ImportError:
    print head + 'not installed' 
```

* * *

## 回答 #3

> 赞同：6
> 
> 时间：2008-08-03T20:07:05.290

我上传它并收到内部错误

```
Premature end of script headers 
```

在玩了很多之后，我发现如果我有

```
import cgi
import cgitb; cgitb.enable()
import MySQLdb 
```

它会给我一个更有用的答案并说它没有安装，你可以自己看 -> [http://woarl.com/db.py](http://woarl.com/db.py)

奇怪的是，这会产生错误

```
import MySQLdb
import cgi
import cgitb; cgitb.enable() 
```

我查看了那里的其他一些文件，似乎该库是我已经尝试过的文件之一。

* * *

## 回答 #4

> 赞同：6
> 
> 时间：2008-08-11T23:16:33.757

[您可以尝试使用Virtual Python](http://peak.telecommunity.com/DevCenter/EasyInstall#creating-a-virtual-python)设置您自己的 python 安装。[在这里](http://forums.site5.com/showthread.php?t=10236)查看如何使用它来设置 Django 。那是很久以前写的，但它显示了我如何在没有 root 访问权限或类似权限的情况下设置 MySQLdb。一旦你掌握了基础知识，你就可以安装任何你想要的 python 库。

* * *

## 回答 #5

> 赞同：5
> 
> 时间：2011-01-27T06:48:31.197

您真的希望 MySQLdb 用于任何 MySQL + Python 代码。但是，您不需要 root 访问权限或任何东西来使用它。您可以在用户目录（~/lib/python2.x/site-packages）中构建/安装它，然后将其添加到您的 PYTHON_PATH 环境变量中。这应该适用于几乎任何 python 库。

试一试，确实没有好的选择。

* * *

## 回答 #6

> 赞同：2
> 
> 时间：2015-10-10T20:00:39.080

选择

[https://docs.djangoproject.com/en/1.8/ref/databases/](https://docs.djangoproject.com/en/1.8/ref/databases/)

MySQLdb 主要是使用驱动程序，但是如果您使用 python3 和 django 1.8.x 将无法正常工作，那么您应该使用 MySQLdb 中的 mysqlclient，在以下链接中

[https://pypi.python.org/pypi/mysqlclient](https://pypi.python.org/pypi/mysqlclient)

# math - 求解线性方程

> ID：769
> 
> 赞同：48
> 
> 时间：2008-08-03T18:14:24.267
> 
> 标签：math, linear-algebra, system, linear-equation

我需要以编程方式求解 C、Objective C 或（如果需要）C++ 中的线性方程组。

这是方程的一个例子：

```
-44.3940 = a * 50.0 + b * 37.0 + tx
-45.3049 = a * 43.0 + b * 39.0 + tx
-44.9594 = a * 52.0 + b * 41.0 + tx 
```

由此，我想得到 、 和 的`a`最佳`b`近似值`tx`。

* * *

## 回答 #1

> 赞同：19
> 
> 时间：2008-08-03T18:37:24.003

[Cramer's Rule](http://en.wikipedia.org/wiki/Cramers_rule) 和 [Gaussian Elimination](http://en.wikipedia.org/wiki/Gaussian_elimination) 是两种很好的通用算法（另见[联立线性方程](http://en.wikipedia.org/wiki/Simultaneous_linear_equations)）。如果您正在寻找代码，请查看[GiNaC](http://en.wikipedia.org/wiki/GiNaC)、[Maxima](http://maxima.sourceforge.net/)和[SymbolicC++](http://issc.uj.ac.za/symbolic/symbolic.html)（当然取决于您的许可要求）。

编辑：我知道你在 C 领域工作，但我也必须为[SymPy](http://code.google.com/p/sympy/)（Python 中的计算机代数系统）说一句好话。你可以从它的算法中学到很多东西（如果你能读懂一点 python）。此外，它在新的 BSD 许可下，而大多数免费数学包都是 GPL。

* * *

## 回答 #2

> 赞同：15
> 
> 时间：2009-02-26T10:59:45.617

您可以使用与手动求解完全相同的程序来求解这个问题（使用乘法和减法，然后将结果反馈到方程中）。这是相当标准的中学水平数学。

```
-44.3940 = 50a + 37b + c (A)
-45.3049 = 43a + 39b + c (B)
-44.9594 = 52a + 41b + c (C)

(A-B): 0.9109 =  7a -  2b (D)
(B-C): 0.3455 = -9a -  2b (E)

(D-E): 1.2564 = 16a (F)

(F/16):  a = 0.078525 (G)

Feed G into D:
       0.9109 = 7a - 2b
    => 0.9109 = 0.549675 - 2b (substitute a)
    => 0.361225 = -2b (subtract 0.549675 from both sides)
    => -0.1806125 = b (divide both sides by -2) (H)

Feed H/G into A:
       -44.3940 = 50a + 37b + c
    => -44.3940 = 3.92625 - 6.6826625 + c (substitute a/b)
    => -41.6375875 = c (subtract 3.92625 - 6.6826625 from both sides) 
```

所以你最终得到：

```
a =   0.0785250
b =  -0.1806125
c = -41.6375875 
```

如果将这些值重新插入 A、B 和 C，您会发现它们是正确的。

诀窍是使用一个简单的 4x3 矩阵，该矩阵依次减少为 3x2 矩阵，然后是“a = n”的 2x1，n 是实际数字。一旦你有了它，你将它输入下一个矩阵以获得另一个值，然后将这两个值输入下一个矩阵，直到你解决了所有变量。

如果你有 N 个不同的方程，你总是可以求解 N 个变量。我说不同是因为这两个不是：

```
 7a + 2b =  50
14a + 4b = 100 
```

它们是*相同*的等式乘以 2，因此您无法从中获得解决方案 - 将第一个乘以 2，然后减去，您会得到真实但无用的陈述：

```
0 = 0 + 0 
```

* * *

例如，这里有一些 C 代码可以计算出您在问题中的联立方程。首先是一些必要的类型、变量、打印方程的支持函数，以及 的开头`main`：

```
#include <stdio.h>

typedef struct { double r, a, b, c; } tEquation;
tEquation equ1[] = {
    { -44.3940,  50, 37, 1 },      // -44.3940 = 50a + 37b + c (A)
    { -45.3049,  43, 39, 1 },      // -45.3049 = 43a + 39b + c (B)
    { -44.9594,  52, 41, 1 },      // -44.9594 = 52a + 41b + c (C)
};
tEquation equ2[2], equ3[1];

static void dumpEqu (char *desc, tEquation *e, char *post) {
    printf ("%10s: %12.8lf = %12.8lfa + %12.8lfb + %12.8lfc (%s)\n",
        desc, e->r, e->a, e->b, e->c, post);
}

int main (void) {
    double a, b, c; 
```

接下来，将三个具有三个未知数的方程简化为两个具有两个未知数的方程：

```
 // First step, populate equ2 based on removing c from equ.

    dumpEqu (">", &(equ1[0]), "A");
    dumpEqu (">", &(equ1[1]), "B");
    dumpEqu (">", &(equ1[2]), "C");
    puts ("");

    // A - B
    equ2[0].r = equ1[0].r * equ1[1].c - equ1[1].r * equ1[0].c;
    equ2[0].a = equ1[0].a * equ1[1].c - equ1[1].a * equ1[0].c;
    equ2[0].b = equ1[0].b * equ1[1].c - equ1[1].b * equ1[0].c;
    equ2[0].c = 0;

    // B - C
    equ2[1].r = equ1[1].r * equ1[2].c - equ1[2].r * equ1[1].c;
    equ2[1].a = equ1[1].a * equ1[2].c - equ1[2].a * equ1[1].c;
    equ2[1].b = equ1[1].b * equ1[2].c - equ1[2].b * equ1[1].c;
    equ2[1].c = 0;

    dumpEqu ("A-B", &(equ2[0]), "D");
    dumpEqu ("B-C", &(equ2[1]), "E");
    puts (""); 
```

接下来，将两个有两个未知数的方程简化为一个有一个未知数的方程：

```
 // Next step, populate equ3 based on removing b from equ2.

    // D - E
    equ3[0].r = equ2[0].r * equ2[1].b - equ2[1].r * equ2[0].b;
    equ3[0].a = equ2[0].a * equ2[1].b - equ2[1].a * equ2[0].b;
    equ3[0].b = 0;
    equ3[0].c = 0;

    dumpEqu ("D-E", &(equ3[0]), "F");
    puts (""); 
```

现在我们有了 类型的公式`number1 = unknown * number2`，我们可以简单地用 计算未知值`unknown <- number1 / number2`。然后，一旦您计算出该值，将其代入具有两个未知数的方程之一，并计算出第二个值。然后将这两个（现在已知的）未知数代入原始方程之一，您现在拥有所有三个未知数的值：

```
 // Finally, substitute values back into equations.

    a = equ3[0].r / equ3[0].a;
    printf ("From (F    ), a = %12.8lf (G)\n", a);

    b = (equ2[0].r - equ2[0].a * a) / equ2[0].b;
    printf ("From (D,G  ), b = %12.8lf (H)\n", b);

    c = (equ1[0].r - equ1[0].a * a - equ1[0].b * b) / equ1[0].c;
    printf ("From (A,G,H), c = %12.8lf (I)\n", c);

    return 0;
} 
```

该代码的输出与此答案中的早期计算相匹配：

```
 >: -44.39400000 =  50.00000000a +  37.00000000b +   1.00000000c (A)
         >: -45.30490000 =  43.00000000a +  39.00000000b +   1.00000000c (B)
         >: -44.95940000 =  52.00000000a +  41.00000000b +   1.00000000c (C)

       A-B:   0.91090000 =   7.00000000a +  -2.00000000b +   0.00000000c (D)
       B-C:  -0.34550000 =  -9.00000000a +  -2.00000000b +   0.00000000c (E)

       D-E:  -2.51280000 = -32.00000000a +   0.00000000b +   0.00000000c (F)

From (F    ), a =   0.07852500 (G)
From (D,G  ), b =  -0.18061250 (H)
From (A,G,H), c = -41.63758750 (I) 
```

* * *

## 回答 #3

> 赞同：7
> 
> 时间：2008-08-08T17:59:27.907

对于 3x3 线性方程组，我想推出自己的算法是可以的。

但是，您可能不得不担心准确性、除以零或非常小的数字以及如何处理无限多的解决方案。我的建议是使用标准的数值线性代数包，例如[LAPACK](http://en.wikipedia.org/wiki/Lapack)。

* * *

## 回答 #4

> 赞同：7
> 
> 时间：2009-04-21T03:33:42.160

看看[Microsoft Solver Foundation](http://code.msdn.microsoft.com/solverfoundation)。

有了它，您可以编写如下代码：

```
 SolverContext context = SolverContext.GetContext();
  Model model = context.CreateModel();

  Decision a = new Decision(Domain.Real, "a");
  Decision b = new Decision(Domain.Real, "b");
  Decision c = new Decision(Domain.Real, "c");
  model.AddDecisions(a,b,c);
  model.AddConstraint("eqA", -44.3940 == 50*a + 37*b + c);
  model.AddConstraint("eqB", -45.3049 == 43*a + 39*b + c);
  model.AddConstraint("eqC", -44.9594 == 52*a + 41*b + c);
  Solution solution = context.Solve();
  string results = solution.GetReport().ToString();
  Console.WriteLine(results); 
```

**这是输出：**
===求解器基础服务报告===
日期时间：04/20/2009 23:29:55
模型名称：
请求的默认功能：LP
求解时间（毫秒）：1027
总时间（毫秒）：1414
求解完成状态：
选择的最佳求解器：Microsoft.SolverFoundation.Solvers.SimplexSolver
指令：
Microsoft.SolverFoundation.Services.Directive
算法：原始
算术：混合
定价（精确）：默认
定价（双倍）：SteepestEdge
基础：Slack
Pivot Count：3
== =解决方案详细信息===
目标：

决策：
a：0.0785250000000004
b：-0.180612500000001
c：-41.6375875

* * *

## 回答 #5

> 赞同：3
> 
> 时间：2008-08-03T18:27:13.180

您是否正在寻找可以完成工作或实际执行矩阵运算等并执行每个步骤的软件包？

第一个，我的一个同事刚刚使用了[Ocaml GLPK](http://ocaml-glpk.sourceforge.net/ "Ocaml GLPK")。它只是[GLPK](http://www.gnu.org/software/glpk/ "GNU 线性规划工具包")的包装器，但它删除了许多设置步骤。不过，看起来您将不得不坚持使用 C 语言中的 GLPK。对于后者，感谢delicious保存了我前段时间学习LP的一篇旧文章，[PDF](http://www.math.ucla.edu/~tom/LP.pdf "线性规划")。如果您需要进一步设置的具体帮助，请告诉我们，我敢肯定，我或其他人会回来提供帮助，但是，我认为从这里开始是相当直接的。祝你好运！

* * *

## 回答 #6

> 赞同：3
> 
> 时间：2008-08-25T18:53:32.837

[NIST 的Template Numerical Toolkit](http://math.nist.gov/tnt/download.html)具有执行此操作的工具。

一种更可靠的方法是使用[QR Decomposition](http://en.wikipedia.org/wiki/QR_decomposition)。

这是一个包装器的示例，以便我可以在我的代码中调用“GetInverse(A, InvA)”，它将逆向 InvA。

```
void GetInverse(const Array2D<double>& A, Array2D<double>& invA)
   {
   QR<double> qr(A);  
   invA = qr.solve(I); 
   } 
```

Array2D 在库中定义。

* * *

## 回答 #7

> 赞同：3
> 
> 时间：2008-09-19T03:36:13.207

在运行时效率方面，其他人的回答比我好。如果你总是有相同数量的方程作为变量，我喜欢[克莱默规则](http://en.wikipedia.org/wiki/Cramer's_rule)，因为它很容易实现。只需编写一个函数来计算矩阵的行列式（或使用已经编写的函数，我相信您可以在那里找到一个），然后将两个矩阵的行列式相除。

* * *

## 回答 #8

> 赞同：2
> 
> 时间：2008-08-25T18:22:48.010

就个人而言，我偏爱[Numerical Recipes](http://www.nr.com/)的算法。（我喜欢 C++ 版本。）

本书将教你为什么这些算法有效，并向你展示这些算法的一些经过良好调试的实现。

当然，你可以盲目地使用[CLAPACK](http://www.netlib.org/clapack/)（我使用它取得了巨大的成功），但我会先手动输入一个高斯消除算法，至少对制作这些算法的工作有一个模糊的概念稳定的。

以后，如果你在做更有趣的线性代数，看看[Octave](http://www.gnu.org/software/octave/)的源代码会回答很多问题。

* * *

## 回答 #9

> 赞同：2
> 
> 时间：2008-09-17T14:22:56.880

从您问题的措辞看来，您的方程式似乎比未知数多，并且您希望最大程度地减少不一致。这通常通过线性回归来完成，它可以最小化不一致性的平方和。根据数据的大小，您可以在电子表格或统计包中执行此操作。R 是一个高质量、免费的包，它可以进行线性回归等。线性回归有很多东西（还有很多陷阱），但对于简单的情况来说它很简单。这是一个使用您的数据的 R 示例。请注意，“tx”是您模型的截距。

```
> y <- c(-44.394, -45.3049, -44.9594)
> a <- c(50.0, 43.0, 52.0)
> b <- c(37.0, 39.0, 41.0)
> regression = lm(y ~ a + b)
> regression

Call:
lm(formula = y ~ a + b)

Coefficients:
(Intercept)            a            b  
  -41.63759      0.07852     -0.18061 
```

* * *

## 回答 #10

> 赞同：1
> 
> 时间：2014-12-30T15:24:38.107

```
function x = LinSolve(A,y)
%
% Recursive Solution of Linear System Ax=y
% matlab equivalent: x = A\y 
% x = n x 1
% A = n x n
% y = n x 1
% Uses stack space extensively. Not efficient.
% C allows recursion, so convert it into C. 
% ----------------------------------------------
n=length(y);
x=zeros(n,1);
if(n>1)
    x(1:n-1,1) = LinSolve( A(1:n-1,1:n-1) - (A(1:n-1,n)*A(n,1:n-1))./A(n,n) , ...
                           y(1:n-1,1) - A(1:n-1,n).*(y(n,1)/A(n,n))); 
    x(n,1) = (y(n,1) - A(n,1:n-1)*x(1:n-1,1))./A(n,n); 
else
    x = y(1,1) / A(1,1);
end 
```

* * *

## 回答 #11

> 赞同：-2
> 
> 时间：2021-09-01T16:22:01.613

对于一般情况，您可以使用 python 和 numpy 进行高斯消除。然后插入值并获取剩余值。

# python - 如何使用 itertools.groupby()？

> ID：773
> 
> 赞同：614
> 
> 时间：2008-08-03T18:27:09.687
> 
> 标签：python, itertools

我一直无法找到关于如何实际使用 Python`itertools.groupby()`函数的可以理解的解释。我想要做的是：

*   取一个列表——在这种情况下，一个对象化元素的子`lxml`元素
*   根据某些标准将其分成几组
*   然后稍后分别迭代这些组中的每一个。

我已经查看[了文档](https://docs.python.org/3/library/itertools.html#itertools.groupby)，但是在尝试将它们应用到简单的数字列表之外时遇到了麻烦。

那么，我该如何使用`itertools.groupby()`？我应该使用另一种技术吗？指向良好的“先决条件”阅读的指针也将不胜感激。

* * *

## 回答 #1

> 赞同：783
> 
> 时间：2008-08-10T18:45:32.430

**重要提示：**您必须先**对数据进行排序**。

* * *

我没有得到的部分是在示例构造中

```
groups = []
uniquekeys = []
for k, g in groupby(data, keyfunc):
   groups.append(list(g))    # Store group iterator as a list
   uniquekeys.append(k) 
```

`k`是当前分组键，并且`g`是一个迭代器，可用于迭代由该分组键定义的组。换句话说，`groupby`迭代器本身返回迭代器。

这是一个示例，使用更清晰的变量名称：

```
from itertools import groupby

things = [("animal", "bear"), ("animal", "duck"), ("plant", "cactus"), ("vehicle", "speed boat"), ("vehicle", "school bus")]

for key, group in groupby(things, lambda x: x[0]):
    for thing in group:
        print("A %s is a %s." % (thing[1], key))
    print("") 
```

这将为您提供输出：

> 熊是一种动物。
> 鸭子是一种动物。
> 
> 仙人掌是一种植物。
> 
> 快艇是一种交通工具。
> 校车是交通工具。

在此示例中，`things`是一个元组列表，其中每个元组中的第一项是第二项所属的组。

该`groupby()`函数有两个参数：（1）要分组的数据和（2）要分组的函数。

在这里，`lambda x: x[0]`告诉`groupby()`使用每个元组中的第一项作为分组键。

在上面的`for`语句中，`groupby`返回三个（键，组迭代器）对 - 每个唯一键一次。您可以使用返回的迭代器来迭代该组中的每个单独项目。

这是一个稍微不同的示例，使用列表推导，使用相同的数据：

```
for key, group in groupby(things, lambda x: x[0]):
    listOfThings = " and ".join([thing[1] for thing in group])
    print(key + "s:  " + listOfThings + ".") 
```

这将为您提供输出：

> 动物：熊和鸭。
> 植物：仙人掌。
> 交通工具：快艇和校车。

* * *

## 回答 #2

> 赞同：134
> 
> 时间：2017-08-25T02:26:21.040

`itertools.groupby`是用于对项目进行分组的工具。

从[docs](https://docs.python.org/3/library/itertools.html#itertools.groupby)中，我们进一步收集了它可能会做什么：

> `# [k for k, g in groupby('AAAABBBCCDAABBB')] --> A B C D A B`
> 
> `# [list(g) for k, g in groupby('AAAABBBCCD')] --> AAAA BBB CC D`

`groupby`对象产生密钥组对，其中组是生成器。

特征

*   A. 将连续的项目组合在一起
*   B. 给定一个排序的可迭代项，对所有出现的项目进行分组
*   C. 指定如何使用*按键功能对项目进行分组* ^*

比较

```
# Define a printer for comparing outputs
>>> def print_groupby(iterable, keyfunc=None):
...    for k, g in it.groupby(iterable, keyfunc):
...        print("key: '{}'--> group: {}".format(k, list(g))) 
```

```
# Feature A: group consecutive occurrences
>>> print_groupby("BCAACACAADBBB")
key: 'B'--> group: ['B']
key: 'C'--> group: ['C']
key: 'A'--> group: ['A', 'A']
key: 'C'--> group: ['C']
key: 'A'--> group: ['A']
key: 'C'--> group: ['C']
key: 'A'--> group: ['A', 'A']
key: 'D'--> group: ['D']
key: 'B'--> group: ['B', 'B', 'B']

# Feature B: group all occurrences
>>> print_groupby(sorted("BCAACACAADBBB"))
key: 'A'--> group: ['A', 'A', 'A', 'A', 'A']
key: 'B'--> group: ['B', 'B', 'B', 'B']
key: 'C'--> group: ['C', 'C', 'C']
key: 'D'--> group: ['D']

# Feature C: group by a key function
>>> # islower = lambda s: s.islower()                      # equivalent
>>> def islower(s):
...     """Return True if a string is lowercase, else False."""   
...     return s.islower()
>>> print_groupby(sorted("bCAaCacAADBbB"), keyfunc=islower)
key: 'False'--> group: ['A', 'A', 'A', 'B', 'B', 'C', 'C', 'D']
key: 'True'--> group: ['a', 'a', 'b', 'b', 'c'] 
```

用途

*   [字谜](https://stackoverflow.com/questions/8181513/finding-and-grouping-anagrams-by-python)（[见笔记本](https://github.com/vterron/EuroPython-2016/blob/master/kung-fu-itertools.ipynb)）
*   [装箱](https://stackoverflow.com/a/45991797/4531270)
*   [将奇数和偶数分组](https://naiquevin.github.io/a-look-at-some-of-pythons-useful-itertools.html)
*   [按值对列表进行分组](https://stackoverflow.com/questions/5695208/group-list-by-values)
*   [删除重复元素](https://stackoverflow.com/questions/56796328/how-to-delete-repeat-elements-in-this-list)
*   [查找数组中重复元素的索引](https://stackoverflow.com/a/44792205/4531270)
*   [将数组拆分为 n 大小的块](https://stackoverflow.com/a/42677465/4531270)
*   [查找两个列表之间的对应元素](https://stackoverflow.com/a/41993784/4531270)
*   [压缩算法](https://youtu.be/iCrOGS1QlB8?t=27m27s)（[见笔记本](https://github.com/vterron/EuroPython-2016/blob/master/kung-fu-itertools.ipynb)）/[运行长度编码](https://stackoverflow.com/questions/25537028/run-length-encoding-in-python-with-list-comprehension/25537050#25537050)
*   [按长度分组字母，按键功能](https://youtu.be/iCrOGS1QlB8?t=29m11s)（[见笔记本](https://github.com/vterron/EuroPython-2016/blob/master/kung-fu-itertools.ipynb)）
*   [超过阈值的连续值](https://youtu.be/iCrOGS1QlB8?t=30m19s)（[见笔记本](https://github.com/vterron/EuroPython-2016/blob/master/kung-fu-itertools.ipynb)）
*   [在列表](https://stackoverflow.com/questions/4628333/converting-a-list-of-integers-into-range-in-python)或[连续项目](https://stackoverflow.com/questions/2154249/identify-groups-of-continuous-numbers-in-a-list)中查找数字范围（请参阅[文档](https://docs.python.org/release/2.4.4/lib/itertools-example.html)）
*   [查找所有相关的最长序列](https://stackoverflow.com/questions/46928922/pythonic-way-to-find-all-potential-longest-sequence)
*   [取满足条件的连续序列](https://stackoverflow.com/a/46752214/4531270)（[见相关帖子](https://stackoverflow.com/a/46432991/4531270)）

*注意：后面的几个例子来自 Víctor Terrón 的 PyCon [（谈话）](https://www.youtube.com/watch?v=iCrOGS1QlB8) [（西班牙语）](https://www.youtube.com/watch?v=4ZIxcdREYVc)，“Kung Fu at Dawn with Itertools”。另请参阅用 C 编写的`groupby` [源代码。](https://github.com/python/cpython/blob/6cca5c8459cc439cb050010ffa762a03859d3051/Modules/itertoolsmodule.c#L11-L375)*

^(* 一个函数，所有项目都通过并比较，影响结果。其他具有关键功能的对象包括 `sorted()`和。`max()``min()`)

* * *

回复

```
# OP: Yes, you can use `groupby`, e.g. 
[do_something(list(g)) for _, g in groupby(lxml_elements, criteria_func)] 
```

* * *

## 回答 #3

> 赞同：73
> 
> 时间：2008-08-03T18:40:09.053

Python 文档中的示例非常简单：

```
groups = []
uniquekeys = []
for k, g in groupby(data, keyfunc):
    groups.append(list(g))      # Store group iterator as a list
    uniquekeys.append(k) 
```

因此，在您的情况下，数据是节点列表，`keyfunc`是您的标准函数的逻辑所在，然后`groupby()`对数据进行分组。

在调用之前，您必须小心按条件**对数据进行排序，**`groupby`否则它将不起作用。`groupby`方法实际上只是遍历一个列表，每当键更改时，它都会创建一个新组。

* * *

## 回答 #4

> 赞同：50
> 
> 时间：2008-08-31T23:27:16.920

groupby 的一个技巧是在一行中运行长度编码：

```
[(c,len(list(cgen))) for c,cgen in groupby(some_string)] 
```

会给你一个 2 元组列表，其中第一个元素是 char，第二个是重复次数。

编辑：请注意，这`itertools.groupby`与 SQL`GROUP BY`语义不同：itertools 不会（通常也不能）提前对迭代器进行排序，因此具有相同“键”的组不会合并。

* * *

## 回答 #5

> 赞同：33
> 
> 时间：2013-01-21T16:54:08.263

另一个例子：

```
for key, igroup in itertools.groupby(xrange(12), lambda x: x // 5):
    print key, list(igroup) 
```

结果是

```
0 [0, 1, 2, 3, 4]
1 [5, 6, 7, 8, 9]
2 [10, 11] 
```

请注意，这`igroup`是一个迭代器（文档称之为子迭代器）。

这对于分块生成器很有用：

```
def chunker(items, chunk_size):
    '''Group items in chunks of chunk_size'''
    for _key, group in itertools.groupby(enumerate(items), lambda x: x[0] // chunk_size):
        yield (g[1] for g in group)

with open('file.txt') as fobj:
    for chunk in chunker(fobj):
        process(chunk) 
```

另一个示例`groupby`- 当键未排序时。在以下示例中， 中的项目`xx`按 中的值分组`yy`。在这种情况下，首先输出一组零，然后输出一组 1，然后再输出一组零。

```
xx = range(10)
yy = [0, 0, 0, 1, 1, 1, 0, 0, 0, 0]
for group in itertools.groupby(iter(xx), lambda x: yy[x]):
    print group[0], list(group[1]) 
```

产生：

```
0 [0, 1, 2]
1 [3, 4, 5]
0 [6, 7, 8, 9] 
```

* * *

## 回答 #6

> 赞同：24
> 
> 时间：2013-11-16T00:39:31.500

警告：

语法 list(groupby(...)) 不会按您想要的方式工作。它似乎破坏了内部迭代器对象，所以使用

```
for x in list(groupby(range(10))):
    print(list(x[1])) 
```

将产生：

```
[]
[]
[]
[]
[]
[]
[]
[]
[]
[9] 
```

取而代之的是 list(groupby(...))，尝试 [(k, list(g)) for k,g in groupby(...)]，或者如果您经常使用该语法，

```
def groupbylist(*args, **kwargs):
    return [(k, list(g)) for k, g in groupby(*args, **kwargs)] 
```

并访问 groupby 功能，同时避免那些讨厌的（对于小数据）迭代器。

* * *

## 回答 #7

> 赞同：12
> 
> 时间：2013-05-07T20:09:46.677

我想举另一个例子，没有排序的 groupby 不起作用。改编自 James Sulak 的示例

```
from itertools import groupby

things = [("vehicle", "bear"), ("animal", "duck"), ("animal", "cactus"), ("vehicle", "speed boat"), ("vehicle", "school bus")]

for key, group in groupby(things, lambda x: x[0]):
    for thing in group:
        print "A %s is a %s." % (thing[1], key)
    print " " 
```

输出是

```
A bear is a vehicle.

A duck is a animal.
A cactus is a animal.

A speed boat is a vehicle.
A school bus is a vehicle. 
```

有两组有车辆，而一个可以预期只有一组

* * *

## 回答 #8

> 赞同：9
> 
> 时间：2009-10-15T15:41:51.620

@CaptSolo，我尝试了您的示例，但是没有用。

```
from itertools import groupby 
[(c,len(list(cs))) for c,cs in groupby('Pedro Manoel')] 
```

输出：

```
[('P', 1), ('e', 1), ('d', 1), ('r', 1), ('o', 1), (' ', 1), ('M', 1), ('a', 1), ('n', 1), ('o', 1), ('e', 1), ('l', 1)] 
```

如您所见，有两个 o 和两个 e，但它们分为不同的组。那时我意识到您需要对传递给 groupby 函数的列表进行排序。因此，正确的用法是：

```
name = list('Pedro Manoel')
name.sort()
[(c,len(list(cs))) for c,cs in groupby(name)] 
```

输出：

```
[(' ', 1), ('M', 1), ('P', 1), ('a', 1), ('d', 1), ('e', 2), ('l', 1), ('n', 1), ('o', 2), ('r', 1)] 
```

请记住，如果列表未排序，则 groupby 功能**将不起作用**！

* * *

## 回答 #9

> 赞同：9
> 
> 时间：2017-08-01T07:14:01.103

> 排序和分组

```
from itertools import groupby

val = [{'name': 'satyajit', 'address': 'btm', 'pin': 560076}, 
       {'name': 'Mukul', 'address': 'Silk board', 'pin': 560078},
       {'name': 'Preetam', 'address': 'btm', 'pin': 560076}]

for pin, list_data in groupby(sorted(val, key=lambda k: k['pin']),lambda x: x['pin']):
...     print pin
...     for rec in list_data:
...             print rec
... 
o/p:

560076
{'name': 'satyajit', 'pin': 560076, 'address': 'btm'}
{'name': 'Preetam', 'pin': 560076, 'address': 'btm'}
560078
{'name': 'Mukul', 'pin': 560078, 'address': 'Silk board'} 
```

* * *

## 回答 #10

> 赞同：7
> 
> 时间：2015-07-27T18:06:30.897

> **如何使用 Python 的 itertools.groupby()？**

您可以使用 groupby 对要迭代的事物进行分组。您给 groupby 一个可迭代对象和一个可选的**键**函数/可调用项，通过该键函数/可调用项来检查从可迭代项中出来的项目，并返回一个迭代器，该迭代器给出键可调用结果和实际项目的二元组另一个可迭代的。从帮助：

```
groupby(iterable[, keyfunc]) -> create an iterator which returns
(key, sub-iterator) grouped by each value of key(value). 
```

这是 groupby 使用协程按计数分组的示例，它使用一个可调用的键（在本例中为`coroutine.send`）来为多次迭代和一个分组的元素子迭代器吐出计数：

```
import itertools

def grouper(iterable, n):
    def coroutine(n):
        yield # queue up coroutine
        for i in itertools.count():
            for j in range(n):
                yield i
    groups = coroutine(n)
    next(groups) # queue up coroutine

    for c, objs in itertools.groupby(iterable, groups.send):
        yield c, list(objs)
    # or instead of materializing a list of objs, just:
    # return itertools.groupby(iterable, groups.send)

list(grouper(range(10), 3)) 
```

印刷

```
[(0, [0, 1, 2]), (1, [3, 4, 5]), (2, [6, 7, 8]), (3, [9])] 
```

* * *

## 回答 #11

> 赞同：5
> 
> 时间：2020-04-05T19:46:07.443

这个基本实现帮助我理解了这个功能。希望它也可以帮助其他人：

```
arr = [(1, "A"), (1, "B"), (1, "C"), (2, "D"), (2, "E"), (3, "F")]

for k,g in groupby(arr, lambda x: x[0]):
    print("--", k, "--")
    for tup in g:
        print(tup[1])  # tup[0] == k 
```

```
-- 1 --
A
B
C
-- 2 --
D
E
-- 3 --
F 
```

* * *

## 回答 #12

> 赞同：5
> 
> 时间：2021-06-22T22:59:17.283

可悲的是，我认为不建议使用`itertools.groupby()`. 安全使用太难了，只需要几行代码就能写出符合预期的东西。

```
def my_group_by(iterable, keyfunc):
    """Because itertools.groupby is tricky to use

    The stdlib method requires sorting in advance, and returns iterators not
    lists, and those iterators get consumed as you try to use them, throwing
    everything off if you try to look at something more than once.
    """
    ret = defaultdict(list)
    for k in iterable:
        ret[keyfunc(k)].append(k)
    return dict(ret) 
```

像这样使用它：

```
def first_letter(x):
    return x[0]

my_group_by('four score and seven years ago'.split(), first_letter) 
```

要得到

```
{'f': ['four'], 's': ['score', 'seven'], 'a': ['and', 'ago'], 'y': ['years']} 
```

* * *

## 回答 #13

> 赞同：4
> 
> 时间：2017-06-18T17:16:54.393

我遇到的一个有用的例子可能会有所帮助：

```
from itertools import groupby

#user input

myinput = input()

#creating empty list to store output

myoutput = []

for k,g in groupby(myinput):

    myoutput.append((len(list(g)),int(k)))

print(*myoutput) 
```

样本输入：14445221

样本输出： (1,1) (3,4) (1,5) (2,2) (1,1)

* * *

## 回答 #14

> 赞同：0
> 
> 时间：2021-10-31T04:03:02.753

```
from random import randint
from itertools import groupby

 l = [randint(1, 3) for _ in range(20)]

 d = {}
 for k, g in groupby(l, lambda x: x):
     if not d.get(k, None):
         d[k] = list(g)
     else:
         d[k] = d[k] + list(g) 
```

上面的代码显示了如何使用 groupby 根据提供的 lambda 函数/键对列表进行分组。唯一的问题是输出没有合并，这可以使用字典轻松解决。

例子：

```
l = [2, 1, 2, 3, 1, 3, 2, 1, 3, 3, 1, 3, 2, 3, 1, 2, 1, 3, 2, 3] 
```

应用 groupby 后，结果将是：

```
for k, g in groupby(l, lambda x:x):
    print(k, list(g))

2 [2]
1 [1]
2 [2]
3 [3]
1 [1]
3 [3]
2 [2]
1 [1]
3 [3, 3]
1 [1]
3 [3]
2 [2]
3 [3]
1 [1]
2 [2]
1 [1]
3 [3]
2 [2]
3 [3] 
```

一旦使用了如上所示的字典，就会得出以下结果，可以轻松地对其进行迭代：

```
{2: [2, 2, 2, 2, 2, 2], 1: [1, 1, 1, 1, 1, 1], 3: [3, 3, 3, 3, 3, 3, 3, 3]} 
```

# asp-classic - ASP, need to use SFTP

> ID：805
> 
> 赞同：17
> 
> 时间：2008-08-03T20:11:26.043
> 
> 标签：asp-classic, sftp

This is ASP classic, not .Net. We have to get a way to SFTP into a server to upload and download a couple of files, kicked off by a user.

What have other people used to do SFTP in ASP classic? Not necessarily opposed to purchasing a control.

* * *

## 回答 #1

> 赞同：8
> 
> 时间：2008-08-03T23:52:47.360

If you have the ability to use WScript.Shell then you can just execute pscp.exe from the [Putty](http://www.chiark.greenend.org.uk/~sgtatham/putty/) package. Obviously this is less then ideal but it will get the job done and let you use SCP/SFTP in classic ASP.

* * *

## 回答 #2

> 赞同：3
> 
> 时间：2008-08-05T21:13:47.150

The way I have done this is to create a command script file and pass this on the command line via the /b command to psftp.exe. I have also tried this in Perl and have yet to find a neater way of doing it.

There is an issue with this method, in that you already have to have accepted the RSA finger-print. If not, then the script will either wait for user input to accept it or will skip over it if you are running in full batch mode, with a failure. Also, if the server changes so that it's RSA finger-print changes (e.g. a cluster) then you need to re-accept the finger-print again.

Not an ideal method, but the only one I know.

I shall be watching this question incase anyone knows another way.

* * *

## 回答 #3

> 赞同：2
> 
> 时间：2016-04-18T12:13:05.417

There is an issue with this method, in that you already have to have accepted the RSA finger-print. If not, then the script will either wait for user input to accept it or will skip over it if you are running in full batch mode, with a failure. Also, if the server changes so that it's RSA finger-print changes (e.g. a cluster) then you need to re-accept the finger-print again.

* * *

## 回答 #4

> 赞同：1
> 
> 时间：2008-08-06T06:27:19.450

I used to do that with FTP on windows (create a file of commands and shell out FTP.exe)

Xetius I tried to upvote yours and accept your answer too and I received an warning that I needed 25 rep to do that. Sorry.

* * *

## 回答 #5

> 赞同：1
> 
> 时间：2008-08-14T14:57:32.587

I've previously used a component from here: www.weonlydo.com. I didn't find it the easiest piece of kit to develop against but it got the job done in a hurry.

* * *

## 回答 #6

> 赞同：0
> 
> 时间：2020-12-12T14:39:04.897

December 2020 :

*   ASP is dead, it has been superseded by ASP .Net 18 years ago.
*   At this time, the most common way to use SFTP in .Net is to use the [SSH.NET NuGet package](https://github.com/sshnet/SSH.NET/).

Maybe this question should be closed ?

# windows - Visual Studio 安装项目 - 每用户注册表设置

> ID：810
> 
> 赞同：21
> 
> 时间：2008-08-03T20:35:01.987
> 
> 标签：windows, visual-studio, registry, installation

我正在尝试维护一个安装项目`Visual Studio 2003`（是的，它是一个遗留应用程序）。我们目前遇到的问题是我们需要为`HKCU`计算机上的每个用户写入注册表项。它们需要在其中，`HKCU`而不是`HKLM`因为它们是默认用户设置，并且它们确实会根据用户进行更改。我的感觉是

1.  这是不可能的
2.  这不是安装程序应该做的事情，而是应用程序应该做的事情（毕竟在安装后创建用户配置文件时会发生什么？）。

考虑到这一点，我仍然希望在应用程序中尽可能少地进行更改，所以我的问题是，**是否可以为`Visual Studio 2003`安装项目中的每个用户添加注册表项？**

而且，目前该项目列出了五个注册表根键（`HKEY_CLASSES_ROOT, HKEY_CURRENT_USER`、`HKEY_LOCAL_MACHINE`、`HKEY_USERS`和 User/Machine Hive）。我对用户根密钥一无所知，也没有见过用户/机器配置单元。谁能告诉我它们是什么？也许他们可以解决我上面的问题。

* * *

## 回答 #1

> 赞同：6
> 
> 时间：2008-08-03T20:48:47.263

第一：是的，这是属于您指定的确切原因的应用程序中的内容：创建新用户配置文件后会发生什么？当然，如果您使用的是域，则可以在创建时将一些内容放入注册表中，但这并不是真正的用例。应用程序应检查是否有设置，如果没有，则使用默认设置。

话虽如此，可以通过 HKEY_USERS Hive 更改其他用户的密钥。

我没有使用 Visual Studio 2003 安装项目的经验，所以这里有一些（完全不相关的）VBScript 代码，可能只是让您知道在哪里看：

```
const HKEY_USERS = &H80000003
strComputer = "."
Set objReg=GetObject("winmgmts:{impersonationLevel=impersonate}!\\" & strComputer & "\root\default:StdRegProv")
strKeyPath = ""
objReg.EnumKey HKEY_USERS, strKeyPath, arrSubKeys
strKeyPath = "\Software\Microsoft\Windows\CurrentVersion\WinTrust\Trust Providers\Software Publishing"
For Each subkey In arrSubKeys
    objReg.SetDWORDValue HKEY_USERS, subkey & strKeyPath, "State", 146944
Next 
```

（代码由[Jeroen Ritmeijer](http://jritmeijer.spaces.live.com/blog/cns!8A48A27460FB898A!965.entry)提供）

* * *

## 回答 #2

> 赞同：6
> 
> 时间：2008-08-03T21:17:33.557

我猜是因为你想为所有用户设置它，你在某种共享计算机上，它可能在域下运行？

**这里是龙**

假设 Joe 和 Jane 定期登录计算机，那么他们将各自拥有“注册表”。

然后您将安装您的应用程序，安装程序将使用巨大的黑客和恶心的东西来为他们在 HKCU 下设置项目。

然后，鲍勃会出现并登录（他和其他 500 人在域中拥有帐户，因此可以这样做）。他以前从未使用过这台电脑，所以他没有注册表。他第一次登录时，windows 会为他创建一个，但他不会有你的设置。

然后，您的应用程序会崩溃或运行不正确，并且 bob 会大声抱怨 raynixon 公司的那些蹩脚产品。

正确的答案是在您的应用程序中只保留一些默认设置，如果找不到它们，它可以将它们写入注册表。一般的良好做法是，您的应用程序永远不应该依赖注册表，并且应该根据需要为任何注册表条目创建东西，而不仅仅是 HKCU，无论如何

* * *

## 回答 #3

> 赞同：3
> 
> 时间：2008-08-03T20:45:27.350

我正在使用 MSDN 上的这个条目来解决我的解决方案（不知道我以前怎么找不到它）。

用户/机器配置
单元 当用户选择“Just Me”或 HKEY_USERS 配置单元或用户在安装过程中选择“所有人”时，在此配置单元下输入的子键和值将安装在 HKEY_CURRENT_USER 配置单元下。

[MSDN 文章的](http://web.archive.org/web/20100112132447/http://msdn.microsoft.com/en-us/library/x6kd89c5(VS.80).aspx)~~[注册表编辑器存档](http://msdn.microsoft.com/en-us/library/x6kd89c5(VS.80).aspx)~~

* * *

## 回答 #4

> 赞同：2
> 
> 时间：2008-08-03T22:34:06.380

尽管~~[MSDN 文章](http://msdn.microsoft.com/en-us/library/x6kd89c5(VS.80).aspx)~~ [Archive of MSDN Article 中](http://web.archive.org/web/20100112132447/http://msdn.microsoft.com/en-us/library/x6kd89c5(VS.80).aspx) 提到了有关用户/机器 Hive 的内容，但它并没有写入 HKEY_USERS。相反，如果您选择 Just Me，它会写入 HKCU，如果您选择所有人，它会写入 HKLM。

所以我的解决方案是使用用户/机器配置单元，然后在应用程序中检查注册表项是否在 HKCU 中，如果没有，则从 HKLM 复制它们。我知道这可能不是最理想的方法，但它的变化最少。

# algorithm - 有效地获得排序列表的排序总和

> ID：826
> 
> 赞同：20
> 
> 时间：2008-08-03T21:08:54.977
> 
> 标签：algorithm, language-agnostic

你有一个数字的升序列表，你能想到的最有效的算法是获取该列表中每两个数字之和的升序列表。结果列表中的重复项无关紧要，您可以删除它们或根据需要避免它们。

需要明确的是，我对算法感兴趣。随意以您喜欢的任何语言和范式发布代码。

* * *

## 回答 #1

> 赞同：12
> 
> 时间：2008-09-18T21:41:13.387

截至 2018 年的编辑：您可能应该停止阅读此内容。（但我不能删除它，因为它被接受了。）

如果你这样写出总和：

```
1 4  5  6  8  9
---------------
2 5  6  7  9 10
  8  9 10 12 13
    10 11 13 14
       12 14 15
          16 17
             18 
```

你会注意到，由于 M[i,j] <= M[i,j+1] 和 M[i,j] <= M[i+1,j]，那么你只需要检查左上角“角”并选择最低的一个。

例如

*   只有 1 个左上角，选择 2
*   只选1个，选5个
*   6或8，选6
*   7或8，选7
*   9或8，选8
*   9或9，两个都选：）
*   10 或 10 或 10，选择所有
*   12 或 11，选择 11
*   12 或 12，两个都选
*   13 或 13，两个都选
*   14 或 14，两个都选
*   15 或 16，选择 15
*   只有 1 个，选择 16 个
*   只有1个，选17个
*   只有 1 个，选择 18 个

当然，当你有*很多*左上角时，这个解决方案就会下放。

我很确定这个问题是 Ω(n²)，因为你必须计算每个 M[i,j] 的总和——除非有人有更好的求和算法:)

* * *

## 回答 #2

> 赞同：4
> 
> 时间：2008-08-03T23:06:15.443

我认为我将逐步对其进行伪编码并解释我的逻辑，而不是对其进行编码，以便更好的程序员可以在必要时在我的逻辑中戳出漏洞。

第一步，我们从长度为 n 的数字列表开始。对于每个数字，我们需要创建一个长度为 n-1 的列表，因为我们没有向自身添加数字。最后，我们有一个大约在 O(n^2) 时间内生成的排序列表的列表。

```
step 1 (startinglist) 
for each number num1 in startinglist
   for each number num2 in startinglist
      add num1 plus num2 into templist
   add templist to sumlist
return sumlist 
```

在第 2 步中，因为列表是按设计排序的（向已排序列表中的每个元素添加一个数字，列表仍将被排序），我们可以通过将每个列表合并在一起而不是对整个列表进行合并排序来简单地进行合并排序。最后，这应该花费 O(n^2) 时间。

```
step 2 (sumlist) 
create an empty list mergedlist
for each list templist in sumlist
   set mergelist equal to: merge(mergedlist,templist)
return mergedlist 
```

然后，合并方法将是正常的合并步骤，并检查以确保没有重复的总和。我不会写出来，因为任何人都可以查找合并排序。

所以这就是我的解决方案。整个算法是 O(n^2) 时间。随时指出任何错误或改进。

* * *

## 回答 #3

> 赞同：2
> 
> 时间：2008-08-11T14:47:31.227

您可以在 python 的两行中使用

```
allSums = set(a+b for a in X for b in X)
allSums = sorted(allSums) 
```

迭代的成本是`n^2`（可能是集合的额外对数因子？），排序的成本是 s * log(s)，其中 s 是集合的大小。

集合的大小可能与`n*(n-1)/2`例如 if一样大`X = [1,2,4,...,2^n]`。所以如果你想生成这个列表，至少`n^2/2`在最坏的情况下需要，因为这是输出的大小。

但是，如果您想选择结果的前 k 个元素，您可以使用`X+Y`Frederickson 和 Johnson 的排序矩阵选择算法在 O(kn) 中执行此操作（[有关血腥细节，请参见此处）](http://arxiv.org/abs/0804.0936)。尽管这可能可以修改为通过重用计算在线生成它们并为此集合获得一个有效的生成器。

@deuseldorf，Peter`(n!)`我严重怀疑 deuseldorf 的意思是“n 阶乘”而只是“n，（非常兴奋）！”

* * *

## 回答 #4

> 赞同：1
> 
> 时间：2008-08-03T21:36:25.890

我能想到的最好的办法是生成每对总和的矩阵，然后将行合并在一起，a-la 合并排序。我觉得我错过了一些简单的见解，这些见解将揭示一个更有效的解决方案。

我的算法，在 Haskell 中：

```
matrixOfSums list = [[a+b | b <- list, b >= a] | a <- list]

sortedSums = foldl merge [] matrixOfSums

--A normal merge, save that we remove duplicates
merge xs [] = xs
merge [] ys = ys
merge (x:xs) (y:ys) = case compare x y of
    LT -> x:(merge xs (y:ys))
    EQ -> x:(merge xs (dropWhile (==x) ys))
    GT -> y:(merge (x:xs) ys) 
```

我发现了一个小的改进，它更适合基于惰性流的编码。不要成对合并列，而是一次合并所有列。优点是您立即开始获取列表的元素。

```
-- wide-merge does a standard merge (ala merge-sort) across an arbitrary number of lists
-- wideNubMerge does this while eliminating duplicates
wideNubMerge :: Ord a => [[a]] -> [a]
wideNubMerge ls = wideNubMerge1 $ filter (/= []) ls
wideNubMerge1 [] = []
wideNubMerge1 ls = mini:(wideNubMerge rest)
    where mini = minimum $ map head ls
          rest = map (dropWhile (== mini)) ls

betterSortedSums = wideNubMerge matrixOfSums 
```

但是，如果您知道您将使用所有的总和，并且早点获得其中一些没有优势，请使用 ' `foldl merge []`'，因为它更快。

* * *

## 回答 #5

> 赞同：1
> 
> 时间：2008-08-08T23:05:47.057

在 SQL 中：

```
create table numbers(n int not null)
insert into numbers(n) values(1),(1), (2), (2), (3), (4)

select distinct num1.n+num2.n sum2n
from numbers num1
inner join numbers num2 
    on num1.n<>num2.n
order by sum2n 
```

C# LINQ：

```
List<int> num = new List<int>{ 1, 1, 2, 2, 3, 4};
var uNum = num.Distinct().ToList();
var sums=(from num1 in uNum
        from num2 in uNum 
        where num1!=num2
        select num1+num2).Distinct();
foreach (var s in sums)
{
    Console.WriteLine(s);
} 
```

* * *

## 回答 #6

> 赞同：1
> 
> 时间：2008-08-21T18:16:13.800

这个问题已经困扰我大约一天了。惊人的。

无论如何，您不能轻易摆脱它的 n^2 特性，但是您可以在合并方面做得更好，因为您可以限制插入每个元素的范围。

如果您查看您生成的所有列表，它们具有以下形式：

`(a[i], a[j]) | j>=i`

如果你把它翻转 90 度，你会得到：

`(a[i], a[j]) | i<=j`

现在，合并过程应该采用两个列表`i`和`i+1`（对应于第一个成员总是`a[i]`和的列表），您可以通过位置和位置`a[i+1]`绑定范围以将元素`(a[i + 1], a[j])`插入列表。`i``(a[i], a[j])``(a[i + 1], a[j + 1])`

这意味着您应该在`j`. 我不知道（还）你是否也可以利用这一点`j`，但这似乎是可能的。

* * *

## 回答 #7

> 赞同：1
> 
> 时间：2008-09-18T22:15:18.577

无论您做什么，如果没有对输入值的额外限制，您都不会比 O(n^2) 做得更好，因为您必须遍历所有数字对。迭代将主导排序（您可以在 O(n log n) 或更快的时间内完成）。

* * *

## 回答 #8

> 赞同：-4
> 
> 时间：2008-08-03T21:24:56.160

如果你正在寻找一个真正与语言无关的解决方案，那么我认为你会非常失望，因为你会被 for 循环和一些条件所困。但是，如果您将其打开到函数式语言或函数式语言特性（我正在查看您的 LINQ），那么我的同事在这里可以用 Ruby、Lisp、Erlang 等的优雅示例填充此页面。

# c# - 我如何最优雅地将聚合 SQL 的左连接表示为 LINQ 查询

> ID：832
> 
> 赞同：24
> 
> 时间：2008-08-03T21:22:52.717
> 
> 标签：c#, linq, left-join

SQL：

```
SELECT
   u.id,
   u.name,
   isnull(MAX(h.dateCol), '1900-01-01') dateColWithDefault
FROM universe u
LEFT JOIN history h 
   ON u.id=h.id 
   AND h.dateCol<GETDATE()-1
GROUP BY u.Id, u.name 
```

* * *

## 回答 #1

> 赞同：10
> 
> 时间：2008-08-03T21:31:17.863

一种解决方案，尽管将处理 null 值推迟到代码，可能是：

> 昨天的日期时间 = DateTime.Now.Date.AddDays(-1);

```
var collection=
    from u in db.Universe
    select new
    {
        u.id,
        u.name,
        MaxDate =(DateTime?)
       (
           from h in db.History
           where u.Id == h.Id
           && h.dateCol < yesterday
           select h.dateCol 
       ).Max()
    }; 
```

这不会产生完全相同的 SQL，但会提供相同的逻辑结果。将“复杂”的 SQL 查询转换为 LINQ 并不总是那么简单。

* * *

## 回答 #2

> 赞同：1
> 
> 时间：2016-04-18T12:16:03.590

```
var collection=
    from u in db.Universe
    select new
    {
        u.id,
        u.name,
        MaxDate =(DateTime?)
       (
           from h in db.History
           where u.Id == h.Id
           && h.dateCol < yesterday
           select h.dateCol 
       ).Max()
    }; 
```

Just youse the above code and this should work fine!

* * *

## 回答 #3

> 赞同：0
> 
> 时间：2008-08-28T19:09:00.853

这不是您的完整答案，但在左侧连接块上，您可以使用 DefaultIfEmpty 运算符，如下所示：

```
var collection = 
from u in db.Universe
join history in db.History on u.id = history.id into temp
from h in temp.DefaultIfEmpty()
where h.dateCol < DateTime.Now.Date.AddDays(-1)
select u.id, u.name, h.dateCol ?? '1900-01-01' 
```

I haven't had the need to do any `groupby` commands yet, so I left that out as to not send you down the wrong path. Two other quick things to note. I have been unable to actually join on two parameters although as above there are ways to get around it. Also, the ?? operator works really well in place of the `isnull` in SQL.

* * *

## 回答 #4

> 赞同：0
> 
> 时间：2008-09-17T05:28:38.990

You're going to want to use the `join into` construct to create a group query.

```
TestContext db = new TestContext(CreateSparqlTripleStore());
var q = from a in db.Album
        join t in db.Track on a.Name equals t.AlbumName into tracks
        select new Album{Name = a.Name, Tracks = tracks};
foreach(var album in q){
    Console.WriteLine(album.Name);
    foreach (Track track in album.Tracks)
    {
        Console.WriteLine(track.Title);
    }
} 
```

# sql-server - 由多个用户编辑数据库记录

> ID：833
> 
> 赞同：33
> 
> 时间：2008-08-03T21:23:41.077
> 
> 标签：sql-server, database

我设计了数据库表（标准化，在 MS SQL 服务器上），并为一个应用程序创建了一个独立的 Windows 前端，少数用户将使用它来添加和编辑信息。我们将添加一个 Web 界面，以便以后在我们的生产区域进行搜索。

我担心如果两个用户开始编辑相同的记录，那么最后提交更新的用户将是“赢家”，重要信息可能会丢失。我想到了许多解决方案，但我不确定我是否会造成更大的头痛。

1.  什么都不做，希望两个用户永远不会同时编辑同一个记录。*- 可能永远不会发生，但如果发生了怎么办？*
2.  编辑例程可以存储原始数据的副本以及更新，然后在用户完成编辑时进行比较。如果它们不同，则显示用户和确认更新*- 需要存储两份数据。*
3.  添加最后更新的 DATETIME 列并在我们更新时检查它是否匹配，如果不匹配则显示差异。*- 需要在每个相关表中添加新列。*
4.  创建一个编辑表，在用户开始编辑将要检查的记录时注册并防止其他用户编辑同一记录。*- 需要仔细考虑程序流程以防止死锁和记录在用户崩溃程序时被锁定。*

有没有更好的解决方案，还是我应该选择其中之一？

* * *

## 回答 #1

> 赞同：16
> 
> 时间：2008-08-03T21:31:40.187

如果您预计不经常发生冲突，[乐观并发](http://msdn.microsoft.com/en-us/library/aa0416cz.aspx)可能是您最好的选择。

Scott Mitchell 写了一篇关于实现该模式的综合教程：
[实现乐观并发](http://www.asp.net/Learn/data-access/tutorial-21-cs.aspx)

* * *

## 回答 #2

> 赞同：4
> 
> 时间：2008-10-01T08:53:19.470

A classic approach is as follows:

*   add a boolean field , "locked" to each table.
*   set this to false by default.
*   when a user starts editing, you do this:

    *   lock the row (or the whole table if you can't lock the row)
    *   check the flag on the row you want to edit
    *   if the flag is true then
        *   inform the user that they cannot edit that row at the moment
    *   else
        *   set the flag to true
    *   release the lock

    *   when saving the record, set the flag back to false

* * *

## 回答 #3

> 赞同：2
> 
> 时间：2008-08-04T21:54:15.463

@Mark Harrison：SQL Server 不支持该语法 ( `SELECT ... FOR UPDATE`)。

SQL Server 的等价物是`SELECT`语句提示`UPDLOCK`。

有关详细信息，请参阅[SQL Server 联机丛书](http://msdn.microsoft.com/en-us/library/ms187373.aspx)。

* * *

## 回答 #4

> 赞同：2
> 
> 时间：2016-07-14T11:23:05.980

-first create filed (update time) to store last update record -when any user select record save select time, compare between select time and update time field if( update time) > (select time) that mean another user update this record after select record

* * *

## 回答 #5

> 赞同：1
> 
> 时间：2008-08-13T22:32:37.230

另一种选择是测试您正在更改的记录中的值是否与您开始时的值相同：

```
SELECT 
    customer_nm,
    customer_nm AS customer_nm_orig
FROM demo_customer
WHERE customer_id = @p_customer_id 
```

(display the customer_nm field and the user changes it)

```
UPDATE demo_customer
SET customer_nm = @p_customer_name_new
WHERE customer_id = @p_customer_id
AND customer_name = @p_customer_nm_old

IF @@ROWCOUNT = 0
    RAISERROR( 'Update failed: Data changed' ); 
```

You don't have to add a new column to your table (and keep it up to date), but you do have to create more verbose SQL statements and pass *new* and *old* fields to the stored procedure.

It also has the advantage that you are not locking the records - because we all know that records will end up staying locked when they should not be...

* * *

## 回答 #6

> 赞同：1
> 
> 时间：2008-10-01T05:39:22.883

SELECT FOR UPDATE and equivalents are good providing you hold the lock for a microscopic amount of time, but for a macroscopic amount (e.g. the user has the data loaded and hasn't pressed 'save' you should use optimistic concurrency as above. (Which I always think is misnamed - it's more pessimistic than 'last writer wins', which is usually the only other alternative considered.)

* * *

## 回答 #7

> 赞同：0
> 
> 时间：2008-08-04T02:30:09.227

数据库将为您执行此操作。看看“select ... for update”，它就是为这种事情而设计的。它会给你一个选定行的写锁，然后你可以提交或回滚。

* * *

## 回答 #8

> 赞同：0
> 
> 时间：2011-06-24T07:14:00.870

With me, the best way i have a column lastupdate (timetamp datatype). when select and update just compare this value another advance of this solution is that you can use this column to track down the time data has change. I think it is not good if you just create a colum like isLock for check update.

# msbuild - CruiseControl.net、msbuild、/p:OutputPath 和 CCNetArtifactDirectory

> ID：835
> 
> 赞同：17
> 
> 时间：2008-08-03T21:25:09.763
> 
> 标签：msbuild, cruisecontrol.net

我正在尝试设置 CruiseControl.net。到目前为止它工作得很好，但我对 MSBuild 任务有疑问。

根据[文档](http://confluence.public.thoughtworks.org/display/CCNET/MsBuild+Task)，它将 CCNetArtifactDirectory 传递给 MSBuild。但是我该如何使用它呢？

我试过这个：

```
<buildArgs>
   /noconsolelogger /p:OutputPath=$(CCNetArtifactDirectory)\test
</buildArgs> 
```

但这不起作用。实际上，它会因以下错误而终止服务：

> ThoughtWorks.CruiseControl.Core.Config.Preprocessor.EvaluationException：引用未知符号 CCNetArtifactDirectory

文档相当稀疏，google und 主要提供修改 .sln 项目文件，这是我想要避免的，以便以后能够手动构建这个项目——我真的更喜欢 .sln 项目文件`/p:OutputPath`。

* * *

## 回答 #1

> 赞同：6
> 
> 时间：2008-08-04T04:45:12.497

CCNetArtifactDirectory 默认传递给 MSBuild，因此您无需担心。MSBuild 会将构建输出放置在与您指定的工作目录相关的“bin 位置”中。

```
<executable>c:\WINDOWS\Microsoft.NET\Framework\v3.5\MSBuild.exe</executable>
<workingDirectory>C:\data\projects\FooSolution\</workingDirectory>
<projectFile>FooSolution.sln</projectFile>
<buildArgs>/noconsolelogger /p:Configuration=Debug </buildArgs> 
```

因此，在上面的示例中，您的构建输出将放在 C:\data\projects\FooSolution[ProjectName]\bin\Debug 中。如果您想输出到不同的位置，您可能需要查看 CCNET 中的标签。

```
<publishers>
  <xmllogger />
  <buildpublisher>
    <sourceDir>C:\data\projects\FooSolution\FooProject\bin\Debug</sourceDir>
    <publishDir>C:\published\FooSolution\</publishDir>
    <useLabelSubDirectory>false</useLabelSubDirectory>
  </buildpublisher>
</publishers> 
```

这将允许您将输出发布到不同的位置。

* * *

## 回答 #2

> 赞同：5
> 
> 时间：2008-08-04T14:40:20.360

您可以在 MSBuild 脚本本身中使用工件目录变量。这是我现在如何从我的 CC.Net MSBuild 脚本运行 FxCop 的示例（此脚本是 CC.Net 指向的 - 脚本中还有一个“构建”目标，其中包括针对 SLN 的 MSBuild 任务进行实际编译）：

```
<Exec
  Command='FxCopCmd.exe /project:"$(MSBuildProjectDirectory)\FXCopRules.FxCop" /out:"$(CCNetArtifactDirectory)\ProjectName.FxCop.xml"'
  WorkingDirectory="C:\Program Files\Microsoft FxCop 1.35"
  ContinueOnError="true"
  IgnoreExitCode="true"
/> 
```

* * *

## 回答 #3

> 赞同：2
> 
> 时间：2010-02-26T17:29:08.037

像这样的参数`CCNetArtifactDirectory`使用环境变量传递给外部程序。它们在外部程序中可用，但不在`CCNET`配置内部。这常常导致混乱。

您可以改用预处理器常量：

```
<cb:define project.artifactDirectory="C:\foo">
<project>
  <!-- [...] -->
  <artifactDirectory>$(project.artifactDirectory)</artifactDirectory>
  <!-- [...] -->
  <tasks>
    <!-- [...] -->
    <msbuild>
      <!-- [...] -->
      <buildArgs>/noconsolelogger /p:OutputPath=$(project.artifactDirectory)\test</buildArgs>
      <!-- [...] -->
    </msbuild>
    <!-- [...] -->
  </tasks>
  <!-- [...] -->
</project> 
```

# javascript - 如何检测网页中使用了哪一种定义的字体？

> ID：845
> 
> 赞同：152
> 
> 时间：2008-08-03T21:42:37.903
> 
> 标签：javascript, html, css, fonts

假设我的页面中有以下 CSS 规则：

```
body {
    font-family: Calibri, Trebuchet MS, Helvetica, sans-serif;
} 
```

如何检测用户浏览器中使用了哪一种定义的字体？

对于想知道我为什么要这样做的人来说，因为我正在检测的字体包含其他字体中*不可*用的字形。如果用户没有*字体*，那么我希望它显示一个链接，要求用户下载该字体（这样他们就可以使用我的 Web 应用程序和正确的字体）。

目前，我正在为所有用户显示下载字体链接。我只想为*没有*安装正确字体的人显示这个。

* * *

## 回答 #1

> 赞同：80
> 
> 时间：2008-08-03T21:51:44.360

我已经看到它以一种不确定但非常可靠的方式完成。基本上，一个元素被设置为使用特定的字体，并且一个字符串被设置为该元素。如果为元素设置的字体不存在，则采用父元素的字体。所以，他们所做的是测量渲染字符串的宽度。如果它与他们对所需字体的期望相匹配，而不是派生字体，那么它就存在。这不适用于等宽字体。

它来自： [Javascript/CSS 字体检测器（ajaxian.com；2007 年 3 月 12 日）](http://ajaxian.com/archives/javascriptcss-font-detector)

* * *

## 回答 #2

> 赞同：36
> 
> 时间：2011-05-21T17:58:10.617

我编写了一个简单的 JavaScript 工具，您可以使用它来检查是否安装了字体。
它使用简单的技术，并且在大多数情况下应该是正确的。

github上的**[jFont Checker](https://github.com/derek1906/jFont-Checker/)**

* * *

## 回答 #3

> 赞同：11
> 
> 时间：2009-05-20T10:57:24.267

@pat 实际上，Safari 没有给出使用的字体，Safari 总是返回堆栈中的第一个字体，无论是否安装，至少在我的经验中是这样。

```
font-family: "my fake font", helvetica, san-serif; 
```

假设 Helvetica 是已安装/使用的，您将获得：

*   Safari 中的“我的假字体”（我相信其他 webkit 浏览器）。
*   Gecko 浏览器和 IE 中的“my fake font, helvetica, san-serif”。
*   Opera 9 中的“helvetica”，尽管我读到他们正在 Opera 10 中更改它以匹配 Gecko。

我通过了这个问题并创建了[Font Unstack](http://github.com/philoye/fontunstack/tree/master)，它测试堆栈中的每种字体并仅返回第一个安装的字体。它使用@MojoFilter 提到的技巧，但如果安装了多个，则仅返回第一个。尽管它确实受到@tlrobinson 提到的弱点的影响（Windows 会默默地用 Arial 代替 Helvetica 并报告 Helvetica 已安装），但它在其他方面运行良好。

* * *

## 回答 #4

> 赞同：10
> 
> 时间：2008-08-25T22:16:21.723

一种有效的技术是查看元素的计算样式。这在 Opera 和 Firefox 中受支持（我在 safari 中进行了侦察，但尚未测试）。IE（至少 7 个）提供了一种获取样式的方法，但它似乎是样式表中的任何内容，而不是计算样式。有关 quirksmode 的更多详细信息：[获取样式](http://www.quirksmode.org/dom/getstyles.html)

这是一个获取元素中使用的字体的简单函数：

```
/**
 * Get the font used for a given element
 * @argument {HTMLElement} the element to check font for
 * @returns {string} The name of the used font or null if font could not be detected
 */
function getFontForElement(ele) {
    if (ele.currentStyle) { // sort of, but not really, works in IE
        return ele.currentStyle["fontFamily"];
    } else if (document.defaultView) { // works in Opera and FF
        return document.defaultView.getComputedStyle(ele,null).getPropertyValue("font-family");
    } else {
        return null;
    }
} 
```

如果这方面的 CSS 规则是：

```
#fonttester {
    font-family: sans-serif, arial, helvetica;
} 
```

如果安装了 helvetica，则返回 arial，最后返回系统默认无衬线字体的名称。请注意，CSS 声明中的字体顺序很重要。

您还可以尝试的一个有趣的技巧是创建许多具有许多不同字体的隐藏元素，以尝试检测机器上安装了哪些字体。我相信有人可以用这种技术制作一个漂亮的字体统计收集页面。

* * *

## 回答 #5

> 赞同：9
> 
> 时间：2011-10-23T13:32:13.487

一个简化的形式是：

```
function getFont() {
    return document.getElementById('header').style.font;
} 
```

如果您需要更完整的内容，请查看[此](http://www.lalit.org/lab/javascript-css-font-detect/#comment-43)内容。

* * *

## 回答 #6

> 赞同：9
> 
> 时间：2011-11-29T08:40:29.367

有一个简单的解决方案 - 只需使用`element.style.font`：

```
function getUserBrowsersFont() {
    var browserHeader = document.getElementById('header');
    return browserHeader.style.font;
} 
```

此功能将完全满足您的需求。执行时它将返回用户/浏览器的字体类型。希望这会有所帮助。

* * *

## 回答 #7

> 赞同：7
> 
> 时间：2012-01-05T11:19:13.653

另一种解决方案是自动安装字体，`@font-face`这可能不需要检测。

```
@font-face {
  font-family: "Calibri";
  src: url("http://www.yourwebsite.com/fonts/Calibri.eot");
  src: local("Calibri"), url("http://www.yourwebsite.com/fonts/Calibri.ttf") format("truetype");
} 
```

当然，它不会解决任何版权问题，但是您始终可以使用免费软件字体，甚至可以制作自己的字体。您将需要两个`.eot`&`.ttf`文件才能最好地工作。

* * *

## 回答 #8

> 赞同：4
> 
> 时间：2012-11-14T18:56:40.510

Calibri 是 Microsoft 拥有的字体，不应免费分发。此外，要求用户下载特定字体也不是很友好。

我建议购买字体许可证并将其嵌入到您的应用程序中。

* * *

## 回答 #9

> 赞同：2
> 
> 时间：2017-03-13T04:31:09.500

我正在使用字体。您只需将 Fount 按钮拖到书签栏上，单击它，然后单击网站上的特定文本。然后它将显示该文本的字体。

[https://fount.artequalswork.com/](https://fount.artequalswork.com/)

* * *

## 回答 #10

> 赞同：2
> 
> 时间：2017-11-30T10:58:47.953

您可以将[Adob​​e Blank](https://technet.microsoft.com/en-us/library/cc939627.aspx)放在要查看的字体之后的字体系列中，然后不会呈现任何不在该字体中的字形。

例如：

```
font-family: Arial, 'Adobe Blank'; 
```

据我所知，没有 JS 方法可以告诉元素中的哪些字形是由该元素的字体堆栈中的哪种字体呈现的。

这很复杂，因为浏览器具有 serif/sans-serif/monospace 字体的用户设置，并且它们也有自己的硬编码后备字体，如果在任何字体中都找不到字形，它们将使用这些字体。字体堆栈。**因此浏览器可能会以不在字体堆栈或用户浏览器字体设置中的字体呈现某些字形。** [Chrome 开发工具将向您显示所选元素中字形的每种渲染字体](https://developers.google.com/web/updates/2013/09/DevTools-answers-What-font-is-that)。所以在你的机器上你可以看到它在做什么，但是没有办法知道用户机器上发生了什么。

用户的系统也可能在其中发挥作用，例如[Window](https://docs.microsoft.com/en-us/globalization/input/font-technology#font-linking)在字形级别进行字体替换。

所以...

对于您感兴趣的字形，您无法知道它们是否会被用户的浏览器/系统回退呈现，即使它们没有您指定的字体。

如果您想在 JS 中对其进行测试，您可以使用包括 Adob​​e Blank 在内的字体系列渲染单个字形并测量它们的宽度以查看它是否为零，**但是**您必须遍历每个字形和**您想要测试**的每种字体，但是，尽管您可以知道元素字体堆栈中的字体，但无法知道用户的浏览器配置为使用哪些字体，因此至少对于您的一些用户，您迭代的字体列表将是不完整的。（如果新字体出现并开始使用，这也不是未来的证据。）

* * *

## 回答 #11

> 赞同：1
> 
> 时间：2015-04-11T20:41:28.363

你可以使用这个网站：

[http://website-font-analyzer.com/](http://website-font-analyzer.com/)

它完全符合您的要求...

# visual-studio - .Net XML 注释到 API 文档中

> ID：855
> 
> 赞同：21
> 
> 时间：2008-08-03T22:03:37.567
> 
> 标签：visual-studio, xslt, documentation, sandcastle, xml-comments

有没有一种从 Visual Studio XML 输出生成 MSDN 样式文档的简单方法？
我没有足够的耐心来为它设置一个好的 xslt，因为我知道我不是第一个跨过这座桥的人。

另外，我最近尝试设置沙堡，但它确实让我的眼睛交叉。要么我在这个过程中遗漏了一些重要的东西，要么就是太投入了。

我知道有人有一个非常好的非常简单的解决方案。

我在这里重申，因为我认为我的格式使该段落不宜阅读：

> 我尝试了沙堡，但设置起来非常困难。我真正想到的是更简单的事情。

也就是说，除非我只是不了解沙堡过程。对我来说，仅仅为测试人员提供一些可以使用的好东西，这似乎是一大堆额外的包袱。

* * *

## 回答 #1

> 赞同：12
> 
> 时间：2008-08-03T22:12:52.820

你在找沙堡

项目页面：[沙堡发布](http://www.codeplex.com/Sandcastle/Release/ProjectReleases.aspx)

博客：[沙堡博客](http://blogs.msdn.com/sandcastle/default.aspx)

[.NET 的 NDoc 代码文档生成器](http://ndoc.sourceforge.net)曾经是首选工具，但几乎停止了支持。

* * *

## 回答 #2

> 赞同：5
> 
> 时间：2008-08-03T22:14:55.453

看看[Sandcastle](http://blogs.msdn.com/sandcastle/)，它就是这样做的。它也是目前更简单的解决方案之一，它或多或少是首选工具，所以从长远来看，如果您指定在设置过程中遇到的问题，也许我们可以帮助您设置 Sandcastle？

* * *

## 回答 #3

> 赞同：5
> 
> 时间：2008-08-04T10:27:05.270

我刚刚再次设置了 Sandcastle。尝试安装它（2008 年 5 月版本）并搜索 SandcastleGui.exe 或类似的东西（它在示例文件夹中）。

单击 Add Assembly 并添加您的 Assembly 或 Assemblies，添加任何 .xml 文档文件（如果您启用了该选项，则由编译器生成的文件）然后构建。

这将需要一些时间，但结果**将**是值得的。它实际上会从 MSDN 中查找内容，因此您生成的文档也将具有一直到 System.Object 的类继承以及指向 MSDN 和内容的链接。

一开始 Sandcastle 似乎有点复杂，尤其是当您想在自动构建中使用它时，但我绝对相信这将是值得的。

还可以看看[Sandcastle Help File Builder](http://www.codeplex.com/SHFB)，这是一个更高级的 GUI。

* * *

## 回答 #4

> 赞同：5
> 
> 时间：2008-09-19T15:22:17.057

您还应该使用 Sandcastle 帮助文件生成器。它为您提供了一个类似于 GUI 的 ndoc 来生成帮助文件，因此您无需从命令提示符处执行任何操作。

[欢迎来到 Sandcastle 帮助文件生成器项目](http://www.codeplex.com/SHFB)

* * *

## 回答 #5

> 赞同：4
> 
> 时间：2008-08-04T10:31:33.220

按照[这个简单的 5 步文章](http://saftsack.fs.uni-bayreuth.de/~dun3/archives/integrate-xml-code-comments-into-visual-studio-20052008-using-sandcastle-and-html-help-20/150.html)，你就大功告成了。作为奖励，您可以使用[H2Viewer](http://www.helpware.net/mshelp2/h2viewer.htm)查看 Html Help 2.x 文件。

* * *

## 回答 #6

> 赞同：2
> 
> 时间：2010-02-21T22:12:47.673

我使用[NDoc3](http://sourceforge.net/projects/ndoc3/)

# svn - 为什么 Git 比 Subversion 更好？

> ID：871
> 
> 赞同：393
> 
> 时间：2008-08-03T22:38:29.040
> 
> 标签：svn, git

我已经使用[Subversion](http://en.wikipedia.org/wiki/Apache_Subversion)几年了，在使用[SourceSafe](http://en.wikipedia.org/wiki/Microsoft_Visual_SourceSafe)之后，我就是喜欢 Subversion。结合[TortoiseSVN](http://en.wikipedia.org/wiki/TortoiseSVN)，我真的无法想象它会变得更好。

然而，越来越多的开发人员声称 Subversion 存在问题，我们应该转向新型分布式版本控制系统，例如[Git](http://git.or.cz/ "Git 分布式版本控制系统")。

Git 如何改进 Subversion？

* * *

## 回答 #1

> 赞同：547
> 
> 时间：2008-08-03T22:45:44.533

Git并不比Subversion好。但也不差。这是不同的。

主要区别在于它是去中心化的。想象一下，您是一名在路上的开发人员，您在笔记本电脑上进行开发，并且您希望拥有源代码控制，这样您就可以回到 3 个小时。

使用 Subversion，您有一个问题：SVN 存储库可能位于您无法到达的位置（在您的公司中，并且您目前没有互联网），您无法提交。如果要复制代码，则必须逐字复制/粘贴它。

使用 Git，您就没有这个问题。您的本地副本是一个存储库，您可以提交它并获得源代码控制的所有好处。当您重新连接到主存储库时，您可以提交它。

起初这看起来不错，但请记住这种方法增加的复杂性。

Git 似乎是“新的、闪亮的、酷炫的”东西。这绝不是坏事（Linus 为 Linux Kernel 开发写它毕竟是有原因的），但我觉得很多人跳上“分布式源代码控制”火车只是因为它是新的并且是由 Linus Torvalds 编写的，实际上并没有知道为什么/如果它更好。

Subversion 有问题，但 Git、Mercurial、CVS、TFS 或其他什么也有。

**编辑：**所以这个答案现在已经有一年了，仍然会产生很多赞成票，所以我想我会添加更多解释。自撰写本文以来的最后一年，Git 获得了很多动力和支持，尤其是在 GitHub 等网站真正起飞之后。我现在同时使用 Git 和 Subversion，我想分享一些个人见解。

首先，在去中心化工作时，Git 一开始可能会让人感到困惑。什么是遥控器？以及如何正确设置初始存储库？是一开始就提出的两个问题，特别是与 SVN 的简单“svnadmin create”相比，Git 的“git init”可以带参数 --bare 和 --shared 这似乎是设置集中式的“正确”方式存储库。这是有原因的，但它增加了复杂性。“checkout”命令的文档对于转换的人来说非常混乱——“正确”的方式似乎是“git clone”，而“git checkout”似乎是切换分支。

当你去中心化时，Git 真的会发光。我家里有一台服务器，路上有一台笔记本电脑，而 SVN 在这里根本无法正常工作。使用 SVN，如果我没有连接到存储库，我将无法进行本地源代码控制（是的，我知道 SVK 或复制存储库的方法）。无论如何，对于 Git，这都是默认模式。虽然这是一个额外的命令（git commit 在本地提交，而 git push origin master 将 master 分支推送到名为“origin”的远程）。

如上所述：Git 增加了复杂性。创建存储库的两种模式，签出与克隆，提交与推送...您必须知道哪些命令在本地工作，哪些与“服务器”一起工作（我假设大多数人仍然喜欢中央“主存储库” ）。

此外，工具仍然不足，至少在 Windows 上是这样。是的，有一个 Visual Studio 插件，但我仍然使用 git bash 和 msysgit。

SVN 的优势在于它更易于学习：有你的存储库，所有对它的更改，如果你知道如何创建、提交和签出，并且你已经准备好并且可以稍后获取分支、更新等内容在。

Git 的优势在于，如果某些开发人员并不总是连接到主存储库，它会更适合。此外，它比 SVN 快得多。据我所知，分支和合并支持要好得多（这是意料之中的，因为这些是编写它的核心原因）。

这也解释了为什么它在 Internet 上引起了如此多的关注，因为 Git 非常适合开源项目：只需 Fork 它，将您的更改提交到您自己的 Fork，然后请原始项目维护者拉取您的更改。使用 Git，这很有效。真的，在 Github 上试试，很神奇。

我还看到了 Git-SVN 桥接器：中央存储库是一个 Subversion 存储库，但开发人员在本地使用 Git，然后桥接器将他们的更改推送到 SVN。

但即使有这么长的补充，我仍然坚持我的核心信息：Git 没有好坏之分，它只是不同。如果您需要“离线源代码管理”并且愿意花一些额外的时间来学习它，那就太棒了。但是，如果您有一个严格集中的源代码控制和/或因为您的同事不感兴趣而首先努力引入源代码控制，那么 SVN 的简单性和出色的工具（至少在 Windows 上）会大放异彩。

* * *

## 回答 #2

> 赞同：145
> 
> 时间：2008-08-04T00:24:15.940

使用 Git，您几乎可以离线做任何事情，因为每个人都有自己的存储库。

创建分支和分支之间的合并非常容易。

即使您没有项目的提交权限，您仍然可以拥有自己的在线存储库，并为您的补丁发布“推送请求”。每个喜欢您的补丁的人都可以将它们拉入他们的项目，包括官方维护者。

分叉一个项目，修改它，然后继续合并来自 HEAD 分支的错误修复是微不足道的。

Git 适用于 Linux 内核开发人员。这意味着它非常快（必须如此），并且可以扩展到成千上万的贡献者。Git 使用的空间也更少（Mozilla 存储库的空间最多减少 30 倍）。

Git 非常灵活，非常 TIMTOWTDI（有不止一种方法可以做到）。你可以使用任何你想要的工作流程，Git 会支持它。

最后，还有[GitHub](http://en.wikipedia.org/wiki/GitHub)，这是一个托管 Git 存储库的绝佳站点。

Git的缺点：

*   它更难学习，因为 Git 有更多的概念和更多的命令。
*   修订版没有 subversion 中的版本号
*   很多 Git 命令都是晦涩难懂的，而且错误信息对用户非常不友好
*   它缺乏一个好的 GUI（比如伟大的[TortoiseSVN](http://en.wikipedia.org/wiki/TortoiseSVN)）

* * *

## 回答 #3

> 赞同：110
> 
> 时间：2008-09-26T00:18:38.620

其他答案很好地解释了 Git 的核心功能（很棒）。但是还有很多*小*方法可以让 Git 表现得更好，并帮助我的生活更加理智。以下是一些小事：

1.  Git 有一个“干净”的命令。SVN 迫切需要这个命令，考虑到它会多频繁地在您的磁盘上转储额外文件。
2.  Git 有 'bisect' 命令。这真好。
3.  SVN 在每个文件夹中创建 .svn 目录（Git 只创建*一个*.git 目录）。您编写的每个脚本和执行的每个 grep 都需要编写以忽略这些 .svn 目录。您还需要一个完整的命令（“svn export”）来获得文件的健全副本。
4.  在 SVN 中，每个文件和文件夹都可以来自不同的修订版或分支。起初，拥有这种自由听起来不错。但这实际上意味着您的本地结帐有上百万种不同的方式可以完全搞砸。（例如，如果“svn switch”中途失败，或者输入错误的命令）。最糟糕的是：如果您遇到一些文件来自一个地方，而其中一些来自另一个地方的情况，“svn 状态”会告诉您一切正常。您需要在每个文件/目录上执行“svn info”以发现事情有多奇怪。如果“git status”告诉你事情很正常，那么你可以相信事情真的很正常。
5.  每当您移动或删除某些内容时，您都必须告诉 SVN。Git 会弄清楚的。
6.  在 Git 中忽略语义更容易。如果您忽略一个模式（例如 *.pyc），它将被*所有*子目录忽略。（但如果你真的想忽略一个目录的东西，你可以）。使用 SVN，似乎没有简单的方法可以忽略所有子目录中的模式。
7.  另一个涉及忽略文件的项目。Git 可以进行“私人”忽略设置（使用文件 .git/info/exclude），这不会影响其他任何人。

* * *

## 回答 #4

> 赞同：56
> 
> 时间：2009-02-10T04:18:46.543

“[为什么 Git 比 X 更好](http://whygitisbetterthanx.com/#svn)”概述了 Git 与其他 SCM 相比的各种优缺点。

简要地：

*   Git 跟踪**内容而不是文件**
*   **分支是轻量级的**，合并很*容易*，我的意思是*非常容易*。
*   它是分布式的，基本上每个存储库都是一个分支。在我看来，与 Subversion 相比，并发和协作开发要容易得多。它还使**离线**开发成为可能。
*   它**不强加任何工作流**，如[上面链接的网站](http://whygitisbetterthanx.com/#svn)上所见，Git 有许多工作流可能。Subversion 风格的工作流程很容易被模仿。
*   Git 存储库的**文件大小**比 Subversion 存储库小得多。只有一个“.git”目录，而不是几十个“.svn”存储库（注意 Subversion 1.7 和更高版本现在使用像 Git 这样[的单个目录。）](http://subversion.apache.org/docs/release-notes/1.7.html#wc-ng)
*   **暂存**区很棒，它允许您查看您将提交的更改、提交部分更改并执行各种其他操作。
*   **当您进行“混乱”开发时，或者只是想在您仍在处理其他事情（在不同的分支上）时修复错误时，存储是非常宝贵的**。****
***   您可以**重写历史**，这对于准备补丁集和修复错误非常有用（*在*您发布提交之前）*   ……还有*更多*。**

 **有一些缺点：

*   还没有很多好的GUI。它是新的，Subversion 已经存在了很长时间，所以这是很自然的，因为有一些接口正在开发中。一些不错的包括[TortoiseGit](http://code.google.com/p/tortoisegit/)和[GitHub for Mac](http://mac.github.com/)。
*   ~~目前无法部分签出/克隆存储库（我读到它正在开发中）。但是，有子模块支持。~~ [Git 1.7+ 支持稀疏检出](http://www.kernel.org/pub/software/scm/git/docs/RelNotes-1.7.0.txt)。
*   即使我没有发现这种情况（大约一年前），它也可能更难学习。Git 最近改进了它的界面并且非常用户友好。

在最简单的用法中，Subversion 和 Git 几乎相同。之间没有太大区别：

```
svn checkout svn://foo.com/bar bar
cd bar
# edit
svn commit -m "foo" 
```

和

```
git clone git@github.com:foo/bar.git
cd bar
# edit
git commit -a -m "foo"
git push 
```

Git 真正闪耀的地方是分支和与其他人一起工作。

* * *

## 回答 #5

> 赞同：54
> 
> 时间：2008-08-03T22:44:26.203

Google 技术讲座：关于 git 的 Linus Torvalds

[http://www.youtube.com/watch?v=4XpnKHJAok8](http://www.youtube.com/watch?v=4XpnKHJAok8)

Git Wiki 的比较页面

[http://git.or.cz/gitwiki/GitSvnComparsion](http://git.or.cz/gitwiki/GitSvnComparsion)

* * *

## 回答 #6

> 赞同：26
> 
> 时间：2008-08-03T22:47:42.703

嗯，已经分发了。基准测试表明它要快得多（考虑到它的分布式特性，差异和日志等操作都是本地的，所以在这种情况下它当然要快得多），并且工作文件夹更小（这仍然让我大吃一惊）。

当您在处理 subversion 或任何其他客户端/服务器修订控制系统时，您实际上是通过*签出*修订在您的机器上创建工作副本。这代表了存储库外观的时间快照。您通过更新更新工作副本，并通过提交更新存储库。

使用分布式版本控制，您没有快照，而是整个代码库。想与 3 个月大的版本进行比较吗？没问题，3 个月大的版本仍在您的计算机上。这不仅意味着事情要快得多，而且如果您与中央服务器断开连接，您仍然可以执行许多您习惯的操作。换句话说，您不仅拥有给定版本的快照，还拥有整个代码库。

你会认为 Git 会占用你硬盘上的大量空间，但从我见过的几个基准测试来看，它实际上占用的空间更少。不要问我怎么做。我的意思是，它是由 Linus 构建的，我猜他对文件系统略知一二。

* * *

## 回答 #7

> 赞同：22
> 
> 时间：2008-09-04T11:06:59.397

我喜欢 DVCS 的要点是：

1.  你可以犯下坏事。没关系，因为在您发布之前，其他人不会看到它们。发布时间与提交时间不同。
2.  因此，您可以更频繁地提交。
3.  您可以合并完整的功能。此功能将有自己的分支。此分支的所有提交都将与此功能相关。您可以使用 CVCS 执行此操作，但默认使用 DVCS。
4.  您可以搜索您的历史记录（查找功能何时更改）
5.  如果有人搞砸了主存储库，您可以撤消拉取操作，您不需要修复错误。只需清除合并。
6.  当您需要在任何目录中进行源代码控制时，请执行以下操作：git init。您可以提交、撤消更改等...
7.  它很快（即使在 Windows 上）

一个相对大的项目的主要原因是第 3 点创造的更好的沟通。其他都是不错的奖励。

* * *

## 回答 #8

> 赞同：15
> 
> 时间：2008-10-02T13:05:58.340

有趣的是：我在 Subversion Repos 中托管项目，但通过 Git Clone 命令访问它们。

请阅读[在 Google 代码项目中使用 Git 进行开发](http://google-opensource.blogspot.com/2008/05/develop-with-git-on-google-code-project.html)

> 尽管 Google Code 原生使用 Subversion，但您可以在开发过程中轻松使用 Git。搜索“git svn”表明这种做法很普遍，我们也鼓励您尝试一下。

在 Svn 存储库上使用 Git 给我带来了好处：

1.  我可以在多台机器上进行*分布式*工作，向它们提交和拉取
2.  我有一个*中央* `backup/public`svn 存储库供其他人查看
3.  他们可以自由地为自己使用 Git

* * *

## 回答 #9

> 赞同：11
> 
> 时间：2009-10-13T07:01:50.840

这里的所有答案都符合预期，以程序员为中心，但是如果您的公司在源代码之外使用修订控制会发生什么？有很多不是源代码的文档可以从版本控制中受益，并且应该靠近代码而不是在另一个 CMS 中。大多数程序员不会孤立地工作——我们作为团队的一部分为公司工作。

考虑到这一点，比较 Subversion 和 git 在客户端工具和培训方面的易用性。*我看不到任何*分布式修订控制系统将更容易使用或向非程序员解释的场景。我很想被证明是错误的，因为这样我就能够评估 git 并且实际上希望它被那些需要版本控制但不是程序员的人所接受。

即便如此，如果管理层问我们为什么要从集中式版本控制系统转向分布式版本控制系统，我也很难给出诚实的答案，因为我们不需要它。

免责声明：我很早就对 Subversion 产生了兴趣（大约在 v0.29 左右），所以显然我有偏见，但是从那时起我工作的公司都从我的热情中受益，因为我鼓励并支持它的使用。我怀疑这就是大多数软件公司的情况。有这么多程序员加入 git 的潮流，我想知道有多少公司会错过在源代码之外使用版本控制的好处？即使您为不同的团队使用不同的系统，您也会错过一些好处，例如（统一的）问题跟踪集成，同时增加了维护、硬件和培训要求。

* * *

## 回答 #10

> 赞同：9
> 
> 时间：2008-09-18T18:44:51.487

Subversion 仍然是一个更常用的版本控制系统，这意味着它有更好的工具支持。你会发现几乎所有[IDE](http://en.wikipedia.org/wiki/Integrated_development_environment)都有成熟的 SVN 插件，并且有很好的资源管理器扩展可用（比如 TurtoiseSVN）。除此之外，我必须同意[Michael](https://stackoverflow.com/questions/871?sort=votes#875)的观点：Git 并不比 Subversion 好或差，它是不同的。

* * *

## 回答 #11

> 赞同：8
> 
> 时间：2008-08-22T15:24:44.907

SubVersion 让我恼火的一件事是它在项目的每个目录中都放置了自己的文件夹，而 git 只在根目录中放置了一个文件夹。这没什么大不了的，但是像这样的小事情加起来*。*

当然，SubVersion 有 Tortoise，[通常] 非常好。

* * *

## 回答 #12

> 赞同：8
> 
> 时间：2010-09-17T18:22:30.390

[David Richards WANdisco 关于 Subversion / GIT 的博客](http://blogs.wandisco.com/2010/09/08/why-we-got-so-heavily-involved-in-the-subversion-project/)

> GIT 的出现带来了一批 DVCS 原教旨主义者——“Gitterons”——他们认为除了 GIT 之外的任何东西都是垃圾。Gitterons 似乎认为软件工程发生在他们自己的岛屿上，并且经常忘记大多数组织并不专门雇用高级软件工程师。没关系，但这不是市场其他人的想法，我很高兴证明这一点：GIT，最后看起来不到 3% 的市场，而 Subversion 拥有大约 500 万用户和大约一半的市场整体市场。
> 
> 我们看到的问题是 Gitterons 正在向 Subversion 开火（廉价）。像“颠覆是如此[缓慢/蹩脚/限制/闻起来不好/以一种有趣的方式看着我]的推文，现在我有GIT和[我生活中的一切正常/我妻子怀孕了/之后我有了女朋友30 年的尝试/我在二十一点桌上赢得了六次]。你得到图片。

* * *

## 回答 #13

> 赞同：7
> 
> 时间：2008-08-09T03:22:14.510

Git 还使分支和合并变得非常容易。Subversion 1.5 刚刚添加了合并跟踪，但 Git 仍然更好。使用 Git 分支非常快速且便宜。它使为每个新功能创建一个分支更加可行。哦，与 Subversion 相比，Git 存储库在存储空间方面非常有效。

* * *

## 回答 #14

> 赞同：6
> 
> 时间：2008-08-03T23:38:05.113

这一切都与做某事所需的易用性/步骤有关。

如果我在我的 PC/笔记本电脑上开发单个项目，git 更好，因为它更容易设置和使用。您不需要服务器，也不需要在进行合并时继续输入存储库 URL。

如果只有 2 个人，我会说 git 也更容易，因为你可以互相推拉。

不过，一旦你超越了这一点，我就会去颠覆，因为那时你需要设置一个“专用”服务器或位置。

使用 git 和使用 SVN 一样可以做到这一点，但是 git 的好处被需要执行额外的步骤来与中央服务器同步所抵消。在 SVN 中，您只需提交即可。在 git 中，你必须先 git commit，然后再 git push。额外的步骤变得烦人只是因为你最终做了这么多。

SVN 还具有更好的 GUI 工具的好处，但是 git 生态系统似乎正在迅速赶上，所以从长远来看，我不会担心这一点。

* * *

## 回答 #15

> 赞同：6
> 
> 时间：2008-08-22T15:19:57.163

[Easy Git](http://www.gnome.org/~newren/eg/)有一个很好的页面，它比较了[Git 和 SVN](http://www.gnome.org/~newren/eg/git-for-svn-users.html)的实际使用情况，它可以让您了解 Git 与 SVN 相比可以做什么（或更容易做）。（从技术上讲，这是基于 Easy Git，它是 Git 之上的轻量级包装器。）

* * *

## 回答 #16

> 赞同：5
> 
> 时间：2008-08-03T23:08:23.580

一般来说，Git 和 DVCS 非常适合开发人员相互独立地进行大量编码，因为每个人都有自己的分支。但是，如果您需要其他人的更改，她必须提交到她的本地存储库，然后她必须将该更改集推送给您，或者您必须从她那里拉取它。

我自己的推理也让我认为，如果你做集中发布之类的事情，DVCS 会让 QA 和发布管理变得更加困难。必须有人负责从其他人的存储库中进行推送/拉取，解决在初始提交时间之前已经解决的任何冲突，然后进行构建，然后让所有其他开发人员重新同步他们的存储库。

当然，所有这些都可以通过人工流程来解决。DVCS 刚刚打破了集中版本控制修复的一些问题，以提供一些新的便利。

* * *

## 回答 #17

> 赞同：5
> 
> 时间：2008-10-05T16:52:34.693

我喜欢 Git，因为它实际上可以帮助大中型团队中的开发人员与开发人员进行交流。作为一个分布式版本控制系统，通过其推/拉系统，它帮助开发人员创建一个源代码生态系统，帮助管理大量开发人员在单个项目上工作。

例如，假设您信任 5 个开发人员，并且只从他们的存储库中提取代码。这些开发人员中的每一个都有自己的信任网络，他们从中提取代码。因此，开发基于开发人员的信任结构，其中代码责任在开发社区之间共享。

当然，这里的其他答案中提到了其他好处。

* * *

## 回答 #18

> 赞同：4
> 
> 时间：2009-08-07T14:59:17.853

一些答案暗示了这些，但我想明确指出两点：

1) 进行选择性提交的能力（例如，`git add --patch`）。如果您的工作目录包含不属于同一逻辑更改的多个更改，Git 可以很容易地进行仅包含部分更改的提交。使用 Subversion，这很困难。

2) 在不公开更改的情况下提交的能力。在 Subversion 中，任何提交都是立即公开的，因此是不可撤销的。这极大地限制了开发者“早提交，常提交”的能力。

Git 不仅仅是一个 VCS。它也是开发补丁的工具。Subversion 只是一个 VCS。

* * *

## 回答 #19

> 赞同：4
> 
> 时间：2010-07-27T15:40:33.973

我认为 Subversion 很好.. 直到您开始合并.. 或做任何复杂的事情.. 或做任何 Subversion 认为复杂的事情（例如查询哪些分支与特定文件混淆，更改*实际*来自何处，检测复制和粘贴， ETC）...

我不同意获胜的答案，说 GIT 的*主要好处*是离线工作 - 它当然很有用，但它更像是我的用例的额外内容。SVK 也可以离线工作，我仍然毫无疑问将学习时间投入到哪一个上）。

只是它非常强大和快速，而且——在习惯了这些概念之后——非常有用（是的，从这个意义上说：用户友好）。

有关合并故事的更多详细信息，请参见： [Using git-svn (or similar) *just* to help out with an svn merge?](https://stackoverflow.com/questions/2945842/using-git-svn-or-similar-just-to-help-out-with-svn-merge/2981745#2981745)

* * *

## 回答 #20

> 赞同：3
> 
> 时间：2008-08-30T12:01:09.527

由于它不需要经常与中央服务器通信，几乎每个命令都在不到一秒的时间内运行（显然 git push/pull/fetch 速度较慢，因为它们必须初始化 SSH 连接）。分支要容易得多（一个简单的分支命令，一个简单的合并命令）

* * *

## 回答 #21

> 赞同：3
> 
> 时间：2010-02-10T22:54:35.410

我非常喜欢能够在 Git 中管理我的源代码的本地分支，而不会弄乱中央存储库的水。在许多情况下，我会从 Subversion 服务器签出代码并运行本地 Git 存储库，以便能够做到这一点。初始化 Git 存储库不会因为到处都是一堆烦人的 .svn 文件夹而污染文件系统，这也很棒。

并且就 Windows 工具支持而言，TortoiseGit 处理基础非常好，但我仍然更喜欢命令行，除非我想查看日志。我真的很喜欢 Tortoise{Git|SVN} 在阅读提交日志时的帮助方式。

* * *

## 回答 #22

> 赞同：3
> 
> 时间：2011-05-29T17:30:50.897

这是一个错误的问题。关注 git 的缺点并就为什么 subversion 表面上更好，至少对于某些用例来说，这太容易了。git 最初被设计为一个低级版本控制构造集并具有巴洛克式的面向 linux 开发人员的界面，这一事实使得圣战更容易获得牵引力和合法性。Git 支持者用数以百万计的工作流程优势来敲鼓，svn 的人宣称这是不必要的。很快，整个辩论就被定格为集中式与分布式，这符合企业 svn 工具社区的利益。这些公司通常会发表关于颠覆在企业中的优势的最有说服力的文章，

但问题是：**Subversion 是一个架构死胡同**。

虽然你可以很容易地使用 git 并构建一个集中的颠覆替代品，尽管 svn 存在的时间是它的两倍多，但它甚至无法像在 git 中那样在任何地方实现基本的合并跟踪。造成这种情况的一个基本原因是使分支与目录相同的设计决策。我不知道他们最初为什么要这样做，这确实使部分结帐变得非常简单。不幸的是，它也使得无法正确跟踪历史。现在显然你应该使用颠覆存储库布局约定将分支与常规目录分开，并且 svn 使用一些启发式方法使事情适用于日常用例。但这一切都只是掩盖了一个非常糟糕和限制性的低级设计决策。能够进行存储库方式的差异（而不是目录方式的差异）是版本控制系统的基本和关键功能，并且大大简化了内部结构，从而可以在其之上构建更智能和有用的功能。您可以看到扩展颠覆所付出的努力，但在合并解析等基本操作方面，它与当前的现代 VCS 作物相差甚远。

现在，对于那些仍然相信 Subversion 在可预见的未来足够好的人来说，这是我发自内心的不可知论的建议：

Subversion 永远赶不上从 RCS 和 CVS 的错误中吸取教训的较新品种的 VCS；除非他们从头开始重新构建存储库模型，否则这在技术上是不可能的，但它不会真的是 svn 吗？无论您认为自己不具备现代 VCS 的功能多少，您的无知都无法保护您免受 Subversion 的陷阱，其中许多情况在其他系统中是不可能或容易解决的。

一个解决方案的技术劣势像 svn 一样清晰，这是极其罕见的，当然我永远不会对 win-vs-linux 或 emacs-vs-vi 发表这样的看法，但在这种情况下它是如此清晰，源代码控制是开发人员武器库中的一个基本工具，我觉得必须明确说明。不管出于组织原因使用 svn 的要求如何，我恳请所有 svn 用户不要让他们的逻辑思维构建错误的信念，即更现代的 VCS 仅对大型开源项目有用。无论您的开发工作的性质如何，如果您是一名程序员，那么如果您学习如何使用设计更好的 VCS，无论是 Git、Mercurial、Darcs 还是许多其他工具，您都会成为一名更高效的程序员。

* * *

## 回答 #23

> 赞同：2
> 
> 时间：2009-10-13T13:14:45.567

Subversion 非常易于使用。在过去的几年中，我从未发现任何问题或某些事情没有按预期工作。还有很多优秀的 GUI 工具，对 SVN 集成的支持很大。

使用 Git，您可以获得更灵活的 VCS。您可以像使用 SVN 一样将它与远程存储库一起使用，您可以在其中提交所有更改。但是您也可以大部分时间离线使用它，并且不时地将更改推送到远程存储库。但 Git 更复杂，学习曲线也更陡峭。我第一次发现自己犯了错误的分支，间接创建分支或收到错误消息，但关于错误的信息不多，我必须用谷歌搜索以获得更好的信息。一些简单的事情，比如替换标记 ($Id$) 不起作用，但 GIT 有一个非常灵活的过滤和挂钩机制来合并自己的脚本，所以你得到你需要的所有东西，但它需要更多的时间和阅读文档;)

如果您主要使用本地存储库脱机工作，那么如果本地计算机上丢失了某些内容，则没有备份。使用 SVN，您主要使用远程存储库，这也是您在另一台服务器上备份的同时...... Git 可以以相同的方式工作，但这不是 Linus 拥有类似 SVN2 的主要目标。它是为 Linux 内核开发者和分布式版本控制系统的需要而设计的。

Git 比 SVN 更好吗？只需要一些版本历史记录和备份机制的开发人员使用 SVN 可以过上轻松愉快的生活。经常使用分支、同时测试更多版本或主要离线工作的开发人员可以从 Git 的功能中受益。有一些非常有用的功能，例如 SVN 所没有的存储功能，可以让生活更轻松。但另一方面，并​​非所有人都需要所有功能。所以我看不到SVN的死。

Git 需要一些更好的文档，并且错误报告必须更有帮助。此外，现有的有用 GUI 也很少。这次我只找到了 1 个支持大多数 Git 功能（git-cola）的 Linux 图形用户界面。Eclipse 集成正在运行，但尚未正式发布，也没有官方更新站点（只有一些外部更新站点，定期从主干[http://www.jgit.org/updates](http://www.jgit.org/updates)构建）所以这是当今使用 Git 的最首选方式是命令行。

* * *

## 回答 #24

> 赞同：2
> 
> 时间：2009-10-13T13:36:01.670

SourceGear 的[Eric Sink撰写了关于分布式和非分布式版本控制系统之间差异的系列文章。](http://www.ericsink.com/)他比较了最流行的版本控制系统的优缺点。非常有趣的阅读。
文章可以在他的博客[www.ericsink.com](http://www.ericsink.com)上找到：

*   [阅读差异](http://www.ericsink.com/entries/Read_the_Diffs.html)

*   [Git是版本控制工具的C](http://www.ericsink.com/entries/git_index.html)

*   [关于 Git 不尊重不变性和 DVCS 的最佳实践](http://www.ericsink.com/entries/git_immutability.html)

*   [DVCS 和 DAG，第 1 部分](http://www.ericsink.com/entries/dvcs_dag_1.html)

*   [DVCS 和 DAG，第 2 部分](http://www.ericsink.com/entries/dvcs_dag_2.html)

*   [DVCS 和错误跟踪](http://www.ericsink.com/entries/dbts_fossil.html)

*   [合并历史、DAG 和 Darcs](http://www.ericsink.com/entries/merge_history.html)

*   [为什么 Git 这么快？](http://www.ericsink.com/entries/why_is_git_fast.html)

*   [Mercurial、Subversion 和 Wesley Snipes](http://www.ericsink.com/entries/hg_denzel.html)

* * *

## 回答 #25

> 赞同：2
> 
> 时间：2011-03-09T14:05:56.953

对于寻找良好 Git GUI 的人来说，[Syntevo SmartGit](http://www.syntevo.com/smartgit/)可能是一个不错的解决方案。我认为它是专有的，但可免费用于非商业用途，可在 Windows/Mac/Linux 上运行，甚至使用某种 git-svn 桥支持 SVN。

* * *

## 回答 #26

> 赞同：1
> 
> 时间：2010-01-03T12:45:36.960

首先，并发版本控制似乎是一个容易解决的问题。根本不是。反正...

SVN 非常不直观。吉特更糟糕。[讽刺推测] 这可能是因为喜欢并发版本控制等难题的开发人员对制作好的 UI 没有太大兴趣。[/讽刺猜测]

SVN 支持者认为他们不需要分布式版本控制系统。**我也是这么想的。**但现在我们只使用 Git，我相信。现在版本控制适用于我和团队/项目，而不仅仅是为项目工作。当我需要分支时，我会分支。有时它是一个分支，在服务器上有相应的分支，有时它没有。更不用说我必须研究的所有其他优点（部分归功于现代版本控制系统 UI 的神秘和荒谬的缺乏）。

* * *

## 回答 #27

> 赞同：1
> 
> 时间：2010-02-10T16:29:29.163

Windows 中的 Git 现在得到了很好的支持。

查看 GitExtensions = [http://code.google.com/p/gitextensions/](http://code.google.com/p/gitextensions/)

和手册以获得更好的 Windows Git 体验。

* * *

## 回答 #28

> 赞同：1
> 
> 时间：2010-02-10T18:51:32.180

[http://subversion.wandisco.com/component/content/article/1/40.html](http://subversion.wandisco.com/component/content/article/1/40.html)

我认为在开发人员中说 SVN Vs 是相当安全的。Git 争论已经有一段时间了，每个人都对哪个更好有自己的看法。这甚至在我们 2010 年及以后的 Subversion 网络研讨会期间的问题中提出。

我们的开源总监兼 Subversion 公司总裁 Hyrum Wright 谈到了 Subversion 和 Git 以及其他分布式版本控制系统 (DVCS) 之间的差异。

他还谈到了 Subversion 即将发生的变化，例如下一代工作副本 (WC-NG)，他认为这将导致许多 Git 用户转换回 Subversion。

观看他的视频，并通过在此博客上发表评论或在我们的论坛上发帖告诉我们您的想法。注册很简单，只需片刻！

* * *

## 回答 #29

> 赞同：1
> 
> 时间：2010-04-25T21:35:23.513

我最近一直住在 Git 领域，我喜欢将它用于个人项目，但我还不能将工作项目从 Subversion 切换到它，因为员工的想法发生了变化，而且没有任何紧迫的好处。此外，我们内部运行的最大项目非常依赖[svn:externals](http://svnbook.red-bean.com/en/1.0/ch07s03.html)，据我目前所见，它在 Git 中并不能很好地无缝运行。

* * *

## 回答 #30

> 赞同：1
> 
> 时间：2010-10-22T16:25:05.737

为什么我认为 Subversion 比 Git 更好（至少对于我从事的项目而言），主要是因为它的可用性和更简单的工作流程：

[http://www.databasesandlife.com/why-subversion-is-better-than-git/](http://www.databasesandlife.com/why-subversion-is-better-than-git/)**

# php - PHP 变量是按值传递还是按引用传递？

> ID：879
> 
> 赞同：291
> 
> 时间：2008-08-03T22:51:41.447
> 
> 标签：php, variables, pass-by-reference, pass-by-value

PHP 变量是按值传递还是按引用传递？

* * *

## 回答 #1

> 赞同：362
> 
> 时间：2008-08-03T23:06:56.423

根据[PHP 文档](http://php.net/manual/en/functions.arguments.php)，它是按值计算的。

> 默认情况下，函数参数是按值传递的（因此，如果函数内的参数值发生变化，它不会在函数外发生变化）。要允许函数修改其参数，它们必须通过引用传递。
> 
> 要让函数的参数始终通过引用传递，请在函数定义中的参数名称前添加一个**&符号。**

```
<?php
function add_some_extra(&$string)
{
    $string .= 'and something extra.';
}

$str = 'This is a string, ';
add_some_extra($str);
echo $str;    // outputs 'This is a string, and something extra.'
?> 
```

* * *

## 回答 #2

> 赞同：89
> 
> 时间：2012-03-14T06:09:47.740

在 PHP 中，默认情况下，对象作为对新对象的引用传递。

看这个例子：

```
class X {
  var $abc = 10; 
}

class Y {

  var $abc = 20; 
  function changeValue($obj)
  {
   $obj->abc = 30;
  }
}

$x = new X();
$y = new Y();

echo $x->abc; //outputs 10
$y->changeValue($x);
echo $x->abc; //outputs 30 
```

现在看到这个：

```
class X {
  var $abc = 10; 
}

class Y {

  var $abc = 20; 
  function changeValue($obj)
  {
    $obj = new Y();
  }
}

$x = new X();
$y = new Y();

echo $x->abc; //outputs 10
$y->changeValue($x);
echo $x->abc; //outputs 10 not 20 same as java does. 
```

现在看到这个：

```
class X {
  var $abc = 10; 
}

class Y {

  var $abc = 20; 
  function changeValue(&$obj)
  {
    $obj = new Y();
  }
}

$x = new X();
$y = new Y();

echo $x->abc; //outputs 10
$y->changeValue($x);
echo $x->abc; //outputs 20 not possible in java. 
```

我希望你能理解这一点。

* * *

## 回答 #3

> 赞同：62
> 
> 时间：2008-08-11T02:09:30.133

似乎很多人对对象传递给函数的方式以及通过引用传递的含义感到困惑。对象还是按值传递的，只是PHP5中传递的值是一个引用句柄。作为证明：

```
<?php
class Holder {
    private $value;

    public function __construct($value) {
        $this->value = $value;
    }

    public function getValue() {
        return $this->value;
    }
}

function swap($x, $y) {
    $tmp = $x;
    $x = $y;
    $y = $tmp;
}

$a = new Holder('a');
$b = new Holder('b');
swap($a, $b);

echo $a->getValue() . ", " . $b->getValue() . "\n"; 
```

输出：

```
a, b 
```

通过[引用传递](http://en.wikipedia.org/wiki/Pass_by_reference#Call_by_reference)意味着我们可以修改调用者看到的变量，显然上面的代码没有这样做。我们需要将交换函数更改为：

```
<?php
function swap(&$x, &$y) {
    $tmp = $x;
    $x = $y;
    $y = $tmp;
}

$a = new Holder('a');
$b = new Holder('b');
swap($a, $b);

echo $a->getValue() . ", " . $b->getValue() . "\n"; 
```

输出：

```
b, a 
```

为了通过引用。

* * *

## 回答 #4

> 赞同：36
> 
> 时间：2008-08-03T23:57:46.820

[http://www.php.net/manual/en/migration5.oop.php](http://www.php.net/manual/en/migration5.oop.php)

> 在 PHP 5 中有一个新的对象模型。PHP 对对象的处理已被完全重写，以提供更好的性能和更多功能。在以前的 PHP 版本中，对象的处理方式类似于原始类型（例如整数和字符串）。这种方法的缺点是语义上整个对象在分配变量时被复制，或者作为参数传递给方法。在新方法中，对象是通过句柄而不是值来引用的（可以将句柄视为对象的标识符）。

* * *

## 回答 #5

> 赞同：33
> 
> 时间：2008-08-03T22:52:17.593

PHP 变量按值分配，按值传递给函数，并且在包含/表示对象时通过引用传递。您可以使用“&”强制变量通过引用传递。

按值/参考分配的示例：

```
$var1 = "test";
$var2 = $var1;
$var2 = "new test";
$var3 = &$var2;
$var3 = "final test";

print ("var1: $var1, var2: $var2, var3: $var3); 
```

输出：

> var1：测试，var2：最终测试，var3：最终测试

通过值/引用示例：

```
$var1 = "foo";
$var2 = "bar";

changeThem($var1, $var2);

print "var1: $var1, var2: $var2";

function changeThem($var1, &$var2){
    $var1 = "FOO";
    $var2 = "BAR";
} 
```

输出：

> var1：foo，var2 酒吧

通过引用传递的对象变量示例：

```
class Foo{
    public $var1;

    function __construct(){
        $this->var1 = "foo";
    }

    public function printFoo(){
        print $this->var1;
    }
}

$foo = new Foo();

changeFoo($foo);

$foo->printFoo();

function changeFoo($foo){
    $foo->var1 = "FOO";
} 
```

输出：

> 食品

（最后一个例子可能会更好。）

* * *

## 回答 #6

> 赞同：10
> 
> 时间：2014-12-21T09:27:02.643

您可以通过引用将变量传递给函数。该函数将能够修改原始变量。

您可以在函数定义中通过引用来定义段落：

```
<?php
function changeValue(&$var)
{
    $var++;
}

$result=5;
changeValue($result);

echo $result; // $result is 6 here
?> 
```

* * *

## 回答 #7

> 赞同：6
> 
> 时间：2009-02-22T09:17:14.973

无论哪种方式，你都可以做到。

在前面放一个“&”符号，您传递的变量将变为一个，并且与它的来源相同，即您可以通过引用传递，而不是复制它。

所以

```
 $fred = 5;
    $larry = & $fred;
    $larry = 8;
    echo $fred;//this will output 8, as larry and fred are now the same reference. 
```

* * *

## 回答 #8

> 赞同：5
> 
> 时间：2008-08-04T00:05:05.790

在 PHP5 中，包含原始类型的变量是按值传递的。包含对象的变量通过引用传递。2006 年的 Linux Journal 有一篇非常有趣的文章，其中提到了 4 和 5 之间的这个和其他 OO 差异。

[http://www.linuxjournal.com/article/9170](http://www.linuxjournal.com/article/9170)

* * *

## 回答 #9

> 赞同：3
> 
> 时间：2020-02-05T19:22:09.803

**TL;DR** : PHP 支持按值传递和按引用传递。引用使用 & 符号 ( `&`) 声明；这与 C++ 的做法非常相似。当函数的形参未用 & 号声明时（即，它不是引用），**所有内容**都按值传递，包括对象。对象和原语的传递方式没有区别。关键是要了解*将*对象传递给函数时传递的内容。这就是理解指针非常宝贵的地方。

对于将来遇到此问题的任何人，我想从[匿名用户发布的 PHP 文档](https://www.php.net/manual/en/language.oop5.references.php)中分享此 gem ：

> 这里似乎有些混乱。指针和引用之间的区别并不是特别有用。已经发布的一些“综合”示例中的行为可以用更简单的统一术语来解释。例如，Hayley 的代码完全按照您的预期执行。（使用 >= 5.3）

> 第一个原则：指针存储访问对象的内存地址。每次分配对象时，都会生成一个指针。（我还没有深入研究 Zend 引擎，但据我所知，这适用）

> 第二个原则，也是最混乱的来源：默认情况下，将变量传递给函数是作为值传递完成的，即，您正在使用副本。“但是对象是通过引用传递的！” 这里和 Java 世界中的一个常见误解。我从来没有说过什么的副本。默认传递是按值完成的。总是。然而，被复制和传递的是指针。当使用“->”时，您当然会访问与调用函数中的原始变量相同的内部结构。仅使用“=”只会播放副本。

> 第三个原则：“&”自动且永久地将另一个变量名/指针设置为与其他东西相同的内存地址，直到您将它们解耦。在这里使用术语“别名”是正确的。把它想象成在臀部连接两个指针，直到被“unset()”强行分开。此功能既存在于同一范围内，也存在于将参数传递给函数时。由于在 C 和 C++ 中“按值传递”和“按引用传递”之间的某些区别，传递的参数通常称为“引用”。

> 请记住：指向对象的指针，而不是对象本身，被传递给函数。这些指针是原始指针的副本，除非您在参数列表中使用“&”来实际传递原始指针。只有当你深入到一个物体的内部时，原件才会改变。

这是他们提供的示例：

```
<?php

//The two are meant to be the same
$a = "Clark Kent"; //a==Clark Kent
$b = &$a; //The two will now share the same fate.

$b="Superman"; // $a=="Superman" too.
echo $a;
echo $a="Clark Kent"; // $b=="Clark Kent" too.
unset($b); // $b divorced from $a
$b="Bizarro";
echo $a; // $a=="Clark Kent" still, since $b is a free agent pointer now.

//The two are NOT meant to be the same.
$c="King";
$d="Pretender to the Throne";
echo $c."\n"; // $c=="King"
echo $d."\n"; // $d=="Pretender to the Throne"
swapByValue($c, $d);
echo $c."\n"; // $c=="King"
echo $d."\n"; // $d=="Pretender to the Throne"
swapByRef($c, $d);
echo $c."\n"; // $c=="Pretender to the Throne"
echo $d."\n"; // $d=="King"

function swapByValue($x, $y){
$temp=$x;
$x=$y;
$y=$temp;
//All this beautiful work will disappear
//because it was done on COPIES of pointers.
//The originals pointers still point as they did.
}

function swapByRef(&$x, &$y){
$temp=$x;
$x=$y;
$y=$temp;
//Note the parameter list: now we switched 'em REAL good.
}

?> 
```

[我为 JavaScript 写了一篇关于这个主题的广泛而详细的博客文章](https://www.aleksandrhovhannisyan.com/blog/javascript-pass-by-reference/)，但我相信它同样适用于 PHP、C++ 和任何其他人们似乎对按值传递与按引用传递感到困惑的语言。

显然，PHP 与 C++ 一样，是一种支持按引用传递的语言。默认情况下，对象是按值传递的。使用存储对象的变量时，将这些变量视为指针会有所帮助（因为在汇编级别，它们基本上就是这样）。如果按值传递指针，您仍然可以“跟踪”指针并修改所指向对象的属性。你不能做的是让它指向一个不同的对象。只有当你明确声明一个参数是通过引用传递时，你才能做到这一点。

* * *

## 回答 #10

> 赞同：1
> 
> 时间：2010-01-09T16:34:13.940

对象在 PHP 5 中通过引用传递，在 PHP 4 中通过值传递。变量默认按值传递！

在这里阅读：[http ://www.webeks.net/programming/php/ampersand-operator-used-for-assigning-reference.html](http://www.webeks.net/programming/php/ampersand-operator-used-for-assigning-reference.html)

* * *

## 回答 #11

> 赞同：1
> 
> 时间：2010-05-11T15:51:24.673

```
class Holder
{
    private $value;

    public function __construct( $value )
    {
        $this->value = $value;
    }

    public function getValue()
    {
        return $this->value;
    }

    public function setValue( $value )
    {
        return $this->value = $value;
    }
}

class Swap
{       
    public function SwapObjects( Holder $x, Holder $y )
    {
        $tmp = $x;

        $x = $y;

        $y = $tmp;
    }

    public function SwapValues( Holder $x, Holder $y )
    {
        $tmp = $x->getValue();

        $x->setValue($y->getValue());

        $y->setValue($tmp);
    }
}

$a1 = new Holder('a');

$b1 = new Holder('b');

$a2 = new Holder('a');

$b2 = new Holder('b');

Swap::SwapValues($a1, $b1);

Swap::SwapObjects($a2, $b2);

echo 'SwapValues: ' . $a2->getValue() . ", " . $b2->getValue() . "<br>";

echo 'SwapObjects: ' . $a1->getValue() . ", " . $b1->getValue() . "<br>"; 
```

当不通过引用传递时，属性仍然是可修改的，所以要小心。

输出：

SwapObjects: b, a SwapValues: a, b

* * *

## 回答 #12

> 赞同：1
> 
> 时间：2021-04-12T03:05:00.850

关于如何将对象传递给函数，您仍然需要了解，如果没有“&”，您将传递给函数一个对象句柄，对象句柄仍然通过值传递，并且它包含指针的值。但是你不能改变这个指针，直到你使用“&”通过引用传递它

```
<?php
        class Example 
        {
            public $value;

        }

        function test1($x) 
        {
             //let's say $x is 0x34313131
             $x->value = 1;  //will reflect outsite of this function
                             //php use pointer 0x34313131 and search for the 
                             //address of 'value' and change it to 1

        }

        function test2($x) 
        {
             //$x is 0x34313131
             $x = new Example;
             //now $x is 0x88888888
             //this will NOT reflect outside of this function 
             //you need to rewrite it as "test2(&$x)"
             $x->value = 1000; //this is 1000 JUST inside this function

        }

     $example = new Example;

     $example->value = 0;

     test1($example); // $example->value changed to  1

     test2($example); // $example did NOT changed to a new object 
                      // $example->value is still 1

 ?> 
```

* * *

## 回答 #13

> 赞同：0
> 
> 时间：2015-07-15T11:25:18.957

实际上这两种方法都是有效的，但这取决于您的要求。通过引用传递值通常会使您的脚本变慢。因此，考虑到执行时间，最好按值传递变量。当您按值传递变量时，代码流也更加一致。

* * *

## 回答 #14

> 赞同：0
> 
> 时间：2018-03-31T12:34:37.123

当您希望简单地更改原始变量并再次将其返回到相同的变量名称并为其分配新值时，可以将其用于函数。

```
function add(&$var){ // The &amp; is before the argument $var
   $var++;
}
$a = 1;
$b = 10;
add($a);
echo "a is $a,";
add($b);
echo " a is $a, and b is $b"; // Note: $a and $b are NOT referenced 
```

* * *

## 回答 #15

> 赞同：0
> 
> 时间：2021-06-25T12:25:57.760

PHP 引用是一个别名，允许两个不同的变量写入同一个值。

而在 PHP 中，如果您有一个包含对象的变量，则该变量不包含对象本身。相反，它包含该对象的标识符。对象访问器将使用标识符来查找实际对象。因此，当我们将对象用作函数中的参数或将其分配给另一个变量时，我们将复制指向对象本身的标识符。

[https://hsalem.com/posts/you-think-you-know-php.html](https://hsalem.com/posts/you-think-you-know-php.html)

```
class Type {}

$x = new Type();
$y = $x;
$y = "New value";

var_dump($x); // Will print the object.
var_dump($y); // Will print the "New value"

$z = &$x; // $z is a reference of $x

$z = "New value";
var_dump($x); // Will print "New value"
var_dump($z); // Will print "New value" 
```

* * *

## 回答 #16

> 赞同：-1
> 
> 时间：2021-03-23T12:05:09.067

看这个例子：

```
<?php

$string = 'First String. ';
$string .= 'Second String. ';
$string .= 'Third String. ';

echo $string;

// output: First String. Second String. Third String. 

?> 
```

* * *

## 回答 #17

> 赞同：-6
> 
> 时间：2008-08-03T22:52:11.930

取决于版本，4 是按值，5 是按引用。

# php - 你如何调试 PHP 脚本？

> ID：888
> 
> 赞同：403
> 
> 时间：2008-08-03T23:18:21.627
> 
> 标签：php, eclipse, debugging, phpstorm, xdebug

你如何调试**PHP**脚本？

我知道基本调试，例如使用错误报告。**PHPEclipse**中的断点调试也很有用。

在 phpStorm 或任何其他 IDE 中进行调试的**最佳**（就快速和简单而言）方法是什么？

* * *

## 回答 #1

> 赞同：145
> 
> 时间：2008-08-03T23:28:39.890

尝试使用[Eclipse PDT](https://eclipse.org/pdt/)来设置具有您提到的调试功能的 Eclipse 环境。与旧方法 var_dump 相比，单步执行代码的能力是一种更好的调试方法，并在各个点打印以查看流程出错的地方。当所有其他方法都失败并且我所拥有的只是 SSH 和 vim 时，我仍然`var_dump()`/`die()`来查找代码往南的地方。

* * *

## 回答 #2

> 赞同：80
> 
> 时间：2008-08-05T17:22:09.333

您可以使用 Firephp 插件来在与 javascript 相同的环境中调试 php。

我还使用前面提到的[Xdebug来分析 php。](http://xdebug.org/)

* * *

## 回答 #3

> 赞同：38
> 
> 时间：2009-06-29T13:40:30.230

这是我的小调试环境：

```
error_reporting(-1);
assert_options(ASSERT_ACTIVE, 1);
assert_options(ASSERT_WARNING, 0);
assert_options(ASSERT_BAIL, 0);
assert_options(ASSERT_QUIET_EVAL, 0);
assert_options(ASSERT_CALLBACK, 'assert_callcack');
set_error_handler('error_handler');
set_exception_handler('exception_handler');
register_shutdown_function('shutdown_handler');

function assert_callcack($file, $line, $message) {
    throw new Customizable_Exception($message, null, $file, $line);
}

function error_handler($errno, $error, $file, $line, $vars) {
    if ($errno === 0 || ($errno & error_reporting()) === 0) {
        return;
    }

    throw new Customizable_Exception($error, $errno, $file, $line);
}

function exception_handler(Exception $e) {
    // Do what ever!
    echo '<pre>', print_r($e, true), '</pre>';
    exit;
}

function shutdown_handler() {
    try {
        if (null !== $error = error_get_last()) {
            throw new Customizable_Exception($error['message'], $error['type'], $error['file'], $error['line']);
        }
    } catch (Exception $e) {
        exception_handler($e);
    }
}

class Customizable_Exception extends Exception {
    public function __construct($message = null, $code = null, $file = null, $line = null) {
        if ($code === null) {
            parent::__construct($message);
        } else {
            parent::__construct($message, $code);
        }
        if ($file !== null) {
            $this->file = $file;
        }
        if ($line !== null) {
            $this->line = $line;
        }
    }
} 
```

* * *

## 回答 #4

> 赞同：32
> 
> 时间：2008-09-15T20:23:29.120

Xdebug 和用于 Notepad++ 的 DBGp 插件用于重型错误搜索，FirePHP 用于轻量级的东西。又快又脏？没有什么[比 dBug 更好](http://dbug.ospinto.com/)的了。

* * *

## 回答 #5

> 赞同：26
> 
> 时间：2008-08-22T15:43:34.563

[XDebug](http://www.xdebug.org/)对于开发是必不可少的。我在任何其他扩展之前安装它。它为您提供任何错误的堆栈跟踪，并且您可以轻松启用分析。

要快速查看数据结构，请使用[`var_dump()`](http://www.php.net/manual/en/function.var-dump.php). 不要使用`print_r()`，因为你必须用它包围它，`<pre>`它一次只打印一个 var。

```
<?php var_dump(__FILE__, __LINE__, $_REQUEST); ?> 
```

对于真正的调试环境，我发现最好的是[Komodo IDE](http://www.activestate.com/Products/komodo_ide/index.mhtml)，但它的成本是 $$。

* * *

## 回答 #6

> 赞同：19
> 
> 时间：2009-02-05T09:16:41.843

PhpEd 真的很好。您可以进入/结束/退出功能。您可以运行临时代码、检查变量、更改变量。这是惊人的。

* * *

## 回答 #7

> 赞同：17
> 
> 时间：2008-08-07T00:25:13.487

1) 我使用 print_r()。在 TextMate 中，我有一个“pre”片段，它扩展为：

```
echo "<pre>";
print_r();
echo "</pre>"; 
```

2) 我使用 Xdebug，但无法让 GUI 在我的 Mac 上正常工作。它至少打印出堆栈跟踪的可读版本。

* * *

## 回答 #8

> 赞同：16
> 
> 时间：2008-08-03T23:20:48.347

我使用了[Zend Studio (5.5)](http://www.zend.com/products/studio/)和[Zend Platform](http://www.zend.com/en/products/platform/)。这提供了适当的调试、断点/跨代码等，尽管需要付出代价。

* * *

## 回答 #9

> 赞同：16
> 
> 时间：2008-08-04T21:28:44.810

老实说，结合 print 和 print_r() 打印出变量。我知道许多人更喜欢使用其他更高级的方法，但我发现这是最容易使用的。

我会说，直到我在 Uni 做了一些微处理器编程并且甚至无法使用它之前，我才完全理解这一点。

* * *

## 回答 #10

> 赞同：14
> 
> 时间：2008-08-04T21:07:09.130

[Derick Rethans 的Xdebug](http://xdebug.org/)非常好。我前段时间用过，发现安装起来不是那么容易。完成后，您将无法理解没有它的管理方式:-)

[Zend Developer Zone](http://devzone.zend.com/article/2803-introducing-xdebug)上有一篇很好的文章（在 Linux 上安装似乎并不容易），甚至还有一个我从未使用过的[Firefox 插件。](https://addons.mozilla.org/fr/firefox/addon/3960)

* * *

## 回答 #11

> 赞同：11
> 
> 时间：2008-08-26T15:04:57.963

我将 Netbeans 与 XDebug 一起使用。在其网站上查看有关如何配置它的文档。 [http://php.netbeans.org/](http://php.netbeans.org/)

* * *

## 回答 #12

> 赞同：11
> 
> 时间：2010-07-09T03:14:15.763

我将 Netbeans 与 XDebug 和[Easy XDebug FireFox 附加组件一起使用](http://www.elime.be/easyxdebug.htm "Easy XDebug FireFox 附加组件")

当您调试 MVC 项目时，插件是必不可少的，因为 XDebug 在 Netbeans 中运行的正常方式是通过 url 注册 dbug 会话。在 FireFox 中安装插件后，您将设置 Netbeans 项目属性 -> 运行配置 -> 高级并选择“不打开 Web 浏览器” 现在可以设置断点并像往常一样使用 Ctrl-F5 启动调试会话. 打开 FireFox 并右键单击右下角的 Add-on 图标以开始监视断点。当代码到达断点时，它将停止，您可以检查变量状态和调用堆栈。

* * *

## 回答 #13

> 赞同：10
> 
> 时间：2008-10-22T09:16:27.450

如果您不想弄乱输出，输出缓冲非常有用。我在单行中执行此操作，我可以随意评论/取消评论

```
 ob_start();var_dump(); user_error(ob_get_contents()); ob_get_clean(); 
```

* * *

## 回答 #14

> 赞同：9
> 
> 时间：2008-09-17T10:14:47.960

PhpEdit 有一个内置调试器，但我通常最终使用 echo(); 和 print_r(); 老式的方式！！

* * *

## 回答 #15

> 赞同：8
> 
> 时间：2008-08-22T15:33:44.743

对于真正棘手的问题，使用 print_r/echo 来弄清楚我使用我的 IDE (PhpEd) 调试功能太费时了。与我使用的其他 IDE 不同，PhpEd 几乎不需要任何设置。我不使用它来解决我遇到的任何问题的唯一原因是它*非常缓慢*。我不确定缓慢是否特定于 PhpEd 或任何 php 调试器。PhpEd 不是免费的，但我相信它无论如何都会使用其中一种开源调试器（如前面提到的 XDebug）。再一次，PhpEd 的好处是它不需要我过去发现非常乏味的设置。

* * *

## 回答 #16

> 赞同：4
> 
> 时间：2008-08-22T15:36:59.713

手动调试对我来说通常更快 -`var_dump()`并且`debug_print_backtrace()`是您武装逻辑所需的所有工具。

* * *

## 回答 #17

> 赞同：3
> 
> 时间：2008-09-18T03:17:36.910

嗯，在某种程度上，这取决于事情的发展方向。这是我尝试隔离的第一件事，然后我将根据需要使用 echo/print_r()。

注意：你们知道可以将 true 作为第二个参数传递给 print_r() 并且它会返回输出而不是打印它？例如：

```
echo "<pre>".print_r($var, true)."</pre>"; 
```

* * *

## 回答 #18

> 赞同：3
> 
> 时间：2010-05-10T09:29:24.013

当无法使用 Rails 时，我经常使用 CakePHP。为了调试错误，我通常`error.log`在 tmp 文件夹中找到并在终端中使用命令将其拖尾...

```
tail -f app/tmp/logs/error.log 
```

它让你从正在发生的事情的蛋糕中运行对话框，这非常方便，如果你想向它输出一些可以使用的中间代码。

```
$this->log('xxxx'); 
```

这通常可以让您很好地了解发生了什么/错误。

* * *

## 回答 #19

> 赞同：2
> 
> 时间：2008-08-03T23:32:13.020

print_r(debug_backtrace());

或类似的东西 ：-）

* * *

## 回答 #20

> 赞同：2
> 
> 时间：2008-08-22T15:44:33.063

Komodo IDE 可以很好地与 xdebug 配合使用，甚至可以进行更多调试。它需要最少的配置。您只需要一个 php 版本，Komodo 可以在本地使用它来单步执行断点上的代码。如果您将脚本导入 komodo 项目，那么您可以通过单击鼠标设置断点，就像在 eclipse 中设置它以调试 java 程序一样。与本地调试设置相比，远程调试显然更难让它正常工作（您可能必须在工作区中使用 php 脚本映射远程 URL），如果您在 MAC 或 Linux 桌面上，本地调试设置非常容易配置.

* * *

## 回答 #21

> 赞同：2
> 
> 时间：2012-05-29T12:43:39.720

Nusphere 也是一个很好的 php [nusphere调试器](http://www.nusphere.com/download.php.ide.htm)

* * *

## 回答 #22

> 赞同：2
> 
> 时间：2015-10-01T11:16:08.927

有许多 PHP 调试技术可以在编码时为您节省无数时间。一种有效但基本的调试技术是简单地打开错误报告。另一种更高级的技术涉及使用打印语句，它可以通过在屏幕上显示实际发生的内容来帮助查明更难以捉摸的错误。PHPeclipse 是一个 Eclipse 插件，它可以突出常见的语法错误，并且可以与调试器一起使用来设置断点。

```
display_errors = Off
error_reporting = E_ALL 
display_errors = On 
```

并且还使用了

```
error_log();
console_log(); 
```

* * *

## 回答 #23

> 赞同：1
> 
> 时间：2008-08-15T04:23:02.617

在生产环境中，我使用 error_log() 将相关数据记录到服务器的错误日志中。

* * *

## 回答 #24

> 赞同：1
> 
> 时间：2008-08-17T18:38:01.570

我使用带有内置调试器的zend studio for eclipse。与使用 xdebug 的 eclipse pdt 进行调试相比，它仍然很慢。希望他们能解决这些问题，与最近的版本相比，速度有所提高，但仍然需要 2-3 秒。zend firefox 工具栏确实让事情变得简单（调试下一页、当前页面等）。它还提供了一个分析器，可以对您的代码进行基准测试并提供饼图、执行时间等。

* * *

## 回答 #25

> 赞同：1
> 
> 时间：2010-05-10T09:18:59.860

大多数错误可以通过简单地设置`var_dump`一些关键变量来轻松找到，但这显然取决于您开发的应用程序类型。

对于更复杂的算法，步进/断点/监视功能非常有用（如果没有必要）

* * *

## 回答 #26

> 赞同：1
> 
> 时间：2016-03-21T12:34:17.490

### [PHP DBG](http://phpdbg.com/)

Interactive Stepthrough PHP Debugger 作为 SAPI 模块实现，它可以让您完全控制环境，而不会影响代码的功能或性能。它旨在成为 PHP 5.4+ 的轻量级、功能强大、易于使用的调试平台，并且随 PHP 5.6 一起提供。

特点包括：

*   逐步调试
*   灵活的断点（类方法、函数、文件：行、地址、操作码）
*   使用内置 eval() 轻松访问 PHP
*   轻松访问当前正在执行的代码
*   用户区 API
*   SAPI 不可知论 - 易于集成
*   PHP 配置文件支持
*   JIT Super Globals - 设置你自己的！！
*   可选的 readline 支持 - 舒适的终端操作
*   远程调试支持 - 捆绑的 Java GUI
*   操作简单

看截图：

[![PHP DBG - 逐步调试 - 屏幕截图](../Images/3d6ce69451d7658a77faeaae9b716062.png)](https://i.stack.imgur.com/yFHuH.png)

[![PHP DBG - 逐步调试 - 屏幕截图](../Images/1e7f04af921e714d6cd2e91d4ad4327c.png)](https://i.stack.imgur.com/WVFoN.png)

主页： http: [//phpdbg.com/](http://phpdbg.com/)

### [PHP 错误](http://phperror.net/)- 更好的 PHP 错误报告

这是一个非常易于使用的库（实际上是一个文件）来调试您的 PHP 脚本。

您唯一需要做的就是包含一个如下文件（在代码的开头）：

```
require('php_error.php');
\php_error\reportErrors(); 
```

然后所有错误都会为您提供回溯、代码上下文、函数参数、服务器变量等信息。例如：

[![PHP 错误 |  改进 PHP 的错误报告 - 回溯截图](../Images/7a64faa16a49da0a0bd3c3a7d2328512.png)](https://i.stack.imgur.com/csob7.png) [![PHP 错误 |  改进 PHP 的错误报告 - 回溯截图](../Images/bf5d65c6145408d0edab9de15a67411d.png)](https://i.stack.imgur.com/ulpyZ.png) [![PHP 错误 |  改进 PHP 的错误报告 - 回溯截图](../Images/e50cc130a2826d2ac8f759584c5aea22.png)](https://i.stack.imgur.com/ZiJwK.png)

特点包括：

*   使用简单，只是一个文件
*   正常和 ajaxy 请求在浏览器中显示的错误
*   AJAX 请求被暂停，允许您自动重新运行它们
*   使错误尽可能严格（鼓励代码质量，并倾向于提高性能）
*   整个堆栈跟踪中的代码片段
*   提供更多信息（例如完整的功能签名）
*   修复了一些完全错误的错误消息
*   语法高亮
*   看起来很漂亮！
*   定制
*   手动打开和关闭
*   运行特定部分而不报告错误
*   忽略文件允许您避免在堆栈跟踪中突出显示代码
*   申请文件；当错误发生时，这些是优先的！

主页： http: [//phperror.net/](http://phperror.net/)

GitHub：[https ://github.com/JosephLenton/PHP-Error](https://github.com/JosephLenton/PHP-Error)

我的叉子（有额外的修复）：[https ://github.com/kenorb-contrib/PHP-Error](https://github.com/kenorb-contrib/PHP-Error)

### [跟踪](https://en.wikipedia.org/wiki/DTrace)

如果您的系统支持[DTrace 动态跟踪](http://php.net/manual/en/features.dtrace.php)（默认安装在 OS X 上）并且您的 PHP 编译时启用`--enable-dtrace`了默认的 DTrace 探针（ ），则此命令可以帮助您立即调试 PHP 脚本：

```
sudo dtrace -qn 'php*:::function-entry { printf("%Y: PHP function-entry:\t%s%s%s() in %s:%d\n", walltimestamp, copyinstr(arg3), copyinstr(arg4), copyinstr(arg0), basename(copyinstr(arg1)), (int)arg2); }' 
```

因此，鉴于以下别名已添加到您的*rc*文件中（例如`~/.bashrc`, `~/.bash_aliases`）：

```
alias trace-php='sudo dtrace -qn "php*:::function-entry { printf(\"%Y: PHP function-entry:\t%s%s%s() in %s:%d\n\", walltimestamp, copyinstr(arg3), copyinstr(arg4), copyinstr(arg0), basename(copyinstr(arg1)), (int)arg2); }"' 
```

您可以使用易于记住的别名来跟踪您的脚本：`trace-php`。

这是更高级的 dtrace 脚本，只需将其保存到`dtruss-php.d`中，使其可执行（`chmod +x dtruss-php.d`）并运行：

```
#!/usr/sbin/dtrace -Zs
# See: https://github.com/kenorb/dtruss-lamp/blob/master/dtruss-php.d

#pragma D option quiet

php*:::compile-file-entry
{
    printf("%Y: PHP compile-file-entry:\t%s (%s)\n", walltimestamp, basename(copyinstr(arg0)), copyinstr(arg1));
}

php*:::compile-file-return
{
    printf("%Y: PHP compile-file-return:\t%s (%s)\n", walltimestamp, basename(copyinstr(arg0)), basename(copyinstr(arg1)));
}

php*:::error
{
    printf("%Y: PHP error message:\t%s in %s:%d\n", walltimestamp, copyinstr(arg0), basename(copyinstr(arg1)), (int)arg2);
}

php*:::exception-caught
{
    printf("%Y: PHP exception-caught:\t%s\n", walltimestamp, copyinstr(arg0));
}

php*:::exception-thrown
{
    printf("%Y: PHP exception-thrown:\t%s\n", walltimestamp, copyinstr(arg0));
}

php*:::execute-entry
{
    printf("%Y: PHP execute-entry:\t%s:%d\n", walltimestamp, basename(copyinstr(arg0)), (int)arg1);
}

php*:::execute-return
{
    printf("%Y: PHP execute-return:\t%s:%d\n", walltimestamp, basename(copyinstr(arg0)), (int)arg1);
}

php*:::function-entry
{
    printf("%Y: PHP function-entry:\t%s%s%s() in %s:%d\n", walltimestamp, copyinstr(arg3), copyinstr(arg4), copyinstr(arg0), basename(copyinstr(arg1)), (int)arg2);
}

php*:::function-return
{
    printf("%Y: PHP function-return:\t%s%s%s() in %s:%d\n", walltimestamp, copyinstr(arg3), copyinstr(arg4), copyinstr(arg0), basename(copyinstr(arg1)), (int)arg2);
}

php*:::request-shutdown
{
    printf("%Y: PHP request-shutdown:\t%s at %s via %s\n", walltimestamp, basename(copyinstr(arg0)), copyinstr(arg1), copyinstr(arg2));
}

php*:::request-startup
{
    printf("%Y, PHP request-startup:\t%s at %s via %s\n", walltimestamp, basename(copyinstr(arg0)), copyinstr(arg1), copyinstr(arg2));
} 
```

^(主页：GitHub 上[的 dtruss-lamp](https://github.com/kenorb/dtruss-lamp))

下面是简单的用法：

1.  运行：`sudo dtruss-php.d`。
2.  在另一个终端上运行：`php -r "phpinfo();"`.

要对此进行测试，您可以使用以下方式访问任何 docroot`index.php`并运行 PHP 内置服务器：

```
php -S localhost:8080 
```

[之后，您可以通过http://localhost:8080/](http://localhost:8080/)访问该站点（或选择您方便的任何端口）。从那里访问一些页面以查看跟踪输出。

注意：Dtrace 默认在 OS X 上可用，在 Linux 上您可能需要[dtrace4linux](https://github.com/dtrace4linux/linux)或检查其他一些[替代方案](https://stackoverflow.com/q/2059311/55075)。

请参阅：在 php.net 上[使用 PHP 和 DTrace](http://php.net/manual/en/features.dtrace.dtrace.php)

* * *

### [SystemTap](https://en.wikipedia.org/wiki/SystemTap)

`yum install systemtap-sdt-devel`或者，通过安装 SystemTap SDT 开发包（例如）来检查 SystemTap 跟踪。

下面是示例脚本 ( `all_probes.stp`)，用于在使用 SystemTap 运行 PHP 脚本期间跟踪所有核心 PHP 静态探测点：

```
probe process("sapi/cli/php").provider("php").mark("compile__file__entry") {
    printf("Probe compile__file__entry\n");
    printf("  compile_file %s\n", user_string($arg1));
    printf("  compile_file_translated %s\n", user_string($arg2));
}
probe process("sapi/cli/php").provider("php").mark("compile__file__return") {
    printf("Probe compile__file__return\n");
    printf("  compile_file %s\n", user_string($arg1));
    printf("  compile_file_translated %s\n", user_string($arg2));
}
probe process("sapi/cli/php").provider("php").mark("error") {
    printf("Probe error\n");
    printf("  errormsg %s\n", user_string($arg1));
    printf("  request_file %s\n", user_string($arg2));
    printf("  lineno %d\n", $arg3);
}
probe process("sapi/cli/php").provider("php").mark("exception__caught") {
    printf("Probe exception__caught\n");
    printf("  classname %s\n", user_string($arg1));
}
probe process("sapi/cli/php").provider("php").mark("exception__thrown") {
    printf("Probe exception__thrown\n");
    printf("  classname %s\n", user_string($arg1));
}
probe process("sapi/cli/php").provider("php").mark("execute__entry") {
    printf("Probe execute__entry\n");
    printf("  request_file %s\n", user_string($arg1));
    printf("  lineno %d\n", $arg2);
}
probe process("sapi/cli/php").provider("php").mark("execute__return") {
    printf("Probe execute__return\n");
    printf("  request_file %s\n", user_string($arg1));
    printf("  lineno %d\n", $arg2);
}
probe process("sapi/cli/php").provider("php").mark("function__entry") {
    printf("Probe function__entry\n");
    printf("  function_name %s\n", user_string($arg1));
    printf("  request_file %s\n", user_string($arg2));
    printf("  lineno %d\n", $arg3);
    printf("  classname %s\n", user_string($arg4));
    printf("  scope %s\n", user_string($arg5));
}
probe process("sapi/cli/php").provider("php").mark("function__return") {
    printf("Probe function__return: %s\n", user_string($arg1));
    printf(" function_name %s\n", user_string($arg1));
    printf("  request_file %s\n", user_string($arg2));
    printf("  lineno %d\n", $arg3);
    printf("  classname %s\n", user_string($arg4));
    printf("  scope %s\n", user_string($arg5));
}
probe process("sapi/cli/php").provider("php").mark("request__shutdown") {
    printf("Probe request__shutdown\n");
    printf("  file %s\n", user_string($arg1));
    printf("  request_uri %s\n", user_string($arg2));
    printf("  request_method %s\n", user_string($arg3));
}
probe process("sapi/cli/php").provider("php").mark("request__startup") {
    printf("Probe request__startup\n");
    printf("  file %s\n", user_string($arg1));
    printf("  request_uri %s\n", user_string($arg2));
    printf("  request_method %s\n", user_string($arg3));
} 
```

用法：

```
stap -c 'sapi/cli/php test.php' all_probes.stp 
```

请参阅：在 php.net[上将 SystemTap 与 PHP DTrace 静态探针一起使用](http://php.net/manual/en/features.dtrace.systemtap.php)

* * *

## 回答 #27

> 赞同：0
> 
> 时间：2008-08-05T00:49:42.347

+1 为 print_r()。使用它来转储对象或变量的内容。为了使其更具可读性，请使用 pre 标签，这样您就不需要查看源代码。

```
echo '<pre>';
print_r($arrayOrObject); 
```

还有 var_dump($thing) - 这对于查看 subthings 的类型非常有用

* * *

## 回答 #28

> 赞同：0
> 
> 时间：2008-08-06T15:46:25.767

根据问题，我喜欢将 error_reporting(E_ALL) 与 echo 测试结合使用（以查找最初发生错误的有问题的行/文件；您知道它并不总是 php 告诉您的行/文件对吗？），IDE 大括号匹配（解决“解析错误：语法错误，意外 $end”问题）和 print_r()；出口; 转储（真正的程序员查看源代码；p）。

你也不能用“memory_get_usage();”打败 phpdebug（检查 sourceforge）和“memory_get_peak_usage();” 找到问题区域。

* * *

## 回答 #29

> 赞同：0
> 
> 时间：2008-08-22T20:10:54.860

集成调试器，您可以在单步执行代码时观察变量更改的值，这真的很酷。但是，它们确实需要服务器上的软件设置和客户端上的一定数量的配置。两者都需要定期维护以保持良好的工作状态。

print_r 很容易编写，并且保证可以在任何设置中工作。

* * *

## 回答 #30

> 赞同：0
> 
> 时间：2008-10-22T08:46:43.063

通常我发现创建一个自定义日志函数能够保存在文件中，存储调试信息，并最终在一个公共页脚上重新打印。

您还可以覆盖常见的异常类，以便这种类型的调试是半自动化的。

# language-agnostic - 项目国际化

> ID：898
> 
> 赞同：48
> 
> 时间：2008-08-04T00:08:51.010
> 
> 标签：language-agnostic, unicode, localization, internationalization

您是如何在您从事的实际项目中实施国际化 (i18n) 的？

在阅读了 Joel 的著名文章后，我对制作跨文化软件产生了兴趣，[每个软件开发人员绝对、肯定必须了解 Unicode 和字符集的绝对最低要求（没有借口！）](http://www.joelonsoftware.com/articles/Unicode.html)。但是，除了确保尽可能使用 Unicode 字符串之外，我还没有能够在实际项目中利用这一点。但是，将所有字符串设为 Unicode 并确保您了解所使用的所有内容的编码方式只是 i18n 的冰山一角。

迄今为止，我所做的一切都是为一组受控的美国英语人士使用，或者 i18n 只是在推动项目上线之前我们没有时间进行工作。所以我正在寻找人们关于使软件在现实世界项目中更加本地化的任何技巧或战争故事。

* * *

## 回答 #1

> 赞同：48
> 
> 时间：2008-08-04T17:58:02.130

已经有一段时间了，所以这并不全面。

**字符集**

Unicode 很棒，但你不能忽略其他字符集。Windows XP（英文）上的默认字符集是 Cp1252。在网络上，您不知道浏览器会向您发送什么（尽管希望您的容器能够处理大部分内容）。当您使用的任何实现中存在错误时，请不要感到惊讶。当字符集在机器之间移动时，它们可以与文件名进行有趣的交互。

**翻译字符串**

一般来说，翻译人员不是编码人员。如果您将源文件发送给翻译人员，他们会破坏它。字符串应该被提取到资源文件（例如Java 中的属性文件或Visual C++ 中的资源DLL）。应该为翻译者提供难以破解的文件和不会让他们破解的工具。

翻译人员不知道产品中字符串的来源。没有上下文就很难翻译字符串。如果您不提供指导，翻译质量就会受到影响。

在上下文的主题上，您可能会看到多次出现相同的字符串“foo”，并认为让 UI 中的所有实例都指向相同的资源会更有效。这是一个坏主意。在某些语言中，单词可能对上下文非常敏感。

翻译字符串需要花钱。如果您发布产品的新版本，则恢复旧版本是有意义的。拥有从旧资源文件中恢复字符串的工具。

应尽量减少字符串连接和手动操作字符串。在适用的情况下使用格式函数。

翻译人员需要能够修改热键。`Ctrl`+`P`是英文打印；德国人使用`Ctrl`+ `D`。

如果您的翻译过程需要有人随时手动剪切和粘贴字符串，那您就是在自找麻烦。

**日期、时间、日历、货币、数字格式、时区**

这些都可能因国家而异。逗号可用于表示小数位。时间可能是 24 小时制。不是每个人都使用公历。你也需要明确。如果您注意在您的网站上将日期显示为美国的 MM/DD/YYYY 和英国的 DD/MM/YYYY，除非用户知道您已经完成，否则这些日期是不明确的。

**尤其是货币**

类库中提供的 Locale 函数将为您提供当地货币符号，但您不能只在以美元表示价格的值前面加上英镑（英镑）或欧元符号。

**用户界面**

布局应该是动态的。不仅字符串在翻译时可能会加倍长度，而且整个 UI 可能需要反转（希伯来语；阿拉伯语），以便控件从右到左运行。那是在我们到达亚洲之前。

**翻译前测试**

*   使用代码的静态分析来定位问题。至少，利用 IDE 中内置的工具。（Eclipse 用户可以转到 Window > Preferences > Java > Compiler > Errors/Warnings 并检查非外部化字符串。）
*   通过模拟翻译进行冒烟测试。解析资源文件并将字符串替换为长度加倍并插入时髦字符的伪翻译版本并不难。您不必说一种语言就可以使用外国操作系统。现代系统应该允许您以具有翻译字符串和外国语言环境的外国用户身份登录。如果您熟悉您的操作系统，您可以在不知道该语言的一个单词的情况下弄清楚什么是什么。
*   键盘映射和字符集引用非常有用。
*   虚拟化在这里非常有用。

**非技术问题**

有时您必须对文化差异保持敏感（可能会导致冒犯或不理解）。您经常看到的一个错误是使用标志作为选择网站语言或地理位置的视觉提示。除非您希望您的软件在全球政治中表明立场，否则这是一个坏主意。如果您是法国人并且提供了带有圣乔治国旗的英语选项（英格兰国旗是白色区域上的红十字），这可能会导致许多说英语的人感到困惑 - 假设外语和国家也会出现类似的问题. 图标需要经过文化相关性的审查。竖起大拇指或绿色勾号是什么意思？语言应该是相对中性的——在一个地区以特定方式称呼用户可能是可以接受的，但在另一个地区被认为是粗鲁的。

**资源**

C++ 和 Java 程序员可能会发现 ICU 网站很有用：http: [//www.icu-project.org/](http://www.icu-project.org/)

* * *

## 回答 #2

> 赞同：15
> 
> 时间：2008-08-04T00:35:14.110

一些有趣的事情：

1.  有一个 PHP 和 MySQL 应用程序可以很好地支持德语和法语，但现在需要支持俄语和中文。我想我把它移到了.net，因为 PHP 的 Unicode 支持——在我看来——不是很好。当然，玩弄 utf8_de/encode 或 mbstring-functions 很有趣。几乎和弗雷迪·克鲁格晚上来看你一样有趣……

2.  意识到某些语言比其他语言更详细。德语通常比英语更冗长，并且看到德语版本如何因为分配的空间太少而破坏用户界面并不有趣。一些产品因其创造性的解决方法而获得了一些声誉，例如 Oblivion 的“Schw.Tr.d.Le.En.W.”。令人难忘:-)

3.  玩弄日期格式，哇哦！是的，世界上确实有人在中间使用日期格式。试图找出 07/02/2008 应该是什么意思真是太有趣了，只是因为有些用户可能认为这可能是 7 月 2 日……但话说回来，你们在池塘里的人可能也相信那些把中间的月份：-P，特别是因为在英语中，7 月 2 日听起来比 7 月 2 日好很多，这不一定适用于其他语言（即在德语中，你永远不会说 Juli 2，但总是说 Zweiter Juli）。我尽可能使用 2008-02-07。很明显，这意味着 2 月 7 日并且排序正确，但是 dd/mm 与 mm/dd 可能是一个非常棘手的问题。

4.  另一个有趣的事情，[数字格式](https://stackoverflow.com/questions/192/floating-point-number-parsing-is-there-a-catch-all-algorithm)！10.000,50 vs 10,000.50 vs. 10 000,50 vs. 10'000,50 ...这是我现在最大的噩梦，必须支持多元文化环境，但无法可靠地知道用户的数字格式将使用。

5.  正式或非正式。在某些语言中，有两种称呼人的方式，一种正式的方式和一种更非正式的方式。在英语中，您只需说“You”，但在德语中，您必须在正式的“Sie”和非正式的“Du”之间做出选择，法语 Tu/Vous 也是如此。选择正式的方式通常是安全的选择，但这很容易被忽视。

6.  日历。在欧洲，一周的第一天是星期一，而在美国是星期日。日历小部件很好。向欧洲用户显示左侧为星期日、右侧为星期六的日历并不是很好，这会使他们感到困惑。

* * *

## 回答 #3

> 赞同：9
> 
> 时间：2008-08-04T00:23:00.123

我为我以前的雇主工作过一个使用 .NET 的项目，我们使用了一种内置的 .resx 格式。我们基本上有一个文件，其中包含 .resx 文件中的所有翻译，然后是具有不同翻译的多个文件。这样做的结果是，您必须非常努力地确保应用程序中可见的所有字符串都存储在 .resx 中，并且无论何时更改，您都必须更新您支持的所有语言。

如果您变得懒惰并且不通知负责翻译的人员，或者您在未通过本地化系统的情况下嵌入字符串，那么稍后尝试修复它将是一场噩梦。同样，如果本地化是事后才想到的，那将很难落实到位。最重要的是，如果您没有将所有可见字符串都存储在外部标准位置，那么很难找到所有需要本地化的字符串。

另一个注意事项，非常严格地避免直接连接可见字符串，例如

```
String message = "The " + item + " is on sale!"; 
```

相反，您必须使用类似的东西

```
String message = String.Format("The {0} is on sale!", item); 
```

原因是不同的语言通常对单词进行不同的排序，直接连接字符串需要一个新的构建来修复，但是如果你使用了像上面这样的某种字符串替换机制，你可以修改你的 .resx 文件（或任何本地化您使用的文件）用于需要重新排序单词的特定语言。

* * *

## 回答 #4

> 赞同：5
> 
> 时间：2008-08-04T15:04:47.737

今天早上我刚听了[Scott Hanselman 的播客](http://www.hanselminutes.com/default.aspx?showID=135)，他在其中谈到了国际化，尤其是非常棘手的事情，比如土耳其语（有四个 i）和泰语。此外，杰夫阿特伍德有一个[帖子](http://www.codinghorror.com/blog/archives/001075.html)：

* * *

## 回答 #5

> 赞同：3
> 
> 时间：2008-09-21T23:44:16.317

除了前面的所有提示，请记住 i18n 不仅仅是将单词更改为其他语言上的等价词，尤其是对于从右到左书写的非拉丁语言字母（韩语、阿拉伯语），因此整个 UI 必须符合，例如

*   第 1 项
*   第 2 项
*   第 3 项

必须是

阿拉伯语文本 1 -

阿拉伯语文本 2 -

阿拉伯语文本 3 -

（反向项目符号列表似乎不起作用：P）

如果您的系统必须在用户更改所使用的语言后动态地应用更改，这可能是 UI 的噩梦。

另一个非常困难的事情是测试不同的语言，不仅仅是为了单词的正确性，而且因为像韩语这样的语言通常有更大的字体类型，这可能会导致语言特定的错误（比如按钮上的“保存”文本大于某些语言的按钮本身）。

* * *

## 回答 #6

> 赞同：2
> 
> 时间：2008-10-14T12:39:16.593

发现一件更有趣的事情：斜体和粗体文本 makrup 不适用于 CJK（中文/日文/韩文）字符。它们只是变得不可读。（好吧，我之前也无法真正阅读它们，但尤其是粗体只会产生墨迹）

* * *

## 回答 #7

> 赞同：1
> 
> 时间：2008-09-18T19:25:06.180

我认为从事国际化工作的每个人都应该熟悉 Common Locale Data Repository，它现在是 Unicode 的一个子项目：

[通用语言环境数据存储库](http://unicode.org/cldr)

这些人正在努力为各种 i18n 问题建立标准资源：货币、地名、大量的东西。鉴于该项目存在，任何维护自己的核心本地数据的项目都是非常疯狂的，恕我直言。

* * *

## 回答 #8

> 赞同：1
> 
> 时间：2008-12-27T06:48:52.660

另一个挑战是接受用户的输入。在许多情况下，操作系统提供的输入处理（例如 Windows 中的 IME，它与常见的文本小部件透明地工作）可以缓解这种情况，但这种功能并非适用于所有可能的需求。

* * *

## 回答 #9

> 赞同：1
> 
> 时间：2008-12-27T04:05:44.157

我建议使用[99translations.com 之](http://99translations.com)类的东西来维护您的翻译。否则，您将无法分辨每种语言的哪些翻译是最新的。

* * *

## 回答 #10

> 赞同：0
> 
> 时间：2008-09-10T15:12:54.353

我使用的一个网站有一种翻译方法，所有者称之为“wiki + 机器翻译”。这是一个基于社区的网站，因此显然与公司的需求不同。

[http://blog.bookmooch.com/2007/09/23/how-bookmooch-does-its-translations/](http://blog.bookmooch.com/2007/09/23/how-bookmooch-does-its-translations/)

* * *

## 回答 #11

> 赞同：0
> 
> 时间：2008-10-07T10:56:59.933

还没有人提到的一件事是带有一些谨慎部分的字符串，例如“该单元将在 5 天内到货”或“星期一发生了一些事情”。其中 5 和星期一将根据状态而变化。将它们一分为二并将它们连接起来并不是一个好主意。只有一个不同的部分和好的文档，你可能会侥幸成功，有两个不同的部分会有一些语言更喜欢改变它们的顺序。

# html - 如何在连字符 (-) 等特殊字符后分词

> ID：904
> 
> 赞同：78
> 
> 时间：2008-08-04T00:17:34.690
> 
> 标签：html, css, text

给定一个相对简单的 CSS：

```
div {
  width: 150px;
}
```

```
<div>
  12333-2333-233-23339392-332332323
</div>
```

> 如何使字符串保持在`width` 150**的范围内，并在***连字符*上换行？

* * *

## 回答 #1

> 赞同：75
> 
> 时间：2008-08-04T00:25:11.227

用这个替换你的连字符：

```
&shy; 
```

它被称为“软”连字符。

```
div {
  width: 150px;
}
```

```
<div>
  12333&shy;2333&shy;233&shy;23339392&shy;332332323
</div>
```

* * *

## 回答 #2

> 赞同：34
> 
> 时间：2012-01-30T06:53:13.320

在所有现代浏览器^*（以及一些[较旧的浏览器](http://www.quirksmode.org/oddsandends/wbr.html)）中，该[`<wbr>`元素](https://developer.mozilla.org/en/HTML/Element/wbr)是提供在特定点打破长词的机会的完美工具。

引用该链接：

> Word Break Opportunity ( `<wbr>`) HTML 元素表示文本中浏览器可以选择换行的位置，尽管它的换行规则不会在该位置创建换行符。

以下是它在 OP 示例中的使用方式（或在[JSFiddle](http://jsfiddle.net/AdleyEskridge/qrgaK/)中查看它的实际应用）：

```
<div style="width: 150px;">
  12333-<wbr>2333-<wbr>233-<wbr>23339392-<wbr>332332323
</div> 
```

^*我已经在 IE9、IE10 以及最新版本的 Chrome、Firefox、Opera 和 Safari 中测试过了。

```
div {
  width: 150px;
}
```

```
<div>
  12333-<wbr>2333-<wbr>233-<wbr>23339392-<wbr>332332323
</div>
```

* * *

## 回答 #3

> 赞同：18
> 
> 时间：2008-08-04T00:25:28.403

作为 CSS3 的一部分，它尚未得到完全支持，[但您可以在此处找到有关自动换行的信息](http://www.css3.info/preview/word-wrap/)。另一个选项是[wbr 标签、­ 和 ​](http://www.quirksmode.org/oddsandends/wbr.html) 其中没有一个是完全支持的。

* * *

## 回答 #4

> 赞同：8
> 
> 时间：2008-09-15T23:15:35.183

您的示例在 Google Chrome、Safari (Windows) 和 IE8 中按预期工作。在 Firefox 3 和 Opera 9.5 中，文本超出了 150 像素的框。

此外`&shy;`不适用于您的示例，因为它会：

*   在分词时工作，但在不分词时不显示任何连字符，或

*   在不分词时工作，但在分词时显示两个连字符，因为它在中断时添加了一个连字符。

* * *

## 回答 #5

> 赞同：8
> 
> 时间：2008-12-05T12:36:27.603

在这个特定的例子中（你的字符串将包含连字符）我会将文本转换到这个服务器端：

```
<div style="width:150px;">
  <span>12333-</span><span>2333-</span><span>233-</span><span>23339392-</span><span>332332323</span>
</div>
```

* * *

## 回答 #6

> 赞同：7
> 
> 时间：2010-09-16T09:04:10.070

根据您想确切看到的内容，您可以使用`hyphen`、`soft hyphen`和/或的组合`zero width space`。

在软连字符上，您的浏览器可以分词（添加连字符）。在零宽度空间上，您的浏览器可以分词（不添加任何内容）。

因此，如果您的代码类似于：

`111111&shy;222222&shy;-333333&#8203;444444-&#8203;555555`

那么您的浏览器将显示此内容而没有分词：

> 1111112222222-33333334444444-5555555

这将是每一个可能的断词：

> 111111-
> 222222-
> -333333
> 444444-
> 555555

只需选择您需要的选项。在您的情况下，它可能是 4s 和 5s 之间的那个。

* * *

## 回答 #7

> 赞同：2
> 
> 时间：2015-08-27T12:40:39.950

您还可以使用：

```
word-break:break-all; 
```

前任。

```
<div style='width:10px'>ababababababbabaabababababababbabababa</div> 
```

输出：

```
abababababa
ababababbba
abbabbababa
ababb 
```

word-break 是打断所有单词或行，即使句子中没有空格且不超过提供的宽度或高度。为此，您必须提供宽度或高度。

* * *

## 回答 #8

> 赞同：0
> 
> 时间：2014-03-21T22:09:57.093

不间断的连字符效果很好。

**HTML 实体（十进制）**

```
&#8209; 
```

* * *

## 回答 #9

> 赞同：0
> 
> 时间：2015-05-14T04:29:27.450

`-`您可以使用`&hyphen;`or代替`\u2010`。

此外，请确保**hyphens** css 属性**未**设置为*none*（默认值为*manual*）。

`<wbr>`不受*Internet Explorer*支持。

* * *

## 回答 #10

> 赞同：0
> 
> 时间：2017-08-31T10:53:47.597

希望这可能会有所帮助

在要换行的地方使用`<br>`（中断）标签。

* * *

## 回答 #11

> 赞同：0
> 
> 时间：2018-09-13T10:21:04.287

您可以在连字符后使用 0 宽度空格：

```
div {
  width: 150px;
}
```

```
<div>
  12333-&#8203;2333-&#8203;233-&#8203;23339392-&#8203;332332323
</div>
```

如果您想在连字符之前换行，请`&#8203;-`改用。

# sql-server - 客户端排序规则和 SQL Server 2005

> ID：905
> 
> 赞同：14
> 
> 时间：2008-08-04T00:17:55.767
> 
> 标签：sql-server, sql-server-2005, windows-server-2003

我们正在将现有程序从 升级`Win2k/SQL Server 2k`到`Windows 2003 and SQL Server 2005`以及购买一个也使用`2k3/2k5`. 供应商说，为了让我们托管这两个数据库，我们需要获取企业版，因为软件客户端对连接使用不同的排序规则，并且只有企业支持。

我在 MS 的网站上找不到任何支持这一点的东西，老实说，如果标准版有效，我不想为 Enterprise 支付额外费用。我是否遗漏了一些未提及的 SQL Server 功能，或者正如我怀疑的那样，这是一个试图向我追加销售的供应商？

* * *

## 回答 #1

> 赞同：6
> 
> 时间：2008-08-04T01:13:06.247

所有版本的`SQL Server 2000/2005/2008`支持都有多个数据库，每个都使用自己的排序规则。您不需要企业版。

当您的数据库使用与数据库服务器的默认排序规则不同的排序规则序列时，如果您使用临时表和/或表变量，则需要采取一些额外的预防措施。临时表/变量存在于 tempdb 数据库中，该数据库使用主数据库使用的排序规则。请记住`COLLATE database_default`在临时表/变量中定义字符字段时使用“”。如果您想了解更多详细信息，我不久前[曾在博客上写过。](http://anotherlab.rajapet.net/2008/07/handling-collation-sequences-with.html)

# c# - 如何连接到数据库并在 C# 中循环记录集？

> ID：930
> 
> 赞同：48
> 
> 时间：2008-08-04T00:47:25.143
> 
> 标签：c#, database, loops, connection

在 C# 中连接和查询数据库以获取一组记录的最简单方法是什么？

* * *

## 回答 #1

> 赞同：35
> 
> 时间：2008-08-04T01:31:31.157

@Goyuix - 这对于从记忆中编写的东西来说非常棒。在这里测试它 - 发现连接没有打开。否则非常好。

```
using System.Data.OleDb;
...

using (OleDbConnection conn = new OleDbConnection())
{
    conn.ConnectionString = "Provider=sqloledb;Data Source=yourServername\\yourInstance;Initial Catalog=databaseName;Integrated Security=SSPI;";

    using (OleDbCommand cmd = new OleDbCommand())
    {
        conn.Open();
        cmd.Connection = conn;
        cmd.CommandText = "Select * from yourTable";

        using (OleDbDataReader dr = cmd.ExecuteReader())
        {
            while (dr.Read())
            {
                Console.WriteLine(dr["columnName"]);
            }
        }
    }
} 
```

* * *

## 回答 #2

> 赞同：17
> 
> 时间：2008-08-04T01:07:14.760

因为我在这台笔记本电脑上没有代码，所以非常粗略地从内存中获取：

```
using (OleDBConnection conn = new OleDbConnection())
{
  conn.ConnectionString = "Whatever connection string";

  using (OleDbCommand cmd = new OleDbCommand())
  {
    cmd.Connection = conn;
    cmd.CommandText = "Select * from CoolTable";

    using (OleDbDataReader dr = cmd.ExecuteReader())
    {
      while (dr.Read())
      {
        // do something like Console.WriteLine(dr["column name"] as String);
      }
    }
  }
} 
```

* * *

## 回答 #3

> 赞同：12
> 
> 时间：2008-08-04T04:45:05.367

这绝对是一个好方法。但是，如果您碰巧使用的是支持 LINQ to SQL 的数据库，那会更有趣。它看起来像这样：

```
MyDB db = new MyDB("Data Source=...");
var q = from db.MyTable
        select c;
foreach (var c in q)
  Console.WriteLine(c.MyField.ToString()); 
```

* * *

## 回答 #4

> 赞同：7
> 
> 时间：2008-08-05T14:17:22.530

这是另一种方式（DataReader 比这个更快）：

```
string s = "";
SqlConnection conn = new SqlConnection("Server=192.168.1.1;Database=master;Connect Timeout=30;User ID=foobar;Password=raboof;");
SqlDataAdapter da = new SqlDataAdapter("SELECT TOP 5 name, dbid FROM sysdatabases", conn);
DataTable dt = new DataTable();

da.Fill(dt);

for (int i = 0; i < dt.Rows.Count; i++)
{
    s += dt.Rows[i]["name"].ToString() + " -- " + dt.Rows[i]["dbid"].ToString() + "\n";
}

MessageBox.Show(s); 
```

* * *

## 回答 #5

> 赞同：4
> 
> 时间：2008-08-21T14:19:29.530

如果您正在查询 SQL Server 数据库（版本 7 及更高版本），则应将 OleDb 类替换为[System.Data.SqlClient](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient)命名空间（[SqlConnection](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlconnection)、[SqlCommand](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlcommand)和[SqlDataReader](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqldatareader)）中的相应类，因为这些类已针对 SQL Server 进行了优化。

另一件需要注意的事情是，您应该“永远不要”全选，因为如果您在此表中添加或删除列，这可能会导致稍后出现意外结果。

* * *

## 回答 #6

> 赞同：4
> 
> 时间：2008-09-15T19:07:17.307

如果您打算读取大量列或记录，那么缓存序号并访问强类型方法也是值得的，例如

```
using (DbDataReader dr = cmd.ExecuteReader()) {
  if (dr.Read()) {
    int idxColumnName = dr.GetOrdinal("columnName");
    int idxSomethingElse = dr.GetOrdinal("somethingElse");

    do {
      Console.WriteLine(dr.GetString(idxColumnName));
      Console.WriteLine(dr.GetInt32(idxSomethingElse));
    } while (dr.Read());
  }
} 
```

* * *

## 回答 #7

> 赞同：1
> 
> 时间：2012-09-05T19:11:25.733

我想，你可以试试实体框架。

```
using (SchoolDBEntities ctx = new SchoolDBEntities())
{
     IList<Course> courseList = ctx.GetCoursesByStudentId(1).ToList<Course>();
     //do something with courselist here
} 
```

* * *

## 回答 #8

> 赞同：0
> 
> 时间：2019-05-17T03:40:00.830

向图书馆收费

```
using MySql.Data.MySqlClient; 
```

这是连接：

```
public static MySqlConnection obtenerconexion()
{
    string server = "Server";
    string database = "Name_Database";
    string Uid = "User";
    string pwd = "Password";
    MySqlConnection conect = new MySqlConnection("server = " + server + ";" + "database =" + database + ";" + "Uid =" + Uid + ";" + "pwd=" + pwd + ";");

    try
    {
        conect.Open();
        return conect;
    }
    catch (Exception)
    {
        MessageBox.Show("Error. Ask the administrator", "An error has occurred while trying to connect to the system", MessageBoxButtons.OK, MessageBoxIcon.Error);
        return conect;
    }
} 
```

# string - postgresql 中的字符串文字和转义字符

> ID：935
> 
> 赞同：127
> 
> 时间：2008-08-04T01:00:24.837
> 
> 标签：string, postgresql, escaping

尝试将转义字符插入表中会导致警告。

例如：

```
create table EscapeTest (text varchar(50));

insert into EscapeTest (text) values ('This is the first part \n And this is the second'); 
```

产生警告：

```
WARNING:  nonstandard use of escape in a string literal 
```

（*使用 PSQL 8.2*）

有谁知道如何解决这个问题？

* * *

## 回答 #1

> 赞同：146
> 
> 时间：2008-08-04T01:07:03.233

部分。文本已插入，但仍会生成警告。

我发现一个讨论表明文本需要以'E'开头，如下所示：

```
insert into EscapeTest (text) values (E'This is the first part \n And this is the second'); 
```

这抑制了警告，但文本仍未正确返回。当我按照迈克尔的建议添加额外的斜线时，它起作用了。

像这样：

```
insert into EscapeTest (text) values (E'This is the first part \\n And this is the second'); 
```

* * *

## 回答 #2

> 赞同：44
> 
> 时间：2008-08-04T01:14:57.367

凉爽的。

我还找到了有关 E 的文档：

[http://www.postgresql.org/docs/8.3/interactive/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS](http://www.postgresql.org/docs/8.3/interactive/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS)

> PostgreSQL 还接受“转义”字符串常量，这是对 SQL 标准的扩展。转义字符串常量通过在开始单引号之前写入字母 E（大写或小写）来指定，例如 E'foo'。（跨行继续转义字符串常量时，仅在第一个开始引号之前写 E。）在转义字符串中，反斜杠字符 (\) 开始类似 C 的反斜杠转义序列，其中反斜杠和后续字符 ( s) 表示一个特殊的字节值。\b 是退格，\f 是换页，\n 是换行符，\r 是回车符，\t 是制表符。还支持 \digits，其中 digits 表示八进制字节值，以及 \xhexdigits，其中 hexdigits 表示十六进制字节值。（您有责任确保您创建的字节序列是服务器字符集编码中的有效字符。）反斜杠后面的任何其他字符都按字面意思表示。因此，要包含反斜杠字符，请编写两个反斜杠 (\\)。此外，除了通常的 '' 之外，还可以通过写 \' 将单引号包含在转义字符串中。

* * *

## 回答 #3

> 赞同：6
> 
> 时间：2010-02-16T23:51:23.200

发出警告是因为您在字符串中使用了反斜杠。如果您想避免该消息，请键入此命令“set standard_conforming_strings=on;”。然后在您的字符串之前使用“E”，包括您希望 postgresql 解释的反斜杠。

* * *

## 回答 #4

> 赞同：3
> 
> 时间：2008-09-19T19:24:55.850

我发现 Postgres 极不可能截断您的输入数据——它要么拒绝它，要么按原样存储它。

```
milen@dev:~$ psql
Welcome to psql 8.2.7, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

milen=> create table EscapeTest (text varchar(50));
CREATE TABLE
milen=> insert into EscapeTest (text) values ('This will be inserted \n This will not be');
WARNING:  nonstandard use of escape in a string literal
LINE 1: insert into EscapeTest (text) values ('This will be inserted...
                                              ^
HINT:  Use the escape string syntax for escapes, e.g., E'\r\n'.
INSERT 0 1
milen=> select * from EscapeTest;
          text
------------------------
 This will be inserted
  This will not be
(1 row)

milen=> 
```

* * *

## 回答 #5

> 赞同：0
> 
> 时间：2008-09-16T13:26:04.093

非常愚蠢的问题：您确定字符串被截断，而不仅仅是在您指定的换行符处中断（并且可能没有显示在您的界面中）？即，您是否希望该字段显示为

> 这将被插入 \n 这不会

或者

> 这将被插入
> 
> 这不会是

另外，你用的是什么接口？有没有可能有东西在吃你的反斜杠？

# c# - .NET 1.1 中未处理的异常处理程序

> ID：944
> 
> 赞同：31
> 
> 时间：2008-08-04T01:15:38.067
> 
> 标签：c#, .net, exception, exception-handling

我正在维护一个 .NET 1.1 应用程序，我的任务之一是确保用户看不到任何不友好的错误通知。

我已经向`Application.ThreadException`and添加了处理程序`AppDomain.CurrentDomain.UnhandledException`，它们确实被调用了。我的问题是仍然显示标准 CLR 错误对话框（在调用异常处理程序之前）。

[Jeff 在他的博客here](https://blog.codinghorror.com/console-apps-and-appdomain-currentdomain-unhandledexception/)和[here](https://blog.codinghorror.com/improved-unhandled-exception-behavior-in-net-20/)上谈到了这个问题。但是没有解决办法。那么.NET 1.1 中处理未捕获异常和显示友好对话框的标准方法是什么？

Jeff 的回答被标记为正确答案，因为他提供的链接包含有关如何执行所需操作的最完整信息。

* * *

## 回答 #1

> 赞同：13
> 
> 时间：2008-08-04T04:31:02.557

哦，在 Windows 窗体中，您绝对应该能够让它工作。您唯一需要注意的是发生在不同线程上的事情。

我在这里有一篇旧的代码项目文章，应该会有所帮助：

*[用户友好的异常处理](http://www.codeproject.com/KB/exception/ExceptionHandling.aspx)*

* * *

## 回答 #2

> 赞同：5
> 
> 时间：2008-08-04T10:20:01.260

**AppDomain.UnhandledException**是一个**事件**，而不是全局异常处理程序。这意味着，当它被提出时，您的应用程序已经处于下水道，除了进行清理和错误记录之外，您无能为力。

幕后发生的事情是这样的：框架检测到异常，将调用堆栈向上走到最顶部，没有找到可以从错误中恢复的处理程序，因此无法确定继续执行是否安全。因此，它启动了关闭序列并启动了这个事件，作为对你的礼貌，这样你就可以对你已经注定的过程表示敬意。当在主线程中未处理异常时会发生这种情况。

这种错误没有单点解决方案。您需要在发生此错误的所有位置的上游放置一个真正的异常处理程序（一个 catch 块），并将其转发到（例如）一个全局处理程序方法/类，该方法/类将确定是否可以安全地简单地报告并继续，基于异常类型和/或内容。

编辑：可以禁用（=hack）Windows 内置的错误报告机制，因此当您的应用程序出现故障时，不会显示强制性的“崩溃和刻录”对话框。但是，这对系统中的*所有*应用程序都有效，而不仅仅是您自己的应用程序。

* * *

## 回答 #3

> 赞同：5
> 
> 时间：2008-09-20T15:52:49.377

.NET 1.x Windows 窗体应用程序中未处理的异常行为取决于：

*   引发异常的线程类型
*   是否在窗口消息处理过程中发生
*   调试器是否附加到进程
*   DbgJitDebugLaunchSetting 注册表设置
*   App.Config 中的 jitDebugging 标志
*   是否覆盖 Windows 窗体异常处理程序
*   是否处理了 CLR 的异常事件
*   月相

未处理异常的默认行为是：

*   如果在泵送窗口消息时在主线程上发生异常，它会被 Windows 窗体异常处理程序拦截。
*   如果在泵送窗口消息时在主线程上发生异常，它将终止应用程序进程，除非它被 Windows 窗体异常处理程序拦截。
*   如果异常发生在手动、线程池或终结器线程上，则会被 CLR 吞下。

未处理异常的联系点是：

*   Windows 窗体异常处理程序。
*   JIT 调试注册表开关 DbgJitDebugLaunchSetting。
*   CLR 未处理的异常事件。

默认情况下，Windows 窗体内置异常处理执行以下操作：

*   在以下情况下捕获未处理的异常：
    *   异常在主线程上并且没有附加调试器。
    *   窗口消息处理期间发生异常。
    *   App.Config 中的 jitDebugging = false。
*   向用户显示对话框并防止应用程序终止。

您可以通过设置 jitDebugging = true 来禁用后一种行为`App.Config`。但请记住，这可能是您停止应用程序终止的最后机会。因此，捕获未处理异常的下一步是注册事件 Application.ThreadException，例如：

```
Application.ThreadException += new
Threading.ThreadExceptionHandler(CatchFormsExceptions); 
```

请注意 HKEY_LOCAL_MACHINE\Software.NetFramework 下的注册表设置 DbgJitDebugLaunchSetting。这具有我知道的三个值之一：

*   0：显示询问“调试或终止”的用户对话框。
*   1：让异常通过让CLR来处理。
*   2：启动 DbgManagedDebugger 注册表项中指定的调试器。

在 Visual Studio 中，转到菜单*工具*→*选项*→*调试*→ *JIT*将此键设置为 0 或 2。但值 1 通常在最终用户的计算机上最好。请注意，此注册表项在 CLR 未处理异常事件之前执行。

这最后一个事件是您记录未处理异常的最后机会。它在您的 finally 块执行之前触发。您可以按如下方式拦截此事件：

```
AppDomain.CurrentDomain.UnhandledException += new
System.UnhandledExceptionEventHandler(CatchClrExceptions); 
```

* * *

## 回答 #4

> 赞同：3
> 
> 时间：2008-08-04T02:45:07.717

这是控制台应用程序还是 Windows 窗体应用程序？如果它是一个 .NET 1.1 控制台应用程序，很遗憾，这是设计使然——MSFT 开发人员在[您引用的第二篇博](https://blog.codinghorror.com/improved-unhandled-exception-behavior-in-net-20/)文中证实了这一点：

> 顺便说一句，在我的 1.1 机器上，来自 MSDN 的示例确实具有预期的输出；只是在您附加调试器（或不附加）之后，第二行才会显示。在 v2 中，我们进行了翻转，以便在调试器附加之前触发 UnhandledException 事件，这似乎是大多数人所期望的。

听起来 .NET 2.0 在这方面做得更好（谢天谢地），但老实说，我从来没有时间回去检查。

* * *

## 回答 #5

> 赞同：1
> 
> 时间：2008-08-04T02:54:15.683

这是一个 Windows 窗体应用程序。Application.ThreadException 捕获的异常工作正常，我没有得到丑陋的 .NET 异常框（`OK`终止，`Cancel`调试？谁想出了这个？？）。

我得到了一些没有被它捕获的异常，最终导致了导致问题的 AppDomain.UnhandledException 事件。我想我已经捕获了大部分异常，现在我将它们显示在我们漂亮的错误框中。

所以我只希望没有其他情况会导致 Application.ThreadException 处理程序无法捕获异常。

* * *

## 回答 #6

> 赞同：0
> 
> 时间：2022-01-28T06:42:56.517

**简短的回答，** *看起来，Form.Load 中发生的异常在没有附加调试器的情况下不会路由到 Application.ThreadException 或 AppDomain.CurrentDomain.UnhandledException。*

**更准确的答案/故事** 这就是我解决类似问题的方法。我不能确定它是如何做到的，但这是我的想法。欢迎提出改进建议。

三个事件，

1.  AppDomain.CurrentDomain.FirstChanceException
2.  AppDomain.CurrentDomain.UnhandledException
3.  和 Application.ThreadException

累积捕获大多数异常，但不在全局范围内（如前所述）。在我的一个应用程序中，我结合使用这些来捕获各种异常，甚至是非托管代码异常，如 DirectX 异常（通过 SharpDX）。所有异常，无论是否被捕获，似乎都在毫无疑问地调用 FirstChanceException。

```
AppDomain.CurrentDomain.FirstChanceException += MyFirstChanceExceptionHandler;
Application.SetUnhandledExceptionMode(UnhandledExceptionMode.CatchException); // not sure if this is important or not.
AppDomain.CurrentDomain.UnhandledException += CurrentDomain_UnhandledException; // can't use Lambda here. need to Unsub this event later.
Application.ThreadException += (s, e) => MyUnhandledExceptionHandler(e.Exception);

static void CurrentDomain_UnhandledException(object sender, UnhandledExceptionEventArgs e)
{
    MyUnhandledExceptionHandler((Exception)e.ExceptionObject);
}
private void CurrentDomain_FirstChanceException(object sender, System.Runtime.ExceptionServices.FirstChanceExceptionEventArgs eventArgs)
{
    // detect the pattern of the exception which we won't be able to get in Fatal events.
    if (eventArgs.Exception.Message.StartsWith("HRESULT"))
        MyUnhandledExceptionHandler(eventArgs.Exception);
} 
```

处理程序看起来像

```
static void MyUnhandledExceptionHandler(Exception ex)
{
    AppDomain.CurrentDomain.UnhandledException -= MyUnhandledExceptionHandler;  // this is important. Any exception occuring in the logging mechanism can cause a stack overflow exception which triggers the window's own JIT message/App crash message if Win JIT is not available.
    // LogTheException()
    // Collect user data
    // inform the user in a civil way to restart/close the app
    Environment.Exit(0);
} 
```

像 DirectX 异常这样的非托管代码异常只出现在 FirstChanceException 中，我必须自己决定异常是否致命。然后我使用 MyUnhandledExceptionHandler 进行记录，并以友好的方式让用户知道一切都在“控制之下”。

**重要的提示！** 该方案仍然没有捕获一种异常。它确实出现在 FirstChanceException 中，但很难将它与其他类型的异常处理此处理程序区分开来。在 Form.Load 中直接发生的任何异常都有这种不同的行为。当附加 VS 调试器时，这些被路由到 UnhandledException 事件。但是如果没有调试器，则会弹出一条老式的 windows 消息，显示发生的异常的堆栈跟踪。最烦人的是，它并没有让MyUnhandledExceptionHandlerr一旦完成就被踢，并且应用程序继续在异常状态下工作。我所做的最终解决方案是将所有代码从 Form_load 移动到另一个线程使用`MyForm.Load += (s,e) => new Thread(()=>{/* My Form_Load code*/ }).Start();`. 这样，Application.ThreadException 被触发，它被路由到 MyUnhandledExceptionHandler，我的安全出口。

# vb6 - 如何在 Visual Basic 中使用互斥锁

> ID：947
> 
> 赞同：26
> 
> 时间：2008-08-04T01:22:49.830
> 
> 标签：vb6, mutex

我已经导入了`kernel32`库。所以，我有`createMutex`可用的函数，但我不太确定各种参数和返回值。

这是经典的 Visual Basic，而不是 Visual Basic.NET，但我可能可以以答案的形式使用任何一种语言。

* * *

## 回答 #1

> 赞同：10
> 
> 时间：2008-09-17T12:01:56.643

[这是CreateMutex](http://msdn.microsoft.com/en-us/library/ms682411(VS.85).aspx)的 VB6 声明- 我刚刚从 API 查看器中复制了它们，您应该将其作为 VB6 安装的一部分。VB6 使用当前代码页将字符串编组为以空值结尾的 ANSI。

```
Public Type SECURITY_ATTRIBUTES
   nLength As Long
   lpSecurityDescriptor As Long
   bInheritHandle As Long 
End Type

Public Declare Function CreateMutex Lib "kernel32" Alias "CreateMutexA" _
   (lpMutexAttributes As SECURITY_ATTRIBUTES, ByVal bInitialOwner As Long, _
    ByVal lpName As String) As Long 
```

请记住，如果您从 VB6 IDE 创建互斥锁，则互斥锁属于 IDE，并且在您停止运行程序时不会被销毁 - 只有在您关闭 IDE 时才会销毁。

* * *

## 回答 #2

> 赞同：8
> 
> 时间：2008-08-04T04:58:40.300

VB 代码如下所示：

```
hMutex = CreateMutex(ByVal 0&, 1, ByVal 0&) 
```

第一个参数是指向`SECURITY_ATTRIBUTES`结构的指针。如果你不知道它是什么，你就不需要它。传递 NULL (0)。

如果调用线程应该取得互斥锁的所有权，则第二个参数是`TRUE`（非零或 1）。`FALSE`除此以外。

第三个参数是互斥体名称，可以为 NULL (0)，如图所示。如果您需要一个命名的互斥锁，请将名称（任何唯一的）传入。不确定包装器是否`VB`将长度前缀`VB`字符串类型（`BSTR`并且有很多例子。

祝你好运！

* * *

## 回答 #3

> 赞同：1
> 
> 时间：2008-08-04T04:48:40.697

好吧，根据[文档](http://msdn.microsoft.com/en-us/library/ms682411(VS.85).aspx)，它看起来像：

1.  安全属性（可以传递 null）
2.  是否最初拥有（可以传递假）
3.  它的名字

高温高压

# python - 向现有对象实例添加方法

> ID：972
> 
> 赞同：772
> 
> 时间：2008-08-04T02:17:51.780
> 
> 标签：python, oop, methods, monkeypatching

我读过可以在 Python 中向现有对象（即不在类定义中）添加方法。

我知道这样做并不总是好的。但是如何做到这一点呢？

* * *

## 回答 #1

> 赞同：1073
> 
> 时间：2008-08-06T00:33:35.063

在 Python 中，函数和绑定方法是有区别的。

```
>>> def foo():
...     print "foo"
...
>>> class A:
...     def bar( self ):
...         print "bar"
...
>>> a = A()
>>> foo
<function foo at 0x00A98D70>
>>> a.bar
<bound method A.bar of <__main__.A instance at 0x00A9BC88>>
>>> 
```

绑定方法已“绑定”（如何描述）到一个实例，并且每当调用该方法时，该实例将作为第一个参数传递。

但是，作为类属性（而不是实例）的可调用对象仍然是未绑定的，因此您可以随时修改类定义：

```
>>> def fooFighters( self ):
...     print "fooFighters"
...
>>> A.fooFighters = fooFighters
>>> a2 = A()
>>> a2.fooFighters
<bound method A.fooFighters of <__main__.A instance at 0x00A9BEB8>>
>>> a2.fooFighters()
fooFighters 
```

先前定义的实例也会更新（只要它们本身没有覆盖属性）：

```
>>> a.fooFighters()
fooFighters 
```

当您想将方法附加到单个实例时，问题就来了：

```
>>> def barFighters( self ):
...     print "barFighters"
...
>>> a.barFighters = barFighters
>>> a.barFighters()
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: barFighters() takes exactly 1 argument (0 given) 
```

该函数在直接附加到实例时不会自动绑定：

```
>>> a.barFighters
<function barFighters at 0x00A98EF0> 
```

要绑定它，我们可以使用[types 模块中的 MethodType 函数](https://docs.python.org/3/library/types.html#types.MethodType)：

```
>>> import types
>>> a.barFighters = types.MethodType( barFighters, a )
>>> a.barFighters
<bound method ?.barFighters of <__main__.A instance at 0x00A9BC88>>
>>> a.barFighters()
barFighters 
```

这次该类的其他实例没有受到影响：

```
>>> a2.barFighters()
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
AttributeError: A instance has no attribute 'barFighters' 
```

[通过阅读有关描述符](https://docs.python.org/3/howto/descriptor.html)和[元类](https://web.archive.org/web/20090124004817/http://www.onlamp.com/pub/a/python/2003/04/17/metaclasses.html) [编程](http://www.gnosis.cx/publish/programming/metaclass_2.html)可以找到更多信息。

* * *

## 回答 #2

> 赞同：135
> 
> 时间：2015-01-21T05:31:23.257

前言 - 关于兼容性的说明：其他答案可能仅适用于 Python 2 - 此答案在 Python 2 和 3 中应该可以很好地工作。如果只编写 Python 3，您可能会省略显式继承 from `object`，否则代码应该保持不变.

> # 向现有对象实例添加方法
> 
> 我读过可以在 Python 中向现有对象（例如不在类定义中）添加方法。
> 
> 我知道这样做并不总是一个好的决定。**但是，怎么可能做到这一点？**

## 是的，有可能 - 但不推荐

我不推荐这个。这是一个坏主意。不要这样做。

这里有几个原因：

*   您将为执行此操作的每个实例添加一个绑定对象。如果你经常这样做，你可能会浪费很多内存。绑定方法通常仅在其调用的短时间内创建，然后在自动垃圾收集时它们不再存在。如果您手动执行此操作，您将拥有一个引用绑定方法的名称绑定 - 这将阻止其在使用时进行垃圾收集。
*   给定类型的对象实例通常在该类型的所有对象上都有其方法。如果您在其他地方添加方法，则某些实例将具有这些方法，而其他实例则没有。程序员不会预料到这一点，您可能会违反[最小意外规则](https://en.wikipedia.org/wiki/Principle_of_least_astonishment)。
*   由于还有其他非常好的理由不这样做，所以如果你这样做，你也会给自己留下不好的名声。

因此，我建议您不要这样做，除非您有充分的理由。**最好在类定义中定义正确的方法，**或者直接*对*类进行猴子补丁，如下所示：

```
Foo.sample_method = sample_method 
```

但是，由于它具有指导意义，因此我将向您展示一些这样做的方法。

## 怎么做

这是一些设置代码。我们需要一个类定义。它可以进口，但它真的不重要。

```
class Foo(object):
    '''An empty class to demonstrate adding a method to an instance''' 
```

创建一个实例：

```
foo = Foo() 
```

创建一个方法来添加它：

```
def sample_method(self, bar, baz):
    print(bar + baz) 
```

### Method naught (0) - 使用描述符方法，`__get__`

函数的虚线查找`__get__`使用实例调用函数的方法，将对象绑定到方法，从而创建“绑定方法”。

```
foo.sample_method = sample_method.__get__(foo) 
```

现在：

```
>>> foo.sample_method(1,2)
3 
```

### 方法一——types.MethodType

首先，导入类型，我们将从中获取方法构造函数：

```
import types 
```

现在我们将方法添加到实例中。为此，我们需要`types`模块（我们在上面导入）中的 MethodType 构造函数。

types.MethodType（在 Python 3 中）的参数签名是`(function, instance)`：

```
foo.sample_method = types.MethodType(sample_method, foo) 
```

和用法：

```
>>> foo.sample_method(1,2)
3 
```

顺便说一句，在 Python 2 中，签名是`(function, instance, class)`：

```
foo.sample_method = types.MethodType(sample_method, foo, Foo) 
```

### 方法二：词法绑定

首先，我们创建一个将方法绑定到实例的包装函数：

```
def bind(instance, method):
    def binding_scope_fn(*args, **kwargs): 
        return method(instance, *args, **kwargs)
    return binding_scope_fn 
```

用法：

```
>>> foo.sample_method = bind(foo, sample_method)    
>>> foo.sample_method(1,2)
3 
```

### 方法三：functools.partial

部分函数将第一个参数应用于函数（以及可选的关键字参数），稍后可以使用剩余的参数（和覆盖的关键字参数）调用。因此：

```
>>> from functools import partial
>>> foo.sample_method = partial(sample_method, foo)
>>> foo.sample_method(1,2)
3 
```

当您认为绑定方法是实例的部分函数时，这是有道理的。

## 作为对象属性的未绑定函数 - 为什么这不起作用：

如果我们尝试以与将其添加到类中相同的方式添加 sample_method，则它与实例解除绑定，并且不会将隐式 self 作为第一个参数。

```
>>> foo.sample_method = sample_method
>>> foo.sample_method(1,2)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: sample_method() takes exactly 3 arguments (2 given) 
```

我们可以通过显式传递实例（或任何东西，因为此方法实际上不使用`self`参数变量）使未绑定函数工作，但它与其他实例的预期签名不一致（如果我们正在猴子补丁本例）：

```
>>> foo.sample_method(foo, 1, 2)
3 
```

## 结论

你现在知道了几种方法*可以*做到这一点，但说真的——不要这样做。

* * *

## 回答 #3

> 赞同：104
> 
> 时间：2009-06-06T05:31:38.817

模块**new**自 python 2.6 以来已弃用并在 3.0 中删除，使用**类型**

见[http://docs.python.org/library/new.html](http://docs.python.org/library/new.html)

在下面的示例中，我故意从`patch_me()`函数中删除了返回值。我认为给出返回值可能会让人们相信补丁返回一个新对象，这是不正确的——它修改了传入的对象。这可能有助于更规范地使用猴子补丁。

```
import types

class A(object):#but seems to work for old style objects too
    pass

def patch_me(target):
    def method(target,x):
        print "x=",x
        print "called from", target
    target.method = types.MethodType(method,target)
    #add more if needed

a = A()
print a
#out: <__main__.A object at 0x2b73ac88bfd0>  
patch_me(a)    #patch instance
a.method(5)
#out: x= 5
#out: called from <__main__.A object at 0x2b73ac88bfd0>
patch_me(A)
A.method(6)        #can patch class too
#out: x= 6
#out: called from <class '__main__.A'> 
```

* * *

## 回答 #4

> 赞同：42
> 
> 时间：2012-01-22T14:20:54.837

我认为上面的答案错过了关键点。

让我们有一个带有方法的类：

```
class A(object):
    def m(self):
        pass 
```

现在，让我们在 ipython 中使用它：

```
In [2]: A.m
Out[2]: <unbound method A.m> 
```

好的，所以*m()*以某种方式成为*A*的未绑定方法。但真的是这样吗？

```
In [5]: A.__dict__['m']
Out[5]: <function m at 0xa66b8b4> 
```

事实证明，*m()*只是一个函数，对它的引用被添加到*A*类字典 - 没有魔法。那为什么*Am*给了我们一个 unbound 方法呢？这是因为点没有被翻译成简单的字典查找。这实际上是对 A.__class__.__getattribute__(A, 'm') 的调用：

```
In [11]: class MetaA(type):
   ....:     def __getattribute__(self, attr_name):
   ....:         print str(self), '-', attr_name

In [12]: class A(object):
   ....:     __metaclass__ = MetaA

In [23]: A.m
<class '__main__.A'> - m
<class '__main__.A'> - m 
```

现在，我不确定为什么最后一行打印了两次，但仍然很清楚那里发生了什么。

现在，默认的 __getattribute__ 所做的是检查属性是否是所谓的[描述符](http://docs.python.org/reference/datamodel.html#implementing-descriptors)，即它是否实现了特殊的 __get__ 方法。如果它实现了那个方法，那么返回的是调用那个 __get__ 方法的结果。回到我们*A*类的第一个版本，这就是我们所拥有的：

```
In [28]: A.__dict__['m'].__get__(None, A)
Out[28]: <unbound method A.m> 
```

并且因为 Python 函数实现了描述符协议，如果它们被代表一个对象调用，它们会在它们的 __get__ 方法中将自己绑定到该对象。

好的，那么如何向现有对象添加方法？假设您不介意修补类，它很简单：

```
B.m = m 
```

然后*Bm* “成为” 一个未绑定的方法，这要归功于描述符魔术。

而且，如果您只想将方法添加到单个对象，则必须自己模拟机器，使用 types.MethodType：

```
b.m = types.MethodType(m, b) 
```

顺便一提：

```
In [2]: A.m
Out[2]: <unbound method A.m>

In [59]: type(A.m)
Out[59]: <type 'instancemethod'>

In [60]: type(b.m)
Out[60]: <type 'instancemethod'>

In [61]: types.MethodType
Out[61]: <type 'instancemethod'> 
```

* * *

## 回答 #5

> 赞同：27
> 
> 时间：2008-08-04T02:31:13.250

在 Python 中，monkeypatching 通常通过用您自己的覆盖类或函数的签名来工作。[下面是来自Zope Wiki](http://web.archive.org/web/20130610034152/http://wiki.zope.org:80/zope2/MonkeyPatch)的示例：

```
from SomeOtherProduct.SomeModule import SomeClass
def speak(self):
   return "ook ook eee eee eee!"
SomeClass.speak = speak 
```

此代码将覆盖/创建`speak`在类中调用的方法。在 Jeff Atwood[最近关于猴子补丁的帖子中](https://blog.codinghorror.com/monkeypatching-for-humans/)，他展示了 C# 3.0 中的一个示例，这是我当前用于工作的语言。

* * *

## 回答 #6

> 赞同：18
> 
> 时间：2014-07-21T12:55:54.433

您可以使用 lambda 将方法绑定到实例：

```
def run(self):
    print self._instanceString

class A(object):
    def __init__(self):
        self._instanceString = "This is instance string"

a = A()
a.run = lambda: run(a)
a.run() 
```

输出：

```
This is instance string 
```

* * *

## 回答 #7

> 赞同：11
> 
> 时间：2013-04-26T15:47:35.480

至少有两种方法可以将方法附加到没有 的实例`types.MethodType`：

```
>>> class A:
...  def m(self):
...   print 'im m, invoked with: ', self

>>> a = A()
>>> a.m()
im m, invoked with:  <__main__.A instance at 0x973ec6c>
>>> a.m
<bound method A.m of <__main__.A instance at 0x973ec6c>>
>>> 
>>> def foo(firstargument):
...  print 'im foo, invoked with: ', firstargument

>>> foo
<function foo at 0x978548c> 
```

1：

```
>>> a.foo = foo.__get__(a, A) # or foo.__get__(a, type(a))
>>> a.foo()
im foo, invoked with:  <__main__.A instance at 0x973ec6c>
>>> a.foo
<bound method A.foo of <__main__.A instance at 0x973ec6c>> 
```

2：

```
>>> instancemethod = type(A.m)
>>> instancemethod
<type 'instancemethod'>
>>> a.foo2 = instancemethod(foo, a, type(a))
>>> a.foo2()
im foo, invoked with:  <__main__.A instance at 0x973ec6c>
>>> a.foo2
<bound method instance.foo of <__main__.A instance at 0x973ec6c>> 
```

有用的链接：
[数据模型 - 调用描述符](http://docs.python.org/2/reference/datamodel.html#invoking-descriptors)
[Descriptor HowTo Guide - 调用描述符](http://docs.python.org/2.7/howto/descriptor.html#invoking-descriptors)

* * *

## 回答 #8

> 赞同：10
> 
> 时间：2008-08-07T11:30:16.047

你要找的是`setattr`我相信的。使用它来设置对象的属性。

```
>>> def printme(s): print repr(s)
>>> class A: pass
>>> setattr(A,'printme',printme)
>>> a = A()
>>> a.printme() # s becomes the implicit 'self' variable
< __ main __ . A instance at 0xABCDEFG> 
```

* * *

## 回答 #9

> 赞同：7
> 
> 时间：2012-01-28T00:12:05.800

合并 Jason Pratt 和社区 wiki 的答案，看看不同绑定方法的结果：

特别注意将绑定函数添加为类方法是如何*工作*的，但引用范围不正确。

```
#!/usr/bin/python -u
import types
import inspect

## dynamically adding methods to a unique instance of a class

# get a list of a class's method type attributes
def listattr(c):
    for m in [(n, v) for n, v in inspect.getmembers(c, inspect.ismethod) if isinstance(v,types.MethodType)]:
        print m[0], m[1]

# externally bind a function as a method of an instance of a class
def ADDMETHOD(c, method, name):
    c.__dict__[name] = types.MethodType(method, c)

class C():
    r = 10 # class attribute variable to test bound scope

    def __init__(self):
        pass

    #internally bind a function as a method of self's class -- note that this one has issues!
    def addmethod(self, method, name):
        self.__dict__[name] = types.MethodType( method, self.__class__ )

    # predfined function to compare with
    def f0(self, x):
        print 'f0\tx = %d\tr = %d' % ( x, self.r)

a = C() # created before modified instnace
b = C() # modified instnace

def f1(self, x): # bind internally
    print 'f1\tx = %d\tr = %d' % ( x, self.r )
def f2( self, x): # add to class instance's .__dict__ as method type
    print 'f2\tx = %d\tr = %d' % ( x, self.r )
def f3( self, x): # assign to class as method type
    print 'f3\tx = %d\tr = %d' % ( x, self.r )
def f4( self, x): # add to class instance's .__dict__ using a general function
    print 'f4\tx = %d\tr = %d' % ( x, self.r )

b.addmethod(f1, 'f1')
b.__dict__['f2'] = types.MethodType( f2, b)
b.f3 = types.MethodType( f3, b)
ADDMETHOD(b, f4, 'f4')

b.f0(0) # OUT: f0   x = 0   r = 10
b.f1(1) # OUT: f1   x = 1   r = 10
b.f2(2) # OUT: f2   x = 2   r = 10
b.f3(3) # OUT: f3   x = 3   r = 10
b.f4(4) # OUT: f4   x = 4   r = 10

k = 2
print 'changing b.r from {0} to {1}'.format(b.r, k)
b.r = k
print 'new b.r = {0}'.format(b.r)

b.f0(0) # OUT: f0   x = 0   r = 2
b.f1(1) # OUT: f1   x = 1   r = 10  !!!!!!!!!
b.f2(2) # OUT: f2   x = 2   r = 2
b.f3(3) # OUT: f3   x = 3   r = 2
b.f4(4) # OUT: f4   x = 4   r = 2

c = C() # created after modifying instance

# let's have a look at each instance's method type attributes
print '\nattributes of a:'
listattr(a)
# OUT:
# attributes of a:
# __init__ <bound method C.__init__ of <__main__.C instance at 0x000000000230FD88>>
# addmethod <bound method C.addmethod of <__main__.C instance at 0x000000000230FD88>>
# f0 <bound method C.f0 of <__main__.C instance at 0x000000000230FD88>>

print '\nattributes of b:'
listattr(b)
# OUT:
# attributes of b:
# __init__ <bound method C.__init__ of <__main__.C instance at 0x000000000230FE08>>
# addmethod <bound method C.addmethod of <__main__.C instance at 0x000000000230FE08>>
# f0 <bound method C.f0 of <__main__.C instance at 0x000000000230FE08>>
# f1 <bound method ?.f1 of <class __main__.C at 0x000000000237AB28>>
# f2 <bound method ?.f2 of <__main__.C instance at 0x000000000230FE08>>
# f3 <bound method ?.f3 of <__main__.C instance at 0x000000000230FE08>>
# f4 <bound method ?.f4 of <__main__.C instance at 0x000000000230FE08>>

print '\nattributes of c:'
listattr(c)
# OUT:
# attributes of c:
# __init__ <bound method C.__init__ of <__main__.C instance at 0x0000000002313108>>
# addmethod <bound method C.addmethod of <__main__.C instance at 0x0000000002313108>>
# f0 <bound method C.f0 of <__main__.C instance at 0x0000000002313108>> 
```

就个人而言，我更喜欢外部 ADDMETHOD 函数路由，因为它还允许我在迭代器中动态分配新方法名称。

```
def y(self, x):
    pass
d = C()
for i in range(1,5):
    ADDMETHOD(d, y, 'f%d' % i)
print '\nattributes of d:'
listattr(d)
# OUT:
# attributes of d:
# __init__ <bound method C.__init__ of <__main__.C instance at 0x0000000002303508>>
# addmethod <bound method C.addmethod of <__main__.C instance at 0x0000000002303508>>
# f0 <bound method C.f0 of <__main__.C instance at 0x0000000002303508>>
# f1 <bound method ?.y of <__main__.C instance at 0x0000000002303508>>
# f2 <bound method ?.y of <__main__.C instance at 0x0000000002303508>>
# f3 <bound method ?.y of <__main__.C instance at 0x0000000002303508>>
# f4 <bound method ?.y of <__main__.C instance at 0x0000000002303508>> 
```

* * *

## 回答 #10

> 赞同：7
> 
> 时间：2012-03-09T15:07:08.730

由于这个问题要求非 Python 版本，这里是 JavaScript：

```
a.methodname = function () { console.log("Yay, a new method!") } 
```

* * *

## 回答 #11

> 赞同：7
> 
> 时间：2015-08-18T15:32:47.100

# 这实际上是对“杰森普拉特”答案的补充

尽管 Jasons 的回答有效，但它只有在想要向类中添加函数时才有效。当我尝试从 .py 源代码文件重新加载已经存在的方法时，它对我不起作用。

我花了很长时间才找到解决方法，但诀窍似乎很简单...... 1.st 从源代码文件中导入代码 2.nd 强制重新加载 3.rd 使用 types.FunctionType(...) 来转换将方法导入和绑定到函数，您还可以传递当前的全局变量，因为重新加载的方法将位于不同的命名空间 4.th 现在您可以按照“Jason Pratt”的建议继续使用 types.MethodType(... )

例子：

```
# this class resides inside ReloadCodeDemo.py
class A:
    def bar( self ):
        print "bar1"

    def reloadCode(self, methodName):
        ''' use this function to reload any function of class A'''
        import types
        import ReloadCodeDemo as ReloadMod # import the code as module
        reload (ReloadMod) # force a reload of the module
        myM = getattr(ReloadMod.A,methodName) #get reloaded Method
        myTempFunc = types.FunctionType(# convert the method to a simple function
                                myM.im_func.func_code, #the methods code
                                globals(), # globals to use
                                argdefs=myM.im_func.func_defaults # default values for variables if any
                                ) 
        myNewM = types.MethodType(myTempFunc,self,self.__class__) #convert the function to a method
        setattr(self,methodName,myNewM) # add the method to the function

if __name__ == '__main__':
    a = A()
    a.bar()
    # now change your code and save the file
    a.reloadCode('bar') # reloads the file
    a.bar() # now executes the reloaded code 
```

* * *

## 回答 #12

> 赞同：5
> 
> 时间：2015-12-21T21:39:00.280

这个问题是几年前提出的，但是，有一种简单的方法可以使用装饰器模拟函数与类实例的绑定：

```
def binder (function, instance):
  copy_of_function = type (function) (function.func_code, {})
  copy_of_function.__bind_to__ = instance
  def bound_function (*args, **kwargs):
    return copy_of_function (copy_of_function.__bind_to__, *args, **kwargs)
  return bound_function

class SupaClass (object):
  def __init__ (self):
    self.supaAttribute = 42

def new_method (self):
  print self.supaAttribute

supaInstance = SupaClass ()
supaInstance.supMethod = binder (new_method, supaInstance)

otherInstance = SupaClass ()
otherInstance.supaAttribute = 72
otherInstance.supMethod = binder (new_method, otherInstance)

otherInstance.supMethod ()
supaInstance.supMethod () 
```

在那里，当您将函数和实例传递给 binder 装饰器时，它将创建一个新函数，其代码对象与第一个函数相同。然后，类的给定实例存储在新创建的函数的属性中。装饰器返回一个（第三个）函数，自动调用复制的函数，将实例作为第一个参数。

总之，你得到一个模拟它绑定到类实例的函数。保持原有功能不变。

* * *

## 回答 #13

> 赞同：4
> 
> 时间：2014-07-15T02:12:30.970

如果有帮助的话，我最近发布了一个名为 Gorilla 的 Python 库，以使猴子修补的过程更加方便。

使用函数`needle()`来修补名为的模块`guineapig`如下：

```
import gorilla
import guineapig
@gorilla.patch(guineapig)
def needle():
    print("awesome") 
```

但它也处理更多有趣的用例，如[文档中的](http://gorilla.readthedocs.org/)[常见问题解答](http://gorilla.readthedocs.org/en/latest/faq.html)中所示。

代码可在[GitHub](https://github.com/christophercrouzet/gorilla)上找到。

* * *

## 回答 #14

> 赞同：4
> 
> 时间：2017-04-30T04:57:29.433

我觉得奇怪的是，没有人提到上面列出的所有方法都会在添加的方法和实例之间创建循环引用，从而导致对象在垃圾回收之前一直存在。有一个老技巧是通过扩展对象的类来添加描述符：

```
def addmethod(obj, name, func):
    klass = obj.__class__
    subclass = type(klass.__name__, (klass,), {})
    setattr(subclass, name, func)
    obj.__class__ = subclass 
```

* * *

## 回答 #15

> 赞同：3
> 
> 时间：2008-08-22T14:40:21.033

Jason Pratt 发布的内容是正确的。

```
>>> class Test(object):
...   def a(self):
...     pass
... 
>>> def b(self):
...   pass
... 
>>> Test.b = b
>>> type(b)
<type 'function'>
>>> type(Test.a)
<type 'instancemethod'>
>>> type(Test.b)
<type 'instancemethod'> 
```

如您所见，Python 认为 b() 与 a() 没有任何不同。在 Python 中，所有方法都只是恰好是函数的变量。

* * *

## 回答 #16

> 赞同：3
> 
> 时间：2017-07-27T04:21:24.750

```
from types import MethodType

def method(self):
   print 'hi!'

setattr( targetObj, method.__name__, MethodType(method, targetObj, type(method)) ) 
```

有了这个，你可以使用自指针

* * *

## 回答 #17

> 赞同：0
> 
> 时间：2022-01-11T07:21:58.580

# 如何从类的实例中恢复类

```
class UnderWater:
    def __init__(self):
        self.net = 'underwater'

marine = UnderWater() # Instantiate the class

# Recover the class from the instance and add attributes to it.
class SubMarine(marine.__class__):  
    def __init__(self):
        super().__init__()
            self.sound = 'Sonar'

print(SubMarine, SubMarine.__name__, SubMarine().net, SubMarine().sound)

# Output
# (__main__.SubMarine,'SubMarine', 'underwater', 'Sonar') 
```

* * *

## 回答 #18

> 赞同：-1
> 
> 时间：2020-11-22T05:14:01.640

除了其他人所说的之外，我发现`__repr__`and`__str__`方法不能在对象级别进行猴子补丁，因为`repr()`and`str()`使用类方法，而不是本地绑定的对象方法：

```
# Instance monkeypatch
[ins] In [55]: x.__str__ = show.__get__(x)                                                                 

[ins] In [56]: x                                                                                           
Out[56]: <__main__.X at 0x7fc207180c10>

[ins] In [57]: str(x)                                                                                      
Out[57]: '<__main__.X object at 0x7fc207180c10>'

[ins] In [58]: x.__str__()                                                                                 
Nice object!

# Class monkeypatch
[ins] In [62]: X.__str__ = lambda _: "From class"                                                          

[ins] In [63]: str(x)                                                                                      
Out[63]: 'From class' 
```